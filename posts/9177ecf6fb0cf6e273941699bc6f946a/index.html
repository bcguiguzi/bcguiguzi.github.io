<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>依赖注入之@Value原理（placeholder解析） - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="依赖注入之@Value原理（placeholder解析）" />
<meta property="og:description" content="resolveEmbeddedValue是doResolveDependency方法处理@Value注解的第二步，resolveEmbeddedValue解析@Value注解中设置value的placeholder，将${xxx}替换为application.properties中配置的值。
回顾一下doResolveDependency方法，如下
public Object doResolveDependency(DependencyDescriptor descriptor, @Nullable String beanName, @Nullable Set&lt;String&gt; autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException { InjectionPoint previousInjectionPoint = ConstructorResolver.setCurrentInjectionPoint(descriptor); try { Class&lt;?&gt; type = descriptor.getDependencyType(); Object value = getAutowireCandidateResolver().getSuggestedValue(descriptor); if (value != null) { if (value instanceof String) { String strVal = resolveEmbeddedValue((String) value); BeanDefinition bd = (beanName != null &amp;&amp; containsBean(beanName) ? getMergedBeanDefinition(beanName) : null); value = evaluateBeanDefinitionString(strVal, bd); } TypeConverter converter = (typeConverter != null ?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/9177ecf6fb0cf6e273941699bc6f946a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-13T22:00:29+08:00" />
<meta property="article:modified_time" content="2022-04-13T22:00:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">依赖注入之@Value原理（placeholder解析）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>resolveEmbeddedValue是doResolveDependency方法处理@Value注解的第二步，resolveEmbeddedValue解析@Value注解中设置value的placeholder，将${xxx}替换为application.properties中配置的值。<br> 回顾一下doResolveDependency方法，如下</p> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doResolveDependency</span><span class="token punctuation">(</span><span class="token class-name">DependencyDescriptor</span> descriptor<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span>
			<span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> autowiredBeanNames<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TypeConverter</span> typeConverter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{<!-- --></span>

		<span class="token class-name">InjectionPoint</span> previousInjectionPoint <span class="token operator">=</span> <span class="token class-name">ConstructorResolver</span><span class="token punctuation">.</span><span class="token function">setCurrentInjectionPoint</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>

			<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type <span class="token operator">=</span> descriptor<span class="token punctuation">.</span><span class="token function">getDependencyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token function">getAutowireCandidateResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSuggestedValue</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token class-name">String</span> strVal <span class="token operator">=</span> <span class="token function">resolveEmbeddedValue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">BeanDefinition</span> bd <span class="token operator">=</span> <span class="token punctuation">(</span>beanName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">containsBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">?</span>
							<span class="token function">getMergedBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					value <span class="token operator">=</span> <span class="token function">evaluateBeanDefinitionString</span><span class="token punctuation">(</span>strVal<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token class-name">TypeConverter</span> converter <span class="token operator">=</span> <span class="token punctuation">(</span>typeConverter <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> typeConverter <span class="token operator">:</span> <span class="token function">getTypeConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">return</span> converter<span class="token punctuation">.</span><span class="token function">convertIfNecessary</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> type<span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span><span class="token function">getTypeDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedOperationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// A custom TypeConverter which does not support TypeDescriptor resolution...</span>
					<span class="token keyword">return</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
							converter<span class="token punctuation">.</span><span class="token function">convertIfNecessary</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> type<span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span>
							converter<span class="token punctuation">.</span><span class="token function">convertIfNecessary</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> type<span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">ConstructorResolver</span><span class="token punctuation">.</span><span class="token function">setCurrentInjectionPoint</span><span class="token punctuation">(</span>previousInjectionPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>前面分析过，resolveEmbeddedValue最终会调用PropertySourcesPropertyResolver#resolvePlaceholders方法或者PropertySourcesPropertyResolver#resolveRequiredPlaceholders处理placeholder，区别在于当${xxx}指定的placehodler不存在值时，resolveRequiredPlaceholders会抛异常，resolvePlaceholders会忽略，PropertySourcesPropertyResolver里的这两个方法都继承自AbstractPropertyResolver，看一下这两个方法</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">resolvePlaceholders</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nonStrictHelper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>nonStrictHelper <span class="token operator">=</span> <span class="token function">createPlaceholderHelper</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">doResolvePlaceholders</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nonStrictHelper<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">resolveRequiredPlaceholders</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>strictHelper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>strictHelper <span class="token operator">=</span> <span class="token function">createPlaceholderHelper</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">doResolvePlaceholders</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>strictHelper<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>这两个方法分别创建了PropertyPlaceholderHelper，然后调用doResolvePlaceholders来解析value</p> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">doResolvePlaceholders</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">,</span> <span class="token class-name">PropertyPlaceholderHelper</span> helper<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> helper<span class="token punctuation">.</span><span class="token function">replacePlaceholders</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getPropertyAsRawString</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>doResolvePlaceholders直接调用PropertyPlaceholderHelper#replacePlaceholders来解析，并将getPropertyAsRawString方法引用作为PlaceholderResolver传进去。PropertyPlaceholderHelper#replacePlaceholders方法会不断提取value中的placeholder，通过PlaceholderResolver将placeholder解析成真正的值。getPropertyAsRawString就是从配置中找到配置的值，这里不在分析。<br> 大部分逻辑都在PropertyPlaceholderHelper，回头看createPlaceholderHelper创建PropertyPlaceholderHelper的</p> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token class-name">PropertyPlaceholderHelper</span> <span class="token function">createPlaceholderHelper</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> ignoreUnresolvablePlaceholders<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PropertyPlaceholderHelper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>placeholderPrefix<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>placeholderSuffix<span class="token punctuation">,</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>valueSeparator<span class="token punctuation">,</span> ignoreUnresolvablePlaceholders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里将四个参数传了进去</p> 
<ul><li>placeholderPrefix，就是’${’</li><li>placeholderSuffix，就是’}’</li><li>valueSeparator，就是’:’</li><li>ignoreUnresolvablePlaceholders，resolvePlaceholders和resolveRequiredPlaceholders分别传的true、false</li></ul> 
<p>placeholderPrefix、placeholderSuffix、ignoreUnresolvablePlaceholders都好理解，解释下valueSeparator。当@Value指定的placeholder不存在配置的值时，除了希望是否忽略之外，还希望能填进去一个默认值，${app.name:jack}这样写时当不存在app.name的配置时，用默认值jack代替。<br> PropertyPlaceholderHelper#replacePlaceholders方法直接调用了PropertyPlaceholderHelper#parseStringValue方法，这个是placeholder解析的核心逻辑。分析该逻辑之前考虑几个问题：</p> 
<ul><li>placeholder能否存在多个？例如<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           p 
          
         
           1 
          
         
        
          a 
         
        
          n 
         
        
          d 
         
        
       
         {p1}and 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="mord">1</span></span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">d</span></span></span></span></span>{p2}</li><li>placeholder能否嵌套？例如<span class="katex--inline">KaTeX parse error: Expected '}', got 'EOF' at end of input: {app.</span>{name}}</li><li>通过placeholder获取到的值能否还包含placeholder？例如<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           a 
          
         
           p 
          
         
           p 
          
         
           . 
          
         
           n 
          
         
           a 
          
         
           m 
          
         
           e 
          
         
        
          ， 
         
        
          配 
         
        
          置 
         
        
          中 
         
        
          a 
         
        
          p 
         
        
          p 
         
        
          . 
         
        
          n 
         
        
          a 
         
        
          m 
         
        
          e 
         
        
          = 
         
        
          a 
         
        
          p 
         
        
          p 
         
        
       
         {app.name}，配置中app.name=app 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="mord mathdefault">p</span><span class="mord mathdefault">p</span><span class="mord">.</span><span class="mord mathdefault">n</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span></span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">配</span><span class="mord cjk_fallback">置</span><span class="mord cjk_fallback">中</span><span class="mord mathdefault">a</span><span class="mord mathdefault">p</span><span class="mord mathdefault">p</span><span class="mord">.</span><span class="mord mathdefault">n</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault">p</span><span class="mord mathdefault">p</span></span></span></span></span>{name}</li><li>placeholder配置的值还包含placeholder，怎么解决循环问题？例如<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           a 
          
         
           p 
          
         
           p 
          
         
           . 
          
         
           n 
          
         
           a 
          
         
           m 
          
         
           e 
          
         
        
          ， 
         
        
          配 
         
        
          置 
         
        
          中 
         
        
          a 
         
        
          p 
         
        
          p 
         
        
          . 
         
        
          n 
         
        
          a 
         
        
          m 
         
        
          e 
         
        
          = 
         
        
          p 
         
        
       
         {app.name}，配置中app.name=p 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="mord mathdefault">p</span><span class="mord mathdefault">p</span><span class="mord">.</span><span class="mord mathdefault">n</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span></span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">配</span><span class="mord cjk_fallback">置</span><span class="mord cjk_fallback">中</span><span class="mord mathdefault">a</span><span class="mord mathdefault">p</span><span class="mord mathdefault">p</span><span class="mord">.</span><span class="mord mathdefault">n</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span></span>{app.name}</li></ul> 
<p>parseStringValue的逻辑主要在解决上面这些问题，通过递归解决嵌套和配置包含placehodler问题，通过记录正在解析的placeholder检测循环并抛异常。while循环里逐个处理text中并列的多个placeholder，对每个placeholder处理逻辑如下</p> 
<ul><li>findPlaceholderEndIndex找到与之相闭合的’}'，找不到则设置startIndex=-1，退出while循环</li><li>拿到placeholder，加入visitedPlaceholders，visitedPlaceholders保存递归过程中正在解析的placeholder，如果当前placeholder在visitedPlaceholders存在，抛异常退出。这个placeholder里面可能还存在placehodler，所以要先处理内部placeholder，在通过placeholderResolver解析当前placeholder</li><li>递归调用parseStringValue解析拿到的placeholder，其实就是处理当前placeholder内部的placeholder，即<span class="katex--inline">KaTeX parse error: Expected '}', got 'EOF' at end of input: {app.</span>{name}}情况</li><li>处理完内部placeholder后，通过placeholderResolver解析当前placeholder，即从配置中获取值</li><li>如果值为null（即不存在该配置），有可能是通过valueSeparator配置了默认值，处理默认值情况</li><li>如果解析的值还是null，则抛异常或忽略</li><li>如果解析出来的值不是null，那么配置的值也是可能包含placeholder的，即app.name=app${name}情况，递归调用parseStringValue来解析</li><li>最后将解析出来的值替换placeholder</li></ul> 
<pre><code class="prism language-java">	<span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">parseStringValue</span><span class="token punctuation">(</span>
			<span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">PlaceholderResolver</span> placeholderResolver<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> visitedPlaceholders<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		<span class="token keyword">int</span> startIndex <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>placeholderPrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>startIndex <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> value<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token class-name">StringBuilder</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>startIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span> endIndex <span class="token operator">=</span> <span class="token function">findPlaceholderEndIndex</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>endIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">String</span> placeholder <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>startIndex <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>placeholderPrefix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> endIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">String</span> originalPlaceholder <span class="token operator">=</span> placeholder<span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>visitedPlaceholders <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					visitedPlaceholders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>visitedPlaceholders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>originalPlaceholder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
							<span class="token string">"Circular placeholder reference '"</span> <span class="token operator">+</span> originalPlaceholder <span class="token operator">+</span> <span class="token string">"' in property definitions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// Recursive invocation, parsing placeholders contained in the placeholder key.</span>
				placeholder <span class="token operator">=</span> <span class="token function">parseStringValue</span><span class="token punctuation">(</span>placeholder<span class="token punctuation">,</span> placeholderResolver<span class="token punctuation">,</span> visitedPlaceholders<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// Now obtain the value for the fully resolved key...</span>
				<span class="token class-name">String</span> propVal <span class="token operator">=</span> placeholderResolver<span class="token punctuation">.</span><span class="token function">resolvePlaceholder</span><span class="token punctuation">(</span>placeholder<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>propVal <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>valueSeparator <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">int</span> separatorIndex <span class="token operator">=</span> placeholder<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>valueSeparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>separatorIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token class-name">String</span> actualPlaceholder <span class="token operator">=</span> placeholder<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> separatorIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token class-name">String</span> defaultValue <span class="token operator">=</span> placeholder<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>separatorIndex <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>valueSeparator<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						propVal <span class="token operator">=</span> placeholderResolver<span class="token punctuation">.</span><span class="token function">resolvePlaceholder</span><span class="token punctuation">(</span>actualPlaceholder<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>propVal <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							propVal <span class="token operator">=</span> defaultValue<span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>propVal <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// Recursive invocation, parsing placeholders contained in the</span>
					<span class="token comment">// previously resolved placeholder value.</span>
					propVal <span class="token operator">=</span> <span class="token function">parseStringValue</span><span class="token punctuation">(</span>propVal<span class="token punctuation">,</span> placeholderResolver<span class="token punctuation">,</span> visitedPlaceholders<span class="token punctuation">)</span><span class="token punctuation">;</span>
					result<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>startIndex<span class="token punctuation">,</span> endIndex <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>placeholderSuffix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> propVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Resolved placeholder '"</span> <span class="token operator">+</span> placeholder <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					startIndex <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>placeholderPrefix<span class="token punctuation">,</span> startIndex <span class="token operator">+</span> propVal<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ignoreUnresolvablePlaceholders<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// Proceed with unprocessed value.</span>
					startIndex <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>placeholderPrefix<span class="token punctuation">,</span> endIndex <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>placeholderSuffix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Could not resolve placeholder '"</span> <span class="token operator">+</span>
							placeholder <span class="token operator">+</span> <span class="token string">"'"</span> <span class="token operator">+</span> <span class="token string">" in value \""</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				visitedPlaceholders<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>originalPlaceholder<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				startIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/93a124e7ae520a60174c6443cae0044d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Typora图片自动上传</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9b76c2dd2eada2965936b90ee8b9c827/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于深度学习的表计识别方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>