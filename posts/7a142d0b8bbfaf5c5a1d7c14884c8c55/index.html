<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ubuntu下HoiTransformer复现pytorch环境搭建&#43;解决问题 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Ubuntu下HoiTransformer复现pytorch环境搭建&#43;解决问题" />
<meta property="og:description" content="一、准备工作 论文：End-to-End Human Object Interaction Detection with HOI Transformer
代码：GitHub - bbepoch/HoiTransformer: This is the code for HOI Transformer 二、环境搭建 硬件/系统：服务器GPU3090，Ubuntu20.。。（忘记了），CUDA11.2
虚拟环境：python3.6，torch1.10.0&#43;cu113，torchaudio0.10.0&#43;cu113，torchvision0.11.1&#43;cu113 虚拟环境创建过程略
三、复现过程 1.克隆代码（github难以直接克隆于是去gitee克隆了，最好克隆不要直接下载压缩包）
git clone https://gitee.com/hoi_xd/HoiTransformer 2.下载预训练模型
cd data/detr_coco &amp;&amp; bash download_model.sh 3.下载注释文件
cd data &amp;&amp; bash download_annotations.sh 4. 下载数据集
cd data &amp;&amp; bash download_images.sh 5.安装相关依赖
pip install -r requirements.txt 6.可以把数据移到服务器机械硬盘上，只在目录下映射一个地址（可省略）
mv data /home/hoi/ ln -s /home/hoi/data data 7.训练模型
# Train on HICO-DET. python3 -m torch.distributed.launch --nproc_per_node=8 --use_env main." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/7a142d0b8bbfaf5c5a1d7c14884c8c55/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-26T13:43:50+08:00" />
<meta property="article:modified_time" content="2022-05-26T13:43:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ubuntu下HoiTransformer复现pytorch环境搭建&#43;解决问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4>一、准备工作</h4> 
<p>论文：<a href="https://arxiv.org/abs/2103.04503" rel="nofollow" title="End-to-End Human Object Interaction Detection with HOI Transformer">End-to-End Human Object Interaction Detection with HOI Transformer</a></p> 
<p>代码：<a href="https://github.com/bbepoch/HoiTransformer" title="GitHub - bbepoch/HoiTransformer: This is the code for HOI Transformer">GitHub - bbepoch/HoiTransformer: This is the code for HOI Transformer</a> </p> 
<h4>二、环境搭建</h4> 
<p>硬件/系统：服务器GPU3090，Ubuntu20.。。（忘记了），CUDA11.2</p> 
<p>虚拟环境：python3.6，torch1.10.0+cu113，torchaudio0.10.0+cu113，torchvision0.11.1+cu113  </p> 
<p>虚拟环境创建过程略</p> 
<h4>三、复现过程</h4> 
<p>1.克隆代码（github难以直接克隆于是去gitee克隆了，最好克隆不要直接下载压缩包）</p> 
<pre><code>git clone https://gitee.com/hoi_xd/HoiTransformer
</code></pre> 
<p>2.下载预训练模型</p> 
<pre><code>cd data/detr_coco &amp;&amp; bash download_model.sh
</code></pre> 
<p>3.下载注释文件</p> 
<pre><code>cd data &amp;&amp; bash download_annotations.sh
</code></pre> 
<p>4. 下载数据集</p> 
<pre><code>cd data &amp;&amp; bash download_images.sh
</code></pre> 
<p>5.安装相关依赖</p> 
<pre><code>pip install -r requirements.txt
</code></pre> 
<p>6.可以把数据移到服务器机械硬盘上，只在目录下映射一个地址（可省略）</p> 
<pre><code>mv data /home/hoi/
ln -s /home/hoi/data data
</code></pre> 
<p>7.训练模型</p> 
<pre><code># Train on HICO-DET.
python3 -m torch.distributed.launch --nproc_per_node=8 --use_env main.py --epochs=150 --lr_drop=110 --dataset_file=hico --batch_size=2 --backbone=resnet50

# Train on HOI-A.
python3 -m torch.distributed.launch --nproc_per_node=8 --use_env main.py --epochs=150 --lr_drop=110 --dataset_file=hoia --batch_size=2 --backbone=resnet50

# Train on V-COCO.
python3 -m torch.distributed.launch --nproc_per_node=8 --use_env main.py --epochs=150 --lr_drop=110 --dataset_file=vcoco --batch_size=2 --backbone=resnet50

# Training longer can get even better performance.</code></pre> 
<p>8.测试模型</p> 
<pre><code>python3 test.py --backbone=resnet50 --batch_size=1 --dataset_file=vcoco --log_dir=./ --model_path=checkpoint/p_202205242249/checkpoint.pth </code></pre> 
<h4> 四、相关问题</h4> 
<p>1、下载注释文件、部分数据集的时候，都是在driver.google上下载，会失败</p> 
<p>解决方法：这里训练了vcoco2014，没有训练其他数据集，所有需要下载的部分直接在本机上下载好传到服务器，下载了以下三个文件，</p> 
<p>vcoco压缩包为注释文件，挂梯子下载20M左右，网址：<a href="https://drive.google.com/uc?id=1vWVScXPsu0KVMtXW8QdLjb25NGLzEPhN" rel="nofollow" title="https://drive.google.com/uc?id=1vWVScXPsu0KVMtXW8QdLjb25NGLzEPhN">https://drive.google.com/uc?id=1vWVScXPsu0KVMtXW8QdLjb25NGLzEPhN</a></p> 
<p>另两个数据集，可以直接下载，网址：</p> 
<p># File name: train2014.zip，16G<br> http://images.cocodataset.org/zips/train2014.zip<br> # File name: val2014.zip，6G<br> http://images.cocodataset.org/zips/val2014.zip</p> 
<p><img alt="" height="91" src="https://images2.imgbox.com/c5/b5/KhRxinWe_o.png" width="236"></p> 
<p>2、按以下目录结构，步骤6做了之后，地址会映射过来，目录结构不变</p> 
<p>    HoiTransformer/<br>     ├── data/<br>     │   ├── detr_coco/<br>     │   ├── hico/<br>     │   │   ├── eval/<br>     │   │   └── images/<br>     │   │       ├── train2015/<br>     │   │       └── test2015/<br>     │   ├── hoia/<br>     │   │   ├── eval/<br>     │   │   └── images/<br>     │   │       ├── trainval/<br>     │   │       └── test/<br>     │   └── vcoco/<br>     │       ├── eval/<br>     │       └── images/<br>     │           ├── train2014/<br>     │           └── val2014/<br>     ├── datasets/<br>     ├── models/<br>     ├── tools/<br>     ├── util/<br>     ├── engin.py<br>     ├── main.py<br>     └── test.py</p> 
<p>3、GPU和 pytorch算力不匹配</p> 
<p style="margin-left:.0001pt;text-align:justify;">pytorch capability sm_86 is not compatible with the current PyTorch installation</p> 
<p style="margin-left:.0001pt;text-align:justify;">解决方法，3090GPU，CUDA11.2 匹配pytorch版本也要高一点</p> 
<p style="margin-left:.0001pt;text-align:justify;">所以下载cu113版本的pytorch，不用pip3下载会下载到实际anaconda环境，用pip下载</p> 
<pre><code>pip install torch==1.10.0+cu113 torchvision==0.11.1+cu113 torchaudio==0.10.0+cu113 -f https://download.pytorch.org/whl/cu113/torch_stable.html
</code></pre> 
<p style="margin-left:.0001pt;text-align:justify;">4、out of memory</p> 
<p style="margin-left:.0001pt;text-align:justify;">GPU并行模式没调整好，学习怎么弄并行模式，或者直接关闭并行模式训练</p> 
<pre><code># Train on V-COCO.
python main.py --epochs=150 --lr_drop=110 --dataset_file=vcoco --batch_size=2 --backbone=resnet50
</code></pre> 
<p>经过学习学会了用分布式训练：</p> 
<pre><code># 查看空余GPU，比如3，4，5，6四张卡空余
nvidia-smi
# 选择空余GPU训练
CUDA_VISIBLE_DEVICES=3,4,5,6 python3 -m torch.distributed.launch --nproc_per_node=4 --use_env main.py --epochs=150 --lr_drop=110 --dataset_file=vcoco --batch_size=2 --backbone=resnet101
</code></pre> 
<p>并行模式学习参考：</p> 
<p><a href="https://blog.csdn.net/hxxjxw/article/details/119606518" title="PyTorch分布式DPP的基本概念(node&amp;rank&amp;local_rank&amp;nnodes&amp;node_rank&amp;nproc_per_node&amp;world_size)_hxxjxw的博客-CSDN博客_nproc_per_node">PyTorch分布式DPP的基本概念(node&amp;rank&amp;local_rank&amp;nnodes&amp;node_rank&amp;nproc_per_node&amp;world_size)_hxxjxw的博客-CSDN博客_nproc_per_node</a> <br><br><a href="https://blog.csdn.net/qq_37541097/article/details/109736159" title="​​​​​​Pytorch中多GPU并行计算教程_太阳花的小绿豆的博客-CSDN博客_pytorch多gpu训练">​​​​​​Pytorch中多GPU并行计算教程_太阳花的小绿豆的博客-CSDN博客_pytorch多gpu训练</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a5174f5f4731ea18668715ce906ec70b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于python中占用内存的主要原因分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cd282903944979740f205fd3516022bf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android R开机流程跟踪-----init.rc和启动Zygote</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>