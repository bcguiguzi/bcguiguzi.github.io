<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql数据分析实战 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql数据分析实战" />
<meta property="og:description" content="使用英国某零售平台交易数据
# 查看特征和类型 # 发票编号、商品名称、简介、数量、日期、单价、用户ID、国家 DESC uk # 查看前5行 SELECT * FROM uk LIMIT 5; 1 缺失值检测
# 总行数、各字段的行数（是否存在缺失值） SELECT COUNT(*),COUNT(invoiceno),COUNT(stockcode),COUNT(description), COUNT(quantity),COUNT(invoicedate),COUNT(unitprice),COUNT(customerid), COUNT(country) FROM uk; # 共541909行，其中发票编号、描述、customerid存在缺失 2 异常值检测
数值型的数量和单价可能存在异常
【数量和单价】 SELECT MAX(quantity),MIN(quantity),MAX(unitprice),MIN(unitprice) FROM uk; SELECT COUNT(*) FROM uk WHERE quantity&lt;=0 # 10000多条 SELECT COUNT(*) FROM uk WHERE unitprice&lt;=0 # 2条异常 # 去掉2条小于0的，将10000条的变为正数 【样本时间范围】-2010-12-01到2011-12-09 SELECT MAX(invoicedate),MIN(invoicedate) FROM uk; 【每月记录数】-没有很少的 SELECT YEAR(invoicedate),MONTH(invoicedate),COUNT(*) FROM uk GROUP BY YEAR(invoicedate),MONTH(invoicedate); 3 重复值检测-536641,541909存在重复值
SELECT COUNT(*) FROM (SELECT DISTINCT * FROM uk) t; SELECT COUNT(*) FROM uk; 4 处理缺失、异常、重复" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/33c52c89cb73c1c3a63068d3bb64dc3b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-29T17:24:22+08:00" />
<meta property="article:modified_time" content="2020-11-29T17:24:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql数据分析实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>使用英国某零售平台交易数据</p> 
<pre><code class="prism language-sql"><span class="token comment"># 查看特征和类型</span>
<span class="token comment"># 发票编号、商品名称、简介、数量、日期、单价、用户ID、国家</span>
<span class="token keyword">DESC</span> uk
</code></pre> 
<p><img src="https://images2.imgbox.com/5b/cd/iHpa2T8V_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment"># 查看前5行</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> uk <span class="token keyword">LIMIT</span> <span class="token number">5</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3c/06/P9LUwRT2_o.png" alt="在这里插入图片描述"><br> <strong>1 缺失值检测</strong></p> 
<pre><code class="prism language-sql"><span class="token comment"># 总行数、各字段的行数（是否存在缺失值）</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>invoiceno<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>stockcode<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>unitprice<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>customerid<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span>country<span class="token punctuation">)</span> <span class="token keyword">FROM</span> uk<span class="token punctuation">;</span>
<span class="token comment"># 共541909行，其中发票编号、描述、customerid存在缺失</span>
</code></pre> 
<p><strong>2 异常值检测</strong><br> 数值型的数量和单价可能存在异常</p> 
<pre><code class="prism language-sql">【数量和单价】
<span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">MIN</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">MAX</span><span class="token punctuation">(</span>unitprice<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">MIN</span><span class="token punctuation">(</span>unitprice<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> uk<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> uk <span class="token keyword">WHERE</span> quantity<span class="token operator">&lt;=</span><span class="token number">0</span>  <span class="token comment"># 10000多条</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> uk <span class="token keyword">WHERE</span> unitprice<span class="token operator">&lt;=</span><span class="token number">0</span>  <span class="token comment"># 2条异常</span>
<span class="token comment"># 去掉2条小于0的，将10000条的变为正数</span>

【样本时间范围】<span class="token operator">-</span><span class="token number">2010</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span>到<span class="token number">2011</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">09</span>
<span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">MIN</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span> <span class="token keyword">FROM</span> uk<span class="token punctuation">;</span>

【每月记录数】<span class="token operator">-</span>没有很少的
<span class="token keyword">SELECT</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> uk
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>3 重复值检测</strong>-536641,541909存在重复值</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> uk<span class="token punctuation">)</span> t<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> uk<span class="token punctuation">;</span>
</code></pre> 
<p><strong>4 处理缺失、异常、重复</strong></p> 
<pre><code class="prism language-sql"><span class="token comment"># quantity&lt;0的变为正</span>
<span class="token keyword">UPDATE</span> uk
<span class="token keyword">SET</span> quantity<span class="token operator">=</span>quantity<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">WHERE</span> quantity<span class="token operator">&lt;</span><span class="token number">0</span>

<span class="token comment"># 删除customerid为空，unitprice&lt;0，quantity=0</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> uk 
<span class="token keyword">WHERE</span> CustomerID <span class="token operator">IS</span> <span class="token boolean">NULL</span>
<span class="token operator">OR</span> unitprice<span class="token operator">&lt;=</span><span class="token number">0</span> <span class="token operator">OR</span> quantity<span class="token operator">=</span><span class="token number">0</span>

<span class="token comment"># 再次查看是否缺失，总记录406789，invoiceNo397884条</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>invoiceno<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>stockcode<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>unitprice<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>customerid<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span>country<span class="token punctuation">)</span> <span class="token keyword">FROM</span> uk

<span class="token comment"># 再次查看是否存在重复值-存在</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> uk<span class="token punctuation">)</span> t<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> uk<span class="token punctuation">;</span>

<span class="token comment"># 建新表，去重,删去原表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> uk2 <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> uk<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> uk<span class="token punctuation">;</span>

<span class="token comment"># invoiceNo缺失比例计算-各月比例大致相同，直接删除对订单月分布影响不大</span>
<span class="token keyword">SELECT</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span> <span class="token punctuation">`</span>年<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span> <span class="token punctuation">`</span>月<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span>InvoiceNo <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>缺失数<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>记录数<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>InvoiceNo <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>缺失比例<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> uk2
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span>

<span class="token comment"># 删除缺失</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> uk2 <span class="token keyword">WHERE</span> Invoiceno <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_83"></a>交易总体状况</h2> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span> <span class="token punctuation">`</span>总订单量<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>unitprice<span class="token operator">*</span>quantity<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>总订单金额<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> customerid<span class="token punctuation">)</span> <span class="token punctuation">`</span>消费者数量<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span> <span class="token punctuation">`</span>商品总销量<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>unitprice<span class="token operator">*</span>quantity<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> customerid<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>客单价<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>连带率<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> uk2<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/63/9a/9jSMREip_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment"># 每月订单数、订单金额、消费者数量、商品总量</span>
<span class="token keyword">SELECT</span> DATE_FORMAT<span class="token punctuation">(</span>invoicedate<span class="token punctuation">,</span><span class="token string">'%Y年%m月'</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>月份<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span> <span class="token punctuation">`</span>订单数<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>unitprice<span class="token operator">*</span>quantity<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>订单金额<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> customerid<span class="token punctuation">)</span> <span class="token punctuation">`</span>消费者数量<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span> <span class="token punctuation">`</span>出售商品总量<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>unitprice<span class="token operator">*</span>quantity<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> customerid<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>客单价<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> customerid<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>连带率<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>unitprice<span class="token operator">*</span>quantity<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>每单平均金额<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>每单平均数量<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> uk2
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> DATE_FORMAT<span class="token punctuation">(</span>invoicedate<span class="token punctuation">,</span><span class="token string">'%Y年%m月'</span><span class="token punctuation">)</span>
<span class="token comment"># 10月、11月是订单高峰期</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/58/6c/rLbOrFhk_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_109"></a>一、订单量分布</h2> 
<h3><a id="_110"></a>按交易地区</h3> 
<p><strong>订单top5的国家</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> country<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span> <span class="token punctuation">`</span>订单数<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span> <span class="token keyword">FROM</span> uk2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>比例<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> uk2 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> country <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span>订单数<span class="token punctuation">`</span> <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">5</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/50/51/HLLuJyme_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_118"></a>按交易时间</h3> 
<p><strong>一个月内各天订单数及比例</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">DAY</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span> <span class="token punctuation">`</span>日<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span> <span class="token punctuation">`</span>订单数<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span> <span class="token keyword">FROM</span> uk2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>比例<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> uk2
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">DAY</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span>日<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token comment"># 月末订单明显少</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/52/0e/aUO1Vllo_o.png" alt="在这里插入图片描述"><br> <strong>星期内订单数及比例</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> DAYOFWEEK<span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span> <span class="token punctuation">`</span>星期<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span> <span class="token punctuation">`</span>订单数<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span> <span class="token keyword">FROM</span> uk2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>比例<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> uk2
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> DAYOFWEEK<span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span>星期<span class="token punctuation">`</span><span class="token punctuation">;</span>  
<span class="token comment"># 1表示星期日，周六不营业？周四订单量最大</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3b/79/bWiWb7Cy_o.png" alt="在这里插入图片描述"><br> <strong>每小时内订单数及比例</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> CONCAT<span class="token punctuation">(</span><span class="token keyword">HOUR</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">,</span><span class="token keyword">HOUR</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>时间<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span> <span class="token punctuation">`</span>订单数<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoicedate<span class="token punctuation">)</span> <span class="token keyword">FROM</span> uk2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>比例<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> uk2
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> CONCAT<span class="token punctuation">(</span><span class="token keyword">HOUR</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">,</span><span class="token keyword">HOUR</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">HOUR</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 10到16是集中时间</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ff/f8/D5hmj9gs_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_152"></a>每单金额、数量及商品单价分布</h2> 
<h3><a id="_153"></a>每单消费金额分布</h3> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token punctuation">`</span>金额<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>数量<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token punctuation">(</span><span class="token keyword">CASE</span> 
    <span class="token keyword">WHEN</span> amount<span class="token operator">&lt;</span><span class="token number">100</span> <span class="token keyword">THEN</span> <span class="token string">'0-100'</span>
    <span class="token keyword">WHEN</span> amount <span class="token operator">BETWEEN</span> <span class="token number">100</span> <span class="token operator">AND</span> <span class="token number">1000</span> <span class="token keyword">THEN</span> <span class="token string">'100-1000'</span>
    <span class="token keyword">WHEN</span> amount <span class="token operator">BETWEEN</span> <span class="token number">1001</span> <span class="token operator">AND</span> <span class="token number">2000</span> <span class="token keyword">THEN</span> <span class="token string">'1000-2000'</span>
    <span class="token keyword">WHEN</span> amount <span class="token operator">BETWEEN</span> <span class="token number">2001</span> <span class="token operator">AND</span> <span class="token number">3000</span> <span class="token keyword">THEN</span> <span class="token string">'2000-3000'</span>
    <span class="token keyword">WHEN</span> amount <span class="token operator">BETWEEN</span> <span class="token number">3001</span> <span class="token operator">AND</span> <span class="token number">4000</span> <span class="token keyword">THEN</span> <span class="token string">'3000-4000'</span>
    <span class="token keyword">WHEN</span> amount <span class="token operator">BETWEEN</span> <span class="token number">4001</span> <span class="token operator">AND</span> <span class="token number">5000</span> <span class="token keyword">THEN</span> <span class="token string">'4000-5000'</span>
    <span class="token keyword">WHEN</span> amount <span class="token operator">BETWEEN</span> <span class="token number">5001</span> <span class="token operator">AND</span> <span class="token number">6000</span> <span class="token keyword">THEN</span> <span class="token string">'5000-6000'</span>
    <span class="token keyword">ELSE</span> <span class="token string">'6000以上'</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>金额<span class="token punctuation">`</span>
    <span class="token keyword">FROM</span>
	<span class="token punctuation">(</span>
	    <span class="token keyword">SELECT</span> invoiceno<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>unitprice<span class="token operator">*</span>quantity<span class="token punctuation">)</span> amount
	    <span class="token keyword">FROM</span> uk2 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> invoiceno
	<span class="token punctuation">)</span> <span class="token keyword">temp</span>
<span class="token punctuation">)</span> t
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span>金额<span class="token punctuation">`</span> <span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/fd/8e/SHp9mIH0_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_176"></a>商品单价分布</h3> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token punctuation">`</span>价格<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>数量<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> <span class="token keyword">CASE</span>
	<span class="token keyword">WHEN</span> unitprice<span class="token operator">&lt;</span><span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'0-1'</span>
	<span class="token keyword">WHEN</span> unitprice <span class="token operator">BETWEEN</span> <span class="token number">2</span> <span class="token operator">AND</span> <span class="token number">5</span> <span class="token keyword">THEN</span> <span class="token string">'2-5'</span>
	<span class="token keyword">WHEN</span> unitprice <span class="token operator">BETWEEN</span> <span class="token number">6</span> <span class="token operator">AND</span> <span class="token number">10</span> <span class="token keyword">THEN</span> <span class="token string">'6-10'</span>
	<span class="token keyword">WHEN</span> unitprice <span class="token operator">BETWEEN</span> <span class="token number">11</span> <span class="token operator">AND</span> <span class="token number">20</span> <span class="token keyword">THEN</span> <span class="token string">'11-20'</span>
	<span class="token keyword">WHEN</span> unitprice <span class="token operator">BETWEEN</span> <span class="token number">21</span> <span class="token operator">AND</span> <span class="token number">30</span> <span class="token keyword">THEN</span> <span class="token string">'21-30'</span>
	<span class="token keyword">WHEN</span> unitprice <span class="token operator">BETWEEN</span> <span class="token number">31</span> <span class="token operator">AND</span> <span class="token number">50</span> <span class="token keyword">THEN</span> <span class="token string">'31-50'</span>
	<span class="token keyword">WHEN</span> unitprice <span class="token operator">BETWEEN</span> <span class="token number">51</span> <span class="token operator">AND</span> <span class="token number">100</span> <span class="token keyword">THEN</span> <span class="token string">'51-100'</span>
	<span class="token keyword">WHEN</span> unitprice <span class="token operator">BETWEEN</span> <span class="token number">101</span> <span class="token operator">AND</span> <span class="token number">300</span> <span class="token keyword">THEN</span> <span class="token string">'101-300'</span>
	<span class="token keyword">WHEN</span> unitprice <span class="token operator">BETWEEN</span> <span class="token number">301</span> <span class="token operator">AND</span> <span class="token number">500</span> <span class="token keyword">THEN</span> <span class="token string">'301-500'</span>
	<span class="token keyword">WHEN</span> unitprice <span class="token operator">BETWEEN</span> <span class="token number">501</span> <span class="token operator">AND</span> <span class="token number">1000</span> <span class="token keyword">THEN</span> <span class="token string">'501-1000'</span>
	<span class="token keyword">ELSE</span> <span class="token string">'1000以上'</span> <span class="token keyword">END</span> <span class="token punctuation">`</span>价格<span class="token punctuation">`</span>
	<span class="token keyword">FROM</span> uk2
	<span class="token punctuation">)</span> <span class="token keyword">temp</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span>价格<span class="token punctuation">`</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ac/81/nnJEuQ8z_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment"># 购买量top20的单价</span>
<span class="token keyword">SELECT</span> unitprice<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">`</span>频率<span class="token punctuation">`</span> <span class="token keyword">FROM</span> uk2 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> unitprice <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span>频率<span class="token punctuation">`</span> <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">20</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a7/e7/vtsZwrfh_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3__203"></a>3 订购量分布</h3> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token punctuation">`</span>订购量<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token string">'数量'</span>
<span class="token keyword">FROM</span>
<span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token punctuation">(</span><span class="token keyword">CASE</span> 
    <span class="token keyword">WHEN</span> amount<span class="token operator">&lt;</span><span class="token number">100</span> <span class="token keyword">THEN</span> <span class="token string">'0-100'</span>
    <span class="token keyword">WHEN</span> amount <span class="token operator">BETWEEN</span> <span class="token number">101</span> <span class="token operator">AND</span> <span class="token number">500</span> <span class="token keyword">THEN</span> <span class="token string">'100-500'</span>
    <span class="token keyword">WHEN</span> amount <span class="token operator">BETWEEN</span> <span class="token number">501</span> <span class="token operator">AND</span> <span class="token number">1000</span> <span class="token keyword">THEN</span> <span class="token string">'500-1000'</span>
    <span class="token keyword">WHEN</span> amount <span class="token operator">BETWEEN</span> <span class="token number">1001</span> <span class="token operator">AND</span> <span class="token number">2000</span> <span class="token keyword">THEN</span> <span class="token string">'1000-2000'</span>
    <span class="token keyword">WHEN</span> amount <span class="token operator">BETWEEN</span> <span class="token number">2001</span> <span class="token operator">AND</span> <span class="token number">3000</span> <span class="token keyword">THEN</span> <span class="token string">'2000-3000'</span>
    <span class="token keyword">ELSE</span> <span class="token string">'3000以上'</span> <span class="token keyword">END</span><span class="token punctuation">)</span><span class="token punctuation">`</span>订购量<span class="token punctuation">`</span>
    <span class="token keyword">FROM</span>
	<span class="token punctuation">(</span>
	    <span class="token keyword">SELECT</span> invoiceno<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span> amount
	    <span class="token keyword">FROM</span> uk2 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> invoiceno
	    <span class="token punctuation">)</span> <span class="token keyword">temp</span>
	<span class="token punctuation">)</span> t
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span>订购量<span class="token punctuation">`</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ba/cb/HZRrUXGk_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_224"></a>每单数量的中位数(四分位数)</h3> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token punctuation">`</span>中位数<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> <span class="token variable">@index</span>:<span class="token operator">=</span><span class="token variable">@index</span><span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">AS</span> num<span class="token punctuation">,</span> amount
	<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
	    <span class="token keyword">SELECT</span> invoiceno<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span> amount
	    <span class="token keyword">FROM</span> uk2 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> invoiceno <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> amount
	    <span class="token punctuation">)</span> <span class="token keyword">temp</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token variable">@index</span>:<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> ti
	<span class="token punctuation">)</span> t
<span class="token keyword">WHERE</span> num<span class="token operator">=</span>FLOOR<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">@index</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">OR</span> num<span class="token operator">=</span>CEIL<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">@index</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment"># @index是最后一个index，也就是最大的值</span>
<span class="token comment"># 下四分位：where num=FLOOR((@index+1)/2)，select amount</span>
<span class="token comment"># 上四分位数：where num=FLOOR(3*(@index+1)/2)，select amount</span>
</code></pre> 
<h2><a id="_240"></a>二、每月留存率</h2> 
<p>2010/12月的消费者为初始，每月的新增消费者在以后月份的留存情况</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> customer_orders <span class="token keyword">AS</span> 
<span class="token keyword">SELECT</span> CustomerID<span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2010'</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">'2010/12'</span><span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">'2011/01'</span><span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">'2011/02'</span><span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">'2011/03'</span><span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">'2011/04'</span><span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'5'</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">'2011/05'</span><span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'6'</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">'2011/06'</span><span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'7'</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">'2011/07'</span><span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'8'</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">'2011/08'</span><span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'9'</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">'2011/09'</span><span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'10'</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">'2011/10'</span><span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'11'</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">'2011/11'</span><span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>DATE_FORMAT<span class="token punctuation">(</span>invoicedate<span class="token punctuation">,</span><span class="token string">'%Y/%m'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2011/12'</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">'2011/12'</span>
<span class="token keyword">FROM</span> uk2
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> CustomerID<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> customer_orders<span class="token punctuation">;</span>
<span class="token comment"># 1表示消费了，0表示没有消费</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/bb/4b/DZTC4Oq8_o.png" alt="在这里插入图片描述"><br> <strong>5个月后的留存</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> retention <span class="token keyword">AS</span> 
<span class="token keyword">SELECT</span> <span class="token string">'2010/12'</span> <span class="token keyword">AS</span><span class="token punctuation">`</span>月份<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>新增<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">01</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">01</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">01</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">01</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">01</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">`</span>
<span class="token keyword">FROM</span>  customer_orders <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">2010</span><span class="token operator">/</span><span class="token number">12</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token string">'2011/01'</span> <span class="token keyword">AS</span><span class="token punctuation">`</span>月份<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>新增<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">`</span>
<span class="token keyword">FROM</span>  customer_orders <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">2010</span><span class="token operator">/</span><span class="token number">12</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">01</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token string">'2011/02'</span> <span class="token keyword">AS</span><span class="token punctuation">`</span>月份<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>新增<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">`</span>
<span class="token keyword">FROM</span>  customer_orders <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">2010</span><span class="token operator">/</span><span class="token number">12</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">01</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token string">'2011/03'</span> <span class="token keyword">AS</span><span class="token punctuation">`</span>月份<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>新增<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">08</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">`</span>
<span class="token keyword">FROM</span>  customer_orders <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">2010</span><span class="token operator">/</span><span class="token number">12</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">01</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token string">'2011/04'</span> <span class="token keyword">AS</span><span class="token punctuation">`</span>月份<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>新增<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">08</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">08</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">09</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">`</span>
<span class="token keyword">FROM</span>  customer_orders <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">2010</span><span class="token operator">/</span><span class="token number">12</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">01</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token string">'2011/05'</span> <span class="token keyword">AS</span><span class="token punctuation">`</span>月份<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>新增<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">08</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">08</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">09</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">08</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">09</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">`</span>
<span class="token keyword">FROM</span>  customer_orders <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">2010</span><span class="token operator">/</span><span class="token number">12</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">01</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token string">'2011/06'</span> <span class="token keyword">AS</span><span class="token punctuation">`</span>月份<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span>新增<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">08</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">08</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">09</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">08</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">09</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">07</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">08</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">09</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">11</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">`</span>
<span class="token keyword">FROM</span>  customer_orders <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">2010</span><span class="token operator">/</span><span class="token number">12</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">01</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">02</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">03</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">04</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">06</span><span class="token punctuation">`</span><span class="token operator">=</span><span class="token number">1</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> retention<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a9/0a/Pj8qNLEm_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_306"></a>三、复购率</h2> 
<h3><a id="_307"></a>购买次数及其人数</h3> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> times <span class="token punctuation">`</span>购买次数<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>人数<span class="token punctuation">`</span>
<span class="token keyword">FROM</span>
<span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> customerid<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span> times
<span class="token keyword">FROM</span> uk2 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> customerid
<span class="token punctuation">)</span> <span class="token keyword">temp</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> times <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> times<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e5/84/EFF5EYcg_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_318"></a>复购率</h3> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span>customerid<span class="token punctuation">)</span><span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> customerid<span class="token punctuation">)</span> <span class="token keyword">FROM</span> uk2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>复购率<span class="token punctuation">`</span>
<span class="token keyword">FROM</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> customerid <span class="token keyword">FROM</span> uk2 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> customerid
<span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span> fugou
</code></pre> 
<p><img src="https://images2.imgbox.com/d1/d4/gpCU0VQ8_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_326"></a>复购的间隔</h3> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> fugou <span class="token keyword">AS</span>  <span class="token comment"># 生成复购表</span>
<span class="token keyword">SELECT</span> <span class="token keyword">temp</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span><span class="token variable">@num</span>:<span class="token operator">=</span><span class="token keyword">IF</span><span class="token punctuation">(</span>customerid<span class="token operator">&lt;&gt;</span><span class="token variable">@c</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">IF</span><span class="token punctuation">(</span>mydate<span class="token operator">&gt;</span><span class="token variable">@date</span><span class="token punctuation">,</span><span class="token variable">@num</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token variable">@num</span><span class="token punctuation">)</span><span class="token punctuation">)</span> num<span class="token punctuation">,</span>
<span class="token variable">@c</span>:<span class="token operator">=</span>customerid<span class="token punctuation">,</span><span class="token variable">@date</span>:<span class="token operator">=</span>mydate
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> uk2<span class="token punctuation">.</span>customerid<span class="token punctuation">,</span><span class="token keyword">DATE</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span> mydate
<span class="token keyword">FROM</span> uk2 <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> customerid <span class="token keyword">FROM</span> uk2
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> customerid
    <span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> <span class="token keyword">DATE</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">1</span> <span class="token comment"># 一张发票也许对应多个时间，但只要在一天就视为一个订单</span>
    <span class="token punctuation">)</span>fugou 
<span class="token keyword">ON</span> uk2<span class="token punctuation">.</span><span class="token punctuation">`</span>CustomerID<span class="token punctuation">`</span><span class="token operator">=</span>fugou<span class="token punctuation">.</span>customerid
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> uk2<span class="token punctuation">.</span>customerid<span class="token punctuation">,</span>mydate
<span class="token punctuation">)</span> <span class="token keyword">temp</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token variable">@num</span>:<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token variable">@c</span>:<span class="token operator">=</span><span class="token string">' '</span><span class="token punctuation">,</span><span class="token variable">@date</span>:<span class="token operator">=</span><span class="token string">'2000-01-01'</span><span class="token punctuation">)</span> t
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> customerid<span class="token punctuation">,</span>mydate  <span class="token comment"># 每个顾客每个订单上有多个产品，需要分组</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> customerid<span class="token punctuation">,</span>mydate<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> fugou<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f6/94/FyUMJ0vZ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_348"></a>每个消费者的平均复购时间间隔</h3> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> f1<span class="token punctuation">.</span>customerid<span class="token punctuation">,</span><span class="token function">MAX</span><span class="token punctuation">(</span>f1<span class="token punctuation">.</span>num<span class="token punctuation">)</span> <span class="token punctuation">`</span>下单次数<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">*</span><span class="token function">AVG</span><span class="token punctuation">(</span>DATEDIFF<span class="token punctuation">(</span>f1<span class="token punctuation">.</span>mydate<span class="token punctuation">,</span>f2<span class="token punctuation">.</span>mydate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>平均间隔天数<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> fugou f1<span class="token punctuation">,</span>fugou f2
<span class="token keyword">WHERE</span> f1<span class="token punctuation">.</span>customerid<span class="token operator">=</span>f2<span class="token punctuation">.</span>customerid
<span class="token operator">AND</span> f1<span class="token punctuation">.</span>num<span class="token operator">-</span>f2<span class="token punctuation">.</span>num<span class="token operator">=</span><span class="token number">1</span>  <span class="token comment"># 本次，上一次</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> f1<span class="token punctuation">.</span>customerid
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span>下单次数<span class="token punctuation">`</span> <span class="token keyword">DESC</span><span class="token punctuation">,</span><span class="token punctuation">`</span>平均间隔天数<span class="token punctuation">`</span> <span class="token keyword">DESC</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/63/ec/uJhf7xv1_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="n_358"></a>新客户首日购买后，第二天（n日内）依旧购买的比例</h3> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> uk2<span class="token punctuation">.</span>customerid<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> customerid<span class="token punctuation">)</span> <span class="token keyword">FROM</span> uk2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>第二天回购比例<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> uk2 <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> customerid<span class="token punctuation">,</span><span class="token function">MIN</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span> first_buy <span class="token keyword">FROM</span> uk2 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> customerid<span class="token punctuation">)</span> t
<span class="token keyword">ON</span> uk2<span class="token punctuation">.</span><span class="token punctuation">`</span>CustomerID<span class="token punctuation">`</span><span class="token operator">=</span>t<span class="token punctuation">.</span>customerid
<span class="token operator">AND</span> DATEDIFF<span class="token punctuation">(</span>uk2<span class="token punctuation">.</span><span class="token punctuation">`</span>InvoiceDate<span class="token punctuation">`</span><span class="token punctuation">,</span>first_buy<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>  <span class="token comment"># &lt;n</span>
<span class="token comment"># DATEDIFF(uk2.`InvoiceDate`,first_buy)&lt;30 AND  uk2.`InvoiceDate`&lt;&gt;first_buy  30天内回购比例：0.22</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f2/72/JLfSRSKL_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="201012_367"></a>2010年12月每日新用户数量，及其在一个月内的复购人数、复购比例</h3> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> fd<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> t<span class="token punctuation">.</span>customerid<span class="token punctuation">)</span> <span class="token punctuation">`</span>新用户数<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> uk2<span class="token punctuation">.</span><span class="token punctuation">`</span>CustomerID<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token punctuation">`</span><span class="token number">30</span>天内复购人数<span class="token punctuation">`</span><span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> uk2<span class="token punctuation">.</span><span class="token punctuation">`</span>CustomerID<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> t<span class="token punctuation">.</span>customerid<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">`</span><span class="token number">30</span>天内复购比例<span class="token punctuation">`</span>
<span class="token keyword">FROM</span>
uk2 <span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span>
<span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> customerid<span class="token punctuation">,</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token keyword">DATE</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">)</span> fd
<span class="token keyword">FROM</span> uk2 <span class="token keyword">WHERE</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2010</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> customerid
<span class="token punctuation">)</span> t
<span class="token keyword">ON</span> uk2<span class="token punctuation">.</span><span class="token punctuation">`</span>CustomerID<span class="token punctuation">`</span><span class="token operator">=</span>t<span class="token punctuation">.</span>customerid
<span class="token operator">AND</span> DATEDIFF<span class="token punctuation">(</span><span class="token keyword">DATE</span><span class="token punctuation">(</span>uk2<span class="token punctuation">.</span><span class="token punctuation">`</span>InvoiceDate<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">30</span> <span class="token operator">AND</span> <span class="token keyword">DATE</span><span class="token punctuation">(</span>uk2<span class="token punctuation">.</span><span class="token punctuation">`</span>InvoiceDate<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token operator">&lt;&gt;</span>fd
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> fd<span class="token punctuation">;</span>
<span class="token comment"># 第二个and条件必须使用DATE函数变为日期，t表中是日期类型的</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/42/7a/zKRHSwsZ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_383"></a>新老顾客标签</h3> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> customer_type <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> uk2<span class="token punctuation">.</span>customerid<span class="token punctuation">,</span><span class="token keyword">DATE</span><span class="token punctuation">(</span>uk2<span class="token punctuation">.</span><span class="token punctuation">`</span>InvoiceDate<span class="token punctuation">`</span><span class="token punctuation">)</span> d<span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token keyword">CASE</span>
<span class="token keyword">WHEN</span> fugou<span class="token punctuation">.</span><span class="token punctuation">`</span>customerid<span class="token punctuation">`</span> <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token string">'新客户'</span>
<span class="token keyword">WHEN</span> fugou<span class="token punctuation">.</span>num<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'新客户'</span>
<span class="token keyword">ELSE</span> <span class="token string">'老客户'</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>客户类型<span class="token punctuation">`</span>
<span class="token keyword">FROM</span> uk2 <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> fugou <span class="token keyword">ON</span> uk2<span class="token punctuation">.</span><span class="token punctuation">`</span>CustomerID<span class="token punctuation">`</span><span class="token operator">=</span>fugou<span class="token punctuation">.</span><span class="token punctuation">`</span>customerid<span class="token punctuation">`</span>
<span class="token operator">AND</span> <span class="token keyword">DATE</span><span class="token punctuation">(</span>uk2<span class="token punctuation">.</span><span class="token punctuation">`</span>InvoiceDate<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token operator">=</span>fugou<span class="token punctuation">.</span><span class="token punctuation">`</span>mydate<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> DATE_FORMAT<span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token punctuation">`</span>月份<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>客户类型<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> n
<span class="token keyword">FROM</span> customer_type
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> DATE_FORMAT<span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">`</span>客户类型<span class="token punctuation">`</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7f/24/AxtKKWin_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="RFM_400"></a>四、RFM模型</h2> 
<pre><code class="prism language-sql"><span class="token comment"># 设现在时间的2011-12-09</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> RFM <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> customerid<span class="token punctuation">,</span>DATEDIFF<span class="token punctuation">(</span><span class="token string">'2011-12-09'</span><span class="token punctuation">,</span><span class="token function">MAX</span><span class="token punctuation">(</span>invoicedate<span class="token punctuation">)</span><span class="token punctuation">)</span> R<span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> invoiceno<span class="token punctuation">)</span> F<span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>quantity<span class="token operator">*</span>unitprice<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> M
<span class="token keyword">FROM</span> uk2
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> customerid<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> RFM <span class="token keyword">LIMIT</span> <span class="token number">5</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c4/75/TL33Um9e_o.png" alt="在这里插入图片描述"><br> 根据均值划分高低两类，客户标签可能不准确。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">CASE</span>
<span class="token keyword">WHEN</span> R_score<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> F_score<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> M_score<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'重要价值客户'</span>
<span class="token keyword">WHEN</span> R_score<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> F_score<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> M_score<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">THEN</span> <span class="token string">'重要保持客户'</span>
<span class="token keyword">WHEN</span> R_score<span class="token operator">=</span><span class="token number">0</span> <span class="token operator">AND</span> F_score<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> M_score<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'重要挽留客户'</span>
<span class="token keyword">WHEN</span> R_score<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> F_score<span class="token operator">=</span><span class="token number">0</span> <span class="token operator">AND</span> M_score<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'重要价值客户'</span>
<span class="token keyword">WHEN</span> R_score<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> F_score<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> M_score<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">THEN</span> <span class="token string">'一般价值客户'</span>
<span class="token keyword">WHEN</span> R_score<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> F_score<span class="token operator">=</span><span class="token number">0</span> <span class="token operator">AND</span> M_score<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">THEN</span> <span class="token string">'一般保持客户'</span>
<span class="token keyword">WHEN</span> R_score<span class="token operator">=</span><span class="token number">0</span> <span class="token operator">AND</span> F_score<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> M_score<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">THEN</span> <span class="token string">'一般客户'</span>
<span class="token keyword">ELSE</span> <span class="token string">'流失客户'</span> <span class="token keyword">END</span> <span class="token punctuation">`</span>客户类型<span class="token punctuation">`</span>
<span class="token keyword">FROM</span>
<span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">IF</span><span class="token punctuation">(</span>R<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>R<span class="token punctuation">)</span> <span class="token keyword">FROM</span> RFM<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> R_score<span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span>F<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>F<span class="token punctuation">)</span> <span class="token keyword">FROM</span> RFM<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> F_score<span class="token punctuation">,</span>
<span class="token keyword">IF</span><span class="token punctuation">(</span>M<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token keyword">FROM</span> RFM<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> M_score
<span class="token keyword">FROM</span> RFM
<span class="token punctuation">)</span> <span class="token keyword">temp</span><span class="token punctuation">;</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/8e/8a/YsUI6QdC_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4e55995a0b3cf69ea469c7ea484422c0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python字符串对齐.format_python字符串格式化之.format</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8f13da16e2f37e458b4a58ad9cdb908a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">l360废墨收集垫清零_爱普生打印机废墨吸收垫已满，爱普生打印机清零一分钟就能学会...</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>