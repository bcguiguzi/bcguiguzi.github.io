<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Golang实现图片与视频的缩略图生成 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Golang实现图片与视频的缩略图生成" />
<meta property="og:description" content="图片与视频的缩略图是一个十分常见的需求，比如即时消息。这里摘取了Golang项目中的相关代码，分享图片与视频相关处理的开发经验。
图片缩略图 缩略图的尺寸分为两种规则：
1）边长模式，生成正方形缩略图；
2）宽高模式，又分三种：指定宽高、指定宽（高等比缩放）、指定高（宽等比缩放）。
如果原图为png或gif，缩略图则采用png格式；否则，都采用jpeg格式。
func createPhotoThumbnail(src string, thumbnail string, side int, width int, height int) (err error) { // open image srcFile, err := os.Open(src) if err != nil { return fmt.Errorf(&#34;opening image failed&#34;) } defer srcFile.Close() img, format, err := image.Decode(srcFile) if err != nil { return fmt.Errorf(&#34;decode image failed %v&#34;, err) } // process image var thumbnailImg image.Image if side &gt; 0 {	// 指定边长 var canvas image." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/3b0a60e4b5c6fe924c98807f67080519/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-07T18:04:13+08:00" />
<meta property="article:modified_time" content="2023-07-07T18:04:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Golang实现图片与视频的缩略图生成</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>图片与视频的缩略图是一个十分常见的需求，比如即时消息。这里摘取了Golang项目中的相关代码，分享图片与视频相关处理的开发经验。</p> 
<p></p> 
<h2>图片缩略图</h2> 
<p>缩略图的尺寸分为两种规则：</p> 
<p>1）边长模式，生成正方形缩略图；</p> 
<p>2）宽高模式，又分三种：指定宽高、指定宽（高等比缩放）、指定高（宽等比缩放）。</p> 
<p>如果原图为png或gif，缩略图则采用png格式；否则，都采用jpeg格式。</p> 
<pre><code class="language-Go">func createPhotoThumbnail(src string, thumbnail string, side int, width int, height int) (err error) {
	// open image
	srcFile, err := os.Open(src)
	if err != nil {
		return fmt.Errorf("opening image failed")
	}
	defer srcFile.Close()
	img, format, err := image.Decode(srcFile)
	if err != nil {
		return fmt.Errorf("decode image failed %v", err)
	}

	// process image
	var thumbnailImg image.Image
	if side &gt; 0 {	// 指定边长
		var canvas image.Image
        s := side
		sz := img.Bounds().Size()
        // 等比缩小
		if sz.X &gt; sz.Y {
			canvas = resize.Thumbnail(uint(sz.X), uint(s), img, resize.Lanczos2)
		} else {
			canvas = resize.Thumbnail(uint(s), uint(sz.Y), img, resize.Lanczos2)
		}
		sz = canvas.Bounds().Size()
		var l, t, r, b int
		if sz.X &gt; s {
			l = (sz.X - s) / 2
			r = l + s
		} else {
			l = 0
			r = sz.X
		}
		if sz.Y &gt; s {
			t = (sz.Y - s) / 2
			b = t + s
		} else {
			t = 0
			b = sz.Y
		}
        // 裁剪
		thumbnailImg = canvas.(*image.YCbCr).SubImage(image.Rect(l, t, r, b)).(*image.YCbCr)
	} else {	// 指定宽和高
        w := width
        h := height
		if w &gt; 0 &amp;&amp; h &gt; 0 {
		} else if w &gt; 0 {
			h = img.Bounds().Dy()
		} else {
			w = img.Bounds().Dx()
		}
		thumbnailImg = resize.Thumbnail(uint(w), uint(h), img, resize.Lanczos2)
	}

	// save thumbnail
	err = os.MkdirAll(filepath.Dir(thumbnail), os.ModePerm)
	if err != nil {
		return
	}
	thumbnailFile, err := os.Create(thumbnail)
	if err != nil {
		return
	}
	defer thumbnailFile.Close()
	if format == "png" || format == "gif" {
		err = png.Encode(thumbnailFile, thumbnailImg)
	} else {
		err = jpeg.Encode(thumbnailFile, thumbnailImg, &amp;jpeg.Options{Quality: 80})
	}
	return
}</code></pre> 
<h2>视频缩略图</h2> 
<p>生成视频的缩略图，需要先用ffmpeg命令行程序从视频中截取2秒之后的单帧图片，这里以Linux为例。然后，用上面的图片缩略图生成函数再生成指定尺寸的缩略图。</p> 
<pre><code class="language-Go">func createVideoThumbnail(src string, thumbnail string, side int, width int, height int) (err error) {
	ctx, cancel := context.WithTimeout(context.Background(), time.Duration(25)*time.Second)
	defer cancel()
	dir := filepath.Dir(thumbnail)
	os.MkdirAll(dir, os.ModePerm)
	tmp := thumbnail + ".tmp"
	c := exec.CommandContext(ctx, "./ffmpeg",
		"-loglevel", "error",
		"-y",
		"-ss", "2",
		"-accurate_seek", "-i", src,
		"-vframes", "1",
		"-f", "image2",
		tmp)
	var stderr bytes.Buffer
	c.Stderr = &amp;stderr
	err = c.Run()
	errStr := ""
	if err != nil {
		errStr = fmt.Sprintf("ffmpeg cmderr(%v) ", err)
	}
	if stderr.Len() != 0 {
		errStr += fmt.Sprintf("ffmpeg stderr(%v) ", stderr.String())
	}
	if ctx.Err() != nil {
		errStr += fmt.Sprintf("ffmpeg ctxerr(%v)", ctx.Err())
	}
	if errStr != "" {
		err = errors.New(errStr)
		return
	}
	err = createPhotoThumbnail(tmp, thumbnail, side, width, height)
	os.Remove(tmp)
	return
}</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/661b13ad866b6bbd8bc8ef82e6f6f839/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mmap函数</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/612fc8d3f8a21600f07935c34fc4900e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux 部署ftp服务</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>