<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【python学习】使用Mysql数据库进行数据分析-pymysql模块 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【python学习】使用Mysql数据库进行数据分析-pymysql模块" />
<meta property="og:description" content="参考：如何从Mysql8.0数据库中导入数据？四种方法帮你快速开启数据分析的第一步 - 知乎 (zhihu.com)
本文简述用python的Pymysql库对Mysql数据库进行数据分析 ，包括数据写入数据库存储，以及数据库中数据分析。
目录
一、Pymysql模块介绍
二、实操步骤
三、案例
一、Pymysql模块介绍
Mysql数据库是数据挖掘任务的数据源之一，通过pymysql模块可以直接连接Mysql数据库，进行增删改查等操作。Python连接Mysql的流程如下：
python与数据库连接时并不是一次性读取了所有数据，而是根据SQL语言进行操作。cursor在这里相当于执行SQL查询的货车，在Mysql数据库和Python程序之间传递信息。
二、实操步骤 1.导入pymysql
# 导入数值运算numpy、数据分析pandas、数据库连接pymysql和时间调试模块 import pandas as pd import numpy as np import pymysql import time 2.连接Mysql数据库
# 连接Mysql数据库 db = pymysql.connect(host=&#34;localhost&#34;, user=&#34;root&#34;, password=&#34;123456&#34;, database=&#34;zgj_project&#34;, charset=&#34;utf8mb4&#34;, cursorclass=pymysql.cursors.DictCursor) pymysql.connect()参数说明：
host(str): MySQL服务器地址，默认为本地主机(localhost)
port(int): MySQL服务器端口号，默认为当前用户
user(str): 用户名，没有默认值
password(str): 连接密码，没有默认值
db(str): 数据库名称
charset(str): 连接编码
cursorclass(str): cursor()使用的种类，默认值为MySQLdb.cursors.Cursor
pymysql.connect()实例对象方法说明：
db.close(): 可关闭数据库连接，并释放相关资源。
db.cursor([cursorClass]):返回一个指针对象，用于访问和操作数据库中的数据。
db.begin(): 用于开始一个事务，如果数据库的AUTOCOMMIT已经开启就关闭它，直到事务调用commit()和rollback()结束。
db.commit(): 表示事务提交
db.rollback():表示事务回退
3.创建游标
# 创建游标 cursor = db." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/ff3e4e15b9f5ea42edf1277cecd16480/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-09T19:53:30+08:00" />
<meta property="article:modified_time" content="2022-12-09T19:53:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【python学习】使用Mysql数据库进行数据分析-pymysql模块</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>参考：<a href="https://zhuanlan.zhihu.com/p/442573792" rel="nofollow" title="如何从Mysql8.0数据库中导入数据？四种方法帮你快速开启数据分析的第一步 - 知乎 (zhihu.com)">如何从Mysql8.0数据库中导入数据？四种方法帮你快速开启数据分析的第一步 - 知乎 (zhihu.com)</a></p> 
<p>本文简述用python的Pymysql库对Mysql数据库进行数据分析 ，包括数据写入数据库存储，以及数据库中数据分析。</p> 
<p id="%C2%A0%E4%B8%80%E3%80%81Pymysql%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D-toc" style="margin-left:40px;"></p> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="%C2%A0%E4%B8%80%E3%80%81Pymysql%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D-toc" style="margin-left:40px;"><a href="#%C2%A0%E4%B8%80%E3%80%81Pymysql%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D" rel="nofollow"> 一、Pymysql模块介绍</a></p> 
<p id="%E4%BA%8C%E3%80%81%E5%AE%9E%E6%93%8D%E6%AD%A5%E9%AA%A4-toc" style="margin-left:40px;"><a href="#%E4%BA%8C%E3%80%81%E5%AE%9E%E6%93%8D%E6%AD%A5%E9%AA%A4" rel="nofollow">二、实操步骤</a></p> 
<p id="%E4%B8%89%E3%80%81%E6%A1%88%E4%BE%8B-toc" style="margin-left:40px;"><a href="#%E4%B8%89%E3%80%81%E6%A1%88%E4%BE%8B" rel="nofollow">三、案例</a></p> 
<hr id="hr-toc"> 
<p></p> 
<p><span style="color:#fe2c24;"><strong> 一、Pymysql模块介绍</strong></span></p> 
<p>Mysql数据库是数据挖掘任务的数据源之一，通过pymysql模块可以直接连接Mysql数据库，进行增删改查等操作。Python连接Mysql的流程如下：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/0f/cb/9sgjhAFv_o.png"></p> 
<p>python与数据库连接时并不是一次性读取了所有数据，而是根据SQL语言进行操作。cursor在这里相当于执行SQL查询的货车，在Mysql数据库和Python程序之间传递信息。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/1a/51/qFxXaKIv_o.png"></p> 
<h3 id="%E4%BA%8C%E3%80%81%E5%AE%9E%E6%93%8D%E6%AD%A5%E9%AA%A4"><span style="color:#fe2c24;"><strong>二、实操步骤</strong></span></h3> 
<p><span style="color:#4da8ee;"><strong>1.导入pymysql</strong></span></p> 
<pre><code class="language-python"># 导入数值运算numpy、数据分析pandas、数据库连接pymysql和时间调试模块

import pandas as pd
import numpy as np
import pymysql
import time</code></pre> 
<p><span style="color:#4da8ee;"><strong>2.连接Mysql数据库</strong></span></p> 
<pre><code class="language-python"># 连接Mysql数据库
db = pymysql.connect(host="localhost",
                       user="root",
                       password="123456",
                       database="zgj_project",
                       charset="utf8mb4",
                       cursorclass=pymysql.cursors.DictCursor)</code></pre> 
<p> pymysql.connect()参数说明：</p> 
<blockquote> 
 <p>host(str):      MySQL服务器地址，默认为本地主机(localhost)<br> port(int):      MySQL服务器端口号，默认为当前用户<br> user(str):      用户名，没有默认值<br> password(str):   连接密码，没有默认值<br> db(str):       数据库名称<br> charset(str):    连接编码<br> cursorclass(str): cursor()使用的种类，默认值为MySQLdb.cursors.Cursor</p> 
</blockquote> 
<p> pymysql.connect()实例对象方法说明：</p> 
<blockquote> 
 <p>db.close():   可关闭数据库连接，并释放相关资源。<br> db.cursor([cursorClass]):返回一个指针对象，用于访问和操作数据库中的数据。<br> db.begin():   用于开始一个事务，如果数据库的AUTOCOMMIT已经开启就关闭它，直到事务调用commit()和rollback()结束。<br> db.commit():  表示事务提交<br> db.rollback():表示事务回退</p> 
</blockquote> 
<p><span style="color:#4da8ee;"><strong>3.创建游标</strong></span></p> 
<pre><code class="language-python"># 创建游标
cursor = db.cursor()</code></pre> 
<p>db.cursor()指针对象游标的方法说明：</p> 
<blockquote> 
 <p> cursor()的类型，括号中不填默认为元组，<br> 还有DictCursor: 字典类型，SSCursor: 无缓冲元组类型，SSDictCursor: 无缓冲字典类型<br> 适用于数据量很大，一次性返回太慢，或者服务端带宽较小；创建连接时，通过cursorclass 参数指定类型。<br> cursor.close():            方法，关闭指针并释放相关资源。<br> cursor.execute(query[,parameters]):执行数据库查询。<br> cursor.fetchall():         方法，可取出指针结果集中的所有行，返回的结果集一个元组(tuples)。<br> cursor.fetchmany([size=cursor.arraysize]):方法，从查询结果集中取出多行，我们可利用可选的参数指定取出的行数。<br> cursor.fetchone():         方法，从查询结果集中返回下一行。<br> cursor.arraysize:          属性,指定由cursor.fetchmany()方法返回行的数目，影响fetchall()的性能，默认值为1。<br> cursor.rowcount:           属性,指出上次查询或更新所发生行数。-1表示还没开始查询或没有查询到数据。</p> 
</blockquote> 
<p><span style="color:#4da8ee;"><strong>4.示例全部代码</strong></span></p> 
<pre><code class="language-python">#连接的全流程
#导入pymysql模块
import pymysql
#创建实例化对象
db = pymysql.connect(host="localhost",
                     user="root",
                     password="*********",
                     database="orderinfo",
                     charset='utf8mb4',
                     cursorclass=pymysql.cursors.DictCursor)
#创建游标
cursor = db.cursor()
#编写SQL语句
sql = "select * from ad limit 5000" 
#执行SQL语句
cursor.execute(sql)  
#取回查询结果集，并将字符串类型结果集转换为列表
result =  cursor.fetchall()
finalresult = list(result) 
#关闭游标
cursor.close() 
#关闭数据库连接
db.close()</code></pre> 
<p>过程中可能会出现程序异常情况，为了防止程序崩溃，采用以下两种方法增强代码鲁棒性。</p> 
<p><span style="color:#fe2c24;"><strong>（1）方法一：使用try...except连接防止程序崩溃</strong></span></p> 
<pre><code class="language-python">#方法一，连接过程使用try...except防止程序崩溃
import pymysql
#创建实例化对象
db = pymysql.connect(host="localhost",
                     user="root",
                     password="**********",
                     database="orderinfo",
                     charset='utf8mb4',
                     cursorclass=pymysql.cursors.DictCursor)
#创建游标
cursor = db.cursor()
try:
    sql = "select * from ad limit 5000"            #SQL查询代码，不需要分号
    t_start = time.time()                          #设置程序运行开始时间戳
    cursor.execute(sql)                            #游标执行SQL查询代码
    result =  cursor.fetchall()                    #获取结果集，此时查询过程已经完成
    finalresult = list(result)                     #取回的结果是元组，将其进行列表化
    t_mid = time.time()                            #设置程序运行截点时间戳
    print("成功获取数据！总共用时：",t_mid-t_start)#打印程序运行信息
except Exception as e:                             #程序异常判断
    cursor.rollback                                #程序运行异常进行回滚
finally: 
    cursor.close()              #一次查询结束后关闭游标，如果不关闭游标，下次还可以接着使用，但是占用资源
    db.close()                                     #关闭数据库连接
    t_end = time.time()                            #设置程序运行结束时间戳
    print("连接完毕！总共用时：",t_end-t_start)    #打印程序运行信息</code></pre> 
<p>每次都这么写实在太繁琐，所以，Python引入了with语句来自动帮我们调用close()方法： </p> 
<p><span style="color:#fe2c24;"><strong>（2）方法二：用with as结构连接</strong></span></p> 
<pre><code class="language-python">import pymysql
#创建实例化对象
db = pymysql.connect(host="localhost",
                     user="root",
                     password="***********",
                     database="orderinfo",
                     charset='utf8mb4',
                     cursorclass=pymysql.cursors.DictCursor)
#创建游标
cursor = db.cursor()
try:
    with db.cursor() as cursor:
        cursor.execute("drop table if exists employee")
        sql = """CREATE TABLE EMPLOYEE (
         FIRST_NAME  CHAR(20) NOT NULL,
         LAST_NAME  CHAR(20),
         AGE INT,  
         SEX CHAR(1),
         INCOME FLOAT )"""
        cursor.execute(sql)
        db.commit()
        
    with db.cursor() as cursor:
        sql = "INSERT INTO EMPLOYEE(FIRST_NAME, \
               LAST_NAME, AGE, SEX, INCOME) \
               VALUES ('%s', '%s',  %s,  '%s',  %s)" % \
              ('Mac','Mohan',20, 'M',2000)
       
        # 执行sql语句
        cursor.execute(sql)
        # 执行sql语句
        db.commit()
        
    with db.cursor() as cursor:
        # 读取单条记录
        sql = "SELECT * FROM EMPLOYEE"
        cursor.execute(sql)
        result = cursor.fetchone()
        print(result)
finally:
        db.close()
# {'FIRST_NAME': 'Mac', 'LAST_NAME': 'Mohan', 'AGE': 20, 'SEX': 'M', 'INCOME': 2000.0}</code></pre> 
<p>注：可采用封装函数以提高代码复用 </p> 
<pre><code class="language-python"># 封装
def get_con():      #连接数据库
    """
    获取MySql连接，return：mysql connection
    """
    return pymysql.connect(host="localhost",
                     user="root",
                     password="**********",
                     database="orderinfo",
                     charset='utf8mb4',
                     cursorclass=pymysql.cursors.DictCursor)
def get_query(sql): #进行数据查询
    """
    根据SQL代码进行查询，并返回结果
    paramater SQL
    return str"""
    conn = get_con()
    try:
        cursor = conn.cursor()
        cursor.execute(sql)
        conn.commit()
        return list(cursor.fetchall())
    finally:
        cursor.close()
        conn.close()
        
def insert_or_update(sql):
    """
    执行插入或更新数据操作
    paramater insert SQL or update SQL
    return None"""
    conn = get_con()
    try:
        cursor = conn.cursor()
        cursor.execute(sql)
        conn.commit() #注意这里只有commit才真正开始执行
    finally:
        cursor.close()
        conn.close()

# if __name__ = "__main__":
#     sql = "SELECT * FROM EMPLOYEE"
#     get_query(sql)</code></pre> 
<h3 id="%E4%B8%89%E3%80%81%E6%A1%88%E4%BE%8B"><span style="color:#fe2c24;"><strong>三、案例</strong></span></h3> 
<p>步骤：</p> 
<p><span style="color:#4da8ee;"><strong>1.从Excel中读取数据，json行简单整理</strong></span></p> 
<pre><code class="language-python">#从Excel中导入数据
import pandas as pd


dt1 = pd.read_excel(r"E:\test.xlsx")
dt1.info(memory_usage="deep")  # 查看数据集的基本信息，183 entries, total 20 columns


#获取数据的列名，以存入数据库
col = dt1.columns
#确定各列的数据类型
varchar = "varchar(60)"
int_ = "int"
float_ = "float"
datatype = [int_,varchar,varchar,float_,int_,int_,int_,int_,int_,varchar,varchar,varchar,varchar,varchar,varchar,varchar,int_,varchar,varchar,varchar]
#将列名和数据类型进行拼接
ncol = pd.DataFrame(list(zip(col,datatype)))
ncol["new"] = ncol[0]+" "+ncol[1]+","
print(ncol["new"])</code></pre> 
<p>输出结果： </p> 
<blockquote> 
 <p>0 item_id int,</p> 
 <p>1 item_name varchar(60),</p> 
 <p>2 TradeName varchar(60),</p> 
 <p>3 price float,</p> 
 <p>4 total_sale int,</p> 
 <p>5 month_sale int,</p> 
 <p>6 accum_comm int,</p> 
 <p>7 TM_points int,</p> 
 <p>8 CollectCount int,</p> 
 <p>9 Tastes varchar(60),</p> 
 <p>10 BodyType varchar(60),</p> 
 <p>11 ApplicablePhase varchar(60),</p> 
 <p>12 Brand varchar(60),</p> 
 <p>13 Classification varchar(60),</p> 
 <p>14 Breed varchar(60),</p> 
 <p>15 Manufacturer varchar(60),</p> 
 <p>16 Weight int,</p> 
 <p>17 Origin varchar(60),</p> 
 <p>18 ManufacturerAddress varchar(60),</p> 
 <p>19 RecipeTastePrescription varchar(60),</p> 
 <p>Name: new, dtype: object</p> 
</blockquote> 
<p><span style="color:#4da8ee;"><strong> 2.Python连接Mysql数据库创建一张新表</strong></span></p> 
<pre><code class="language-python"># 连接数据库，创建数据表Product_details_rawdata
sql1 = """create table Product_details_rawdata(
            item_id bigint,
            item_name varchar(120),
            TradeName varchar(60),
            price float,
            total_sale int,
            month_sale int,
            accum_comm int,
            TM_points int,
            CollectCount int,
            Tastes varchar(60),
            BodyType varchar(60),
            ApplicablePhase varchar(60),
            Brand varchar(60),
            Classification varchar(60),
            Breed varchar(60),
            Manufacturer varchar(60),
            Weight int,
            Origin varchar(60),
            ManufacturerAddress varchar(60),
            RecipeTastePrescription varchar(60))"""
#成功调用向数据库orderinfo中创建一张新的空表
insert_or_update(sql1)</code></pre> 
<p><strong><span style="color:#4da8ee;">3. 将数据导入Mysql数据库存储</span></strong></p> 
<p>（1）方法一：通过命令行进行文件导入</p> 
<p>连接数据库后，解除安全模式命令：set global local_infile = 'ON'，</p> 
<p>导入csv文件命令：</p> 
<blockquote> 
 <p>-&gt;load data local infile "E:\\CBdata\\1、orderdata\\output.csv"<br> -&gt;into table orderdata<br> -&gt;fields terminated by ","<br> -&gt;ignore 1 lines;</p> 
</blockquote> 
<p><strong> 注：mysql只能导入CSV文件，要想导入Excel文件，需要转换，然后在记事本打开，选择utf_8编码。</strong></p> 
<p>（2）方法二：通过mysqlworkbench图形界面导入文件</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/42/9d/sBmV5K65_o.png"></p> 
<p><strong>（3）方法三:通过for循环一句一句插入到表中</strong></p> 
<pre><code class="language-python">for i in range(10):
    sql2 = "INSERT INTO Product_details_rawdata(item_id, item_name, TradeName, price, total_sale,\
       month_sale, accum_comm, TM_points, CollectCount, Tastes,\
       BodyType, ApplicablePhase, Brand, Classification, Breed,\
       Manufacturer, Weight, Origin, ManufacturerAddress,\
       RecipeTastePrescription) VALUES (%s,'%s','%s',%s,%s,%s,%s,%s,%s,'%s','%s','%s','%s','%s','%s','%s',%s,'%s','%s','%s')" % \
       tuple(dt1.iloc[i,:].values)"
    insert_or_update(sql2)</code></pre> 
<p><strong>（4）方法四:通过pandas自带的导入数据库的功能</strong></p> 
<pre><code class="language-python">from sqlalchemy import create_engine
engine = create_engine('mysql+pymysql://root:password@localhost:3306/orderinfo')
dt1.to_sql(name='Product_details_rawdata', con=engine, chunksize=1000, if_exists='append', index=None)</code></pre> 
<p><span style="color:#4da8ee;"><strong>4.Mysql数据库中取数据进行数据分析</strong></span></p> 
<pre><code class="language-python"># 从Mysql库取数据，并进行数据分析
#取出orderinfo库中的Product_details_rawdata表中的全部记录
#SQL语句
sql3 = "select * from Product_details_rawdata"     
#调用函数取出数据 
orginal_data = get_query(sql3)            
 #转换为DataFrame          
dt2 = pd.DataFrame(orginal_data,columns=col)</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1c109d9d754a5805766b4d023e281ddf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">高防CDN是什么，有什么用，网站被攻击了怎么办？云服务器可以接入CDN使用吗？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3c9d07b7bf86699df30838c1a094aa74/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vuex的新写法引入mapState省略$store.state</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>