<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>什么是布隆过滤器？如何解决高并发缓存穿透问题？ - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="什么是布隆过滤器？如何解决高并发缓存穿透问题？" />
<meta property="og:description" content="日常开发中，大家经常使用缓存，但是你知道大型的互联网公司面对高并发流量，要注意缓存穿透问题吗!!! 本文会介绍布隆过滤器，空间换时间，以较低的内存空间、高效解决这个问题。
本篇文章的目录：
1、性能不够，缓存来凑 现在的年轻人都喜欢网购，没事就逛逛淘宝，剁剁手，买些自己喜欢的东西，释放下工作压力。
地址：
https://detail.tmall.com/item.htm?id=628993216729
上图是一个天猫 iphone12 的商品详情页，id表示商品的编号
我们都知道淘宝的访问量是非常高的，为了提升系统的吞吐量，做了很多性能优化，其中非常重要一点是将信息异构到缓存中。
有句话说的好：性能不够，缓存来凑。
但是，使用缓存时，我们要关注一个重要问题，如果缓存没有命中怎么办？
2、缓存没有命中，怎么办？ ①我们先查询缓存，判断缓存中是否有数据
②如果有数据，直接返回
③如果缓存为空，我们需要再查一次数据库，并将数据格式异构化，然后预热到缓冲中，然后将结果返回
注意：
步骤 ③ 存在风险漏洞，如果缓存中数据不存在，压力会转嫁给数据库。假如被竞争对手利用，搞无效请求流量攻击，瞬间大量请求打到数据库中，对系统性能产生很大影响，很容易把数据库打挂，这种现象称为缓存穿透。
3、那么如何处理缓存穿透？ 我们的思路是，缓存中能不能判断这个数据库值的存在性，如果真的不存在，直接返回，也避免一次数据库查询。
由于不存在是个无限边界，所以，我们采用反向策略，将存在的值建立一个高效的检索。每次缓存取值时，先走一次判空检索。
简单归纳下，这个框架的要求：
快速检索
内存空间要非常小
经调研，我们发现布隆过滤器具备以上两个条件。
4、什么是布隆过滤器？ 布隆过滤器（Bloom Filter）是1970年由布隆提出的。它实际上是一个很长的二进制向量和一系列随机映射函数。布隆过滤器可以用于检索一个元素是否在一个集合中。
优点：空间效率和查询时间都远远超过一般的算法。
缺点：有一定的误识别率，删除困难。
5、布隆过滤器如何构建？ 布隆过滤器本质上是一个 n 位的二进制数组，用0和1表示。
假如我们以商品为例，有三件商品，商品编码分别为，id1、id2、id3
a）首先，对id1，进行三次哈希，并确定其在二进制数组中的位置。
三次哈希，对应的二进制数组下标分别是 2、5、8，将原始数据从 0 变为 1。
b）对id2，进行三次哈希，并确定其在二进制数组中的位置。
三次哈希，对应的二进制数组下标分别是 2、7、98，将原始数据从 0 变为 1。
下标 2，之前已经被操作设置成 1，则本次认为是哈希冲突，不需要改动。
Hash 规则：如果在 Hash 后，原始位它是 0 的话，将其从 0 变为 1；如果本身这一位就是 1 的话，则保持不变。
6、布隆过滤器如何使用？ 跟初始化的过程有点类似，当查询一件商品的缓存信息时，我们首先要判断这件商品是否存在。
通过三个哈希函数对商品id计算哈希值然后，在布隆数组中查找访问对应的位值，0或1判断，三个值中，只要有一个不是1，那么我们认为数据是不存在的。 注意：布隆过滤器只能精确判断数据不存在情况，对于存在我们只能说是可能，因为存在Hash冲突情况，当然这个概率非常低。
7、如何减少布隆过滤器的误判？ a）增加二进制位数组的长度。这样经过hash后数据会更加的离散化，出现冲突的概率会大大降低" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/7e5d5481319d70c04824317c40b526b2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-23T14:52:14+08:00" />
<meta property="article:modified_time" content="2023-03-23T14:52:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">什么是布隆过滤器？如何解决高并发缓存穿透问题？</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>日常开发中，大家经常使用缓存，但是你知道大型的互联网公司面对高并发流量，要注意缓存穿透问题吗!!! 本文会介绍布隆过滤器，空间换时间，以较低的内存空间、高效解决这个问题。</p> 
<p>本篇文章的目录：<br> <img src="https://images2.imgbox.com/ac/f7/OyOjxKfx_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="1_5"></a>1、性能不够，缓存来凑</h3> 
<p>现在的年轻人都喜欢网购，没事就逛逛淘宝，剁剁手，买些自己喜欢的东西，释放下工作压力。<br> <img src="https://images2.imgbox.com/b5/b4/PiNgrdFC_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>地址：</p> 
 <p>https://detail.tmall.com/item.htm?id=628993216729</p> 
</blockquote> 
<p>上图是一个天猫 iphone12 的<code>商品详情页</code>，id表示商品的编号</p> 
<p>我们都知道淘宝的访问量是非常高的，为了提升系统的吞吐量，做了很多性能优化，其中非常重要一点是将信息异构到缓存中。</p> 
<p>有句话说的好：性能不够，缓存来凑。</p> 
<p>但是，使用缓存时，我们要关注一个重要问题，如果缓存没有命中怎么办？</p> 
<p><img src="https://images2.imgbox.com/c8/75/pgMTsIfG_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_24"></a>2、缓存没有命中，怎么办？</h3> 
<p><img src="https://images2.imgbox.com/92/fc/BvRoyp51_o.png" alt="在这里插入图片描述"><br> ①我们先查询缓存，判断缓存中是否有数据<br> ②如果有数据，直接返回<br> ③如果缓存为空，我们需要再查一次数据库，并将数据格式异构化，然后预热到缓冲中，然后将结果返回<br> 注意：</p> 
<p>步骤 ③ 存在风险漏洞，如果缓存中数据不存在，压力会转嫁给数据库。假如被竞争对手利用，搞无效请求流量攻击，瞬间大量请求打到数据库中，对系统性能产生很大影响，很容易把数据库打挂，这种现象称为缓存穿透。</p> 
<h3><a id="3_35"></a>3、那么如何处理缓存穿透？</h3> 
<p>我们的思路是，缓存中能不能判断这个数据库值的存在性，如果真的不存在，直接返回，也避免一次数据库查询。</p> 
<p>由于不存在是个<code>无限边界</code>，所以，我们采用反向策略，将存在的值建立一个高效的检索。每次缓存取值时，先走一次判空检索。</p> 
<p>简单归纳下，这个框架的要求：</p> 
<p>快速检索<br> 内存空间要非常小<br> 经调研，我们发现布<code>隆过滤器</code>具备以上两个条件。</p> 
<h3><a id="4_49"></a>4、什么是布隆过滤器？</h3> 
<p>布隆过滤器（Bloom Filter）是1970年由布隆提出的。它实际上是一个很长的二进制向量和一系列随机映射函数。布隆过滤器可以用于检索一个元素是否在一个集合中。</p> 
<p>优点：空间效率和查询时间都远远超过一般的算法。<br> 缺点：有一定的误识别率，删除困难。</p> 
<h3><a id="5_57"></a>5、布隆过滤器如何构建？</h3> 
<p>布隆过滤器本质上是一个 n 位的二进制数组，用0和1表示。</p> 
<p>假如我们以商品为例，有三件商品，商品编码分别为，<code>id1、id2、id3</code></p> 
<p>a）首先，对<code>id1</code>，进行三次哈希，并确定其在二进制数组中的位置。<br> <img src="https://images2.imgbox.com/55/df/O6DO8kIR_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>三次哈希，对应的二进制数组下标分别是 2、5、8，将原始数据从 0 变为 1。</p> 
</blockquote> 
<p>b）对id2，进行三次哈希，并确定其在二进制数组中的位置。<br> <img src="https://images2.imgbox.com/4b/68/MZrcvdCX_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>三次哈希，对应的二进制数组下标分别是 2、7、98，将原始数据从 0 变为 1。</p> 
</blockquote> 
<p>下标 2，之前已经被操作设置成 1，则本次认为是哈希冲突，不需要改动。</p> 
<p>Hash 规则：如果在 Hash 后，原始位它是 0 的话，将其从 0 变为 1；如果本身这一位就是 1 的话，则保持不变。</p> 
<h3><a id="6_76"></a>6、布隆过滤器如何使用？</h3> 
<p><img src="https://images2.imgbox.com/27/32/OFfXRbxd_o.png" alt="在这里插入图片描述"><br> 跟初始化的过程有点类似，当查询一件商品的缓存信息时，我们首先要判断这件商品是否存在。</p> 
<ul><li>通过三个哈希函数对商品id计算哈希值</li><li>然后，在布隆数组中查找访问对应的位值，0或1</li><li>判断，三个值中，只要有一个不是1，那么我们认为数据是不存在的。</li></ul> 
<p>注意：布隆过滤器只能精确判断数据不存在情况，对于存在我们只能说是可能，因为存在Hash冲突情况，当然这个概率非常低。</p> 
<h3><a id="7_89"></a>7、如何减少布隆过滤器的误判？</h3> 
<p>a）增加二进制位数组的长度。这样经过hash后数据会更加的离散化，出现冲突的概率会大大降低</p> 
<p>b）增加Hash的次数，变相的增加数据特征，特征越多，冲突的概率越小</p> 
<h3><a id="8_95"></a>8、布隆过滤器会不会很费内存？</h3> 
<p>带着疑问，我们来做个实验</p> 
<p>假设有1千万个数据，我们需要记录其是否存在。存在的话标记1，不存在标记为0。技术选型，框架采用Redis的BitMap存储。</p> 
<p>数据初始化预热代码：</p> 
<pre><code class="prism language-java">redisTemplate<span class="token punctuation">.</span><span class="token function">executePipelined</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedisCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">doInRedis</span><span class="token punctuation">(</span><span class="token class-name">RedisConnection</span> connection<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DataAccessException</span> <span class="token punctuation">{<!-- --></span>
        connection<span class="token punctuation">.</span><span class="token function">openPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token number">10000000</span><span class="token punctuation">;</span> offset <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> offset<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">boolean</span> value <span class="token operator">=</span> offset <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            connection<span class="token punctuation">.</span><span class="token function">setBit</span><span class="token punctuation">(</span><span class="token string">"bloom-filter-data-1"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offset<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        connection<span class="token punctuation">.</span><span class="token function">closePipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"数据预热完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>性能有点慢，我们也可以采用分组形式，10000个数一组，多批次提交。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/ca/bb/68JRWIP2_o.png" alt="在这里插入图片描述"><br> 数据上传完了后，大小 1.19M，跟我们设想的一样。</p> 
<p>计算公式： <strong>10000000/8/1024/1024=1.19M</strong></p> 
<h3><a id="9Java_127"></a>9、Java应用中，如何使用布隆过滤器？代码实例</h3> 
<p>Java语言的生态非常繁荣，提供了很多开箱即用的开源框架供我们使用。布隆过滤器也不例外，Java 中提供了一个 Redisson 的组件，它内置了布隆过滤器。<br> 首先引入依赖包</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>redisson<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>redisson<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">3.11</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>代码示例：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @author 
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">"redis://172.16.67.37:6379"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RedissonClient</span> cient <span class="token operator">=</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RBloomFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bloomFilter <span class="token operator">=</span> cient<span class="token punctuation">.</span><span class="token function">getBloomFilter</span><span class="token punctuation">(</span><span class="token string">"test5-bloom-filter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化布隆过滤器，数组长度100W，误判率 1%</span>
    bloomFilter<span class="token punctuation">.</span><span class="token function">tryInit</span><span class="token punctuation">(</span><span class="token number">1000000L</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 添加数据</span>
    bloomFilter<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Tom哥"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断是否存在</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bloomFilter<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"微观技术"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bloomFilter<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"Tom哥"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行结果：</p> 
<pre><code class="prism language-java"><span class="token boolean">false</span>   <span class="token comment">// 肯定不存在</span>
<span class="token boolean">true</span>    <span class="token comment">// 可能存在，有1%的误判率</span>
</code></pre> 
<p>注意：误判率设置过小，会产生更多次的 Hash 操作，降低系统的性能。通常我们的建议值是 1%</p> 
<h3><a id="10_169"></a>10、布隆过滤器二进制数组，如何处理删除？</h3> 
<p>初始化后的布隆过滤器，可以直接拿来使用了。但是如果原始数据删除了怎么办？布隆过滤器二进制数组如何维护？</p> 
<p>直接删除不行吗？</p> 
<p>还真不行！因为这里面有Hash冲突的可能，会导致误删。</p> 
<p>怎么办？</p> 
<p>方案1：开发定时任务，每隔几个小时，自动创建一个新的布隆过滤器数组，替换老的，有点<br> <code>CopyOnWriteArrayList</code>的味道</p> 
<p>方案2：布隆过滤器增加一个等长的数组，存储计数器，主要解决冲突问题，每次删除时对应的计数器减一，如果结果为0，更新主数组的二进制值为0</p> 
<h3><a id="11_185"></a>11、布隆过滤器的应用场景</h3> 
<p>本文重点介绍的，解决缓存穿透<br> 网页爬虫对URL的去重，避免爬取相同的URL地址<br> 反垃圾邮件，从数十亿个垃圾邮件列表中判断某邮箱是否垃圾邮箱</p> 
<p>原文地址:https://mp.weixin.qq.com/s?__biz=MzU0OTE4MzYzMw==&amp;mid=2247515984&amp;idx=5&amp;sn=391c392a5b4581cf3b0d4c3f2e09e1c4&amp;chksm=fbb136aeccc6bfb827fd0c34fe79fc8dec2a46c181609a74c42ad7b50729dc36fe6b4efd8a01&amp;scene=27</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a0b30056448778a9f9d76c47bad61c49/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何实现OPC DA Server和MQTT Broker之间的数据交互？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8419d2b564959baeb2795b187cfae1ef/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">elasticsearch与mysql数据同步</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>