<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>go中的go:linkname的理解 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="go中的go:linkname的理解" />
<meta property="og:description" content="什么是 go:linkname 在go语言的源码中，会发现很多，代码只有函数签名，却看不到函数体，如：
// src/os/proc.go 68行 func runtime_beforeExit() // implemented in runtime 此处我们只看到函数签名，却看不到函数体，全局搜了一把，发现它的函数体却定义在src/runtime/proc.go中
// os_beforeExit is called from os.Exit(0). //go:linkname os_beforeExit os.runtime_beforeExit func os_beforeExit() { if raceenabled { racefini() } } 它是通过go:linkname把函数签名和函数体连接在一起的。
指令格式：
//go:linkname B A 第一个参数表示当前方法或变量，第二个参数表示需要建立链接方法，变量的路径。
go:linkname引导编译器将当前(私有)方法或者变量在编译时链接到指定的位置的方法或者变量，第一个参数表示当前方法或变量，第二个参数表示目标方法或变量，因为这个指令会破坏系统和包的模块化，因此在使用时必须导入unsafe
注意点
go:linkname可以跨包使用，需要导入 unsafe包。A所在的包必须要打入B所在的包，这个也好理解，相当于A调用了B。go build无法编译go:linkname,必须用单独的compile命令进行编译，因为go build会加上-complete参数，这个参数会检查到没有方法体的方法，并且不通过，报错missing function body。或者，在这个没有方法体的包下添加一个空的aa.s 的汇编文件标示，就可以编译了。 为什么要用 go:linkname 这个指令不经常用，最好也不要用，但理解这个指令可以帮助你理解核心包的很多代码。在标准库中是为了可以使用另一个包的unexported的方法或者变量，在敲代码的时候是不可包外访问的，但是运行时用这个命令hack了一下，就变得可以访问。
最大的作用就是定向可访问。
实例 go-ole hello hello.s hello.go link link.go demo.go go.mod // hello.go // 要导入 link 包 // 一般需要一个可导出的方法，例如 CallHello package hello import ( _ &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/9e37de749a818459521927d5d8e024c3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-22T10:15:15+08:00" />
<meta property="article:modified_time" content="2021-12-22T10:15:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">go中的go:linkname的理解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5><a id="_golinkname_0"></a>什么是 go:linkname</h5> 
<p>在go语言的源码中，会发现很多，代码只有函数签名，却看不到函数体，如：</p> 
<pre><code class="prism language-go"><span class="token comment">// src/os/proc.go 68行</span>
<span class="token keyword">func</span> <span class="token function">runtime_beforeExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// implemented in runtime</span>
</code></pre> 
<p>此处我们只看到函数签名，却看不到函数体，全局搜了一把，发现它的函数体却定义在<code>src/runtime/proc.go</code>中</p> 
<pre><code class="prism language-go"><span class="token comment">// os_beforeExit is called from os.Exit(0).</span>
<span class="token comment">//go:linkname os_beforeExit os.runtime_beforeExit</span>
<span class="token keyword">func</span> <span class="token function">os_beforeExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> raceenabled <span class="token punctuation">{<!-- --></span>
        <span class="token function">racefini</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>它是通过<code>go:linkname</code>把函数签名和函数体连接在一起的。</p> 
<p>指令格式：</p> 
<pre><code class="prism language-go"><span class="token comment">//go:linkname B A</span>
</code></pre> 
<p>第一个参数表示当前方法或变量，第二个参数表示需要建立链接方法，变量的路径。</p> 
<p><code>go:linkname</code>引导编译器将当前(私有)方法或者变量在编译时链接到指定的位置的方法或者变量，第一个参数表示当前方法或变量，第二个参数表示目标方法或变量，因为这个指令会破坏系统和包的模块化，因此在使用时必须导入<code>unsafe</code></p> 
<p>注意点</p> 
<ul><li><code>go:linkname</code>可以跨包使用，需要导入 <code>unsafe</code>包。</li><li>A所在的包必须要打入B所在的包，这个也好理解，相当于A调用了B。</li><li><code>go build</code>无法编译<code>go:linkname</code>,必须用单独的<code>compile</code>命令进行编译，因为<code>go build</code>会加上<code>-complete</code>参数，这个参数会检查到没有方法体的方法，并且不通过，报错<code>missing function body</code>。或者，在这个没有方法体的包下添加一个空的<code>aa.s</code> 的汇编文件标示，就可以编译了。</li></ul> 
<h5><a id="_golinkname_41"></a>为什么要用 go:linkname</h5> 
<p>这个指令不经常用，<code>最好也不要用</code>，但理解这个指令可以帮助你理解核心包的很多代码。在标准库中是为了可以使用另一个包的unexported的方法或者变量，在敲代码的时候是不可包外访问的，但是运行时用这个命令hack了一下，就变得可以访问。</p> 
<p>最大的作用就是定向可访问。</p> 
<h5><a id="_47"></a>实例</h5> 
<pre><code class="prism language-bash">go-ole
	hello
		hello.s
		hello.go
	<span class="token function">link</span>
		link.go
	demo.go
	go.mod
</code></pre> 
<pre><code class="prism language-go"><span class="token comment">// hello.go</span>
<span class="token comment">// 要导入 link 包</span>
<span class="token comment">// 一般需要一个可导出的方法，例如 CallHello</span>

<span class="token keyword">package</span> hello

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token boolean">_</span> <span class="token string">"go-ole/link"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">CallHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-go"><span class="token comment">// link.go</span>
<span class="token comment">// 需要导入 unsafe 包</span>

<span class="token keyword">package</span> link

<span class="token keyword">import</span> <span class="token boolean">_</span> <span class="token string">"unsafe"</span>

<span class="token comment">//go:linkname helloWorld go-ole/hello.hello</span>
<span class="token keyword">func</span> <span class="token function">helloWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello world!"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-go"><span class="token comment">// demo.go</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"go-ole/hello"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	hello<span class="token punctuation">.</span><span class="token function">CallHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-bash">go build demo.go
demo.exe
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/84186234668b162a532c5da2b4d23293/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">安装wsl后环境变量失效问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/767b92f05cfc134dd0ac2e9a80d85ccf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SpringBoot的核心注解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>