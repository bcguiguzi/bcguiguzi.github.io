<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【vue3源码】十二、认识虚拟DOM - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【vue3源码】十二、认识虚拟DOM" />
<meta property="og:description" content="【vue3源码】十二、认识虚拟DOM 什么是虚拟DOM？ 虚拟DOM（也可以称为vnode）描述了一个真实的DOM结构，它和真实DOM一样都是由很多节点组成的一个树形结构。本质其实就是一个JS对象，如下就是一个vnode：
{ type: &#39;div&#39;, props: { id: &#39;container&#39; }, children: [ { type: &#39;span&#39;, props: { class: &#39;span1&#39; }, children: &#39;Hello &#39; }, { type: &#39;span&#39;, props: { class: &#39;span2&#39; }, children: &#39;World&#39; }, ] } 上面这个vnode描述的真实DOM结构如下：
&lt;div id=&#34;container&#34;&gt; &lt;span class=&#34;text1&#34;&gt;Hello &lt;/span&gt; &lt;span class=&#34;text2&#34;&gt;World&lt;/span&gt; &lt;/div&gt; 可以发现，虚拟节点的type描述了标签的类型，props描述了标签的属性，children描述了标签的子节点。当然一个vnode不仅只有这三个属性。vue3中对vnode的类型定义如下：
export interface VNode&lt; HostNode = RendererNode, HostElement = RendererElement, ExtraProps = { [key: string]: any } &gt; { // 标记为一个VNode __v_isVNode: true // 禁止将VNode处理为响应式对象 [ReactiveFlags." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/49a695395f0df3480b4118faf22d4f7a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-14T22:30:02+08:00" />
<meta property="article:modified_time" content="2022-09-14T22:30:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【vue3源码】十二、认识虚拟DOM</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="vue3DOM_0"></a>【vue3源码】十二、认识虚拟DOM</h2> 
<h3><a id="DOM_2"></a>什么是虚拟DOM？</h3> 
<p>虚拟DOM（也可以称为<code>vnode</code>）描述了一个真实的DOM结构，它和真实DOM一样都是由很多节点组成的一个树形结构。本质其实就是一个JS对象，如下就是一个<code>vnode</code>：</p> 
<pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'container'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'span'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'span1'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">'Hello '</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'span'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'span2'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">'World'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面这个<code>vnode</code>描述的真实DOM结构如下：</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Hello <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>可以发现，虚拟节点的<code>type</code>描述了标签的类型，<code>props</code>描述了标签的属性，<code>children</code>描述了标签的子节点。当然一个<code>vnode</code>不仅只有这三个属性。<code>vue3</code>中对<code>vnode</code>的类型定义如下：</p> 
<pre><code class="prism language-ts"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNode<span class="token operator">&lt;</span>
  HostNode <span class="token operator">=</span> RendererNode<span class="token punctuation">,</span>
  HostElement <span class="token operator">=</span> RendererElement<span class="token punctuation">,</span>
  ExtraProps <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span>
<span class="token operator">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 标记为一个VNode</span>
  __v_isVNode<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token comment">// 禁止将VNode处理为响应式对象</span>
  <span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">SKIP</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token comment">// 节点类型</span>
  type<span class="token operator">:</span> VNodeTypes
  <span class="token comment">// 节点的属性</span>
  props<span class="token operator">:</span> <span class="token punctuation">(</span>VNodeProps <span class="token operator">&amp;</span> ExtraProps<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token comment">// 便与DOM的复用，主要用在diff算法中</span>
  key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">symbol</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token comment">// 被用来给元素或子组件注册引用信息</span>
  ref<span class="token operator">:</span> VNodeNormalizedRef <span class="token operator">|</span> <span class="token keyword">null</span>
  scopeId<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  slotScopeIds<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token comment">// 子节点</span>
  children<span class="token operator">:</span> VNodeNormalizedChildren
  <span class="token comment">// 组件实例</span>
  component<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token comment">// 指令信息</span>
  dirs<span class="token operator">:</span> DirectiveBinding<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  transition<span class="token operator">:</span> TransitionHooks<span class="token operator">&lt;</span>HostElement<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span>

  <span class="token comment">// DOM</span>
  <span class="token comment">// vnode对应的DOM</span>
  el<span class="token operator">:</span> HostNode <span class="token operator">|</span> <span class="token keyword">null</span>
  anchor<span class="token operator">:</span> HostNode <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token comment">// fragment anchor</span>
  <span class="token comment">// teleport需要挂载的目标DOM</span>
  target<span class="token operator">:</span> HostElement <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token comment">// teleport挂载所需的锚点</span>
  targetAnchor<span class="token operator">:</span> HostNode <span class="token operator">|</span> <span class="token keyword">null</span>
   
  <span class="token comment">// 对于Static vnode所包含的静态节点数量</span>
  staticCount<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token comment">// suspense组件的边界</span>
  suspense<span class="token operator">:</span> SuspenseBoundary <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token comment">// suspense的default slot对应的vnode</span>
  ssContent<span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token comment">// suspense的fallback slot对应的vnode</span>
  ssFallback<span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token keyword">null</span>

  <span class="token comment">// 用于优化的标记，主要用于判断节点类型</span>
  shapeFlag<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token comment">// 用于diff优化的补丁标记</span>
  patchFlag<span class="token operator">:</span> <span class="token builtin">number</span>
  dynamicProps<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  dynamicChildren<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span>

  <span class="token comment">// application root node only</span>
  appContext<span class="token operator">:</span> AppContext <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token comment">/**
   * @internal attached by v-memo
   */</span>
  memo<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">/**
   * @internal __COMPAT__ only
   */</span>
  isCompatRoot<span class="token operator">?</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token comment">/**
   * @internal custom element interception hook
   */</span>
  ce<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>instance<span class="token operator">:</span> ComponentInternalInstance<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="DOM_110"></a>如何创建虚拟DOM</h3> 
<p><code>vue3</code>对外提供了<code>h()</code>方法用于创建虚拟DOM。所在文件路径：<code>packages/runtime-core/src/h.ts</code></p> 
<pre><code class="prism language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span>type<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> propsOrChildren<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> children<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> l <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length
  <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// propsOrChildren是对象且不是数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>propsOrChildren<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>propsOrChildren<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// propsOrChildren是vnode</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isVNode</span><span class="token punctuation">(</span>propsOrChildren<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>propsOrChildren<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 有props无子节点</span>
      <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> propsOrChildren<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 有子节点</span>
      <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> propsOrChildren<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果参数大于3，那么第三个参数及之后的参数都会被作为子节点处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      children <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">===</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isVNode</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      children <span class="token operator">=</span> <span class="token punctuation">[</span>children<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> propsOrChildren<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在<code>h</code>函数会使用<code>createVNode</code>函数创建虚拟DOM。</p> 
<pre><code class="prism language-ts"><span class="token keyword">export</span> <span class="token keyword">const</span> createVNode <span class="token operator">=</span> <span class="token punctuation">(</span>
  __DEV__ <span class="token operator">?</span> createVNodeWithArgsTransform <span class="token operator">:</span> _createVNode
<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> _createVNode
</code></pre> 
<p>可以看到<code>createVNode</code>在开发环境下会使用<code>createVNodeWithArgsTransform</code>，其他环境下会使用<code>_createVNode</code>。这里我们只看下<code>_createVNode</code>的实现。</p> 
<code>_createVNode</code>完整代码 
<pre><code class="prism language-ts"><span class="token keyword">function</span> <span class="token function">_createVNode</span><span class="token punctuation">(</span>
  type<span class="token operator">:</span> VNodeTypes <span class="token operator">|</span> ClassComponent <span class="token operator">|</span> <span class="token keyword">typeof</span> <span class="token constant">NULL_DYNAMIC_COMPONENT</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">(</span>Data <span class="token operator">&amp;</span> VNodeProps<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token builtin">unknown</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  patchFlag<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  dynamicProps<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  isBlockNode <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>type <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token constant">NULL_DYNAMIC_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid vnode type when creating vnode: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    type <span class="token operator">=</span> Comment
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果type已经是个vnode，则复制个新的vnode</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> cloned <span class="token operator">=</span> <span class="token function">cloneVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* mergeRef: true */</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>cloned<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isBlockTreeEnabled <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isBlockNode <span class="token operator">&amp;&amp;</span> currentBlock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cloned<span class="token punctuation">.</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        currentBlock<span class="token punctuation">[</span>currentBlock<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> cloned
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        currentBlock<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cloned<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    cloned<span class="token punctuation">.</span>patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">BAIL</span>
    <span class="token keyword">return</span> cloned
  <span class="token punctuation">}</span>

  <span class="token comment">// class组件的type</span>
  <span class="token class-name"><span class="token keyword">if</span></span> <span class="token punctuation">(</span><span class="token function">isClassComponent</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    type <span class="token operator">=</span> type<span class="token punctuation">.</span>__vccOpts
  <span class="token punctuation">}</span>

  <span class="token comment">//  兼容2.x的异步及函数式组件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__COMPAT__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    type <span class="token operator">=</span> <span class="token function">convertLegacyComponent</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> currentRenderingInstance<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// class、style的标准化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    props <span class="token operator">=</span> <span class="token function">guardReactiveProps</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token operator">!</span>
    <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">class</span><span class="token operator">:</span> klass<span class="token punctuation">,</span> style <span class="token punctuation">}</span> <span class="token operator">=</span> props
    <span class="token keyword">if</span> <span class="token punctuation">(</span>klass <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isString</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      props<span class="token punctuation">.</span>class <span class="token operator">=</span> <span class="token function">normalizeClass</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isProxy</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        style <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> style<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      props<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token function">normalizeStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 根据type属性确定patchFlag</span>
  <span class="token keyword">const</span> shapeFlag <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span>
    <span class="token operator">:</span> __FEATURE_SUSPENSE__ <span class="token operator">&amp;&amp;</span> <span class="token function">isSuspense</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">SUSPENSE</span>
    <span class="token operator">:</span> <span class="token function">isTeleport</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TELEPORT</span>
    <span class="token operator">:</span> <span class="token function">isObject</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span>
    <span class="token operator">:</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">FUNCTIONAL_COMPONENT</span>
    <span class="token operator">:</span> <span class="token number">0</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isProxy</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    type <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Vue received a Component which was made a reactive object. This can </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">lead to unnecessary performance overhead, and should be avoided by </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">marking the component with \`markRaw\` or using \`shallowRef\` </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">instead of \`ref\`.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\nComponent that was made reactive: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      type
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">createBaseVNode</span><span class="token punctuation">(</span>
    type<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
    children<span class="token punctuation">,</span>
    patchFlag<span class="token punctuation">,</span>
    dynamicProps<span class="token punctuation">,</span>
    shapeFlag<span class="token punctuation">,</span>
    isBlockNode<span class="token punctuation">,</span>
    <span class="token boolean">true</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>_createVNode</code>可以接受6个参数：</p> 
<ul><li><code>type</code>：<code>vnode</code>类型</li><li><code>props</code>：<code>vnode</code>的属性</li><li><code>children</code>：子<code>vnode</code></li><li><code>patchFlag</code>：补丁标记，由编译器生成<code>vnode</code>时的优化提示，在diff期间会进入对应优化</li><li><code>dynamicProps</code>：动态属性</li><li><code>isBlockNode</code>：是否是个<code>Block</code>节点</li></ul> 
<p>首先会对<code>type</code>进行校验，如果<code>type</code>是空的动态组件，进行提示，并将<code>type</code>指定为一个<code>Comment</code>注释DOM。</p> 
<pre><code class="prism language-ts"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>type <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token constant">NULL_DYNAMIC_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid vnode type when creating vnode: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  type <span class="token operator">=</span> Comment
<span class="token punctuation">}</span>
</code></pre> 
<p>如果<code>type</code>已经是个<code>vnode</code>，会从<code>type</code>复制出一个新的<code>vnode</code>。这种情况主要在<code>&lt;component :is="vnode"/&gt;</code>情况下发生</p> 
<pre><code class="prism language-ts"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> cloned <span class="token operator">=</span> <span class="token function">cloneVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* mergeRef: true */</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 修改其children属性及完善shapeFlag属性</span>
    <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>cloned<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 将被拷贝的对象存入currentBlock中</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isBlockTreeEnabled <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isBlockNode <span class="token operator">&amp;&amp;</span> currentBlock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cloned<span class="token punctuation">.</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      currentBlock<span class="token punctuation">[</span>currentBlock<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> cloned
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      currentBlock<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cloned<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  cloned<span class="token punctuation">.</span>patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">BAIL</span>
  <span class="token keyword">return</span> cloned
<span class="token punctuation">}</span>
</code></pre> 
<p>关于<code>cloneVNode</code>的实现：</p> 
<pre><code class="prism language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">cloneVNode</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  vnode<span class="token operator">:</span> VNode<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  extraProps<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>Data <span class="token operator">&amp;</span> VNodeProps<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  mergeRef <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token operator">:</span> VNode<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">U</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> props<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> patchFlag<span class="token punctuation">,</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> vnode
  <span class="token comment">// 如果存在extraProps，需要将extraProps和vnode的props进行合并</span>
  <span class="token keyword">const</span> mergedProps <span class="token operator">=</span> extraProps <span class="token operator">?</span> <span class="token function">mergeProps</span><span class="token punctuation">(</span>props <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> extraProps<span class="token punctuation">)</span> <span class="token operator">:</span> props
  <span class="token keyword">const</span> cloned<span class="token operator">:</span> VNode <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    __v_isVNode<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    __v_skip<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> vnode<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
    props<span class="token operator">:</span> mergedProps<span class="token punctuation">,</span>
    <span class="token comment">// 如果过mergedProps中不存在key，则设置为null</span>
    key<span class="token operator">:</span> mergedProps <span class="token operator">&amp;&amp;</span> <span class="token function">normalizeKey</span><span class="token punctuation">(</span>mergedProps<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//  如果过存在额外的ref</span>
    <span class="token comment">//      如果过需要合并ref</span>
    <span class="token comment">//          如果被拷贝节点中的ref是个数组，将调用normalizeRef处理ref，并将结果合并到被拷贝节点中的ref中</span>
    <span class="token comment">//          否则，创建一个新的数组，存储ref和normalizeRef(extraProps)的结果</span>
    <span class="token comment">//      否则直接调用normalizeRef(extraProps)处理新的ref</span>
    <span class="token comment">// 否则ref不变</span>
    ref<span class="token operator">:</span>
      extraProps <span class="token operator">&amp;&amp;</span> extraProps<span class="token punctuation">.</span>ref
        <span class="token operator">?</span> mergeRef <span class="token operator">&amp;&amp;</span> ref
          <span class="token operator">?</span> <span class="token function">isArray</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span>
            <span class="token operator">?</span> ref<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">normalizeRef</span><span class="token punctuation">(</span>extraProps<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token punctuation">[</span>ref<span class="token punctuation">,</span> <span class="token function">normalizeRef</span><span class="token punctuation">(</span>extraProps<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">]</span>
          <span class="token operator">:</span> <span class="token function">normalizeRef</span><span class="token punctuation">(</span>extraProps<span class="token punctuation">)</span>
        <span class="token operator">:</span> ref<span class="token punctuation">,</span>
    scopeId<span class="token operator">:</span> vnode<span class="token punctuation">.</span>scopeId<span class="token punctuation">,</span>
    slotScopeIds<span class="token operator">:</span> vnode<span class="token punctuation">.</span>slotScopeIds<span class="token punctuation">,</span>
    children<span class="token operator">:</span>
      __DEV__ <span class="token operator">&amp;&amp;</span> patchFlag <span class="token operator">===</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">HOISTED</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token punctuation">(</span>children <span class="token keyword">as</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>deepCloneVNode<span class="token punctuation">)</span>
        <span class="token operator">:</span> children<span class="token punctuation">,</span>
    target<span class="token operator">:</span> vnode<span class="token punctuation">.</span>target<span class="token punctuation">,</span>
    targetAnchor<span class="token operator">:</span> vnode<span class="token punctuation">.</span>targetAnchor<span class="token punctuation">,</span>
    staticCount<span class="token operator">:</span> vnode<span class="token punctuation">.</span>staticCount<span class="token punctuation">,</span>
    shapeFlag<span class="token operator">:</span> vnode<span class="token punctuation">.</span>shapeFlag<span class="token punctuation">,</span>
    <span class="token comment">// 如果 vnode 使用额外的 props 克隆，我们不能再假设其现有的补丁标志是可靠的，需要添加 FULL_PROPS 标志</span>
    <span class="token comment">// 如果存在extraProps，并且vnode.type不是是Fragment片段的情况下：</span>
    <span class="token comment">//    如果patchFlag为-1，说明是静态节点，它的内容不会发生变化。新的vnode的patchFlag为PatchFlags.FULL_PROPS，表示props中存在动态key</span>
    <span class="token comment">//    如果patchFlag不为-1，将patchFlag与PatchFlags.FULL_PROPS进行或运算</span>
    <span class="token comment">// 否则patchFlag保持不变</span>
    patchFlag<span class="token operator">:</span>
      extraProps <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>type <span class="token operator">!==</span> Fragment
        <span class="token operator">?</span> patchFlag <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">// hoisted node</span>
          <span class="token operator">?</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">FULL_PROPS</span>
          <span class="token operator">:</span> patchFlag <span class="token operator">|</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">FULL_PROPS</span>
        <span class="token operator">:</span> patchFlag<span class="token punctuation">,</span>
    dynamicProps<span class="token operator">:</span> vnode<span class="token punctuation">.</span>dynamicProps<span class="token punctuation">,</span>
    dynamicChildren<span class="token operator">:</span> vnode<span class="token punctuation">.</span>dynamicChildren<span class="token punctuation">,</span>
    appContext<span class="token operator">:</span> vnode<span class="token punctuation">.</span>appContext<span class="token punctuation">,</span>
    dirs<span class="token operator">:</span> vnode<span class="token punctuation">.</span>dirs<span class="token punctuation">,</span>
    transition<span class="token operator">:</span> vnode<span class="token punctuation">.</span>transition<span class="token punctuation">,</span>
    component<span class="token operator">:</span> vnode<span class="token punctuation">.</span>component<span class="token punctuation">,</span>
    suspense<span class="token operator">:</span> vnode<span class="token punctuation">.</span>suspense<span class="token punctuation">,</span>
    ssContent<span class="token operator">:</span> vnode<span class="token punctuation">.</span>ssContent <span class="token operator">&amp;&amp;</span> <span class="token function">cloneVNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>ssContent<span class="token punctuation">)</span><span class="token punctuation">,</span>
    ssFallback<span class="token operator">:</span> vnode<span class="token punctuation">.</span>ssFallback <span class="token operator">&amp;&amp;</span> <span class="token function">cloneVNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>ssFallback<span class="token punctuation">)</span><span class="token punctuation">,</span>
    el<span class="token operator">:</span> vnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span>
    anchor<span class="token operator">:</span> vnode<span class="token punctuation">.</span>anchor
  <span class="token punctuation">}</span>
  <span class="token comment">// 用于兼容vue2</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__COMPAT__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">defineLegacyVNodeProperties</span><span class="token punctuation">(</span>cloned<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> cloned <span class="token keyword">as</span> <span class="token builtin">any</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在复制节点的过程中主要处理经历以下步骤:</p> 
<ol><li>被拷贝节点的<code>props</code>与额外的<code>props</code>的合并</li><li>创建新的<code>vnode</code> 
  <ul><li><code>key</code>的处理：取合并后的<code>props</code>中的<code>key</code>，如果不存在，取<code>null</code></li><li><code>ref</code>的合并：根据是否需要合并<code>ref</code>，决定是否合并<code>ref</code></li><li><code>patchFlag</code>的处理：如果<code>vnode</code>使用额外的<code>props</code>克隆，补丁标志不再可靠的，需要添加<code>FULL_PROPS</code>标志</li><li><code>ssContent</code>的处理：使用<code>cloneVNode</code>复制被拷贝节点的<code>ssContent</code></li><li><code>ssFallback</code>的处理：使用<code>cloneVNode</code>复制被拷贝节点的<code>ssFallback</code></li></ul> </li><li>兼容<code>vue2</code></li><li>返回新的<code>vnode</code></li></ol> 
<p>在克隆<code>vnode</code>时，<code>props</code>会使用<code>mergeProps</code>进行合并：</p> 
<pre><code class="prism language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mergeProps</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token punctuation">(</span>Data <span class="token operator">&amp;</span> VNodeProps<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> ret<span class="token operator">:</span> Data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> toMerge <span class="token operator">=</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> toMerge<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'class'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">.</span>class <span class="token operator">!==</span> toMerge<span class="token punctuation">.</span>class<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 建立一个数组并调用normalizeClass，最终class会是字符串的形式</span>
          ret<span class="token punctuation">.</span>class <span class="token operator">=</span> <span class="token function">normalizeClass</span><span class="token punctuation">(</span><span class="token punctuation">[</span>ret<span class="token punctuation">.</span>class<span class="token punctuation">,</span> toMerge<span class="token punctuation">.</span>class<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'style'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 建立style数组并调用normalizeStyle，最终style是对象形式</span>
        ret<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token function">normalizeStyle</span><span class="token punctuation">(</span><span class="token punctuation">[</span>ret<span class="token punctuation">.</span>style<span class="token punctuation">,</span> toMerge<span class="token punctuation">.</span>style<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOn</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 以on开头的属性，统一按事件处理</span>
        <span class="token keyword">const</span> existing <span class="token operator">=</span> ret<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token keyword">const</span> incoming <span class="token operator">=</span> toMerge<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token comment">// 如果已经存在的key对应事件与incoming不同，并且已经存在的key对应事件中不包含incoming</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          incoming <span class="token operator">&amp;&amp;</span>
          existing <span class="token operator">!==</span> incoming <span class="token operator">&amp;&amp;</span>
          <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>existing<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> existing<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>incoming<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 如果过存在existing，将existing、incoming合并到一个新的数组中</span>
          ret<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> existing
            <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>existing <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">,</span> incoming <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> incoming
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 其他情况直接对ret[key]进行赋值，靠后合并的值会取代之前的值</span>
        ret<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> toMerge<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ret
<span class="token punctuation">}</span>
</code></pre> 
<p>关于<code>normalizeClass</code>、<code>normalizeStyle</code>的实现：</p> 
<pre><code class="prism language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">normalizeClass</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    res <span class="token operator">=</span> value
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> normalized <span class="token operator">=</span> <span class="token function">normalizeClass</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>normalized<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        res <span class="token operator">+=</span> normalized <span class="token operator">+</span> <span class="token string">' '</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name <span class="token keyword">in</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        res <span class="token operator">+=</span> name <span class="token operator">+</span> <span class="token string">' '</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">normalizeStyle</span><span class="token punctuation">(</span>
  value<span class="token operator">:</span> <span class="token builtin">unknown</span>
<span class="token punctuation">)</span><span class="token operator">:</span> NormalizedStyle <span class="token operator">|</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> res<span class="token operator">:</span> NormalizedStyle <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> item <span class="token operator">=</span> value<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">const</span> normalized <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token function">parseStringStyle</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token function">normalizeStyle</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token keyword">as</span> NormalizedStyle<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>normalized<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> normalized<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          res<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> normalized<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> listDelimiterRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">;(?![^(]*\))</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
<span class="token keyword">const</span> propertyDelimiterRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">:(.+)</span><span class="token regex-delimiter">/</span></span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parseStringStyle</span><span class="token punctuation">(</span>cssText<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> NormalizedStyle <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> ret<span class="token operator">:</span> NormalizedStyle <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  cssText<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>listDelimiterRE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> tmp <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>propertyDelimiterRE<span class="token punctuation">)</span>
      tmp<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ret<span class="token punctuation">[</span>tmp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> ret
<span class="token punctuation">}</span>
</code></pre> 
<p>回到<code>_createVNode</code>中，当复制出一个新的<code>vnode</code>后，调用了一个<code>normalizeChildren</code>方法，该方法的作用是对新复制的<code>vnode</code>，修改其<code>children</code>属性及完善<code>shapeFlag</code>属性</p> 
<pre><code class="prism language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> shapeFlag <span class="token punctuation">}</span> <span class="token operator">=</span> vnode
  <span class="token comment">// 如果children为null或undefined，children取null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    children <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果过children数数组，type改为ShapeFlags.ARRAY_CHILDREN</span>
    type <span class="token operator">=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> children <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 如果children是对象</span>
    <span class="token comment">// 如果vndoe是element或teleport</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> <span class="token punctuation">(</span>ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span> <span class="token operator">|</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TELEPORT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 取默认插槽</span>
      <span class="token keyword">const</span> slot <span class="token operator">=</span> <span class="token punctuation">(</span>children <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
      <span class="token keyword">if</span> <span class="token punctuation">(</span>slot<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// _c 标记由 withCtx() 添加，表示这是一个已编译的插槽</span>
        slot<span class="token punctuation">.</span>_c <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>slot<span class="token punctuation">.</span>_d <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token comment">// 将默认插槽的结果作为vnode的children</span>
        <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token function">slot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        slot<span class="token punctuation">.</span>_c <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>slot<span class="token punctuation">.</span>_d <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      type <span class="token operator">=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">SLOTS_CHILDREN</span>
      <span class="token keyword">const</span> slotFlag <span class="token operator">=</span> <span class="token punctuation">(</span>children <span class="token keyword">as</span> RawSlots<span class="token punctuation">)</span><span class="token punctuation">.</span>_
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>slotFlag <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>InternalObjectKey <span class="token keyword">in</span> children<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token comment">// 如果槽未规范化，则附加上下文实例（编译过或标准话的slots已经有上下文）</span>
        <span class="token punctuation">;</span><span class="token punctuation">(</span>children <span class="token keyword">as</span> RawSlots<span class="token punctuation">)</span><span class="token punctuation">.</span>_ctx <span class="token operator">=</span> currentRenderingInstance
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>slotFlag <span class="token operator">===</span> SlotFlags<span class="token punctuation">.</span><span class="token constant">FORWARDED</span> <span class="token operator">&amp;&amp;</span> currentRenderingInstance<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 子组件接收来自父组件的转发slots。</span>
        <span class="token comment">// 它的插槽类型由其父插槽类型决定。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token punctuation">(</span>currentRenderingInstance<span class="token punctuation">.</span>slots <span class="token keyword">as</span> RawSlots<span class="token punctuation">)</span><span class="token punctuation">.</span>_ <span class="token operator">===</span> SlotFlags<span class="token punctuation">.</span><span class="token constant">STABLE</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token punctuation">;</span><span class="token punctuation">(</span>children <span class="token keyword">as</span> RawSlots<span class="token punctuation">)</span><span class="token punctuation">.</span>_ <span class="token operator">=</span> SlotFlags<span class="token punctuation">.</span><span class="token constant">STABLE</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token punctuation">;</span><span class="token punctuation">(</span>children <span class="token keyword">as</span> RawSlots<span class="token punctuation">)</span><span class="token punctuation">.</span>_ <span class="token operator">=</span> SlotFlags<span class="token punctuation">.</span><span class="token constant">DYNAMIC</span>
          vnode<span class="token punctuation">.</span>patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">DYNAMIC_SLOTS</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 如果过children是function</span>
    children <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">default</span><span class="token operator">:</span> children<span class="token punctuation">,</span> _ctx<span class="token operator">:</span> currentRenderingInstance <span class="token punctuation">}</span>
    type <span class="token operator">=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">SLOTS_CHILDREN</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    children <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span>
    <span class="token comment">// force teleport children to array so it can be moved around</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TELEPORT</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      type <span class="token operator">=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span>
      children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">createTextVNode</span><span class="token punctuation">(</span>children <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      type <span class="token operator">=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  vnode<span class="token punctuation">.</span>children <span class="token operator">=</span> children <span class="token keyword">as</span> VNodeNormalizedChildren
  vnode<span class="token punctuation">.</span>shapeFlag <span class="token operator">|=</span> type
<span class="token punctuation">}</span>
</code></pre> 
<p>然后判断<code>vnode</code>是否应该被收集到<code>Block</code>中，并返回拷贝的节点。</p> 
<p>如果<code>type</code>不是<code>vnode</code>，在方法最后会调用一个<code>createBaseVNode</code>创建<code>vnode</code></p> 
<pre><code class="prism language-ts"><span class="token keyword">function</span> <span class="token function">createBaseVNode</span><span class="token punctuation">(</span>
  type<span class="token operator">:</span> VNodeTypes <span class="token operator">|</span> ClassComponent <span class="token operator">|</span> <span class="token keyword">typeof</span> <span class="token constant">NULL_DYNAMIC_COMPONENT</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">(</span>Data <span class="token operator">&amp;</span> VNodeProps<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token builtin">unknown</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  patchFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  dynamicProps<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  shapeFlag <span class="token operator">=</span> type <span class="token operator">===</span> Fragment <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>
  isBlockNode <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  needFullChildrenNormalization <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    __v_isVNode<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    __v_skip<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    type<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
    key<span class="token operator">:</span> props <span class="token operator">&amp;&amp;</span> <span class="token function">normalizeKey</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span>
    ref<span class="token operator">:</span> props <span class="token operator">&amp;&amp;</span> <span class="token function">normalizeRef</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span>
    scopeId<span class="token operator">:</span> currentScopeId<span class="token punctuation">,</span>
    slotScopeIds<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    children<span class="token punctuation">,</span>
    component<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    suspense<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    ssContent<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    ssFallback<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    dirs<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    transition<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    el<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    anchor<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    target<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    targetAnchor<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    staticCount<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    shapeFlag<span class="token punctuation">,</span>
    patchFlag<span class="token punctuation">,</span>
    dynamicProps<span class="token punctuation">,</span>
    dynamicChildren<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    appContext<span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> VNode

  <span class="token keyword">if</span> <span class="token punctuation">(</span>needFullChildrenNormalization<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
    <span class="token comment">// normalize suspense children</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__FEATURE_SUSPENSE__ <span class="token operator">&amp;&amp;</span> shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">SUSPENSE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token class-name"><span class="token keyword">as</span></span> <span class="token keyword">typeof</span> SuspenseImpl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// compiled element vnode - if children is passed, only possible types are</span>
    <span class="token comment">// string or Array.</span>
    vnode<span class="token punctuation">.</span>shapeFlag <span class="token operator">|=</span> <span class="token function">isString</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span>
      <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span>
      <span class="token operator">:</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// validate key</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>key <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">VNode created with invalid key (NaN). VNode type:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 收集vnode到block树中</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    isBlockTreeEnabled <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
    <span class="token comment">// 避免block自己收集自己</span>
    <span class="token operator">!</span>isBlockNode <span class="token operator">&amp;&amp;</span>
    <span class="token comment">// 存在父block</span>
    currentBlock <span class="token operator">&amp;&amp;</span>
    <span class="token comment">// vnode.patchFlag需要大于0或shapeFlag中存在ShapeFlags.COMPONENT</span>
    <span class="token comment">// patchFlag的存在表明该节点需要修补更新。</span>
    <span class="token comment">// 组件节点也应该总是打补丁，因为即使组件不需要更新，它也需要将实例持久化到下一个 vnode，以便以后可以正确卸载它</span>
    <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>patchFlag <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">COMPONENT</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token comment">// the EVENTS flag is only for hydration and if it is the only flag, the</span>
    <span class="token comment">// vnode should not be considered dynamic due to handler caching.</span>
    vnode<span class="token punctuation">.</span>patchFlag <span class="token operator">!==</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">HYDRATE_EVENTS</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    currentBlock<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>__COMPAT__<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">convertLegacyVModelProps</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
    <span class="token function">defineLegacyVNodeProperties</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> vnode
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_626"></a>总结</h3> 
<p>虚拟<code>DOM</code>的创建流程：</p> 
<ol><li>如果<code>type</code>是个空的动态组件，将<code>vnode.type</code>指定为<code>Comment</code>注释节点。</li><li>如果<code>type</code>已经是个<code>vnode</code>，则拷贝一个新的<code>vnode</code>返回。</li><li>处理<code>class component</code></li><li>兼容<code>vue2</code>的异步组件及函数式组件</li><li><code>class</code>及<code>style</code>的标准化</li><li>根据<code>type</code>属性初步确定<code>patchFlag</code></li><li>调用<code>createBaseVNode</code>方法创建<code>vnode</code>并返回</li></ol> 
<p><code>createBaseVNode</code>：</p> 
<ol><li>先创建一个<code>vnode</code>对象</li><li>完善<code>children</code>及<code>patchFlag</code>属性</li><li>判断是否应该被父<code>Block</code>收集</li><li>处理兼容<code>vue2</code></li><li>返回<code>vnode</code></li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6f7a01d4f05f42a35a4a7fe77e162351/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【uni-app报错】选择地址：fail the api need to be declared in the requiredPrivateInfos field in app/ext.json</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3d085d1db4bb7d6c336abaf2bf8b8b45/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Educational Codeforces Round 125 (Rated for Div. 2) CD题解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>