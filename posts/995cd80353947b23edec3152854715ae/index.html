<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>coturn服务器部署 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="coturn服务器部署" />
<meta property="og:description" content="一、coturn coturn 服务器完整的实现了 STUN/TURN/ICE 协议，支持 P2P 穿透防火墙。主要用于 webrtc 等点对点视频音频通话。
coturn 支持 tcp, udp, tls, dtls 连接；支持 linux bsd solaris mac os， 暂不支持windows
GITHUB: https://github.com/coturn/coturn
二、Centos 7 执行命令 cat /etc/centos-release
三、下载编译安装coturn（错误参照第四步） mkdir wlx cd wlx git clone https://github.com/coturn/coturn.git cd coturn ./configure make make install 查看是否安装成功 which turnserver
四、解决报错 4.1 OpenSSL 错误 执行安装 yum -y install openssl-devel
4.2 Libevent2错误 安装 下载 libevent
wget https://github.com/downloads/libevent/libevent/libevent-2.0.21-stable.tar.gz tar zxvf libevent-2.0.21-stable.tar.gz cd libevent-2.0.21-stable &amp;&amp; ./configure make &amp;&amp; make install 五、配置文件 5." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/995cd80353947b23edec3152854715ae/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-05-22T13:51:39+08:00" />
<meta property="article:modified_time" content="2019-05-22T13:51:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">coturn服务器部署</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>一、coturn</h2> 
<p>       coturn 服务器完整的实现了 STUN/TURN/ICE 协议，支持 P2P 穿透防火墙。主要用于 webrtc 等点对点视频音频通话。</p> 
<p>       coturn 支持 tcp, udp, tls, dtls 连接；支持 linux bsd solaris mac os， 暂不支持windows</p> 
<p>       GITHUB: <a href="https://github.com/coturn/coturn">https://github.com/coturn/coturn</a></p> 
<p> </p> 
<h2>二、Centos 7</h2> 
<p>       执行命令  <span style="color:#3399ea;"><strong>cat /etc/centos-release</strong></span></p> 
<p><img alt="" class="has" height="63" src="https://images2.imgbox.com/6d/66/81EjEewM_o.png" width="673"></p> 
<p> </p> 
<h2>三、下载编译安装coturn（错误参照第四步）</h2> 
<pre class="has"><code class="language-bash">mkdir wlx
cd wlx
git clone https://github.com/coturn/coturn.git
cd coturn
./configure 
make 
make install</code></pre> 
<h2> </h2> 
<h2><img alt="" class="has" height="225" src="https://images2.imgbox.com/99/83/X6lwc5AQ_o.png" width="1010"></h2> 
<p>查看是否安装成功 <span style="color:#3399ea;"><strong>which turnserver</strong></span></p> 
<h2><img alt="" class="has" height="93" src="https://images2.imgbox.com/86/a0/87ZaT6Ld_o.png" width="709"></h2> 
<p> </p> 
<h2>四、解决报错</h2> 
<h4><strong><span style="color:#f33b45;">4.1 OpenSSL 错误</span></strong></h4> 
<p><img alt="" class="has" height="465" src="https://images2.imgbox.com/38/22/Q9j1kREB_o.png" width="1200"></p> 
<p>执行安装 <span style="color:#f33b45;"><strong> yum -y install openssl-devel</strong></span></p> 
<h4><span style="color:#f33b45;"><strong>4.2 Libevent2错误</strong></span></h4> 
<p><img alt="" class="has" height="553" src="https://images2.imgbox.com/1b/32/xtF2Del8_o.png" width="1200"></p> 
<p>安装 下载 libevent</p> 
<pre class="has"><code class="language-bash">wget https://github.com/downloads/libevent/libevent/libevent-2.0.21-stable.tar.gz
tar zxvf libevent-2.0.21-stable.tar.gz
cd libevent-2.0.21-stable &amp;&amp; ./configure
make &amp;&amp; make install</code></pre> 
<h2>五、配置文件</h2> 
<p>    5.1 在/usr/local/etc/目录下有turnserver.conf.default，复制为turnserver.conf</p> 
<pre class="has"><code class="language-bash">cd /usr/local/etc/
cp turnserver.conf.default turnserver.conf</code></pre> 
<p>5.2 查看内网地址</p> 
<p><img alt="" class="has" height="472" src="https://images2.imgbox.com/5f/5c/b2aYZ2f0_o.png" width="1085"></p> 
<p>5.3 cert和pkey配置的自签名证书用Openssl命令生成,生成的两个文件在/etc/目录下</p> 
<pre class="has"><code class="language-bash">openssl req -x509 -newkey rsa:2048 -keyout /etc/turn_server_pkey.pem -out /etc/turn_server_cert.pem -days 99999 -nodes</code></pre> 
<p><img alt="" class="has" height="83" src="https://images2.imgbox.com/6d/0c/aPsjmfbm_o.png" width="833"></p> 
<p>5.4 修改配置信息(文件内容太长了，还是下载来下使用 Notepad++ 编辑吧)</p> 
<p><span style="color:#3399ea;"><strong>vi /usr/local/etc/turnserver.conf</strong></span><br> listening-ip与relay-ip采用内网ip，external-ip是外网的ip ，配置如下（相关的IP用户名什么的要替换成自己的）</p> 
<pre class="has"><code class="language-bash">relay-device=eth0   #与前ifconfig查到的网卡名称一致
listening-ip=172.31.156.145   #内网IP
listening-port=3478
tls-listening-port=5349
relay-ip=172.31.156.145
external-ip=47.105.104.4   #公网IP
relay-threads=50
lt-cred-mech
cert=/etc/turn_server_cert.pem
pkey=/etc/turn_server_pkey.pem
pidfile=”/var/run/turnserver.pid”
min-port=49152
max-port=65535
user=wlx:123456    #用户名密码，创建IceServer时用
cli-password=qwerty #不开启会报CONFIG ERROR: Empty cli-password, and so telnet cli interface is disabled! Please set a non empty cli-password!错误
 
#创建IceServer
IceServer turnIceServer = new IceServer("turn:47.105.104.4:3478","wlx","123456");
IceServer stunIceServer = new IceServer("stun:47.105.104.4:19302","","");</code></pre> 
<p> 5.5 启动</p> 
<p><span style="color:#3399ea;"><strong>turnserver -o -a -f -user=wlx:123456 -r Guangdong</strong></span></p> 
<p>5.6 关闭防火墙</p> 
<pre class="has"><code class="language-bash">启动： systemctl start firewalld
关闭： systemctl stop firewalld
查看状态： systemctl status firewalld 
开机禁用  ： systemctl disable firewalld
开机启用  ： systemctl enable firewalld
 </code></pre> 
<h2>六、测试</h2> 
<p>测试地址：<a href="https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/" rel="nofollow">https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/</a></p> 
<p>分别测试stun和turn服务器，只有relay地址回来的是你的ip才算穿透成功。</p> 
<p><img alt="" class="has" height="714" src="https://images2.imgbox.com/14/28/hEaxV0C2_o.png" width="1038"></p> 
<p><img alt="" class="has" height="774" src="https://images2.imgbox.com/57/0a/Zb3b33ji_o.png" width="1056"></p> 
<p>最后特别感谢 ： <a href="https://www.jianshu.com/p/915eab39476d" rel="nofollow">https://www.jianshu.com/p/915eab39476d  </a></p> 
<p> </p> 
<p> </p> 
<hr> 
<p>下面是最简单的配置,turn默认为3478   stun默认为19302</p> 
<pre class="has"><code class="language-bash">#监听端口可以不设置会默认的使用3478
listening-port=3478
##listening-ip,注意必须是你的内网IP地址如(如果你是阿里云的，就是私网地址）：
listening-ip=172.31.156.145
##relay-ip可以不设置，默认会使用你的外网ip地址作为转发包的中继地址,建议不设置，使用默认就可以：
##external-ip，注意必须使用你的外网IP地址如：
external-ip=47.105.104.4
##设置用户名及密码，这个是作为TURN服务器使用必须设置的,可以设置多个，我这里配置1个
user=wlx:123456


cli-password=qwerty #不开启会报CONFIG ERROR: Empty cli-password, and so telnet cli interface is disabled! Please set a non empty cli-password!错误
 </code></pre> 
<p>需要使用<span style="color:#3399ea;"><strong> turnserver -v -r ylbs -a -o -c /etc/turnserver.conf </strong></span> 启动注意后面的配置文件路径</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/eb8f26f244cdf3db664195747d8d4e39/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">windows 通过cmd命令（netsh wlan命令）连接wifi</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b50c7c0eecc06a45725b7182d4f3e679/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring boot websocket</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>