<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 13 有线网变更(用到的可以收藏) - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 13 有线网变更(用到的可以收藏)" />
<meta property="og:description" content="Android 13 有线网变更 文章目录 Android 13 有线网变更一、从接触的Android13 （Tv版）源码和测试结果看，有线网有如下变更：二、有线网具体变更介绍1、限制了设置有线网参数设置接口方法2、新增有线网开启关闭接口方法3、新增了 updateConfiguration 接口方法4、有线网设置的静态ip和代理信息重启后无效 三、总结1、有线网变化2、Android13 有线网适配思路3、其他 如果是Android12 的系统需要开发用到有线网络，那么本文可以让你少走一些弯路。
Android12 和13 网络部分变化是不大的，
Android11 到Android 12 网络部分无论是代码存放目录和代码逻辑都是有较多修改的。
一、从接触的Android13 （Tv版）源码和测试结果看，有线网有如下变更： 1、限制了设置有线网参数设置接口方法 2、新增有线网开启关闭接口方法 3、新增了 updateConfiguration 接口方法 4、有线网设置的静态ip和代理信息重启后无效 简单的说就是，如果app api 设置成Android13 ，应用用无法有以前的接口设置有线网信息。
二、有线网具体变更介绍 1、限制了设置有线网参数设置接口方法 有线网设置新路径：
packages\modules\Connectivity\framework-t\src\android\net\EthernetManager.java
@UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.R, trackingBug = 170729553) public IpConfiguration getConfiguration(String iface) { try { return mService.getConfiguration(iface); } catch (RemoteException e) { throw e.rethrowFromSystemServer(); } } @UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.R, trackingBug = 170729553) public void setConfiguration(@NonNull String iface, @NonNull IpConfiguration config) { try { mService." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/63075689614981dfcb200ad97d4b7642/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-10T19:00:38+08:00" />
<meta property="article:modified_time" content="2023-05-10T19:00:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 13 有线网变更(用到的可以收藏)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Android_13__0"></a>Android 13 有线网变更</h2> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Android_13__0" rel="nofollow">Android 13 有线网变更</a></li><li><ul><li><a href="#Android13_Tv_10" rel="nofollow">一、从接触的Android13 （Tv版）源码和测试结果看，有线网有如下变更：</a></li><li><a href="#_26" rel="nofollow">二、有线网具体变更介绍</a></li><li><ul><li><a href="#1_29" rel="nofollow">1、限制了设置有线网参数设置接口方法</a></li><li><a href="#2_85" rel="nofollow">2、新增有线网开启关闭接口方法</a></li><li><a href="#3_updateConfiguration__117" rel="nofollow">3、新增了 updateConfiguration 接口方法</a></li><li><a href="#4ip_188" rel="nofollow">4、有线网设置的静态ip和代理信息重启后无效</a></li></ul> 
   </li><li><a href="#_218" rel="nofollow">三、总结</a></li><li><ul><li><a href="#1_220" rel="nofollow">1、有线网变化</a></li><li><a href="#2Android13__245" rel="nofollow">2、Android13 有线网适配思路</a></li><li><a href="#3_276" rel="nofollow">3、其他</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>如果是Android12 的系统需要开发用到有线网络，那么本文可以让你少走一些弯路。</p> 
<p>Android12 和13 网络部分变化是不大的，<br> Android11 到Android 12 网络部分无论是代码存放目录和代码逻辑都是有较多修改的。</p> 
<h3><a id="Android13_Tv_10"></a>一、从接触的Android13 （Tv版）源码和测试结果看，有线网有如下变更：</h3> 
<pre><code>
1、限制了设置有线网参数设置接口方法
2、新增有线网开启关闭接口方法
3、新增了 updateConfiguration 接口方法
4、有线网设置的静态ip和代理信息重启后无效

</code></pre> 
<p>简单的说就是，如果app api 设置成Android13 ，应用用无法有以前的接口设置有线网信息。</p> 
<h3><a id="_26"></a>二、有线网具体变更介绍</h3> 
<h4><a id="1_29"></a>1、限制了设置有线网参数设置接口方法</h4> 
<p>有线网设置新路径：<br> packages\modules\Connectivity\framework-t\src\android\net\EthernetManager.java</p> 
<pre><code>
    @UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.R, trackingBug = 170729553)
    public IpConfiguration getConfiguration(String iface) {
        try {
            return mService.getConfiguration(iface);
        } catch (RemoteException e) {
            throw e.rethrowFromSystemServer();
        }
    }

    @UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.R, trackingBug = 170729553)
    public void setConfiguration(@NonNull String iface, @NonNull IpConfiguration config) {
        try {
            mService.setConfiguration(iface, config);
        } catch (RemoteException e) {
            throw e.rethrowFromSystemServer();
        }
    }

    @UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.R, trackingBug = 170729553)
    public String[] getAvailableInterfaces() {
        try {
            return mService.getAvailableInterfaces();
        } catch (RemoteException e) {
            throw e.rethrowAsRuntimeException();
        }
    }

</code></pre> 
<p>从上面看，主要是api加了限制 ：maxTargetSdk = Build.VERSION_CODES.R //Android11</p> 
<p>maxTargetSdk 表明最大支持的SDK 版本，R 表示Android11 .<br> 所以Android 12 或者更新的版本，在EthernetManager 是调用不到上面几个接口方法的！</p> 
<p>有线网Android12 之前的路径：</p> 
<pre><code>frameworks\base\core\java\android\net\EthernetManager.java
</code></pre> 
<p>后面开发Android12 或新版本代码，你会发现wifi 、蓝牙、热点 之前 framework 的源码都移动到了下面的package目录：</p> 
<pre><code>
packages\modules\Connectivity\

</code></pre> 
<h4><a id="2_85"></a>2、新增有线网开启关闭接口方法</h4> 
<p>EthernetManager.java</p> 
<pre><code>
    @RequiresPermission(anyOf = {
            NetworkStack.PERMISSION_MAINLINE_NETWORK_STACK,
            android.Manifest.permission.NETWORK_STACK,
            android.Manifest.permission.NETWORK_SETTINGS})
    @SystemApi(client = MODULE_LIBRARIES)
    public void setEthernetEnabled(boolean enabled) {
        try {
            mService.setEthernetEnabled(enabled);
        } catch (RemoteException e) {
            throw e.rethrowFromSystemServer();
        }
    }

</code></pre> 
<p>这个是新增的接口方法 setEthernetEnabled ，之前是要自己实现有线网开关的的。</p> 
<p>需要的权限上面已经说明的，基本是要系统签名的应用才能调用。</p> 
<p>Android 9 之前开发的增加开关接口方法过程：</p> 
<p>https://blog.csdn.net/wenzhi20102321/article/details/122243396</p> 
<h4><a id="3_updateConfiguration__117"></a>3、新增了 updateConfiguration 接口方法</h4> 
<p>EthernetManager.java</p> 
<pre><code>    @SystemApi
    @RequiresPermission(anyOf = {
            NetworkStack.PERMISSION_MAINLINE_NETWORK_STACK,
            android.Manifest.permission.NETWORK_STACK,
            android.Manifest.permission.MANAGE_ETHERNET_NETWORKS})
    public void updateConfiguration(
            @NonNull String iface,
            @NonNull EthernetNetworkUpdateRequest request,
            @Nullable @CallbackExecutor Executor executor,
            @Nullable OutcomeReceiver&lt;String, EthernetNetworkManagementException&gt; callback) {
        Objects.requireNonNull(iface, "iface must be non-null");
        Objects.requireNonNull(request, "request must be non-null");
        final NetworkInterfaceOutcomeReceiver proxy = makeNetworkInterfaceOutcomeReceiver(
                executor, callback);
        try {
            mService.updateConfiguration(iface, request, proxy);
        } catch (RemoteException e) {
            throw e.rethrowFromSystemServer();
        }
    }

</code></pre> 
<p>String iface //节点名称：eth0 / eth1<br> EthernetNetworkUpdateRequest request 对象是包含静态ip和代理信息对象和特征属性对象。<br> 后面两个是回调监听，具体使用需要自行研究，并且未要求非空，估计是可以传null 的。</p> 
<p>其实还要另外的坑，在有线网服务，新api 才有这个限制！</p> 
<p>具体代码情况：</p> 
<pre><code>packages\modules\Connectivity\service-t\src\com\android\server\ethernet\EthernetServiceImpl.java

    @Override
    public void updateConfiguration(@NonNull final String iface,
            @NonNull final EthernetNetworkUpdateRequest request,
            @Nullable final INetworkInterfaceOutcomeReceiver listener) {
        Objects.requireNonNull(iface);
        Objects.requireNonNull(request);
        throwIfEthernetNotStarted();


        // TODO: validate that iface is listed in overlay config_ethernet_interfaces
        // only automotive devices are allowed to set the NetworkCapabilities using this API
        //only automotive devices 表明，只有 车载设备支持设置该方法
+        // 非车载项目必须注释调方法：enforceAdminPermission ，否则会报错，这里是校验是否是车载项目
+        //enforceAdminPermission(iface, request.getNetworkCapabilities() != null,
+         //       "updateConfiguration() with non-null capabilities");
+        Log.i(TAG, " lwz add updateConfiguration with: iface=" + iface + ", listener=" + listener);
        maybeValidateTestCapabilities(iface, request.getNetworkCapabilities());

        mTracker.updateConfiguration(
                iface, request.getIpConfiguration(), request.getNetworkCapabilities(), listener);
    }

</code></pre> 
<p>所以要在自己项目中调用新的api ，必须设置属性让自己的设备识别为车载项目或者把车载判断的逻辑去除即可。</p> 
<p>TvSettings是可以设置有线网信息的，调用后就是会报异常。<br> 即使屏蔽了 校验车载的过程，TvSettings 中设置静态ip和代理信息还是有问题的，会显示未连接!<br> 所以TvSettings 中调用有线网的接口也是未完善的情况！</p> 
<h4><a id="4ip_188"></a>4、有线网设置的静态ip和代理信息重启后无效</h4> 
<p>查看有线网配置信息保存的类：</p> 
<pre><code>
packages\modules\Connectivity\service-t\src\com\android\server\ethernet\EthernetConfigStore.java

    private static final String CONFIG_FILE = "ipconfig.txt";
    private static final String FILE_PATH = "/misc/ethernet/";
    private static final String LEGACY_IP_CONFIG_FILE_PATH = Environment.getDataDirectory() + FILE_PATH;
    //Android13 新增下面路径：
    private static final String APEX_IP_CONFIG_FILE_PATH = ApexEnvironment.getApexEnvironment(
            TETHERING_MODULE_NAME).getDeviceProtectedDataDir() + FILE_PATH; // TETHERING_MODULE_NAME --》com.android.tethering

</code></pre> 
<p>可以看到之前的路径是：<br> /data/misc/ethernet/ipconfig.txt</p> 
<p>最新的有线网配置文件保存目录：<br> /data/misc/apexdata/com.android.tethering/misc/ethernet/ipconfig.txt</p> 
<p>但是保存有线网静态ip信息后未生成信息文件。具体原因就要进行具体分析了！！！目前正在分析。</p> 
<p>因为未成功保存本地配置文件，所以每次开机重启后，无法读取到静态ip和代理等信息。<br> 所以出现 有线网设置的静态ip和代理信息重启后无效 问题。</p> 
<h3><a id="_218"></a>三、总结</h3> 
<h4><a id="1_220"></a>1、有线网变化</h4> 
<pre><code>(1) 限制了设置有线网参数设置 setConfiguration 接口方法 等方法使用
(2) 新增有线网开启关闭接口方法
(3) 新增了 updateConfiguration 接口方法
(4) 有线网设置的静态ip和代理信息重启后无效

</code></pre> 
<p>从EthernetManager.java 源码可以看出，无法是获取配置和设置配置信息的方法都做了限制 Android11 以后不支持使用！</p> 
<p>所以Android12 以后，系统代码看起来只能支持开关操作，不支持设置静态ip和代理设置。</p> 
<p>但是新的api 中新增了 updateConfiguration 接口方法，可以进行设置静态ip和代理信息；<br> 不足的是新的api接口中未发现查询 之前配置的信息情况接口方法。<br> 还有个bug就是，如果要调用新api updateConfiguration 接口方法需要把项目属性设置成车载或者必须跳过车载校验<br> 后面N个版本后估计Google会进行完善，毕竟还是有很多Android设备是需要用到有线网的。</p> 
<p>尝试用一些手段后，发现Android13 也是可以正常设置静态ip和代理信息的，<br> 只是重启后设置的有线网配置信息无效了，这个需要对有线保存配置部分的逻辑进行分析处理了，应该是可以完善的。</p> 
<h4><a id="2Android13__245"></a>2、Android13 有线网适配思路</h4> 
<pre><code>
（1）使用新api接口设置静态ip和代理信息
（2）反射调用之前的接口方法
（3）去除EthernetManager 里面的限制编译新的framework jar包，这个我也不会！
（4）在 EthernetManager 新增一套接口，把限制的重新写一次，有点傻！

</code></pre> 
<p>系统源码中这个应用是有调用 有线网新api 接口示例：</p> 
<pre><code>packages/services/Car/tests/RailwayReferenceApp 

</code></pre> 
<p>但是上面的代码应用并未完善，需要自己进一步进行完善，有点坑。</p> 
<p>并且 EthernetManager 新api中并未有查询之前配置的信息情况的接口方法，<br> 所以需要查询要是要另辟蹊径，比如使用反射调用之前的接口方法。</p> 
<p>使用反射的方式调用api接口：</p> 
<p>https://blog.csdn.net/weixin_44917215/article/details/1300271321</p> 
<p>亲测，使用反射的方法是可以调用之前所有api 接口的！</p> 
<h4><a id="3_276"></a>3、其他</h4> 
<p>有线网的所有接口基本都是要系统权限才能调用！</p> 
<p>Android 普通设备一般不使用有线网，使用有线网的一般是大屏设备和盒子设备，基本是有 签名 权限的！</p> 
<p>其他有线网相关文章：</p> 
<p>Android9、11 有线网络开关设置：<br> <a href="https://blog.csdn.net/wenzhi20102321">https://blog.csdn.net/wenzhi20102321</a></p> 
<p>Android adb查看网络连接情况 ：<br> <a href="https://blog.csdn.net/wenzhi20102321">https://blog.csdn.net/wenzhi20102321</a></p> 
<p>Android11 有线网Score分析流程<br> <a href="https://blog.csdn.net/wenzhi20102321">https://blog.csdn.net/wenzhi20102321</a></p> 
<p>Android11 有线网和wifi优先级设置：<br> <a href="https://blog.csdn.net/wenzhi20102321">https://blog.csdn.net/wenzhi20102321</a></p> 
<p>后续还会写一下新api的demo 和完整的反射调用的demo！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/161df0999f1d06e033f9e6fc6668dabb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">自动化测试框架有哪几种？全网最全面的总结来了</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/936afe03927a91f9837e285d62d81446/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">安全测试 —— 越权漏洞</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>