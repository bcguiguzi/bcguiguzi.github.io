<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【AI的未来 - AI Agent系列】【MetaGPT】2. 实现自己的第一个Agent - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【AI的未来 - AI Agent系列】【MetaGPT】2. 实现自己的第一个Agent" />
<meta property="og:description" content="在MetaGPT中定义的一个agent运行示例如下：
一个agent在启动后他会观察自己能获取到的信息，加入自己的记忆中下一步进行思考，决定下一步的行动，也就是从Action1，Action2，Action3中选择执行的Action决定行动后，紧接着就执行对应行动，得到这个环节的结果 以Task3 作业为例，来看下使用MetaGPT 实现Agent的思路。Task3任务如下：
经过上面的学习，我想你已经对 MetaGPT 的框架有了基本了解，现在我希望你能够自己编写这样一个 agent
这个 Agent 拥有三个动作 打印1 打印2 打印3（初始化时 init_action([print,print,print])）重写有关方法（请不要使用act_by_order，我希望你能独立实现）使得 Agent 顺序执行上面三个动作当上述三个动作执行完毕后，为 Agent 生成新的动作 打印4 打印5 打印6 并顺序执行，（之前我们初始化了三个 print 动作，执行完毕后，重新 init_action([…,…,…])，然后顺序执行这个新生成的动作列表) 实现思路 用最通俗的话来总结：
要实现一个Agent，其实就是定义一个Role。该Role应该包含自己的Action。在Role的初始化中初始化ActionsRole重写_act函数或_react函数，Role run的时候会调用该函数 _react函数重写，一般是先思考_think下一步用哪个action，然后再_act Action重写run函数，这里面决定了我们对传入的内容到底要做什么样的处理，例如调用大模型得到结果 Task3 - 完整代码及注释 先看执行结果：顺序打印1-6，然后结束 完整代码及细节注释 # 加载 .env 到环境变量 from dotenv import load_dotenv, find_dotenv _ = load_dotenv(find_dotenv()) from metagpt.actions import Action from metagpt.logs import logger import asyncio from metagpt.roles import Role from metagpt.schema import Message ## 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/0927371059541a34f46062358e93b0a4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-14T18:08:24+08:00" />
<meta property="article:modified_time" content="2024-01-14T18:08:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【AI的未来 - AI Agent系列】【MetaGPT】2. 实现自己的第一个Agent</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>在MetaGPT中定义的一个agent运行示例如下：<br> <img src="https://images2.imgbox.com/91/f7/rWJ2rRl5_o.png" alt="在这里插入图片描述"></p> 
<ul><li>一个agent在启动后他会观察自己能获取到的信息，加入自己的记忆中</li><li>下一步进行思考，决定下一步的行动，也就是从Action1，Action2，Action3中选择执行的Action</li><li>决定行动后，紧接着就执行对应行动，得到这个环节的结果</li></ul> 
<p>以Task3 作业为例，来看下使用MetaGPT 实现Agent的思路。Task3任务如下：</p> 
<blockquote> 
 <p>经过上面的学习，我想你已经对 MetaGPT 的框架有了基本了解，现在我希望你能够自己编写这样一个 agent</p> 
 <ul><li>这个 Agent 拥有三个动作 打印1 打印2 打印3（初始化时 init_action([print,print,print])）</li><li>重写有关方法（请不要使用act_by_order，我希望你能独立实现）使得 Agent 顺序执行上面三个动作</li><li>当上述三个动作执行完毕后，为 Agent 生成新的动作 打印4 打印5 打印6 并顺序执行，（之前我们初始化了三个 print 动作，执行完毕后，重新 init_action([…,…,…])，然后顺序执行这个新生成的动作列表)</li></ul> 
</blockquote> 
<h3><a id="_12"></a>实现思路</h3> 
<p>用最通俗的话来总结：</p> 
<ol><li>要实现一个Agent，其实就是定义一个Role。该Role应该包含自己的Action。</li><li>在Role的初始化中初始化Actions</li><li>Role重写_act函数或_react函数，Role run的时候会调用该函数 
  <ul><li>_react函数重写，一般是先思考_think下一步用哪个action，然后再_act</li></ul> </li><li>Action重写run函数，这里面决定了我们对传入的内容到底要做什么样的处理，例如调用大模型得到结果</li></ol> 
<h3><a id="Task3___21"></a>Task3 - 完整代码及注释</h3> 
<ul><li>先看执行结果：顺序打印1-6，然后结束</li></ul> 
<p><img src="https://images2.imgbox.com/dd/58/CEXf98Ae_o.png" alt="在这里插入图片描述"></p> 
<ul><li>完整代码及细节注释</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># 加载 .env 到环境变量</span>
<span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv<span class="token punctuation">,</span> find_dotenv
_ <span class="token operator">=</span> load_dotenv<span class="token punctuation">(</span>find_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">from</span> metagpt<span class="token punctuation">.</span>actions <span class="token keyword">import</span> Action
<span class="token keyword">from</span> metagpt<span class="token punctuation">.</span>logs <span class="token keyword">import</span> logger
<span class="token keyword">import</span> asyncio        
<span class="token keyword">from</span> metagpt<span class="token punctuation">.</span>roles <span class="token keyword">import</span> Role
<span class="token keyword">from</span> metagpt<span class="token punctuation">.</span>schema <span class="token keyword">import</span> Message

<span class="token comment">## 1. 定义Action</span>
<span class="token keyword">class</span> <span class="token class-name">PrintAction</span><span class="token punctuation">(</span>Action<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> number<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_number <span class="token operator">=</span> number
        
    <span class="token comment">## 1.1 run方法中定义具体的处理操作，这里只是打印一个数</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_number<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_number


<span class="token comment">## 2. 定义Role</span>
<span class="token keyword">class</span> <span class="token class-name">Printer</span><span class="token punctuation">(</span>Role<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"Printer"</span><span class="token punctuation">,</span>
        profile<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"Printer"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> profile<span class="token punctuation">)</span>
        
        <span class="token comment">## 2.1 初始化中初始化该Role的Actions，这里首先初始化了3个Action，将会按顺序执行</span>
        self<span class="token punctuation">.</span>_init_actions<span class="token punctuation">(</span><span class="token punctuation">[</span>PrintAction<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PrintAction<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PrintAction<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_think</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Determine the next action to be taken by the role."""</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_rc<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>self<span class="token punctuation">,</span><span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>_setting<span class="token punctuation">}</span></span><span class="token string">: ready to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>_rc<span class="token punctuation">.</span>todo<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_rc<span class="token punctuation">.</span>todo <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 这里回到了第一个Action</span>
            logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"reset state to 0"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>

		<span class="token comment">## 这里决定下一个action是什么，_rc.state表示要执行的action的下标，_states记录了所有actions及其下标</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_rc<span class="token punctuation">.</span>state <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_states<span class="token punctuation">)</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"set state to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>_rc<span class="token punctuation">.</span>state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_rc<span class="token punctuation">.</span>state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># todo变为下一个action</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_rc<span class="token punctuation">.</span>todo <span class="token operator">=</span> <span class="token boolean">None</span>     
            
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_act</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        todo <span class="token operator">=</span> self<span class="token punctuation">.</span>_rc<span class="token punctuation">.</span>todo
        <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>todo<span class="token punctuation">)</span> <span class="token keyword">is</span> PrintAction<span class="token punctuation">:</span>
            ret <span class="token operator">=</span> <span class="token keyword">await</span> todo<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token number">3</span> <span class="token operator">==</span> ret<span class="token punctuation">:</span> <span class="token comment"># 这里判断下是第几个action了，根据任务描述，第三个任务完成后动态添加4,5,6 action</span>
                actions <span class="token operator">=</span> <span class="token punctuation">[</span>PrintAction<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PrintAction<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PrintAction<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>_init_actions<span class="token punctuation">(</span>actions<span class="token punctuation">)</span> <span class="token comment"># 动态添加4,5,6 action，这时候action4变成了第一个action</span>
                self<span class="token punctuation">.</span>_rc<span class="token punctuation">.</span>todo <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token comment"># _think中会设置为第一个Action，也就是action4</span>
            
        <span class="token keyword">return</span> <span class="token string">"Continue"</span>
        
    <span class="token comment">## 3. 重写_react函数    </span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_react</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"react"</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>_think<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">## 首先思考下一步执行哪个action</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_rc<span class="token punctuation">.</span>todo <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            result <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>_act<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">## 执行action，这里的action是_think里决定</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    msg <span class="token operator">=</span> <span class="token string">"start"</span> <span class="token comment">## 给一个msg，必须给一个非空的msg，否则run不起来，待研究</span>
    role <span class="token operator">=</span> Printer<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> role<span class="token punctuation">.</span>run<span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token comment">## 开始运行agent，会调用role里的_react</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>先写到这，展示个结果和总体步骤，后面有时间会详细拆解每一步的实现和细节，以及过程中遇到的坑及解决方法。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8ad3751266083f46a40f43914c57f3d0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">利用Monte Carlo进行数值积分（二）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a413d12c769cf2383fd2f70c865f789e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux：/proc/kmsg 与 /proc/sys/kernel/printk_xxx</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>