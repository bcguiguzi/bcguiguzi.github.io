<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>DataX更换python3，File “datax.py“, line 114 print readerRef - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="DataX更换python3，File “datax.py“, line 114 print readerRef" />
<meta property="og:description" content="datax 报错 File “datax.py”, line 114 print readerRef 报错： File &#34;datax.py&#34;, line 114 print readerRef 解决方案：更换安装目录下bin的对应文件
datax.py, dxprof.y, perftrace.py
我们去查看datax.py的bin目录
解决方案 参考网址：
https://github.com/WeiYe-Jing/datax-web/tree/master/doc/datax-web/datax-python3 或者复制下面的源码替换bin对应的py文件
注意：需要全部复制，包括编码的设定
datax.py
#!/usr/bin/env python # -*- coding:utf-8 -*- &#34;&#34;&#34; Life&#39;s short, Python more. &#34;&#34;&#34; import sys import os import signal import subprocess import time import re import socket import json from optparse import OptionParser from optparse import OptionGroup from string import Template import codecs import platform def isWindows(): return platform." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/c63bd329b5293dde74fac7f13641b24b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-18T00:23:03+08:00" />
<meta property="article:modified_time" content="2022-04-18T00:23:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">DataX更换python3，File “datax.py“, line 114 print readerRef</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="datax__File_dataxpy_line_114____print_readerRef_0"></a>datax 报错 File “datax.py”, line 114 print readerRef</h2> 
<h3><a id="_2"></a>报错：</h3> 
<pre><code>File "datax.py", line 114    print readerRef
</code></pre> 
<p>解决方案：更换安装目录下bin的对应文件</p> 
<p>datax.py, dxprof.y, perftrace.py</p> 
<p>我们去查看datax.py的bin目录</p> 
<p><img src="https://images2.imgbox.com/77/ae/JXMG6R5m_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-1c8jWgub-1650212347299)(C:\Users\大勇\AppData\Roaming\Typora\typora-user-images\image-20220418001121445.png)]"></p> 
<h3><a id="_15"></a>解决方案</h3> 
<p><a href="https://github.com/WeiYe-Jing/datax-web/tree/master/doc/datax-web/datax-python3">参考网址：</a></p> 
<pre><code>https://github.com/WeiYe-Jing/datax-web/tree/master/doc/datax-web/datax-python3
</code></pre> 
<p>或者复制下面的源码替换bin对应的py文件</p> 
<p>注意：需要全部复制，<strong>包括编码的设定</strong></p> 
<p>datax.py</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding:utf-8 -*-</span>


<span class="token triple-quoted-string string">"""
   Life's short, Python more.
"""</span>

<span class="token keyword">import</span> sys
<span class="token keyword">import</span> os
<span class="token keyword">import</span> signal
<span class="token keyword">import</span> subprocess

<span class="token keyword">import</span> time
<span class="token keyword">import</span> re
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> json
<span class="token keyword">from</span> optparse <span class="token keyword">import</span> OptionParser
<span class="token keyword">from</span> optparse <span class="token keyword">import</span> OptionGroup
<span class="token keyword">from</span> string <span class="token keyword">import</span> Template
<span class="token keyword">import</span> codecs
<span class="token keyword">import</span> platform

<span class="token keyword">def</span> <span class="token function">isWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> platform<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'Windows'</span>

DATAX_HOME <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

DATAX_VERSION <span class="token operator">=</span> <span class="token string">'DATAX-OPENSOURCE-3.0'</span>
<span class="token keyword">if</span> isWindows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    codecs<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token keyword">lambda</span> name<span class="token punctuation">:</span> name <span class="token operator">==</span> <span class="token string">'cp65001'</span> <span class="token keyword">and</span> codecs<span class="token punctuation">.</span>lookup<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    CLASS_PATH <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"%s/lib/*"</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>DATAX_HOME<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    CLASS_PATH <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"%s/lib/*:."</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>DATAX_HOME<span class="token punctuation">)</span>
LOGBACK_FILE <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"%s/conf/logback.xml"</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>DATAX_HOME<span class="token punctuation">)</span>
DEFAULT_JVM <span class="token operator">=</span> <span class="token string">"-Xms1g -Xmx1g -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=%s/log"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>DATAX_HOME<span class="token punctuation">)</span>
DEFAULT_PROPERTY_CONF <span class="token operator">=</span> <span class="token string">"-Dfile.encoding=UTF-8 -Dlogback.statusListenerClass=ch.qos.logback.core.status.NopStatusListener -Djava.security.egd=file:///dev/urandom -Ddatax.home=%s -Dlogback.configurationFile=%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
    DATAX_HOME<span class="token punctuation">,</span> LOGBACK_FILE<span class="token punctuation">)</span>
ENGINE_COMMAND <span class="token operator">=</span> <span class="token string">"java -server ${jvm} %s -classpath %s  ${params} com.alibaba.datax.core.Engine -mode ${mode} -jobid ${jobid} -job ${job}"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
    DEFAULT_PROPERTY_CONF<span class="token punctuation">,</span> CLASS_PATH<span class="token punctuation">)</span>
REMOTE_DEBUG_CONFIG <span class="token operator">=</span> <span class="token string">"-Xdebug -Xrunjdwp:transport=dt_socket,server=y,address=9999"</span>

RET_STATE <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"KILL"</span><span class="token punctuation">:</span> <span class="token number">143</span><span class="token punctuation">,</span>
    <span class="token string">"FAIL"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string">"OK"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string">"RUN"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string">"RETRY"</span><span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>


<span class="token keyword">def</span> <span class="token function">getLocalIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> socket<span class="token punctuation">.</span>gethostbyname<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>getfqdn<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>gethostname<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"Unknown"</span>


<span class="token keyword">def</span> <span class="token function">suicide</span><span class="token punctuation">(</span>signum<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> child_process
    <span class="token keyword">print</span> <span class="token operator">&gt;&gt;</span> sys<span class="token punctuation">.</span>stderr<span class="token punctuation">,</span> <span class="token string">"[Error] DataX receive unexpected signal %d, starts to suicide."</span> <span class="token operator">%</span> <span class="token punctuation">(</span>signum<span class="token punctuation">)</span>

    <span class="token keyword">if</span> child_process<span class="token punctuation">:</span>
        child_process<span class="token punctuation">.</span>send_signal<span class="token punctuation">(</span>signal<span class="token punctuation">.</span>SIGQUIT<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        child_process<span class="token punctuation">.</span>kill<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token operator">&gt;&gt;</span> sys<span class="token punctuation">.</span>stderr<span class="token punctuation">,</span> <span class="token string">"DataX Process was killed ! you did ?"</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>RET_STATE<span class="token punctuation">[</span><span class="token string">"KILL"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">register_signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> isWindows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">global</span> child_process
        signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> suicide<span class="token punctuation">)</span>
        signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> suicide<span class="token punctuation">)</span>
        signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> suicide<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">getOptionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    usage <span class="token operator">=</span> <span class="token string">"usage: %prog [options] job-url-or-path"</span>
    parser <span class="token operator">=</span> OptionParser<span class="token punctuation">(</span>usage<span class="token operator">=</span>usage<span class="token punctuation">)</span>

    prodEnvOptionGroup <span class="token operator">=</span> OptionGroup<span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token string">"Product Env Options"</span><span class="token punctuation">,</span>
                                     <span class="token string">"Normal user use these options to set jvm parameters, job runtime mode etc. "</span>
                                     <span class="token string">"Make sure these options can be used in Product Env."</span><span class="token punctuation">)</span>
    prodEnvOptionGroup<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">"-j"</span><span class="token punctuation">,</span> <span class="token string">"--jvm"</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">"&lt;jvm parameters&gt;"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"jvmParameters"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store"</span><span class="token punctuation">,</span>
                                  default<span class="token operator">=</span>DEFAULT_JVM<span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Set jvm parameters if necessary."</span><span class="token punctuation">)</span>
    prodEnvOptionGroup<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">"--jobid"</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">"&lt;job unique id&gt;"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"jobid"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"-1"</span><span class="token punctuation">,</span>
                                  <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Set job unique id when running by Distribute/Local Mode."</span><span class="token punctuation">)</span>
    prodEnvOptionGroup<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">"-m"</span><span class="token punctuation">,</span> <span class="token string">"--mode"</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">"&lt;job runtime mode&gt;"</span><span class="token punctuation">,</span>
                                  action<span class="token operator">=</span><span class="token string">"store"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"standalone"</span><span class="token punctuation">,</span>
                                  <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Set job runtime mode such as: standalone, local, distribute. "</span>
                                       <span class="token string">"Default mode is standalone."</span><span class="token punctuation">)</span>
    prodEnvOptionGroup<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">"-p"</span><span class="token punctuation">,</span> <span class="token string">"--params"</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">"&lt;parameter used in job config&gt;"</span><span class="token punctuation">,</span>
                                  action<span class="token operator">=</span><span class="token string">"store"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"params"</span><span class="token punctuation">,</span>
                                  <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Set job parameter, eg: the source tableName you want to set it by command, '</span>
                                       <span class="token string">'then you can use like this: -p"-DtableName=your-table-name", '</span>
                                       <span class="token string">'if you have mutiple parameters: -p"-DtableName=your-table-name -DcolumnName=your-column-name".'</span>
                                       <span class="token string">'Note: you should config in you job tableName with ${tableName}.'</span><span class="token punctuation">)</span>
    prodEnvOptionGroup<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">"-r"</span><span class="token punctuation">,</span> <span class="token string">"--reader"</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">"&lt;parameter used in view job config[reader] template&gt;"</span><span class="token punctuation">,</span>
                                  action<span class="token operator">=</span><span class="token string">"store"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"reader"</span><span class="token punctuation">,</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"string"</span><span class="token punctuation">,</span>
                                  <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'View job config[reader] template, eg: mysqlreader,streamreader'</span><span class="token punctuation">)</span>
    prodEnvOptionGroup<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">"-w"</span><span class="token punctuation">,</span> <span class="token string">"--writer"</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">"&lt;parameter used in view job config[writer] template&gt;"</span><span class="token punctuation">,</span>
                                  action<span class="token operator">=</span><span class="token string">"store"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"writer"</span><span class="token punctuation">,</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"string"</span><span class="token punctuation">,</span>
                                  <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'View job config[writer] template, eg: mysqlwriter,streamwriter'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option_group<span class="token punctuation">(</span>prodEnvOptionGroup<span class="token punctuation">)</span>

    devEnvOptionGroup <span class="token operator">=</span> OptionGroup<span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token string">"Develop/Debug Options"</span><span class="token punctuation">,</span>
                                    <span class="token string">"Developer use these options to trace more details of DataX."</span><span class="token punctuation">)</span>
    devEnvOptionGroup<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">"-d"</span><span class="token punctuation">,</span> <span class="token string">"--debug"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"remoteDebug"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">,</span>
                                 <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Set to remote debug mode."</span><span class="token punctuation">)</span>
    devEnvOptionGroup<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">"--loglevel"</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">"&lt;log level&gt;"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"loglevel"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store"</span><span class="token punctuation">,</span>
                                 default<span class="token operator">=</span><span class="token string">"info"</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Set log level such as: debug, info, all etc."</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option_group<span class="token punctuation">(</span>devEnvOptionGroup<span class="token punctuation">)</span>
    <span class="token keyword">return</span> parser

<span class="token keyword">def</span> <span class="token function">generateJobConfigTemplate</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> writer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    readerRef <span class="token operator">=</span> <span class="token string">"Please refer to the %s document:\n     https://github.com/alibaba/DataX/blob/master/%s/doc/%s.md \n"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>reader<span class="token punctuation">,</span>reader<span class="token punctuation">,</span>reader<span class="token punctuation">)</span>
    writerRef <span class="token operator">=</span> <span class="token string">"Please refer to the %s document:\n     https://github.com/alibaba/DataX/blob/master/%s/doc/%s.md \n "</span> <span class="token operator">%</span> <span class="token punctuation">(</span>writer<span class="token punctuation">,</span>writer<span class="token punctuation">,</span>writer<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>readerRef<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>writerRef<span class="token punctuation">)</span>
    jobGuid <span class="token operator">=</span> <span class="token string">'Please save the following configuration as a json file and  use\n     python {DATAX_HOME}/bin/datax.py {JSON_FILE_NAME}.json \nto run the job.\n'</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>jobGuid<span class="token punctuation">)</span>
    jobTemplate<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
      <span class="token string">"job"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"setting"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"speed"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"channel"</span><span class="token punctuation">:</span> <span class="token string">""</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token string">"reader"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"writer"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    readerTemplatePath <span class="token operator">=</span> <span class="token string">"%s/plugin/reader/%s/plugin_job_template.json"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>DATAX_HOME<span class="token punctuation">,</span>reader<span class="token punctuation">)</span>
    writerTemplatePath <span class="token operator">=</span> <span class="token string">"%s/plugin/writer/%s/plugin_job_template.json"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>DATAX_HOME<span class="token punctuation">,</span>writer<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
      readerPar <span class="token operator">=</span> readPluginTemplate<span class="token punctuation">(</span>readerTemplatePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Read reader[%s] template error: can\'t find file %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>reader<span class="token punctuation">,</span>readerTemplatePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
      writerPar <span class="token operator">=</span> readPluginTemplate<span class="token punctuation">(</span>writerTemplatePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Read writer[%s] template error: : can\'t find file %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>writer<span class="token punctuation">,</span>writerTemplatePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
    jobTemplate<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'reader'</span><span class="token punctuation">]</span> <span class="token operator">=</span> readerPar<span class="token punctuation">;</span>
    jobTemplate<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'writer'</span><span class="token punctuation">]</span> <span class="token operator">=</span> writerPar<span class="token punctuation">;</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>jobTemplate<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> sort_keys<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">readPluginTemplate</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token keyword">return</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">isUrl</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> path<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">assert</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    m <span class="token operator">=</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r"^http[s]?://\S+\w*"</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> m<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>


<span class="token keyword">def</span> <span class="token function">buildStartCommand</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    commandMap <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    tempJVMCommand <span class="token operator">=</span> DEFAULT_JVM
    <span class="token keyword">if</span> options<span class="token punctuation">.</span>jvmParameters<span class="token punctuation">:</span>
        tempJVMCommand <span class="token operator">=</span> tempJVMCommand <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>jvmParameters

    <span class="token keyword">if</span> options<span class="token punctuation">.</span>remoteDebug<span class="token punctuation">:</span>
        tempJVMCommand <span class="token operator">=</span> tempJVMCommand <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> REMOTE_DEBUG_CONFIG
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'local ip: '</span><span class="token punctuation">,</span> getLocalIp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> options<span class="token punctuation">.</span>loglevel<span class="token punctuation">:</span>
        tempJVMCommand <span class="token operator">=</span> tempJVMCommand <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string">"-Dloglevel=%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>loglevel<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> options<span class="token punctuation">.</span>mode<span class="token punctuation">:</span>
        commandMap<span class="token punctuation">[</span><span class="token string">"mode"</span><span class="token punctuation">]</span> <span class="token operator">=</span> options<span class="token punctuation">.</span>mode

    <span class="token comment"># jobResource 可能是 URL，也可能是本地文件路径（相对,绝对）</span>
    jobResource <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> isUrl<span class="token punctuation">(</span>jobResource<span class="token punctuation">)</span><span class="token punctuation">:</span>
        jobResource <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>jobResource<span class="token punctuation">)</span>
        <span class="token keyword">if</span> jobResource<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"file://"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            jobResource <span class="token operator">=</span> jobResource<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">"file://"</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

    jobParams <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"-Dlog.file.name=%s"</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>jobResource<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> options<span class="token punctuation">.</span>params<span class="token punctuation">:</span>
        jobParams <span class="token operator">=</span> jobParams <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>params

    <span class="token keyword">if</span> options<span class="token punctuation">.</span>jobid<span class="token punctuation">:</span>
        commandMap<span class="token punctuation">[</span><span class="token string">"jobid"</span><span class="token punctuation">]</span> <span class="token operator">=</span> options<span class="token punctuation">.</span>jobid

    commandMap<span class="token punctuation">[</span><span class="token string">"jvm"</span><span class="token punctuation">]</span> <span class="token operator">=</span> tempJVMCommand
    commandMap<span class="token punctuation">[</span><span class="token string">"params"</span><span class="token punctuation">]</span> <span class="token operator">=</span> jobParams
    commandMap<span class="token punctuation">[</span><span class="token string">"job"</span><span class="token punctuation">]</span> <span class="token operator">=</span> jobResource

    <span class="token keyword">return</span> Template<span class="token punctuation">(</span>ENGINE_COMMAND<span class="token punctuation">)</span><span class="token punctuation">.</span>substitute<span class="token punctuation">(</span><span class="token operator">**</span>commandMap<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">printCopyright</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
DataX (%s), From Alibaba !
Copyright (C) 2010-2017, Alibaba Group. All Rights Reserved.
'''</span> <span class="token operator">%</span> DATAX_VERSION<span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    printCopyright<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser <span class="token operator">=</span> getOptionParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    options<span class="token punctuation">,</span> args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> options<span class="token punctuation">.</span>reader <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> options<span class="token punctuation">.</span>writer <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        generateJobConfigTemplate<span class="token punctuation">(</span>options<span class="token punctuation">.</span>reader<span class="token punctuation">,</span>options<span class="token punctuation">.</span>writer<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>RET_STATE<span class="token punctuation">[</span><span class="token string">'OK'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
        parser<span class="token punctuation">.</span>print_help<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>RET_STATE<span class="token punctuation">[</span><span class="token string">'FAIL'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    startCommand <span class="token operator">=</span> buildStartCommand<span class="token punctuation">(</span>options<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token comment"># print startCommand</span>

    child_process <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>startCommand<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    register_signal<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>stdout<span class="token punctuation">,</span> stderr<span class="token punctuation">)</span> <span class="token operator">=</span> child_process<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>

    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>child_process<span class="token punctuation">.</span>returncode<span class="token punctuation">)</span>
</code></pre> 
<p>dxprof.py</p> 
<pre><code class="prism language-python"><span class="token comment">#! /usr/bin/env python</span>
<span class="token comment"># vim: set expandtab tabstop=4 shiftwidth=4 foldmethod=marker nu:</span>

<span class="token keyword">import</span> re
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> time

REG_SQL_WAKE <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'Begin\s+to\s+read\s+record\s+by\s+Sql'</span><span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
REG_SQL_DONE <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'Finished\s+read\s+record\s+by\s+Sql'</span><span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
REG_SQL_PATH <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'from\s+(\w+)(\s+where|\s*$)'</span><span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
REG_SQL_JDBC <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'jdbcUrl:\s*\[(.+?)\]'</span><span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
REG_SQL_UUID <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'(\d+\-)+reader'</span><span class="token punctuation">)</span>
REG_COMMIT_UUID <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'(\d+\-)+writer'</span><span class="token punctuation">)</span>
REG_COMMIT_WAKE <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'begin\s+to\s+commit\s+blocks'</span><span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
REG_COMMIT_DONE <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'commit\s+blocks\s+ok'</span><span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>

<span class="token comment"># {<!-- -->{<!-- -->{ function parse_timestamp() #</span>
<span class="token keyword">def</span> <span class="token function">parse_timestamp</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        ts <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>mktime<span class="token punctuation">(</span>time<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m-%d %H:%M:%S'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        ts <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">return</span> ts

<span class="token comment"># }}} #</span>

<span class="token comment"># {<!-- -->{<!-- -->{ function parse_query_host() #</span>
<span class="token keyword">def</span> <span class="token function">parse_query_host</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ori <span class="token operator">=</span> REG_SQL_JDBC<span class="token punctuation">.</span>search<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">not</span> ori<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">''</span>

    ori <span class="token operator">=</span> ori<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    off <span class="token operator">=</span> ori<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'@'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>off <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ori <span class="token operator">=</span> ori<span class="token punctuation">[</span>off<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">(</span>ori<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        off <span class="token operator">=</span> ori<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'//'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>off <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            ori <span class="token operator">=</span> ori<span class="token punctuation">[</span>off<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">(</span>ori<span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> ori<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># }}} #</span>

<span class="token comment"># {<!-- -->{<!-- -->{ function parse_query_table() #</span>
<span class="token keyword">def</span> <span class="token function">parse_query_table</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ori <span class="token operator">=</span> REG_SQL_PATH<span class="token punctuation">.</span>search<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>ori <span class="token keyword">and</span> ori<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">''</span>
<span class="token comment"># }}} #</span>

<span class="token comment"># {<!-- -->{<!-- -->{ function parse_reader_task() #</span>
<span class="token keyword">def</span> <span class="token function">parse_task</span><span class="token punctuation">(</span>fname<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> LAST_SQL_UUID
    <span class="token keyword">global</span> LAST_COMMIT_UUID
    <span class="token keyword">global</span> DATAX_JOBDICT
    <span class="token keyword">global</span> DATAX_JOBDICT_COMMIT
    <span class="token keyword">global</span> UNIXTIME
    LAST_SQL_UUID <span class="token operator">=</span> <span class="token string">''</span>
    DATAX_JOBDICT <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    LAST_COMMIT_UUID <span class="token operator">=</span> <span class="token string">''</span>
    DATAX_JOBDICT_COMMIT <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    UNIXTIME <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            line <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>LAST_SQL_UUID <span class="token keyword">and</span> <span class="token punctuation">(</span>LAST_SQL_UUID <span class="token keyword">in</span> DATAX_JOBDICT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                DATAX_JOBDICT<span class="token punctuation">[</span>LAST_SQL_UUID<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span> <span class="token operator">=</span> parse_query_host<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
                LAST_SQL_UUID <span class="token operator">=</span> <span class="token string">''</span>

            <span class="token keyword">if</span> line<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'CommonRdbmsReader$Task'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                parse_read_task<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> line<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'commit blocks'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                parse_write_task<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
<span class="token comment"># }}} #</span>

<span class="token comment"># {<!-- -->{<!-- -->{ function parse_read_task() #</span>
<span class="token keyword">def</span> <span class="token function">parse_read_task</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ser <span class="token operator">=</span> REG_SQL_UUID<span class="token punctuation">.</span>search<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> ser<span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    LAST_SQL_UUID <span class="token operator">=</span> ser<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> REG_SQL_WAKE<span class="token punctuation">.</span>search<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">:</span>
        DATAX_JOBDICT<span class="token punctuation">[</span>LAST_SQL_UUID<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'stat'</span> <span class="token punctuation">:</span> <span class="token string">'R'</span><span class="token punctuation">,</span>
            <span class="token string">'wake'</span> <span class="token punctuation">:</span> parse_timestamp<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'done'</span> <span class="token punctuation">:</span> UNIXTIME<span class="token punctuation">,</span>
            <span class="token string">'host'</span> <span class="token punctuation">:</span> parse_query_host<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'path'</span> <span class="token punctuation">:</span> parse_query_table<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">elif</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>LAST_SQL_UUID <span class="token keyword">in</span> DATAX_JOBDICT<span class="token punctuation">)</span> <span class="token keyword">and</span> REG_SQL_DONE<span class="token punctuation">.</span>search<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        DATAX_JOBDICT<span class="token punctuation">[</span>LAST_SQL_UUID<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'stat'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'D'</span>
        DATAX_JOBDICT<span class="token punctuation">[</span>LAST_SQL_UUID<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'done'</span><span class="token punctuation">]</span> <span class="token operator">=</span> parse_timestamp<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
<span class="token comment"># }}} #</span>

<span class="token comment"># {<!-- -->{<!-- -->{ function parse_write_task() #</span>
<span class="token keyword">def</span> <span class="token function">parse_write_task</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ser <span class="token operator">=</span> REG_COMMIT_UUID<span class="token punctuation">.</span>search<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> ser<span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    LAST_COMMIT_UUID <span class="token operator">=</span> ser<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> REG_COMMIT_WAKE<span class="token punctuation">.</span>search<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">:</span>
        DATAX_JOBDICT_COMMIT<span class="token punctuation">[</span>LAST_COMMIT_UUID<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'stat'</span> <span class="token punctuation">:</span> <span class="token string">'R'</span><span class="token punctuation">,</span>
            <span class="token string">'wake'</span> <span class="token punctuation">:</span> parse_timestamp<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'done'</span> <span class="token punctuation">:</span> UNIXTIME<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">elif</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>LAST_COMMIT_UUID <span class="token keyword">in</span> DATAX_JOBDICT_COMMIT<span class="token punctuation">)</span> <span class="token keyword">and</span> REG_COMMIT_DONE<span class="token punctuation">.</span>search<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        DATAX_JOBDICT_COMMIT<span class="token punctuation">[</span>LAST_COMMIT_UUID<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'stat'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'D'</span>
        DATAX_JOBDICT_COMMIT<span class="token punctuation">[</span>LAST_COMMIT_UUID<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'done'</span><span class="token punctuation">]</span> <span class="token operator">=</span> parse_timestamp<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
<span class="token comment"># }}} #</span>

<span class="token comment"># {<!-- -->{<!-- -->{ function result_analyse() #</span>
<span class="token keyword">def</span> <span class="token function">result_analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">compare</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> b<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span> <span class="token operator">-</span> a<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span>

    tasklist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    hostsmap <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    statvars <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'sum'</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'cnt'</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'svr'</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'max'</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'min'</span> <span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    tasklist_commit <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    statvars_commit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'sum'</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'cnt'</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>

    <span class="token keyword">for</span> idx <span class="token keyword">in</span> DATAX_JOBDICT<span class="token punctuation">:</span>
        item <span class="token operator">=</span> DATAX_JOBDICT<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        item<span class="token punctuation">[</span><span class="token string">'uuid'</span><span class="token punctuation">]</span> <span class="token operator">=</span> idx<span class="token punctuation">;</span>
        item<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">'done'</span><span class="token punctuation">]</span> <span class="token operator">-</span> item<span class="token punctuation">[</span><span class="token string">'wake'</span><span class="token punctuation">]</span>
        tasklist<span class="token punctuation">.</span>append<span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">not</span> <span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span> <span class="token keyword">in</span> hostsmap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            hostsmap<span class="token punctuation">[</span>item<span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
            statvars<span class="token punctuation">[</span><span class="token string">'svr'</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span> item<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">864000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            statvars<span class="token punctuation">[</span><span class="token string">'sum'</span><span class="token punctuation">]</span> <span class="token operator">+=</span> item<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span>
            statvars<span class="token punctuation">[</span><span class="token string">'cnt'</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
            statvars<span class="token punctuation">[</span><span class="token string">'max'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>statvars<span class="token punctuation">[</span><span class="token string">'max'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token string">'done'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            statvars<span class="token punctuation">[</span><span class="token string">'min'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>statvars<span class="token punctuation">[</span><span class="token string">'min'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token string">'wake'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> idx <span class="token keyword">in</span> DATAX_JOBDICT_COMMIT<span class="token punctuation">:</span>
        itemc <span class="token operator">=</span> DATAX_JOBDICT_COMMIT<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        itemc<span class="token punctuation">[</span><span class="token string">'uuid'</span><span class="token punctuation">]</span> <span class="token operator">=</span> idx
        itemc<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span> <span class="token operator">=</span> itemc<span class="token punctuation">[</span><span class="token string">'done'</span><span class="token punctuation">]</span> <span class="token operator">-</span> itemc<span class="token punctuation">[</span><span class="token string">'wake'</span><span class="token punctuation">]</span>
        tasklist_commit<span class="token punctuation">.</span>append<span class="token punctuation">(</span>itemc<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>itemc<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span> itemc<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">864000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            statvars_commit<span class="token punctuation">[</span><span class="token string">'sum'</span><span class="token punctuation">]</span> <span class="token operator">+=</span> itemc<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span>
            statvars_commit<span class="token punctuation">[</span><span class="token string">'cnt'</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>

    ttl <span class="token operator">=</span> <span class="token punctuation">(</span>statvars<span class="token punctuation">[</span><span class="token string">'max'</span><span class="token punctuation">]</span> <span class="token operator">-</span> statvars<span class="token punctuation">[</span><span class="token string">'min'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token number">1</span>
    idx <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>statvars<span class="token punctuation">[</span><span class="token string">'cnt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>statvars<span class="token punctuation">[</span><span class="token string">'sum'</span><span class="token punctuation">]</span> <span class="token keyword">or</span> ttl<span class="token punctuation">)</span>

    tasklist<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>compare<span class="token punctuation">)</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> tasklist<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s\t%s.%s\t%s\t%s\t% 4d\t% 2.1f%%\t% .2f'</span> <span class="token operator">%</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'stat'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                           time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%H:%M:%S'</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'wake'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                           <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'D'</span> <span class="token operator">==</span> item<span class="token punctuation">[</span><span class="token string">'stat'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">and</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%H:%M:%S'</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'done'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">'--'</span><span class="token punctuation">,</span>
                                                           item<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">100</span> <span class="token operator">*</span> item<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span> <span class="token operator">/</span> ttl<span class="token punctuation">,</span> idx <span class="token operator">*</span> item<span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">not</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tasklist<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">not</span> statvars<span class="token punctuation">[</span><span class="token string">'cnt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\n--- DataX Profiling Statistics ---'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%d task(s) on %d server(s), Total elapsed %d second(s), %.2f second(s) per task in average'</span> <span class="token operator">%</span><span class="token punctuation">(</span>statvars<span class="token punctuation">[</span><span class="token string">'cnt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                                                                         statvars<span class="token punctuation">[</span><span class="token string">'svr'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> statvars<span class="token punctuation">[</span><span class="token string">'sum'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>statvars<span class="token punctuation">[</span><span class="token string">'sum'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> statvars<span class="token punctuation">[</span><span class="token string">'cnt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Actually cost %d second(s) (%s - %s), task concurrency: %.2f, tilt index: %.2f'</span> <span class="token operator">%</span><span class="token punctuation">(</span>ttl<span class="token punctuation">,</span>
                                                                                             time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%H:%M:%S'</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>statvars<span class="token punctuation">[</span><span class="token string">'min'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                                             time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%H:%M:%S'</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>statvars<span class="token punctuation">[</span><span class="token string">'max'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                                             <span class="token builtin">float</span><span class="token punctuation">(</span>statvars<span class="token punctuation">[</span><span class="token string">'sum'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> ttl<span class="token punctuation">,</span> idx <span class="token operator">*</span> tasklist<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    idx_commit <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>statvars_commit<span class="token punctuation">[</span><span class="token string">'cnt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>statvars_commit<span class="token punctuation">[</span><span class="token string">'sum'</span><span class="token punctuation">]</span> <span class="token keyword">or</span> ttl<span class="token punctuation">)</span>
    tasklist_commit<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>compare<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%d task(s) done odps comit, Total elapsed %d second(s), %.2f second(s) per task in average, tilt index: %.2f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
        statvars_commit<span class="token punctuation">[</span><span class="token string">'cnt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        statvars_commit<span class="token punctuation">[</span><span class="token string">'sum'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>statvars_commit<span class="token punctuation">[</span><span class="token string">'sum'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> statvars_commit<span class="token punctuation">[</span><span class="token string">'cnt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        idx_commit <span class="token operator">*</span> tasklist_commit<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'cost'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># }}} #</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Usage: %s filename"</span> <span class="token operator">%</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    quit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    parse_task<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    result_analyse<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>perftrace.py</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding:utf-8 -*-</span>


<span class="token triple-quoted-string string">"""
   Life's short, Python more.
"""</span>

<span class="token keyword">import</span> re
<span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> json
<span class="token keyword">import</span> uuid
<span class="token keyword">import</span> signal
<span class="token keyword">import</span> time
<span class="token keyword">import</span> subprocess
<span class="token keyword">from</span> optparse <span class="token keyword">import</span> OptionParser
<span class="token builtin">reload</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>setdefaultencoding<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>

<span class="token comment">##begin cli &amp; help logic</span>
<span class="token keyword">def</span> <span class="token function">getOptionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    usage <span class="token operator">=</span> getUsage<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser <span class="token operator">=</span> OptionParser<span class="token punctuation">(</span>usage <span class="token operator">=</span> usage<span class="token punctuation">)</span>
    <span class="token comment">#rdbms reader and writer</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-r'</span><span class="token punctuation">,</span> <span class="token string">'--reader'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'reader'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'trace datasource read performance with specified !json! string'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-w'</span><span class="token punctuation">,</span> <span class="token string">'--writer'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'writer'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'trace datasource write performance with specified !json! string'</span><span class="token punctuation">)</span>

    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'--channel'</span><span class="token punctuation">,</span>  action<span class="token operator">=</span><span class="token string">'store'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'channel'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'the number of concurrent sync thread, the default is 1'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-f'</span><span class="token punctuation">,</span> <span class="token string">'--file'</span><span class="token punctuation">,</span>   action<span class="token operator">=</span><span class="token string">'store'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'existing datax configuration file, include reader and writer params'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-t'</span><span class="token punctuation">,</span> <span class="token string">'--type'</span><span class="token punctuation">,</span>   action<span class="token operator">=</span><span class="token string">'store'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'reader'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'trace which side\'s performance, cooperate with -f --file params, need to be reader or writer'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'--delete'</span><span class="token punctuation">,</span>   action<span class="token operator">=</span><span class="token string">'store'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'delete temporary files, the default value is true'</span><span class="token punctuation">)</span>
    <span class="token comment">#parser.add_option('-h', '--help',   action='store', default='true', help='print usage information')</span>
    <span class="token keyword">return</span> parser

<span class="token keyword">def</span> <span class="token function">getUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''
The following params are available for -r --reader:
    [these params is for rdbms reader, used to trace rdbms read performance, it's like datax's key]
    *datasourceType: datasource type, may be mysql|drds|oracle|ads|sqlserver|postgresql|db2 etc...
    *jdbcUrl:        datasource jdbc connection string, mysql as a example: jdbc:mysql://ip:port/database
    *username:       username for datasource
    *password:       password for datasource
    *table:          table name for read data
    column:          column to be read, the default value is ['*']
    splitPk:         the splitPk column of rdbms table
    where:           limit the scope of the performance data set
    fetchSize:       how many rows to be fetched at each communicate
    [these params is for stream reader, used to trace rdbms write performance]
    reader-sliceRecordCount:  how man test data to mock(each channel), the default value is 10000
    reader-column          :  stream reader while generate test data(type supports: string|long|date|double|bool|bytes; support constant value and random function)，demo: [{"type":"string","value":"abc"},{"type":"string","random":"10,20"}]
The following params are available for -w --writer:
    [these params is for rdbms writer, used to trace rdbms write performance, it's like datax's key]
    datasourceType:  datasource type, may be mysql|drds|oracle|ads|sqlserver|postgresql|db2|ads etc...
    *jdbcUrl:        datasource jdbc connection string, mysql as a example: jdbc:mysql://ip:port/database
    *username:       username for datasource
    *password:       password for datasource
    *table:          table name for write data
    column:          column to be writed, the default value is ['*']
    batchSize:       how many rows to be storeed at each communicate, the default value is 512
    preSql:          prepare sql to be executed before write data, the default value is ''
    postSql:         post sql to be executed end of write data, the default value is ''
    url:             required for ads, pattern is ip:port
    schme:           required for ads, ads database name
    [these params is for stream writer, used to trace rdbms read performance]
    writer-print:           true means print data read from source datasource, the default value is false
The following params are available global control:
    -c --channel:    the number of concurrent tasks, the default value is 1
    -f --file:       existing completely dataX configuration file path
    -t --type:       test read or write performance for a datasource, couble be reader or writer, in collaboration with -f --file
    -h --help:       print help message
some demo:
perftrace.py --channel=10 --reader='{"jdbcUrl":"jdbc:mysql://127.0.0.1:3306/database", "username":"", "password":"", "table": "", "where":"", "splitPk":"", "writer-print":"false"}'
perftrace.py --channel=10 --writer='{"jdbcUrl":"jdbc:mysql://127.0.0.1:3306/database", "username":"", "password":"", "table": "", "reader-sliceRecordCount": "10000", "reader-column": [{"type":"string","value":"abc"},{"type":"string","random":"10,20"}]}'
perftrace.py --file=/tmp/datax.job.json --type=reader --reader='{"writer-print": "false"}'
perftrace.py --file=/tmp/datax.job.json --type=writer --writer='{"reader-sliceRecordCount": "10000", "reader-column": [{"type":"string","value":"abc"},{"type":"string","random":"10,20"}]}'
some example jdbc url pattern, may help:
jdbc:oracle:thin:@ip:port:database
jdbc:mysql://ip:port/database
jdbc:sqlserver://ip:port;DatabaseName=database
jdbc:postgresql://ip:port/database
warn: ads url pattern is ip:port
warn: test write performance will write data into your table, you can use a temporary table just for test.
'''</span>

<span class="token keyword">def</span> <span class="token function">printCopyright</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    DATAX_VERSION <span class="token operator">=</span> <span class="token string">'UNKNOWN_DATAX_VERSION'</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
DataX Util Tools (%s), From Alibaba !
Copyright (C) 2010-2016, Alibaba Group. All Rights Reserved.'''</span> <span class="token operator">%</span> DATAX_VERSION<span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">yesNoChoice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    yes <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'yes'</span><span class="token punctuation">,</span><span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'ye'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    no <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'no'</span><span class="token punctuation">,</span><span class="token string">'n'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    choice <span class="token operator">=</span> <span class="token builtin">raw_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> choice <span class="token keyword">in</span> yes<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">elif</span> choice <span class="token keyword">in</span> no<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"Please respond with 'yes' or 'no'"</span><span class="token punctuation">)</span>
<span class="token comment">##end cli &amp; help logic</span>


<span class="token comment">##begin process logic</span>
<span class="token keyword">def</span> <span class="token function">suicide</span><span class="token punctuation">(</span>signum<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> childProcess
    <span class="token keyword">print</span> <span class="token operator">&gt;&gt;</span> sys<span class="token punctuation">.</span>stderr<span class="token punctuation">,</span> <span class="token string">"[Error] Receive unexpected signal %d, starts to suicide."</span> <span class="token operator">%</span> <span class="token punctuation">(</span>signum<span class="token punctuation">)</span>
    <span class="token keyword">if</span> childProcess<span class="token punctuation">:</span>
        childProcess<span class="token punctuation">.</span>send_signal<span class="token punctuation">(</span>signal<span class="token punctuation">.</span>SIGQUIT<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        childProcess<span class="token punctuation">.</span>kill<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token operator">&gt;&gt;</span> sys<span class="token punctuation">.</span>stderr<span class="token punctuation">,</span> <span class="token string">"DataX Process was killed ! you did ?"</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">registerSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> childProcess
    signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> suicide<span class="token punctuation">)</span>
    signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> suicide<span class="token punctuation">)</span>
    signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> suicide<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">fork</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> isShell<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> childProcess
    childProcess <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>command<span class="token punctuation">,</span> shell <span class="token operator">=</span> isShell<span class="token punctuation">)</span>
    registerSignal<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>stdout<span class="token punctuation">,</span> stderr<span class="token punctuation">)</span> <span class="token operator">=</span> childProcess<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#阻塞直到子进程结束</span>
    childProcess<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> childProcess<span class="token punctuation">.</span>returncode
<span class="token comment">##end process logic</span>


<span class="token comment">##begin datax json generate logic</span>
<span class="token comment">#warn: if not '': -&gt; true;   if not None: -&gt; true</span>
<span class="token keyword">def</span> <span class="token function">notNone</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> obj<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"Configuration property [%s] could not be blank!"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">attributeNotNone</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> key <span class="token keyword">in</span> attributes<span class="token punctuation">:</span>
        notNone<span class="token punctuation">(</span>obj<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">isBlank</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> value <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token keyword">def</span> <span class="token function">parsePluginName</span><span class="token punctuation">(</span>jdbcUrl<span class="token punctuation">,</span> pluginType<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> re
    <span class="token comment">#warn: drds</span>
    name <span class="token operator">=</span> <span class="token string">'pluginName'</span>
    mysqlRegex <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">'jdbc:(mysql)://.*'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mysqlRegex<span class="token punctuation">.</span>match<span class="token punctuation">(</span>jdbcUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> <span class="token string">'mysql'</span>
    postgresqlRegex <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">'jdbc:(postgresql)://.*'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>postgresqlRegex<span class="token punctuation">.</span>match<span class="token punctuation">(</span>jdbcUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> <span class="token string">'postgresql'</span>
    oracleRegex <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">'jdbc:(oracle):.*'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oracleRegex<span class="token punctuation">.</span>match<span class="token punctuation">(</span>jdbcUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> <span class="token string">'oracle'</span>
    sqlserverRegex <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">'jdbc:(sqlserver)://.*'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlserverRegex<span class="token punctuation">.</span>match<span class="token punctuation">(</span>jdbcUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> <span class="token string">'sqlserver'</span>
    db2Regex <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">'jdbc:(db2)://.*'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>db2Regex<span class="token punctuation">.</span>match<span class="token punctuation">(</span>jdbcUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> <span class="token string">'db2'</span>
    <span class="token keyword">return</span> <span class="token string">"%s%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> pluginType<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">renderDataXJson</span><span class="token punctuation">(</span>paramsDict<span class="token punctuation">,</span> readerOrWriter <span class="token operator">=</span> <span class="token string">'reader'</span><span class="token punctuation">,</span> channel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dataxTemplate <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"job"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"setting"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"speed"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"channel"</span><span class="token punctuation">:</span> <span class="token number">1</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"reader"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
                        <span class="token string">"parameter"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
                            <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
                            <span class="token string">"sliceRecordCount"</span><span class="token punctuation">:</span> <span class="token string">"10000"</span><span class="token punctuation">,</span>
                            <span class="token string">"column"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                                <span class="token string">"*"</span>
                            <span class="token punctuation">]</span><span class="token punctuation">,</span>
                            <span class="token string">"connection"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                                <span class="token punctuation">{<!-- --></span>
                                    <span class="token string">"table"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                    <span class="token string">"jdbcUrl"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">]</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"writer"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
                        <span class="token string">"parameter"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token string">"print"</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
                            <span class="token string">"connection"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                                <span class="token punctuation">{<!-- --></span>
                                    <span class="token string">"table"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                    <span class="token string">"jdbcUrl"</span><span class="token punctuation">:</span> <span class="token string">''</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">]</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    dataxTemplate<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'setting'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'speed'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'channel'</span><span class="token punctuation">]</span> <span class="token operator">=</span> channel
    dataxTemplateContent <span class="token operator">=</span> dataxTemplate<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    pluginName <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">if</span> paramsDict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'datasourceType'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pluginName <span class="token operator">=</span> <span class="token string">'%s%s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>paramsDict<span class="token punctuation">[</span><span class="token string">'datasourceType'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> readerOrWriter<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> paramsDict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'jdbcUrl'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pluginName <span class="token operator">=</span> parsePluginName<span class="token punctuation">(</span>paramsDict<span class="token punctuation">[</span><span class="token string">'jdbcUrl'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> readerOrWriter<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> paramsDict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pluginName <span class="token operator">=</span> <span class="token string">'adswriter'</span>

    theOtherSide <span class="token operator">=</span> <span class="token string">'writer'</span> <span class="token keyword">if</span> readerOrWriter <span class="token operator">==</span> <span class="token string">'reader'</span> <span class="token keyword">else</span> <span class="token string">'reader'</span>
    dataxPluginParamsContent <span class="token operator">=</span> dataxTemplateContent<span class="token punctuation">.</span>get<span class="token punctuation">(</span>readerOrWriter<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'parameter'</span><span class="token punctuation">)</span>
    dataxPluginParamsContent<span class="token punctuation">.</span>update<span class="token punctuation">(</span>paramsDict<span class="token punctuation">)</span>

    dataxPluginParamsContentOtherSide <span class="token operator">=</span> dataxTemplateContent<span class="token punctuation">.</span>get<span class="token punctuation">(</span>theOtherSide<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'parameter'</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> readerOrWriter <span class="token operator">==</span> <span class="token string">'reader'</span><span class="token punctuation">:</span>
        dataxTemplateContent<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'reader'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pluginName
        dataxTemplateContent<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'writer'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'streamwriter'</span>
        <span class="token keyword">if</span> paramsDict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'writer-print'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            dataxPluginParamsContentOtherSide<span class="token punctuation">[</span><span class="token string">'print'</span><span class="token punctuation">]</span> <span class="token operator">=</span> paramsDict<span class="token punctuation">[</span><span class="token string">'writer-print'</span><span class="token punctuation">]</span>
            <span class="token keyword">del</span> dataxPluginParamsContent<span class="token punctuation">[</span><span class="token string">'writer-print'</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> dataxPluginParamsContentOtherSide<span class="token punctuation">[</span><span class="token string">'connection'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> readerOrWriter <span class="token operator">==</span> <span class="token string">'writer'</span><span class="token punctuation">:</span>
        dataxTemplateContent<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'reader'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'streamreader'</span>
        dataxTemplateContent<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'writer'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pluginName
        <span class="token keyword">if</span> paramsDict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'reader-column'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            dataxPluginParamsContentOtherSide<span class="token punctuation">[</span><span class="token string">'column'</span><span class="token punctuation">]</span> <span class="token operator">=</span> paramsDict<span class="token punctuation">[</span><span class="token string">'reader-column'</span><span class="token punctuation">]</span>
            <span class="token keyword">del</span> dataxPluginParamsContent<span class="token punctuation">[</span><span class="token string">'reader-column'</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> paramsDict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'reader-sliceRecordCount'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            dataxPluginParamsContentOtherSide<span class="token punctuation">[</span><span class="token string">'sliceRecordCount'</span><span class="token punctuation">]</span> <span class="token operator">=</span> paramsDict<span class="token punctuation">[</span><span class="token string">'reader-sliceRecordCount'</span><span class="token punctuation">]</span>
            <span class="token keyword">del</span> dataxPluginParamsContent<span class="token punctuation">[</span><span class="token string">'reader-sliceRecordCount'</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> dataxPluginParamsContentOtherSide<span class="token punctuation">[</span><span class="token string">'connection'</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> paramsDict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'jdbcUrl'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> readerOrWriter <span class="token operator">==</span> <span class="token string">'reader'</span><span class="token punctuation">:</span>
            dataxPluginParamsContent<span class="token punctuation">[</span><span class="token string">'connection'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'jdbcUrl'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>paramsDict<span class="token punctuation">[</span><span class="token string">'jdbcUrl'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            dataxPluginParamsContent<span class="token punctuation">[</span><span class="token string">'connection'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'jdbcUrl'</span><span class="token punctuation">]</span> <span class="token operator">=</span> paramsDict<span class="token punctuation">[</span><span class="token string">'jdbcUrl'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> paramsDict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'table'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        dataxPluginParamsContent<span class="token punctuation">[</span><span class="token string">'connection'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'table'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>paramsDict<span class="token punctuation">[</span><span class="token string">'table'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


    traceJobJson <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>dataxTemplate<span class="token punctuation">,</span> indent <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> traceJobJson

<span class="token keyword">def</span> <span class="token function">isUrl</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> path<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Configuration file path required for the string, you configure is:%s'</span> <span class="token operator">%</span> path<span class="token punctuation">)</span>
    m <span class="token operator">=</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r"^http[s]?://\S+\w*"</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> m<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>


<span class="token keyword">def</span> <span class="token function">readJobJsonFromLocal</span><span class="token punctuation">(</span>jobConfigPath<span class="token punctuation">)</span><span class="token punctuation">:</span>
    jobConfigContent <span class="token operator">=</span> <span class="token boolean">None</span>
    jobConfigPath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>jobConfigPath<span class="token punctuation">)</span>
    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>jobConfigPath<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        jobConfigContent <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token builtin">file</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> jobConfigContent<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"Your job configuration file read the result is empty, please check the configuration is legal, path: [%s]\nconfiguration:\n%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>jobConfigPath<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>jobConfigContent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> jobConfigContent


<span class="token keyword">def</span> <span class="token function">readJobJsonFromRemote</span><span class="token punctuation">(</span>jobConfigPath<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> urllib
    conn <span class="token operator">=</span> urllib<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span>jobConfigPath<span class="token punctuation">)</span>
    jobJson <span class="token operator">=</span> conn<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> jobJson

<span class="token keyword">def</span> <span class="token function">parseJson</span><span class="token punctuation">(</span>strConfig<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>strConfig<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">import</span> traceback
        traceback<span class="token punctuation">.</span>print_exc<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token operator">&gt;&gt;</span> sys<span class="token punctuation">.</span>stderr<span class="token punctuation">,</span> <span class="token string">'%s %s need in line with json syntax'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> strConfig<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">convert</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    traceJobJson <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">if</span> options<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> isUrl<span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            traceJobJson <span class="token operator">=</span> readJobJsonFromRemote<span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            traceJobJson <span class="token operator">=</span> readJobJsonFromLocal<span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">)</span>
        traceJobDict <span class="token operator">=</span> parseJson<span class="token punctuation">(</span>traceJobJson<span class="token punctuation">,</span> <span class="token string">'%s content'</span> <span class="token operator">%</span> options<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">)</span>
        attributeNotNone<span class="token punctuation">(</span>traceJobDict<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        attributeNotNone<span class="token punctuation">(</span>traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        attributeNotNone<span class="token punctuation">(</span>traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'reader'</span><span class="token punctuation">,</span> <span class="token string">'writer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        attributeNotNone<span class="token punctuation">(</span>traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'reader'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        attributeNotNone<span class="token punctuation">(</span>traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'writer'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> options<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">'reader'</span><span class="token punctuation">:</span>
            traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'writer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'streamwriter'</span>
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>reader<span class="token punctuation">:</span>
                traceReaderDict <span class="token operator">=</span> parseJson<span class="token punctuation">(</span>options<span class="token punctuation">.</span>reader<span class="token punctuation">,</span> <span class="token string">'reader config'</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> traceReaderDict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'writer-print'</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'writer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'print'</span><span class="token punctuation">]</span> <span class="token operator">=</span> traceReaderDict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'writer-print'</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'writer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'print'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'false'</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'writer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'print'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'false'</span>
        <span class="token keyword">elif</span> options<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">'writer'</span><span class="token punctuation">:</span>
            traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'reader'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'streamreader'</span>
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>writer<span class="token punctuation">:</span>
                traceWriterDict <span class="token operator">=</span> parseJson<span class="token punctuation">(</span>options<span class="token punctuation">.</span>writer<span class="token punctuation">,</span> <span class="token string">'writer config'</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> traceWriterDict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'reader-column'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'reader'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'column'</span><span class="token punctuation">]</span> <span class="token operator">=</span> traceWriterDict<span class="token punctuation">[</span><span class="token string">'reader-column'</span><span class="token punctuation">]</span>
                <span class="token keyword">if</span> traceWriterDict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'reader-sliceRecordCount'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'reader'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'sliceRecordCount'</span><span class="token punctuation">]</span> <span class="token operator">=</span> traceWriterDict<span class="token punctuation">[</span><span class="token string">'reader-sliceRecordCount'</span><span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                columnSize <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'writer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'column'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                streamReaderColumn <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>columnSize<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    streamReaderColumn<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"long"</span><span class="token punctuation">,</span> <span class="token string">"random"</span><span class="token punctuation">:</span> <span class="token string">"2,10"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'reader'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'column'</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamReaderColumn
                traceJobDict<span class="token punctuation">[</span><span class="token string">'job'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'reader'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'sliceRecordCount'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10000</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">pass</span><span class="token comment">#do nothing</span>
        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>traceJobDict<span class="token punctuation">,</span> indent <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> options<span class="token punctuation">.</span>reader<span class="token punctuation">:</span>
        traceReaderDict <span class="token operator">=</span> parseJson<span class="token punctuation">(</span>options<span class="token punctuation">.</span>reader<span class="token punctuation">,</span> <span class="token string">'reader config'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> renderDataXJson<span class="token punctuation">(</span>traceReaderDict<span class="token punctuation">,</span> <span class="token string">'reader'</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>channel<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> options<span class="token punctuation">.</span>writer<span class="token punctuation">:</span>
        traceWriterDict <span class="token operator">=</span> parseJson<span class="token punctuation">(</span>options<span class="token punctuation">.</span>writer<span class="token punctuation">,</span> <span class="token string">'writer config'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> renderDataXJson<span class="token punctuation">(</span>traceWriterDict<span class="token punctuation">,</span> <span class="token string">'writer'</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>channel<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>getUsage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">#dataxParams = {}</span>
    <span class="token comment">#for opt, value in options.__dict__.items():</span>
    <span class="token comment">#    dataxParams[opt] = value</span>
<span class="token comment">##end datax json generate logic</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    printCopyright<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser <span class="token operator">=</span> getOptionParser<span class="token punctuation">(</span><span class="token punctuation">)</span>

    options<span class="token punctuation">,</span> args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">#print options, args</span>
    dataxTraceJobJson <span class="token operator">=</span> convert<span class="token punctuation">(</span>options<span class="token punctuation">,</span> args<span class="token punctuation">)</span>

    <span class="token comment">#由MAC地址、当前时间戳、随机数生成,可以保证全球范围内的唯一性</span>
    dataxJobPath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"perftrace-"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    jobConfigOk <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>dataxJobPath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"file already exists, truncate and rewrite it? %s"</span> <span class="token operator">%</span> dataxJobPath<span class="token punctuation">)</span>
        <span class="token keyword">if</span> yesNoChoice<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            jobConfigOk <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"exit failed, because of file conflict"</span><span class="token punctuation">)</span>
            sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    fileWriter <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>dataxJobPath<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
    fileWriter<span class="token punctuation">.</span>write<span class="token punctuation">(</span>dataxTraceJobJson<span class="token punctuation">)</span>
    fileWriter<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"trace environments:"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"dataxJobPath:  %s"</span> <span class="token operator">%</span> dataxJobPath<span class="token punctuation">)</span>
    dataxHomePath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"dataxHomePath: %s"</span> <span class="token operator">%</span> dataxHomePath<span class="token punctuation">)</span>

    dataxCommand <span class="token operator">=</span> <span class="token string">"%s %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dataxHomePath<span class="token punctuation">,</span> <span class="token string">"bin"</span><span class="token punctuation">,</span> <span class="token string">"datax.py"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dataxJobPath<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"dataxCommand:  %s"</span> <span class="token operator">%</span> dataxCommand<span class="token punctuation">)</span>

    returncode <span class="token operator">=</span> fork<span class="token punctuation">(</span>dataxCommand<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> options<span class="token punctuation">.</span>delete <span class="token operator">==</span> <span class="token string">'true'</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>dataxJobPath<span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>returncode<span class="token punctuation">)</span>
</code></pre> 
<p>总结：记录一下踩到的坑，希望可以帮到你</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/890e9f910a6b6ebb0304d5b0981faff8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Debian10二进制安装MySQL5.7</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c408162fb0ec5bd2655fedea042a6017/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python 1行代码解决算法 回文数 问题（多一行都不行）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>