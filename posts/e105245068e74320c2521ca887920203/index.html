<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Building the kernel with clang - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Building the kernel with clang" />
<meta property="og:description" content="https://lwn.net/Articles/734071/
https://oschina.net/news/89194/linux-build-kernel-with-clang
Building the kernel with clang By Jake Edge September 19, 2017 Linux Plumbers Conference Over the years, there has been a persistent effort to build the Linuxkernel using the Clang C compiler that is part of the LLVM project. Welast looked in on the effort in areport fromthe LLVM microconference at the 2015 Linux Plumbers Conference (LPC), but wehave followed itbefore that aswell. At this year&#39;s LPC, two Google kernel engineers, Greg Hackmann andNick Desaulniers, came to theAndroidmicroconference to update the status; at this point, it is possible tobuild two long-term support kernels (4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/e105245068e74320c2521ca887920203/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-12-21T21:25:19+08:00" />
<meta property="article:modified_time" content="2017-12-21T21:25:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Building the kernel with clang</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><a target="_blank" href="https://lwn.net/Articles/734071/" rel="nofollow noopener noreferrer">https://lwn.net/Articles/734071/</a></p> 
<p><a target="_blank" href="https://oschina.net/news/89194/linux-build-kernel-with-clang" rel="nofollow noopener noreferrer">https://oschina.net/news/89194/linux-build-kernel-with-clang</a><br> </p> 
<p><br> </p> 
<p></p> 
<div class="PageHeadline"> 
 <h2>Building the kernel with clang</h2> 
</div> 
<div class="FeatureByline">
  By 
 <strong>Jake Edge</strong> 
 <br> September 19, 2017 
 <hr> 
 <a target="_blank" href="https://lwn.net/Archives/ConferenceByYear/#2017-Linux_Plumbers_Conference" rel="nofollow noopener noreferrer">Linux Plumbers Conference</a> 
</div> 
<p></p> 
<p>Over the years, there has been a persistent effort to build the Linuxkernel using the Clang C compiler that is part of the LLVM project. Welast looked in on the effort in a<a target="_blank" href="https://lwn.net/Articles/655544/" rel="nofollow noopener noreferrer">report fromthe LLVM microconference</a> at the 2015 Linux Plumbers Conference (LPC), but wehave followed it<a target="_blank" href="https://lwn.net/Articles/549203/" rel="nofollow noopener noreferrer">before that</a> aswell. At this year's LPC, two Google kernel engineers, Greg Hackmann andNick Desaulniers, came to the<a target="_blank" href="https://www.linuxplumbersconf.org/2017/ocw/events/LPC2017/tracks/643" rel="nofollow noopener noreferrer">Androidmicroconference</a> to update the status; at this point, it is possible tobuild two long-term support kernels (4.4 and 4.9) with Clang.</p> 
<a target="_blank" href="https://lwn.net/Articles/734118/" rel="nofollow noopener noreferrer"><img src="https://images2.imgbox.com/da/f0/kK4R2GOg_o.jpg" alt="[Nick Desaulniers]" title="Nick Desaulniers" align="right" width="214" border="0" height="280"></a> 
<p>Desaulniers began the presentation by answering the most commonly askedquestion: why build the kernel with Clang? To start with, the Android userspace is all built with Clang these days, so Google would like to reducethe number of toolchains it needs to support. He acknowledged that it isreally only a benefit to Google and is "not super useful" elsewhere. Butthere are other reasons that are beneficial to the wider community.</p> 
<p>There are some common bugs that often pop up in kernel code, especiallyout-of-tree code like the third-party drivers that end up in Androiddevices. The developers are interested in using the static analysisavailable in Clang to spotthose bugs, but the kernel needs to be built using Clang to do so. Thereare also a number of dynamic-analysis tools that can be used like thevarious<a target="_blank" href="https://github.com/google/sanitizers" rel="noopener noreferrer">sanitizers</a>(e.g.<a target="_blank" href="https://github.com/google/sanitizers/wiki/AddressSanitizer" rel="noopener noreferrer">AddressSanitizer</a>or ASan) and their kernel equivalents (e.g. <a target="_blank" href="https://github.com/google/kasan/wiki" rel="noopener noreferrer"> KernelAddressSanitizer</a> orKASAN). </p> 
<p>Clang provides a different set of warnings than GCC does; looking at thosewill result in higher quality code. It is clearly beneficial to all kernelusers to have fewer bugs in it. There are some additional tools that areplanned using Clang. One is a control-flow-analysis tool that couldenumerate valid stack frames at compile time; those could be checked atrun time to eliminate<a target="_blank" href="https://en.wikipedia.org/wiki/Return-oriented_programming" rel="nofollow noopener noreferrer">return-orientedprogramming</a> (ROP) attacks. There is also work going on for link-timeoptimization (LTO) and profile-guided optimization (PGO) for Clang, which couldprovide better execution speed, especially for hot paths.</p> 
<p>Building code with another compiler is a good way to shake out code thatrelies on undefined behaviors. Since the language specification does notdefine certain behaviors, compiler developers can choose whatever isconvenient. That choice could change, so even a GCC upgrade might causemisbehavior if some kernel code is relying on undefined behavior. Thehope, Desaulniers said, is that both the kernel and LLVM/Clang can improvetheir code bases from this effort. The kernel is a big project with a lotof code that can find bugs in the compiler; in fact, it already has.</p> 
<p>Greg Kroah-Hartman said that "competition is good"; he was strongly infavor of the effort. Desaulniers was glad to hear that as he and otherswere worried that the tight coupling with GCC was being protected by thekernel developers. Kroah-Hartman said that there have been other compilersbuilding the kernel along the way. Behan Webster also pointed to all ofthe new features that have come about in GCC over the past five years as aresult of the competition with LLVM. Kroah-Hartman said that he wishedthere was a competitor to the Linux kernel.</p> 
<a target="_blank" href="https://lwn.net/Articles/734118/" rel="nofollow noopener noreferrer"><img src="https://images2.imgbox.com/84/3a/Vw23gSDj_o.jpg" alt="[Greg Hackmann]" title="Greg Hackmann" align="left" width="206" border="0" height="280"></a> 
<p>Hackmann related the state of the upstream kernel: "we are very close tohaving a kernel that can be built with Clang". It does require using a recent Clangthat has some fixes, but the x86_64 and ARM64 kernels can be built,though each architecture has one out-of-tree patch that needs to be appliedto do so. There is also one Android-specific Kbuild change that is needed,but only if the Android open-source project (AOSP) pre-built toolchain isbeing used.</p> 
<p>As <a target="_blank" href="https://lkml.org/lkml/2017/8/22/912" rel="nofollow noopener noreferrer"> announced</a> on thekernel mailing list, there are patches available for the 4.4 and 4.9kernels. There are also experimental branches of the Android kernelsfor 4.4 and 4.9 available from AOSP. More details can be found in the <a target="_blank" href="https://www.linuxplumbersconf.org/2017/ocw//system/presentations/4799/original/LPC%202017-%20Clang%20built%20kernels.pdf" rel="nofollow noopener noreferrer"> slides[PDF]</a>. Those branches had just been pushed a few days earlier,Hackmann said, and the<a target="_blank" href="https://www.96boards.org/product/hikey/" rel="nofollow noopener noreferrer">HiKey</a> boards were ableto build and boot that code shortly thereafter.</p> 
<p>There have been LLVM bugs found in the process, though most of them havebeen fixed at this point, Desaulniers said. The initial work was done with LLVM 4.0, butthey have since updated to 5.0 and are also building with the current LLVMdevelopment tree (which will become 6.0). You can probably build thekernel with 4.0, he said, but it will be much slower than building with 5.0or later.</p> 
<p>There are still some outstanding issues. Variable-length arrays asnon-terminal fields in structures are not supported by Clang, there is aGNU C extension for inline functions that is not supported, and the LLVMassembler cannot be used to build the kernel. Hackmann noted that the GNU assembler istoo liberal in what it accepts.</p> 
<p>This work has shown that the FUD surrounding using a new toolchain for thekernel is unfounded, Desaulniers said. It is working now, but there are afew asterisks. Clang, the front end, can compile the kernel, butthe assembler and the linker from GNU Binutils are needed to complete thebuild process.</p> 
<p>Next up is figuring out how to do automated testing of LLVM and thekernel. Currently, the team is working with two specific LTS kernelbranches and using specific LLVM versions. So he can't quite say thatClang will build any kernel, since there are so many differentconfiguration options. A bot to check whether kernel patches will fail tobuild under Clang is in the works as well. An audience member noted that<a target="_blank" href="https://kernelci.org/" rel="nofollow noopener noreferrer">kernelci.org</a> is looking at adding othercompilers to its build-and-boot testing.</p> 
<p>Hackmann and Desaulniers encouraged others to try building using Clang.All it takes is a simple "<tt>make CC=clang</tt>" on a properlyequipped system. We are, it seems, quite close to having a two-compilerworld for the Linux kernel.</p> 
<p>[I would like to thank LWN's travel sponsor, The Linux Foundation, forassistance in traveling to Los Angeles for LPC.]</p> 
<br> 
<p><br> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6170e6c6950ac68122298ee1144623c3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【TensorFlow随笔】关于一个矩阵与多个矩阵相乘的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/94d3522fd7658bca365c03148332eef9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">osmdroid 在线加载谷歌瓦片（谷歌地图瓦片地址解释）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>