<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>量化投资之工具篇一：Backtrader从入门到精通（3）-Cerebro源代码解读 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="量化投资之工具篇一：Backtrader从入门到精通（3）-Cerebro源代码解读" />
<meta property="og:description" content="前面两篇文章已经一步一步展示了如何使用backtrader以及使用backtrader的一些重要概念和注意事项。但是你要真正灵活地使用backtrader实现自己的策略，还需要了解backtrader各个组成部分。本文开始，对backtrader的类进行详细的说明。为了让大家更能深入了解backtrader的运行机制，咱们基于源代码进行解读。
代码架构中，会用到元类，我们先了解元类在backtrader中的应用。
元类 在backtrader的类定义中，经常出现如下定义：
class Cerebro(with_metaclass(MetaParams, object)): class MetaLineRoot(metabase.MetaParams): class WriterBase(with_metaclass(bt.MetaParams, object)) 里面经常出现的metaclass，就是元类的意思。
在backtrader中，基本上所有类从元类继承。我们从顶往下看，先看metabase类。
class MetaBase(type): def doprenew(cls, *args, **kwargs): return cls, args, kwargs def donew(cls, *args, **kwargs): _obj = cls.__new__(cls, *args, **kwargs)s return _obj, args, kwargs def dopreinit(cls, _obj, *args, **kwargs): return _obj, args, kwargs def doinit(cls, _obj, *args, **kwargs): _obj.__init__(*args, **kwargs) return _obj, args, kwargs def dopostinit(cls, _obj, *args, **kwargs): return _obj, args, kwargs def __call__(cls, *args, **kwargs): cls, args, kwargs = cls." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/7e0f0148282b5497be1e87ac9a8e14cc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-26T20:45:12+08:00" />
<meta property="article:modified_time" content="2021-11-26T20:45:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">量化投资之工具篇一：Backtrader从入门到精通（3）-Cerebro源代码解读</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>前面两篇文章已经一步一步展示了如何使用backtrader以及使用backtrader的一些重要概念和注意事项。但是你要真正灵活地使用backtrader实现自己的策略，还需要了解backtrader各个组成部分。本文开始，对backtrader的类进行详细的说明。为了让大家更能深入了解backtrader的运行机制，咱们基于源代码进行解读。</p> 
<p>代码架构中，会用到元类，我们先了解元类在backtrader中的应用。</p> 
<h2><a id="_5"></a>元类</h2> 
<p>在backtrader的类定义中，经常出现如下定义：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Cerebro</span><span class="token punctuation">(</span>with_metaclass<span class="token punctuation">(</span>MetaParams<span class="token punctuation">,</span> <span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
<span class="token keyword">class</span> <span class="token class-name">MetaLineRoot</span><span class="token punctuation">(</span>metabase<span class="token punctuation">.</span>MetaParams<span class="token punctuation">)</span><span class="token punctuation">:</span>

<span class="token keyword">class</span> <span class="token class-name">WriterBase</span><span class="token punctuation">(</span>with_metaclass<span class="token punctuation">(</span>bt<span class="token punctuation">.</span>MetaParams<span class="token punctuation">,</span> <span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>里面经常出现的metaclass，就是元类的意思。</p> 
<p>在backtrader中，基本上所有类从元类继承。我们从顶往下看，先看metabase类。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MetaBase</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">doprenew</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs

    <span class="token keyword">def</span> <span class="token function">donew</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        _obj <span class="token operator">=</span> cls<span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>s
        <span class="token keyword">return</span> _obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs

    <span class="token keyword">def</span> <span class="token function">dopreinit</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> _obj<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> _obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs

    <span class="token keyword">def</span> <span class="token function">doinit</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> _obj<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        _obj<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> _obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs

    <span class="token keyword">def</span> <span class="token function">dopostinit</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> _obj<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> _obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cls<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs <span class="token operator">=</span> cls<span class="token punctuation">.</span>doprenew<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        _obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs <span class="token operator">=</span> cls<span class="token punctuation">.</span>donew<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        _obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs <span class="token operator">=</span> cls<span class="token punctuation">.</span>dopreinit<span class="token punctuation">(</span>_obj<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        _obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs <span class="token operator">=</span> cls<span class="token punctuation">.</span>doinit<span class="token punctuation">(</span>_obj<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        _obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs <span class="token operator">=</span> cls<span class="token punctuation">.</span>dopostinit<span class="token punctuation">(</span>_obj<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> _obj
</code></pre> 
<p>这个元类类继承type，前面实例中还有object。这些是啥区别？这个就得从python的特性说起。在python中，<strong>一切皆为对象</strong>。甚至数据类型，以及数值都是对象。不信看看：</p> 
<blockquote> 
 <p>print(type(2))</p> 
 <p>&lt;class ‘int’&gt;</p> 
 <p>print(isinstance(2, object))</p> 
 <p>True</p> 
 <p>print(isinstance(2, int))</p> 
 <p>True</p> 
</blockquote> 
<p>数值2是int类的实例，也是int超类object的实例。记住：<strong>所有类的最顶层基类是object</strong>。</p> 
<blockquote> 
 <p>print(isinstance(object, type))<br> True</p> 
 <p>print(isinstance(int, type))<br> True</p> 
</blockquote> 
<p>这个看出来啥呢？object类是type的实例，所有的类都继承自object，也就是所有类都是type生成的。<strong>type就是Python在背后用来创建所有类的元类</strong>。是总结一句话：<strong>实例由类生成，类由type生成。</strong></p> 
<p>那元类又是啥？元类就是用来创建这些类（对象）的，元类就是类的类。</p> 
<p>这些关系如下代码即可明了：</p> 
<pre><code class="prism language-python">name <span class="token operator">=</span> <span class="token string">'bob'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"name.__class__ is %s"</span><span class="token operator">%</span>name<span class="token punctuation">.</span>__class__<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"name.__class__.__class__ is %s"</span><span class="token operator">%</span>name<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__class__<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">pass</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Bar.__class__ is %s"</span><span class="token operator">%</span>Bar<span class="token punctuation">.</span>__class__<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Bar.__class__.__class__ is %s"</span><span class="token operator">%</span>Bar<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__class__<span class="token punctuation">)</span>

mybar<span class="token operator">=</span>Bar<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"mybar.__class__ is %s"</span><span class="token operator">%</span>mybar<span class="token punctuation">.</span>__class__<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"mybar.__class__.__class__ is %s"</span><span class="token operator">%</span>mybar<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__class__<span class="token punctuation">)</span>
</code></pre> 
<p>结果如下：</p> 
<blockquote> 
 <p>name.__class__ is &lt;class ‘str’&gt;<br> name.__class__ .__class__is &lt;class ‘type’&gt;<br> Bar.__class__ is &lt;class ‘type’&gt;<br> Bar.__class__ .__class__.<strong>class</strong> is &lt;class ‘type’&gt;<br> mybar.__class__ is &lt;class ‘<strong>main</strong>.Bar’&gt;<br> mybar.__class__ .__class__.<strong>class</strong> is &lt;class ‘type’&gt;</p> 
</blockquote> 
<p>总之一句话：实例的类是类（创建它的类），类的类是type。</p> 
<p>普通类和元类创建类啥区别？比较复杂，我们这里关注影响backtrader架构的的特点。</p> 
<p>普通类和元类创建的类的一个重要区别就是：</p> 
<p>普通类实例化的时候，先用__new__构造新的空对象，然后调用__init__方法,去初始化这个对象。如果要调用__call__,需要使用实例后加一个括号显式调用。</p> 
<p>元类创建类实例化的时候，首先调用元类的__call__，然后才是__new__和__init__，这样有啥好处？由于要先调用__call__，我们可以控制类的生成，比如说，我们可以控制生成类的参数（普通类代码中固定死了）。实际上99%的没啥用。就是构造架构的时候简化下代码，代价是代码太难读了。</p> 
<p>回到咱们的MetaBase类，该类定义了doprenew/donew/dopreinit/doinit/dopostinit,其中donew中调用类的__new__创建对象和doinit函数对__init__对对象进行初始化。特别注意__call__函数，直接完成预处理、实例化、初始化，后处理一系列动作，而且这个处理不需要显式调用，在类进行实例化的时候就会完成。所有MetaBase（或者其子类）创建的类都会先调用这个函数，包括Cerebro、lineseries、strategies、broker、indicator等等。</p> 
<p>这些功能类并没有继承MetaBase，而是继承MetaBase的子类MetaParams：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MetaParams</span><span class="token punctuation">(</span>MetaBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> dct<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Remove params from class definition to avoid inheritance</span>
        <span class="token comment"># (and hence "repetition")</span>
        newparams <span class="token operator">=</span> dct<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'params'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        packs <span class="token operator">=</span> <span class="token string">'packages'</span>
        newpackages <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>dct<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>packs<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># remove before creation</span>

        fpacks <span class="token operator">=</span> <span class="token string">'frompackages'</span>
        fnewpackages <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>dct<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>fpacks<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># remove before creation</span>

        <span class="token comment"># Create the new class - this pulls predefined "params"</span>
        cls <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>MetaParams<span class="token punctuation">,</span> meta<span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> dct<span class="token punctuation">)</span>

        <span class="token comment"># Pulls the param class out of it - default is the empty class</span>
        params <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token string">'params'</span><span class="token punctuation">,</span> AutoInfoClass<span class="token punctuation">)</span>

        <span class="token comment"># Pulls the packages class out of it - default is the empty class</span>
        packages <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> packs<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        fpackages <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> fpacks<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># get extra (to the right) base classes which have a param attribute</span>
        morebasesparams <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>params <span class="token keyword">for</span> x <span class="token keyword">in</span> bases<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">'params'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment"># Get extra packages, add them to the packages and put all in the class</span>
        <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>packages <span class="token keyword">for</span> x <span class="token keyword">in</span> bases<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> packs<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            packages <span class="token operator">+=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>

        <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>frompackages <span class="token keyword">for</span> x <span class="token keyword">in</span> bases<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> fpacks<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            fpackages <span class="token operator">+=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>

        cls<span class="token punctuation">.</span>packages <span class="token operator">=</span> packages <span class="token operator">+</span> newpackages
        cls<span class="token punctuation">.</span>frompackages <span class="token operator">=</span> fpackages <span class="token operator">+</span> fnewpackages

        <span class="token comment"># Subclass and store the newly derived params class</span>
        cls<span class="token punctuation">.</span>params <span class="token operator">=</span> params<span class="token punctuation">.</span>_derive<span class="token punctuation">(</span>name<span class="token punctuation">,</span> newparams<span class="token punctuation">,</span> morebasesparams<span class="token punctuation">)</span>

        <span class="token keyword">return</span> cls

    <span class="token keyword">def</span> <span class="token function">donew</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        clsmod <span class="token operator">=</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>cls<span class="token punctuation">.</span>__module__<span class="token punctuation">]</span>
        <span class="token comment"># import specified packages</span>
        <span class="token keyword">for</span> p <span class="token keyword">in</span> cls<span class="token punctuation">.</span>packages<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">tuple</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                p<span class="token punctuation">,</span> palias <span class="token operator">=</span> p
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                palias <span class="token operator">=</span> p

            pmod <span class="token operator">=</span> <span class="token builtin">__import__</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>

            plevels <span class="token operator">=</span> p<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> p <span class="token operator">==</span> palias <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>plevels<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># 'os.path' not aliased</span>
                <span class="token builtin">setattr</span><span class="token punctuation">(</span>clsmod<span class="token punctuation">,</span> pmod<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> pmod<span class="token punctuation">)</span>  <span class="token comment"># set 'os' in module</span>

            <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># aliased and/or dots</span>
                <span class="token keyword">for</span> plevel <span class="token keyword">in</span> plevels<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>  <span class="token comment"># recurse down the mod</span>
                    pmod <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>pmod<span class="token punctuation">,</span> plevel<span class="token punctuation">)</span>

                <span class="token builtin">setattr</span><span class="token punctuation">(</span>clsmod<span class="token punctuation">,</span> palias<span class="token punctuation">,</span> pmod<span class="token punctuation">)</span>

        <span class="token comment"># import from specified packages - the 2nd part is a string or iterable</span>
        <span class="token keyword">for</span> p<span class="token punctuation">,</span> frompackage <span class="token keyword">in</span> cls<span class="token punctuation">.</span>frompackages<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>frompackage<span class="token punctuation">,</span> string_types<span class="token punctuation">)</span><span class="token punctuation">:</span>
                frompackage <span class="token operator">=</span> <span class="token punctuation">(</span>frompackage<span class="token punctuation">,</span><span class="token punctuation">)</span>  <span class="token comment"># make it a tuple</span>

            <span class="token keyword">for</span> fp <span class="token keyword">in</span> frompackage<span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">tuple</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    fp<span class="token punctuation">,</span> falias <span class="token operator">=</span> fp
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    fp<span class="token punctuation">,</span> falias <span class="token operator">=</span> fp<span class="token punctuation">,</span> fp  <span class="token comment"># assumed is string</span>

                <span class="token comment"># complain "not string" without fp (unicode vs bytes)</span>
                pmod <span class="token operator">=</span> <span class="token builtin">__import__</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> fromlist<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                pattr <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>pmod<span class="token punctuation">,</span> fp<span class="token punctuation">)</span>
                <span class="token builtin">setattr</span><span class="token punctuation">(</span>clsmod<span class="token punctuation">,</span> falias<span class="token punctuation">,</span> pattr<span class="token punctuation">)</span>
                <span class="token keyword">for</span> basecls <span class="token keyword">in</span> cls<span class="token punctuation">.</span>__bases__<span class="token punctuation">:</span>
                    <span class="token builtin">setattr</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>basecls<span class="token punctuation">.</span>__module__<span class="token punctuation">]</span><span class="token punctuation">,</span> falias<span class="token punctuation">,</span> pattr<span class="token punctuation">)</span>

        <span class="token comment"># Create params and set the values from the kwargs</span>
        params <span class="token operator">=</span> cls<span class="token punctuation">.</span>params<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> pname<span class="token punctuation">,</span> pdef <span class="token keyword">in</span> cls<span class="token punctuation">.</span>params<span class="token punctuation">.</span>_getitems<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> pname<span class="token punctuation">,</span> kwargs<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>pname<span class="token punctuation">,</span> pdef<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Create the object and set the params in place</span>
        _obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>MetaParams<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">.</span>donew<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        _obj<span class="token punctuation">.</span>params <span class="token operator">=</span> params
        _obj<span class="token punctuation">.</span>p <span class="token operator">=</span> params  <span class="token comment"># shorter alias</span>

        <span class="token comment"># Parameter values have now been set before __init__</span>
        <span class="token keyword">return</span> _obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs
</code></pre> 
<p>需要重点关注的是donew函数，在这个函数里面分别提取package，frompackage和params并赋值，前面两个对我们影响不大，关键是params（最后几行代码）。</p> 
<p>如何提取参数了？比如在Cerebro类中，参数定义为元组：</p> 
<pre><code class="prism language-python">params <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token string">'preload'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'runonce'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'maxcpus'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'stdstats'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'oldbuysell'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'oldtrades'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'lookahead'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'exactbars'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'optdatas'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'optreturn'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'objcache'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'live'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'writer'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'tradehistory'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'oldsync'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'tz'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'cheat_on_open'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'broker_coo'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'quicknotify'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre> 
<p>用起来就不方便了，这里通过setattr直接赋值到具体的独立参数里，方便进行访问。</p> 
<p>总结，元组在backtrader中的应用（目前看出来的）：</p> 
<ol><li>所有类实例化的时候通过原来的__call__完成，不同的类可以进行一些特殊化的处理。</li><li>参数通过donew完成映射。</li></ol> 
<p>总之，元类在backtrader中就是做繁琐无聊的工作，让具体功能类专注于功能的实现。</p> 
<p>下面开始具体类的分析，先从backtrader中最重要的Cerebro开始。</p> 
<h2><a id="Cerebro_250"></a>Cerebro</h2> 
<p>cerebro是backtrader系统的中心控制系统，主要的工作包括：</p> 
<ol><li>收集所有的输入（data feeds），执行者（strategies），观测者（Observers）、评价者（Analyzers）以及文档（Writers），保证系统在任何时候都正常运行。</li><li>执行回测或者实时数据输入以及交易。</li><li>返回结果。</li><li>画图。</li></ol> 
<p>下面我们一步一步地结合源代码来分析Cerebro运行机制。</p> 
<p>特别说明下：</p> 
<ul><li>Cerebro只是搭建了运行的架构，很多细节都是在组件中实现，这里重点关注Cerebro的运行机制。</li><li>另外，还有一部分代码过于非常琐碎，对我们使用影响不大，也会省略。</li><li>当然还有一些代码我现在也没看到应用场景，或者看错了，先记录于此，后续随着深入学习后再更正和补充。</li></ul> 
<h3><a id="Cerebro_267"></a>Cerebro的初始化</h3> 
<p>Cerebro通过如下代码进行初始化：</p> 
<pre><code class="prism language-python">cerebro <span class="token operator">=</span> bt<span class="token punctuation">.</span>Cerebro<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
</code></pre> 
<p>这里实例化了一个Cerebro，首先调用是Cerebro类的__init__函数（再此之前还会调用元类的一些处理，例如参数的统一处理，参见前述元类的介绍）：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_dolive <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>_doreplay <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>_dooptimize <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>stores <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>feeds <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>datas <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>datasbyname <span class="token operator">=</span> collections<span class="token punctuation">.</span>OrderedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>strats <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>optcbs <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># holds a list of callbacks for opt strategies</span>
        self<span class="token punctuation">.</span>observers <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>analyzers <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>indicators <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sizers <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>writers <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>storecbs <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>datacbs <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>signals <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_signal_strat <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_signal_concurrent <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>_signal_accumulate <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>_dataid <span class="token operator">=</span> itertools<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_broker <span class="token operator">=</span> BackBroker<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#初始化一个缺省的broker实例。</span>
        self<span class="token punctuation">.</span>_broker<span class="token punctuation">.</span>cerebro <span class="token operator">=</span> self
        self<span class="token punctuation">.</span>_tradingcal <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># TradingCalendar()</span>
        self<span class="token punctuation">.</span>_pretimers <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_ohistory <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_fhistory <span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre> 
<p>可以看出，初始化函数只是设置了类属性（只描述公共属性，私有属性主要用于类函数实现，具体用到的时候在讨论），这些属性如下表所示，具体如何使用我们在。</p> 
<table><thead><tr><th>名称</th><th>定义</th><th>说明</th></tr></thead><tbody><tr><td>stores</td><td>list</td><td>用于存储接收到的其他组件（例如data）消息（通知）。</td></tr><tr><td>feeds</td><td>list</td><td>用于存储数据源（data Feeds）的基类。</td></tr><tr><td>datas</td><td>list</td><td>用于存储数据源。那这个和feeds啥区别？区别就是feeds是data的基类。前面说了，整个框架用了大量类的方法，很复杂，但是简化了应用。我们主要关注应用方法。两者之间的的关系，我们后续在data类中再详述。</td></tr><tr><td>datasbyname</td><td>OrderedDict</td><td>就是存储数据源的名称。存储的方式是有序的字典（python中，字典dict是没有顺序的）。</td></tr><tr><td>strats</td><td>list</td><td>用于存储策略（strategies）类</td></tr><tr><td>optcbs</td><td>list</td><td>存储优化策略的回调。对执行完的优化策略进行处理的回调。啥是优化策略？本系列文章1有过介绍。</td></tr><tr><td>observers</td><td>list</td><td>保存observers类，具体信息在介绍该类的时候再说明。由于Cerebro是整个系统的中心，需要控制多个部件协调行动，所以需要保存这些部件的类（或实例）。</td></tr><tr><td>analyzers</td><td>list</td><td>保存analyzers类，具体信息在介绍该类的时候再说明。</td></tr><tr><td>indicators</td><td>list</td><td>保存indicators类，具体信息在介绍该类的时候再说明。</td></tr><tr><td>writers</td><td>list</td><td>保存writers类，具体信息在介绍该类的时候再说明。</td></tr><tr><td>storecbs</td><td>list</td><td>保存对notify_store消息处理的回调.对于收到存储在store消息中可以定制处理过程。</td></tr><tr><td>datacbs</td><td>list</td><td>保存对data类消息处理的回调。同上类似。</td></tr><tr><td>signals</td><td>list</td><td>保存信号。这种主要用于通过signal strategy进行回测的机制。</td></tr><tr><td>sizers</td><td>dict</td><td>保存sizers类，具体信息在介绍该类的时候再说明。</td></tr></tbody></table> 
<p>Cerebro类还支持一系列的参数（这些参数在元类中统一进行处理），实例化的时候通过**kwargs传递，参数以元组的元组形式定义，如下：</p> 
<pre><code class="prism language-python">params <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token string">'preload'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'runonce'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'maxcpus'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'stdstats'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'oldbuysell'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'oldtrades'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'lookahead'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'exactbars'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'optdatas'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'optreturn'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'objcache'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'live'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'writer'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'tradehistory'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'oldsync'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'tz'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'cheat_on_open'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'broker_coo'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'quicknotify'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre> 
<p>具体信息如下表所示：</p> 
<table><thead><tr><th>参数</th><th>取值范围</th><th>缺省值</th><th>含义</th></tr></thead><tbody><tr><td>preload</td><td>TrueFalse</td><td>TRUE</td><td>是否为Strategies预加载传递给Cerebro的不同数据源。通常我们选择为TRUE。</td></tr><tr><td>runonce</td><td>TrueFalse</td><td>True</td><td>前面描述过，runonce是indicators类对数据访问方法的优化以加快速度，使用的是矢量化模式来提高算法的运行速度，后续如果有大量数据需要进行回测的时候将有极大的优势。strategies和Observers通常是基于事件对数据进行处理。</td></tr><tr><td>maxcpus</td><td>None-&gt;运行系统可用的核</td><td>None</td><td>指定可以用于优化的CPU核。</td></tr><tr><td>stdstats</td><td>TrueFalse</td><td>True</td><td>如果为True的话为创建已缺省的Observers，包括Broker，Buysell和Trades。</td></tr><tr><td>oldbuysell</td><td>TrueFalse</td><td>FALSE</td><td>创建Observers的时候，使用新的bugsell还是之前实现的。没有特殊需求，我们使用新代码。</td></tr><tr><td>oldtrades</td><td>TrueFalse</td><td>FALSE</td><td>创建Observers的时候，使用新的bugsell还是之前实现的。没有特殊需求，我们使用新代码。</td></tr><tr><td>lookahead</td><td>数值</td><td>0</td><td>这个主要用于扩展数据的时候，扩大数据的缓存的大小。通常设置缺省值即可。</td></tr><tr><td>exactbars</td><td>False，数值</td><td>False</td><td>这里用于指示如何缓存数据以节约内存。False就是Lines对象数据都会加入到内存以方便计算。如果采用其他值，会有一些特殊处理减少内存，可能对画图，runonce等机制造成影响。咱们现在机器这么强，内存这么大，而且白菜价，就不要节约了，缺省False就好。</td></tr><tr><td>optdatas</td><td>True False</td><td>True</td><td>这个也是速度处理的优化机制，主要是数据预装载、runonce等，可以提高效率。设置成缺省值就行了</td></tr><tr><td>optreturn</td><td>True False</td><td>True</td><td>同上，也是对不同类的优化机制，可以提高效率，设置为缺省值即可。</td></tr><tr><td>objcache</td><td>True False</td><td>False</td><td>一种实验性质的方法，没啥用，缺省值。</td></tr><tr><td>live</td><td>True False</td><td>False</td><td>是否实时输入数据，这个咱们用不上，缺省值。</td></tr><tr><td>writer</td><td>True False</td><td>False</td><td>设置为True的话，为自动创建一个writer，缺省输出日志到stdout。</td></tr><tr><td>tradehistory</td><td>True False</td><td>False</td><td>设置为True的话，会记录所有策略的每一次交易信息。当然也可以在strategies里面设置</td></tr><tr><td>oldsync</td><td>True False</td><td>False</td><td>新版本之后（1.9.0.99之后）提供新来的datas同步机制。如果你要用老的同步机制，可以设置为True。谁这么无聊呢？大家都喜新厌旧。</td></tr><tr><td>tz</td><td>None，String</td><td>None</td><td>记录时区信息，缺省None，使用的就是UTC，对于中国，就是“UTC+8”。对于回测，时区并不重要。</td></tr><tr><td>cheat_on_open</td><td>True False</td><td>False</td><td>这个设置为True的话，会调用strategies的next_open方法，这个方法在next之前调用，主要用于在对订单的评估，可以基于前一天的open价发起一个订单。具体有啥用，还没想到有啥场景，咱们记住这个茬，说不定哪个策略能用到</td></tr><tr><td>broker_coo</td><td>True False</td><td>True</td><td>和上面差不多，设置为True，broker调用set_coo开启‘cheat_on_open’。开启这一个参数，上一个参数cheat_on_open也必须打开。</td></tr><tr><td>quicknotify</td><td>True False</td><td>False</td><td>就是在next之前发起broker的通知。回测没啥意义，只有实时数据可以快速通知。</td></tr></tbody></table> 
<p>可以看出，Cerebro基本没做啥实质性的工作，只是初始化了一堆容器，真正的处理还是在run之后。</p> 
<h3><a id="Data_Feeds_389"></a>增加数据源（Data Feeds）</h3> 
<p>增加数据源最常见的方式就是cerebro.adddata(data)，data就是必须是已经实例化的data feed。</p> 
<p>例如：</p> 
<pre><code class="prism language-python">data <span class="token operator">=</span> bt<span class="token punctuation">.</span>feeds<span class="token punctuation">.</span>PandasData<span class="token punctuation">(</span>dataname<span class="token operator">=</span>stock_hfq_df<span class="token punctuation">,</span> fromdate<span class="token operator">=</span>start_date<span class="token punctuation">,</span> todate<span class="token operator">=</span>end_date<span class="token punctuation">)</span>  <span class="token comment"># 加载数据</span>
cerebro<span class="token punctuation">.</span>adddata<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre> 
<p>也可以是resample和replay</p> 
<pre><code class="prism language-python">cerebro<span class="token punctuation">.</span>resampledata<span class="token punctuation">(</span>data<span class="token punctuation">,</span>timeframe<span class="token operator">=</span>bt<span class="token punctuation">.</span>TimeFrame<span class="token punctuation">.</span>Weeks<span class="token punctuation">)</span> 
cerebro<span class="token punctuation">.</span>replaydatadata<span class="token punctuation">(</span>data<span class="token punctuation">,</span> timeframe<span class="token operator">=</span>bt<span class="token punctuation">.</span>TimeFrame<span class="token punctuation">.</span>Days<span class="token punctuation">)</span>
</code></pre> 
<p>系统可以接受任何数量的data feeds，包括普通的数据以及resample/replay（这俩啥意思？后面Data Feeds再细说）的数据。</p> 
<p>下面看adddata代码：</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">adddata</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        Adds a ``Data Feed`` instance to the mix.
        If ``name`` is not None it will be put into ``data._name`` which is
        meant for decoration/plotting purposes.
        '''</span>
        <span class="token keyword">if</span> name <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            data<span class="token punctuation">.</span>_name <span class="token operator">=</span> name

        data<span class="token punctuation">.</span>_id <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_dataid<span class="token punctuation">)</span>
        data<span class="token punctuation">.</span>setenvironment<span class="token punctuation">(</span>self<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>datas<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>datasbyname<span class="token punctuation">[</span>data<span class="token punctuation">.</span>_name<span class="token punctuation">]</span> <span class="token operator">=</span> data
        feed <span class="token operator">=</span> data<span class="token punctuation">.</span>getfeed<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> feed <span class="token keyword">and</span> feed <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>feeds<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>feeds<span class="token punctuation">.</span>append<span class="token punctuation">(</span>feed<span class="token punctuation">)</span>

        <span class="token keyword">if</span> data<span class="token punctuation">.</span>islive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_dolive <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token keyword">return</span> data
</code></pre> 
<p>整个流程简述如下：</p> 
<ol><li>记录下data的名称</li><li>分配data的ID，注意，这里从1开始。</li><li>本Cerebro和data建立关联关系：data调用setenvironment记录自己现在归当前Cerebro管，同时Cerebro将data加入到datas列表中，两人建立关系了。</li><li>获取data的feed，如果feed有效，加入到feeds列表中。feed是data的基类。</li><li>最后记录是否实时数据。</li></ol> 
<p>再看看resampdata的代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">resampledata</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dataname<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        Adds a ``Data Feed`` to be resample by the system

        If ``name`` is not None it will be put into ``data._name`` which is
        meant for decoration/plotting purposes.

        Any other kwargs like ``timeframe``, ``compression``, ``todate`` which
        are supported by the resample filter will be passed transparently
        '''</span>
        <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>dataname <span class="token keyword">is</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">)</span><span class="token punctuation">:</span>
            dataname <span class="token operator">=</span> dataname<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>

        dataname<span class="token punctuation">.</span>resample<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>adddata<span class="token punctuation">(</span>dataname<span class="token punctuation">,</span> name<span class="token operator">=</span>name<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_doreplay <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token keyword">return</span> dataname
</code></pre> 
<p>整个函数流程关键点简述如下：</p> 
<ol><li>首先要判断resample目的dataname（data对象实例）是不是已经保存在datas列表中。如果是已经保存的，那么不能直接resample了，需要clone一个新的data对象。</li><li>然后就调用data feeds的resample函数对数据进行处理，具体处理方法后续在data feeds类中再讨论。</li><li>resample后的data就直接调用adddata函数来处理了，同时记录._doreplay标记。</li></ol> 
<p>replaydata的代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">replaydata</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dataname<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        Adds a ``Data Feed`` to be replayed by the system

        If ``name`` is not None it will be put into ``data._name`` which is
        meant for decoration/plotting purposes.

        Any other kwargs like ``timeframe``, ``compression``, ``todate`` which
        are supported by the replay filter will be passed transparently
        '''</span>
        <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>dataname <span class="token keyword">is</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">)</span><span class="token punctuation">:</span>
            dataname <span class="token operator">=</span> dataname<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>

        dataname<span class="token punctuation">.</span>replay<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>adddata<span class="token punctuation">(</span>dataname<span class="token punctuation">,</span> name<span class="token operator">=</span>name<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_doreplay <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token keyword">return</span> dataname
</code></pre> 
<p>和resample处理差不多，就是需要使用data的replay函数进行处理后然后加入到Cerebro的datas列表中。</p> 
<h3><a id="_500"></a>加入策略</h3> 
<p>Cerebro加入策略就更简单了：</p> 
<pre><code>    cerebro.addstrategy(TestStrategy)
</code></pre> 
<p>看看源代码做了啥？也很简单：</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">addstrategy</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> strategy<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        Adds a ``Strategy`` class to the mix for a single pass run.
        Instantiation will happen during ``run`` time.

        args and kwargs will be passed to the strategy as they are during
        instantiation.

        Returns the index with which addition of other objects (like sizers)
        can be referenced
        '''</span>
        self<span class="token punctuation">.</span>strats<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>strategy<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>strats<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
</code></pre> 
<p>函数注释写得很清楚，就是将strategies类加入到Cerebro用于存储的容器中（strats），返回索引，这个索引可以供其他对象引用。特别注意的是，这里只是存储了strategies类以及传递给它的参数，strategies只有在run的时候才会实例化。</p> 
<h3><a id="_528"></a>加入其他部件</h3> 
<p>我们可以理解Cerebro是军队的的指挥中心，要打仗了，先把部队准备好。除了主力部队strategies之外，咱们还得一些配合主力行动的部队，主要包括writer（记录过程），analyzer（分析结果）以及observer(观察交易过程），提供的函数分别是：</p> 
<ul><li>addwriter</li><li>addanalyzer</li><li>addobserver (或者 addobservermulti)</li></ul> 
<p>几个函数源代码如下：</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">addwriter</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> wrtcls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''Adds an ``Writer`` class to the mix. Instantiation will be done at
        ``run`` time in cerebro
        '''</span>
        self<span class="token punctuation">.</span>writers<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>wrtcls<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">addsizer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sizercls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''Adds a ``Sizer`` class (and args) which is the default sizer for any
        strategy added to cerebro
        '''</span>
        self<span class="token punctuation">.</span>sizers<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>sizercls<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">addanalyzer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ancls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        Adds an ``Analyzer`` class to the mix. Instantiation will be done at
        ``run`` time
        '''</span>
        self<span class="token punctuation">.</span>analyzers<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>ancls<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">addobserver</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obscls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        Adds an ``Observer`` class to the mix. Instantiation will be done at
        ``run`` time
        '''</span>
        self<span class="token punctuation">.</span>observers<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> obscls<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">addobservermulti</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obscls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        Adds an ``Observer`` class to the mix. Instantiation will be done at
        ``run`` time

        It will be added once per "data" in the system. A use case is a
        buy/sell observer which observes individual datas.

        A counter-example is the CashValue, which observes system-wide values
        '''</span>
        self<span class="token punctuation">.</span>observers<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> obscls<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>代码都简单，就是将各个部队装入对应的容器，注意，这里装入的都是类以及参数，在run的时候实例化。这些部队各自功能，后续在各自类中详述。</p> 
<h3><a id="broker_582"></a>更改broker</h3> 
<p>大家应该记得初始化的时候实例化了一个缺省的broker，如果你希望提供自己的broker，可以通过如下方法重写：</p> 
<pre><code class="prism language-python">broker <span class="token operator">=</span> MyBroker<span class="token punctuation">(</span><span class="token punctuation">)</span>
cerebro<span class="token punctuation">.</span>broker <span class="token operator">=</span> broker
</code></pre> 
<p>有人说，broker我记得是私有属性啊，咋直接赋值操作了？这个用的是property（装饰器），等同通过setbroker/getbroker设置/读取。</p> 
<p>好了，部队ready，开始run了。</p> 
<h3><a id="run_595"></a>开始run</h3> 
<p>用户使用如下代码开始run：</p> 
<pre><code class="prism language-python">result <span class="token operator">=</span> cerebro<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
</code></pre> 
<p>注意，run函数是带参数的。</p> 
<h4><a id="run_605"></a>run函数代码解读</h4> 
<p>run的源代码如下（比较长，分几段进行解析）</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''The core method to perform backtesting. Any ``kwargs`` passed to it
        will affect the value of the standard parameters ``Cerebro`` was
        instantiated with.

        If ``cerebro`` has not datas the method will immediately bail out.

        It has different return values:

          - For No Optimization: a list contanining instances of the Strategy
            classes added with ``addstrategy``

          - For Optimization: a list of lists which contain instances of the
            Strategy classes added with ``addstrategy``
        '''</span>
        self<span class="token punctuation">.</span>_event_stop <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># Stop is requested</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># nothing can be run</span>

        pkeys <span class="token operator">=</span> self<span class="token punctuation">.</span>params<span class="token punctuation">.</span>_getkeys<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> key<span class="token punctuation">,</span> val <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> key <span class="token keyword">in</span> pkeys<span class="token punctuation">:</span>
                <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>params<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span>

        <span class="token comment"># Manage activate/deactivate object cache</span>
        linebuffer<span class="token punctuation">.</span>LineActions<span class="token punctuation">.</span>cleancache<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># clean cache</span>
        indicator<span class="token punctuation">.</span>Indicator<span class="token punctuation">.</span>cleancache<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># clean cache</span>

        linebuffer<span class="token punctuation">.</span>LineActions<span class="token punctuation">.</span>usecache<span class="token punctuation">(</span>self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>objcache<span class="token punctuation">)</span>
        indicator<span class="token punctuation">.</span>Indicator<span class="token punctuation">.</span>usecache<span class="token punctuation">(</span>self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>objcache<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_dorunonce <span class="token operator">=</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>runonce
        self<span class="token punctuation">.</span>_dopreload <span class="token operator">=</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>preload
        self<span class="token punctuation">.</span>_exactbars <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>exactbars<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_exactbars<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_dorunonce <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># something is saving memory, no runonce</span>
            self<span class="token punctuation">.</span>_dopreload <span class="token operator">=</span> self<span class="token punctuation">.</span>_dopreload <span class="token keyword">and</span> self<span class="token punctuation">.</span>_exactbars <span class="token operator">&lt;</span> <span class="token number">1</span>

        self<span class="token punctuation">.</span>_doreplay <span class="token operator">=</span> self<span class="token punctuation">.</span>_doreplay <span class="token keyword">or</span> <span class="token builtin">any</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>replaying <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_doreplay<span class="token punctuation">:</span>
            <span class="token comment"># preloading is not supported with replay. full timeframe bars</span>
            <span class="token comment"># are constructed in realtime</span>
            self<span class="token punctuation">.</span>_dopreload <span class="token operator">=</span> <span class="token boolean">False</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_dolive <span class="token keyword">or</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>live<span class="token punctuation">:</span>
            <span class="token comment"># in this case both preload and runonce must be off</span>
            self<span class="token punctuation">.</span>_dorunonce <span class="token operator">=</span> <span class="token boolean">False</span>
            self<span class="token punctuation">.</span>_dopreload <span class="token operator">=</span> <span class="token boolean">False</span>

        self<span class="token punctuation">.</span>runwriters <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Add the system default writer if requested</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>writer <span class="token keyword">is</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            wr <span class="token operator">=</span> WriterFile<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>runwriters<span class="token punctuation">.</span>append<span class="token punctuation">(</span>wr<span class="token punctuation">)</span>

        <span class="token comment"># Instantiate any other writers</span>
        <span class="token keyword">for</span> wrcls<span class="token punctuation">,</span> wrargs<span class="token punctuation">,</span> wrkwargs <span class="token keyword">in</span> self<span class="token punctuation">.</span>writers<span class="token punctuation">:</span>
            wr <span class="token operator">=</span> wrcls<span class="token punctuation">(</span><span class="token operator">*</span>wrargs<span class="token punctuation">,</span> <span class="token operator">**</span>wrkwargs<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>runwriters<span class="token punctuation">.</span>append<span class="token punctuation">(</span>wr<span class="token punctuation">)</span>

        <span class="token comment"># Write down if any writer wants the full csv output</span>
        self<span class="token punctuation">.</span>writers_csv <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>p<span class="token punctuation">.</span>csv<span class="token punctuation">,</span> self<span class="token punctuation">.</span>runwriters<span class="token punctuation">)</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>runstrats <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>要点：</p> 
<ol><li>记录_event_stop为False，说明开始启动了，需要通过stop来停止。</li><li>检查是否有数据源（datas），没有的话，没法跑，退出。</li><li>检查下run函数携带的参数在不在Cerebro的参数表里面，有的话，更新Cerebro实例的参数，说明Cerebro参数在初始化的时候可以设置，在run的时候也可以设置。</li><li>紧接着就是参数的的处理，根据参数设置一些标记（参数的含义参见前述的表格，绝大部分用不上），清空缓存，为系统运行做好准备。</li><li>如果参数指示要求提供writers（记录日志），那么就实例化一个缺省的writers。同时看看还有没有其他的writers（通过addwriter添加的），有的话，就实例化。两者都加入到runwriters容器，然后看看这些writers有没有参数要求输出csv，任意一个有这个参数，记录到writers_csv标志中。注意这里Any的用法。</li><li>初始化运行策略容器（runstrats）以供后用。</li></ol> 
<p>下面继续：</p> 
<pre><code class="prism language-python"><span class="token keyword">if</span> self<span class="token punctuation">.</span>signals<span class="token punctuation">:</span>  <span class="token comment"># allow processing of signals</span>
            signalst<span class="token punctuation">,</span> sargs<span class="token punctuation">,</span> skwargs <span class="token operator">=</span> self<span class="token punctuation">.</span>_signal_strat
            <span class="token keyword">if</span> signalst <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token comment"># Try to see if the 1st regular strategy is a signal strategy</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    signalst<span class="token punctuation">,</span> sargs<span class="token punctuation">,</span> skwargs <span class="token operator">=</span> self<span class="token punctuation">.</span>strats<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>
                    <span class="token keyword">pass</span>  <span class="token comment"># Nothing there</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>signalst<span class="token punctuation">,</span> SignalStrategy<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token comment"># no signal ... reinsert at the beginning</span>
                        self<span class="token punctuation">.</span>strats<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>signalst<span class="token punctuation">,</span> sargs<span class="token punctuation">,</span> skwargs<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        signalst <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># flag as not presetn</span>

            <span class="token keyword">if</span> signalst <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>  <span class="token comment"># recheck</span>
                <span class="token comment"># Still None, create a default one</span>
                signalst<span class="token punctuation">,</span> sargs<span class="token punctuation">,</span> skwargs <span class="token operator">=</span> SignalStrategy<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># Add the signal strategy</span>
            self<span class="token punctuation">.</span>addstrategy<span class="token punctuation">(</span>signalst<span class="token punctuation">,</span>
                             _accumulate<span class="token operator">=</span>self<span class="token punctuation">.</span>_signal_accumulate<span class="token punctuation">,</span>
                             _concurrent<span class="token operator">=</span>self<span class="token punctuation">.</span>_signal_concurrent<span class="token punctuation">,</span>
                             signals<span class="token operator">=</span>self<span class="token punctuation">.</span>signals<span class="token punctuation">,</span>
                             <span class="token operator">*</span>sargs<span class="token punctuation">,</span>
                             <span class="token operator">**</span>skwargs<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>strats<span class="token punctuation">:</span>  <span class="token comment"># Datas are present, add a strategy</span>
            self<span class="token punctuation">.</span>addstrategy<span class="token punctuation">(</span>Strategy<span class="token punctuation">)</span>

        iterstrats <span class="token operator">=</span> itertools<span class="token punctuation">.</span>product<span class="token punctuation">(</span><span class="token operator">*</span>self<span class="token punctuation">.</span>strats<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_dooptimize <span class="token keyword">or</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>maxcpus <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token comment"># If no optimmization is wished ... or 1 core is to be used</span>
            <span class="token comment"># let's skip process "spawning"</span>
            <span class="token keyword">for</span> iterstrat <span class="token keyword">in</span> iterstrats<span class="token punctuation">:</span>
                runstrat <span class="token operator">=</span> self<span class="token punctuation">.</span>runstrategies<span class="token punctuation">(</span>iterstrat<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>runstrats<span class="token punctuation">.</span>append<span class="token punctuation">(</span>runstrat<span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>_dooptimize<span class="token punctuation">:</span>
                    <span class="token keyword">for</span> cb <span class="token keyword">in</span> self<span class="token punctuation">.</span>optcbs<span class="token punctuation">:</span>
                        cb<span class="token punctuation">(</span>runstrat<span class="token punctuation">)</span>  <span class="token comment"># callback receives finished strategy</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>optdatas <span class="token keyword">and</span> self<span class="token punctuation">.</span>_dopreload <span class="token keyword">and</span> self<span class="token punctuation">.</span>_dorunonce<span class="token punctuation">:</span>
                <span class="token keyword">for</span> data <span class="token keyword">in</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">:</span>
                    data<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_exactbars <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># datas can be full length</span>
                        data<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>size<span class="token operator">=</span>self<span class="token punctuation">.</span>params<span class="token punctuation">.</span>lookahead<span class="token punctuation">)</span>
                    data<span class="token punctuation">.</span>_start<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_dopreload<span class="token punctuation">:</span>
                        data<span class="token punctuation">.</span>preload<span class="token punctuation">(</span><span class="token punctuation">)</span>

            pool <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Pool<span class="token punctuation">(</span>self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>maxcpus <span class="token keyword">or</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> r <span class="token keyword">in</span> pool<span class="token punctuation">.</span>imap<span class="token punctuation">(</span>self<span class="token punctuation">,</span> iterstrats<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>runstrats<span class="token punctuation">.</span>append<span class="token punctuation">(</span>r<span class="token punctuation">)</span>
                <span class="token keyword">for</span> cb <span class="token keyword">in</span> self<span class="token punctuation">.</span>optcbs<span class="token punctuation">:</span>
                    cb<span class="token punctuation">(</span>r<span class="token punctuation">)</span>  <span class="token comment"># callback receives finished strategy</span>

            pool<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>optdatas <span class="token keyword">and</span> self<span class="token punctuation">.</span>_dopreload <span class="token keyword">and</span> self<span class="token punctuation">.</span>_dorunonce<span class="token punctuation">:</span>
                <span class="token keyword">for</span> data <span class="token keyword">in</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">:</span>
                    data<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_dooptimize<span class="token punctuation">:</span>
            <span class="token comment"># avoid a list of list for regular cases</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>runstrats<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token keyword">return</span> self<span class="token punctuation">.</span>runstrats
</code></pre> 
<p>要点如下：</p> 
<ol><li> <p>最前面是处理信号相关功能。如果要处理信号，首先看_signal_strat容器中有没有记录信号策略类（SignalStrategy，通过signal_strategy加入的，至于这个东西的用途，咱们在strategies再介绍）。如果没有的话，看看普通strategies容器strats第一个策略是不是SignalStrategy类（用到了isinstance这个函数），还不是的话（记得把普通策略类返回），就创建一个空的signal_strategy。听起来有点绕吧，总之就是用户自己通过signal_strategy函数添加的signalStrategy，普通strategy容器中的signalStrategy以及缺省创建的signalstrategy，三个按优先顺序，必须插入一个信号策略类，注意还是保存在普通strategies容器strats中，只是参数设置为signal。这里关键要记住的是，如果要使用信号回测方式，那么一定要加一个信号策略类。</p> </li><li> <p>如果用户没有设定策略，Cerebro局加一个缺省的strategies类。大家还记得系列文章（1）中最简单程序没有加策略，系统还是一样可以运行。</p> </li><li> <p>下面一行代码就比较重要了，使用了product将所有的strategies类存放到iterstrats迭代器中。</p> </li><li> <p>紧接着的处理就运行strategy，分为两类处理：</p> 
  <ol><li>如果不进行性能优化，或者参数中maxcpus为1：那么直接按循序调用runstrategies（下一步详述）运行进行策略的运行。如果是优化策略（就是一个策略输入多个参数进行优化评估）的处理。执行完的策略还可以调用回调（回调可通过optcallback增加）进行处理。</li><li>对于需要进行性能优化的处理：首先对数据进行reset/start/preload的处理（具体处理，后续在data feeds类详述），然后根据maxcpus参数启用多线程，在多线程中调用runstrategies进行策略运行。同样对于优化策略进行回调处理。执行完毕，还得调用data的stop方法。</li></ol> </li></ol> 
<h4><a id="runstrategies_773"></a>runstrategies函数代码解读</h4> 
<p>下面看runstrategies:</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">runstrategies</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> iterstrat<span class="token punctuation">,</span> predata<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    Internal method invoked by ``run```to run a set of strategies
    '''</span>
    self<span class="token punctuation">.</span>_init_stcount<span class="token punctuation">(</span><span class="token punctuation">)</span>

    self<span class="token punctuation">.</span>runningstrats <span class="token operator">=</span> runstrats <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> store <span class="token keyword">in</span> self<span class="token punctuation">.</span>stores<span class="token punctuation">:</span>
        store<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>cheat_on_open <span class="token keyword">and</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>broker_coo<span class="token punctuation">:</span>
        <span class="token comment"># try to activate in broker</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_broker<span class="token punctuation">,</span> <span class="token string">'set_coo'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_broker<span class="token punctuation">.</span>set_coo<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_fhistory <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_broker<span class="token punctuation">.</span>set_fund_history<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_fhistory<span class="token punctuation">)</span>

    <span class="token keyword">for</span> orders<span class="token punctuation">,</span> onotify <span class="token keyword">in</span> self<span class="token punctuation">.</span>_ohistory<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_broker<span class="token punctuation">.</span>add_order_history<span class="token punctuation">(</span>orders<span class="token punctuation">,</span> onotify<span class="token punctuation">)</span>

    self<span class="token punctuation">.</span>_broker<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> feed <span class="token keyword">in</span> self<span class="token punctuation">.</span>feeds<span class="token punctuation">:</span>
        feed<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>writers_csv<span class="token punctuation">:</span>
        wheaders <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> data <span class="token keyword">in</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">:</span>
            <span class="token keyword">if</span> data<span class="token punctuation">.</span>csv<span class="token punctuation">:</span>
                wheaders<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>data<span class="token punctuation">.</span>getwriterheaders<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> writer <span class="token keyword">in</span> self<span class="token punctuation">.</span>runwriters<span class="token punctuation">:</span>
            <span class="token keyword">if</span> writer<span class="token punctuation">.</span>p<span class="token punctuation">.</span>csv<span class="token punctuation">:</span>
                writer<span class="token punctuation">.</span>addheaders<span class="token punctuation">(</span>wheaders<span class="token punctuation">)</span>

    <span class="token comment"># self._plotfillers = [list() for d in self.datas]</span>
    <span class="token comment"># self._plotfillers2 = [list() for d in self.datas]</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> predata<span class="token punctuation">:</span>
        <span class="token keyword">for</span> data <span class="token keyword">in</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">:</span>
            data<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_exactbars <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># datas can be full length</span>
                data<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>size<span class="token operator">=</span>self<span class="token punctuation">.</span>params<span class="token punctuation">.</span>lookahead<span class="token punctuation">)</span>
            data<span class="token punctuation">.</span>_start<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_dopreload<span class="token punctuation">:</span>
                data<span class="token punctuation">.</span>preload<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> stratcls<span class="token punctuation">,</span> sargs<span class="token punctuation">,</span> skwargs <span class="token keyword">in</span> iterstrat<span class="token punctuation">:</span>
        sargs <span class="token operator">=</span> self<span class="token punctuation">.</span>datas <span class="token operator">+</span> <span class="token builtin">list</span><span class="token punctuation">(</span>sargs<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            strat <span class="token operator">=</span> stratcls<span class="token punctuation">(</span><span class="token operator">*</span>sargs<span class="token punctuation">,</span> <span class="token operator">**</span>skwargs<span class="token punctuation">)</span>
        <span class="token keyword">except</span> bt<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>StrategySkipError<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>  <span class="token comment"># do not add strategy to the mix</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>oldsync<span class="token punctuation">:</span>
            strat<span class="token punctuation">.</span>_oldsync <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># tell strategy to use old clock update</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>tradehistory<span class="token punctuation">:</span>
            strat<span class="token punctuation">.</span>set_tradehistory<span class="token punctuation">(</span><span class="token punctuation">)</span>
        runstrats<span class="token punctuation">.</span>append<span class="token punctuation">(</span>strat<span class="token punctuation">)</span>

    tz <span class="token operator">=</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>tz
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>tz<span class="token punctuation">,</span> integer_types<span class="token punctuation">)</span><span class="token punctuation">:</span>
        tz <span class="token operator">=</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">[</span>tz<span class="token punctuation">]</span><span class="token punctuation">.</span>_tz
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        tz <span class="token operator">=</span> tzparse<span class="token punctuation">(</span>tz<span class="token punctuation">)</span>
</code></pre> 
<p>要点如下：</p> 
<ol><li> <p>策略运行计数。</p> </li><li> <p>初始化一个容器runningstrats用于存储正在运行的策略。</p> </li><li> <p>然后是对部件（Cerebro控制的部队）的参数设置和初始化：信号存储（store）的启动（start）；broker参数的设置和启动。feed（feed哪来的？adddata的时候获取的）的启动。Writers的参数设置。</p> </li><li> <p>如果predata为否的话，那么现在就开始调用preload预加载数据。部分性能优化情况下，在run的时候就preload了。</p> </li><li> <p>下面重点来了：从iterstrat迭代器（run调用本函数带进来的，携带的是加入的strategies及其参数）提取每一个strategy和参数，进行strategy的实例化和初始化，并返回正在执行的strategy的实例，记录到runstrats容器中。如下代码非常重要，使用了元类的方法进行处理（这就是元类的好处，极大的简化处理，代价是难懂）：</p> <pre><code class="prism language-python">strat <span class="token operator">=</span> stratcls<span class="token punctuation">(</span><span class="token operator">*</span>sargs<span class="token punctuation">,</span> <span class="token operator">**</span>skwargs<span class="token punctuation">)</span>
</code></pre> </li><li> <p>记录下时区，用datas类存储的时区或者参数输入时区。</p> </li></ol> 
<p>继续代码：</p> 
<pre><code class="prism language-python">     <span class="token keyword">if</span> runstrats<span class="token punctuation">:</span>
<span class="token comment">#loop separated for clarity</span>
             defaultsizer <span class="token operator">=</span> self<span class="token punctuation">.</span>sizers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token keyword">for</span> idx<span class="token punctuation">,</span> strat <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>runstrats<span class="token punctuation">)</span><span class="token punctuation">:</span>
                 <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>stdstats<span class="token punctuation">:</span>
                     strat<span class="token punctuation">.</span>_addobserver<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> observers<span class="token punctuation">.</span>Broker<span class="token punctuation">)</span>
                     <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>oldbuysell<span class="token punctuation">:</span>
                         strat<span class="token punctuation">.</span>_addobserver<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> observers<span class="token punctuation">.</span>BuySell<span class="token punctuation">)</span>
                     <span class="token keyword">else</span><span class="token punctuation">:</span>
                         strat<span class="token punctuation">.</span>_addobserver<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> observers<span class="token punctuation">.</span>BuySell<span class="token punctuation">,</span>
                                           barplot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>oldtrades <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>datas<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                        strat<span class="token punctuation">.</span>_addobserver<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> observers<span class="token punctuation">.</span>Trades<span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        strat<span class="token punctuation">.</span>_addobserver<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> observers<span class="token punctuation">.</span>DataTrades<span class="token punctuation">)</span>
    
                <span class="token keyword">for</span> multi<span class="token punctuation">,</span> obscls<span class="token punctuation">,</span> obsargs<span class="token punctuation">,</span> obskwargs <span class="token keyword">in</span> self<span class="token punctuation">.</span>observers<span class="token punctuation">:</span>
                    strat<span class="token punctuation">.</span>_addobserver<span class="token punctuation">(</span>multi<span class="token punctuation">,</span> obscls<span class="token punctuation">,</span> <span class="token operator">*</span>obsargs<span class="token punctuation">,</span> <span class="token operator">**</span>obskwargs<span class="token punctuation">)</span>
    
                <span class="token keyword">for</span> indcls<span class="token punctuation">,</span> indargs<span class="token punctuation">,</span> indkwargs <span class="token keyword">in</span> self<span class="token punctuation">.</span>indicators<span class="token punctuation">:</span>
                    strat<span class="token punctuation">.</span>_addindicator<span class="token punctuation">(</span>indcls<span class="token punctuation">,</span> <span class="token operator">*</span>indargs<span class="token punctuation">,</span> <span class="token operator">**</span>indkwargs<span class="token punctuation">)</span>
    
                <span class="token keyword">for</span> ancls<span class="token punctuation">,</span> anargs<span class="token punctuation">,</span> ankwargs <span class="token keyword">in</span> self<span class="token punctuation">.</span>analyzers<span class="token punctuation">:</span>
                    strat<span class="token punctuation">.</span>_addanalyzer<span class="token punctuation">(</span>ancls<span class="token punctuation">,</span> <span class="token operator">*</span>anargs<span class="token punctuation">,</span> <span class="token operator">**</span>ankwargs<span class="token punctuation">)</span>
    
                sizer<span class="token punctuation">,</span> sargs<span class="token punctuation">,</span> skwargs <span class="token operator">=</span> self<span class="token punctuation">.</span>sizers<span class="token punctuation">.</span>get<span class="token punctuation">(</span>idx<span class="token punctuation">,</span> defaultsizer<span class="token punctuation">)</span>
                <span class="token keyword">if</span> sizer <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    strat<span class="token punctuation">.</span>_addsizer<span class="token punctuation">(</span>sizer<span class="token punctuation">,</span> <span class="token operator">*</span>sargs<span class="token punctuation">,</span> <span class="token operator">**</span>skwargs<span class="token punctuation">)</span>
    
                strat<span class="token punctuation">.</span>_settz<span class="token punctuation">(</span>tz<span class="token punctuation">)</span>
                strat<span class="token punctuation">.</span>_start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
                <span class="token keyword">for</span> writer <span class="token keyword">in</span> self<span class="token punctuation">.</span>runwriters<span class="token punctuation">:</span>
                    <span class="token keyword">if</span> writer<span class="token punctuation">.</span>p<span class="token punctuation">.</span>csv<span class="token punctuation">:</span>
                        writer<span class="token punctuation">.</span>addheaders<span class="token punctuation">(</span>strat<span class="token punctuation">.</span>getwriterheaders<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
            <span class="token keyword">if</span> <span class="token keyword">not</span> predata<span class="token punctuation">:</span>
                <span class="token keyword">for</span> strat <span class="token keyword">in</span> runstrats<span class="token punctuation">:</span>
                    strat<span class="token punctuation">.</span>qbuffer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_exactbars<span class="token punctuation">,</span> replaying<span class="token operator">=</span>self<span class="token punctuation">.</span>_doreplay<span class="token punctuation">)</span>
    
            <span class="token keyword">for</span> writer <span class="token keyword">in</span> self<span class="token punctuation">.</span>runwriters<span class="token punctuation">:</span>
                writer<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
            <span class="token comment"># Prepare timers</span>
            self<span class="token punctuation">.</span>_timers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>_timerscheat <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> timer <span class="token keyword">in</span> self<span class="token punctuation">.</span>_pretimers<span class="token punctuation">:</span>
                <span class="token comment"># preprocess tzdata if needed</span>
                timer<span class="token punctuation">.</span>start<span class="token punctuation">(</span>self<span class="token punctuation">.</span>datas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
                <span class="token keyword">if</span> timer<span class="token punctuation">.</span>params<span class="token punctuation">.</span>cheat<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>_timerscheat<span class="token punctuation">.</span>append<span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>_timers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
    
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_dopreload <span class="token keyword">and</span> self<span class="token punctuation">.</span>_dorunonce<span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>oldsync<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>_runonce_old<span class="token punctuation">(</span>runstrats<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>_runonce<span class="token punctuation">(</span>runstrats<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>oldsync<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>_runnext_old<span class="token punctuation">(</span>runstrats<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>_runnext<span class="token punctuation">(</span>runstrats<span class="token punctuation">)</span>
    
            <span class="token keyword">for</span> strat <span class="token keyword">in</span> runstrats<span class="token punctuation">:</span>
                strat<span class="token punctuation">.</span>_stop<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre> 
<p>要点如下：</p> 
<ol><li>开始针对运行的strategy实例，分别加入Observers、indicators、analyzer以及sizer类，并调用start函数开始启动，主要进行一些初始的处理，后续在strategies类中说明。</li><li>对于运行的writers（存储在runwriters容器中，run的时候实例化），设置表头，并启动。</li><li>设定定时器，并开始对strategies执行_runonce/_runonce_old/_runnext_old/_runnexth函数，这些后面单独描述。</li><li>后面一段代码就不贴了，主要就是停止各部件。如果是优化策略运行的话，还要对运行结果进行分析。</li></ol> 
<p>下面开始runnext和runonce代码的解读，先看最常用的runnext：</p> 
<h4><a id="_runnext_951"></a>_runnext函数代码解读</h4> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">_runnext</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> runstrats<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        Actual implementation of run in full next mode. All objects have its
        ``next`` method invoke on each data arrival
        '''</span>
        datas <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>datas<span class="token punctuation">,</span>
                       key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>_timeframe<span class="token punctuation">,</span> x<span class="token punctuation">.</span>_compression<span class="token punctuation">)</span><span class="token punctuation">)</span>
        datas1 <span class="token operator">=</span> datas<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        data0 <span class="token operator">=</span> datas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        d0ret <span class="token operator">=</span> <span class="token boolean">True</span>

        rs <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i<span class="token punctuation">,</span> x <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>datas<span class="token punctuation">)</span> <span class="token keyword">if</span> x<span class="token punctuation">.</span>resampling<span class="token punctuation">]</span>
        rp <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i<span class="token punctuation">,</span> x <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>datas<span class="token punctuation">)</span> <span class="token keyword">if</span> x<span class="token punctuation">.</span>replaying<span class="token punctuation">]</span>
        rsonly <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i<span class="token punctuation">,</span> x <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>datas<span class="token punctuation">)</span>
                  <span class="token keyword">if</span> x<span class="token punctuation">.</span>resampling <span class="token keyword">and</span> <span class="token keyword">not</span> x<span class="token punctuation">.</span>replaying<span class="token punctuation">]</span>
        onlyresample <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>datas<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rsonly<span class="token punctuation">)</span>
        noresample <span class="token operator">=</span> <span class="token keyword">not</span> rsonly

        clonecount <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>_clone <span class="token keyword">for</span> d <span class="token keyword">in</span> datas<span class="token punctuation">)</span>
        ldatas <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>datas<span class="token punctuation">)</span>
        ldatas_noclones <span class="token operator">=</span> ldatas <span class="token operator">-</span> clonecount
        lastqcheck <span class="token operator">=</span> <span class="token boolean">False</span>
        dt0 <span class="token operator">=</span> date2num<span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span>  <span class="token comment"># default at max</span>
        <span class="token keyword">while</span> d0ret <span class="token keyword">or</span> d0ret <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token comment"># if any has live data in the buffer, no data will wait anything</span>
            newqcheck <span class="token operator">=</span> <span class="token keyword">not</span> <span class="token builtin">any</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>haslivedata<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> datas<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> newqcheck<span class="token punctuation">:</span>
                <span class="token comment"># If no data has reached the live status or all, wait for</span>
                <span class="token comment"># the next incoming data</span>
                livecount <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>_laststatus <span class="token operator">==</span> d<span class="token punctuation">.</span>LIVE <span class="token keyword">for</span> d <span class="token keyword">in</span> datas<span class="token punctuation">)</span>
                newqcheck <span class="token operator">=</span> <span class="token keyword">not</span> livecount <span class="token keyword">or</span> livecount <span class="token operator">==</span> ldatas_noclones

            lastret <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token comment"># Notify anything from the store even before moving datas</span>
            <span class="token comment"># because datas may not move due to an error reported by the store</span>
            self<span class="token punctuation">.</span>_storenotify<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_event_stop<span class="token punctuation">:</span>  <span class="token comment"># stop if requested</span>
                <span class="token keyword">return</span>
            self<span class="token punctuation">.</span>_datanotify<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_event_stop<span class="token punctuation">:</span>  <span class="token comment"># stop if requested</span>
                <span class="token keyword">return</span>

            <span class="token comment"># record starting time and tell feeds to discount the elapsed time</span>
            <span class="token comment"># from the qcheck value</span>
            drets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            qstart <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> d <span class="token keyword">in</span> datas<span class="token punctuation">:</span>
                qlapse <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> qstart
                d<span class="token punctuation">.</span>do_qcheck<span class="token punctuation">(</span>newqcheck<span class="token punctuation">,</span> qlapse<span class="token punctuation">.</span>total_seconds<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                drets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span>ticks<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            d0ret <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dret <span class="token keyword">for</span> dret <span class="token keyword">in</span> drets<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> d0ret <span class="token keyword">and</span> <span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dret <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">for</span> dret <span class="token keyword">in</span> drets<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                d0ret <span class="token operator">=</span> <span class="token boolean">None</span>

            <span class="token keyword">if</span> d0ret<span class="token punctuation">:</span>
                dts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                <span class="token keyword">for</span> i<span class="token punctuation">,</span> ret <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>drets<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    dts<span class="token punctuation">.</span>append<span class="token punctuation">(</span>datas<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>datetime<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">if</span> ret <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">)</span>

                <span class="token comment"># Get index to minimum datetime</span>
                <span class="token keyword">if</span> onlyresample <span class="token keyword">or</span> noresample<span class="token punctuation">:</span>
                    dt0 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token keyword">for</span> d <span class="token keyword">in</span> dts <span class="token keyword">if</span> d <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    dt0 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token keyword">for</span> i<span class="token punctuation">,</span> d <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dts<span class="token punctuation">)</span>
                               <span class="token keyword">if</span> d <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> i <span class="token keyword">not</span> <span class="token keyword">in</span> rsonly<span class="token punctuation">)</span><span class="token punctuation">)</span>

                dmaster <span class="token operator">=</span> datas<span class="token punctuation">[</span>dts<span class="token punctuation">.</span>index<span class="token punctuation">(</span>dt0<span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># and timemaster</span>
                self<span class="token punctuation">.</span>_dtmaster <span class="token operator">=</span> dmaster<span class="token punctuation">.</span>num2date<span class="token punctuation">(</span>dt0<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>_udtmaster <span class="token operator">=</span> num2date<span class="token punctuation">(</span>dt0<span class="token punctuation">)</span>

                <span class="token comment"># slen = len(runstrats[0])</span>
                <span class="token comment"># Try to get something for those that didn't return</span>
                <span class="token keyword">for</span> i<span class="token punctuation">,</span> ret <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>drets<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> ret<span class="token punctuation">:</span>  <span class="token comment"># dts already contains a valid datetime for this i</span>
                        <span class="token keyword">continue</span>

                    <span class="token comment"># try to get a data by checking with a master</span>
                    d <span class="token operator">=</span> datas<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                    d<span class="token punctuation">.</span>_check<span class="token punctuation">(</span>forcedata<span class="token operator">=</span>dmaster<span class="token punctuation">)</span>  <span class="token comment"># check to force output</span>
                    <span class="token keyword">if</span> d<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span>datamaster<span class="token operator">=</span>dmaster<span class="token punctuation">,</span> ticks<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># retry</span>
                        dts<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> d<span class="token punctuation">.</span>datetime<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># good -&gt; store</span>
                        <span class="token comment"># self._plotfillers2[i].append(slen)  # mark as fill</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        <span class="token comment"># self._plotfillers[i].append(slen)  # mark as empty</span>
                        <span class="token keyword">pass</span>

                <span class="token comment"># make sure only those at dmaster level end up delivering</span>
                <span class="token keyword">for</span> i<span class="token punctuation">,</span> dti <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dts<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> dti <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                        di <span class="token operator">=</span> datas<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                        rpi <span class="token operator">=</span> <span class="token boolean">False</span> <span class="token keyword">and</span> di<span class="token punctuation">.</span>replaying   <span class="token comment"># to check behavior</span>
                        <span class="token keyword">if</span> dti <span class="token operator">&gt;</span> dt0<span class="token punctuation">:</span>
                            <span class="token keyword">if</span> <span class="token keyword">not</span> rpi<span class="token punctuation">:</span>  <span class="token comment"># must see all ticks ...</span>
                                di<span class="token punctuation">.</span>rewind<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># cannot deliver yet</span>
                            <span class="token comment"># self._plotfillers[i].append(slen)</span>
                        <span class="token keyword">elif</span> <span class="token keyword">not</span> di<span class="token punctuation">.</span>replaying<span class="token punctuation">:</span>
                            <span class="token comment"># Replay forces tick fill, else force here</span>
                            di<span class="token punctuation">.</span>_tick_fill<span class="token punctuation">(</span>force<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

                        <span class="token comment"># self._plotfillers2[i].append(slen)  # mark as fill</span>

            <span class="token keyword">elif</span> d0ret <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token comment"># meant for things like live feeds which may not produce a bar</span>
                <span class="token comment"># at the moment but need the loop to run for notifications and</span>
                <span class="token comment"># getting resample and others to produce timely bars</span>
                <span class="token keyword">for</span> data <span class="token keyword">in</span> datas<span class="token punctuation">:</span>
                    data<span class="token punctuation">.</span>_check<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                lastret <span class="token operator">=</span> data0<span class="token punctuation">.</span>_last<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> data <span class="token keyword">in</span> datas1<span class="token punctuation">:</span>
                    lastret <span class="token operator">+=</span> data<span class="token punctuation">.</span>_last<span class="token punctuation">(</span>datamaster<span class="token operator">=</span>data0<span class="token punctuation">)</span>

                <span class="token keyword">if</span> <span class="token keyword">not</span> lastret<span class="token punctuation">:</span>
                    <span class="token comment"># Only go extra round if something was changed by "lasts"</span>
                    <span class="token keyword">break</span>

            <span class="token comment"># Datas may have generated a new notification after next</span>
            self<span class="token punctuation">.</span>_datanotify<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_event_stop<span class="token punctuation">:</span>  <span class="token comment"># stop if requested</span>
                <span class="token keyword">return</span>

            <span class="token keyword">if</span> d0ret <span class="token keyword">or</span> lastret<span class="token punctuation">:</span>  <span class="token comment"># if any bar, check timers before broker</span>
                self<span class="token punctuation">.</span>_check_timers<span class="token punctuation">(</span>runstrats<span class="token punctuation">,</span> dt0<span class="token punctuation">,</span> cheat<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>cheat_on_open<span class="token punctuation">:</span>
                    <span class="token keyword">for</span> strat <span class="token keyword">in</span> runstrats<span class="token punctuation">:</span>
                        strat<span class="token punctuation">.</span>_next_open<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_event_stop<span class="token punctuation">:</span>  <span class="token comment"># stop if requested</span>
                            <span class="token keyword">return</span>

            self<span class="token punctuation">.</span>_brokernotify<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_event_stop<span class="token punctuation">:</span>  <span class="token comment"># stop if requested</span>
                <span class="token keyword">return</span>

            <span class="token keyword">if</span> d0ret <span class="token keyword">or</span> lastret<span class="token punctuation">:</span>  <span class="token comment"># bars produced by data or filters</span>
                self<span class="token punctuation">.</span>_check_timers<span class="token punctuation">(</span>runstrats<span class="token punctuation">,</span> dt0<span class="token punctuation">,</span> cheat<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> strat <span class="token keyword">in</span> runstrats<span class="token punctuation">:</span>
                    strat<span class="token punctuation">.</span>_next<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_event_stop<span class="token punctuation">:</span>  <span class="token comment"># stop if requested</span>
                        <span class="token keyword">return</span>

                    self<span class="token punctuation">.</span>_next_writers<span class="token punctuation">(</span>runstrats<span class="token punctuation">)</span>

        <span class="token comment"># Last notification chance before stopping</span>
        self<span class="token punctuation">.</span>_datanotify<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_event_stop<span class="token punctuation">:</span>  <span class="token comment"># stop if requested</span>
            <span class="token keyword">return</span>
        self<span class="token punctuation">.</span>_storenotify<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_event_stop<span class="token punctuation">:</span>  <span class="token comment"># stop if requested</span>
            <span class="token keyword">return</span>
</code></pre> 
<p>要点如下：</p> 
<ol><li>首先按照周期大小排序datas，将具有最小周期的data作为data0，其他的放到datas1容器中。</li><li>将resample和replay的数据索引单独保存，做好几个标记。计算clone数据（啥时候clone？加入resample和replay数据的时候都会clone）的个数、非clone数据的个数以及数据总的数量。</li><li>dt0初始化最大值为最大日期（9999年12月31日）的多边格里高利度序数（每一日期对应一个独一无二的数，方便程序处理）。</li><li>如果所有数据是live或者没有新的数据（数据如何更新，后续讲data类的时候再详述），那么就需要等待（newqcheck这一块的处理）。</li><li>识别有没有收到stop消息（从store容器中读取），在等待数据的时候，可能因为失败没有进一步的数据。</li><li>所有的data都会调用do_qcheck（输入等待的时间，至于干啥用的，以后在data类的时候再详述）以及next。</li><li>后面一段确实比较难以理解，其总体思路是寻找主data（dmaster），通常应该是周期最短的数据。然后其他数据以此数据作为基准。（目前理解有限，后续在解读Data相关类的时候针对此场景再补充分析）</li><li>在此过程中，需要调用_brokernotify和_datanotify检测是否有停止信号。</li><li>数据完备（bar成功产生之后），就调用策略的next方法，这样就进入到我们定制策略next中进行处理了。</li></ol> 
<h4><a id="_runonce_1118"></a>_runonce函数代码解读</h4> 
<p>runonce之前专门讲过，其特点是采取矢量模式，直接对数据进行处理，以提高效率。系统缺省采用runonce的方式。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">_runonce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> runstrats<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        Actual implementation of run in vector mode.

        Strategies are still invoked on a pseudo-event mode in which ``next``
        is called for each data arrival
        '''</span>
        <span class="token keyword">for</span> strat <span class="token keyword">in</span> runstrats<span class="token punctuation">:</span>
            strat<span class="token punctuation">.</span>_once<span class="token punctuation">(</span><span class="token punctuation">)</span>
            strat<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># strat called next by next - reset lines</span>

        <span class="token comment"># The default once for strategies does nothing and therefore</span>
        <span class="token comment"># has not moved forward all datas/indicators/observers that</span>
        <span class="token comment"># were homed before calling once, Hence no "need" to do it</span>
        <span class="token comment"># here again, because pointers are at 0</span>
        datas <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>datas<span class="token punctuation">,</span>
                       key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>_timeframe<span class="token punctuation">,</span> x<span class="token punctuation">.</span>_compression<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token comment"># Check next incoming date in the datas</span>
            dts <span class="token operator">=</span> <span class="token punctuation">[</span>d<span class="token punctuation">.</span>advance_peek<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> datas<span class="token punctuation">]</span>
            dt0 <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>dts<span class="token punctuation">)</span>
            <span class="token keyword">if</span> dt0 <span class="token operator">==</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>  <span class="token comment"># no data delivers anything</span>

            <span class="token comment"># Timemaster if needed be</span>
            <span class="token comment"># dmaster = datas[dts.index(dt0)]  # and timemaster</span>
            slen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>runstrats<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> dti <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dts<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> dti <span class="token operator">&lt;=</span> dt0<span class="token punctuation">:</span>
                    datas<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>advance<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token comment"># self._plotfillers2[i].append(slen)  # mark as fill</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token comment"># self._plotfillers[i].append(slen)</span>
                    <span class="token keyword">pass</span>

            self<span class="token punctuation">.</span>_check_timers<span class="token punctuation">(</span>runstrats<span class="token punctuation">,</span> dt0<span class="token punctuation">,</span> cheat<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>cheat_on_open<span class="token punctuation">:</span>
                <span class="token keyword">for</span> strat <span class="token keyword">in</span> runstrats<span class="token punctuation">:</span>
                    strat<span class="token punctuation">.</span>_oncepost_open<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_event_stop<span class="token punctuation">:</span>  <span class="token comment"># stop if requested</span>
                        <span class="token keyword">return</span>

            self<span class="token punctuation">.</span>_brokernotify<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_event_stop<span class="token punctuation">:</span>  <span class="token comment"># stop if requested</span>
                <span class="token keyword">return</span>

            self<span class="token punctuation">.</span>_check_timers<span class="token punctuation">(</span>runstrats<span class="token punctuation">,</span> dt0<span class="token punctuation">,</span> cheat<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

            <span class="token keyword">for</span> strat <span class="token keyword">in</span> runstrats<span class="token punctuation">:</span>
                strat<span class="token punctuation">.</span>_oncepost<span class="token punctuation">(</span>dt0<span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>_event_stop<span class="token punctuation">:</span>  <span class="token comment"># stop if requested</span>
                    <span class="token keyword">return</span>

                self<span class="token punctuation">.</span>_next_writers<span class="token punctuation">(</span>runstrats<span class="token punctuation">)</span>
</code></pre> 
<p>要点如下：</p> 
<ol><li>开始三行代码是关键，针对每个strategy，运行_once方法并进行reset。实际上就是将数据索引指向0.</li><li>仍然将数据按照周期（timeframe）大小排序。</li><li>调用advance_peek看下一个时间（索引为1，还记得索引为1的含义？），最近时间记为dt0.</li><li>对于最近时间的的data调用advance（嗯，又是数据的处理，后面再具体讲吧）</li><li>如果设置了cheat_on_open，那么在策略的next之前调用next_open方法。</li><li>检测是否收到broker的stop消息。</li><li>下面开始调用策略的、_oncepost方法，这个方法中会调用到strategy的next方法，怎么玩的？必须要到数据类中探索了。</li></ol> 
<p>总的来看，Cerebro的run过程，实际上按照时间驱动数据不断运行，在此过程中协调其他部件协同工作。</p> 
<h3><a id="_1193"></a>画图</h3> 
<p>最后可以调用plot方法进行可视化输出：</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">plot</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> plotter<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> numfigs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> iplot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
             width<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> dpi<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> tight<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> use<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
             <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        Plots the strategies inside cerebro

        If ``plotter`` is None a default ``Plot`` instance is created and
        ``kwargs`` are passed to it during instantiation.

        ``numfigs`` split the plot in the indicated number of charts reducing
        chart density if wished

        ``iplot``: if ``True`` and running in a ``notebook`` the charts will be
        displayed inline

        ``use``: set it to the name of the desired matplotlib backend. It will
        take precedence over ``iplot``

        ``start``: An index to the datetime line array of the strategy or a
        ``datetime.date``, ``datetime.datetime`` instance indicating the start
        of the plot

        ``end``: An index to the datetime line array of the strategy or a
        ``datetime.date``, ``datetime.datetime`` instance indicating the end
        of the plot

        ``width``: in inches of the saved figure

        ``height``: in inches of the saved figure

        ``dpi``: quality in dots per inches of the saved figure

        ``tight``: only save actual content and not the frame of the figure
        '''</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_exactbars <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> plotter<span class="token punctuation">:</span>
            <span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> plot
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>oldsync<span class="token punctuation">:</span>
                plotter <span class="token operator">=</span> plot<span class="token punctuation">.</span>Plot_OldSync<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                plotter <span class="token operator">=</span> plot<span class="token punctuation">.</span>Plot<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

        <span class="token comment"># pfillers = {self.datas[i]: self._plotfillers[i]</span>
        <span class="token comment"># for i, x in enumerate(self._plotfillers)}</span>

        <span class="token comment"># pfillers2 = {self.datas[i]: self._plotfillers2[i]</span>
        <span class="token comment"># for i, x in enumerate(self._plotfillers2)}</span>

        figs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> stratlist <span class="token keyword">in</span> self<span class="token punctuation">.</span>runstrats<span class="token punctuation">:</span>
            <span class="token keyword">for</span> si<span class="token punctuation">,</span> strat <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>stratlist<span class="token punctuation">)</span><span class="token punctuation">:</span>
                rfig <span class="token operator">=</span> plotter<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>strat<span class="token punctuation">,</span> figid<span class="token operator">=</span>si <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span>
                                    numfigs<span class="token operator">=</span>numfigs<span class="token punctuation">,</span> iplot<span class="token operator">=</span>iplot<span class="token punctuation">,</span>
                                    start<span class="token operator">=</span>start<span class="token punctuation">,</span> end<span class="token operator">=</span>end<span class="token punctuation">,</span> use<span class="token operator">=</span>use<span class="token punctuation">)</span>
                <span class="token comment"># pfillers=pfillers2)</span>

                figs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rfig<span class="token punctuation">)</span>

            plotter<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> figs
</code></pre> 
<p>这个过程比较简单，就是引入plotter模块，针对每一个运行的strategy画图。贴字段代码的目的，就是告诉大家，Cerebro没干啥，都是驱动别人干活。</p> 
<h2><a id="_1267"></a>总结</h2> 
<p>Cerebro解读完了，读完好像还是一头雾水，没看懂系统到底咋玩的啊！这就对了，因为Cerebor就没干啥，我们需要深入了解Cerebro驱动的部件是如何工作的，反过来你就会理解Cerebor。</p> 
<p>关于这个文档的顺序，本来我想从底层部件代码解读，但是想到没有一个整体的框架，看部件的代码也很难理解。所以先从Cerebro开始，从整体上看Backtrader是怎么运行的，再看看每一个部件工作机制以及如何在整个系统中起作用，最后在整体上完全掌握。所以，现在看的不太明白也没啥，只要知道Cerebro的运行顺序，以及在哪里用到什么部件就行了。</p> 
<p>下一篇文章我们开始解读data相关类，看看数据是如何保存以及如何驱动的。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/809b6774c12cac3f4ea9e8b1c13e9edb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">docker的四种单主机网络模式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8934088fa8767b3aff12e47282a9c151/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Git基本操作（3）- git add详细举例</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>