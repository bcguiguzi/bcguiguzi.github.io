<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>最简k8s部署（AWS Load Balancer Controller使用） - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="最简k8s部署（AWS Load Balancer Controller使用）" />
<meta property="og:description" content="问题 我需要在k8s集群里面部署springboot服务，通过k8s ingress访问集群内部的springboot服务，应该怎么做？
这里假设已经准备好k8s集群，而且也准备好springboot服务的运行镜像了。这里我们将精力放在k8s服务编排上面。
一图胜千言 上图来自于kubernetes的ingress教程。接下来，我们按照上述部署1个ingress&#43;2个服务。
service1 先用kubectl命令创建一个deployment.yaml和service.yaml，然后，将这两个内容合并到一个文件中，即service1.yaml。具体命令如下：
创建deployment.yaml：
kubectl create deployment service1 --image xxx.dkr.ecr.us-east-1.amazonaws.com/service1:latest -o yaml --dry-run=client &gt; k8s/deployment.yaml 创建service.yaml：
kubectl create service clusterip service1 --tcp 8080:8080 -o yaml --dry-run=client &gt; k8s/service.yaml 根据自己需求，去掉一下不要的内容，调整相关配置，合并成如下内容：
service1.yaml apiVersion: apps/v1 kind: Deployment metadata: labels: app: service1 name: service1 spec: replicas: 2 selector: matchLabels: app: service1 template: metadata: labels: app: service1 spec: containers: - image: xxxxxxxxxxxx.dkr.ecr.us-east-1.amazonaws.com/service1:latest name: service1 resources: requests: memory: &#34;2Gi&#34; cpu: &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/0b6382830ff2e4ef424efe2106fd84bd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-08T17:09:39+08:00" />
<meta property="article:modified_time" content="2024-03-08T17:09:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">最简k8s部署（AWS Load Balancer Controller使用）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>问题</h2> 
<p>我需要在k8s集群里面部署springboot服务，通过k8s ingress访问集群内部的springboot服务，应该怎么做？<br> 这里假设已经准备好k8s集群，而且也准备好springboot服务的运行镜像了。这里我们将精力放在k8s服务编排上面。</p> 
<h2><a id="_3"></a>一图胜千言</h2> 
<p><img src="https://images2.imgbox.com/20/49/CqT8HGNV_o.png" alt="ingress最简扇出模式"><br> 上图来自于kubernetes的ingress教程。接下来，我们按照上述部署1个ingress+2个服务。</p> 
<h2><a id="service1_6"></a>service1</h2> 
<p>先用kubectl命令创建一个deployment.yaml和service.yaml，然后，将这两个内容合并到一个文件中，即<code>service1.yaml</code>。具体命令如下：<br> 创建deployment.yaml：</p> 
<pre><code class="prism language-bash">kubectl create deployment service1 <span class="token parameter variable">--image</span> xxx.dkr.ecr.us-east-1.amazonaws.com/service1:latest <span class="token parameter variable">-o</span> yaml --dry-run<span class="token operator">=</span>client <span class="token operator">&gt;</span> k8s/deployment.yaml 
</code></pre> 
<p>创建service.yaml：</p> 
<pre><code class="prism language-bash"> kubectl create <span class="token function">service</span> clusterip service1 <span class="token parameter variable">--tcp</span> <span class="token number">8080</span>:8080 <span class="token parameter variable">-o</span> yaml --dry-run<span class="token operator">=</span>client <span class="token operator">&gt;</span> k8s/service.yaml 
</code></pre> 
<p>根据自己需求，去掉一下不要的内容，调整相关配置，合并成如下内容：</p> 
<h3><a id="service1yaml_17"></a>service1.yaml</h3> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> service1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> service1
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> service1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> xxxxxxxxxxxx.dkr.ecr.us<span class="token punctuation">-</span>east<span class="token punctuation">-</span>1.amazonaws.com/service1<span class="token punctuation">:</span>latest
          <span class="token key atrule">name</span><span class="token punctuation">:</span> service1
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"2Gi"</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"2Gi"</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
          <span class="token comment"># 准备检查，通过则接入流量</span>
          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /foo/actuator/health
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
          <span class="token comment"># 活力检查，不通过时重启容器</span>
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /foo/actuator/health
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> service1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">4200</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">4200</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> service1
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP

</code></pre> 
<h2><a id="service2_72"></a>service2</h2> 
<p>按之前service1方式，获得如下内容：</p> 
<h3><a id="service2yaml_74"></a>service2.yaml</h3> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> service2
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> service2
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> service2
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> xxxxxxxxxxxx.dkr.ecr.us<span class="token punctuation">-</span>east<span class="token punctuation">-</span>1.amazonaws.com/service2<span class="token punctuation">:</span>latest
          <span class="token key atrule">name</span><span class="token punctuation">:</span> service2
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"2Gi"</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"2Gi"</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
          <span class="token comment"># 准备检查，通过则接入流量</span>
          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /bar/actuator/health
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
          <span class="token comment"># 活力检查，不通过时重启容器</span>
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /bar/actuator/health
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> service2
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> service2
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP

</code></pre> 
<h2><a id="ingress_129"></a>ingress</h2> 
<p>使用kubectl命令获得ingress基本配置，如下命令：</p> 
<pre><code class="prism language-bash">kubectl create ingress ingress <span class="token parameter variable">--rule</span><span class="token operator">=</span><span class="token string">"/path=service1:8080"</span> <span class="token parameter variable">-o</span> yaml --dry-run<span class="token operator">=</span>client <span class="token operator">&gt;</span> k8s/ingress.yaml
</code></pre> 
<p>根据自己的需求调整后的内容如下：</p> 
<h3><a id="ingressyaml_135"></a>ingress.yaml</h3> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> service1
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">4200</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /foo
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> service2
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8080</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /bar
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
</code></pre> 
<p>这里有个问题，由于我现在使用的aws云，所以，这k8s ingress在aws云环境下面，需要针对这种情况调整aws云相关配置。</p> 
<h4><a id="AWS_EKSAWS_Load_Balancer_Controller_161"></a>AWS EKS配置AWS Load Balancer Controller</h4> 
<h5><a id="_IAM_OIDC__162"></a>为集群创建 IAM OIDC 提供商</h5> 
<p>找到现有集群的OpenID Connect 提供商 URL值，点击copy，如下图：<br> <img src="https://images2.imgbox.com/25/71/pGVbgDbL_o.png" alt="复制集群的OpenID"><br> 然后，回到IAM主页，为集群创建 IAM OIDC 提供商，具体如下：<br> <img src="https://images2.imgbox.com/ce/d2/BmXv7rvS_o.png" alt="添加提供商"><br> 创建提供商如下图：<br> <img src="https://images2.imgbox.com/47/95/TaL6GdXB_o.png" alt="创建身份提供商"></p> 
<h5><a id="AWS_Load_Balancer_Controller_EKS_169"></a>AWS Load Balancer Controller 部署到EKS</h5> 
<h6><a id="AWSLoadBalancerControllerIAMPolicy_170"></a>创建AWSLoadBalancerControllerIAMPolicy策略</h6> 
<p>我这里用到aws云区是普通云区，所以，这里使用的aws-load-balancer-controller的策略脚本如下：<br> <code>https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json</code><br> 下载命令如下：</p> 
<pre><code class="prism language-bash"><span class="token function">curl</span> <span class="token parameter variable">-o</span> iam-policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json
</code></pre> 
<p>新建一个策略：</p> 
<pre><code class="prism language-bash">aws iam create-policy <span class="token punctuation">\</span>
    --policy-name AWSLoadBalancerControllerIAMPolicy <span class="token punctuation">\</span>
    --policy-document file://iam-policy.json
</code></pre> 
<h6><a id="ServiceAccountk8s_183"></a>创建一个ServiceAccount给k8s</h6> 
<pre><code class="prism language-bash">eksctl create iamserviceaccount <span class="token punctuation">\</span>
<span class="token parameter variable">--cluster</span><span class="token operator">=</span><span class="token operator">&lt;</span>cluster-name<span class="token operator">&gt;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--namespace</span><span class="token operator">=</span>kube-system <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span><span class="token operator">=</span>aws-load-balancer-controller <span class="token punctuation">\</span>
--attach-policy-arn<span class="token operator">=</span>arn:aws:iam::<span class="token operator">&lt;</span>AWS_ACCOUNT_ID<span class="token operator">&gt;</span>:policy/AWSLoadBalancerControllerIAMPolicy <span class="token punctuation">\</span>
--override-existing-serviceaccounts <span class="token punctuation">\</span>
<span class="token parameter variable">--region</span> <span class="token operator">&lt;</span>region-code<span class="token operator">&gt;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--approve</span>
</code></pre> 
<p>这里用到<code>eksctl</code>命令，给k8s集群创建一个ServiceAccount服务账号<code>aws-load-balancer-controller</code>，并使用上面之前创建的权限策略。怎么安装<code>eksctl</code>命令，可以看看官网，这里就不提了。</p> 
<h6><a id="helmawsloadbalancercontroller_195"></a>helm安装aws-load-balancer-controller</h6> 
<p>这里假设我们已经会使用k8s集群的包管理器helm了。<br> 添加EKS资源库到helm，如下命令：</p> 
<pre><code class="prism language-bash">helm repo <span class="token function">add</span> eks https://aws.github.io/eks-charts
</code></pre> 
<p>更新本地资源库，如下命令：</p> 
<pre><code class="prism language-bash">helm repo update eks
</code></pre> 
<p>安装aws-load-balancer-controller，如下命令：</p> 
<pre><code class="prism language-bash">helm <span class="token function">install</span> aws-load-balancer-controller eks/aws-load-balancer-controller <span class="token parameter variable">--set</span> <span class="token assign-left variable">clusterName</span><span class="token operator">=</span>my-cluster <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">--set</span> <span class="token assign-left variable">serviceAccount.create</span><span class="token operator">=</span>false <span class="token parameter variable">--set</span> <span class="token assign-left variable">serviceAccount.name</span><span class="token operator">=</span>aws-load-balancer-controller
</code></pre> 
<p>等待一段时间出现，如下反馈，说明aws-load-balancer-controller安装成功：</p> 
<pre><code class="prism language-bash">NAME: aws-load-balancer-controller
LAST DEPLOYED: Thu Mar  <span class="token number">7</span> <span class="token number">15</span>:11:01 <span class="token number">2024</span>
NAMESPACE: kube-system
STATUS: deployed
REVISION: <span class="token number">1</span>
TEST SUITE: None
NOTES:
AWS Load Balancer controller installed<span class="token operator">!</span>
</code></pre> 
<p>如果出现，如下错误：<br> <code>Error: INSTALLATION FAILED: cannot re-use a name that is still in use</code><br> 说明，需要先卸载，再安装，具体命令如下：</p> 
<pre><code class="prism language-bash">helm delete aws-load-balancer-controller <span class="token parameter variable">-n</span> kube-system
</code></pre> 
<p>检查k8s集群中aws-load-balancer-controller是否安装成功，具体命令如下：</p> 
<pre><code class="prism language-bash">kubectl get deployment <span class="token parameter variable">-n</span> kube-system aws-load-balancer-controller
</code></pre> 
<p>安装成功示例，如下：</p> 
<pre><code class="prism language-bash">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
aws-load-balancer-controller   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           10m
</code></pre> 
<h4><a id="ingress_235"></a>调整ingress配置</h4> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
  	<span class="token comment"># alb名称</span>
  	<span class="token key atrule">alb.ingress.kubernetes.io/load-balancer-name</span><span class="token punctuation">:</span> apg2
  	<span class="token comment"># 内网</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/scheme</span><span class="token punctuation">:</span> internal
    <span class="token comment"># 流量路由到pod层面</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/target-type</span><span class="token punctuation">:</span> ip
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 使用alb作为ingress默认类</span>
  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> alb
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> service1
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">4200</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /foo
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> service2
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8080</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /bar
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
</code></pre> 
<h4><a id="service_269"></a>调整service配置</h4> 
<p>除了再ingress里面添加lbc注解之外，还需要再service中添加健康检查的lbc注解：</p> 
<pre><code class="prism language-bash">  annotations:
    alb.ingress.kubernetes.io/healthcheck-path: /api/demo/actuator/health
</code></pre> 
<h5><a id="service1yaml_275"></a>service1.yaml</h5> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> service1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> service1
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> service1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> xxxxxxxxxxxx.dkr.ecr.us<span class="token punctuation">-</span>east<span class="token punctuation">-</span>1.amazonaws.com/service1<span class="token punctuation">:</span>latest
          <span class="token key atrule">name</span><span class="token punctuation">:</span> service1
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"2Gi"</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"2Gi"</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
          <span class="token comment"># 准备检查，通过则接入流量</span>
          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /foo/actuator/health
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
          <span class="token comment"># 活力检查，不通过时重启容器</span>
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /foo/actuator/health
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> service1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service1
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
  	<span class="token comment"># aws目标组健康检查</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/healthcheck-path</span><span class="token punctuation">:</span> /for/actuator/health
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">4200</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">4200</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> service1
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP

</code></pre> 
<h5><a id="service2yaml_333"></a>service2.yaml</h5> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> service2
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> service2
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> service2
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> xxxxxxxxxxxx.dkr.ecr.us<span class="token punctuation">-</span>east<span class="token punctuation">-</span>1.amazonaws.com/service2<span class="token punctuation">:</span>latest
          <span class="token key atrule">name</span><span class="token punctuation">:</span> service2
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"2Gi"</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"2Gi"</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
          <span class="token comment"># 准备检查，通过则接入流量</span>
          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /bar/actuator/health
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
          <span class="token comment"># 活力检查，不通过时重启容器</span>
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /bar/actuator/health
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> service2
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service2
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
  	<span class="token comment"># aws目标组健康检查</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/healthcheck-path</span><span class="token punctuation">:</span> /bar/actuator/health
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> service2
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP

</code></pre> 
<h2><a id="_391"></a>部署</h2> 
<pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> ./k8s
</code></pre> 
<p>清除资源：</p> 
<pre><code class="prism language-bash">kubectl delete <span class="token parameter variable">-f</span> ./k8s
</code></pre> 
<h2><a id="_399"></a>总结</h2> 
<p>AWS Load Balancer Controller没有重写路径功能，注意安全。这里只介绍的主要是EKS创建ALB在私有VPC内部访问。这里没有介绍CDN套在API接口外面的情况，一般来说，预算足够的情况下面，都会在API接口外面套一层CDN服务。需要注意的是AWS CloudFront（CDN服务）只支持公网的LB。不知道什么原因维护AWS Load Balancer Controller（LBC）团队的人，死活不肯提供重写路径功能。这里还没有服务监控，有机会再介绍介绍吧！<br> 下面是公有ingress创建ALB的配置：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
  	<span class="token comment"># alb名称</span>
  	<span class="token key atrule">alb.ingress.kubernetes.io/load-balancer-name</span><span class="token punctuation">:</span> apg2
  	<span class="token comment"># 只让cdn（CloudFront）访问负载均衡器</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/security-groups</span><span class="token punctuation">:</span> cloudfront<span class="token punctuation">-</span>only
    <span class="token comment"># pod和node安全组自动生成</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/manage-backend-security-group-rules</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
  	<span class="token comment"># 公网</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/scheme</span><span class="token punctuation">:</span> internet<span class="token punctuation">-</span>facing
    <span class="token comment"># 流量路由到pod层面</span>
    <span class="token key atrule">alb.ingress.kubernetes.io/target-type</span><span class="token punctuation">:</span> ip
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 使用alb作为ingress默认类</span>
  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> alb
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> service1
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">4200</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /foo
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> service2
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8080</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /bar
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
</code></pre> 
<p>就这样吧，ingress用http端口，然后限制只有cdn节点才能访问，这样公网alb就相对安全了一些。加上前面有cdn的话，基本上没人知道真实的alb地址。</p> 
<h2><a id="_441"></a>参考：</h2> 
<ul><li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="nofollow">Ingress</a></li><li><a href="https://aws.amazon.com/cn/blogs/containers/deploy-a-spring-boot-application-on-a-multi-architecture-amazon-eks-cluster/" rel="nofollow">Deploy a Spring Boot application on a multi-architecture Amazon EKS cluster</a></li><li><a href="https://spring.io/guides/topicals/spring-on-kubernetes" rel="nofollow">Spring on Kubernetes</a></li><li><a href="https://spring.io/guides/gs/spring-boot-kubernetes" rel="nofollow">Spring Boot Kubernetes</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/alb-ingress.html" rel="nofollow">Amazon EKS 上的应用程序负载均衡</a></li><li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.7/deploy/installation/" rel="nofollow">安装AWS Load Balancer Controller</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/aws-load-balancer-controller.html" rel="nofollow">安装 AWS Load Balancer Controller 附加组件</a></li><li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.7/deploy/security_groups/" rel="nofollow">Security Groups for Load Balancers</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8658ac800d04e92153d1f272815e4b0f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ubuntu設定QGC獲取pixhawk Mini4(PX4 Mini 4) 的imu信息</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d1fbe73d12bcb76ab7f622d8e9456fcf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">安卓 修改系统时间</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>