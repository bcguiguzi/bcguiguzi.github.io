<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>初识Umi.JS - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="初识Umi.JS" />
<meta property="og:description" content="什么是Umi.js? Umi，中文可发音为乌米，是可扩展的企业级前端应用框架。Umi 以路由为基础的，同时支持配置式路由和约定式路由，保证路由的功能完备，并以此进行功能扩展。然后配以生命周期完善的插件体系，覆盖从源码到构建产物的每个生命周期，支持各种功能扩展和业务需求。
为什么使用Umi.js? 我们做react开发的时候会不会遇到以下问题？：
1.项目做大的时候，开发调试的启动和热更新时间会变得很长。
2.大应用下，网站打开很慢，有没有办法基于路由做到按需加载。
3.dva的model每次都要手写载入，能否一开始就同项目初始化好？
使用乌米，即可解决以上问题，并且还能提供如下优势：
🎉开箱即用，内置 react、react-router 等📦类 next.js 且功能完备的路由约定，同时支持配置的路由方式🐠完善的插件体系，覆盖从源码到构建产物的每个生命周期🚀 一键兼容到 IE9🍉完善的 TypeScript 支持🍗与 dva 数据流的深入融合 umi 有 2 和 3 两个版本。两个版本的使用都差不多。umi2 对 javascript 支持比较好，umi3 默认支持 typeScript
起步Umi node环境安装 建议安装最新的稳定版本，笔者这里为 14.15.3。同时建议使用 yarn
Umi快速上手 创建空目录 umi-learn
# 新建应用 $ mkdir umi-learn &amp;&amp; cd umi-learn # 使用命令 $ yarn create umi # 安装依赖 $ yarn install 安装过程选择 app
项目工程结构 mock // mock文件 src |-- assets // 静态资源文件 |-- layouts // 全局布局文件 |-- pages // 项目页面文件 |-- globals // 全局样式 |--." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/8bd45773804600e29fa829ae9163c3ea/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-26T14:08:00+08:00" />
<meta property="article:modified_time" content="2021-01-26T14:08:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">初识Umi.JS</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/53/be/VcvQ7OfJ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Umijs_2"></a>什么是Umi.js?</h4> 
<p>Umi，中文可发音为<strong>乌米</strong>，是可扩展的企业级前端应用框架。Umi 以路由为基础的，同时支持配置式路由和约定式路由，保证路由的功能完备，并以此进行功能扩展。然后配以生命周期完善的插件体系，覆盖从源码到构建产物的每个生命周期，支持各种功能扩展和业务需求。</p> 
<h4><a id="Umijs_6"></a>为什么使用Umi.js?</h4> 
<p>我们做react开发的时候会不会遇到以下问题？：<br> 1.项目做大的时候，开发调试的启动和热更新时间会变得很长。<br> 2.大应用下，网站打开很慢，有没有办法基于路由做到按需加载。<br> 3.dva的model每次都要手写载入，能否一开始就同项目初始化好？</p> 
<p>使用乌米，即可解决以上问题，并且还能提供如下优势：</p> 
<ul><li>🎉开箱即用，内置 react、react-router 等</li><li>📦类 next.js 且功能完备的路由约定，同时支持配置的路由方式</li><li>🐠完善的插件体系，覆盖从源码到构建产物的每个生命周期</li><li>🚀 一键兼容到 IE9</li><li>🍉完善的 TypeScript 支持</li><li>🍗与 dva 数据流的深入融合</li></ul> 
<hr> 
<p>umi 有 2 和 3 两个版本。两个版本的使用都差不多。umi2 对 javascript 支持比较好，umi3 默认支持 typeScript</p> 
<h3><a id="Umi_24"></a>起步Umi</h3> 
<h4><a id="node_26"></a>node环境安装</h4> 
<p>建议安装最新的稳定版本，笔者这里为 14.15.3。同时建议使用 yarn</p> 
<h4><a id="Umi_30"></a>Umi快速上手</h4> 
<p>创建空目录 umi-learn</p> 
<pre><code class="prism language-bash"><span class="token comment"># 新建应用</span>
$ <span class="token function">mkdir</span> umi-learn <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> umi-learn

<span class="token comment"># 使用命令</span>
$ <span class="token function">yarn</span> create umi

<span class="token comment"># 安装依赖</span>
$ <span class="token function">yarn</span> <span class="token function">install</span>
</code></pre> 
<p>安装过程选择 app</p> 
<p><img src="https://images2.imgbox.com/99/08/cZfZIAk8_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/8a/53/ckNyM0iq_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_52"></a>项目工程结构</h4> 
<pre><code class="prism language-csharp">mock                    <span class="token comment">// mock文件</span>
src
  <span class="token operator">|</span><span class="token operator">--</span> assets        	<span class="token comment">// 静态资源文件</span>
  <span class="token operator">|</span><span class="token operator">--</span> layouts           <span class="token comment">// 全局布局文件</span>
  <span class="token operator">|</span><span class="token operator">--</span> pages           	<span class="token comment">// 项目页面文件</span>
  <span class="token operator">|</span><span class="token operator">--</span> globals           <span class="token comment">// 全局样式</span>
  <span class="token operator">|</span><span class="token operator">--</span><span class="token punctuation">.</span>eslintignore     <span class="token comment">// eslint过滤文件清单</span>
  <span class="token operator">|</span><span class="token operator">--</span><span class="token punctuation">.</span>eslintrc<span class="token punctuation">.</span>js      <span class="token comment">// eslint配置</span>
  <span class="token operator">|</span><span class="token operator">--</span><span class="token punctuation">.</span>eslintignore     <span class="token comment">// eslint过滤文件清单</span>
  <span class="token operator">|</span><span class="token operator">--</span><span class="token punctuation">.</span>eslintignore     <span class="token comment">// eslint过滤文件清单</span>
  <span class="token operator">|</span><span class="token operator">--</span><span class="token punctuation">.</span>umirc<span class="token punctuation">.</span>js 		   <span class="token comment">// umi 配置文件</span>

</code></pre> 
<h4><a id="_69"></a>约定式路由</h4> 
<blockquote> 
 <p>启动 umi start 后，大家会发现 pages 下多了个 .umi 的目录。不要直接在这里修改代码，umi 重启或者 pages 下的文件修改都会重新生成这个文件夹下的文件，约定 pages 下所有的 (j|t)sx? 文件即路由</p> 
</blockquote> 
<h4><a id="_73"></a>动态生成路由</h4> 
<pre><code class="prism language-crystal">npx umi g page demo
</code></pre> 
<blockquote> 
 <p>page 目录下生成 demo.js 和 demo.css。.umirc.js 会自动生成相对应的路由，访问 /demo 路由。即可看到页面</p> 
</blockquote> 
<pre><code class="prism language-crystal">npx umi g page class/index
</code></pre> 
<blockquote> 
 <p>page 目录下生成 class 文件夹 / index.js 和 index.css。.umirc.js 会自动生成相对应的路由，访问 /class/index 路由。即可看到页面</p> 
</blockquote> 
<blockquote> 
 <p>手动生成的文件，.umirc.js 文件中不会生成相对应的路由</p> 
</blockquote> 
<h4><a id="_89"></a>获取路由中的参数</h4> 
<p>该文件必须以 $ 开头命名，这时 .umi 文件夹下的 router.js 文件会生成对应的路由</p> 
<h4><a id="umi2__umi3_93"></a>umi2 --&gt; umi3</h4> 
<pre><code class="prism language-bash">$ <span class="token function">yarn</span> create @umijs/umi-app
$ <span class="token function">yarn</span> <span class="token function">install</span>
</code></pre> 
<h4><a id="dva_102"></a>使用dva</h4> 
<p>在 umi 项目中，你可以使用 dva 来处理数据流，以响应一些复杂的交互操作。<br> 在 umi2 中要使用 dva 的功能很简单，只要使用 umi-plugin-react 插件并配置 dva:true 即可。<br> 修改配置的文件：./umirc.js</p> 
<pre><code class="prism language-js"><span class="token comment">// ref: https://umijs.org/config/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// ref: https://umijs.org/plugin/umi-plugin-react.html</span>
    <span class="token punctuation">[</span><span class="token string">'umi-plugin-react'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      antd<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      dva<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 在此处启用 dva</span>
      dynamicImport<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      title<span class="token operator">:</span> <span class="token string">'hero'</span><span class="token punctuation">,</span>
      dll<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      routes<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        exclude<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      hardSource<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在dva中，处理数据流的文件统一放在 models 文件夹下，每一个文件默认导出一个对象，里面包含数据和处理数据的方法，通常我们称之为 model 。如以下count.js，model结构一般是如此：</p> 
<h6><a id="srcmodelscountjs_130"></a>./src/models/count.js</h6> 
<pre><code class="prism language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span>
  namespace<span class="token operator">:</span> <span class="token string">'count'</span><span class="token punctuation">,</span> <span class="token comment">// 默认与文件名相同</span>
  state<span class="token operator">:</span> <span class="token string">'count'</span><span class="token punctuation">,</span>
  subscriptions<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{<!-- --></span> dispatch<span class="token punctuation">,</span> history <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 同步</span>
  reducers<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_count</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 异步</span>
  effects<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">*</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{<!-- --></span> payload <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> call<span class="token punctuation">,</span> put <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            type<span class="token operator">:</span> <span class="token string">'update'</span><span class="token punctuation">,</span>
            payload
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="model_158"></a>在项目页面中使用model</h4> 
<p>我们需要导入connect将页面和model绑定在一起。</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'dva'</span><span class="token punctuation">;</span>  
<span class="token keyword">function</span> <span class="token function">CountPage</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
 <span class="token comment">//从props属性中打印namespace为count的model的state数据       </span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>      
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>styles<span class="token punctuation">.</span>normal<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>数量大小<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>This is <span class="token punctuation">{<!-- --></span>props<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{<!-- --></span> count <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> count <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>CountPage<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre> 
<p>如果使用es7的装饰器，我们可以改成这样的写法：</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'dva'</span><span class="token punctuation">;</span> 
<span class="token comment">// 装饰器 </span>
@<span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{<!-- --></span> count <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> count <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">CountPage</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
 <span class="token comment">// 从 props 属性中打印 namespace 为 count 的 model 的 state 数据       </span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>      
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>styles<span class="token punctuation">.</span>normal<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>数量大小<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>This is <span class="token punctuation">{<!-- --></span>props<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> CountPage<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="mock__196"></a>mock 文件夹</h4> 
<blockquote> 
 <p>一般的文件格式如下，umi 的 mock 是对 express 的封装</p> 
</blockquote> 
<pre><code class="prism language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'GET /api/getLists'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        lists<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'GET /api/getListsAsync'</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            lists<span class="token operator">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> query<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre> 
<h4><a id="src__services__214"></a>src / services 文件夹</h4> 
<blockquote> 
 <p>请求有关的处理文件</p> 
</blockquote> 
<pre><code class="prism language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getLists</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api/getLists?value='</span> <span class="token operator">+</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    	<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<p>上述内容其实在真实的项目开发当中所用不多，使用 umi 框架开发项目的方式，与 react 几乎无异。既然如何那为何要学？识万卷书，行万里路。见得东西越多，越能明白自己的不足之处。</p> 
<p>下面是笔者开发项目架构，各位可以做个参考</p> 
<p><img src="https://images2.imgbox.com/27/b5/DsOHhU6L_o.png" alt="在这里插入图片描述"><br> 源代码存放在 gitee 中</p> 
<p>================================================================</p> 
<p>来更新啦啦啦啦啦</p> 
<p>================================================================</p> 
<p>可以自定义 CLI，以后使用起来更加方便快捷。</p> 
<p>啊，生活已经很累了，为啥你还要折磨我<br> <img src="https://images2.imgbox.com/d2/32/1BBh1eY1_o.gif" alt="在这里插入图片描述"><br> 我重复造轮子不就行了吗？（骂骂咧咧中～～～～～）啊，那随你吧<br> <img src="https://images2.imgbox.com/6d/88/R6u7zWzj_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>PS：<br> 1. <code>npm link</code> 或者 <code>npm</code> 其他情况下如果报错，请使用管理员权限，加个 <code>sudo</code><br> 2. 请在 <code>github</code> 上创建一个组织，加入进去，在组织中放入自己的代码（不要问为啥，问就是我不想继续探索了，我饿了，找了一个最简单的办法写完，我想去吃饭）</p> 
</blockquote> 
<p>如何在 github 上创建组织</p> 
<blockquote> 
 <p>PS：github 容易抽风</p> 
</blockquote> 
<p>需要实现哪些基本功能：</p> 
<ul><li>通过 <code>sumi create &lt;name&gt;</code> 命令启动项目</li><li>询问用户需要下载的模板</li><li>远程拉取模板</li></ul> 
<h4><a id="1__271"></a>1. 创建项目</h4> 
<p>目录结构</p> 
<pre><code class="prism language-css">s-umi-cli           
├─ bin                
│  └─ cli.js  # 启动文件      
├─ README.md          
└─ package.json       
</code></pre> 
<p>配置脚手架启动文件</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"s-umi-cli"</span><span class="token punctuation">,</span>
  <span class="token string">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
  <span class="token string">"description"</span><span class="token operator">:</span> <span class="token string">"umi cli"</span><span class="token punctuation">,</span>
  <span class="token string">"main"</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
  <span class="token string">"bin"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"sumi"</span><span class="token operator">:</span> <span class="token string">"./bin/cli.js"</span> <span class="token comment">// 配置启动文件路径，sumi 为别名</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"test"</span><span class="token operator">:</span> <span class="token string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"author"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"license"</span><span class="token operator">:</span> <span class="token string">"MIT"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>cli.js</p> 
<pre><code class="prism language-javascript">#<span class="token operator">!</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'~~~~~~~'</span><span class="token punctuation">)</span>
</code></pre> 
<p>为了方便开发调试，使用 npm link 链接到全局</p> 
<pre><code class="prism language-bash"><span class="token function">npm</span> <span class="token function">link</span>
</code></pre> 
<blockquote> 
 <p>如果报错，请加上 sudo</p> 
</blockquote> 
<p>终端输入</p> 
<pre><code class="prism language-bash">sumi
</code></pre> 
<p>就可以看见 <code>console.log</code> 中的内容</p> 
<h4><a id="2__325"></a>2. 创建脚手架启动命令</h4> 
<p>借助 commander 依赖去实现这个需求</p> 
<h5><a id="21__330"></a>2.1 安装依赖</h5> 
<pre><code class="prism language-bash"><span class="token function">npm</span> <span class="token function">install</span> commander --save
</code></pre> 
<h5><a id="22__336"></a>2.2 创建命令</h5> 
<p>cli.js</p> 
<pre><code class="prism language-javascript">#<span class="token operator">!</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node

<span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'commander'</span><span class="token punctuation">)</span>

program
  <span class="token comment">// 定义命令和参数</span>
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'create &lt;app-name&gt;'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">'create a new project'</span><span class="token punctuation">)</span>
  <span class="token comment">// -f or --force 为强制创建，如果创建的目录存在则直接覆盖</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-f, --force'</span><span class="token punctuation">,</span> <span class="token string">'overwrite target directory if it exist'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 打印执行结果</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'name:'</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token string">'options:'</span><span class="token punctuation">,</span>options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
program
   <span class="token comment">// 配置版本号信息</span>
  <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">v</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">usage</span><span class="token punctuation">(</span><span class="token string">'&lt;command&gt; [option]'</span><span class="token punctuation">)</span>
  
<span class="token comment">// 解析用户执行命令传入参数</span>
program<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>中端输入 sumi</p> 
<pre><code class="prism language-bash">sumi
</code></pre> 
<pre><code class="prism language-bash">Usage: sumi <span class="token operator">&lt;</span>command<span class="token operator">&gt;</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span>

Options:
  -V, --version                output the version number
  -h, --help                   display <span class="token builtin class-name">help</span> <span class="token keyword">for</span> <span class="token builtin class-name">command</span>

Commands:
  create <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token operator">&lt;</span>app-name<span class="token operator">&gt;</span>  create a new project
  <span class="token builtin class-name">help</span> <span class="token punctuation">[</span>command<span class="token punctuation">]</span>               display <span class="token builtin class-name">help</span> <span class="token keyword">for</span> <span class="token builtin class-name">command</span>
</code></pre> 
<p>我们可以看到 <code>Commands</code> 下面已经有了 <code>create [options] &lt;app-name&gt;</code>，接着执行一下这个命令</p> 
<pre><code class="prism language-bash">sumi create
error: missing required argument <span class="token string">'app-name'</span>

sumi create my-project
执行结果 <span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> name: my-project options: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

sumi create my-project -f
执行结果 <span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> name: my-project options: <span class="token punctuation">{<!-- --></span> force: <span class="token boolean">true</span> <span class="token punctuation">}</span>

sumi create my-project --force
执行结果 <span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> name: my-project options: <span class="token punctuation">{<!-- --></span> force: <span class="token boolean">true</span> <span class="token punctuation">}</span>
</code></pre> 
<p>成功拿到命令行输入信息</p> 
<h5><a id="23__401"></a>2.3 执行命令</h5> 
<p>创建 lib 文件夹并在文件夹下创建 create.js</p> 
<pre><code class="prism language-javascript"><span class="token comment">// lib/create.js</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 验证是否正常取到值</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;&gt; create.js'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 cli.js 中使用 create.js</p> 
<pre><code class="prism language-javascript"><span class="token comment">// bin/cli.js</span>

<span class="token operator">...</span><span class="token operator">...</span>
program
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'create &lt;app-name&gt;'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">'create a new project'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-f, --force'</span><span class="token punctuation">,</span> <span class="token string">'overwrite target directory if it exist'</span><span class="token punctuation">)</span> <span class="token comment">// 是否强制创建，当文件夹已经存在</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 在 create.js 中执行创建任务</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/create.js'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">...</span><span class="token operator">...</span>
</code></pre> 
<p>执行一下 <code>sumi create my-project</code>，此时在 <code>create.js</code> 正常打印了我们出入的信息</p> 
<pre><code class="prism language-bash">sumi create my-project
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> create.js
my-project <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<p>在创建目录的时候，需要判断是否已经存在</p> 
<p>如果存在</p> 
<p>当 <code>{ force: true }</code> 时，直接移除原来的目录，直接创建<br> 当 <code>{ force: false }</code> 时 询问用户是否需要覆盖</p> 
<p>如果不存在，直接创建</p> 
<p>这里用到了 fs 的扩展工具 fs-extra，先来安装一下<br> fs-extra 是对 fs 模块的扩展，支持 promise</p> 
<pre><code class="prism language-bash"><span class="token function">npm</span> <span class="token function">install</span> fs-extra --save
</code></pre> 
<p>接着完善一下 create.js 内部的实现逻辑</p> 
<pre><code class="prism language-javascript"><span class="token comment">// lib/create.js</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs-extra'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 执行创建命令</span>

  <span class="token comment">// 当前命令行选择的目录</span>
  <span class="token keyword">const</span> cwd  <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 需要创建的目录地址</span>
  <span class="token keyword">const</span> targetAir  <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> name<span class="token punctuation">)</span>

  <span class="token comment">// 目录是否已经存在？</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>targetAir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 是否为强制创建？</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>force<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>targetAir<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 询问用户是否确定要覆盖</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>询问部分的逻辑，我们将在下文继续完善</p> 
<h5><a id="24__486"></a>2.4 创建更多命令</h5> 
<p>如果想添加其他命令也是同样的处理方式</p> 
<pre><code class="prism language-javascript"><span class="token comment">// bin/cli.js</span>

<span class="token comment">// 配置 config 命令</span>
program
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'config [value]'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">'inspect and modify the config'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-g, --get &lt;path&gt;'</span><span class="token punctuation">,</span> <span class="token string">'get value from option'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-s, --set &lt;path&gt; &lt;value&gt;'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-d, --delete &lt;path&gt;'</span><span class="token punctuation">,</span> <span class="token string">'delete option from config'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 配置 ui 命令</span>
program
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'ui'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">'start add open roc-cli ui'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-p, --port &lt;port&gt;'</span><span class="token punctuation">,</span> <span class="token string">'Port used for the UI Server'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="25__513"></a>2.5 完善帮助信息</h5> 
<p>可以看一下 vue-cli 执行 --help 打印的信息</p> 
<p>对比 sumi --help 打印的结果，结尾处少了一条说明信息，这里我们做补充，重点需要注意说明信息是带有颜色的，这里就需要用到我们工具库里面的 chalk 来处理</p> 
<pre><code class="prism language-javascript"><span class="token comment">// bin/cli.js</span>

program
  <span class="token comment">// 监听 --help 执行</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'--help'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 新增说明信息</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\r\nRun </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sumi &lt;command&gt; --help</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> for detailed usage of given command\r\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="26__Logo_530"></a>2.6 打印个 Logo</h5> 
<p>给脚手架来一个 Logo，使用工具库里的 figlet</p> 
<pre><code class="prism language-javascript"><span class="token comment">// bin/cli.js</span>

program
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'--help'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 使用 figlet 绘制 Logo</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\r\n'</span> <span class="token operator">+</span> figlet<span class="token punctuation">.</span><span class="token function">textSync</span><span class="token punctuation">(</span><span class="token string">'sumi'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      font<span class="token operator">:</span> <span class="token string">'Ghost'</span><span class="token punctuation">,</span>
      horizontalLayout<span class="token operator">:</span> <span class="token string">'default'</span><span class="token punctuation">,</span>
      verticalLayout<span class="token operator">:</span> <span class="token string">'default'</span><span class="token punctuation">,</span>
      width<span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
      whitespaceBreak<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 新增说明信息</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\r\nRun </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sumi &lt;command&gt; --help</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> show details\r\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="3__551"></a>3. 询问用户问题获取创建所需信息</h4> 
<p>使用 inquirer 解决命令行交互的问题<br> 上一步遗留：询问用户是否覆盖已存在的目录</p> 
<ul><li>用户选择模板</li><li>用户选择版本</li><li>获取下载模板的链接</li></ul> 
<h5><a id="31__558"></a>3.1 询问是否覆盖已存在的目录</h5> 
<p>这里解决上一步遗留的问题：</p> 
<p>如果目录已存在</p> 
<p>当 <code>{ force: false }</code> 时 询问用户是否需要覆盖</p> 
<p>逻辑实际上已经完成，这里补充一下询问的内容</p> 
<p>安装 inquirer</p> 
<pre><code class="prism language-bash"><span class="token function">npm</span> <span class="token function">install</span> inquirer --save
</code></pre> 
<p>然后询问用户是否进行 Overwrite</p> 
<pre><code class="prism language-javascript"><span class="token comment">// lib/create.js</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token comment">// fs-extra 是对 fs 模块的扩展，支持 promise 语法</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs-extra'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> inquirer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'inquirer'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 执行创建命令</span>

  <span class="token comment">// 当前命令行选择的目录</span>
  <span class="token keyword">const</span> cwd  <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 需要创建的目录地址</span>
  <span class="token keyword">const</span> targetAir  <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> name<span class="token punctuation">)</span>

  <span class="token comment">// 目录是否已经存在？</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>targetAir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 是否为强制创建？</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>force<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>targetAir<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

      <span class="token comment">// 询问用户是否确定要覆盖</span>
      <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> action <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
          name<span class="token operator">:</span> <span class="token string">'action'</span><span class="token punctuation">,</span>
          type<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
          message<span class="token operator">:</span> <span class="token string">'Target directory already exists Pick an action:'</span><span class="token punctuation">,</span>
          choices<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
              name<span class="token operator">:</span> <span class="token string">'Overwrite'</span><span class="token punctuation">,</span>
              value<span class="token operator">:</span> <span class="token string">'overwrite'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span>
              name<span class="token operator">:</span> <span class="token string">'Cancel'</span><span class="token punctuation">,</span>
              value<span class="token operator">:</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>action<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">===</span> <span class="token string">'overwrite'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 移除已存在的目录</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\r\nRemoving...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>targetAir<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>github 提供了 api 接口来获取信息</p> 
<p>api.github.com/orgs/ 接口获取模板信息<br> api.github.com/repos/ 接口获取版本信息</p> 
<p>我们在 lib 目录下创建一个 http.js 专门处理模板和版本信息的获取</p> 
<pre><code class="prism language-javascript"><span class="token comment">// lib/http.js</span>

<span class="token comment">// 通过 axios 处理请求</span>
<span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>

axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">/**
 * 获取模板列表
 * @returns Promise
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getRepoList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/orgs/zhurong-cli/repos'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 获取版本信息
 * @param {string} repo 模板名称
 * @returns Promise
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span>  <span class="token function">getTagList</span><span class="token punctuation">(</span><span class="token parameter">repo</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.github.com/repos/zhurong-cli/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>repo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/tags</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  getRepoList<span class="token punctuation">,</span>
  getTagList
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="33__672"></a>3.3 用户选择模板</h5> 
<p>我们专门新建一个 Generator.js 来处理项目创建逻辑</p> 
<pre><code class="prism language-javascript"><span class="token comment">// lib/Generator.js</span>

<span class="token keyword">class</span> <span class="token class-name">Generator</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> targetDir</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 目录名称</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token comment">// 创建位置</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>targetDir <span class="token operator">=</span> targetDir<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 核心创建逻辑</span>
  <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Generator<span class="token punctuation">;</span>
</code></pre> 
<p>在 create.js 中引入 Generator 类</p> 
<pre><code class="prism language-javascript"><span class="token comment">// lib/create.js</span>

<span class="token operator">...</span>
<span class="token keyword">const</span> Generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Generator'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 执行创建命令</span>

  <span class="token comment">// 当前命令行选择的目录</span>
  <span class="token keyword">const</span> cwd  <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 需要创建的目录地址</span>
  <span class="token keyword">const</span> targetAir  <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> name<span class="token punctuation">)</span>

  <span class="token comment">// 目录是否已经存在？</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>targetAir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 创建项目</span>
  <span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Generator</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> targetAir<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 开始创建项目</span>
  generator<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>询问用户选择模版的逻辑</p> 
<pre><code class="prism language-javascript"><span class="token comment">// lib/Generator.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> getRepoList <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ora <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ora'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> inquirer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'inquirer'</span><span class="token punctuation">)</span>

<span class="token comment">// 添加加载动画</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">wrapLoading</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 使用 ora 初始化，传入提示信息 message</span>
  <span class="token keyword">const</span> spinner <span class="token operator">=</span> <span class="token function">ora</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 开始加载动画</span>
  spinner<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 执行传入方法 fn</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 状态为修改为成功</span>
    spinner<span class="token punctuation">.</span><span class="token function">succeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 状态为修改为失败</span>
    spinner<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">'Request failed, refetch ...'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Generator</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> targetDir</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 目录名称</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token comment">// 创建位置</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>targetDir <span class="token operator">=</span> targetDir<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取用户选择的模板</span>
  <span class="token comment">// 1）从远程拉取模板数据</span>
  <span class="token comment">// 2）用户选择自己新下载的模板名称</span>
  <span class="token comment">// 3）return 用户选择的名称</span>

  <span class="token keyword">async</span> <span class="token function">getRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1）从远程拉取模板数据</span>
    <span class="token keyword">const</span> repoList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">wrapLoading</span><span class="token punctuation">(</span>getRepoList<span class="token punctuation">,</span> <span class="token string">'waiting fetch template'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>repoList<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// 过滤我们需要的模板名称</span>
    <span class="token keyword">const</span> repos <span class="token operator">=</span> repoList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2）用户选择自己新下载的模板名称</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> repo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      name<span class="token operator">:</span> <span class="token string">'repo'</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
      choices<span class="token operator">:</span> repos<span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">'Please choose a template to create project'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 3）return 用户选择的名称</span>
    <span class="token keyword">return</span> repo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 核心创建逻辑</span>
  <span class="token comment">// 1）获取模板名称</span>
  <span class="token comment">// 2）获取 tag 名称</span>
  <span class="token comment">// 3）下载模板到模板目录</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 1）获取模板名称</span>
    <span class="token keyword">const</span> repo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户选择了，repo='</span> <span class="token operator">+</span> repo<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Generator<span class="token punctuation">;</span>
</code></pre> 
<p>此时，成功拿到模板名称 repo 的结果 ✌️</p> 
<h5><a id="34__802"></a>3.4 用户选择版本</h5> 
<p>过程和 3.3 一样</p> 
<pre><code class="prism language-javascript"><span class="token comment">// lib/generator.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> getRepoList<span class="token punctuation">,</span> getTagList <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./http'</span><span class="token punctuation">)</span>
<span class="token operator">...</span>

<span class="token comment">// 添加加载动画</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">wrapLoading</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Generator</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> targetDir</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 目录名称</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token comment">// 创建位置</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>targetDir <span class="token operator">=</span> targetDir<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取用户选择的模板</span>
  <span class="token comment">// 1）从远程拉取模板数据</span>
  <span class="token comment">// 2）用户选择自己新下载的模板名称</span>
  <span class="token comment">// 3）return 用户选择的名称</span>

  <span class="token keyword">async</span> <span class="token function">getRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取用户选择的版本</span>
  <span class="token comment">// 1）基于 repo 结果，远程拉取对应的 tag 列表</span>
  <span class="token comment">// 2）用户选择自己需要下载的 tag</span>
  <span class="token comment">// 3）return 用户选择的 tag</span>

  <span class="token keyword">async</span> <span class="token function">getTag</span><span class="token punctuation">(</span><span class="token parameter">repo</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1）基于 repo 结果，远程拉取对应的 tag 列表</span>
    <span class="token keyword">const</span> tags <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">wrapLoading</span><span class="token punctuation">(</span>getTagList<span class="token punctuation">,</span> <span class="token string">'waiting fetch tag'</span><span class="token punctuation">,</span> repo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tags<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 过滤我们需要的 tag 名称</span>
    <span class="token keyword">const</span> tagsList <span class="token operator">=</span> tags<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2）用户选择自己需要下载的 tag</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> tag <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      name<span class="token operator">:</span> <span class="token string">'tag'</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
      choices<span class="token operator">:</span> tagsList<span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">'Place choose a tag to create project'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 3）return 用户选择的 tag</span>
    <span class="token keyword">return</span> tag
  <span class="token punctuation">}</span>

  <span class="token comment">// 核心创建逻辑</span>
  <span class="token comment">// 1）获取模板名称</span>
  <span class="token comment">// 2）获取 tag 名称</span>
  <span class="token comment">// 3）下载模板到模板目录</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 1）获取模板名称</span>
    <span class="token keyword">const</span> repo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 2) 获取 tag 名称</span>
    <span class="token keyword">const</span> tag <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTag</span><span class="token punctuation">(</span>repo<span class="token punctuation">)</span>
     
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户选择了，repo='</span> <span class="token operator">+</span> repo <span class="token operator">+</span> <span class="token string">'，tag='</span><span class="token operator">+</span> tag<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Generator<span class="token punctuation">;</span>
</code></pre> 
<p>到此询问的工作就结束了，可以进行模板下载了</p> 
<h4><a id="4__877"></a>4. 下载远程模板</h4> 
<p>下载远程模版需要使用 download-git-repo 工具包，但它是不支持 promise的，所以我们这里需要使用 util 模块中的 promisify 方法对其进行 promise 化。</p> 
<h5><a id="41__promise__879"></a>4.1 安装依赖与 promise 化</h5> 
<pre><code class="prism language-bash"><span class="token function">npm</span> <span class="token function">install</span> download-git-repo --save
</code></pre> 
<p>进行 promise 化处理</p> 
<pre><code class="prism language-javascript"><span class="token comment">// lib/Generator.js</span>

<span class="token operator">...</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> downloadGitRepo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'download-git-repo'</span><span class="token punctuation">)</span> <span class="token comment">// 不支持 Promise</span>

<span class="token keyword">class</span> <span class="token class-name">Generator</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> targetDir</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>

    <span class="token comment">// 对 download-git-repo 进行 promise 化改造</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>downloadGitRepo <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>downloadGitRepo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="42__906"></a>4.2 核心下载功能</h5> 
<p>接着，就是模板下载部分的逻辑了</p> 
<pre><code class="prism language-javascript"><span class="token comment">// lib/Generator.js</span>

<span class="token operator">...</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> downloadGitRepo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'download-git-repo'</span><span class="token punctuation">)</span> <span class="token comment">// 不支持 Promise</span>

<span class="token comment">// 添加加载动画</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">wrapLoading</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Generator</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> targetDir</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>

    <span class="token comment">// 对 download-git-repo 进行 promise 化改造</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>downloadGitRepo <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>downloadGitRepo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
  
  <span class="token comment">// 下载远程模板</span>
  <span class="token comment">// 1）拼接下载地址</span>
  <span class="token comment">// 2）调用下载方法</span>
  <span class="token keyword">async</span> <span class="token function">download</span><span class="token punctuation">(</span><span class="token parameter">repo<span class="token punctuation">,</span> tag</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 1）拼接下载地址</span>
    <span class="token keyword">const</span> requestUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">zhurong-cli/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>repo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>tag<span class="token operator">?</span><span class="token string">'#'</span><span class="token operator">+</span>tag<span class="token operator">:</span><span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token comment">// 2）调用下载方法</span>
    <span class="token keyword">await</span> <span class="token function">wrapLoading</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>downloadGitRepo<span class="token punctuation">,</span> <span class="token comment">// 远程下载方法</span>
      <span class="token string">'waiting download template'</span><span class="token punctuation">,</span> <span class="token comment">// 加载提示信息</span>
      requestUrl<span class="token punctuation">,</span> <span class="token comment">// 参数1: 下载地址</span>
      path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 参数2: 创建位置</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 核心创建逻辑</span>
  <span class="token comment">// 1）获取模板名称</span>
  <span class="token comment">// 2）获取 tag 名称</span>
  <span class="token comment">// 3）下载模板到模板目录</span>
  <span class="token comment">// 4）模板使用提示</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 1）获取模板名称</span>
    <span class="token keyword">const</span> repo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 2) 获取 tag 名称</span>
    <span class="token keyword">const</span> tag <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTag</span><span class="token punctuation">(</span>repo<span class="token punctuation">)</span>

    <span class="token comment">// 3）下载模板到模板目录</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">download</span><span class="token punctuation">(</span>repo<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>
    
    <span class="token comment">// 4）模板使用提示</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\r\nSuccessfully created project </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\r\n  cd </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'  npm run dev\r\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Generator<span class="token punctuation">;</span>
</code></pre> 
<p>完成这块，一个简单的脚手架就完成了<br> 来试一下效果如何，执行 sumi create my-project</p> 
<p>这个时候，我们就可以看到模板就已经创建好了<br> s-umi-cli</p> 
<pre><code class="prism language-javascript">├─ bin                      
│  └─ cli<span class="token punctuation">.</span>js                
├─ lib                      
│  ├─ Generator<span class="token punctuation">.</span>js          
│  ├─ create<span class="token punctuation">.</span>js             
│  └─ http<span class="token punctuation">.</span>js               
├─ my<span class="token operator">-</span>project <span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 我们创建的项目             
│  ├─ <span class="token keyword">public</span>                
│  │  ├─ favicon<span class="token punctuation">.</span>ico        
│  │  └─ index<span class="token punctuation">.</span>html         
│  ├─ src                   
│  │  ├─ assets             
│  │  │  └─ logo<span class="token punctuation">.</span>png        
│  │  ├─ components         
│  │  │  └─ HelloWorld<span class="token punctuation">.</span>vue  
│  │  ├─ App<span class="token punctuation">.</span>vue            
│  │  └─ main<span class="token punctuation">.</span>js            
│  ├─ <span class="token constant">README</span><span class="token punctuation">.</span>md             
│  ├─ babel<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js       
│  └─ <span class="token keyword">package</span><span class="token punctuation">.</span>json          
├─ <span class="token constant">README</span><span class="token punctuation">.</span>md                
├─ <span class="token keyword">package</span><span class="token operator">-</span>lock<span class="token punctuation">.</span>json        
└─ <span class="token keyword">package</span><span class="token punctuation">.</span>json             
</code></pre> 
<h4><a id="5__1006"></a>5. 发布项目</h4> 
<p>上面都是在本地测试，实际在使用的时候，可能就需要发布到 npm 仓库，通过 npm 全局安装之后，直接到目标目录下面去创建项目，如何发布呢？</p> 
<p>第一步，在 git 上建好仓库<br> 第二步，完善 package.json 中的配置</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"zhurong-cli"</span><span class="token punctuation">,</span>
  <span class="token string">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.4"</span><span class="token punctuation">,</span>
  <span class="token string">"description"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token string">"main"</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
  <span class="token string">"bin"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"zr"</span><span class="token operator">:</span> <span class="token string">"./bin/cli.js"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"test"</span><span class="token operator">:</span> <span class="token string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"files"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"bin"</span><span class="token punctuation">,</span>
    <span class="token string">"lib"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"author"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"T-Roc"</span><span class="token punctuation">,</span>
    <span class="token string">"email"</span><span class="token operator">:</span> <span class="token string">"lxp_work@163.com"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"keywords"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"zhurong-cli"</span><span class="token punctuation">,</span>
    <span class="token string">"zr"</span><span class="token punctuation">,</span>
    <span class="token string">"脚手架"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"license"</span><span class="token operator">:</span> <span class="token string">"MIT"</span><span class="token punctuation">,</span>
  <span class="token string">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"axios"</span><span class="token operator">:</span> <span class="token string">"^0.21.1"</span><span class="token punctuation">,</span>
    <span class="token string">"chalk"</span><span class="token operator">:</span> <span class="token string">"^4.1.1"</span><span class="token punctuation">,</span>
    <span class="token string">"commander"</span><span class="token operator">:</span> <span class="token string">"^7.2.0"</span><span class="token punctuation">,</span>
    <span class="token string">"download-git-repo"</span><span class="token operator">:</span> <span class="token string">"^3.0.2"</span><span class="token punctuation">,</span>
    <span class="token string">"figlet"</span><span class="token operator">:</span> <span class="token string">"^1.5.0"</span><span class="token punctuation">,</span>
    <span class="token string">"fs-extra"</span><span class="token operator">:</span> <span class="token string">"^10.0.0"</span><span class="token punctuation">,</span>
    <span class="token string">"inquirer"</span><span class="token operator">:</span> <span class="token string">"^8.0.0"</span><span class="token punctuation">,</span>
    <span class="token string">"ora"</span><span class="token operator">:</span> <span class="token string">"^5.4.0"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>第三步，使用 npm publish 进行发布，更新到时候，注意修改版本号</p> 
<p>这样就发布成功了，我们打开 npm 网站搜索一下 🔍</p> 
<p>已经可以找到它了，这样我们就可以通过 npm 或者 yarn 全局安装使用了。</p> 
<p>关注公众号：大明贵妇，获取 Umi.js 学习资料（回复 Umi ），期待各位客官来临<br> <img src="https://images2.imgbox.com/a5/59/KDc8fkaY_o.jpg" alt="在这里插入图片描述"></p> 
<p>参考文章：https://www.jianshu.com/p/dc493809a2fd</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e24e3c5c01314f9a879c573691fa9e4c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">html 转成vue_浅析Vue两种版本</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/545463d605f731e402ef7084ef4d7a01/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Numpy学习笔记（一）基本操作&amp;array的创建</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>