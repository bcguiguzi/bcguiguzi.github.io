<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux_TCP/IP_网络编程 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux_TCP/IP_网络编程" />
<meta property="og:description" content="网络编程 一、Internet与TCP/IP协议 ​ 20世纪50年代，美国领导的西方阵营，苏联领导的东方阵营。为争夺科技，军事力量的背景下产生。
​ 美国成立国防部高级研究计划。1968年提出高级资源共享的计算机网络。后实现网络互连。最初的Internet形成。
​ 也叫ARPAnet 阿帕网。其他国家相继建立本国的主干网并接入Internet.又MIC,Sprint 公司运营使普通家庭也可以使用。
1.1 OSI OSI是Open System Interconnect的缩写，意为开放式系统互联。
其各个层次的划分遵循下列原则：
（1）同一层中的各网络节点都有相同的层次结构，具有同样的功能。
（2）同一节点内相邻层之间通过接口进行通信。
（3）七层结构中的每一层使用下一层提供的服务，并且向其上层提供服务。
（4）不同节点的同等层按照协议实现对等层之间的通信。
​ 应用层： 产生网络流量的程序
​ 表示层： 传输之前是否进行加密或者压缩处理
​ 会话层： 查看会话，查木马 netstat-n
​ 传输层： 可靠传输、流量控制、不可靠传输
​ 网络层： 负责选择最佳路径、规划ip地址
​ 数据链路层： 帧的开始和结束、透明传输、差错校验
​ 物理层： 接口标准、电器标准、如何更快传输数据
1.2 TCP/IP ​ TCP/IP（Transmission Control Protocol/Internet Protocol，传输控制协议/网际协议）是指能够在多个不同网络间实现信息传输的协议簇。TCP/IP协议不仅仅指的是TCP 和IP两个协议，而是指一个由FTP、SMTP、TCP、UDP、IP等协议构成的协议簇， 只是因为在TCP/IP协议中TCP协议和IP协议最具代表性，所以被称为TCP/IP协议。
TCP/IP是在网络的使用中的最基本的通信协议。TCP/IP传输协议对互联网中各部分进行通信的标准和方法进行了规定。TCP/IP传输协议是保证网络数据信息及时、完整传输的两个重要的协议。TCP/IP传输协议是严格来说是一个四层的体系结构，应用层、传输层、网络层和数据链路层都包含其中。 各层的常见协议
第层常见协议1应用层Telnet（远程登录）
FTP（文件传输协议）
HTTP（超文本传输协议）
DNS（域名系统）
SNMP（简单网络管理协议 基于UDP）
SMTP（简单邮件传输）2传输层TCP（传输控制协议） 可靠的
UDP（用户数据报协议） 不可靠的3网络层IP协议（网际协议）
ICMP（互联网报文控制协议）
IGMP（组管理协议）4网络接口和物理层以太网、令牌环网、FDDI
ARP（地址解析协议） RARP（逆地址解析协议） 四层的作用
应用层：应用层是TCP/IP协议的第一层，是直接为应用进程提供服务的。 对不同种类的应用程序它们会根据自己的需要来使用应用层的不同协议，邮件传输应用使用了SMTP协议、万维网应用使用了HTTP协议、远程登录服务应用使用了有TELNET协议。应用层还能加密、解密、格式化数据。应用层可以建立或解除与其他节点的联系，这样可以充分节省网络资源。 运输层：作为TCP/IP协议的第二层，运输层在整个TCP/IP协议中起到了中流砥柱的作用。且在运输层中，TCP和UDP也同样起到了中流砥柱的作用网络层：网络层在TCP/IP协议中的位于第三层。在TCP/IP协议中网络层可以进行网络连接的建立和终止以及IP地址的寻找等功能网络接口层：在TCP/IP协议中，网络接口层位于第四层。由于网络接口层兼并了物理层和数据链路层所以，网络接口层既是传输数据的物理媒介，也可以为网络层提供一条准确无误的线路 OSI模型和TCP/IP模型的结构图" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/f38f20bc398446a267ad68e4b3ace415/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-04T14:59:04+08:00" />
<meta property="article:modified_time" content="2023-08-04T14:59:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux_TCP/IP_网络编程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>网络编程</h2> 
<h3><a id="InternetTCPIP_2"></a>一、Internet与TCP/IP协议</h3> 
<blockquote> 
 <p>​ 20世纪50年代，美国领导的西方阵营，苏联领导的东方阵营。为争夺科技，军事力量的背景下产生。</p> 
 <p>​ 美国成立国防部高级研究计划。1968年提出高级资源共享的计算机网络。后实现网络互连。最初的Internet形成。</p> 
 <p>​ 也叫ARPAnet 阿帕网。其他国家相继建立本国的主干网并接入Internet.又MIC,Sprint 公司运营使普通家庭也可以使用。</p> 
</blockquote> 
<h4><a id="11_OSI_10"></a>1.1 OSI</h4> 
<blockquote> 
 <p>OSI是Open System Interconnect的缩写，意为开放式系统互联。</p> 
</blockquote> 
<p>其各个层次的划分遵循下列原则：</p> 
<p>（1）同一层中的各网络节点都有相同的层次结构，具有同样的功能。</p> 
<p>（2）同一节点内相邻层之间通过接口进行通信。</p> 
<p>（3）七层结构中的每一层使用下一层提供的服务，并且向其上层提供服务。</p> 
<p>（4）不同节点的同等层按照协议实现对等层之间的通信。<br> <img src="https://images2.imgbox.com/56/17/IcpjHdJy_o.gif" alt="在这里插入图片描述"></p> 
<p>​ <strong>应用层：</strong> 产生网络流量的程序</p> 
<p>​ <strong>表示层：</strong> 传输之前是否进行加密或者压缩处理</p> 
<p>​ <strong>会话层：</strong> 查看会话，查木马 netstat-n</p> 
<p>​ <strong>传输层：</strong> 可靠传输、流量控制、不可靠传输</p> 
<p>​ <strong>网络层：</strong> 负责选择最佳路径、规划ip地址</p> 
<p>​ <strong>数据链路层：</strong> 帧的开始和结束、透明传输、差错校验</p> 
<p>​ <strong>物理层：</strong> 接口标准、电器标准、如何更快传输数据</p> 
<hr> 
<h4><a id="12_TCPIP_42"></a>1.2 TCP/IP</h4> 
<blockquote> 
 <p>​ TCP/IP（Transmission Control Protocol/Internet Protocol，<strong>传输控制协议/网际协议</strong>）是指能够在多个不同网络间实现信息传输的协议簇。TCP/IP协议不仅仅指的是TCP 和IP两个协议，而是指一个由FTP、SMTP、TCP、UDP、IP等协议构成的协议簇， 只是因为在TCP/IP协议中TCP协议和IP协议最具代表性，所以被称为TCP/IP协议。</p> 
</blockquote> 
<ul><li>TCP/IP是在网络的使用中的<strong>最基本的通信协议</strong>。</li><li>TCP/IP传输协议对互联网中各部分进行<strong>通信的标准和方法进行了规定</strong>。</li><li>TCP/IP传输协议是<strong>保证网络数据信息及时、完整传输</strong>的两个重要的协议。</li><li>TCP/IP传输协议是严格来说是一个<strong>四层</strong>的体系结构，<strong>应用层</strong>、<strong>传输层</strong>、<strong>网络层</strong>和<strong>数据链路层</strong>都包含其中。</li></ul> 
<blockquote> 
 <p><strong>各层的常见协议</strong></p> 
</blockquote> 
<table><thead><tr><th>第</th><th align="left">层</th><th>常见协议</th></tr></thead><tbody><tr><td>1</td><td align="left">应用层</td><td><code>Telnet</code>（远程登录）<br><code>FTP</code>（文件传输协议）<br><code>HTTP</code>（超文本传输协议）<br><code>DNS</code>（域名系统）<br><code>SNMP</code>（简单网络管理协议 基于UDP）<br><code>SMTP</code>（简单邮件传输）</td></tr><tr><td>2</td><td align="left">传输层</td><td><code>TCP</code>（传输控制协议） 可靠的<br><code>UDP</code>（用户数据报协议） 不可靠的</td></tr><tr><td>3</td><td align="left">网络层</td><td><code>IP协议</code>（网际协议）<br><code>ICMP</code>（互联网报文控制协议）<br><code> IGMP</code>（组管理协议）</td></tr><tr><td>4</td><td align="left">网络接口和物理层</td><td>以太网、令牌环网、FDDI<br><code>ARP</code>（地址解析协议） <br><code>RARP</code>（逆地址解析协议）</td></tr></tbody></table> 
<blockquote> 
 <p><strong>四层的作用</strong></p> 
</blockquote> 
<ul><li>应用层：应用层是<code>TCP/IP协议</code>的第一层，是直接为应用进程提供服务的。 
  <ul><li>对不同种类的应用程序它们会根据自己的需要来使用应用层的不同协议，邮件传输应用使用了SMTP协议、万维网应用使用了HTTP协议、远程登录服务应用使用了有TELNET协议。</li><li>应用层还能加密、解密、格式化数据。</li><li>应用层可以建立或解除与其他节点的联系，这样可以充分节省网络资源。</li></ul> </li><li>运输层：作为<code>TCP/IP协议</code>的第二层，运输层在整个<code>TCP/IP协议</code>中起到了中流砥柱的作用。且在运输层中，TCP和UDP也同样起到了中流砥柱的作用</li><li>网络层：网络层在TCP/IP协议中的位于第三层。在<code>TCP/IP协议</code>中网络层可以进行网络连接的建立和终止以及IP地址的寻找等功能</li><li>网络接口层：在<code>TCP/IP协议</code>中，网络接口层位于第四层。由于网络接口层兼并了物理层和数据链路层所以，网络接口层既是传输数据的物理媒介，也可以为网络层提供一条准确无误的线路</li></ul> 
<blockquote> 
 <p>OSI模型和TCP/IP模型的结构图<br> <img src="https://images2.imgbox.com/23/ce/8TPch4Tl_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a8/dd/ndh7YLx0_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p><strong>协议</strong></p> 
<blockquote> 
 <p>在网络通信的过程中，将发出数据的主机称为源主机，接收数据的主机称为目的主机。</p> 
</blockquote> 
<p>当源主机发出数据时，数据在源主机中从上层向下层传送。</p> 
<ul><li>源主机中的应用进程先将数据交给应用层，应用层加上必要的控制信息就成了报文流，向下传给传输层。</li><li>传输层将收到的数据单元加上本层的控制信息，形成报文段、数据报，再交给网际层。</li><li>网际层加上本层的控制信息，形成IP数据报，传给网络接口层。</li><li>网络接口层将网际层交下来的IP数据报组装成帧，并以比特流的形式传给网络硬件（即物理层），数据就离开源主机。</li></ul> 
<hr> 
<h4><a id="13__87"></a>1.3 网络的术语</h4> 
<h5><a id="131__89"></a>1.3.1 互联网的地址</h5> 
<p>​ <strong>互联网的地址必须有唯一的IP，IP地址为32位（IPv4）或者128位（IPv6）。</strong> Internet中的主机要与别的机器通信必须具有一个IP地址，</p> 
<p><mark>理解源IP地址和目的IP地址</mark></p> 
<p>​ 因特网中的每一台主机都有自己的IP地址，如果要实现A主机与B主机进行通信，A主机就必须要知道B主机的IP地址（目的IP），这样A主机才能向B主机发生数据；B主机接收到数据后，显然也需要A主机一个响应，那么B主机就必须要知道A主机的IP地址（源IP地址）；当然这里只是大概的意思，等我们对套接字编程有了一定的了解，知道两个主机之间是如何通信的，再回过头来去理解这些协议的作用和更深层的理解；</p> 
<p>每个数据包都必须携带<strong>目的IP地址</strong>和<strong>源IP地址</strong>，路由器依靠此信息为数据包选择路由。</p> 
<ul><li> <p><mark>公有地址</mark><br> 公有地址（Public address）由Inter NIC（Internet Network Information Center因特网信息中心）负责。这些IP地址分配给注册并向Inter NIC提出申请的组织机构。通过它直接访问因特网。</p> </li><li> <p><mark>私有地址</mark><br> 私有地址（Private address）属于非注册地址，专门为组织机构内部使用。</p> 
  <blockquote> 
   <p>以下列出留用的内部私有地址<br> <img src="https://images2.imgbox.com/c7/00/veyOMBMZ_o.png" alt="在这里插入图片描述"></p> 
  </blockquote> </li></ul> 
<p>这些32位的地址通常写成四个十进制的数，其中每个整数对应一个字节。这种表示方法称作 <font face="黑体" color="#ff0000"><strong>点分十进制</strong></font> 表示法(Dotted decimal notation)”。</p> 
<table><thead><tr><th align="center">类别</th><th>最大网络数</th><th>IP地址范围</th><th>单个网段最大主机数</th><th>私有IP地址范围</th></tr></thead><tbody><tr><td align="center">A</td><td>126(2^7-2)</td><td>1.0.0.1-127.255.255.254</td><td>16777214</td><td>10.0.0.0-10.255.255.255</td></tr><tr><td align="center">B</td><td>16384(2^14)</td><td>128.0.0.1-191.255.255.254</td><td>65534</td><td>172.16.0.0-172.31.255.255</td></tr><tr><td align="center">C</td><td>2097152(2^21)</td><td>192.0.0.1-223.255.255.254</td><td>254</td><td>192.168.0.0-192.168.255.255</td></tr></tbody></table> 
<p>有三类IP地址:</p> 
<ul><li> <p>单播地址（目的为单个主机)。</p> </li><li> <p>广播地址（目的端为给定网络上的所有主机）。</p> </li><li> <p>多播地址（目的端为同一组内的所有主机)。</p> </li></ul> 
<p>在Linux运行ifconfig, 如果网卡信息中包含UP BROADCAST(广播) RUNNING MULTICAST(组播)，则支持广播和组播。</p> 
<blockquote> 
 <p>IP字符串&lt;–&gt;网络字节序</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">//将strptr所指的字符串转换成32位的网络字节序二进制值</span>
<span class="token keyword">int</span> <span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token operator">*</span>addrptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    
<span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">//功能同上，返回转换后的地址。</span>
<span class="token class-name">in_addr_t</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    
<span class="token function">inet_ntoa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">//将32位网络字节序二进制地址转换成点分十进制的字符串。 </span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>stuct in_addr inaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">/* Internet address. */</span>
<span class="token keyword">struct</span> <span class="token class-name">in_addr</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> s_addr<span class="token punctuation">;</span> <span class="token comment">/* address in network byte order */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>有关IP的结构体</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span>		<span class="token comment">// IPV4</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">sa_family_t</span> sa_family<span class="token punctuation">;</span>
    <span class="token keyword">char</span> 		sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 因特网类型		使用时要强制转换</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">sa_family_t</span> sin_family<span class="token punctuation">;</span>    <span class="token comment">// 协议族</span>
    in_port t sin_port<span class="token punctuation">;</span>        <span class="token comment">// 端口号</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span>   <span class="token comment">// IP地址结构体</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 填充 没有实际意义，只是为跟sockaddh结构在内存中对齐这样两者才能相互转换</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<hr> 
<h5><a id="132__172"></a>1.3.2 端口</h5> 
<p>在网络技术中，端口（Port）大致有两种意思：</p> 
<ul><li> <p>物理意义上的端口，比如，ADSL Modem、集线器、交换机、路由器用于连接其他<strong>网络设备的接口</strong>，如RJ-45端口、SC端口等等。</p> </li><li> <p>逻辑意义上的端口，一般是指<strong>TCP/IP协议中的端口，端口号的范围从0到65535</strong>，比如用于浏览网页服务的80端口，用于FTP服务的21端口等等。</p> </li></ul> 
<p><strong>理解源端口号和目的端口号</strong></p> 
<p>​ 数据链路和IP中的地址，分别是<u>MAC地址和IP地址。前者是用来识别同一链路中不同的计算机，后者是用来识别TCP/IP网络中互连的主机和路由器。</u>在传输层中也有这样类似于地址的概念，那就是<font face="黑体" color="#ff0000"><strong>端口号</strong></font>。<font face="黑体" color="#ff0000">端口号</font>是用来==<em><strong>识别同一台计算机中进行通信的不同应用程序</strong></em>==。因此，它也被称为程序地址。</p> 
<p>​ 服务器一般都是通过<strong>知名端口号</strong>来识别的。例如，对于每个TCP/IP实现来说，FTP服务器的TCP端口号都是21，每个Telnet服务器的TCP端口号都是23。任何TCP/IP实现所提供的服务都用知名的1~1023之间的端口号。这些知名端口号由Internet号分配机构（ Internet Assigned Numbers Authority, IANA)来管理。</p> 
<p>​ 到1992年为止，<strong>知名端口号介于1～255之间</strong>。<strong>256~1023之间的端口号通常都是由Unix系统占用</strong>，以提供一些特定的Unix服务——也就是说，提供一些只有Unix系统才有的、而其他操作系统可能不提供的服务。现在IANA管理1～1023之间所有的端口号。</p> 
<p>​ **大多数TCP/IP实现给临时端口分配1024～5000之间的端口号。**大于5000的端口号是为其他服务器预留的( Internet上并不常用的服务)。</p> 
<p>​ <strong>1024~65535是动态端口</strong>。这些端口号一般不固定分配给某个服务，也就是说许多服务都可以使用这些端口。当程序关闭，也会同时释放这些端口供其他程序使用。</p> 
<p>​ 大多数Unix系统的文件/etc/services都包含了人们熟知的端口号。为了找到Telnet服务器和域名系统的端口号，可以运行以下语句: <code>preg telnet /etc/services</code></p> 
<p><strong>进程ID与端口号的理解：</strong></p> 
<p>​ <strong>我们都知道所有进程都需要一个PID来进行表示，但是不是所有的进程都是网络进程，所以不是所有进程都需要端口号。同时一个进程可以绑定多个端口号（就像学生在学校可以有学号，在健身房可以有会员号)，但是一个端口号不能被多个进程绑定。</strong></p> 
<p>​ <mark>为什么客户端一般不绑定一个端口呢？</mark></p> 
<p>因为一个端口只能被绑定一次。这些端口当然要优先让级服务端，由于服务端的端口不能变更，需要被其他的客户端所知。而客户端的端口不需要被其他多端知晓。</p> 
<p>​ <mark>为什么tcp/ip中的端口范围为65535？</mark></p> 
<p>在TCP/IP协议的开头，会分别有16位来存储源端口号和目标端口号，这16位所支持的数值范围即为端口范围。由于2^16-1=65535，所以端口范围为0-65535。 <mark>在新的IPV6和ipv4上的端口限制都为65535。</mark></p> 
<table><thead><tr><th>端口号</th><th>用途</th></tr></thead><tbody><tr><td>0-255</td><td>知名端口号</td></tr><tr><td>256~1023</td><td>Unix系统占用</td></tr><tr><td>1024~5000</td><td>临时端口</td></tr><tr><td>1024~49151</td><td>用户端口</td></tr><tr><td>5000~65535</td><td>服务器预留</td></tr></tbody></table> 
<blockquote> 
 <p>重要的端口</p> 
</blockquote> 
<table><thead><tr><th>译</th><th>协议</th><th>TCP端口号</th></tr></thead><tbody><tr><td>用于万维网（WWW）服务的超文本传输协议</td><td>HTTP</td><td>80</td></tr><tr><td>文件传输协议</td><td>FTP</td><td>20(数据传输)/21（发送控制命令）</td></tr><tr><td>简单邮件传输协议</td><td>SMTP</td><td>25</td></tr><tr><td>邮局协议版本3</td><td>POP3</td><td>110</td></tr><tr><td>域名服务</td><td>DNS</td><td>53</td></tr><tr><td>Telnet 服务</td><td>TELNET</td><td>23</td></tr></tbody></table> 
<hr> 
<h5><a id="133__227"></a>1.3.3 字节序</h5> 
<ul><li>Big-endian： <strong>高位</strong>字节存入<strong>低地址</strong>，<strong>低位</strong>字节存入<strong>高地址</strong></li><li>Little-endian：<strong>低位</strong>字节存入<strong>低地址</strong>，<strong>高位</strong>字节存入<strong>高地址</strong></li></ul> 
<p>将<code>12345678h</code>写入<code>1000h</code>开始的内存中，以<strong>大端序</strong>和<strong>小端序</strong>模式存放结果如下：<br> <img src="https://images2.imgbox.com/75/c5/xF9yv5jG_o.png" alt="在这里插入图片描述"></p> 
<p>一般来说，x86系列CPU都是<code>Little-endian</code>字节序，PowerPC通常是<code>Big-endian</code>字节序。</p> 
<p>​ IP是TCP/IP协议族中最为核心的协议。所有的TCP、UDP、ICMP及IGMP数据都以IP数据报格式传输。许多刚开始接触TCP/IP的人对IP提供不可靠、无连接的数据报传送服务感到很奇怪，特别是那些具有X.25或SNA背景知识的人。<br> ​ <strong>不可靠( unreliable）的意思是它不能保证IP数据报能成功地到达目的地。</strong> IP仅提供最好的传输服务。如果发生某种错误时，如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法:丢弃该数据报，然后发送ICMP消息报给信源端。任何要求的可靠性必须由上层来提供（如TCP）。<br> ​ <strong>无连接( connectionless）这个术语的意思是IP并不维护任何关于后续数据报的状态信息。</strong> 每个数据报的处理是相互独立的。这也说明，IP数据报可以不按发送顺序接收。如果一信源向相同的信宿发送两个连续的数据报（先是A，然后是B)，每个数据报都是独立地进行路由选择，可能选择不同的路线，因此B可能在A到达之前先到达。</p> 
<p>​ 4个字节的32 bit值以下面的次序传输:首先是(0～7 bit，其次8~15 bit，然后16~23 bit,最后是24~31 bit。这种传输次序称作<strong>大端（big endian）字节序</strong>。由于TCP/IP首部中所有的二进制整数在网络中传输时都要求以这种次序，因此它又称作<font face="黑体" color="#ff0000">网络字节序</font>。以其他形式存储二进制整数的机器，如小端（little endian）格式，则必须在传输数据之前把首部转换成网络字节序。</p> 
<p><mark>TCP/IP协议规定，网络数据流应采用大端字节序，即低地址存高字节，高地址存低字节。</mark></p> 
<p>​ <strong>与同一台计算机上的进程进行通信时，一般不考虑字节序。</strong> 字节序是一个处理器架构特性，用于指示像整数这样的大数据类型内部的字节如何排序。但如果涉及网络通信，那就必须考虑大小端的问题，否则对端主机识别出来的数据可能与发送端想要发送的数据是不一致的。</p> 
<p>​ TCP/IP协议栈使用大端字节序。应用程序交换格式化数据时，字节序问题就会出现。对TCP/IP，地址用网络字节序来表示，所以应用程序有时候需要在处理器的字节序与网络字节序之间进行转换。以确保数据的一致性。</p> 
<blockquote> 
 <p>​ 例如上一节的UDP段格式，地址0~1是16位的源端口号，如果这个端口号是1000（0x3e8），则地址0是0x03，地址1是0xe8，也就是先发0x03，再发0xe8，这16位在发送主机的缓冲区中也应该是低地址存0x03，高地址存0xe8。</p> 
 <p>​ 但是，如果发送主机是小端字节序的，这16位被解释成0xe803，而不是1000。因此，发送主机把1000填到发送缓冲区之前需要做字节序的转换。</p> 
 <p>​ 同样地，接收主机如果是小端字节序的，接到16位的源端口号也要做字节序的转换。如果主机是大端字节序的，发送和接收都不需要做转换。同理，32位的IP地址也要考虑网络字节序和主机字节序的问题。</p> 
</blockquote> 
<p>​ 为使网络程序具有可移植性，使同样的C代码在大端和小端计算机上编译后都能正常运行，可以调用以下库函数做网络字节序和主机字节序的转换。</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
 
<span class="token class-name">uint32_t</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> hostlong<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//返回值：以网络字节序表示的32位整数</span>
<span class="token class-name">uint16_t</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> hostshort<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回值：以网络字节序表示的16位整数</span>
<span class="token class-name">uint32_t</span> <span class="token function">ntohl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> netlong<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回值：以主机字节序表示的32位整数</span>
<span class="token class-name">uint16_t</span> <span class="token function">ntohs</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> netshort<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//返回值：以主机字节序表示的16位整数</span>
	h表示host，n表示network，l表示<span class="token number">32</span>位长整数，s表示<span class="token number">16</span>位短整数。
	如果主机是小端字节序，这些函数将参数做相应的大小端转换然后返回，如果主机是大端字节序，这些函数不做转换，将参数原封不动地返回。
</code></pre> 
<hr> 
<h5><a id="134__271"></a>1.3.4 套接字</h5> 
<p>Socket在Linux下，用于表示进程间网络通信的特殊文件类型。</p> 
<p>​ 本质为内核借助缓冲区形成的<mark>伪文件</mark>。既然是文件，那么理所当然的，我们可以<mark>使用文件描述符引用套接字</mark>。与管道类似的，Linux系统将其封装成文件的目的是为了统一接口，使得读写套接字和读写文件的操作一致 。区别是<mark>管道主要应用于本地进程间通信，而套接字多应用于网络进程间数据的传递</mark>。</p> 
<p>​ 在TCP/IP协议中，“IP地址+TCP或<a href="https://so.csdn.net/so/search?q=UDP&amp;spm=1001.2101.3001.7020">UDP</a>端口号”唯一标识网络通讯中的一个进程。“IP地址+端口号”就对应一个socket。 欲建立连接的两个进程各自有一个socket来标识，那么这两个socket组成的socket pair就唯一标识一个连接。<strong>因此可以用Socket来描述网络连接的一对一关系。</strong></p> 
<p><strong>Socket（套接字）主要用到的协议</strong></p> 
<p>​ <strong>1、TCP（面向连接）</strong> 双方必须连接成功才能发数据，类似打电话，主要用于对传输数据精确的情况，如传输指令。<br> ​ <strong>2、UDP（面向报文）</strong> 双方无须连接成功就能发数据，类似发短信，主要用于传输大数据量的情况，如视频。</p> 
<p><strong>总的来说：</strong></p> 
<ol><li><strong>IP地址最大的意义在于指导一个报文该如何进行路径选择，到哪里去就是去找目标IP地址。</strong></li><li><strong>端口号的意义在于唯一的标识一台机器上的唯一一个进程。</strong></li><li><strong>IP地址 + 端口号 = 能够标识互联网中的唯一一个进程！（也就是我们接下来讲的套接字）；</strong></li><li><strong>IP地址 + port（端口号） = socket（套接字）</strong></li></ol> 
<hr> 
<h4><a id="14__294"></a>1.4 网络应用编程模型</h4> 
<h5><a id="141_CS_296"></a>1.4.1 C/S模式</h5> 
<blockquote> 
 <p>C/S(Client/Server)也叫C/S模式，C/S架构或C/S模型。</p> 
</blockquote> 
<ul><li>胖客户端编程架构</li><li>主要工作在客户端进行</li></ul> 
<p>C/S将网络事务处理分为两个部分</p> 
<ul><li>客户端：客户端（Client，也叫客户机）用于为用户提供操作，同时向网络提供请求服务的接口；</li><li>服务端： 服务端（Server）负责接收并处理客户端发出的服务请求，并将服务处理结果返回给客户端。</li></ul> 
<p><strong>C/S即适用于实际的应用程序，又适用于真正的计算机部署。</strong></p> 
<blockquote> 
 <p>​ 从程序实现的角度来说，客户端和服务端实际是计算机上的两个进程的交互。服务端进程逐一等待并处理客户端请求。<br> ​ 运行服务端进程的计算机系统一般通过所提供的服务来命名。</p> 
 <p>​ 例如，提供邮件服务的主机称为邮件服务器，提供远程文件访问的计算机称为文件服务器等。</p> 
</blockquote> 
<p>应用：LOL等大型3D游戏（缓存数据图像，环境包等）</p> 
<ul><li> <p><strong>优点：</strong></p> 
  <ol><li><strong>协议选用灵活。</strong>（可以在标准协议的基础上根据需求裁剪及定制。例如，腾讯公司所采用的通信协议，即为ftp协议的修改剪裁版。）</li><li>将数据缓存至客户端，<strong>提高数据传输效率</strong>。</li></ol> </li><li> <p><strong>缺点：</strong></p> 
  <ol><li><strong>对用户的安全构成威胁</strong> （需要将客户端安插至用户主机上，对用户主机的安全性构成威胁。这也是很多用户不愿使用C/S模式应用程序的重要原因。）</li><li><strong>开发工作量较大，调试困难</strong>（服务器和客户端都需要团队开发）。</li></ol> </li></ul> 
<hr> 
<h5><a id="142_BS_327"></a>1.4.2 B/S模式</h5> 
<blockquote> 
 <p>B/S （Browse/Server），也叫B/S模式，B/S模型。Browse是指Web浏览器，仅使用HTTP进行通信。</p> 
</blockquote> 
<p>极少数事务在前端实现，但主要事务逻辑在服务器端实现。</p> 
<ul><li> <p><strong>优点</strong></p> 
  <ol><li>S架构客户端无需安装，有Web浏览器即可。</li><li>B/S架构可以直接放在广域网上，交互性较强。</li><li>B/S架构无需升级多个客户端，升级服务器即可。</li></ol> </li><li> <p><strong>缺点</strong></p> 
  <ol><li>在跨浏览器上，BS架构不尽如人意。</li><li>表现要达到C/S程序的程度需要花费不少精力。</li><li>在速度和安全性上需要花费巨大的设计成本。</li></ol> </li></ul> 
<blockquote> 
 <p>B/S编程模型采用三层架构设计</p> 
 <ul><li>用户界面</li><li>逻辑设计</li><li>数据支持</li></ul> 
</blockquote> 
<p><mark>B/S 和 C/S 的区别</mark></p> 
<ul><li>构建方式<br> 一个是浏览器/服务器端架构，另一个是客户端/服务器架构<br> B为浏览器，浏览器即客户端，C/S需单独设计客户端</li><li>更新维护方式<br> B/S结构维护升级比较简单，而C/S结构维护升级相对困难；</li><li>安全控制能力<br> C/S结构比B/S结构更安全，因为用户群相对固定，对信息的保护更强；</li><li>用户受众<br> C/S用户群相对固定，而B/S相对来说很广，B/S是建立在广域网上的，适应范围强。</li></ul> 
<hr> 
<h5><a id="143_CS_363"></a>1.4.3 C/S工作过程</h5> 
<blockquote> 
 <p><font face="黑体" color="#8900ff" size="5"> <strong>服务器端和客户端的工作过程</strong> </font></p> 
</blockquote> 
<ol><li>服务器首先启动监听程序，对指定的端口进行监听，等待接收客户端的连接请求。</li><li>客户端启动程序，请求连接服务器的指定端口。</li><li>服务器收到客户端的连接请求后，与客户端建立套接字连接。</li><li>连接建立成功，客户端与服务器分别打开两个流，其中客户端的输入流连接到服务器的输出流，服务器的输入流连接到客户端的输出流，两边的流连接成功后进行双向通信。</li><li>当通信完毕后，客户端和服务器两边各自断开连接。</li></ol> 
<blockquote> 
 <p><font face="黑体" color="#8900ff" size="5"><strong>建立连接和断开连接的细节</strong></font></p> 
</blockquote> 
<p><font face="黑体" color="0xaaff00" size="5"><strong>三次握手</strong></font></p> 
<blockquote> 
 <p><strong>最开始的时候客户端和服务器都是处于CLOSED状态。主动打开连接的为客户端，被动打开连接的是服务器。</strong><br> <img src="https://images2.imgbox.com/3b/2a/61ClC1tb_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a6/48/3eOlsdnY_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<ul><li>第一次握手：客户端主动打开，发送连接请求报文段，将SYN标识位置为1。</li><li>第二次握手：服务器收到SYN报文段进行确认（ACK），将SYN标识位置为1，ACK置为1，这个状态被称为半连接状态。</li><li>第三次握手：客户端再进行一次确认（ACK），将ACK置为1（此时不用SYN）。</li></ul> 
<p><mark>为什么TCP客户端最后还要发送一次确认呢？</mark></p> 
<blockquote> 
 <p>一句话，主要防止已经失效的连接请求报文突然又传送到了服务器，从而产生错误。</p> 
 <p>​ 如果使用的是两次握手建立连接，假设有这样一种场景，客户端发送了第一个请求连接并且没有丢失，只是因为在网络结点中滞留的时间太长了，由于TCP的客户端迟迟没有收到确认报文，以为服务器没有收到，此时重新向服务器发送这条报文，此后客户端和服务器经过两次握手完成连接，传输数据，然后关闭连接。此时此前滞留的那一次请求连接，网络通畅了到达了服务器，这个报文本该是失效的，但是，两次握手的机制将会让客户端和服务器再次建立连接，这将导致不必要的错误和资源的浪费。</p> 
 <p>​ 如果采用的是三次握手，就算是那一次失效的报文传送过来了，服务端接受到了那条失效报文并且回复了确认报文，但是客户端不会再次发出确认。由于服务器收不到确认，就知道客户端并没有请求连接。</p> 
</blockquote> 
<p><strong>三次握手的目的</strong></p> 
<p>​ 第一次：让服务器知道，从客户端到服务器的连接是通的。（客户端对服务器说：我想给你发数据）<br> ​ 第二次：让客户端知道，从服务器到客户端的连接是通的。（服务器对客户端说：我能收到，你发吧 — 确保上行通道）<br> ​ 第三次：让服务器知道，从服务器到客户端的连接是通的。（客户端对服务器说：我知道你收到我的请求了，那我发了 — 确保下行通道）</p> 
<p><font face="黑体" color="0xaaff00" size="5"><strong>四次挥手</strong></font></p> 
<blockquote> 
 <p>​ 数据传输完毕后，双方都可释放连接。最开始的时候，客户端和服务器都是处于ESTABLISHED状态，然后客户端主动关闭，服务器被动关闭。<br> <img src="https://images2.imgbox.com/52/9e/0sRmD9TA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4c/b7/7vap1aTo_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p><strong>四次挥手的目的</strong></p> 
<p>​ 因为对于断开链接，发送方和接收方都需要获取对方的终止信号（FIN）和对终止的确认信号（ACK），所以需要四次挥手。<br> ​ 第一次：客户端对服务器说：到点了，我要走啦。<br> ​ 第二次：服务器对客户端说：好吧，我知道你要走了。<br> ​ 第三次：服务器对客户端说：那我也走啦。<br> ​ 第四次：客户端对服务器说：好，我也知道你要走了。</p> 
<p><strong>为什么客户端最后还要等待2MSL？</strong></p> 
<blockquote> 
 <p>MSL（Maximum Segment Lifetime），TCP允许不同的实现可以设置不同的MSL值。</p> 
 <p>​ <strong>第一，保证客户端发送的最后一个ACK报文能够到达服务器</strong>，因为这个ACK报文可能丢失，站在服务器的角度看来，我已经发送了FIN+ACK报文请求断开了，客户端还没有给我回应，应该是我发送的请求断开报文它没有收到，于是服务器又会重新发送一次，而客户端就能在这个2MSL时间段内收到这个重传的报文，接着给出回应报文，并且会重启2MSL计时器。</p> 
 <p>​ <strong>第二，防止类似与“三次握手”中提到了的“已经失效的连接请求报文段”出现在本连接中</strong>。客户端发送完最后一个确认报文后，在这个2MSL时间中，就可以使本连接持续的时间内所产生的所有报文段都从网络中消失。这样新的连接中不会出现旧连接的请求报文。</p> 
</blockquote> 
<p><strong>为什么建立连接是三次握手，关闭连接确是四次挥手呢？</strong></p> 
<blockquote> 
 <p>​ 建立连接的时候， 服务器在LISTEN状态下，收到建立连接请求的SYN报文后，把ACK和SYN放在一个报文里发送给客户端。<br> ​ 而关闭连接时，服务器收到对方的FIN报文时，仅仅表示对方不再发送数据了但是还能接收数据，而自己也未必全部数据都发送给对方了，所以己方可以立即关闭，也可以发送一些数据给对方后，再发送FIN报文给对方来表示同意现在关闭连接，因此，己方ACK和FIN一般都会分开发送，从而导致多了一次。</p> 
</blockquote> 
<p><strong>如果已经建立了连接，但是客户端突然出现故障了怎么办？</strong></p> 
<blockquote> 
 <p>​ TCP还设有一个<strong>保活计时器</strong>，显然，客户端如果出现故障，服务器不能一直等下去，白白浪费资源。服务器每收到一次客户端的请求后都会重新复位这个计时器，<strong>时间通常是设置为2小时</strong>，若两小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔75秒发送一次。若一连发送10个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接。</p> 
</blockquote> 
<h5><a id="144_CS_432"></a>1.4.4 C/S编程流程</h5> 
<p><strong>服务器端的编程流程</strong></p> 
<table><thead><tr><th>step</th><th>步骤</th><th>需要的函数</th><th>TCP是否必选</th><th>UDP是否必选</th></tr></thead><tbody><tr><td>1</td><td>创建Socket套接字</td><td><code>socket();</code></td><td></td><td></td></tr><tr><td>2</td><td>设置Socket属性</td><td><code>setsockopt();</code></td><td>非必选</td><td></td></tr><tr><td>3</td><td>绑定端口</td><td><code>bind();</code></td><td></td><td></td></tr><tr><td>4</td><td>开启监听</td><td><code>listen();</code></td><td></td><td><font face="黑体" color="#ff0000">不需要</font></td></tr><tr><td>5</td><td>接受客户端发送过来<br>的连接请求</td><td><code>accept();</code></td><td></td><td><font face="黑体" color="#ff0000">不需要</font></td></tr><tr><td>6</td><td>交换数据</td><td><code>read()</code>/<code>write()</code>、<br><code>send()</code>/<code>recv()</code>、<br><code>sendto()</code>/<code>recvfrom()</code></td><td></td><td><code>sendto()</code><br><code>recvfrom()</code></td></tr><tr><td>7</td><td>处理事件</td><td>自定义函数</td><td></td><td></td></tr><tr><td>8</td><td>关闭套接字</td><td><code>close()</code></td><td></td><td></td></tr></tbody></table> 
<p><strong>客户端的编程流程</strong></p> 
<table><thead><tr><th>step</th><th>步骤</th><th>需要的函数</th><th>TCP是否必选</th><th>UDP是否必选</th></tr></thead><tbody><tr><td>1</td><td>创建套接字</td><td><code>socket();</code></td><td></td><td></td></tr><tr><td>2</td><td>设置Socket属性</td><td><code>setsockopt();</code></td><td>非必选</td><td></td></tr><tr><td>3</td><td>设置端口和ip</td><td><code>bind();</code></td><td>非必选</td><td></td></tr><tr><td>4</td><td>连接服务器</td><td><code>connect()</code></td><td></td><td><font face="黑体" color="#ff0000">不需要</font></td></tr><tr><td>5</td><td>交换数据</td><td><code>read()</code>/<code>write()</code>、<br><code>send()</code>/<code>recv()</code>、<br><code>sendto()</code>/<code>recvfrom()</code></td><td></td><td><code>sendto()</code><br><code>recvfrom()</code></td></tr><tr><td>6</td><td>处理事件</td><td>自定义函数</td><td></td><td></td></tr><tr><td>7</td><td>关闭套接字</td><td><code>close()</code></td><td></td><td></td></tr></tbody></table> 
<hr> 
<h3><a id="_463"></a>二、服务端/客服端</h3> 
<h4><a id="21_TCP_465"></a>2.1 TCP</h4> 
<blockquote> 
 <p>TCP是 Transmission Control Protocol 的缩写，即传输控制协议。</p> 
</blockquote> 
<p>​ TCP与UDP的区别相当大。它充分地实现了数据传输时的各种控制功能，可以进行丢包时重发控制，还可以对次序乱掉的分包进行顺序控制。而这些再UDP中都没有。此外，TCP作为一种面向有连接的协议，只要在确认通信对端存在时才会发生数据，从而可以控制通信流量的浪费。</p> 
<ul><li><strong>传输层协议</strong></li><li><strong>有连接</strong></li><li><strong>可靠传输</strong></li><li><strong>面向字节流</strong></li></ul> 
<blockquote> 
 <p><strong>以上或许你有很多不太了解，这里你只需要知道 <mark>UDP是无连接，TCP是有连接</mark> 的即可。阅读下文套接字编程，就可以感受的出来。</strong></p> 
</blockquote> 
<hr> 
<h5><a id="211__480"></a>2.1.1 服务端</h5> 
<h6><a id="2111__socket_482"></a>2.1.1.1 创建套接字 <code>socket()</code></h6> 
<blockquote> 
 <p>用于根据指定的地址族、数据类型和协议来分配一个套接口的描述字及其所用的资源的函数。</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span> <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{<!-- --></span>
 	@msg
        domain <span class="token operator">:</span>指明所使用的协议族
        type <span class="token operator">:</span>指定socket类型
        protocol <span class="token operator">:</span>通常赋值为 <span class="token number">0</span> ，<span class="token number">0</span>表示选择type类型对应得默认协议
    @<span class="token keyword">return</span>
        <span class="token keyword">int</span> <span class="token operator">:</span>成功时返回文件描述符，失败返回 <span class="token operator">-</span><span class="token number">1</span>，并设置errno
<span class="token punctuation">}</span>

eg<span class="token operator">:</span>
	<span class="token keyword">int</span> listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre> 
<table><thead><tr><th>domain（第一个参数）</th><th></th><th></th></tr></thead><tbody><tr><td>AF_INET</td><td>IPv4因特网域</td><td></td></tr><tr><td>AF_INET6</td><td>IPv6因特网域</td><td></td></tr><tr><td>AF_UNIX</td><td>Unix 域</td><td></td></tr><tr><td>AF_ROUTE</td><td>路由套接字</td><td></td></tr><tr><td>AF_KEYE</td><td>钥套接字</td><td></td></tr><tr><td>AF_UNSPEC</td><td>未拖定</td><td></td></tr></tbody></table> 
<table><thead><tr><th><strong>type</strong>（第二个参数）</th><th>描述</th></tr></thead><tbody><tr><td>SOCK_STREAM</td><td><strong>TCP：</strong> <mark>流式套接字</mark>提供可靠的、面向连接的通信流:它使用TCP协议，从而保证了数据传输的正确性和顺序性</td></tr><tr><td>SOCK_DGRAM</td><td><strong>UDP：</strong> <mark>数据报套接字</mark>定义了一种无连按的服，数据通过相互独立的报文进行传输， 是无序的，并且不保证是可靠，无差错的。它使用数据报协议UDP。</td></tr><tr><td>SOCK_RAW</td><td>允许程序使用低层协议，原始科接字允许对底层协议如IP或ICMP进行直接访问，功能强大但使用较为不便，主要用于一些协议的开发。</td></tr></tbody></table> 
<table><thead><tr><th>protocol（第三个参数）</th><th>描述</th></tr></thead><tbody><tr><td><strong>IPPROTO_TCP</strong></td><td>TCP传输协议</td></tr><tr><td><strong>IPPTOTO_UDP</strong></td><td>UDP 传输协议</td></tr><tr><td><strong>IPPROTO_SCTP</strong></td><td>SCTP传输协议</td></tr><tr><td><strong>IPPROTO_TIPC</strong></td><td>TIPC传输协议</td></tr></tbody></table> 
<h6><a id="2112_scoket_setscokopt_526"></a>2.1.1.2 设置scoket <code>setscokopt()</code></h6> 
<blockquote> 
 <p>用于任意类型、任意状态套接口的设置选项值。</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token function">setsockopt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span> <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">int</span> optname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>optval<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> optlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{<!-- --></span>
    @msg
        sockfd <span class="token operator">:</span>套接字描述符
    	level <span class="token operator">:</span>被设置的选项的级别
        optname <span class="token operator">:</span>指定准备设置的选项
    	<span class="token operator">*</span>optval <span class="token operator">:</span>指向存放选项待设置的新值的缓冲区。
    	optlen <span class="token operator">:</span>optval缓冲区长度。
    @<span class="token keyword">return</span>
        <span class="token keyword">int</span> <span class="token operator">:</span>成功返回<span class="token number">0</span>，失败返回<span class="token operator">-</span><span class="token number">1</span>，并设置errno
<span class="token punctuation">}</span>
eg<span class="token operator">:</span>
	

<span class="token keyword">int</span> <span class="token function">getsockopt</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">int</span> optname<span class="token punctuation">,</span>
               <span class="token keyword">void</span> <span class="token operator">*</span>optval<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>optlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<table><thead><tr><th align="left">optname选项 SOL_SOCKET</th><th>意义</th><th>类型</th></tr></thead><tbody><tr><td align="left">SO_BROADCAST</td><td>允许发送广播数据</td><td>int</td></tr><tr><td align="left">SO_DEBUG</td><td>允许调试</td><td>int</td></tr><tr><td align="left">SO_DONTROUTE</td><td>不查找路由</td><td>int</td></tr><tr><td align="left">SO_ERROR</td><td>获得套接字错误</td><td>int</td></tr><tr><td align="left">SO_KEEPALIVE</td><td>保持连接</td><td>int</td></tr><tr><td align="left">SO_LINGER</td><td>延迟关闭连接</td><td>struct linger</td></tr><tr><td align="left">SO_OOBINLINE</td><td>带外数据放入正常数据流</td><td>int</td></tr><tr><td align="left">SO_RCVBUF</td><td>接收缓冲区大小</td><td>int</td></tr><tr><td align="left">SO_SNDBUF</td><td>发送缓冲区大小</td><td>int</td></tr><tr><td align="left">SO_RCVLOWAT</td><td>接收缓冲区下限</td><td>int</td></tr><tr><td align="left">SO_SNDLOWAT</td><td>发送缓冲区下限</td><td>int</td></tr><tr><td align="left">SO_RCVTIMEO</td><td>接收超时</td><td>struct linger</td></tr><tr><td align="left">SO_SNDTIMEO</td><td>发送超时</td><td>struct linger</td></tr><tr><td align="left">SO_REUSEADDR</td><td>允许重用本地地址和端口</td><td>int</td></tr><tr><td align="left">SO_TYPE</td><td>获得套接字类型</td><td>int</td></tr><tr><td align="left">SO_BSDCOMPAT</td><td>与BSD系统兼容</td><td>int</td></tr><tr><td align="left"></td><td></td><td></td></tr></tbody></table> 
<table><thead><tr><th>SOL_SOCKET</th><th></th><th></th></tr></thead><tbody><tr><td>IP_HDRINCL</td><td>在数据包中包含IP首部</td><td>int</td></tr><tr><td>IP_OPTINOS</td><td>IP首部选项</td><td>int</td></tr><tr><td>IP_TOS</td><td>服务类型</td><td></td></tr><tr><td>IP_TTL</td><td>生存时间</td><td>int</td></tr><tr><td></td><td></td><td></td></tr></tbody></table> 
<table><thead><tr><th>IPPRO_TCP</th><th></th><th></th></tr></thead><tbody><tr><td>TCP_MAXSEG</td><td>TCP最大数据段的大小</td><td>int</td></tr><tr><td>TCP_NODELAY</td><td>不使用Nagle算法</td><td>int</td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></tbody></table> 
<h6><a id="2113_IP_bind_590"></a>2.1.1.3 绑定IP、端口 <code>bind()</code></h6> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span> <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{<!-- --></span>
    @msg
        sockfd <span class="token operator">:</span> 一个socket描述符，由<span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>调用返回
    	<span class="token operator">*</span>addr <span class="token operator">:</span>是一个指向包含有本机IP地址及端口号等信息的sockaddr类型的指针，指向要绑定给sockfd的协议地址结构，这个地址结构根据地址创建，socket时的地址协议族的不同而不同。
    	addrlen <span class="token operator">:</span>第二个参数中结构体的大小，一般用<span class="token keyword">sizeof</span>计算
    @<span class="token keyword">return</span>
        <span class="token keyword">int</span> <span class="token operator">:</span>成功返回<span class="token number">0</span>，失败返回<span class="token operator">-</span><span class="token number">1</span>，并设置errno
<span class="token punctuation">}</span>
eg：
    <span class="token comment">// 绑定ip和端口等信息</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ser_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ser_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr</span>		<span class="token comment">// IPV4</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">sa_family_t</span> sa_family<span class="token punctuation">;</span>
    <span class="token keyword">char</span> 		sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 因特网类型		使用时要强制转换</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">sa_family_t</span> sin_family<span class="token punctuation">;</span>    <span class="token comment">// 协议族</span>
    in_port t sin_port<span class="token punctuation">;</span>        <span class="token comment">// 端口号</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span>   <span class="token comment">// IP地址结构体</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 填充 没有实际意义，只是为跟sockaddh结构在内存中对齐这样两者才能相互转换</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="2114_listen_627"></a>2.1.1.4 建立监听<code>listen()</code></h6> 
<blockquote> 
 <p>listen函数使用主动连接套接口变为被连接套接口，使得一个进程可以接受其它进程的请求，从而成为一个服务器进程。在TCP服务器编程中listen函数把进程变为一个服务器，并指定相应的套接字变为被动连接。</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span> <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{<!-- --></span>
    @msg
        sockfd <span class="token operator">:</span>由于系统默认时认为一个套接字是主动连接的，所以需要通过某种方式来告诉系统，用户进程通过系统调用listen来完成这件事。
        backlog <span class="token operator">:</span>是侦听队列的长度<span class="token punctuation">,</span>它的作用在于处理可能同时出现的几个连接请求。
        <span class="token comment">//DoS(拒绝服务)攻击即利用了这个原理，非法的连接占用了全部的连接数，造成正常的连接请求被拒绝。</span>
    @<span class="token keyword">return</span>
        <span class="token keyword">int</span> <span class="token operator">:</span>成功返回<span class="token number">0</span>，失败返回<span class="token operator">-</span><span class="token number">1</span>，并设置errno
<span class="token punctuation">}</span>

ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<h6><a id="2115__accept_650"></a>2.1.1.5 连接 <code>accept</code></h6> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span> <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{<!-- --></span>
 	@msg
        sockfd <span class="token operator">:</span> 监听套接字 
        <span class="token operator">*</span>addr <span class="token operator">:</span> 对方地址
        <span class="token operator">*</span>addrlen：地址长度
         <span class="token comment">//如果不关心对方的ip和端口等 addr 和 addrlen写成NULL</span>
         <span class="token comment">//如果要关心：再用一个 Internet协议地址结构； struct sockaddr_in 类型变量保存，然后再使用</span>
    @<span class="token keyword">return</span>
         <span class="token keyword">int</span> <span class="token operator">:</span> 成功时返回连接套接字<span class="token punctuation">,</span>失败时返回<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>并设置errno
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2115__671"></a>2.1.1.5 交换数据</h6> 
<pre><code class="prism language-c"></code></pre> 
<h6><a id="2116__676"></a>2.1.1.6 处理事件</h6> 
<h6><a id="2117__680"></a>2.1.1.7 关闭套接字</h6> 
<pre><code class="prism language-c"><span class="token function">close</span><span class="token punctuation">(</span>socketfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="212__688"></a>2.1.2 客户端</h5> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span> <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIZE</span> <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">!=</span> argc<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Usage: &lt;%s&gt; &lt;IP&gt; &lt;PORT&gt;\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token comment">//创建通信套结字 ：注意：客户端 没有监听，创建的套结字直接就是通信套结字</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> connfd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//以下填充的是 要连接的服务器ip 和端口等信息</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">1</span></span></span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serveraddr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>sin_family <span class="token operator">=</span> PF_INET<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serveraddr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    serveraddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    serveraddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    serveraddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token comment">//连接服务器</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serveraddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">connect</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serveraddr<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//主动连接服务器</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//通信</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">write</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// sleep(1);</span>
        <span class="token function">read</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// write(STDOUT_FILENO, buf,strlen(buf)); //等同于 printf 输出到屏幕</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//关闭套结字</span>
    <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="223__758"></a>2.2.3 并发服务器</h5> 
<p>多个客户端需要处理，请求可能同时到来可运用循环服务器和并发服务器。</p> 
<ul><li> <p>循环服务器：一次处理每个客户端，知到当前客户端的所有请求处理完成，再处理下一个客户端。</p> </li><li> <p>并发服务器：思想：多任务处理机制（多线程或多进程）</p> 
  <blockquote> 
   <p>分别给每个客户端创建一个任务来处理，极大提高了服务器的并发处理能力。</p> 
  </blockquote> </li></ul> 
<h6><a id="2231__768"></a>2.2.3.1 多进程并发服务器</h6> 
<p>父进程创建连接、子进程负责与客户端的数据交互</p> 
<p>每来一个客户端建立连接之后，会常见子进程来负责数据的交互</p> 
<p>子进程资源释放：使用信号进行异步处理</p> 
<p>​ 子进程退出时会给父进程发送SIGCHLD</p> 
<p>​ 捕捉SIGCHLD信号，进行处理需要实现信号处理函数</p> 
<p>不足：每个进程都需要单独分配内存空间，客户端越多，则进程越多，就会消耗更多的资源，进程之间的协同需要进程建通讯</p> 
<p>文件描述符浪费情况：在fork之后子进程不需要监听套接字，父进程不需要客户端套接字，将不需要的文件描述符要关闭掉</p> 
<pre><code class="prism language-c"><span class="token comment">/**************************************************************
 * File Name     : pthr_TCP_server.c
 * Creat Time    : 2022年11月15日 星期二 14时44分53秒
 * 备注          : 
 ***************************************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">conn</span><span class="token punctuation">(</span><span class="token keyword">int</span> conn<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">signaled</span><span class="token punctuation">(</span><span class="token keyword">int</span> sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">server_init</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  
	<span class="token keyword">int</span> conn_fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> caddr<span class="token punctuation">;</span>
	<span class="token class-name">socklen_t</span> clen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>caddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">signal</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> signaled<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token function">server_init</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">6666</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		conn_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>caddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>conn_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>caddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>caddr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\e[1;32m客户端（%s:%d）已连接！\e[0m\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>pid<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">conn</span><span class="token punctuation">(</span>conn_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>caddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">close</span><span class="token punctuation">(</span>conn_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">server_init</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>listenfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"创建成功！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setsockopt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> listenaddr <span class="token operator">=</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>sin_family 	<span class="token operator">=</span> AF_INET<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>sin_port 		<span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> 
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>listenaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>listenaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"绑定成功！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> backlog<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"等待客户端连接。。。。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> listenfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">signaled</span><span class="token punctuation">(</span><span class="token keyword">int</span> sign<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sign <span class="token operator">==</span> SIGCHLD<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"清理僵尸进程...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>WNOHANG<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">conn</span><span class="token punctuation">(</span><span class="token keyword">int</span> conn<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span>user<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">time_t</span> now<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">tm</span> <span class="token operator">*</span>date<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>user<span class="token operator">-&gt;</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>user<span class="token operator">-&gt;</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token function">time</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
		date <span class="token operator">=</span> <span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> BUFSIZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\e[31m客户端(%s:%d) \e[36m%02d:%02d:%02d \e[31m已断开\e[0m\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> port<span class="token punctuation">,</span> date<span class="token operator">-&gt;</span>tm_hour<span class="token punctuation">,</span> date<span class="token operator">-&gt;</span>tm_min<span class="token punctuation">,</span> date<span class="token operator">-&gt;</span>tm_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\e[32m%s:%d \e[36m%02d:%02d:%02d \e[1;33m&lt;--\e[0m%s"</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span>port<span class="token punctuation">,</span> date<span class="token operator">-&gt;</span>tm_hour<span class="token punctuation">,</span> date<span class="token operator">-&gt;</span>tm_min<span class="token punctuation">,</span> date<span class="token operator">-&gt;</span>tm_sec<span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-reEH0h49-1669028155413)(05_网络编程.assets/image-20221115175610071.png)]</p> 
<h6><a id="2232__913"></a>2.2.3.2 多线程并发服务器</h6> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span> <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/ip.h&gt;</span> <span class="token comment">/* superset of previous */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SERV_ip</span> <span class="token string">"0"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SERV_PORT</span> <span class="token expression"><span class="token number">6666</span></span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">do_client</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">server_init</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>ip<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>
    listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> listenfd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> saddr<span class="token punctuation">;</span>
    saddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    saddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    saddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>saddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>saddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// goto  ERROR_STEM;</span>
    <span class="token punctuation">}</span>
    <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> listenfd<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
    ERROR_STEM<span class="token operator">:</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

<span class="token comment">//多进程服务器</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> connfd<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>
    listenfd <span class="token operator">=</span> <span class="token function">server_init</span><span class="token punctuation">(</span>SERV_ip<span class="token punctuation">,</span> SERV_PORT<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> listenfd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"server_init "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wait for connect......\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"connnect a client!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//每连接一个客户，开线程：主线程负责监听； 子线程 负责通信</span>
        <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> do_client<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建子线程</span>
        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>                                   <span class="token comment">//线程资源回收</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">do_client</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// memset(buf, 0, sizeof(buf));</span>
        <span class="token function">bzero</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client quit\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv:%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2233_IO_1024"></a>2.2.3.3 IO多路复用并发服务器</h6> 
<blockquote> 
 <p>​ 5种IO模型分别是阻塞IO模型、非阻塞IO模型、IO复用模型、信号驱动的IO模型、异步IO模型；前4种为同步IO操作，只有异步IO模型是异步IO操作。</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span> <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">server_init</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>ipaddr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> port<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span> <span class="token comment">//初始化服务器</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/********************************************
     AF_INET             IPv4 Internet protocols
     SOCK_STREAM         string socket
     0
    *********************************************/</span>
    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> sockfd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sockfd=%d\n"</span><span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*************************************************************
    Internet协议地址结构“ /usr/include/netinet/in.h”
        struct sockaddr_in
        {
            u_short sin_family;			// 地址族, AF_INET，2 bytes
            u_short sin_port;			// 端口，2 bytes
            struct in_addr sin_addr;	// IPV4地址，4 bytes
            char sin_zero[8];			// 8 bytes unused，作为填充
        };
        struct in_addr{
            in_addr_t  s_addr;			// u32 network address
        };
    ****************************************************************/</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> saddr<span class="token punctuation">;</span>         <span class="token comment">//定义Internet地址结构变量，保存服务器的ip及port</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>saddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>saddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bzero</span>

    saddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>   <span class="token comment">//指定网络协议 IPV4</span>
    saddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//指定服务器的端口号 &gt;=5001,由主机序转网络字节序</span>

    <span class="token comment">// INADDR_ANY:任意ip地址</span>
    saddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> ipaddr<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//指定服务器的ip地址，ip地址由点分式转32为无符号网络字节序</span>

    <span class="token class-name">socklen_t</span> slen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>saddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//将服务器的ip和port与sockfd绑定</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>saddr<span class="token punctuation">,</span> slen<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> ERR_STEMP<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bind success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// sockfd变为监听套接字</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> ERR_STEMP<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> sockfd<span class="token punctuation">;</span>

ERR_STEMP<span class="token operator">:</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">server_init</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化服务器</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> sockfd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server_init error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"listen....\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> caddr<span class="token punctuation">;</span> <span class="token comment">//保存客户端的ip及port</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>caddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>caddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">socklen_t</span> clen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>caddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
	<span class="token comment">//int rws = accept(sockfd,NULL, NULL);//rws用于和客户端通信</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token keyword">int</span> rws <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>caddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// rws用于和客户端通信</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> rws<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"rws=%d\n"</span><span class="token punctuation">,</span> rws<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIZE</span> <span class="token expression"><span class="token number">128</span></span></span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">//使用IO多路复用解决阻塞问题</span>
    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> pollfd<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>pollfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pollfd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pollfd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token comment">//将标准输入添加到集合</span>
    pollfd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span> <span class="token comment">//指定文件描述符的读事件</span>

    pollfd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> rws<span class="token punctuation">;</span> <span class="token comment">//将rws添加到集合</span>
    pollfd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>

    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">//指定监测的文件描述符的个数</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>pollfd<span class="token punctuation">,</span> count<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"poll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pollfd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">==</span> POLLIN<span class="token punctuation">)</span> <span class="token comment">//判断标准输入文件描述符是否准备就绪</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//读标准输入</span>
            ret <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>rws<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//给客户端发送消息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pollfd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">==</span> POLLIN<span class="token punctuation">)</span> <span class="token comment">//判断rws是否准备就绪</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>rws<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//读取客户端发送的消息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span> <span class="token comment">//客户端关闭</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client closed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">close</span><span class="token punctuation">(</span>pollfd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pollfd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//文件描述符指定为-1时，表示当前文件描述符无效</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
                <span class="token function">fputs</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="224_UNIX_1188"></a>2.2.4 本地通信<code>UNIX</code></h5> 
<blockquote> 
 <p>服务器</p> 
</blockquote> 
<table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>(1) 创建套接字 – socket ( )</td><td></td><td></td></tr><tr><td>(2) 填充服务器本地信息结构体 – sockaddr_un</td><td></td><td></td></tr><tr><td>(3) 将套接字与服务器本地结构体绑定 – bind ( )</td><td></td><td></td></tr><tr><td>(4) 将套接字设置为被动监听状态 – listen ( )</td><td></td><td></td></tr><tr><td>(5) 阻塞等待客户端的连接请求 – accept ( )</td><td></td><td></td></tr><tr><td>(6) 进行通信 – recv ( ) / send ( ) 或 read ( ) / write ( )</td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></tbody></table> 
<blockquote> 
 <p>客户端</p> 
</blockquote> 
<table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>(1) 创建套接字 – socket ( )</td><td></td><td></td></tr><tr><td>(2) 填充服务器本地信息结构体 – sockaddr_un</td><td></td><td></td></tr><tr><td>(3) 将套接字与服务器本地结构体绑定 – bind ( )</td><td></td><td></td></tr><tr><td>(4) 将套接字设置为被动监听状态 – listen ( )</td><td></td><td></td></tr><tr><td>(5) 阻塞等待客户端的连接请求 – accept ( )</td><td></td><td></td></tr><tr><td>(6) 进行通信 – recv ( ) / send ( ) 或 read ( ) / write ( )</td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></tbody></table> 
<h4><a id="22_UDP_1216"></a>2.2 UDP</h4> 
<h5><a id="221__1218"></a>2.2.1 广播服务器</h5> 
<blockquote> 
 <p>发送者</p> 
</blockquote> 
<table><thead><tr><th>setp</th><th></th><th></th></tr></thead><tbody><tr><td>1</td><td>创建套接字</td><td>socket ( )</td></tr><tr><td>2</td><td>设置为允许发送广播权限</td><td>setsockopt ( )</td></tr><tr><td>3</td><td>填充广播信息结构体</td><td>sockaddr_in</td></tr><tr><td>4</td><td>发送数据</td><td>sendto ( )</td></tr><tr><td></td><td></td><td></td></tr></tbody></table> 
<blockquote> 
 <p>接收者</p> 
</blockquote> 
<table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>(1) 创建套接字 – socket ( )</td><td></td><td></td></tr><tr><td>(2) 填充广播信息结构体 – sockaddr_in</td><td></td><td></td></tr><tr><td>(3) 将套接字与广播信息结构体绑定 – bind ( )</td><td></td><td></td></tr><tr><td>(4) 接收数据 – recvfrom ( )</td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></tbody></table> 
<pre><code class="prism language-c"></code></pre> 
<h5><a id="222__1245"></a>2.2.2 组播服务器</h5> 
<blockquote> 
 <p>发送者</p> 
</blockquote> 
<table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>(1) 创建套接字 – socket ( )</td><td></td><td></td></tr><tr><td>(2) 填充组播信息结构体 – sockaddr_in</td><td></td><td></td></tr><tr><td>(3) 发送数据 – sendto ( )</td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></tbody></table> 
<blockquote> 
 <p>接收者</p> 
</blockquote> 
<table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>(1) 创建套接字 – socket ( )</td><td></td><td></td></tr><tr><td>(2) 填充组播信息结构体 – sockaddr_in</td><td></td><td></td></tr><tr><td>(3) 将套接字与组播信息结构体绑定 – bind ( )</td><td></td><td></td></tr><tr><td>(4) 设置为加入多播组 – setsockopt ( )</td><td></td><td></td></tr><tr><td>(5) 接收数据 – recvfrom ( )</td><td></td><td></td></tr></tbody></table> 
<h3><a id="_1269"></a>三、轻量级数据库</h3> 
<h4><a id="31_sqlite3_1271"></a>3.1 安装sqlite3</h4> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> sqlite3			<span class="token comment">#安装SQLite3</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libsqlite3-dev 	<span class="token comment">#安装Sqlite3编译需要的工具包</span>
sqlite3 <span class="token parameter variable">-version</span> 	<span class="token comment">#查看版本</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> sqlitebrowser 		<span class="token comment">#安装图形界面</span>
sqlitebrowser 		<span class="token comment">#打开图形化界面</span>

<span class="token function">sudo</span> dpkg <span class="token parameter variable">-i</span> *.deb 	<span class="token comment">#离线安装</span>

</code></pre> 
<blockquote> 
 <p><a href="https://blog.csdn.net/gymaisyl/article/details/108462433">版本依赖问题解决</a></p> 
</blockquote> 
<h4><a id="32__1286"></a>3.2 系统命令</h4> 
<blockquote> 
 <p>终端界面输入 sqlite3 进入</p> 
</blockquote> 
<p>进入之后可正常输入命令，如果出现<code>...&gt;</code>的模式，用<kbd>CTRL</kbd> + <kbd>D</kbd> 结束，或者<kbd>CTRL</kbd> + <kbd>Z</kbd>。</p> 
<pre><code class="prism language-sqlite">以‘.’（点）开头的命令
.help	帮助
.quit	退出
.exit	退出
.schema	查看标的结构图
.databases	查看打开的数据库
.table	查看表
</code></pre> 
<h4><a id="33_sql_1302"></a>3.3 sql命令</h4> 
<blockquote> 
 <p>不以 <code>.</code><u>（点）</u>开头，但是需要以 <code>;</code><u>（分号）</u>结尾；</p> 
</blockquote> 
<ol><li>创建一张数据的表</li></ol> 
<pre><code class="prism language-sqlite">create table student(no Integer，name char，score float);
	数据类型：
		Integer 整型
		char 字符串，也可以用string
		...
</code></pre> 
<ol start="2"><li> <p>插入一条数据</p> 
  <blockquote> 
   <p>完整数据插入：</p> 
  </blockquote> <pre><code class="prism language-sqlite">insert into student values(1, ‘zhangsan', 80);                        
insert into 表名 values(成员1, 成员2, 成员3, ...);                 

/*字符串zhangsan既可以用单引号‘zhangsan’，也可以用双引号“zhangsan”；*/
</code></pre> 
  <blockquote> 
   <p>部分数据插入</p> 
  </blockquote> <pre><code class="prism language-sqlite">insert into student （no，name） values(2, 'lisi');
insert into student （字段1，字段2） values(字段1的值, 字段2的值);
</code></pre> </li><li> <p>查询记录</p> 
  <blockquote> 
   <p>完整数据查询</p> 
  </blockquote> <pre><code class="prism language-sqlite">select * from student；
</code></pre> 
  <blockquote> 
   <p>部分数据查询</p> 
  </blockquote> <pre><code class="prism language-sqlite">select no，name from student；
</code></pre> 
  <blockquote> 
   <p>按照条件查询</p> 
  </blockquote> <pre><code class="prism language-sqlite">select * from student where score=100；
select * from student where no=1 and score=100；
select * from student where no=1 or score=100；
</code></pre> </li><li> <p>删除记录</p> 
  <blockquote> 
   <p>删除某一条记录</p> 
  </blockquote> <pre><code class="prism language-sqlite">delete from student where name='lisi';
</code></pre> 
  <blockquote> 
   <p>删除整张表数据</p> 
  </blockquote> <pre><code class="prism language-sqlite">delete from student;
</code></pre> </li><li> <p>更新记录</p> <pre><code class="prism language-sqlite">update student set name=‘lisi’ where id=3；
update student set name='lisi',score=80 where id=2;
update student set 要修改的字段 where 要查询的字段;
</code></pre> </li><li> <p>在表中增加一列</p> <pre><code class="prism language-sqlite">alter table student add column address char
</code></pre> </li><li> <p>在表中删除一列（不支持直接删一列）</p> </li><li> <p>删除原有的表格</p> <pre><code class="prism language-sqlite">drop table student;
</code></pre> </li><li> <p>将新的表格名字改为原有表的名字</p> <pre><code class="prism language-sqlite">alter table stu rename to student;
</code></pre> </li><li> <p>创建一个新的表并从原有表中提取字段</p> </li></ol> 
<pre><code class="prism language-sqlite">create table stu as select id, name, score from student;
</code></pre> 
<h4><a id="34_sqlite3_1404"></a>3.4 sqlite3函数接口</h4> 
<blockquote> 
 <p>打开数据库</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">sqlite3_open</span><span class="token punctuation">(</span>		  <span class="token comment">/* 功能：打开一个数据库 */</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span>   <span class="token comment">/* Database filename (UTF-8) 要操作的数据库文件的路径；*/</span>
  sqlite3 <span class="token operator">*</span><span class="token operator">*</span>ppDb          <span class="token comment">/* OUT: SQLite db handle */</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{<!-- --></span>
    @msg
        <span class="token operator">*</span>filename：	代表数据库的路径名；
        <span class="token operator">*</span><span class="token operator">*</span>ppdb：		代表数据库的操作句柄（指针）；
    @<span class="token keyword">return</span>
    	成功<span class="token operator">-</span>SQLITE_OK，出错<span class="token operator">-</span>错误码；
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>关闭数据库</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">sqlite3_close</span><span class="token punctuation">(</span>sqlite3 <span class="token operator">*</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* 功能：关闭数据库 */</span>
<span class="token punctuation">{<!-- --></span>
	@msg
		db	：操作数据库的句柄；
	@<span class="token keyword">return</span>
		成功<span class="token operator">-</span>SQLITE_OK，出错<span class="token operator">-</span>错误码；
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>获得操作的错误信息</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">sqlite3_errmsg</span><span class="token punctuation">(</span>sqlite3 <span class="token operator">*</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* 功能：通过db句柄，得到数据库操作的错误信息 */</span>
<span class="token punctuation">{<!-- --></span>
	@msg
		db	：操作数据库的句柄；
	@<span class="token keyword">return</span>
		成功<span class="token operator">-</span>错误信息的首地址，出错<span class="token operator">-</span>错误码；
<span class="token punctuation">}</span>
返回值：错误信息的首地址；
</code></pre> 
<blockquote> 
 <p>执行sql语句</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">sqlite3_exec</span><span class="token punctuation">(</span>	<span class="token comment">/* 执行一条sql语句；*/</span>
  sqlite3<span class="token operator">*</span><span class="token punctuation">,</span>                                  <span class="token comment">/* An open database */</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sql<span class="token punctuation">,</span>                           <span class="token comment">/* SQL to be evaluated */</span>
  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>callback<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">/* Callback function */</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span>                                    <span class="token comment">/* 1st argument to callback */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>errmsg                              <span class="token comment">/* Error msg written here */</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{<!-- --></span>
    @msg：
        db	：数据库操作句柄；
        sql	：一条sql语句；
        callback：只有sql为查询语句的时候，才会执行此语句；
        arg	：给回调函数callback传递参数；
        errmsg	：错误消息
    @<span class="token keyword">return</span>
    	成功<span class="token operator">-</span>SQLITE_OK，出错<span class="token operator">-</span>错误码；
<span class="token punctuation">}</span>

<span class="token comment">//实例</span>
<span class="token function">strcpy</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token string">"create table student(no int, name char, score float);"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">sqlite3_exec</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> sql<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>errmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> SQLITE_OK<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"create:%s\n"</span><span class="token punctuation">,</span> <span class="token function">sqlite3_errmsg</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre> 
<blockquote> 
 <p>回调函数</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token comment">/* Callback function */</span>
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>callback<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>parg<span class="token punctuation">,</span> <span class="token keyword">int</span> f_num<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>f_value<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>f_name<span class="token punctuation">)</span><span class="token punctuation">;</span>	
功能：查询的结果，是一个函数指针类型，传递一个函数名即可。
<span class="token punctuation">{<!-- --></span>
    @msg
        <span class="token operator">*</span>para	：传递给回调函数的参数；
        f_num	：记录中包含的字段数目；
        <span class="token operator">*</span><span class="token operator">*</span>f_value	：包含每个字段值的指针数组；
        <span class="token operator">*</span><span class="token operator">*</span>f_name	：包含每个字段名称的指针数组
    @<span class="token keyword">return</span>
    	成功返回<span class="token number">0</span>，失败返回<span class="token operator">-</span><span class="token number">1</span>；
<span class="token punctuation">}</span>

<span class="token comment">//回调函数示例</span>
<span class="token keyword">int</span> <span class="token function">callfun</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>parg<span class="token punctuation">,</span> <span class="token keyword">int</span> f_num<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>f_value<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>f_name<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"----------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>f_num<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s:%s\n"</span><span class="token punctuation">,</span> f_name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>f_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//这句话很重要，不加就会出错</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>数据查询</p> 
</blockquote> 
<pre><code class="prism language-C">查询数据：
int sqlite3_get_table(
  sqlite3 *db,          /* An open database */
  const char *zSql,     /* SQL to be evaluated */
  char ***pazResult,    /* Results of the query */
  int *pnRow,           /* Number of result rows written here */
  int *pnColumn,        /* Number of result columns written here */
  char **pzErrmsg       /* Error msg written here */
);
功能，查询表中数据
参数：
	*db	：数据库操作句柄
	*zSql	：查询的sql语句
	***pazResult	：查询结果的返回地址；
	*pnRow	：满足条件的记录数目（表中的行数）
	*pnColumn：每条记录包含的字段数目（表中的列数）
	**pzErrmsg：错误信息指针的地址；
返回值：成功返回0，失败返回错误码。
    
ret = sqlite3_get_table(db, cmd, &amp;data, &amp;row, &amp;col, &amp;errmsg);
//错误判断
//数据被存在data的二级指针指向的地址中，存放是将记录中的每个字段数据依次存放
</code></pre> 
<p>void sqlite3_free_table(char **result);</p> 
<blockquote> 
 <p>查看错误信息</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">sqlite3_errmsg</span><span class="token punctuation">(</span>sqlite3 <span class="token operator">*</span>db<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    @msg
    	<span class="token operator">*</span>db	：数据库操作句柄
    @<span class="token keyword">return</span>
        <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">:</span>错误信息
<span class="token punctuation">}</span>


<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"create:%s\n"</span><span class="token punctuation">,</span> <span class="token function">sqlite3_errmsg</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<hr> 
<hr> 
<p>{<!-- --><br> printf(“create:%s\n”, sqlite3_errmsg(db));<br> exit(-1);<br> }</p> 
<pre><code>
&gt; 回调函数

~~~c
/* Callback function */
int (*callback)(void *parg, int f_num, char **f_value, char **f_name);	
功能：查询的结果，是一个函数指针类型，传递一个函数名即可。
{
    @msg
        *para	：传递给回调函数的参数；
        f_num	：记录中包含的字段数目；
        **f_value	：包含每个字段值的指针数组；
        **f_name	：包含每个字段名称的指针数组
    @return
    	成功返回0，失败返回-1；
}

//回调函数示例
int callfun(void *parg, int f_num, char **f_value, char **f_name)
{
    printf("----------------\n");
    for(int i = 0;i&lt;f_num;i++)
    {
        printf("%s:%s\n", f_name[i],f_value[i]);
    }
    return 0;	//这句话很重要，不加就会出错
}
</code></pre> 
<blockquote> 
 <p>数据查询</p> 
</blockquote> 
<pre><code class="prism language-C">查询数据：
int sqlite3_get_table(
  sqlite3 *db,          /* An open database */
  const char *zSql,     /* SQL to be evaluated */
  char ***pazResult,    /* Results of the query */
  int *pnRow,           /* Number of result rows written here */
  int *pnColumn,        /* Number of result columns written here */
  char **pzErrmsg       /* Error msg written here */
);
功能，查询表中数据
参数：
	*db	：数据库操作句柄
	*zSql	：查询的sql语句
	***pazResult	：查询结果的返回地址；
	*pnRow	：满足条件的记录数目（表中的行数）
	*pnColumn：每条记录包含的字段数目（表中的列数）
	**pzErrmsg：错误信息指针的地址；
返回值：成功返回0，失败返回错误码。
    
ret = sqlite3_get_table(db, cmd, &amp;data, &amp;row, &amp;col, &amp;errmsg);
//错误判断
//数据被存在data的二级指针指向的地址中，存放是将记录中的每个字段数据依次存放
</code></pre> 
<p>void sqlite3_free_table(char **result);</p> 
<blockquote> 
 <p>查看错误信息</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">sqlite3_errmsg</span><span class="token punctuation">(</span>sqlite3 <span class="token operator">*</span>db<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    @msg
    	<span class="token operator">*</span>db	：数据库操作句柄
    @<span class="token keyword">return</span>
        <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">:</span>错误信息
<span class="token punctuation">}</span>


<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"create:%s\n"</span><span class="token punctuation">,</span> <span class="token function">sqlite3_errmsg</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<hr> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_0" rel="nofollow">网络编程</a></li><li><ul><li><a href="#InternetTCPIP_2" rel="nofollow">一、Internet与TCP/IP协议</a></li><li><ul><li><a href="#11_OSI_10" rel="nofollow">1.1 OSI</a></li><li><a href="#12_TCPIP_42" rel="nofollow">1.2 TCP/IP</a></li><li><a href="#13__87" rel="nofollow">1.3 网络的术语</a></li><li><ul><li><a href="#131__89" rel="nofollow">1.3.1 互联网的地址</a></li><li><a href="#132__172" rel="nofollow">1.3.2 端口</a></li><li><a href="#133__227" rel="nofollow">1.3.3 字节序</a></li><li><a href="#134__271" rel="nofollow">1.3.4 套接字</a></li></ul> 
    </li><li><a href="#14__294" rel="nofollow">1.4 网络应用编程模型</a></li><li><ul><li><a href="#141_CS_296" rel="nofollow">1.4.1 C/S模式</a></li><li><a href="#142_BS_327" rel="nofollow">1.4.2 B/S模式</a></li><li><a href="#143_CS_363" rel="nofollow">1.4.3 C/S工作过程</a></li><li><a href="#144_CS_432" rel="nofollow">1.4.4 C/S编程流程</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_463" rel="nofollow">二、服务端/客服端</a></li><li><ul><li><a href="#21_TCP_465" rel="nofollow">2.1 TCP</a></li><li><ul><li><a href="#211__480" rel="nofollow">2.1.1 服务端</a></li><li><ul><li><a href="#2111__socket_482" rel="nofollow">2.1.1.1 创建套接字 `socket()`</a></li><li><a href="#2112_scoket_setscokopt_526" rel="nofollow">2.1.1.2 设置scoket `setscokopt()`</a></li><li><a href="#2113_IP_bind_590" rel="nofollow">2.1.1.3 绑定IP、端口 `bind()`</a></li><li><a href="#2114_listen_627" rel="nofollow">2.1.1.4 建立监听`listen()`</a></li><li><a href="#2115__accept_650" rel="nofollow">2.1.1.5 连接 `accept`</a></li><li><a href="#2115__671" rel="nofollow">2.1.1.5 交换数据</a></li><li><a href="#2116__676" rel="nofollow">2.1.1.6 处理事件</a></li><li><a href="#2117__680" rel="nofollow">2.1.1.7 关闭套接字</a></li></ul> 
     </li><li><a href="#212__688" rel="nofollow">2.1.2 客户端</a></li><li><a href="#223__758" rel="nofollow">2.2.3 并发服务器</a></li><li><ul><li><a href="#2231__768" rel="nofollow">2.2.3.1 多进程并发服务器</a></li><li><a href="#2232__913" rel="nofollow">2.2.3.2 多线程并发服务器</a></li><li><a href="#2233_IO_1024" rel="nofollow">2.2.3.3 IO多路复用并发服务器</a></li></ul> 
     </li><li><a href="#224_UNIX_1188" rel="nofollow">2.2.4 本地通信`UNIX`</a></li></ul> 
    </li><li><a href="#22_UDP_1216" rel="nofollow">2.2 UDP</a></li><li><ul><li><a href="#221__1218" rel="nofollow">2.2.1 广播服务器</a></li><li><a href="#222__1245" rel="nofollow">2.2.2 组播服务器</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_1269" rel="nofollow">三、轻量级数据库</a></li><li><ul><li><a href="#31_sqlite3_1271" rel="nofollow">3.1 安装sqlite3</a></li><li><a href="#32__1286" rel="nofollow">3.2 系统命令</a></li><li><a href="#33_sql_1302" rel="nofollow">3.3 sql命令</a></li><li><a href="#34_sqlite3_1404" rel="nofollow">3.4 sqlite3函数接口</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a8f103cc94fa3e8fa890ee56476f8074/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">报错 -bash: wget: command not found</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b3d4065abe790cac3f944846909658fa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">本地上传到服务器的视频不能在线播放怎么办？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>