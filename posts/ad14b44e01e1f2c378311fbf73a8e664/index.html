<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>FPGA入门（5）：控制LED灯 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="FPGA入门（5）：控制LED灯" />
<meta property="og:description" content="文章目录 第17讲：触摸按键控制LED灯第18讲：流水灯第19讲：呼吸灯第20讲：状态机第21讲：无源蜂鸣器驱动实验 第17讲：触摸按键控制LED灯 触摸按键可分为四大类：电阻式、电容式、红外感应式、表面声波式
电容式触摸按键主要由按键IC部分和电容部分构成；按键IC用于将电容的变化转换为电信号；电容部分指的是由电容极板、地、隔离区等组成触摸按键的电容环境。
模块绘制
波形图绘制：按键未按下时保持高电平，按键按下保持低电平；按下时间与低电平保持时间相同，松开按键返回高电平
使用按键下降沿控制灯的点亮和熄灭
touch_ctrl_led.v
`timescale 1ns/1ns module touch_ctrl_led ( input wire sys_clk , //系统时钟，频率50MHz input wire sys_rst_n , //复位信号，低电平有效 input wire touch_key , //触摸按键信号 output reg led //led输出信号 ); //wire define wire touch_flag ; //触摸使能信号 //reg define reg touch_key_dly1 ; //touch_key延迟一个时钟信号 reg touch_key_dly2 ; //touch_key延迟两个时钟信号 //对touch_key信号延迟两个时钟周期用来产生触摸按键信号 always@(posedge sys_clk or negedge sys_rst_n) if(sys_rst_n == 1&#39;b0) begin touch_key_dly1 &lt;= 1&#39;b1; touch_key_dly2 &lt;= 1&#39;b1; end else begin touch_key_dly1 &lt;= touch_key; touch_key_dly2 &lt;= touch_key_dly1; end //根据触摸按键信号的下降沿判断触摸了触摸按键 assign touch_flag = ((touch_key_dly1 == 1&#39;b0) &amp;&amp; (touch_key_dly2 == 1&#39;b1)); //根据触摸使能信号控制led状态 always@(posedge sys_clk or negedge sys_rst_n) if(sys_rst_n == 1&#39;b0) led &lt;= 1&#39;b1; else if(touch_flag == 1&#39;b1) led &lt;= ~led; else led &lt;= led; endmodule `timescale 1ns/1ns module tb_touch_ctrl_led(); //wire define wire led ; //reg define reg sys_clk ; reg sys_rst_n ; reg touch_key ; //sys_clk,sys_rst_n初始赋值，模拟触摸按键信号值 initial begin sys_clk = 1&#39;b1 ; sys_rst_n &lt;= 1&#39;b0 ; touch_key &lt;= 1&#39;b1 ; #20 sys_rst_n &lt;= 1&#39;b1 ; #200 touch_key &lt;= 1&#39;b0 ; #2000 touch_key &lt;= 1&#39;b1 ; #1000 touch_key &lt;= 1&#39;b0 ; #3000 touch_key &lt;= 1&#39;b1 ; end //clk：产生时钟 always #10 sys_clk = ~sys_clk ; //------------- touch_ctrl_led_inst ------------- touch_ctrl_led touch_ctrl_led_inst ( ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/ad14b44e01e1f2c378311fbf73a8e664/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-26T14:58:33+08:00" />
<meta property="article:modified_time" content="2022-12-26T14:58:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">FPGA入门（5）：控制LED灯</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#17LED_2" rel="nofollow">第17讲：触摸按键控制LED灯</a></li><li><a href="#18_115" rel="nofollow">第18讲：流水灯</a></li><li><a href="#19_215" rel="nofollow">第19讲：呼吸灯</a></li><li><a href="#20_342" rel="nofollow">第20讲：状态机</a></li><li><a href="#21_659" rel="nofollow">第21讲：无源蜂鸣器驱动实验</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="17LED_2"></a>第17讲：触摸按键控制LED灯</h3> 
<p>触摸按键可分为四大类：<strong>电阻式、电容式、红外感应式、表面声波式</strong></p> 
<p><strong>电容式触摸按键</strong>主要由按键IC部分和电容部分构成；按键IC用于将电容的变化转换为电信号；电容部分指的是由电容极板、地、隔离区等组成触摸按键的电容环境。<br> <img src="https://images2.imgbox.com/b8/3a/XPd1PmqY_o.png" alt="在这里插入图片描述"><br> <br></p> 
<p><strong>模块绘制</strong><br> <img src="https://images2.imgbox.com/54/6a/dELVyWam_o.png" alt="在这里插入图片描述"><br> <strong>波形图绘制：按键未按下时保持高电平，按键按下保持低电平</strong>；按下时间与低电平保持时间相同，松开按键返回高电平<br> <mark>使用按键下降沿控制灯的点亮和熄灭</mark><br> <img src="https://images2.imgbox.com/51/98/X6AdwqGR_o.png" alt="在这里插入图片描述"></p> 
<p><strong>touch_ctrl_led.v</strong></p> 
<pre><code class="prism language-c">`timescale  <span class="token number">1</span>ns<span class="token operator">/</span><span class="token number">1</span>ns

module  <span class="token function">touch_ctrl_led</span>
<span class="token punctuation">(</span>
    input   wire    sys_clk     <span class="token punctuation">,</span>   <span class="token comment">//系统时钟，频率50MHz</span>
    input   wire    sys_rst_n   <span class="token punctuation">,</span>   <span class="token comment">//复位信号，低电平有效</span>
    input   wire    touch_key   <span class="token punctuation">,</span>   <span class="token comment">//触摸按键信号</span>

    output  reg     led             <span class="token comment">//led输出信号</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//wire  define</span>
wire    touch_flag    <span class="token punctuation">;</span>   <span class="token comment">//触摸使能信号</span>

<span class="token comment">//reg   define</span>
reg touch_key_dly1  <span class="token punctuation">;</span>   <span class="token comment">//touch_key延迟一个时钟信号</span>
reg touch_key_dly2  <span class="token punctuation">;</span>   <span class="token comment">//touch_key延迟两个时钟信号</span>

<span class="token comment">//对touch_key信号延迟两个时钟周期用来产生触摸按键信号</span>
always@<span class="token punctuation">(</span>posedge sys_clk or  negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        begin
            touch_key_dly1  <span class="token operator">&lt;=</span>  <span class="token number">1</span>'b1<span class="token punctuation">;</span>
            touch_key_dly2  <span class="token operator">&lt;=</span>  <span class="token number">1</span>'b1<span class="token punctuation">;</span>
        end
    <span class="token keyword">else</span>
        begin
            touch_key_dly1  <span class="token operator">&lt;=</span>  touch_key<span class="token punctuation">;</span>
            touch_key_dly2  <span class="token operator">&lt;=</span>  touch_key_dly1<span class="token punctuation">;</span>
        end

<span class="token comment">//根据触摸按键信号的下降沿判断触摸了触摸按键</span>
assign  touch_flag    <span class="token operator">=</span>   <span class="token punctuation">(</span><span class="token punctuation">(</span>touch_key_dly1 <span class="token operator">==</span> <span class="token number">1</span><span class="token char">'b0) &amp;&amp; (touch_key_dly2 == 1'</span>b1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//根据触摸使能信号控制led状态</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        led <span class="token operator">&lt;=</span>  <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>touch_flag <span class="token operator">==</span> <span class="token number">1</span>'b1<span class="token punctuation">)</span>
        led <span class="token operator">&lt;=</span>  <span class="token operator">~</span>led<span class="token punctuation">;</span>
    <span class="token keyword">else</span>  
        led <span class="token operator">&lt;=</span>  led<span class="token punctuation">;</span>
        
endmodule
</code></pre> 
<pre><code class="prism language-c">`timescale  <span class="token number">1</span>ns<span class="token operator">/</span><span class="token number">1</span>ns

module  <span class="token function">tb_touch_ctrl_led</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//wire  define</span>
wire    led         <span class="token punctuation">;</span>

<span class="token comment">//reg   define</span>
reg     sys_clk     <span class="token punctuation">;</span>
reg     sys_rst_n   <span class="token punctuation">;</span>
reg     touch_key   <span class="token punctuation">;</span>

<span class="token comment">//sys_clk,sys_rst_n初始赋值，模拟触摸按键信号值</span>
initial
    begin
        sys_clk       <span class="token operator">=</span>   <span class="token number">1</span>'b1 <span class="token punctuation">;</span>
        sys_rst_n    <span class="token operator">&lt;=</span>   <span class="token number">1</span>'b0 <span class="token punctuation">;</span>
        touch_key    <span class="token operator">&lt;=</span>   <span class="token number">1</span>'b1 <span class="token punctuation">;</span>
        #<span class="token number">20</span>
        sys_rst_n    <span class="token operator">&lt;=</span>   <span class="token number">1</span>'b1 <span class="token punctuation">;</span>
        #<span class="token number">200</span>
        touch_key    <span class="token operator">&lt;=</span>   <span class="token number">1</span>'b0 <span class="token punctuation">;</span>
        #<span class="token number">2000</span>
        touch_key    <span class="token operator">&lt;=</span>   <span class="token number">1</span>'b1 <span class="token punctuation">;</span>
        #<span class="token number">1000</span>
        touch_key    <span class="token operator">&lt;=</span>   <span class="token number">1</span>'b0 <span class="token punctuation">;</span>
        #<span class="token number">3000</span>
        touch_key    <span class="token operator">&lt;=</span>   <span class="token number">1</span>'b1 <span class="token punctuation">;</span>
    end

<span class="token comment">//clk：产生时钟</span>
always  #<span class="token number">10</span> sys_clk <span class="token operator">=</span> <span class="token operator">~</span>sys_clk <span class="token punctuation">;</span>

<span class="token comment">//------------- touch_ctrl_led_inst -------------</span>
touch_ctrl_led    <span class="token function">touch_ctrl_led_inst</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">.</span><span class="token function">sys_clk</span>    <span class="token punctuation">(</span>sys_clk    <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//系统时钟，频率50MHz</span>
    <span class="token punctuation">.</span><span class="token function">sys_rst_n</span>  <span class="token punctuation">(</span>sys_rst_n  <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//复位信号，低电平有效</span>
    <span class="token punctuation">.</span><span class="token function">touch_key</span>  <span class="token punctuation">(</span>touch_key  <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//触摸按键信号</span>

    <span class="token punctuation">.</span><span class="token function">led</span>        <span class="token punctuation">(</span>led        <span class="token punctuation">)</span>   <span class="token comment">//led输出信号</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

endmodule
</code></pre> 
<p><br><br></p> 
<h3><a id="18_115"></a>第18讲：流水灯</h3> 
<p><strong>模块设计</strong><br> <img src="https://images2.imgbox.com/38/54/suDy23T4_o.png" alt="在这里插入图片描述"><br> <strong>波形绘制</strong>：0.5秒转换一个灯<br> <img src="https://images2.imgbox.com/bc/f4/qbGbw0VW_o.png" alt="在这里插入图片描述"></p> 
<p><strong>water_led.v</strong></p> 
<pre><code class="prism language-c">`timescale  <span class="token number">1</span>ns<span class="token operator">/</span><span class="token number">1</span>ns

module  water_led
#<span class="token punctuation">(</span>
    parameter CNT_MAX <span class="token operator">=</span> <span class="token number">25</span>'d24_999_999
<span class="token punctuation">)</span>
<span class="token punctuation">(</span>
    input   wire            sys_clk     <span class="token punctuation">,</span>   <span class="token comment">//系统时钟50Mh</span>
    input   wire            sys_rst_n   <span class="token punctuation">,</span>  <span class="token comment">//全局复位</span>

    output  wire    <span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   led_out        <span class="token comment">//输出控制led灯</span>

<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//reg   define</span>
reg     <span class="token punctuation">[</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>  cnt         <span class="token punctuation">;</span>
reg             cnt_flag    <span class="token punctuation">;</span>
reg     <span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   led_out_reg <span class="token punctuation">;</span>

<span class="token comment">//cnt:计数器计数500ms</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        cnt <span class="token operator">&lt;=</span> <span class="token number">25</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cnt <span class="token operator">==</span> CNT_MAX<span class="token punctuation">)</span>
        cnt <span class="token operator">&lt;=</span> <span class="token number">25</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        cnt <span class="token operator">&lt;=</span> cnt <span class="token operator">+</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>

<span class="token comment">//cnt_flag:计数器计数满500ms标志信号</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        cnt_flag <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cnt <span class="token operator">==</span> CNT_MAX <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        cnt_flag <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        cnt_flag <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>

<span class="token comment">//led_out_reg:led循环流水</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        led_out_reg <span class="token operator">&lt;=</span>  <span class="token number">4</span>'b0001<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>led_out_reg <span class="token operator">==</span> <span class="token number">4</span><span class="token char">'b1000 &amp;&amp; cnt_flag == 1'</span>b1<span class="token punctuation">)</span>
        led_out_reg <span class="token operator">&lt;=</span>  <span class="token number">4</span>'b0001<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_flag <span class="token operator">==</span> <span class="token number">1</span>'b1<span class="token punctuation">)</span>
        led_out_reg <span class="token operator">&lt;=</span>  led_out_reg <span class="token operator">&lt;&lt;</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span> <span class="token comment">//左移</span>

assign  led_out <span class="token operator">=</span> <span class="token operator">~</span>led_out_reg<span class="token punctuation">;</span>

endmodule
</code></pre> 
<p><strong>tb_water_led.v</strong></p> 
<pre><code class="prism language-c">`timescale  <span class="token number">1</span>ns<span class="token operator">/</span><span class="token number">1</span>ns

module  <span class="token function">tb_water_led</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//wire  define</span>
wire    <span class="token punctuation">[</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   led_out     <span class="token punctuation">;</span>

<span class="token comment">//reg   define</span>
reg             sys_clk     <span class="token punctuation">;</span>
reg             sys_rst_n   <span class="token punctuation">;</span>

<span class="token comment">//初始化系统时钟、全局复位</span>
initial begin
    sys_clk    <span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    sys_rst_n <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    #<span class="token number">20</span>
    sys_rst_n <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
end

<span class="token comment">//sys_clk:模拟系统时钟，每10ns电平翻转一次，周期为20ns，频率为50Mhz</span>
always #<span class="token number">10</span> sys_clk <span class="token operator">=</span> <span class="token operator">~</span>sys_clk<span class="token punctuation">;</span>

<span class="token comment">//-------------------- water_led_inst --------------------</span>
water_led   
#<span class="token punctuation">(</span>
    <span class="token punctuation">.</span><span class="token function">CNT_MAX</span>    <span class="token punctuation">(</span><span class="token number">25</span>'d24<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token function">water_led_inst</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">.</span><span class="token function">sys_clk</span>    <span class="token punctuation">(</span>sys_clk    <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//input          sys_clk</span>
    <span class="token punctuation">.</span><span class="token function">sys_rst_n</span>  <span class="token punctuation">(</span>sys_rst_n  <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//input          sys_rst_n</span>
                    
    <span class="token punctuation">.</span><span class="token function">led_out</span>    <span class="token punctuation">(</span>led_out    <span class="token punctuation">)</span>   <span class="token comment">//output  [3:0]  led_out</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

endmodule
</code></pre> 
<p><br><br></p> 
<h3><a id="19_215"></a>第19讲：呼吸灯</h3> 
<p><strong>LED灯低电平点亮，高电平熄灭。</strong></p> 
<p><strong>模块设计</strong><br> <img src="https://images2.imgbox.com/78/68/bZ4o3k6m_o.png" alt="在这里插入图片描述"><br> <strong>波形图绘制</strong><br> <img src="https://images2.imgbox.com/d0/2d/JJVYFTD3_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/fe/b3/M11lcMK3_o.png" alt="在这里插入图片描述"></p> 
<p><strong>breath_led.v</strong></p> 
<pre><code class="prism language-c">`timescale  <span class="token number">1</span>ns<span class="token operator">/</span><span class="token number">1</span>ns

module  breath_led
#<span class="token punctuation">(</span>
    parameter CNT_1US_MAX <span class="token operator">=</span> <span class="token number">6</span>'d49   <span class="token punctuation">,</span>
    parameter CNT_1MS_MAX <span class="token operator">=</span> <span class="token number">10</span>'d999 <span class="token punctuation">,</span>
    parameter CNT_1S_MAX  <span class="token operator">=</span> <span class="token number">10</span>'d999
<span class="token punctuation">)</span>
<span class="token punctuation">(</span>
    input   wire    sys_clk     <span class="token punctuation">,</span>   <span class="token comment">//系统时钟50Mhz</span>
    input   wire    sys_rst_n   <span class="token punctuation">,</span>   <span class="token comment">//全局复位</span>

    output  reg     led_out         <span class="token comment">//输出信号，控制led灯</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//reg define</span>
reg <span class="token punctuation">[</span><span class="token number">5</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   cnt_1us     <span class="token punctuation">;</span>
reg <span class="token punctuation">[</span><span class="token number">9</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   cnt_1ms     <span class="token punctuation">;</span>
reg <span class="token punctuation">[</span><span class="token number">9</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   cnt_1s      <span class="token punctuation">;</span>
reg         cnt_1s_en   <span class="token punctuation">;</span>  <span class="token comment">//方便点亮到熄灭，熄灭到点亮的取反</span>

<span class="token comment">//cnt_1us:1us计数器</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        cnt_1us <span class="token operator">&lt;=</span> <span class="token number">6</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_1us <span class="token operator">==</span> CNT_1US_MAX<span class="token punctuation">)</span>
        cnt_1us <span class="token operator">&lt;=</span> <span class="token number">6</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        cnt_1us <span class="token operator">&lt;=</span> cnt_1us <span class="token operator">+</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>

<span class="token comment">//cnt_1ms:1ms计数器</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        cnt_1ms <span class="token operator">&lt;=</span> <span class="token number">10</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_1ms <span class="token operator">==</span> CNT_1MS_MAX <span class="token operator">&amp;&amp;</span> cnt_1us <span class="token operator">==</span> CNT_1US_MAX<span class="token punctuation">)</span>
        cnt_1ms <span class="token operator">&lt;=</span> <span class="token number">10</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_1us <span class="token operator">==</span> CNT_1US_MAX<span class="token punctuation">)</span>
        cnt_1ms <span class="token operator">&lt;=</span> cnt_1ms <span class="token operator">+</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    <span class="token keyword">else</span>   
        cnt_1ms <span class="token operator">&lt;=</span> cnt_1ms<span class="token punctuation">;</span>
        
<span class="token comment">//cnt_1s:1s计数器</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        cnt_1s <span class="token operator">&lt;=</span> <span class="token number">10</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_1s <span class="token operator">==</span> CNT_1S_MAX <span class="token operator">&amp;&amp;</span> cnt_1ms <span class="token operator">==</span> CNT_1MS_MAX <span class="token operator">&amp;&amp;</span> cnt_1us <span class="token operator">==</span> CNT_1US_MAX<span class="token punctuation">)</span>
        cnt_1s <span class="token operator">&lt;=</span> <span class="token number">10</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_1ms <span class="token operator">==</span> CNT_1MS_MAX <span class="token operator">&amp;&amp;</span> cnt_1us <span class="token operator">==</span> CNT_1US_MAX<span class="token punctuation">)</span>
        cnt_1s <span class="token operator">&lt;=</span> cnt_1s <span class="token operator">+</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    <span class="token keyword">else</span> 
        cnt_1s <span class="token operator">&lt;=</span> cnt_1s<span class="token punctuation">;</span>
        
<span class="token comment">//cnt_1s_en:1s计数器使能信号</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        cnt_1s_en <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cnt_1s <span class="token operator">==</span> CNT_1S_MAX <span class="token operator">&amp;&amp;</span> cnt_1ms <span class="token operator">==</span> CNT_1MS_MAX  <span class="token operator">&amp;&amp;</span> cnt_1us <span class="token operator">==</span> CNT_1US_MAX<span class="token punctuation">)</span>
        cnt_1s_en <span class="token operator">&lt;=</span> <span class="token operator">~</span>cnt_1s_en<span class="token punctuation">;</span>
    <span class="token keyword">else</span>   
        cnt_1s_en <span class="token operator">&lt;=</span> cnt_1s_en<span class="token punctuation">;</span>
        
<span class="token comment">//led_out:输出信号连接到外部的led灯</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        led_out <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cnt_1s_en <span class="token operator">==</span> <span class="token number">1</span>'b0 <span class="token operator">&amp;&amp;</span> cnt_1ms <span class="token operator">&lt;=</span> cnt_1s<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>cnt_1s_en <span class="token operator">==</span> <span class="token number">1</span>'b1 <span class="token operator">&amp;&amp;</span> cnt_1ms <span class="token operator">&gt;</span> cnt_1s<span class="token punctuation">)</span><span class="token punctuation">)</span>
        led_out <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        led_out <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>

endmodule
</code></pre> 
<p><strong>tb_breath_led.v</strong></p> 
<pre><code class="prism language-c">`timescale  <span class="token number">1</span>ns<span class="token operator">/</span><span class="token number">1</span>ns

module  <span class="token function">tb_breath_led</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//wire  define</span>
wire    led_out     <span class="token punctuation">;</span>

<span class="token comment">//reg   define</span>
reg     sys_clk     <span class="token punctuation">;</span>
reg     sys_rst_n   <span class="token punctuation">;</span>

<span class="token comment">//初始化系统时钟、全局复位</span>
initial begin
    sys_clk    <span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    sys_rst_n <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    #<span class="token number">20</span>
    sys_rst_n <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
end

<span class="token comment">//sys_clk:模拟系统时钟，每10ns电平翻转一次，周期为20ns，频率为50Mhz</span>
always #<span class="token number">10</span> sys_clk <span class="token operator">=</span> <span class="token operator">~</span>sys_clk<span class="token punctuation">;</span>

<span class="token comment">//-------------------- breath_led_inst --------------------</span>
breath_led
#<span class="token punctuation">(</span>
    <span class="token punctuation">.</span><span class="token function">CNT_1US_MAX</span><span class="token punctuation">(</span><span class="token number">6</span>'d4   <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token function">CNT_1MS_MAX</span><span class="token punctuation">(</span><span class="token number">10</span>'d9  <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token function">CNT_1S_MAX</span> <span class="token punctuation">(</span><span class="token number">10</span>'d9  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token function">breath_led_inst</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">.</span><span class="token function">sys_clk</span>    <span class="token punctuation">(</span>sys_clk    <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//input     sys_clk</span>
    <span class="token punctuation">.</span><span class="token function">sys_rst_n</span>  <span class="token punctuation">(</span>sys_rst_n  <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//input     sys_rst_n</span>

    <span class="token punctuation">.</span><span class="token function">led_out</span>    <span class="token punctuation">(</span>led_out    <span class="token punctuation">)</span>   <span class="token comment">//output    led_out</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

endmodule
</code></pre> 
<p><br><br></p> 
<h3><a id="20_342"></a>第20讲：状态机</h3> 
<p><img src="https://images2.imgbox.com/25/7f/JhXxVuGD_o.png" alt="在这里插入图片描述"><br> <br></p> 
<p><strong>例：简单状态机</strong><br> <strong>模块设计</strong><br> <img src="https://images2.imgbox.com/fc/6c/dl63bxVm_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>输入：投入1元硬币<br> 输出：出可乐，不出可乐<br> 状态：投入0元，投入1元，投入2元，投入3元</p> 
</blockquote> 
<p><strong>状态分析</strong><br> <img src="https://images2.imgbox.com/f8/96/pAs1MSYH_o.png" alt="在这里插入图片描述"><br> <strong>波形图绘制</strong><br> <img src="https://images2.imgbox.com/5e/1a/eDiyMkfW_o.png" alt="在这里插入图片描述"><br> <strong>simple_fsm.v</strong></p> 
<pre><code class="prism language-c">`timescale  <span class="token number">1</span>ns<span class="token operator">/</span><span class="token number">1</span>ns

module  <span class="token function">simple_fsm</span>
<span class="token punctuation">(</span>
    input   wire    sys_clk     <span class="token punctuation">,</span>   <span class="token comment">//系统时钟50MHz</span>
    input   wire    sys_rst_n   <span class="token punctuation">,</span>   <span class="token comment">//全局复位</span>
    input   wire    pi_money    <span class="token punctuation">,</span>   <span class="token comment">//投币方式可以为：不投币（0）、投1元（1）</span>

    output  reg     po_cola         <span class="token comment">//po_cola为1时出可乐，po_cola为0时不出可乐</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//parameter define</span>
<span class="token comment">//只有三种状态，使用独热码</span>
parameter   IDLE <span class="token operator">=</span> <span class="token number">3</span>'b001<span class="token punctuation">;</span>
parameter   ONE  <span class="token operator">=</span> <span class="token number">3</span>'b010<span class="token punctuation">;</span>
parameter   TWO  <span class="token operator">=</span> <span class="token number">3</span>'b100<span class="token punctuation">;</span>

<span class="token comment">//reg   define</span>
reg     <span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   state<span class="token punctuation">;</span>

<span class="token comment">//第一段状态机，描述当前状态state如何根据输入跳转到下一状态</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        state <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>  <span class="token comment">//任何情况下只要按复位就回到初始状态</span>
    <span class="token keyword">else</span>    <span class="token keyword">case</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
                IDLE    <span class="token operator">:</span>   <span class="token keyword">if</span><span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">1</span>'b1<span class="token punctuation">)</span><span class="token comment">//判断输入情况</span>
                                state <span class="token operator">&lt;=</span> ONE<span class="token punctuation">;</span>
                            <span class="token keyword">else</span>
                                state <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>

                ONE     <span class="token operator">:</span>   <span class="token keyword">if</span><span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">1</span>'b1<span class="token punctuation">)</span>
                                state <span class="token operator">&lt;=</span> TWO<span class="token punctuation">;</span>
                            <span class="token keyword">else</span>
                                state <span class="token operator">&lt;=</span> ONE<span class="token punctuation">;</span>

                TWO     <span class="token operator">:</span>   <span class="token keyword">if</span><span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">1</span>'b1<span class="token punctuation">)</span>
                                state <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>
                            <span class="token keyword">else</span>
                                state <span class="token operator">&lt;=</span> TWO<span class="token punctuation">;</span>
                <span class="token comment">//如果状态机跳转到编码的状态之外也回到初始状态</span>
                <span class="token keyword">default</span> <span class="token operator">:</span>       state <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>
            endcase

<span class="token comment">//第二段状态机，描述当前状态state和输入pi_money如何影响po_cola输出</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        po_cola <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state <span class="token operator">==</span> TWO<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">1</span>'b1<span class="token punctuation">)</span><span class="token punctuation">)</span>
        po_cola <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        po_cola <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>

endmodule
</code></pre> 
<p><img src="https://images2.imgbox.com/93/ee/LRG8qSld_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f5/b1/7TlFXBrV_o.png" alt="在这里插入图片描述"></p> 
<p><strong>tb_simple_fsm.v</strong></p> 
<pre><code class="prism language-c">`timescale  <span class="token number">1</span>ns<span class="token operator">/</span><span class="token number">1</span>ns

module  <span class="token function">tb_simple_fsm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//reg define</span>
reg     sys_clk<span class="token punctuation">;</span>
reg     sys_rst_n<span class="token punctuation">;</span>
reg     pi_money<span class="token punctuation">;</span>

<span class="token comment">//wire  define</span>
wire    po_cola<span class="token punctuation">;</span>

<span class="token comment">//初始化系统时钟、全局复位</span>
initial begin
    sys_clk    <span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    sys_rst_n <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    #<span class="token number">20</span>
    sys_rst_n <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
end

<span class="token comment">//sys_clk:模拟系统时钟，每10ns电平翻转一次，周期为20ns，频率为50MHz</span>
always  #<span class="token number">10</span> sys_clk <span class="token operator">=</span> <span class="token operator">~</span>sys_clk<span class="token punctuation">;</span>

<span class="token comment">//pi_money:产生输入随机数，模拟投币1元的情况</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        pi_money <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        pi_money <span class="token operator">&lt;=</span> <span class="token punctuation">{<!-- --></span>$random<span class="token punctuation">}</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">//取模求余数，产生非负随机数0、1</span>

<span class="token comment">//------------------------------------------------------------</span>
<span class="token comment">//将RTL模块中的内部信号引入到Testbench模块中进行观察</span>
wire <span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span> state <span class="token operator">=</span> simple_fsm_inst<span class="token punctuation">.</span>state<span class="token punctuation">;</span>

initial begin
    $<span class="token function">timeformat</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"ns"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    $<span class="token function">monitor</span><span class="token punctuation">(</span><span class="token string">"@time %t: pi_money=%b state=%b po_cola=%b"</span><span class="token punctuation">,</span> $time<span class="token punctuation">,</span> pi_money<span class="token punctuation">,</span> state<span class="token punctuation">,</span> po_cola<span class="token punctuation">)</span><span class="token punctuation">;</span>
end
<span class="token comment">//------------------------------------------------------------</span>

<span class="token comment">//------------------------simple_fsm_inst------------------------</span>
simple_fsm  <span class="token function">simple_fsm_inst</span><span class="token punctuation">(</span>
    <span class="token punctuation">.</span><span class="token function">sys_clk</span>    <span class="token punctuation">(</span>sys_clk    <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//input     sys_clk</span>
    <span class="token punctuation">.</span><span class="token function">sys_rst_n</span>  <span class="token punctuation">(</span>sys_rst_n  <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//input     sys_rst_n</span>
    <span class="token punctuation">.</span><span class="token function">pi_money</span>   <span class="token punctuation">(</span>pi_money   <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//input     pi_money</span>

    <span class="token punctuation">.</span><span class="token function">po_cola</span>    <span class="token punctuation">(</span>po_cola    <span class="token punctuation">)</span>   <span class="token comment">//output    po_cola</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

endmodule
</code></pre> 
<p><br><br></p> 
<p><strong>例：复杂状态机</strong><br> <strong>模块设计</strong><br> <img src="https://images2.imgbox.com/2c/d2/21hnjQ1S_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>输入：0.5、1<br> 输出：不出可乐/不找零、出可乐/不找零、出可乐/找零<br> 状态：0、0.5、1、1.5、2、2.5、3</p> 
</blockquote> 
<p><strong>状态转移图</strong><br> <img src="https://images2.imgbox.com/6d/08/dhKl0z5u_o.png" alt="在这里插入图片描述"><br> <strong>波形图绘制</strong><br> <img src="https://images2.imgbox.com/57/37/q3LB3eEF_o.png" alt="在这里插入图片描述"></p> 
<p><strong>complex_fsm.v</strong></p> 
<pre><code class="prism language-c">`timescale  <span class="token number">1</span>ns<span class="token operator">/</span><span class="token number">1</span>ns

module  <span class="token function">complex_fsm</span>
<span class="token punctuation">(</span>
    input   wire    sys_clk         <span class="token punctuation">,</span>   <span class="token comment">//系统时钟50MHz</span>
    input   wire    sys_rst_n       <span class="token punctuation">,</span>   <span class="token comment">//全局复位</span>
    input   wire    pi_money_one    <span class="token punctuation">,</span>   <span class="token comment">//投币1元</span>
    input   wire    pi_money_half   <span class="token punctuation">,</span>   <span class="token comment">//投币0.5元</span>
                    
    output  reg     po_money        <span class="token punctuation">,</span>   <span class="token comment">//po_money为1时表示找零</span>
                                        <span class="token comment">//po_money为0时表示不找零</span>
    output  reg     po_cola             <span class="token comment">//po_cola为1时出可乐</span>
                                        <span class="token comment">//po_cola为0时不出可乐</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//parameter define</span>
<span class="token comment">//只有五种状态，使用独热码</span>
parameter   IDLE     <span class="token operator">=</span> <span class="token number">5</span>'b00001<span class="token punctuation">;</span>
parameter   HALF     <span class="token operator">=</span> <span class="token number">5</span>'b00010<span class="token punctuation">;</span>
parameter   ONE      <span class="token operator">=</span> <span class="token number">5</span>'b00100<span class="token punctuation">;</span>
parameter   ONE_HALF <span class="token operator">=</span> <span class="token number">5</span>'b01000<span class="token punctuation">;</span>
parameter   TWO      <span class="token operator">=</span> <span class="token number">5</span>'b10000<span class="token punctuation">;</span>

<span class="token comment">//reg   define</span>
reg     <span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   state<span class="token punctuation">;</span>

<span class="token comment">//wire  define</span>
wire    <span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   pi_money<span class="token punctuation">;</span>

<span class="token comment">//pi_money:为了减少变量的个数，我们用位拼接把输入的两个1bit信号拼接成1个2bit信号</span>
<span class="token comment">//投币方式可以为：不投币（00）、投0.5元（01）、投1元（10），每次只投一个币</span>
assign pi_money <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>pi_money_one<span class="token punctuation">,</span> pi_money_half<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//第一段状态机，描述当前状态state如何根据输入跳转到下一状态</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        state <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>  <span class="token comment">//任何情况下只要按复位就回到初始状态</span>
    <span class="token keyword">else</span>	<span class="token keyword">case</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
                IDLE    <span class="token operator">:</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">2</span>'b01<span class="token punctuation">)</span>   <span class="token comment">//判断一种输入情况</span>
                              state <span class="token operator">&lt;=</span> HALF<span class="token punctuation">;</span>
                          <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">2</span>'b10<span class="token punctuation">)</span><span class="token comment">//判断另一种输入情况</span>
                              state <span class="token operator">&lt;=</span> ONE<span class="token punctuation">;</span>
                          <span class="token keyword">else</span>
                              state <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>
    
                HALF    <span class="token operator">:</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">2</span>'b01<span class="token punctuation">)</span>
                              state <span class="token operator">&lt;=</span> ONE<span class="token punctuation">;</span>
                          <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">2</span>'b10<span class="token punctuation">)</span>
                              state <span class="token operator">&lt;=</span> ONE_HALF<span class="token punctuation">;</span>
                          <span class="token keyword">else</span>
                              state <span class="token operator">&lt;=</span> HALF<span class="token punctuation">;</span>
    
                ONE     <span class="token operator">:</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">2</span>'b01<span class="token punctuation">)</span>
                              state <span class="token operator">&lt;=</span> ONE_HALF<span class="token punctuation">;</span>
                          <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">2</span>'b10<span class="token punctuation">)</span>
                              state <span class="token operator">&lt;=</span> TWO<span class="token punctuation">;</span>
                          <span class="token keyword">else</span>
                              state <span class="token operator">&lt;=</span> ONE<span class="token punctuation">;</span>
    
                ONE_HALF<span class="token operator">:</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">2</span>'b01<span class="token punctuation">)</span>
                              state <span class="token operator">&lt;=</span> TWO<span class="token punctuation">;</span>
                          <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">2</span>'b10<span class="token punctuation">)</span>
                              state <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>
                          <span class="token keyword">else</span>
                              state <span class="token operator">&lt;=</span> ONE_HALF<span class="token punctuation">;</span>
    
                TWO     <span class="token operator">:</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">2</span><span class="token char">'b01) || (pi_money == 2'</span>b10<span class="token punctuation">)</span><span class="token punctuation">)</span>
                              state <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>
                          <span class="token keyword">else</span>
                              state <span class="token operator">&lt;=</span> TWO<span class="token punctuation">;</span>
        <span class="token comment">//如果状态机跳转到编码的状态之外也回到初始状态</span>
                <span class="token keyword">default</span> <span class="token operator">:</span>       state <span class="token operator">&lt;=</span> IDLE<span class="token punctuation">;</span>
            endcase

<span class="token comment">//第二段状态机，描述当前状态state和输入pi_money如何影响po_cola输出</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        po_cola <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token operator">==</span>TWO <span class="token operator">&amp;&amp;</span> pi_money<span class="token operator">==</span><span class="token number">2</span>'b01<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>state<span class="token operator">==</span>TWO <span class="token operator">&amp;&amp;</span> pi_money<span class="token operator">==</span><span class="token number">2</span>'b10<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>state<span class="token operator">==</span>ONE_HALF <span class="token operator">&amp;&amp;</span> pi_money<span class="token operator">==</span><span class="token number">2</span>'b10<span class="token punctuation">)</span><span class="token punctuation">)</span>
        po_cola <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        po_cola <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>

<span class="token comment">//第二段状态机，描述当前状态state和输入pi_money如何影响po_money输出</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span>	<span class="token number">1</span>'b0<span class="token punctuation">)</span>
        po_money <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state <span class="token operator">==</span> TWO<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pi_money <span class="token operator">==</span> <span class="token number">2</span>'b10<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//只有一种情况需要找零</span>
        po_money <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        po_money <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>

endmodule
</code></pre> 
<p><img src="https://images2.imgbox.com/be/2f/bhQxSEjy_o.png" alt="在这里插入图片描述"><br> <strong>tb_complex_fsm.v</strong></p> 
<pre><code class="prism language-c">`timescale  <span class="token number">1</span>ns<span class="token operator">/</span><span class="token number">1</span>ns
module  <span class="token function">tb_complex_fsm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//reg   define</span>
reg         sys_clk<span class="token punctuation">;</span>
reg         sys_rst_n<span class="token punctuation">;</span>
reg         pi_money_one<span class="token punctuation">;</span>
reg         pi_money_half<span class="token punctuation">;</span>
reg         random_data_gen<span class="token punctuation">;</span>

<span class="token comment">//wire  define</span>
wire        po_cola<span class="token punctuation">;</span>
wire        po_money<span class="token punctuation">;</span>

<span class="token comment">//初始化系统时钟、全局复位</span>
initial begin
    sys_clk    <span class="token operator">=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    sys_rst_n <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    #<span class="token number">20</span>
    sys_rst_n <span class="token operator">&lt;=</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
end

<span class="token comment">//sys_clk:模拟系统时钟，每10ns电平翻转一次，周期为20ns，频率为50MHz</span>
always  #<span class="token number">10</span> sys_clk <span class="token operator">=</span> <span class="token operator">~</span>sys_clk<span class="token punctuation">;</span>

<span class="token comment">//random_data_gen:产生非负随机数0、1</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        random_data_gen <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        random_data_gen <span class="token operator">&lt;=</span> <span class="token punctuation">{<!-- --></span>$random<span class="token punctuation">}</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">//pi_money_one:模拟投入1元的情况</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        pi_money_one <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        pi_money_one <span class="token operator">&lt;=</span> random_data_gen<span class="token punctuation">;</span>

<span class="token comment">//pi_money_half:模拟投入0.5元的情况</span>
always@<span class="token punctuation">(</span>posedge sys_clk or negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        pi_money_half <span class="token operator">&lt;=</span> <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
    <span class="token comment">//取反是因为一次只能投一个币，即pi_money_one和pi_money_half不能同时为1</span>
        pi_money_half <span class="token operator">&lt;=</span> <span class="token operator">~</span>random_data_gen<span class="token punctuation">;</span>

<span class="token comment">//------------------------------------------------------------</span>
<span class="token comment">//将RTL模块中的内部信号引入到Testbench模块中进行观察</span>
wire    <span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   state    <span class="token operator">=</span> complex_fsm_inst<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
wire    <span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   pi_money <span class="token operator">=</span> complex_fsm_inst<span class="token punctuation">.</span>pi_money<span class="token punctuation">;</span>

initial begin
    $<span class="token function">timeformat</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"ns"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    $<span class="token function">monitor</span><span class="token punctuation">(</span><span class="token string">"@time %t: pi_money_one=%b pi_money_half=%b pi_money=%b state=%b po_cola=%b po_money=%b"</span><span class="token punctuation">,</span> $time<span class="token punctuation">,</span> pi_money_one<span class="token punctuation">,</span> pi_money_half<span class="token punctuation">,</span> pi_money<span class="token punctuation">,</span> state<span class="token punctuation">,</span> po_cola<span class="token punctuation">,</span> po_money<span class="token punctuation">)</span><span class="token punctuation">;</span>
end
<span class="token comment">//------------------------------------------------------------</span>

<span class="token comment">//------------------------complex_fsm_inst------------------------</span>
complex_fsm <span class="token function">complex_fsm_inst</span><span class="token punctuation">(</span>
    <span class="token punctuation">.</span><span class="token function">sys_clk</span>        <span class="token punctuation">(</span>sys_clk        <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//input     sys_clk</span>
    <span class="token punctuation">.</span><span class="token function">sys_rst_n</span>      <span class="token punctuation">(</span>sys_rst_n      <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//input     sys_rst_n</span>
    <span class="token punctuation">.</span><span class="token function">pi_money_one</span>   <span class="token punctuation">(</span>pi_money_one   <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//input     pi_money_one</span>
    <span class="token punctuation">.</span><span class="token function">pi_money_half</span>  <span class="token punctuation">(</span>pi_money_half  <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//input     pi_money_half</span>
                    
    <span class="token punctuation">.</span><span class="token function">po_cola</span>        <span class="token punctuation">(</span>po_cola        <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//output    po_money</span>
    <span class="token punctuation">.</span><span class="token function">po_money</span>       <span class="token punctuation">(</span>po_money       <span class="token punctuation">)</span>   <span class="token comment">//output    po_cola</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>  

endmodule
</code></pre> 
<p><br><br></p> 
<h3><a id="21_659"></a>第21讲：无源蜂鸣器驱动实验</h3> 
<p><strong>蜂鸣器</strong>按其结构可分为<strong>电磁式蜂鸣器和压电式蜂鸣器</strong>两种类型；蜂鸣器按其是否带有信号源又分为<strong>有源蜂鸣器和无源蜂鸣器</strong>。<br> 有源蜂鸣器的内部装有集成电路，不需要音频驱动电路，只需要接通直流电压就能直接发出声响；而无源蜂鸣器只有外加音频驱动信号才能发出声响。</p> 
<p>无源蜂鸣器与有源蜂鸣器不同，因其内部不带震荡源，所以其无法像有源蜂鸣器那样直接用直流信号驱动，这里需要使用PWM方法才能驱动其发生。<br> 输入不同频率和占空比的PWM方法发出的声音是不同的，其中频率对音频有影响，占空比对音量大小有影响。</p> 
<p><img src="https://images2.imgbox.com/a8/21/Fl2X4fcw_o.png" alt="在这里插入图片描述"><br> <br></p> 
<p><strong>模块设计</strong><br> <img src="https://images2.imgbox.com/57/6d/df4GUMA4_o.png" alt="在这里插入图片描述"><br> <strong>波形图绘制</strong><br> <img src="https://images2.imgbox.com/d4/5e/g1Yb57yx_o.png" alt="在这里插入图片描述"><br> <strong>beep.v</strong></p> 
<pre><code class="prism language-c">`timescale  <span class="token number">1</span>ns<span class="token operator">/</span><span class="token number">1</span>ns
module  beep
#<span class="token punctuation">(</span>
    parameter   TIME_500MS <span class="token operator">=</span>   <span class="token number">25</span>'d24999999<span class="token punctuation">,</span>   <span class="token comment">//0.5s计数值</span>
    parameter   DO  <span class="token operator">=</span>   <span class="token number">18</span>'d190839 <span class="token punctuation">,</span>   <span class="token comment">//"哆"音调分频计数值（频率262）</span>
    parameter   RE  <span class="token operator">=</span>   <span class="token number">18</span>'d170067 <span class="token punctuation">,</span>   <span class="token comment">//"来"音调分频计数值（频率294）</span>
    parameter   MI  <span class="token operator">=</span>   <span class="token number">18</span>'d151514 <span class="token punctuation">,</span>   <span class="token comment">//"咪"音调分频计数值（频率330）</span>
    parameter   FA  <span class="token operator">=</span>   <span class="token number">18</span>'d143265 <span class="token punctuation">,</span>   <span class="token comment">//"发"音调分频计数值（频率349）</span>
    parameter   SO  <span class="token operator">=</span>   <span class="token number">18</span>'d127550 <span class="token punctuation">,</span>   <span class="token comment">//"梭"音调分频计数值（频率392）</span>
    parameter   LA  <span class="token operator">=</span>   <span class="token number">18</span>'d113635 <span class="token punctuation">,</span>   <span class="token comment">//"拉"音调分频计数值（频率440）</span>
    parameter   XI  <span class="token operator">=</span>   <span class="token number">18</span>'d101214     <span class="token comment">//"西"音调分频计数值（频率494）</span>
<span class="token punctuation">)</span>
<span class="token punctuation">(</span>
    input   wire        sys_clk     <span class="token punctuation">,</span>   <span class="token comment">//系统时钟,频率50MHz</span>
    input   wire        sys_rst_n   <span class="token punctuation">,</span>   <span class="token comment">//系统复位，低有效</span>

    output  reg         beep            <span class="token comment">//输出蜂鸣器控制信号</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//reg   define</span>
reg     <span class="token punctuation">[</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>  cnt         <span class="token punctuation">;</span>   <span class="token comment">//0.5s计数器</span>
reg     <span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>  freq_cnt    <span class="token punctuation">;</span>   <span class="token comment">//音调计数器</span>
reg     <span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>   cnt_500ms   <span class="token punctuation">;</span>   <span class="token comment">//0.5s个数计数</span>
reg     <span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>  freq_data   <span class="token punctuation">;</span>   <span class="token comment">//音调分频计数值</span>

<span class="token comment">//wire  define</span>
wire    <span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">]</span>  duty_data   <span class="token punctuation">;</span>   <span class="token comment">//占空比计数值</span>

<span class="token comment">//cnt:0.5s循环计数器</span>
always@<span class="token punctuation">(</span>posedge sys_clk or  negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        cnt <span class="token operator">&lt;=</span>  <span class="token number">25</span>'d0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cnt <span class="token operator">==</span> TIME_500MS <span class="token punctuation">)</span>
        cnt <span class="token operator">&lt;=</span>   <span class="token number">25</span>'d0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        cnt <span class="token operator">&lt;=</span>  cnt <span class="token operator">+</span>   <span class="token number">1</span>'b1<span class="token punctuation">;</span>

<span class="token comment">//cnt_500ms：对500ms个数进行计数，每个音阶鸣叫时间0.5s，7个音节一循环</span>
always@<span class="token punctuation">(</span>posedge sys_clk or  negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        cnt_500ms   <span class="token operator">&lt;=</span>  <span class="token number">3</span>'d0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cnt <span class="token operator">==</span> TIME_500MS <span class="token operator">&amp;&amp;</span> cnt_500ms <span class="token operator">==</span>  <span class="token number">6</span><span class="token punctuation">)</span>
        cnt_500ms   <span class="token operator">&lt;=</span>  <span class="token number">3</span>'d0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cnt <span class="token operator">==</span> TIME_500MS<span class="token punctuation">)</span>
        cnt_500ms   <span class="token operator">&lt;=</span>  cnt_500ms <span class="token operator">+</span> <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    <span class="token keyword">else</span>   
        cnt_500ms   <span class="token operator">&lt;=</span>  cnt_500ms<span class="token punctuation">;</span>   <span class="token comment">//时序逻辑中可以不写，组合逻辑一定要写</span>

<span class="token comment">//freq_cnt：当计数到音阶计数值或跳转到下一音阶时，开始重新计数</span>
always@<span class="token punctuation">(</span>posedge sys_clk or  negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        freq_cnt    <span class="token operator">&lt;=</span>  <span class="token number">18</span>'d0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>freq_cnt <span class="token operator">==</span> freq_data <span class="token operator">||</span> cnt <span class="token operator">==</span> TIME_500MS<span class="token punctuation">)</span>
        freq_cnt    <span class="token operator">&lt;=</span>  <span class="token number">18</span>'d0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        freq_cnt    <span class="token operator">&lt;=</span>  freq_cnt <span class="token operator">+</span>  <span class="token number">1</span>'b1<span class="token punctuation">;</span>    
            
<span class="token comment">//不同时间鸣叫不同的音阶</span>
always@<span class="token punctuation">(</span>posedge sys_clk or  negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        freq_data   <span class="token operator">&lt;=</span>  DO<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">case</span><span class="token punctuation">(</span>cnt_500ms<span class="token punctuation">)</span>
        <span class="token number">0</span><span class="token operator">:</span>  freq_data   <span class="token operator">&lt;=</span>   DO<span class="token punctuation">;</span>
        <span class="token number">1</span><span class="token operator">:</span>  freq_data   <span class="token operator">&lt;=</span>   RE<span class="token punctuation">;</span>
        <span class="token number">2</span><span class="token operator">:</span>  freq_data   <span class="token operator">&lt;=</span>   MI<span class="token punctuation">;</span>
        <span class="token number">3</span><span class="token operator">:</span>  freq_data   <span class="token operator">&lt;=</span>   FA<span class="token punctuation">;</span>
        <span class="token number">4</span><span class="token operator">:</span>  freq_data   <span class="token operator">&lt;=</span>   SO<span class="token punctuation">;</span>
        <span class="token number">5</span><span class="token operator">:</span>  freq_data   <span class="token operator">&lt;=</span>   LA<span class="token punctuation">;</span>
        <span class="token number">6</span><span class="token operator">:</span>  freq_data   <span class="token operator">&lt;=</span>   XI<span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>  freq_data   <span class="token operator">&lt;=</span>   DO<span class="token punctuation">;</span>
    endcase

<span class="token comment">//设置50％占空比：音阶分频计数值的一半即为占空比的高电平数</span>
assign  duty_data   <span class="token operator">=</span>   freq_data   <span class="token operator">&gt;&gt;</span>    <span class="token number">1</span>'b1<span class="token punctuation">;</span>

<span class="token comment">//beep：输出蜂鸣器波形</span>
always@<span class="token punctuation">(</span>posedge sys_clk or  negedge sys_rst_n<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sys_rst_n <span class="token operator">==</span> <span class="token number">1</span>'b0<span class="token punctuation">)</span>
        beep    <span class="token operator">&lt;=</span>  <span class="token number">1</span>'b0<span class="token punctuation">;</span>
    <span class="token keyword">else</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>freq_cnt <span class="token operator">&gt;=</span> duty_data<span class="token punctuation">)</span>
        beep    <span class="token operator">&lt;=</span>  <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        beep    <span class="token operator">&lt;=</span>  <span class="token number">1</span>'b0<span class="token punctuation">;</span>

endmodule
</code></pre> 
<p><strong>tb_beep.v</strong></p> 
<pre><code class="prism language-c">`timescale  <span class="token number">1</span>ns<span class="token operator">/</span><span class="token number">1</span>ns
module  <span class="token function">tb_beep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//reg   define</span>
reg     sys_clk     <span class="token punctuation">;</span>   <span class="token comment">//时钟</span>
reg     sys_rst_n   <span class="token punctuation">;</span>   <span class="token comment">//复位</span>

<span class="token comment">//对时钟，复位信号赋初值</span>
initial
    begin
        sys_clk     <span class="token operator">=</span>   <span class="token number">1</span>'b1<span class="token punctuation">;</span>
        sys_rst_n   <span class="token operator">&lt;=</span>  <span class="token number">1</span>'b0<span class="token punctuation">;</span>
        #<span class="token number">100</span>
        sys_rst_n   <span class="token operator">&lt;=</span>  <span class="token number">1</span>'b1<span class="token punctuation">;</span>
    end

<span class="token comment">//产生时钟信号</span>
always #<span class="token number">10</span> sys_clk <span class="token operator">=</span>   <span class="token operator">~</span>sys_clk<span class="token punctuation">;</span>

beep
#<span class="token punctuation">(</span>
    <span class="token punctuation">.</span><span class="token function">TIME_500MS</span><span class="token punctuation">(</span><span class="token number">25</span>'d24999<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//0.5s计数值</span>
    <span class="token punctuation">.</span><span class="token function">DO</span>        <span class="token punctuation">(</span><span class="token number">18</span>'d190  <span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//"哆"音调分频计数值（频率262）</span>
    <span class="token punctuation">.</span><span class="token function">RE</span>        <span class="token punctuation">(</span><span class="token number">18</span>'d170  <span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//"来"音调分频计数值（频率294）</span>
    <span class="token punctuation">.</span><span class="token function">MI</span>        <span class="token punctuation">(</span><span class="token number">18</span>'d151  <span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//"咪"音调分频计数值（频率330）</span>
    <span class="token punctuation">.</span><span class="token function">FA</span>        <span class="token punctuation">(</span><span class="token number">18</span>'d143  <span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//"发"音调分频计数值（频率349）</span>
    <span class="token punctuation">.</span><span class="token function">SO</span>        <span class="token punctuation">(</span><span class="token number">18</span>'d127  <span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//"梭"音调分频计数值（频率392）</span>
    <span class="token punctuation">.</span><span class="token function">LA</span>        <span class="token punctuation">(</span><span class="token number">18</span>'d113  <span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//"拉"音调分频计数值（频率440）</span>
    <span class="token punctuation">.</span><span class="token function">XI</span>        <span class="token punctuation">(</span><span class="token number">18</span>'d101  <span class="token punctuation">)</span>    <span class="token comment">//"西"音调分频计数值（频率494）</span>
<span class="token punctuation">)</span>
<span class="token function">beep_inst</span>
<span class="token punctuation">(</span>
    <span class="token punctuation">.</span><span class="token function">sys_clk</span>     <span class="token punctuation">(</span>sys_clk   <span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//系统时钟,频率50MHz</span>
    <span class="token punctuation">.</span><span class="token function">sys_rst_n</span>   <span class="token punctuation">(</span>sys_rst_n <span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//系统复位，低有效</span>

    <span class="token punctuation">.</span><span class="token function">beep</span>        <span class="token punctuation">(</span>beep      <span class="token punctuation">)</span>    <span class="token comment">//输出蜂鸣器控制信号</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

endmodule
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7216d67ee9c0ac1d9b2fa8fcda0f7b3b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">写一段python爬取付费音乐的代码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6509e03940c58420047847f48af2c386/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Your password does not satisfy the current policy requirements.mysql密码不能设为root</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>