<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>uniapp使用阿里云OSS直接上传文件 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="uniapp使用阿里云OSS直接上传文件" />
<meta property="og:description" content="背景 由于服务器带宽优先，很多时候上传文件，尤其是视频文件，稍微大一点上传速度有很慢，加上一些安全方面的原因，我还是喜欢将文件直接上传到阿里云OSS上，但是在uniapp中配置上传相对有点繁琐，这里记录一下，也方便大家直接拷贝使用。
流程 1.阿里云后台获取相关key
这里用需要三个数据
分别是：
1.accessid：
2.accesskey:
3.Bucket域名：
前两个大家都知道，最后一个由于阿里云后台都写在一起，比较容易搞混，这里截图给大家参考下
2.小程序端配置js文件
小程序主要配置4个文件和一个调用文件：crypto.js，hmac.js，sha1.js，base64.js
这四个文件我把代码放在下面，大家也可以直接网上下载。
最后一个aliyun.js是配置和调用的。
由于我习惯了网站的文件管理习惯，所以都放在了&#34;/static/js&#34;文件夹下，文件夹也是新建的，大家可以根据自己的习惯去修改路劲，不过修改路径的话记得前面的几个文件中的调用也要修改下。想偷懒就按的路劲来也可以的。
3.前端调用
代码调用就直接抄我的吧
代码 crypto.js
var base64map = &#34;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#43;/&#34;; let Crypto = {}; var util = Crypto.util = { rotl: function (n, b) { return (n &lt;&lt; b) | (n &gt;&gt;&gt; (32 - b)); }, rotr: function (n, b) { return (n &lt;&lt; (32 - b)) | (n &gt;&gt;&gt; b); }, endian: function (n) { if (n." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/787db74861ad084a68677d0c9435c638/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-12T14:53:18+08:00" />
<meta property="article:modified_time" content="2022-05-12T14:53:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">uniapp使用阿里云OSS直接上传文件</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>背景</h2> 
<p>由于服务器带宽优先，很多时候上传文件，尤其是视频文件，稍微大一点上传速度有很慢，加上一些安全方面的原因，我还是喜欢将文件直接上传到阿里云OSS上，但是在uniapp中配置上传相对有点繁琐，这里记录一下，也方便大家直接拷贝使用。</p> 
<h2><a id="_2"></a>流程</h2> 
<p>1.阿里云后台获取相关key<br> 这里用需要三个数据<br> 分别是：<br> 1.accessid：<br> 2.accesskey:<br> 3.Bucket域名：<br> 前两个大家都知道，最后一个由于阿里云后台都写在一起，比较容易搞混，这里截图给大家参考下<br> <img src="https://images2.imgbox.com/52/2c/ddTg1mjl_o.png" alt="在这里插入图片描述"></p> 
<p>2.小程序端配置js文件<br> 小程序主要配置4个文件和一个调用文件：crypto.js，hmac.js，sha1.js，base64.js<br> 这四个文件我把代码放在下面，大家也可以直接网上下载。<br> 最后一个aliyun.js是配置和调用的。<br> 由于我习惯了网站的文件管理习惯，所以都放在了"/static/js"文件夹下，文件夹也是新建的，大家可以根据自己的习惯去修改路劲，不过修改路径的话记得前面的几个文件中的调用也要修改下。想偷懒就按的路劲来也可以的。<br> 3.前端调用<br> 代码调用就直接抄我的吧</p> 
<h2><a id="_19"></a>代码</h2> 
<p>crypto.js</p> 
<pre><code>var base64map = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
let Crypto = {};
var util = Crypto.util = {
    rotl: function (n, b) {
        return (n &lt;&lt; b) | (n &gt;&gt;&gt; (32 - b));
    },
    rotr: function (n, b) {
        return (n &lt;&lt; (32 - b)) | (n &gt;&gt;&gt; b);
    },
    endian: function (n) {
        if (n.constructor == Number) {
            return util.rotl(n,  8) &amp; 0x00FF00FF |
                   util.rotl(n, 24) &amp; 0xFF00FF00;
        }
        for (var i = 0; i &lt; n.length; i++)
            n[i] = util.endian(n[i]);
        return n;
    },
    randomBytes: function (n) {
        for (var bytes = []; n &gt; 0; n--)
            bytes.push(Math.floor(Math.random() * 256));
        return bytes;
    },
    stringToBytes: function (str) {
        var bytes = [];
        for (var i = 0; i &lt; str.length; i++)
            bytes.push(str.charCodeAt(i));
        return bytes;
    },
    bytesToString: function (bytes) {
        var str = [];
        for (var i = 0; i &lt; bytes.length; i++)
            str.push(String.fromCharCode(bytes[i]));
        return str.join("");
    },
    stringToWords: function (str) {
        var words = [];
        for (var c = 0, b = 0; c &lt; str.length; c++, b += 8)
            words[b &gt;&gt;&gt; 5] |= str.charCodeAt(c) &lt;&lt; (24 - b % 32);
        return words;
    },
    bytesToWords: function (bytes) {
        var words = [];
        for (var i = 0, b = 0; i &lt; bytes.length; i++, b += 8)
            words[b &gt;&gt;&gt; 5] |= bytes[i] &lt;&lt; (24 - b % 32);
        return words;
    },
    wordsToBytes: function (words) {
        var bytes = [];
        for (var b = 0; b &lt; words.length * 32; b += 8)
            bytes.push((words[b &gt;&gt;&gt; 5] &gt;&gt;&gt; (24 - b % 32)) &amp; 0xFF);
        return bytes;
    },
    bytesToHex: function (bytes) {
        var hex = [];
        for (var i = 0; i &lt; bytes.length; i++) {
            hex.push((bytes[i] &gt;&gt;&gt; 4).toString(16));
            hex.push((bytes[i] &amp; 0xF).toString(16));
        }
        return hex.join("");
    },
    hexToBytes: function (hex) {
        var bytes = [];
        for (var c = 0; c &lt; hex.length; c += 2)
            bytes.push(parseInt(hex.substr(c, 2), 16));
        return bytes;
    },
    bytesToBase64: function (bytes) {
        if (typeof btoa == "function") return btoa(util.bytesToString(bytes));
        var base64 = [],
            overflow;
        for (var i = 0; i &lt; bytes.length; i++) {
            switch (i % 3) {
                case 0:
                    base64.push(base64map.charAt(bytes[i] &gt;&gt;&gt; 2));
                    overflow = (bytes[i] &amp; 0x3) &lt;&lt; 4;
                    break;
                case 1:
                    base64.push(base64map.charAt(overflow | (bytes[i] &gt;&gt;&gt; 4)));
                    overflow = (bytes[i] &amp; 0xF) &lt;&lt; 2;
                    break;
                case 2:
                    base64.push(base64map.charAt(overflow | (bytes[i] &gt;&gt;&gt; 6)));
                    base64.push(base64map.charAt(bytes[i] &amp; 0x3F));
                    overflow = -1;
            }
        }
        if (overflow != undefined &amp;&amp; overflow != -1)
            base64.push(base64map.charAt(overflow));
        while (base64.length % 4 != 0) base64.push("=");
        return base64.join("");
    },
    base64ToBytes: function (base64) {
        if (typeof atob == "function") return util.stringToBytes(atob(base64));
        base64 = base64.replace(/[^A-Z0-9+\/]/ig, "");
        var bytes = [];
        for (var i = 0; i &lt; base64.length; i++) {
            switch (i % 4) {
                case 1:
                    bytes.push((base64map.indexOf(base64.charAt(i - 1)) &lt;&lt; 2) |
                               (base64map.indexOf(base64.charAt(i)) &gt;&gt;&gt; 4));
                    break;
                case 2:
                    bytes.push(((base64map.indexOf(base64.charAt(i - 1)) &amp; 0xF) &lt;&lt; 4) |
                               (base64map.indexOf(base64.charAt(i)) &gt;&gt;&gt; 2));
                    break;
                case 3:
                    bytes.push(((base64map.indexOf(base64.charAt(i - 1)) &amp; 0x3) &lt;&lt; 6) |
                               (base64map.indexOf(base64.charAt(i))));
                    break;
            }
        }
        return bytes;
    }
};
Crypto.mode = {};
export default Crypto;
</code></pre> 
<p>hmac.js</p> 
<pre><code>import Crypto from '@/static/js/crypto.js';
/*!
 * Crypto-JS v1.1.0
 * http://code.google.com/p/crypto-js/
 * Copyright (c) 2009, Jeff Mott. All rights reserved.
 * http://code.google.com/p/crypto-js/wiki/License
 */
(function(){

// Shortcut
var util = Crypto.util;

Crypto.HMAC = function (hasher, message, key, options) {

    // Allow arbitrary length keys
    key = key.length &gt; hasher._blocksize * 4 ?
          hasher(key, { asBytes: true }) :
          util.stringToBytes(key);

    // XOR keys with pad constants
    var okey = key,
        ikey = key.slice(0);
    for (var i = 0; i &lt; hasher._blocksize * 4; i++) {
        okey[i] ^= 0x5C;
        ikey[i] ^= 0x36;
    }

    var hmacbytes = hasher(util.bytesToString(okey) +
                           hasher(util.bytesToString(ikey) + message, { asString: true }),
                           { asBytes: true });
    return options &amp;&amp; options.asBytes ? hmacbytes :
           options &amp;&amp; options.asString ? util.bytesToString(hmacbytes) :
           util.bytesToHex(hmacbytes);

};

})();

</code></pre> 
<p>sha1.js</p> 
<pre><code>import Crypto from '@/static/js/crypto.js';
/*!
 * Crypto-JS v1.1.0
 * http://code.google.com/p/crypto-js/
 * Copyright (c) 2009, Jeff Mott. All rights reserved.
 * http://code.google.com/p/crypto-js/wiki/License
 */
(function(){

// Shortcut
var util = Crypto.util;

// Public API
var SHA1 = Crypto.SHA1 = function (message, options) {
    var digestbytes = util.wordsToBytes(SHA1._sha1(message));
    return options &amp;&amp; options.asBytes ? digestbytes :
           options &amp;&amp; options.asString ? util.bytesToString(digestbytes) :
           util.bytesToHex(digestbytes);
};

// The core
SHA1._sha1 = function (message) {

    var m  = util.stringToWords(message),
        l  = message.length * 8,
        w  =  [],
        H0 =  1732584193,
        H1 = -271733879,
        H2 = -1732584194,
        H3 =  271733878,
        H4 = -1009589776;

    // Padding
    m[l &gt;&gt; 5] |= 0x80 &lt;&lt; (24 - l % 32);
    m[((l + 64 &gt;&gt;&gt; 9) &lt;&lt; 4) + 15] = l;

    for (var i = 0; i &lt; m.length; i += 16) {

        var a = H0,
            b = H1,
            c = H2,
            d = H3,
            e = H4;

        for (var j = 0; j &lt; 80; j++) {

            if (j &lt; 16) w[j] = m[i + j];
            else {
                var n = w[j-3] ^ w[j-8] ^ w[j-14] ^ w[j-16];
                w[j] = (n &lt;&lt; 1) | (n &gt;&gt;&gt; 31);
            }

            var t = ((H0 &lt;&lt; 5) | (H0 &gt;&gt;&gt; 27)) + H4 + (w[j] &gt;&gt;&gt; 0) + (
                     j &lt; 20 ? (H1 &amp; H2 | ~H1 &amp; H3) + 1518500249 :
                     j &lt; 40 ? (H1 ^ H2 ^ H3) + 1859775393 :
                     j &lt; 60 ? (H1 &amp; H2 | H1 &amp; H3 | H2 &amp; H3) - 1894007588 :
                              (H1 ^ H2 ^ H3) - 899497514);

            H4 =  H3;
            H3 =  H2;
            H2 = (H1 &lt;&lt; 30) | (H1 &gt;&gt;&gt; 2);
            H1 =  H0;
            H0 =  t;

        }

        H0 += a;
        H1 += b;
        H2 += c;
        H3 += d;
        H4 += e;

    }

    return [H0, H1, H2, H3, H4];

};

// Package private blocksize
SHA1._blocksize = 16;

})();

</code></pre> 
<p>base64.js</p> 
<pre><code>export const Base64 = {

        // private property
        _keyStr : "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",

        // public method for encoding
        encode : function (input) {
            var output = "";
            var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
            var i = 0;

            input = Base64._utf8_encode(input);

            while (i &lt; input.length) {

                chr1 = input.charCodeAt(i++);
                chr2 = input.charCodeAt(i++);
                chr3 = input.charCodeAt(i++);

                enc1 = chr1 &gt;&gt; 2;
                enc2 = ((chr1 &amp; 3) &lt;&lt; 4) | (chr2 &gt;&gt; 4);
                enc3 = ((chr2 &amp; 15) &lt;&lt; 2) | (chr3 &gt;&gt; 6);
                enc4 = chr3 &amp; 63;

                if (isNaN(chr2)) {
                    enc3 = enc4 = 64;
                } else if (isNaN(chr3)) {
                    enc4 = 64;
                }

                output = output +
                this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +
                this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);

            }

            return output;
        },

        // public method for decoding
        decode : function (input) {
            var output = "";
            var chr1, chr2, chr3;
            var enc1, enc2, enc3, enc4;
            var i = 0;

            input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");

            while (i &lt; input.length) {

                enc1 = this._keyStr.indexOf(input.charAt(i++));
                enc2 = this._keyStr.indexOf(input.charAt(i++));
                enc3 = this._keyStr.indexOf(input.charAt(i++));
                enc4 = this._keyStr.indexOf(input.charAt(i++));

                chr1 = (enc1 &lt;&lt; 2) | (enc2 &gt;&gt; 4);
                chr2 = ((enc2 &amp; 15) &lt;&lt; 4) | (enc3 &gt;&gt; 2);
                chr3 = ((enc3 &amp; 3) &lt;&lt; 6) | enc4;

                output = output + String.fromCharCode(chr1);

                if (enc3 != 64) {
                    output = output + String.fromCharCode(chr2);
                }
                if (enc4 != 64) {
                    output = output + String.fromCharCode(chr3);
                }

            }

            output = Base64._utf8_decode(output);

            return output;

        },

        // private method for UTF-8 encoding
        _utf8_encode : function (string) {
            string = string.replace(/\r\n/g,"\n");
            var utftext = "";

            for (var n = 0; n &lt; string.length; n++) {

                var c = string.charCodeAt(n);

                if (c &lt; 128) {
                    utftext += String.fromCharCode(c);
                }
                else if((c &gt; 127) &amp;&amp; (c &lt; 2048)) {
                    utftext += String.fromCharCode((c &gt;&gt; 6) | 192);
                    utftext += String.fromCharCode((c &amp; 63) | 128);
                }
                else {
                    utftext += String.fromCharCode((c &gt;&gt; 12) | 224);
                    utftext += String.fromCharCode(((c &gt;&gt; 6) &amp; 63) | 128);
                    utftext += String.fromCharCode((c &amp; 63) | 128);
                }

            }

            return utftext;
        },

        // private method for UTF-8 decoding
        _utf8_decode : function (utftext) {
            var string = "";
            var i = 0;
            var c = c1 = c2 = 0;

            while ( i &lt; utftext.length ) {

                c = utftext.charCodeAt(i);

                if (c &lt; 128) {
                    string += String.fromCharCode(c);
                    i++;
                }
                else if((c &gt; 191) &amp;&amp; (c &lt; 224)) {
                    c2 = utftext.charCodeAt(i+1);
                    string += String.fromCharCode(((c &amp; 31) &lt;&lt; 6) | (c2 &amp; 63));
                    i += 2;
                }
                else {
                    c2 = utftext.charCodeAt(i+1);
                    c3 = utftext.charCodeAt(i+2);
                    string += String.fromCharCode(((c &amp; 15) &lt;&lt; 12) | ((c2 &amp; 63) &lt;&lt; 6) | (c3 &amp; 63));
                    i += 3;
                }

            }

            return string;
        }

    }

</code></pre> 
<p>aliyun.js</p> 
<pre><code>import Crypto from '@/static/js/crypto.js';
	import '@/static/js/hmac.js';
	import '@/static/js/sha1.js';
	import {Base64} from '@/static/js/base64.js';
	
	let date=new Date()
	date=date.setHours(date.getHours() + 1)
	let extime=""+new Date(date).toISOString()
	var policyText = {
		"expiration": extime, //设置该Policy的失效时间，超过这个失效时间之后，就没有办法通过这个policy上传文件了
		"conditions": [
			["content-length-range", 0, 1024*1024*100] // 设置上传文件的大小限制 
		]
	};	
	var config={
		accessid:'LTAI**********************',
		accesskey:'wSs****************************Yq2f',
		osshost:'https://*******.oss-cn-shanghai.aliyuncs.com',
		policyBase64:Base64.encode(JSON.stringify(policyText))
	}
	var message = policyBase64;
	var bytes = Crypto.HMAC(Crypto.SHA1, message, accesskey, { asBytes: true }) ;
	var signature = Crypto.util.bytesToBase64(bytes);
	var timetamp = new Date().getTime();
	function random_string(len) {
	　　len = len || 32;
	　　var chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';   
	　　var maxPos = chars.length;
	　　var pwd = '';
	　　for (let i = 0; i &lt; len; i++) {
		　　pwd += chars.charAt(Math.floor(Math.random() * maxPos));
		}
		return pwd;
	}
var OSS={
		name:'aliyun',
		host:config.osshost,
		accessid:config.accessid,
		signature:signature,
		policyBase64:policyBase64,
	}
	export default OSS;
</code></pre> 
<p>前端调用<br> dom</p> 
<pre><code>&lt;view class="btn" @click="selectVideo"&gt;选择视频&lt;/view&gt;
</code></pre> 
<p>js引入文件</p> 
<pre><code>import OSS from '@/static/js/aliyun.js';
</code></pre> 
<p>methods</p> 
<pre><code>selectVideo(){
				let that=this
				uni.chooseVideo({  //打开选择视频 
					sourceType: ['album'],  //直接打开选择视频 ['album','camera'] 就会弹出选框
					success: function (res) {
						that.video = res.tempFilePath;  //res.tempFilePath里面就是你选择到的视频
						console.log(that.video)
						if(res.size &gt; OSS.uploadFileSize){	 //OSS.uploadFileSize在aliyun.js里面设置，
							uni.showToast({
								title: '文件大小超过系统上传限制：' + OSS.uploadFileSize,
								icon: 'none',
								duration: 1000
							});
							return;
						}
							
						var date=new Date;var year=date.getFullYear(); var month=date.getMonth()+1;
						let filePath='test/'+year+"-"+month+"/"+Date.parse(new Date())+parseInt(Math.random()*(100000-10000+1)+10000,10)+".mp4"	//路径自己修改
						that.fileUpload('video', that.video, filePath);
						that.info.video=OSS.host+"/"+filePath
					}
				});
			},
			fileUpload(type, path, stroeAs){
				console.log('开始上传')
				let self = this;
				return new Promise((resolve, reject) =&gt; {
				uni.uploadFile({
					url: OSS.host,
					filePath: path,
					name: 'file',
					formData:{'key': stroeAs,'policy': OSS.policyBase64,'OSSAccessKeyId': OSS.accessid, 'success_action_status': '200','signature': OSS.signature,},
					success: (res) =&gt; {
						console.log(res)
						uni.showToast({
							title: '上传成功',
							icon: 'success',
							duration: 1000
						});
						console.log(OSS.host +'/'+ stroeAs)
						resolve('suc');
					},
					fail: (err) =&gt; {
						console.log('upload fail', err);
						uni.showModal({
							content: err.errMsg,
							showCancel: false
						});
						reject('err')
					}
				});
				
				})
			},
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c0758ba8902fa48401efc6af6a81ac70/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Centos 7操作系统，可ping通，但无法ssh</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/48dbe28bc7a6f4afd144bba8f51d5661/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AndroidStudio开发APP和ESP8266进行联网传输数据</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>