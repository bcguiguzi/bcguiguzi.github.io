<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>实战篇--常见的Shell脚本编写（二） - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="实战篇--常见的Shell脚本编写（二）" />
<meta property="og:description" content="常见的Shell脚本编写（二） 1.11 屏蔽网站访问频繁的IP1.12 判断输入是否为IP1.13 判断输入是否为数字1.15 监控目录，将新创建的文件名追加到日志中1.17 查看网卡实时流量1.18 MySQL数据库备份1.19 Nginx启动脚本1.20 选择SSH连接主机 1.11 屏蔽网站访问频繁的IP 1）屏蔽每分钟访问超过200的IP
方法1：以Nginx日志作为测试
DATE=$(date &#43;%d/%b/%Y:%H:%M) ABNORMAL_IP=$(tail -n5000 access.log |grep $DATE |awk &#39;{a[$1]&#43;&#43;}END{for(i in a)if(a[i]&gt;100)print i}&#39;) #先tail防止文件过大，读取慢，数字可调整每分钟最大的访问量。awk不能直接过滤日志，因为包含特殊字符。 for IP in $ABNORMAL_IP; do if [ $(iptables -vnL |grep -c &#34;$IP&#34;) -eq 0 ]; then iptables -I INPUT -s $IP -j DROP fi done 方法2：通过建立连接数
ABNORMAL_IP=$(netstat -an |awk &#39;$4~/:80$/ &amp;&amp; $6~/ESTABLISHED/{gsub(/:[0-9]&#43;/,&#34;&#34;,$5);{a[$5]&#43;&#43;}}END{for(i in a)if(a[i]&gt;100)print i}&#39;) #gsub是将第五列（客户端IP）的冒号和端口去掉 for IP in $ABNORMAL_IP; do if [ $(iptables -vnL |grep -c &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/b08791187f62372c1799b1961f35e00c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-15T23:41:44+08:00" />
<meta property="article:modified_time" content="2020-10-15T23:41:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">实战篇--常见的Shell脚本编写（二）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>常见的Shell脚本编写（二）</h4> 
 <ul><li><ul><li><a href="#111_IP_1" rel="nofollow">1.11 屏蔽网站访问频繁的IP</a></li><li><a href="#112_IP_52" rel="nofollow">1.12 判断输入是否为IP</a></li><li><a href="#113__118" rel="nofollow">1.13 判断输入是否为数字</a></li><li><a href="#115__147" rel="nofollow">1.15 监控目录，将新创建的文件名追加到日志中</a></li><li><a href="#117__199" rel="nofollow">1.17 查看网卡实时流量</a></li><li><a href="#118_MySQL_238" rel="nofollow">1.18 MySQL数据库备份</a></li><li><a href="#119_Nginx_262" rel="nofollow">1.19 Nginx启动脚本</a></li><li><a href="#120_SSH_335" rel="nofollow">1.20 选择SSH连接主机</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="111_IP_1"></a>1.11 屏蔽网站访问频繁的IP</h3> 
<p>1）屏蔽每分钟访问超过200的IP</p> 
<p>方法1：以Nginx日志作为测试</p> 
<pre><code class="prism language-shell">DATE<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%d/%b/%Y:%H:%M<span class="token variable">)</span></span>
ABNORMAL_IP<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">tail</span> -n5000 access.log <span class="token operator">|</span><span class="token function">grep</span> $DATE <span class="token operator">|</span><span class="token function">awk</span> '<span class="token punctuation">{<!-- --></span>a<span class="token punctuation">[</span>$1<span class="token punctuation">]</span>++<span class="token punctuation">}</span>END<span class="token punctuation">{<!-- --></span>for<span class="token punctuation">(</span>i <span class="token keyword">in</span> a<span class="token variable">)</span></span>if<span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;</span>100<span class="token punctuation">)</span>print i<span class="token punctuation">}</span>'<span class="token punctuation">)</span>
<span class="token comment">#先tail防止文件过大，读取慢，数字可调整每分钟最大的访问量。awk不能直接过滤日志，因为包含特殊字符。</span>
<span class="token keyword">for</span> IP <span class="token keyword">in</span> <span class="token variable">$ABNORMAL_IP</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">$(</span>iptables -vnL <span class="token operator">|</span><span class="token function">grep</span> -c <span class="token string">"<span class="token variable">$IP</span>"</span><span class="token variable">)</span></span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        iptables -I INPUT -s <span class="token variable">$IP</span> -j DROP
    <span class="token keyword">fi</span>
<span class="token keyword">done</span>
</code></pre> 
<p>方法2：通过建立连接数</p> 
<pre><code class="prism language-shell">ABNORMAL_IP<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">netstat</span> -an <span class="token operator">|</span><span class="token function">awk</span> '$4~/:80$/ <span class="token operator">&amp;&amp;</span> $6~/ESTABLISHED/<span class="token punctuation">{<!-- --></span>gsub<span class="token punctuation">(</span>/:<span class="token punctuation">[</span>0-9<span class="token punctuation">]</span>+/,<span class="token string">""</span>,$5<span class="token variable">)</span></span><span class="token punctuation">;</span><span class="token punctuation">{<!-- --></span>a<span class="token punctuation">[</span><span class="token variable">$5</span><span class="token punctuation">]</span>++<span class="token punctuation">}</span><span class="token punctuation">}</span>END<span class="token punctuation">{<!-- --></span>for<span class="token punctuation">(</span>i <span class="token keyword">in</span> a<span class="token punctuation">)</span>if<span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;</span>100<span class="token punctuation">)</span>print i<span class="token punctuation">}</span>'<span class="token punctuation">)</span>
<span class="token comment">#gsub是将第五列（客户端IP）的冒号和端口去掉</span>
<span class="token keyword">for</span> IP <span class="token keyword">in</span> <span class="token variable">$ABNORMAL_IP</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">$(</span>iptables -vnL <span class="token operator">|</span><span class="token function">grep</span> -c <span class="token string">"<span class="token variable">$IP</span>"</span><span class="token variable">)</span></span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        iptables -I INPUT -s <span class="token variable">$IP</span> -j DROP
    <span class="token keyword">fi</span>
<span class="token keyword">done</span>
</code></pre> 
<p>2）屏蔽每分钟SSH暴力破解超过10次的IP</p> 
<p>方法1：通过lastb获取登录状态:</p> 
<pre><code class="prism language-shell">DATE<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">"%a %b %e %H:%M"</span><span class="token variable">)</span></span> <span class="token comment">#星期月天时分  %e单数字时显示7，而%d显示07</span>
ABNORMAL_IP<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>lastb <span class="token operator">|</span><span class="token function">grep</span> <span class="token string">"<span class="token variable">$DATE</span>"</span> <span class="token operator">|</span><span class="token function">awk</span> '<span class="token punctuation">{<!-- --></span>a<span class="token punctuation">[</span>$3<span class="token punctuation">]</span>++<span class="token punctuation">}</span>END<span class="token punctuation">{<!-- --></span>for<span class="token punctuation">(</span>i <span class="token keyword">in</span> a<span class="token variable">)</span></span>if<span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;</span>10<span class="token punctuation">)</span>print i<span class="token punctuation">}</span>'<span class="token punctuation">)</span>
<span class="token keyword">for</span> IP <span class="token keyword">in</span> <span class="token variable">$ABNORMAL_IP</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">$(</span>iptables -vnL <span class="token operator">|</span><span class="token function">grep</span> -c <span class="token string">"<span class="token variable">$IP</span>"</span><span class="token variable">)</span></span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        iptables -I INPUT -s <span class="token variable">$IP</span> -j DROP
    <span class="token keyword">fi</span>
<span class="token keyword">done</span>
</code></pre> 
<p>方法2：通过日志获取登录状态</p> 
<pre><code class="prism language-shell">DATE<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">"%b %d %H"</span><span class="token variable">)</span></span>
ABNORMAL_IP<span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">tail</span> -n10000 /var/log/auth.log <span class="token operator">|</span><span class="token function">grep</span> <span class="token string">"<span class="token variable">$DATE</span>"</span> <span class="token operator">|</span><span class="token function">awk</span> '/Failed/<span class="token punctuation">{<!-- --></span>a<span class="token punctuation">[</span><span class="token punctuation">$(</span>NF-3<span class="token variable">)</span></span>]++}END{for(i in a)if(a[i]&gt;5)print i}')"</span>
<span class="token keyword">for</span> IP <span class="token keyword">in</span> <span class="token variable">$ABNORMAL_IP</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">$(</span>iptables -vnL <span class="token operator">|</span><span class="token function">grep</span> -c <span class="token string">"<span class="token variable">$IP</span>"</span><span class="token variable">)</span></span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        iptables -A INPUT -s <span class="token variable">$IP</span> -j DROP
        <span class="token keyword">echo</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">"%F %T"</span><span class="token variable">)</span></span> - iptables -A INPUT -s <span class="token variable">$IP</span> -j DROP"</span> <span class="token operator">&gt;&gt;</span>~/ssh-login-limit.log
    <span class="token keyword">fi</span>
<span class="token keyword">done</span>
</code></pre> 
<h3><a id="112_IP_52"></a>1.12 判断输入是否为IP</h3> 
<p>方法1:</p> 
<pre><code class="prism language-shell"><span class="token keyword">function</span> check_ip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    IP<span class="token operator">=</span><span class="token variable">$1</span>
    VALID_CHECK<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> $IP<span class="token operator">|</span><span class="token function">awk</span> -F. <span class="token string">'<span class="token variable">$1</span>&lt;=255&amp;&amp;<span class="token variable">$2</span>&lt;=255&amp;&amp;<span class="token variable">$3</span>&lt;=255&amp;&amp;<span class="token variable">$4</span>&lt;=255{print "yes"}'</span><span class="token variable">)</span></span>
    <span class="token keyword">if</span> <span class="token keyword">echo</span> <span class="token variable">$IP</span><span class="token operator">|</span><span class="token function">grep</span> -E <span class="token string">"^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$"</span><span class="token operator">&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$VALID_CHECK</span> <span class="token operator">==</span> <span class="token string">"yes"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$IP</span> available."</span>
        <span class="token keyword">else</span>
            <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$IP</span> not available!"</span>
        <span class="token keyword">fi</span>
    <span class="token keyword">else</span>
        <span class="token keyword">echo</span> <span class="token string">"Format error!"</span>
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>
check_ip 192.168.1.1
check_ip 256.1.1.1
</code></pre> 
<p>方法2：</p> 
<pre><code class="prism language-shell"><span class="token keyword">function</span> check_ip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    IP<span class="token operator">=</span><span class="token variable">$1</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$IP</span> <span class="token operator">=</span>~ ^<span class="token punctuation">[</span>0-9<span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>1,3<span class="token punctuation">}</span>\.<span class="token punctuation">[</span>0-9<span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>1,3<span class="token punctuation">}</span>\.<span class="token punctuation">[</span>0-9<span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>1,3<span class="token punctuation">}</span>\.<span class="token punctuation">[</span>0-9<span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>1,3<span class="token punctuation">}</span>$ <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        FIELD1<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> $IP<span class="token operator">|</span><span class="token function">cut</span> -d. -f1<span class="token variable">)</span></span>
        FIELD2<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> $IP<span class="token operator">|</span><span class="token function">cut</span> -d. -f2<span class="token variable">)</span></span>
        FIELD3<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> $IP<span class="token operator">|</span><span class="token function">cut</span> -d. -f3<span class="token variable">)</span></span>
        FIELD4<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> $IP<span class="token operator">|</span><span class="token function">cut</span> -d. -f4<span class="token variable">)</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$FIELD1</span> -le 255 -a <span class="token variable">$FIELD2</span> -le 255 -a <span class="token variable">$FIELD3</span> -le 255 -a <span class="token variable">$FIELD4</span> -le 255 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$IP</span> available."</span>
        <span class="token keyword">else</span>
            <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$IP</span> not available!"</span>
        <span class="token keyword">fi</span>
    <span class="token keyword">else</span>
        <span class="token keyword">echo</span> <span class="token string">"Format error!"</span>
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>
check_ip 192.168.1.1
check_ip 256.1.1.1
</code></pre> 
<p>增加版：加个死循环，如果IP可用就退出，不可用提示继续输入，并使用awk判断</p> 
<pre><code class="prism language-shell"><span class="token keyword">function</span> check_ip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    local IP<span class="token operator">=</span><span class="token variable">$1</span>
    VALID_CHECK<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> $IP<span class="token operator">|</span><span class="token function">awk</span> -F. <span class="token string">'<span class="token variable">$1</span>&lt;=255&amp;&amp;<span class="token variable">$2</span>&lt;=255&amp;&amp;<span class="token variable">$3</span>&lt;=255&amp;&amp;<span class="token variable">$4</span>&lt;=255{print "yes"}'</span><span class="token variable">)</span></span>
    <span class="token keyword">if</span> <span class="token keyword">echo</span> <span class="token variable">$IP</span><span class="token operator">|</span><span class="token function">grep</span> -E <span class="token string">"^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$"</span> <span class="token operator">&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$VALID_CHECK</span> <span class="token operator">==</span> <span class="token string">"yes"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token keyword">return</span> 0
        <span class="token keyword">else</span>
            <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$IP</span> not available!"</span>
            <span class="token keyword">return</span> 1
        <span class="token keyword">fi</span>
    <span class="token keyword">else</span>
        <span class="token keyword">echo</span> <span class="token string">"Format error! Please input again."</span>
        <span class="token keyword">return</span> 1
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>
<span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token function">read</span> -p <span class="token string">"Please enter IP: "</span> IP
    check_ip <span class="token variable">$IP</span>
    <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq 0 <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">break</span> <span class="token operator">||</span> <span class="token keyword">continue</span>
<span class="token keyword">done</span>
</code></pre> 
<h3><a id="113__118"></a>1.13 判断输入是否为数字</h3> 
<pre><code class="prism language-shell">方法1：
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$1</span> <span class="token operator">=</span>~ ^<span class="token punctuation">[</span>0-9<span class="token punctuation">]</span>+$ <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token keyword">echo</span> <span class="token string">"Is Number."</span>
<span class="token keyword">else</span>
    <span class="token keyword">echo</span> <span class="token string">"No Number."</span>
<span class="token keyword">fi</span>
方法2：
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$1</span> -gt 0 <span class="token punctuation">]</span> 2<span class="token operator">&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token keyword">echo</span> <span class="token string">"Is Number."</span>
<span class="token keyword">else</span>
    <span class="token keyword">echo</span> <span class="token string">"No Number."</span>
<span class="token keyword">fi</span>
</code></pre> 
<p>方法3：</p> 
<pre><code class="prism language-powershell"><span class="token function">echo</span> <span class="token variable">$1</span> <span class="token punctuation">|</span>awk <span class="token string">'{print $0~/^[0-9]+$/?"Is Number.":"No Number."}'</span>  <span class="token comment">#三目运算符</span>
12<span class="token punctuation">.</span>14 找出包含关键字的文件
<span class="token function">DIR</span>=<span class="token variable">$1</span>
KEY=<span class="token variable">$2</span>
<span class="token keyword">for</span> FILE in $<span class="token punctuation">(</span>find <span class="token variable">$DIR</span> <span class="token operator">-</span><span class="token function">type</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> grep <span class="token variable">$KEY</span> <span class="token variable">$FILE</span> &amp;&gt;<span class="token operator">/</span>dev<span class="token operator">/</span>null<span class="token punctuation">;</span> then
        <span class="token function">echo</span> <span class="token string">"--&gt; <span class="token variable">$FILE</span>"</span>
    fi
done
</code></pre> 
<h3><a id="115__147"></a>1.15 监控目录，将新创建的文件名追加到日志中</h3> 
<p>需安装inotify-tools软件包</p> 
<pre><code class="prism language-shell"><span class="token shebang important">#!/bin/bash</span>
MON_DIR<span class="token operator">=</span>/opt
inotifywait -mq --format %f -e create <span class="token variable">$MON_DIR</span> <span class="token operator">|</span>\
<span class="token keyword">while</span> <span class="token function">read</span> files<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">echo</span> <span class="token variable">$files</span> <span class="token operator">&gt;&gt;</span> test.log
<span class="token keyword">done</span>
12.16 多个网卡选择
<span class="token keyword">function</span> local_nic<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    local NUM ARRAY_LENGTH
    NUM<span class="token operator">=</span>0
    <span class="token keyword">for</span> NIC_NAME <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> /sys/class/net<span class="token operator">|</span><span class="token function">grep</span> -vE <span class="token string">"lo|docker0"</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
        NIC_IP<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ifconfig</span> $NIC_NAME <span class="token operator">|</span><span class="token function">awk</span> -F<span class="token string">'[: ]+'</span> <span class="token string">'/inet addr/{print <span class="token variable">$4</span>}'</span><span class="token variable">)</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> -n <span class="token string">"<span class="token variable">$NIC_IP</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            NIC_IP_ARRAY<span class="token punctuation">[</span><span class="token variable">$NUM</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$NIC_NAME</span>:<span class="token variable">$NIC_IP</span>"</span>    <span class="token comment">#将网卡名和对应IP放到数组</span>
            <span class="token keyword">let</span> NUM++
        <span class="token keyword">fi</span>
    <span class="token keyword">done</span>
    ARRAY_LENGTH<span class="token operator">=</span><span class="token variable">${#NIC_IP_ARRAY[*]}</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$ARRAY_LENGTH</span> -eq 1 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>     <span class="token comment">#如果数组里面只有一条记录说明就一个网卡</span>
        NIC<span class="token operator">=</span><span class="token variable">${NIC_IP_ARRAY[0]%:*}</span>
        <span class="token keyword">return</span> 0
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$ARRAY_LENGTH</span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>   <span class="token comment">#如果没有记录说明没有网卡</span>
        <span class="token keyword">echo</span> <span class="token string">"No available network card!"</span>
        <span class="token keyword">exit</span> 1
    <span class="token keyword">else</span>
        <span class="token comment">#如果有多条记录则提醒输入选择</span>
        <span class="token keyword">for</span> NIC <span class="token keyword">in</span> <span class="token variable">${NIC_IP_ARRAY[*]}</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
            <span class="token keyword">echo</span> <span class="token variable">$NIC</span>
        <span class="token keyword">done</span>
        <span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
            <span class="token function">read</span> -p <span class="token string">"Please enter local use to network card name: "</span> INPUT_NIC_NAME
            COUNT<span class="token operator">=</span>0
            <span class="token keyword">for</span> NIC <span class="token keyword">in</span> <span class="token variable">${NIC_IP_ARRAY[*]}</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
                NIC_NAME<span class="token operator">=</span><span class="token variable">${NIC%:*}</span>
                <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$NIC_NAME</span> <span class="token operator">==</span> <span class="token string">"<span class="token variable">$INPUT_NIC_NAME</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                    NIC<span class="token operator">=</span><span class="token variable">${NIC_IP_ARRAY[$COUNT]%:*}</span>
                    <span class="token keyword">return</span> 0
                <span class="token keyword">else</span>
                   COUNT+<span class="token operator">=</span>1
                <span class="token keyword">fi</span>
            <span class="token keyword">done</span>
            <span class="token keyword">echo</span> <span class="token string">"Not match! Please input again."</span>
        <span class="token keyword">done</span>
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>
local_nic
</code></pre> 
<p>如果有只有一个网卡就不选择。</p> 
<h3><a id="117__199"></a>1.17 查看网卡实时流量</h3> 
<pre><code class="prism language-shell"><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># Description: Only CentOS6</span>
traffic_unit_conv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    local traffic<span class="token operator">=</span><span class="token variable">$1</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$traffic</span> -gt 1024000 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token function">printf</span> <span class="token string">"%.1f%s"</span> <span class="token string">"<span class="token variable"><span class="token variable">$((</span>$traffic<span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span><span class="token variable">))</span></span>"</span> <span class="token string">"MB/s"</span>
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$traffic</span> -lt 1024000 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token function">printf</span> <span class="token string">"%.1f%s"</span> <span class="token string">"<span class="token variable"><span class="token variable">$((</span>$traffic<span class="token operator">/</span><span class="token number">1024</span><span class="token variable">))</span></span>"</span> <span class="token string">"KB/s"</span>
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>
NIC<span class="token operator">=</span><span class="token variable">$1</span>
<span class="token keyword">echo</span> -e <span class="token string">" In ------ Out"</span>
<span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    OLD_IN<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">awk</span> -F<span class="token string">'[: ]+'</span> <span class="token string">'<span class="token variable">$0</span>~"'</span>$NIC<span class="token string">'"{print <span class="token variable">$3</span>}'</span> /proc/net/dev<span class="token variable">)</span></span>
    OLD_OUT<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">awk</span> -F<span class="token string">'[: ]+'</span> <span class="token string">'<span class="token variable">$0</span>~"'</span>$NIC<span class="token string">'"{print <span class="token variable">$11</span>}'</span> /proc/net/dev<span class="token variable">)</span></span>
    <span class="token function">sleep</span> 1
    NEW_IN<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">awk</span> -F<span class="token string">'[: ]+'</span> <span class="token string">'<span class="token variable">$0</span>~"'</span>$NIC<span class="token string">'"{print <span class="token variable">$3</span>}'</span> /proc/net/dev<span class="token variable">)</span></span>
    NEW_OUT<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">awk</span> -F<span class="token string">'[: ]+'</span> <span class="token string">'<span class="token variable">$0</span>~"'</span>$NIC<span class="token string">'"{print <span class="token variable">$11</span>}'</span> /proc/net/dev<span class="token variable">)</span></span>
    IN<span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$NEW_IN<span class="token operator">-</span>$OLD_IN<span class="token variable">))</span></span>
    OUT<span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$NEW_OUT<span class="token operator">-</span>$OLD_OUT<span class="token variable">))</span></span>
    <span class="token keyword">echo</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>traffic_unit_conv $IN<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>traffic_unit_conv $OUT<span class="token variable">)</span></span>"</span>
    <span class="token function">sleep</span> 1
<span class="token keyword">done</span>
<span class="token comment"># 也可以通过ficonfig命令获取收发流量</span>
<span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    OLD_IN<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ifconfig</span> $NIC <span class="token operator">|</span><span class="token function">awk</span> -F<span class="token string">'[: ]+'</span> <span class="token string">'/bytes/{print <span class="token variable">$4</span>}'</span><span class="token variable">)</span></span>  
    OLD_OUT<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ifconfig</span> $NIC <span class="token operator">|</span><span class="token function">awk</span> -F<span class="token string">'[: ]+'</span> <span class="token string">'/bytes/{print <span class="token variable">$9</span>}'</span><span class="token variable">)</span></span>
    <span class="token function">sleep</span> 1
    NEW_IN<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ifconfig</span> $NIC <span class="token operator">|</span><span class="token function">awk</span> -F<span class="token string">'[: ]+'</span> <span class="token string">'/bytes/{print <span class="token variable">$4</span>}'</span><span class="token variable">)</span></span>
    NEW_OUT<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ifconfig</span> $NIC <span class="token operator">|</span><span class="token function">awk</span> -F<span class="token string">'[: ]+'</span> <span class="token string">'/bytes/{print <span class="token variable">$9</span>}'</span><span class="token variable">)</span></span>
    IN<span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$NEW_IN<span class="token operator">-</span>$OLD_IN<span class="token variable">))</span></span>
    OUT<span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$NEW_OUT<span class="token operator">-</span>$OLD_OUT<span class="token variable">))</span></span>
    <span class="token keyword">echo</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>traffic_unit_conv $IN<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>traffic_unit_conv $OUT<span class="token variable">)</span></span>"</span>
    <span class="token function">sleep</span> 1
<span class="token keyword">done</span>
</code></pre> 
<h3><a id="118_MySQL_238"></a>1.18 MySQL数据库备份</h3> 
<pre><code class="prism language-powershell"><span class="token comment">#!/bin/bash</span>
DATE=$<span class="token punctuation">(</span>date <span class="token operator">+</span><span class="token operator">%</span>F_<span class="token operator">%</span>H-<span class="token operator">%</span>M-<span class="token operator">%</span>S<span class="token punctuation">)</span>
HOST=192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>1<span class="token punctuation">.</span>120
DB=test
USER=bak
PASS=123456
MAIL=<span class="token string">"zhangsan@example.com lisi@example.com"</span>
BACKUP_DIR=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>db_backup
SQL_FILE=$<span class="token punctuation">{<!-- --></span>DB<span class="token punctuation">}</span>_full_<span class="token variable">$DATE</span><span class="token punctuation">.</span>sql
BAK_FILE=$<span class="token punctuation">{<!-- --></span>DB<span class="token punctuation">}</span>_full_<span class="token variable">$DATE</span><span class="token punctuation">.</span>zip
cd <span class="token variable">$BACKUP_DIR</span>
<span class="token keyword">if</span> mysqldump <span class="token operator">-</span>h<span class="token variable">$HOST</span> <span class="token operator">-</span>u<span class="token variable">$USER</span> <span class="token operator">-</span>p<span class="token variable">$PASS</span> <span class="token operator">--</span>single<span class="token operator">-</span>transaction <span class="token operator">--</span>routines <span class="token operator">--</span>triggers <span class="token operator">-</span>B <span class="token variable">$DB</span> &gt; <span class="token variable">$SQL_FILE</span><span class="token punctuation">;</span> then
    zip <span class="token variable">$BAK_FILE</span> <span class="token variable">$SQL_FILE</span> &amp;&amp; <span class="token function">rm</span> <span class="token operator">-</span>f <span class="token variable">$SQL_FILE</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token operator">-</span>s <span class="token variable">$BAK_FILE</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> then
            <span class="token function">echo</span> <span class="token string">"<span class="token variable">$DATE</span> 内容"</span> <span class="token punctuation">|</span> mail <span class="token operator">-</span>s <span class="token string">"主题"</span> <span class="token variable">$MAIL</span>
    fi
<span class="token keyword">else</span>
    <span class="token function">echo</span> <span class="token string">"<span class="token variable">$DATE</span> 内容"</span> <span class="token punctuation">|</span> mail <span class="token operator">-</span>s <span class="token string">"主题"</span> <span class="token variable">$MAIL</span>
fi
find <span class="token variable">$BACKUP_DIR</span> <span class="token operator">-</span>name <span class="token string">'*.zip'</span> <span class="token operator">-</span>ctime <span class="token operator">+</span>14 <span class="token operator">-</span>exec <span class="token function">rm</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> \<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="119_Nginx_262"></a>1.19 Nginx启动脚本</h3> 
<pre><code class="prism language-shell"><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># Description: Only support RedHat system</span>
<span class="token keyword">.</span> /etc/init.d/functions
WORD_DIR<span class="token operator">=</span>/data/project/nginx1.10
DAEMON<span class="token operator">=</span><span class="token variable">$WORD_DIR</span>/sbin/nginx
CONF<span class="token operator">=</span><span class="token variable">$WORD_DIR</span>/conf/nginx.conf
NAME<span class="token operator">=</span>nginx
PID<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">awk</span> -F<span class="token string">'[; ]+'</span> '/^<span class="token punctuation">[</span>^#<span class="token punctuation">]</span>/<span class="token punctuation">{<!-- --></span>if<span class="token punctuation">(</span>$0~/pid<span class="token punctuation">;</span>/<span class="token variable">)</span></span>print <span class="token variable">$2</span><span class="token punctuation">}</span>' <span class="token variable">$CONF</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> -z <span class="token string">"<span class="token variable">$PID</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    PID<span class="token operator">=</span><span class="token variable">$WORD_DIR</span>/logs/nginx.pid
<span class="token keyword">else</span>
    PID<span class="token operator">=</span><span class="token variable">$WORD_DIR</span>/<span class="token variable">$PID</span>
<span class="token keyword">fi</span>
stop<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$DAEMON</span> -s stop
    <span class="token function">sleep</span> 1
    <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token variable">$PID</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> action <span class="token string">"* Stopping <span class="token variable">$NAME</span>"</span>  /bin/true <span class="token operator">||</span> action <span class="token string">"* Stopping <span class="token variable">$NAME</span>"</span> /bin/false
<span class="token punctuation">}</span>
start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$DAEMON</span>
    <span class="token function">sleep</span> 1
    <span class="token punctuation">[</span> -f <span class="token variable">$PID</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> action <span class="token string">"* Starting <span class="token variable">$NAME</span>"</span>  /bin/true <span class="token operator">||</span> action <span class="token string">"* Starting <span class="token variable">$NAME</span>"</span> /bin/false
<span class="token punctuation">}</span>
reload<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$DAEMON</span> -s reload
<span class="token punctuation">}</span>
test_config<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$DAEMON</span> -t
<span class="token punctuation">}</span>
<span class="token keyword">case</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token keyword">in</span>
    start<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token variable">$PID</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            start
        <span class="token keyword">else</span>
            <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$NAME</span> is running..."</span>
            <span class="token keyword">exit</span> 0
        <span class="token keyword">fi</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
    stop<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> -f <span class="token variable">$PID</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            stop
        <span class="token keyword">else</span>
            <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$NAME</span> not running!"</span>
            <span class="token keyword">exit</span> 0
        <span class="token keyword">fi</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
    restart<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token variable">$PID</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$NAME</span> not running!"</span> 
            start
        <span class="token keyword">else</span>
            stop
            start
        <span class="token keyword">fi</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
    reload<span class="token punctuation">)</span>
        reload
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
    testconfig<span class="token punctuation">)</span>
        test_config
        <span class="token punctuation">;</span><span class="token punctuation">;</span> 
    status<span class="token punctuation">)</span>
        <span class="token punctuation">[</span> -f <span class="token variable">$PID</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$NAME</span> is running..."</span> <span class="token operator">||</span> <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$NAME</span> not running!"</span>
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
    *<span class="token punctuation">)</span>
        <span class="token keyword">echo</span> <span class="token string">"Usage: <span class="token variable">$0</span> {start|stop|restart|reload|testconfig|status}"</span>
        <span class="token keyword">exit</span> 3
        <span class="token punctuation">;</span><span class="token punctuation">;</span>
esac
</code></pre> 
<h3><a id="120_SSH_335"></a>1.20 选择SSH连接主机</h3> 
<p>写一个配置文件保存被监控主机SSH连接信息，文件内容格式：主机名 IP User Port</p> 
<pre><code class="prism language-powershell"><span class="token comment">#!/bin/bash</span>
PS3=<span class="token string">"Please input number: "</span>
HOST_FILE=host
<span class="token keyword">while</span> true<span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token function">select</span> NAME in $<span class="token punctuation">(</span>awk <span class="token string">'{print $1}'</span> <span class="token variable">$HOST_FILE</span><span class="token punctuation">)</span> quit<span class="token punctuation">;</span> <span class="token keyword">do</span>
        <span class="token punctuation">[</span> $<span class="token punctuation">{<!-- --></span>NAME:=empty<span class="token punctuation">}</span> == <span class="token string">"quit"</span> <span class="token punctuation">]</span> &amp;&amp; <span class="token keyword">exit</span> 0
        IP=$<span class="token punctuation">(</span>awk <span class="token operator">-</span>v NAME=$<span class="token punctuation">{<!-- --></span>NAME<span class="token punctuation">}</span> <span class="token string">'$1==NAME{print $2}'</span> <span class="token variable">$HOST_FILE</span><span class="token punctuation">)</span>
        USER=$<span class="token punctuation">(</span>awk <span class="token operator">-</span>v NAME=$<span class="token punctuation">{<!-- --></span>NAME<span class="token punctuation">}</span> <span class="token string">'$1==NAME{print $3}'</span> <span class="token variable">$HOST_FILE</span><span class="token punctuation">)</span>
        PORT=$<span class="token punctuation">(</span>awk <span class="token operator">-</span>v NAME=$<span class="token punctuation">{<!-- --></span>NAME<span class="token punctuation">}</span> <span class="token string">'$1==NAME{print $4}'</span> <span class="token variable">$HOST_FILE</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$IP</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> then
            <span class="token function">echo</span> <span class="token string">"Name: <span class="token variable">$NAME</span>, IP: <span class="token variable">$IP</span>"</span>
            ssh <span class="token operator">-</span>o StrictHostKeyChecking=no <span class="token operator">-</span>p <span class="token variable">$PORT</span> <span class="token operator">-</span>i id_rsa <span class="token variable">$USER</span>@<span class="token variable">$IP</span>  <span class="token comment"># 密钥登录</span>
            <span class="token keyword">break</span>
        <span class="token keyword">else</span>
            <span class="token function">echo</span> <span class="token string">"Input error, Please enter again!"</span>
            <span class="token keyword">break</span>
        fi
    done
done
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/efaf279204deb2985ee6365aa3fd8384/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">实战篇--常见的Shell脚本编写案例（一）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c0c9644f410fbdcf503a048f62b83407/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">实战篇--常见的Shell脚本编写案例（三）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>