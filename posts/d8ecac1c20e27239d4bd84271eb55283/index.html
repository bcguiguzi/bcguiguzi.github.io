<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Cesium 之加载ArcGIS Server 4490切片服务（含orgin -400 400） - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Cesium 之加载ArcGIS Server 4490切片服务（含orgin -400 400）" />
<meta property="og:description" content="对于ArcGIS Server发布的切片服务，在地理坐标系中Cesium默认只支持wgs84的4326坐标系，无法通过ArcGisMapServerImageryProvider直接加载CGCS2000的4490坐标系，虽然可以使用WebMapTileServiceImageryProvider加载符合OGC标准的WMTS类型，但只能针对于原点在orgin X: -180.0Y: 90.0的情况，对于原点在orgin X: -400.0Y: 400.0时还是无法正常加载，为了能够实现加载，以下通过修改源码方式来达到目的。
笔者以Cesium 1.91版本为例。
目录
1、修改ArcGisMapServerImageryProvider类
2、修改GeographicTilingScheme类
3、定义2000椭球参数
4、底图调用实现
1、修改ArcGisMapServerImageryProvider类 在metadataSuccess方法中修改
（1）读取切片模式时增加支持wkid 4490坐标系的判断，同时将切片信息也传入，目的是为了后面在获取行列号xy时，可以通过读取切片信息，使用自定义方法改写行列号的获取方式。
else if (data.fullExtent.spatialReference.wkid === 4490) { that._tilingScheme = new GeographicTilingScheme({ ellipsoid: options.ellipsoid, tileInfo: data.tileInfo, rectangle: that._rectangle }); that._tilingScheme._tileInfo = data.tileInfo;//附加自定义属性 } 如截图所示：
（2）增加最大层级定义（用来限制最大可缩放多少层级，达到一定层级后不显示，根据项目需要为可选修改项）
//修改最大层级定义
that._maximumLevel = defaultValue(options.maximumLevel, data.tileInfo.lods.length - 1);
（3）矩阵范围定义中 增加wkid 4490坐标系判断。
2、修改GeographicTilingScheme类 （1）增加4490坐标系的椭球、矩阵范围等定义，4490坐标系默认椭球为CGCS2000，矩阵范围为（-180，-90，180，90），开放矩阵范围的目的就是为了支持自定义的origin原点。
if (defined(options.tileInfo) &amp;&amp; defined(options.tileInfo.spatialReference) &amp;&amp; defined(options.tileInfo.spatialReference.wkid) &amp;&amp; options.tileInfo.spatialReference.wkid == 4490) { this._tileInfo = options.tileInfo; this._ellipsoid = defaultValue(options." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/d8ecac1c20e27239d4bd84271eb55283/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-13T19:05:55+08:00" />
<meta property="article:modified_time" content="2022-03-13T19:05:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Cesium 之加载ArcGIS Server 4490切片服务（含orgin -400 400）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>        对于ArcGIS Server发布的切片服务，在地理坐标系中Cesium默认只支持wgs84的4326坐标系，无法通过<span style="color:#ff9900;">ArcGisMapServerImageryProvider</span>直接加载CGCS2000的4490坐标系，虽然可以使用<span style="color:#ff9900;">WebMapTileServiceImageryProvider</span>加载符合OGC标准的WMTS类型，但只能针对于原点在<span style="color:#4da8ee;">orgin <em>X: </em>-180.0<em>Y: </em>90.0</span>的情况，对于原点在<span style="color:#4da8ee;">orgin <em>X: </em>-400.0<em>Y: </em>400.0</span>时还是无法正常加载，为了能够实现加载，以下通过修改源码方式来达到目的。</p> 
<p>笔者以Cesium 1.91版本为例。</p> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="1%E3%80%81%E6%90%9C%E7%B4%A2%E6%BA%90%E7%A0%81%E4%B8%AD%20ArcGisMapServerImageryProvider%E7%B1%BB-toc" style="margin-left:40px;"><a href="#1%E3%80%81%E6%90%9C%E7%B4%A2%E6%BA%90%E7%A0%81%E4%B8%AD%20ArcGisMapServerImageryProvider%E7%B1%BB" rel="nofollow">1、修改ArcGisMapServerImageryProvider类</a></p> 
<p id="2%E3%80%81%E6%90%9C%E7%B4%A2%E6%BA%90%E7%A0%81%E4%B8%AD%20%E5%9C%B0%E7%90%86%E5%88%87%E7%89%87%E6%A8%A1%E5%BC%8FGeographicTilingScheme%E7%B1%BB-toc" style="margin-left:40px;"><a href="#2%E3%80%81%E6%90%9C%E7%B4%A2%E6%BA%90%E7%A0%81%E4%B8%AD%20%E5%9C%B0%E7%90%86%E5%88%87%E7%89%87%E6%A8%A1%E5%BC%8FGeographicTilingScheme%E7%B1%BB" rel="nofollow">2、修改GeographicTilingScheme类</a></p> 
<p id="%C2%A03%E3%80%81%E5%AE%9A%E4%B9%892000%E6%A4%AD%E7%90%83%E5%8F%82%E6%95%B0-toc" style="margin-left:40px;"><a href="#%C2%A03%E3%80%81%E5%AE%9A%E4%B9%892000%E6%A4%AD%E7%90%83%E5%8F%82%E6%95%B0" rel="nofollow"> 3、定义2000椭球参数</a></p> 
<p id="4%E3%80%81%E5%BA%95%E5%9B%BE%E8%B0%83%E7%94%A8%E5%AE%9E%E7%8E%B0-toc" style="margin-left:40px;"><a href="#4%E3%80%81%E5%BA%95%E5%9B%BE%E8%B0%83%E7%94%A8%E5%AE%9E%E7%8E%B0" rel="nofollow">4、底图调用实现</a></p> 
<hr id="hr-toc"> 
<p></p> 
<blockquote> 
 <h3 id="1%E3%80%81%E6%90%9C%E7%B4%A2%E6%BA%90%E7%A0%81%E4%B8%AD%20ArcGisMapServerImageryProvider%E7%B1%BB">1、修改ArcGisMapServerImageryProvider类</h3> 
</blockquote> 
<p>在metadataSuccess方法中修改</p> 
<p>（1）读取切片模式时增加支持wkid 4490坐标系的判断，同时将切片信息也传入，目的是为了后面在获取行列号xy时，可以通过读取切片信息，使用自定义方法改写行列号的获取方式。</p> 
<pre><code class="language-javascript">else if (data.fullExtent.spatialReference.wkid === 4490) {
          that._tilingScheme = new GeographicTilingScheme({
            ellipsoid: options.ellipsoid,
            tileInfo: data.tileInfo,
            rectangle: that._rectangle
          });
          that._tilingScheme._tileInfo = data.tileInfo;//附加自定义属性
        } </code></pre> 
<p>如截图所示：</p> 
<p><img alt="" height="887" src="https://images2.imgbox.com/1c/21/Lxkun1DV_o.png" width="1200"></p> 
<p>（2）增加最大层级定义（用来限制最大可缩放多少层级，达到一定层级后不显示，根据项目需要为可选修改项）</p> 
<p> //修改最大层级定义</p> 
<p>        that._maximumLevel = defaultValue(options.maximumLevel, data.tileInfo.lods.length - 1);</p> 
<p><img alt="" height="77" src="https://images2.imgbox.com/4a/ed/9MUO2YCX_o.png" width="1031"></p> 
<p>（3）矩阵范围定义中 增加wkid 4490坐标系判断。</p> 
<p><img alt="" height="164" src="https://images2.imgbox.com/e0/ce/xpZC6jqM_o.png" width="1200"></p> 
<p></p> 
<blockquote> 
 <h3 id="2%E3%80%81%E6%90%9C%E7%B4%A2%E6%BA%90%E7%A0%81%E4%B8%AD%20%E5%9C%B0%E7%90%86%E5%88%87%E7%89%87%E6%A8%A1%E5%BC%8FGeographicTilingScheme%E7%B1%BB">2、修改GeographicTilingScheme类</h3> 
</blockquote> 
<p>（1）增加4490坐标系的椭球、矩阵范围等定义，4490坐标系默认椭球为CGCS2000，矩阵范围为（-180，-90，180，90），开放矩阵范围的目的就是为了支持自定义的origin原点。</p> 
<pre><code class="language-javascript">    if (defined(options.tileInfo)
      &amp;&amp; defined(options.tileInfo.spatialReference)
      &amp;&amp; defined(options.tileInfo.spatialReference.wkid)
      &amp;&amp; options.tileInfo.spatialReference.wkid == 4490) {
      this._tileInfo = options.tileInfo;
      this._ellipsoid = defaultValue(options.ellipsoid, Ellipsoid.CGCS2000);
      this._rectangle = defaultValue(options.rectangle, Rectangle.fromDegrees(-180, -90, 180, 90));
      this._numberOfLevelZeroTilesX = defaultValue(options.numberOfLevelZeroTilesX, 4);
      this._numberOfLevelZeroTilesY = defaultValue(options.numberOfLevelZeroTilesY, 2);
    }
    else {
      this._ellipsoid = defaultValue(options.ellipsoid, Ellipsoid.WGS84);
      this._rectangle = defaultValue(options.rectangle, Rectangle.MAX_VALUE);
      this._numberOfLevelZeroTilesX = defaultValue(options.numberOfLevelZeroTilesX, 2);
      this._numberOfLevelZeroTilesY = defaultValue(options.numberOfLevelZeroTilesY, 1);
    }</code></pre> 
<p><img alt="" height="820" src="https://images2.imgbox.com/c0/18/4dgMu3Na_o.png" width="1135"></p> 
<p>（2）修改切片矩阵计算获取行列号xy值的原型方法getNumberOfXTilesAtLevel和getNumberOfYTilesAtLevel</p> 
<pre><code class="language-javascript">/**
   * Gets the total number of tiles in the X direction at a specified level-of-detail.
   *
   * @param {Number} level The level-of-detail.
   * @returns {Number} The number of tiles in the X direction at the given level.
   */
  GeographicTilingScheme.prototype.getNumberOfXTilesAtLevel = function (level) {
    if (!defined(this._tileInfo)) {
      return this._numberOfLevelZeroTilesX &lt;&lt; level
    } else { // 使用切片矩阵计算
      var currentMatrix = this._tileInfo.lods.filter(function (item) {
        return item.level === level
      })
      var currentResolution = currentMatrix[0].resolution
      // return Math.round(360 / (this._tileInfo.rows * currentResolution))
      return Math.round(CesiumMath.toDegrees(CesiumMath.TWO_PI) / (this._tileInfo.rows * currentResolution));
    }
  };

  /**
   * Gets the total number of tiles in the Y direction at a specified level-of-detail.
   *
   * @param {Number} level The level-of-detail.
   * @returns {Number} The number of tiles in the Y direction at the given level.
   */
  GeographicTilingScheme.prototype.getNumberOfYTilesAtLevel = function (level) {
    if (!defined(this._tileInfo)) {
      return this._numberOfLevelZeroTilesY &lt;&lt; level
    } else { // 使用切片矩阵计算
      var currentMatrix = this._tileInfo.lods.filter(function (item) {
        return item.level === level
      })
      var currentResolution = currentMatrix[0].resolution
      // return Math.round(180 / (this._tileInfo.cols * currentResolution))
      return Math.round(CesiumMath.toDegrees(CesiumMath.TWO_PI / 2) / (this._tileInfo.cols * currentResolution));
    }
  };</code></pre> 
<p><img alt="" height="768" src="https://images2.imgbox.com/4c/df/z1R7EPqf_o.png" width="1200"></p> 
<blockquote> 
 <h3 id="%C2%A03%E3%80%81%E5%AE%9A%E4%B9%892000%E6%A4%AD%E7%90%83%E5%8F%82%E6%95%B0"> 3、定义2000椭球参数</h3> 
</blockquote> 
<pre><code class="language-javascript">  Ellipsoid.CGCS2000 = Object.freeze(
    new Ellipsoid(6378137.0, 6378137.0, 6356752.31414035585)
  );</code></pre> 
<p> <img alt="" height="443" src="https://images2.imgbox.com/b2/2a/rVSX387M_o.png" width="915"></p> 
<blockquote> 
 <h3 id="4%E3%80%81%E5%BA%95%E5%9B%BE%E8%B0%83%E7%94%A8%E5%AE%9E%E7%8E%B0">4、底图调用实现</h3> 
</blockquote> 
<p> 以上修改完后，接下来就是如何调用的问题了。</p> 
<p>调用方式比一般的调用相对更复杂些，具体如下：</p> 
<p>（1）确定椭球参数</p> 
<p>如 CGCS2000椭球如下</p> 
<p> var cgs2000Ellipsolid = new Cesium.Ellipsoid(6378137.0, 6378137.0, 6356752.31414035585)</p> 
<p>或者直接用源码中已修改过的Ellipsoid.CGCS2000</p> 
<p>var cgs2000Ellipsolid=Cesium.Ellipsoid.CGCS2000</p> 
<p>(2) 定义切片模式</p> 
<p>如orgin 为-400 400时</p> 
<pre><code class="language-javascript">var myGeographicTilingScheme = new Cesium.GeographicTilingScheme({
    ellipsoid: cgs2000Ellipsolid,
    rectangle: Cesium.Rectangle.fromDegrees(-400, -399.9999999999998, 400, 399.9999999999998),
    numberOfLevelZeroTilesX: 2,
    numberOfLevelZeroTilesY: 1
})</code></pre> 
<p>orgin -180 90时 等等</p> 
<pre><code class="language-javascript">var myGeographicTilingScheme = new Cesium.GeographicTilingScheme({
    ellipsoid: cgs2000Ellipsolid,
    rectangle: Cesium.Rectangle.fromDegrees(-180, -90, 180, 90),
    numberOfLevelZeroTilesX: 4,
    numberOfLevelZeroTilesY: 2
})
</code></pre> 
<p>（3）创建ArcGisMapServerImageryProvider</p> 
<p>url为MapServer地址</p> 
<p>layer的名称可在wmts下找到，这个大家应该都知道，我就不截图了，</p> 
<p>具体参数设置如下：</p> 
<p><img alt="" height="239" src="https://images2.imgbox.com/76/a2/nbGHiWaq_o.png" width="1131"></p> 
<p>生成的provider赋值到Viewer参数的imageryProvider下</p> 
<p> （4）初始化地图投影</p> 
<p>var cgs2000GeographicProj = new Cesium.GeographicProjection(cgs2000Ellipsolid)</p> 
<p>将其赋值到Viewer参数的mapProjection下</p> 
<p>（5）初始化生成三维球体</p> 
<pre><code class="language-javascript">let viewer2 = new Cesium.Viewer('map3D', {
    animation: false,
    baseLayerPicker: false,
    fullscreenButton: false,
    geocoder: false,
    homeButton: false,
    sceneModePicker: false,
    selectionIndicator: false,
    timeline: false,
    navigationHelpButton: false,
    infoBox: false,
    navigationInstructionsInitiallyVisible: false,
    mapProjection: cgs2000GeographicProj,
    imageryProvider: esriWMTS,
    scene3DOnly: false,
    sceneMode: Cesium.SceneMode.SCENE2D,
    terrainExaggeration: 1,
    showRenderLoopErrors: false,

});</code></pre> 
<p>OK完成，效果图如下：</p> 
<p><img alt="" height="726" src="https://images2.imgbox.com/82/96/8qMVKCw5_o.png" width="1049"></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8616069d6dfe24dcd3a0dec1bf435a62/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">输入一个整数n，控制台输出n行“*”金字塔的形状（Java）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2be259d74a4ed2b483a181c9d66023d4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Neo4j基础理论、Linux安装与Windows安装以及CQL语法（增删改查、排序、分页、去重）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>