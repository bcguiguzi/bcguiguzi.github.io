<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>c&#43;&#43;以及golang基于protobuf进行简单通讯【c&#43;&#43;与golang】【项目研究】 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="c&#43;&#43;以及golang基于protobuf进行简单通讯【c&#43;&#43;与golang】【项目研究】" />
<meta property="og:description" content="文章目录 前言一、C&#43;&#43;和Go语言都可以对protobuf进行操作二、protobuf编写与生成1、protobuf格式2、protobuf的编写2、两种语言的生成 三、c&#43;&#43;与go语言操作protobuf不同点四、c&#43;&#43;与go语言基于protobuf进行网络通信1、go语言编写服务提供者2、c&#43;&#43;服务调用者 总结 前言 当我们需要在不同的编程语言之间进行通讯时，通常会遇到数据格式不兼容的问题。在这种情况下，使用数据序列化工具就成为了一种非常有效的解决方案。Google 推出的 Protocol Buffers（简称 protobuf）就是一种非常常用的数据序列化工具，它可以帮助我们快速实现跨语言、跨平台的数据传输等应用。
C&#43;&#43; 和 Go 是两种常用的编程语言，本文将介绍如何利用 protobuf 实现 C&#43;&#43; 和 Go 语言之间的通讯。为微服务框架打基础。
一、C&#43;&#43;和Go语言都可以对protobuf进行操作 Protocol Buffers 是一种轻巧高效的数据序列化工具，通过将结构化数据编码为二进制格式的消息，从而实现方便地进行数据交换和存储，并能够在不同的语言和平台间进行数据互通。因此利用 protobuf 实现 C&#43;&#43; 和 Go 语言之间的通讯是完全可行的，只要共同采用相同的消息格式定义，并通过相应语言的protobuf库进行序列化和反序列化。
与其他序列化方式相比，protobuf 有更高的性能和更小的数据体积，因此广泛应用于 Google 内部以及众多开源项目中。
除了基础的序列化功能，Protobuf 还提供了其他高级特性，如扩展、注释、默认值、嵌套类型、枚举等，使其更加灵活、易用。
总之，protobuf 是一种优秀的数据序列化工具，可帮助开发者快速实现跨语言、跨平台的数据传输等应用。
二、protobuf编写与生成 1、protobuf格式 首先是声明protobuf的版本，以及代码所在的包（对于C&#43;&#43;来说是namespace），如果需要生成服务类以及rpc方法描述就需要配置cc_generic_services。
syntax = &#34;proto3&#34;; // 声明了protobuf的版本 package fixbug; // 声明了代码所在的包（对于C&#43;&#43;来说是namespace） // 定义下面的选项，表示生成service服务类和rpc方法描述， option cc_generic_services = true; 定义数据，可以定义嵌套类型，枚举以及数组等等类型
message ResultCode { int32 errcode = 1; bytes errmsg = 2; } // 数据 列表 映射表 // 定义登录请求消息类型 name pwd message LoginRequest { bytes name = 1; bytes pwd = 2; } // 定义登录响应消息类型 message LoginResponse { ResultCode result = 1; bool success = 2; } message GetFriendListsRequest { uint32 userid = 1; } message User { bytes name = 1; uint32 age = 2; // 枚举 enum Sex { MAN = 0; WOMAN = 1; } Sex sex = 3; } message GetFriendListsResponse { ResultCode result = 1; repeated User friend_list = 2; // 定义了一个列表类型 } 定义描述rpc方法的类型 ：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/34564793722207b9854d4b0447143db8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-02T09:13:33+08:00" />
<meta property="article:modified_time" content="2023-12-02T09:13:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">c&#43;&#43;以及golang基于protobuf进行简单通讯【c&#43;&#43;与golang】【项目研究】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_11" rel="nofollow">前言</a></li><li><a href="#CGoprotobuf_17" rel="nofollow">一、C++和Go语言都可以对protobuf进行操作</a></li><li><a href="#protobuf_25" rel="nofollow">二、protobuf编写与生成</a></li><li><ul><li><a href="#1protobuf_26" rel="nofollow">1、protobuf格式</a></li><li><a href="#2protobuf_96" rel="nofollow">2、protobuf的编写</a></li><li><a href="#2_163" rel="nofollow">2、两种语言的生成</a></li></ul> 
  </li><li><a href="#cgoprotobuf_174" rel="nofollow">三、c++与go语言操作protobuf不同点</a></li><li><a href="#cgoprotobuf_178" rel="nofollow">四、c++与go语言基于protobuf进行网络通信</a></li><li><ul><li><a href="#1go_183" rel="nofollow">1、go语言编写服务提供者</a></li><li><a href="#2c_255" rel="nofollow">2、c++服务调用者</a></li></ul> 
  </li><li><a href="#_313" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_11"></a>前言</h2> 
<p>当我们需要在不同的编程语言之间进行通讯时，通常会遇到数据格式不兼容的问题。在这种情况下，使用数据序列化工具就成为了一种非常有效的解决方案。Google 推出的 Protocol Buffers（简称 protobuf）就是一种非常常用的数据序列化工具，它可以帮助我们快速实现跨语言、跨平台的数据传输等应用。<br> C++ 和 Go 是两种常用的编程语言，<strong>本文将介绍如何利用 protobuf 实现 C++ 和 Go 语言之间的通讯。为微服务框架打基础。</strong></p> 
<h2><a id="CGoprotobuf_17"></a>一、C++和Go语言都可以对protobuf进行操作</h2> 
<p>Protocol Buffers 是一种轻巧高效的数据序列化工具，通过将结构化数据编码为二进制格式的消息，从而实现方便地进行数据交换和存储，并能够在不同的语言和平台间进行数据互通。<strong>因此利用 protobuf 实现 C++ 和 Go 语言之间的通讯是完全可行的，只要共同采用相同的消息格式定义，并通过相应语言的protobuf库进行序列化和反序列化</strong>。</p> 
<p><strong>与其他序列化方式相比</strong>，protobuf 有更高的性能和更小的数据体积，因此广泛应用于 Google 内部以及众多开源项目中。<br> 除了基础的序列化功能，Protobuf 还提供了其他高级特性，如扩展、注释、默认值、嵌套类型、枚举等，使其更加灵活、易用。</p> 
<p>总之，protobuf 是一种优秀的数据序列化工具，可帮助开发者快速实现跨语言、跨平台的数据传输等应用。</p> 
<h2><a id="protobuf_25"></a>二、protobuf编写与生成</h2> 
<h3><a id="1protobuf_26"></a>1、protobuf格式</h3> 
<p>首先是声明protobuf的版本，以及代码所在的包（对于C++来说是namespace），如果需要生成服务类以及rpc方法描述就需要配置cc_generic_services。</p> 
<pre><code class="prism language-cpp">syntax <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span> <span class="token comment">// 声明了protobuf的版本</span>

package fixbug<span class="token punctuation">;</span> <span class="token comment">// 声明了代码所在的包（对于C++来说是namespace）</span>

<span class="token comment">// 定义下面的选项，表示生成service服务类和rpc方法描述，</span>
option cc_generic_services <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

</code></pre> 
<p>定义数据，可以定义嵌套类型，枚举以及数组等等类型</p> 
<pre><code class="prism language-cpp">message ResultCode
<span class="token punctuation">{<!-- --></span>
    int32 errcode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    bytes errmsg <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 数据   列表   映射表</span>
<span class="token comment">// 定义登录请求消息类型  name   pwd</span>
message LoginRequest
<span class="token punctuation">{<!-- --></span>
    bytes name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    bytes pwd <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 定义登录响应消息类型</span>
message LoginResponse
<span class="token punctuation">{<!-- --></span>
    ResultCode result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> success <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message GetFriendListsRequest
<span class="token punctuation">{<!-- --></span>
    uint32 userid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
message User
<span class="token punctuation">{<!-- --></span>
    bytes name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    uint32 age <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment">// 枚举</span>
    <span class="token keyword">enum</span> <span class="token class-name">Sex</span>
    <span class="token punctuation">{<!-- --></span>
        MAN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        WOMAN <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Sex sex <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
message GetFriendListsResponse
<span class="token punctuation">{<!-- --></span>
    ResultCode result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    repeated User friend_list <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 定义了一个列表类型</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>定义描述rpc方法的类型 ：</p> 
<pre><code class="prism language-cpp">service UserServiceRpc
<span class="token punctuation">{<!-- --></span>
    rpc <span class="token function">Login</span><span class="token punctuation">(</span>LoginRequest<span class="token punctuation">)</span> <span class="token function">returns</span><span class="token punctuation">(</span>LoginResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpc <span class="token function">GetFriendLists</span><span class="token punctuation">(</span>GetFriendListsRequest<span class="token punctuation">)</span> <span class="token function">returns</span><span class="token punctuation">(</span>GetFriendListsResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2protobuf_96"></a>2、protobuf的编写</h3> 
<pre><code class="prism language-cpp">syntax <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>

option go_package<span class="token operator">=</span><span class="token string">"./;userpb"</span><span class="token punctuation">;</span>

package userpb<span class="token punctuation">;</span> <span class="token comment">// 声明了代码所在的包（对于C++来说是namespace）</span>

<span class="token comment">// 定义下面的选项，表示生成service服务类和rpc方法描述，默认不生成</span>
option cc_generic_services <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

message ResultCode
<span class="token punctuation">{<!-- --></span>
    int32 errcode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    string errmsg <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 数据   列表   映射表</span>
<span class="token comment">// 定义登录请求消息类型  name   pwd</span>
message LoginRequest
<span class="token punctuation">{<!-- --></span>
    string name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    string pwd <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 定义登录响应消息类型</span>
message LoginResponse
<span class="token punctuation">{<!-- --></span>
    ResultCode result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> success <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message GetFriendListsRequest
<span class="token punctuation">{<!-- --></span>
    uint32 userid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
message User
<span class="token punctuation">{<!-- --></span>
    string name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    uint32 age <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment">// 枚举</span>
    <span class="token keyword">enum</span> <span class="token class-name">Sex</span>
    <span class="token punctuation">{<!-- --></span>
        MAN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        WOMAN <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Sex sex <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
message GetFriendListsResponse
<span class="token punctuation">{<!-- --></span>
    ResultCode result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    repeated User friend_list <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 定义了一个列表类型</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在protobuf里面怎么定义描述rpc方法的类型 - service</span>
service UserServiceRpc
<span class="token punctuation">{<!-- --></span>
    rpc <span class="token function">Login</span><span class="token punctuation">(</span>LoginRequest<span class="token punctuation">)</span> <span class="token function">returns</span><span class="token punctuation">(</span>LoginResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpc <span class="token function">GetFriendLists</span><span class="token punctuation">(</span>GetFriendListsRequest<span class="token punctuation">)</span> <span class="token function">returns</span><span class="token punctuation">(</span>GetFriendListsResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>有一个区别c++是可以去掉这一行的</p> 
<pre><code class="prism language-cpp">option go_package<span class="token operator">=</span><span class="token string">"./;userpb"</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="2_163"></a>2、两种语言的生成</h3> 
<p>生成对应的c++文件命令</p> 
<pre><code class="prism language-bash">protoc user.proto <span class="token parameter variable">--cpp_out</span><span class="token operator">=</span>.
</code></pre> 
<p>生成对应的go文件命令</p> 
<pre><code class="prism language-go">protoc <span class="token operator">--</span>go_out<span class="token operator">=</span><span class="token punctuation">.</span><span class="token operator">/</span> <span class="token punctuation">.</span><span class="token operator">/</span>user<span class="token punctuation">.</span>proto
</code></pre> 
<h2><a id="cgoprotobuf_174"></a>三、c++与go语言操作protobuf不同点</h2> 
<p>vector 与 repeated bytes<br> repeated bytes 与go语言汽配的转换</p> 
<h2><a id="cgoprotobuf_178"></a>四、c++与go语言基于protobuf进行网络通信</h2> 
<p>两边通信利用TCP进行连接，之前有分别对go以及c++的网络通信进行总结。<br> c++与go的TCP网络编程总结地址如下：<br> <a href="https://blog.csdn.net/weixin_44545838/article/details/130222369">c++与go的TCP网络编程总结</a></p> 
<h3><a id="1go_183"></a>1、go语言编写服务提供者</h3> 
<p>go 如果要使用protobuf先要下载对应的插件<br> 下载go install google.golang.org/protobuf/cmd/protoc-gen-go@latest<br> 确保下面两个命令运行成功：</p> 
<pre><code class="prism language-bash">$ protoc <span class="token parameter variable">--version</span>
libprotoc <span class="token number">3.19</span>.3

$ protoc-gen-go <span class="token parameter variable">--version</span>
protoc-gen-go v1.27.1
</code></pre> 
<p>文件导入"github.com/golang/protobuf/proto"<br> 服务提供者实现的简单逻辑是</p> 
<pre><code class="prism language-go"><span class="token comment">// 业务处理函数</span>
<span class="token keyword">func</span> <span class="token function">Handler</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span>  <span class="token punctuation">{<!-- --></span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"gett !!!"</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
	buf<span class="token operator">:=</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span><span class="token number">4096</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">// n不停的监控 客户端发来的信息   如果发来的信息 n==0 那么就表示这个客户端下线了</span>
		<span class="token comment">// n 传过来的是长度</span>
		n<span class="token punctuation">,</span>err<span class="token operator">:=</span>conn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
		<span class="token keyword">if</span> n<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err<span class="token operator">!=</span><span class="token boolean">nil</span><span class="token operator">&amp;&amp;</span>err<span class="token operator">!=</span>io<span class="token punctuation">.</span>EOF<span class="token punctuation">{<!-- --></span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"err"</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		msg<span class="token operator">:=</span><span class="token function">string</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"&lt;&lt;&lt;&lt;&lt;== server get client message:%s \n"</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span>


		loginRequest <span class="token operator">:=</span> <span class="token operator">&amp;</span>userpb<span class="token punctuation">.</span>LoginRequest<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
		loginResponse <span class="token operator">:=</span> <span class="token operator">&amp;</span>userpb<span class="token punctuation">.</span>LoginResponse<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
		proto<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span> loginRequest<span class="token punctuation">)</span>
		<span class="token function">LoginLogic</span><span class="token punctuation">(</span>loginRequest<span class="token punctuation">,</span>loginResponse<span class="token punctuation">)</span>
		<span class="token comment">// 序列化成二进制</span>
		responsemsg<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> proto<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>loginResponse<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"responsemsg: %v\n"</span><span class="token punctuation">,</span> responsemsg<span class="token punctuation">)</span>

		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"=&gt;&gt;&gt;&gt;&gt;&gt; server sent client message:%s \n"</span><span class="token punctuation">,</span>responsemsg<span class="token punctuation">)</span>
		conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>responsemsg<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中简单的逻辑函数如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">LoginLogic</span><span class="token punctuation">(</span>res <span class="token operator">*</span>userpb<span class="token punctuation">.</span>LoginRequest<span class="token punctuation">,</span>req <span class="token operator">*</span>userpb<span class="token punctuation">.</span>LoginResponse<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"//rpc LoginLogic//\n"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"res.GetName(): %s\n"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"res.GetPwd(): %s\n"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token function">GetPwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// req := &amp;userpb.LoginResponse{<!-- --></span>
	<span class="token comment">// 	result: ResultCode{<!-- --></span>
	<span class="token comment">// 		Rrrcode:1,</span>
	<span class="token comment">// 		Errmsg :"no",</span>
	<span class="token comment">// 	},</span>
	<span class="token comment">// 	Success: true,</span>
	<span class="token comment">// }</span>
	req<span class="token punctuation">.</span>Success<span class="token operator">=</span><span class="token boolean">true</span>
	req<span class="token punctuation">.</span>Result<span class="token operator">=</span><span class="token operator">&amp;</span>userpb<span class="token punctuation">.</span>ResultCode<span class="token punctuation">{<!-- --></span>
		 Errcode <span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
		 Errmsg <span class="token punctuation">:</span> <span class="token string">"yes"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2c_255"></a>2、c++服务调用者</h3> 
<p>生成之后需要导入库 以及链接</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"user.pb.h"</span></span>
</code></pre> 
<p>调用 res.SerializeToString(&amp;send_str) 方法将 res 对象序列化成二进制格式的字符串，并将结果存储在变量 send_str 中。这里使用的是 Protocol Buffers 序列化方法。，然后发送，发送函数已经在之前的网络编程总结中提前写了。</p> 
<pre><code class="prism language-cpp">  LoginRequest res<span class="token punctuation">;</span>
   res<span class="token punctuation">.</span><span class="token function">set_name</span><span class="token punctuation">(</span><span class="token string">"hzl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   res<span class="token punctuation">.</span><span class="token function">set_pwd</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">// 序列化</span>
   string send_str<span class="token punctuation">;</span>
   res<span class="token punctuation">.</span><span class="token function">SerializeToString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>send_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// cout &lt;&lt; "" &lt;&lt; endl;</span>
   <span class="token comment">// if (rsp.SerializeToString(&amp;send_str)) {<!-- --></span>
   <span class="token comment">//    cout &lt;&lt; send_str.c_str() &lt;&lt; endl;</span>
   <span class="token comment">// }</span>
   <span class="token comment">// 3. 通信</span>
   client<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> send_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>接收并且解析成为对应的结构体函数如下：调用 read(fd, recvBuf, sizeof(recvBuf)) 方法读取从服务器端返回的数据，如果出错则直接退出，否则根据读取的数据进行反序列化并输出反序列化后的结果。</p> 
<p>在这里，使用的是 LoginResponse 对象对接收的数据进行反序列化</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">ListenFunc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">char</span> recvBuf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> recvBuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>recvBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token comment">// LOG_INFO("&lt;&lt;&lt;&lt;&lt;&lt;== client get data:%s", recvBuf);</span>

         LoginResponse rsp<span class="token punctuation">;</span>
         <span class="token comment">// 获取反序列化的</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>rsp<span class="token punctuation">.</span><span class="token function">ParseFromString</span><span class="token punctuation">(</span>recvBuf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> ResultCode<span class="token operator">&amp;</span> result <span class="token operator">=</span> rsp<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取 ResultCode 对象</span>
            <span class="token keyword">int32_t</span> errcode <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">errcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取 errcode 字段值</span>
            string errmsg <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">errmsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 获取 errmsg 字段值</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"errcode:"</span> <span class="token operator">&lt;&lt;</span> errcode <span class="token operator">&lt;&lt;</span> <span class="token string">"   errmsg:"</span> <span class="token operator">&lt;&lt;</span> errmsg <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token keyword">bool</span> success <span class="token operator">=</span> rsp<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"success:"</span> <span class="token operator">&lt;&lt;</span> success <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token comment">// 表示服务器端断开连接</span>
         <span class="token function">LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"server closed.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_313"></a>总结</h2> 
<p>文章总结了如何使用 protobuf 实现 C++ 和 Go 语言之间的通讯，包括了 protobuf 的编写与生成、C++ 和 Go 在操作 protobuf 时的一些不同点，以及基于 protobuf 实现网络通信的示例。同时还介绍了 protobuf 的优点以及常用的高级特性。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dd0062af2e00671a4b62f4462a2eb9da/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">一个较为实用的日志类【Python】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/085daee8fef9530b74eef43fd55b8e43/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SpringBoot使用Swagger编写接口文档</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>