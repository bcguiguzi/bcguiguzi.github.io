<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ClickHouse三分片两副本集群部署 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ClickHouse三分片两副本集群部署" />
<meta property="og:description" content="(以clickhouse20.8.9.6和ubuntu18.4为例)
环境准备：
ubuntu服务器6台
硬盘挂载/app目录
zk集群信息
一、TGZ安装包方式
curl -O https://repo.clickhouse.com/tgz/stable/clickhouse-common-static-20.8.9.6.tgz curl -O https://repo.clickhouse.com/tgz/stable/clickhouse-server-20.8.9.6.tgz curl -O https://repo.clickhouse.com/tgz/stable/clickhouse-client-20.8.9.6.tgz tar -xzvf clickhouse-common-static-20.8.9.6.tgz sudo clickhouse-common-static-20.8.9.6/install/doinst.sh tar -xzvf clickhouse-server-20.8.9.6.tgz sudo clickhouse-server-20.8.9.6/install/doinst.sh tar -xzvf clickhouse-client-20.8.9.6.tgz sudo clickhouse-client-20.8.9.6/install/doinst.sh 二、修改配置文件
假设我们的节点是10.***.***.[16:21]，以10.***.***.16上的配置为例。
config.xml
根据实际情况修改。我的节点信息都配置在metrika.xml文件里，config.xml文件主要做了一些存储路径，大小限制的修改。该版本自带prometheus exporter，有需要取消相应注释即可。 &lt;?xml version=&#34;1.0&#34;?&gt; &lt;!-- NOTE: User and query level settings are set up in &#34;users.xml&#34; file. If you have accidentally specified user-level settings here, server won&#39;t start. You can either move the settings to the right place inside &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/b60ec64c06aece45a8ab81e6109cb86b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-18T16:18:56+08:00" />
<meta property="article:modified_time" content="2023-07-18T16:18:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ClickHouse三分片两副本集群部署</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>(以clickhouse20.8.9.6和ubuntu18.4为例)</p> 
<p>环境准备：</p> 
<ul><li> <p>ubuntu服务器6台</p> </li><li> <p>硬盘挂载/app目录</p> </li><li> <p>zk集群信息</p> </li></ul> 
<p>一、TGZ安装包方式</p> 
<pre><code class="prism language-bash"><span class="token function">curl</span> <span class="token parameter variable">-O</span> https://repo.clickhouse.com/tgz/stable/clickhouse-common-static-20.8.9.6.tgz
<span class="token function">curl</span> <span class="token parameter variable">-O</span> https://repo.clickhouse.com/tgz/stable/clickhouse-server-20.8.9.6.tgz
<span class="token function">curl</span> <span class="token parameter variable">-O</span> https://repo.clickhouse.com/tgz/stable/clickhouse-client-20.8.9.6.tgz

<span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> clickhouse-common-static-20.8.9.6.tgz
<span class="token function">sudo</span> clickhouse-common-static-20.8.9.6/install/doinst.sh

<span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> clickhouse-server-20.8.9.6.tgz
<span class="token function">sudo</span> clickhouse-server-20.8.9.6/install/doinst.sh

<span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> clickhouse-client-20.8.9.6.tgz
<span class="token function">sudo</span> clickhouse-client-20.8.9.6/install/doinst.sh
</code></pre> 
<p>二、修改配置文件<br> 假设我们的节点是<code>10.***.***.[16:21]</code>，以<code>10.***.***.16</code>上的配置为例。<br> <img src="https://images2.imgbox.com/e7/b0/OEANIquc_o.png" alt="文件目录"></p> 
<ul><li>config.xml<br> 根据实际情况修改。我的节点信息都配置在<code>metrika.xml</code>文件里，<code>config.xml</code>文件主要做了一些存储路径，大小限制的修改。该版本自带prometheus exporter，有需要取消相应注释即可。</li></ul> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0"?&gt;</span>
<span class="token comment">&lt;!--
  NOTE: User and query level settings are set up in "users.xml" file.
  If you have accidentally specified user-level settings here, server won't start.
  You can either move the settings to the right place inside "users.xml" file
   or add &lt;skip_check_for_incorrect_settings&gt;1&lt;/skip_check_for_incorrect_settings&gt; here.
--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>yandex</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Possible levels: https://github.com/pocoproject/poco/blob/poco-1.9.4-release/Foundation/include/Poco/Logger.h#L105 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">&gt;</span></span>trace<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log</span><span class="token punctuation">&gt;</span></span>/app/clickhouse/logs/server/clickhouse-server.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>errorlog</span><span class="token punctuation">&gt;</span></span>/app/clickhouse/logs/server/clickhouse-server.err.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>errorlog</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>size</span><span class="token punctuation">&gt;</span></span>1000M<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>size</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>count</span><span class="token punctuation">&gt;</span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>count</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- &lt;console&gt;1&lt;/console&gt; --&gt;</span> <span class="token comment">&lt;!-- Default behavior is autodetection (log to console if not daemon mode and is tty) --&gt;</span>

        <span class="token comment">&lt;!-- Per level overrides (legacy):

        For example to suppress logging of the ConfigReloader you can use:
        NOTE: levels.logger is reserved, see below.
        --&gt;</span>
        <span class="token comment">&lt;!--
        &lt;levels&gt;
          &lt;ConfigReloader&gt;none&lt;/ConfigReloader&gt;
        &lt;/levels&gt;
        --&gt;</span>

        <span class="token comment">&lt;!-- Per level overrides:

        For example to suppress logging of the RBAC for default user you can use:
        (But please note that the logger name maybe changed from version to version, even after minor upgrade)
        --&gt;</span>
        <span class="token comment">&lt;!--
        &lt;levels&gt;
          &lt;logger&gt;
            &lt;name&gt;ContextAccess (default)&lt;/name&gt;
            &lt;level&gt;none&lt;/level&gt;
          &lt;/logger&gt;
          &lt;logger&gt;
            &lt;name&gt;DatabaseOrdinary (test)&lt;/name&gt;
            &lt;level&gt;none&lt;/level&gt;
          &lt;/logger&gt;
        &lt;/levels&gt;
        --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>logger</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>send_crash_reports</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Changing &lt;enabled&gt; to true allows sending crash reports to --&gt;</span>
        <span class="token comment">&lt;!-- the ClickHouse core developers team via Sentry https://sentry.io --&gt;</span>
        <span class="token comment">&lt;!-- Doing so at least in pre-production environments is highly appreciated --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Change &lt;anonymize&gt; to true if you don't feel comfortable attaching the server hostname to the crash report --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>anonymize</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>anonymize</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Default endpoint should be changed to different Sentry DSN only if you have --&gt;</span>
        <span class="token comment">&lt;!-- some in-house engineers or hired consultants who're going to debug ClickHouse issues for you --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>endpoint</span><span class="token punctuation">&gt;</span></span>https://6f33034cfe684dd7a3ab9875e57b1c8d@o388870.ingest.sentry.io/5226277<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>endpoint</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>send_crash_reports</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--display_name&gt;production&lt;/display_name--&gt;</span> <span class="token comment">&lt;!-- It is the name that will be shown in the client --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>display_name</span><span class="token punctuation">&gt;</span></span>PROD_ZZ_16<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>display_name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>http_port</span><span class="token punctuation">&gt;</span></span>8123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>http_port</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tcp_port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tcp_port</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mysql_port</span><span class="token punctuation">&gt;</span></span>9004<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mysql_port</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- For HTTPS and SSL over native protocol. --&gt;</span>
    <span class="token comment">&lt;!--
    &lt;https_port&gt;8443&lt;/https_port&gt;
    &lt;tcp_port_secure&gt;9440&lt;/tcp_port_secure&gt;
    --&gt;</span>
    <span class="token comment">&lt;!-- Used with https_port and tcp_port_secure. Full ssl options list: https://github.com/ClickHouse-Extras/poco/blob/master/NetSSL_OpenSSL/include/Poco/Net/SSLManager.h#L71 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>openSSL</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- Used for https server AND secure tcp port --&gt;</span>
            <span class="token comment">&lt;!-- openssl req -subj "/CN=localhost" -new -newkey rsa:2048 -days 365 -nodes -x509 -keyout /etc/clickhouse-server/server.key -out /etc/clickhouse-server/server.crt --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>certificateFile</span><span class="token punctuation">&gt;</span></span>/etc/clickhouse-server/server.crt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>certificateFile</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>privateKeyFile</span><span class="token punctuation">&gt;</span></span>/etc/clickhouse-server/server.key<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>privateKeyFile</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- openssl dhparam -out /etc/clickhouse-server/dhparam.pem 4096 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dhParamsFile</span><span class="token punctuation">&gt;</span></span>/etc/clickhouse-server/dhparam.pem<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dhParamsFile</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>verificationMode</span><span class="token punctuation">&gt;</span></span>none<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>verificationMode</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>loadDefaultCAFile</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>loadDefaultCAFile</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cacheSessions</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>cacheSessions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disableProtocols</span><span class="token punctuation">&gt;</span></span>sslv2,sslv3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disableProtocols</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>preferServerCiphers</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>preferServerCiphers</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>client</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- Used for connecting to https dictionary source and secured Zookeeper communication --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>loadDefaultCAFile</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>loadDefaultCAFile</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cacheSessions</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>cacheSessions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disableProtocols</span><span class="token punctuation">&gt;</span></span>sslv2,sslv3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disableProtocols</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>preferServerCiphers</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>preferServerCiphers</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- Use for self-signed: &lt;verificationMode&gt;none&lt;/verificationMode&gt; --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>invalidCertificateHandler</span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">&lt;!-- Use for self-signed: &lt;name&gt;AcceptCertificateHandler&lt;/name&gt; --&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>RejectCertificateHandler<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>invalidCertificateHandler</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>client</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>openSSL</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Default root page on http[s] server. For example load UI from https://tabix.io/ when opening http://localhost:8123 --&gt;</span>
    <span class="token comment">&lt;!--
    &lt;http_server_default_response&gt;&lt;![CDATA[&lt;html ng-app="SMI2"&gt;&lt;head&gt;&lt;base href="http://ui.tabix.io/"&gt;&lt;/head&gt;&lt;body&gt;&lt;div ui-view="" class="content-ui"&gt;&lt;/div&gt;&lt;script src="http://loader.tabix.io/master.js"&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;]]&gt;&lt;/http_server_default_response&gt;
    --&gt;</span>

    <span class="token comment">&lt;!-- Port for communication between replicas. Used for data exchange. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>interserver_http_port</span><span class="token punctuation">&gt;</span></span>9009<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>interserver_http_port</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Hostname that is used by other replicas to request this server.
         If not specified, than it is determined analogous to 'hostname -f' command.
         This setting could be used to switch replication to another network interface.
      --&gt;</span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>interserver_http_host</span><span class="token punctuation">&gt;</span></span>10.***.***.16<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>interserver_http_host</span><span class="token punctuation">&gt;</span></span>


    <span class="token comment">&lt;!-- Listen specified host. use :: (wildcard IPv6 address), if you want to accept connections both with IPv4 and IPv6 from everywhere. --&gt;</span>
    <span class="token comment">&lt;!-- &lt;listen_host&gt;::&lt;/listen_host&gt; --&gt;</span>
    <span class="token comment">&lt;!-- Same for hosts with disabled ipv6: --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listen_host</span><span class="token punctuation">&gt;</span></span>0.0.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listen_host</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Default values - try listen localhost on ipv4 and ipv6: --&gt;</span>
    <span class="token comment">&lt;!--
    &lt;listen_host&gt;::1&lt;/listen_host&gt;
    &lt;listen_host&gt;127.0.0.1&lt;/listen_host&gt;
    --&gt;</span>
    <span class="token comment">&lt;!-- Don't exit if ipv6 or ipv4 unavailable, but listen_host with this protocol specified --&gt;</span>
    <span class="token comment">&lt;!-- &lt;listen_try&gt;0&lt;/listen_try&gt; --&gt;</span>

    <span class="token comment">&lt;!-- Allow listen on same address:port --&gt;</span>
    <span class="token comment">&lt;!-- &lt;listen_reuse_port&gt;0&lt;/listen_reuse_port&gt; --&gt;</span>

    <span class="token comment">&lt;!-- &lt;listen_backlog&gt;64&lt;/listen_backlog&gt; --&gt;</span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max_connections</span><span class="token punctuation">&gt;</span></span>4096<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max_connections</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keep_alive_timeout</span><span class="token punctuation">&gt;</span></span>600<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keep_alive_timeout</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Maximum number of concurrent queries. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max_concurrent_queries</span><span class="token punctuation">&gt;</span></span>500<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max_concurrent_queries</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Maximum memory usage (resident set size) for server process.
         Zero value or unset means default. Default is "max_server_memory_usage_to_ram_ratio" of available physical RAM.
         If the value is larger than "max_server_memory_usage_to_ram_ratio" of available physical RAM, it will be cut down.

         The constraint is checked on query execution time.
         If a query tries to allocate memory and the current memory usage plus allocation is greater
          than specified threshold, exception will be thrown.

         It is not practical to set this constraint to small values like just a few gigabytes,
          because memory allocator will keep this amount of memory in caches and the server will deny service of queries.
      --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max_server_memory_usage</span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max_server_memory_usage</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Maximum number of threads in the Global thread pool.
    This will default to a maximum of 10000 threads if not specified.
    This setting will be useful in scenarios where there are a large number
    of distributed queries that are running concurrently but are idling most
    of the time, in which case a higher number of threads might be required.
    --&gt;</span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max_thread_pool_size</span><span class="token punctuation">&gt;</span></span>10000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max_thread_pool_size</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- On memory constrained environments you may have to set this to value larger than 1.
      --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max_server_memory_usage_to_ram_ratio</span><span class="token punctuation">&gt;</span></span>0.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max_server_memory_usage_to_ram_ratio</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Simple server-wide memory profiler. Collect a stack trace at every peak allocation step (in bytes).
         Data will be stored in system.trace_log table with query_id = empty string.
         Zero means disabled.
      --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>total_memory_profiler_step</span><span class="token punctuation">&gt;</span></span>4194304<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>total_memory_profiler_step</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Collect random allocations and deallocations and write them into system.trace_log with 'MemorySample' trace_type.
         The probability is for every alloc/free regardless to the size of the allocation.
         Note that sampling happens only when the amount of untracked memory exceeds the untracked memory limit,
          which is 4 MiB by default but can be lowered if 'total_memory_profiler_step' is lowered.
         You may want to set 'total_memory_profiler_step' to 1 for extra fine grained sampling.
      --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>total_memory_tracker_sample_probability</span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>total_memory_tracker_sample_probability</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Set limit on number of open files (default: maximum). This setting makes sense on Mac OS X because getrlimit() fails to retrieve
         correct maximum value. --&gt;</span>
    <span class="token comment">&lt;!-- &lt;max_open_files&gt;262144&lt;/max_open_files&gt; --&gt;</span>

    <span class="token comment">&lt;!-- Size of cache of uncompressed blocks of data, used in tables of MergeTree family.
         In bytes. Cache is single for server. Memory is allocated only on demand.
         Cache is used when 'use_uncompressed_cache' user setting turned on (off by default).
         Uncompressed cache is advantageous only for very short queries and in rare cases.
      --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uncompressed_cache_size</span><span class="token punctuation">&gt;</span></span>8589934592<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>uncompressed_cache_size</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Approximate size of mark cache, used in tables of MergeTree family.
         In bytes. Cache is single for server. Memory is allocated only on demand.
         You should not lower this value.
      --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mark_cache_size</span><span class="token punctuation">&gt;</span></span>5368709120<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mark_cache_size</span><span class="token punctuation">&gt;</span></span>


    <span class="token comment">&lt;!-- Path to data directory, with trailing slash. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span><span class="token punctuation">&gt;</span></span>/app/clickhouse/CHDATA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>path</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Path to temporary data for processing hard queries. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tmp_path</span><span class="token punctuation">&gt;</span></span>/app/clickhouse/tmp/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tmp_path</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Policy from the &lt;storage_configuration&gt; for the temporary files.
         If not set &lt;tmp_path&gt; is used, otherwise &lt;tmp_path&gt; is ignored.

         Notes:
         - move_factor              is ignored
         - keep_free_space_bytes    is ignored
         - max_data_part_size_bytes is ignored
         - you must have exactly one volume in that policy
    --&gt;</span>
    <span class="token comment">&lt;!-- &lt;tmp_policy&gt;tmp&lt;/tmp_policy&gt; --&gt;</span>

    <span class="token comment">&lt;!-- Directory with user provided files that are accessible by 'file' table function. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user_files_path</span><span class="token punctuation">&gt;</span></span>/app/clickhouse/user_files/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user_files_path</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Path to folder where users and roles created by SQL commands are stored. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>access_control_path</span><span class="token punctuation">&gt;</span></span>/app/clickhouse/access/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>access_control_path</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- External user directories (LDAP). --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ldap_servers</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- List LDAP servers with their connection parameters here to later use them as authenticators for dedicated users,
             who have 'ldap' authentication mechanism specified instead of 'password'.
             Parameters:
                host - LDAP server hostname or IP, this parameter is mandatory and cannot be empty.
                port - LDAP server port, default is 636 if enable_tls is set to true, 389 otherwise.
                auth_dn_prefix, auth_dn_suffix - prefix and suffix used to construct the DN to bind to.
                        Effectively, the resulting DN will be constructed as auth_dn_prefix + escape(user_name) + auth_dn_suffix string.
                        Note, that this implies that auth_dn_suffix should usually have comma ',' as its first non-space character.
                enable_tls - flag to trigger use of secure connection to the LDAP server.
                        Specify 'no' for plain text (ldap://) protocol (not recommended).
                        Specify 'yes' for LDAP over SSL/TLS (ldaps://) protocol (recommended, the default).
                        Specify 'starttls' for legacy StartTLS protocol (plain text (ldap://) protocol, upgraded to TLS).
                tls_minimum_protocol_version - the minimum protocol version of SSL/TLS.
                        Accepted values are: 'ssl2', 'ssl3', 'tls1.0', 'tls1.1', 'tls1.2' (the default).
                tls_require_cert - SSL/TLS peer certificate verification behavior.
                        Accepted values are: 'never', 'allow', 'try', 'demand' (the default).
                tls_cert_file - path to certificate file.
                tls_key_file - path to certificate key file.
                tls_ca_cert_file - path to CA certificate file.
                tls_ca_cert_dir - path to the directory containing CA certificates.
                tls_cipher_suite - allowed cipher suite.
             Example:
                &lt;my_ldap_server&gt;
                    &lt;host&gt;localhost&lt;/host&gt;
                    &lt;port&gt;636&lt;/port&gt;
                    &lt;auth_dn_prefix&gt;uid=&lt;/auth_dn_prefix&gt;
                    &lt;auth_dn_suffix&gt;,ou=users,dc=example,dc=com&lt;/auth_dn_suffix&gt;
                    &lt;enable_tls&gt;yes&lt;/enable_tls&gt;
                    &lt;tls_minimum_protocol_version&gt;tls1.2&lt;/tls_minimum_protocol_version&gt;
                    &lt;tls_require_cert&gt;demand&lt;/tls_require_cert&gt;
                    &lt;tls_cert_file&gt;/path/to/tls_cert_file&lt;/tls_cert_file&gt;
                    &lt;tls_key_file&gt;/path/to/tls_key_file&lt;/tls_key_file&gt;
                    &lt;tls_ca_cert_file&gt;/path/to/tls_ca_cert_file&lt;/tls_ca_cert_file&gt;
                    &lt;tls_ca_cert_dir&gt;/path/to/tls_ca_cert_dir&lt;/tls_ca_cert_dir&gt;
                    &lt;tls_cipher_suite&gt;ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:AES256-GCM-SHA384&lt;/tls_cipher_suite&gt;
                &lt;/my_ldap_server&gt;
        --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ldap_servers</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Path to configuration file with users, access rights, profiles of settings, quotas. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>users_config</span><span class="token punctuation">&gt;</span></span>users.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>users_config</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Default profile of settings. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>default_profile</span><span class="token punctuation">&gt;</span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>default_profile</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Comma-separated list of prefixes for user-defined settings. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>custom_settings_prefixes</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>custom_settings_prefixes</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- System profile of settings. This settings are used by internal processes (Buffer storage, Distributed DDL worker and so on). --&gt;</span>
    <span class="token comment">&lt;!-- &lt;system_profile&gt;default&lt;/system_profile&gt; --&gt;</span>

    <span class="token comment">&lt;!-- Default database. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>default_database</span><span class="token punctuation">&gt;</span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>default_database</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Server time zone could be set here.

         Time zone is used when converting between String and DateTime types,
          when printing DateTime in text formats and parsing DateTime from text,
          it is used in date and time related functions, if specific time zone was not passed as an argument.

         Time zone is specified as identifier from IANA time zone database, like UTC or Africa/Abidjan.
         If not specified, system time zone at server startup is used.

         Please note, that server could display time zone alias instead of specified name.
         Example: W-SU is an alias for Europe/Moscow and Zulu is an alias for UTC.
    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timezone</span><span class="token punctuation">&gt;</span></span>Asia/Shanghai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timezone</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- You can specify umask here (see "man umask"). Server will apply it on startup.
         Number is always parsed as octal. Default umask is 027 (other users cannot read logs, data files, etc; group can only read).
    --&gt;</span>
    <span class="token comment">&lt;!-- &lt;umask&gt;022&lt;/umask&gt; --&gt;</span>

    <span class="token comment">&lt;!-- Perform mlockall after startup to lower first queries latency
          and to prevent clickhouse executable from being paged out under high IO load.
         Enabling this option is recommended but will lead to increased startup time for up to a few seconds.
    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mlock_executable</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mlock_executable</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Configuration of clusters that could be used in Distributed tables.
         https://clickhouse.tech/docs/en/operations/table_engines/distributed/
      --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>remote_servers</span> <span class="token attr-name">incl</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clickhouse_remote_servers<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include_from</span><span class="token punctuation">&gt;</span></span>/etc/clickhouse-server/config.d/metrika.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include_from</span><span class="token punctuation">&gt;</span></span> 

    <span class="token comment">&lt;!-- The list of hosts allowed to use in URL-related storage engines and table functions.
        If this section is not present in configuration, all hosts are allowed.
    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>remote_url_allow_hosts</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Host should be specified exactly as in URL. The name is checked before DNS resolution.
            Example: "yandex.ru", "yandex.ru." and "www.yandex.ru" are different hosts.
                    If port is explicitly specified in URL, the host:port is checked as a whole.
                    If host specified here without port, any port with this host allowed.
                    "yandex.ru" -&gt; "yandex.ru:443", "yandex.ru:80" etc. is allowed, but "yandex.ru:80" -&gt; only "yandex.ru:80" is allowed.
            If the host is specified as IP address, it is checked as specified in URL. Example: "[2a02:6b8:a::a]".
            If there are redirects and support for redirects is enabled, every redirect (the Location field) is checked.
        --&gt;</span>

        <span class="token comment">&lt;!-- Regular expression can be specified. RE2 engine is used for regexps.
            Regexps are not aligned: don't forget to add ^ and $. Also don't forget to escape dot (.) metacharacter
            (forgetting to do so is a common source of error).
        --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>remote_url_allow_hosts</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- If element has 'incl' attribute, then for it's value will be used corresponding substitution from another file.
         By default, path to file with substitutions is /etc/metrika.xml. It could be changed in config in 'include_from' element.
         Values for substitutions are specified in /yandex/name_of_substitution elements in that file.
      --&gt;</span>

    <span class="token comment">&lt;!-- ZooKeeper is used to store metadata about replicas, when using Replicated tables.
         Optional. If you don't use replicated tables, you could omit that.

         See https://clickhouse.yandex/docs/en/table_engines/replication/
      --&gt;</span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>zookeeper</span> <span class="token attr-name">incl</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zookeeper-servers<span class="token punctuation">"</span></span> <span class="token attr-name">optional</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!-- Substitutions for parameters of replicated tables.
          Optional. If you don't use replicated tables, you could omit that.

         See https://clickhouse.yandex/docs/en/table_engines/replication/#creating-replicated-tables
      --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>macros</span> <span class="token attr-name">incl</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>macros<span class="token punctuation">"</span></span> <span class="token attr-name">optional</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>


    <span class="token comment">&lt;!-- Reloading interval for embedded dictionaries, in seconds. Default: 3600. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>builtin_dictionaries_reload_interval</span><span class="token punctuation">&gt;</span></span>3600<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>builtin_dictionaries_reload_interval</span><span class="token punctuation">&gt;</span></span>


    <span class="token comment">&lt;!-- Maximum session timeout, in seconds. Default: 3600. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max_session_timeout</span><span class="token punctuation">&gt;</span></span>3600<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max_session_timeout</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Default session timeout, in seconds. Default: 60. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>default_session_timeout</span><span class="token punctuation">&gt;</span></span>60<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>default_session_timeout</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Sending data to Graphite for monitoring. Several sections can be defined. --&gt;</span>
    <span class="token comment">&lt;!--
        interval - send every X second
        root_path - prefix for keys
        hostname_in_path - append hostname to root_path (default = true)
        metrics - send data from table system.metrics
        events - send data from table system.events
        asynchronous_metrics - send data from table system.asynchronous_metrics
    --&gt;</span>
    <span class="token comment">&lt;!--
    &lt;graphite&gt;
        &lt;host&gt;localhost&lt;/host&gt;
        &lt;port&gt;42000&lt;/port&gt;
        &lt;timeout&gt;0.1&lt;/timeout&gt;
        &lt;interval&gt;60&lt;/interval&gt;
        &lt;root_path&gt;one_min&lt;/root_path&gt;
        &lt;hostname_in_path&gt;true&lt;/hostname_in_path&gt;

        &lt;metrics&gt;true&lt;/metrics&gt;
        &lt;events&gt;true&lt;/events&gt;
        &lt;events_cumulative&gt;false&lt;/events_cumulative&gt;
        &lt;asynchronous_metrics&gt;true&lt;/asynchronous_metrics&gt;
    &lt;/graphite&gt;
    &lt;graphite&gt;
        &lt;host&gt;localhost&lt;/host&gt;
        &lt;port&gt;42000&lt;/port&gt;
        &lt;timeout&gt;0.1&lt;/timeout&gt;
        &lt;interval&gt;1&lt;/interval&gt;
        &lt;root_path&gt;one_sec&lt;/root_path&gt;

        &lt;metrics&gt;true&lt;/metrics&gt;
        &lt;events&gt;true&lt;/events&gt;
        &lt;events_cumulative&gt;false&lt;/events_cumulative&gt;
        &lt;asynchronous_metrics&gt;false&lt;/asynchronous_metrics&gt;
    &lt;/graphite&gt;
    --&gt;</span>

    <span class="token comment">&lt;!-- Serve endpoint for Prometheus monitoring. --&gt;</span>
    <span class="token comment">&lt;!--
        endpoint - mertics path (relative to root, statring with "/")
        port - port to setup server. If not defined or 0 than http_port used
        metrics - send data from table system.metrics
        events - send data from table system.events
        asynchronous_metrics - send data from table system.asynchronous_metrics
        status_info - send data from different component from CH, ex: Dictionaries status
    --&gt;</span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prometheus</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>endpoint</span><span class="token punctuation">&gt;</span></span>/metrics<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>endpoint</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9363<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>metrics</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>metrics</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>events</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>events</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>asynchronous_metrics</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>asynchronous_metrics</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>status_info</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>status_info</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>prometheus</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Query log. Used only for queries with setting log_queries = 1. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>query_log</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- What table to insert data. If table is not exist, it will be created.
             When query log structure is changed after system update,
              then old table will be renamed and new table will be created automatically.
        --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>database</span><span class="token punctuation">&gt;</span></span>system<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>database</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>query_log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--
            PARTITION BY expr https://clickhouse.yandex/docs/en/table_engines/custom_partitioning_key/
            Example:
                event_date
                toMonday(event_date)
                toYYYYMM(event_date)
                toStartOfHour(event_time)
        --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>partition_by</span><span class="token punctuation">&gt;</span></span>toYYYYMM(event_date)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>partition_by</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- Instead of partition_by, you can provide full engine expression (starting with ENGINE = ) with parameters,
             Example: &lt;engine&gt;ENGINE = MergeTree PARTITION BY toYYYYMM(event_date) ORDER BY (event_date, event_time) SETTINGS index_granularity = 1024&lt;/engine&gt;
          --&gt;</span>

        <span class="token comment">&lt;!-- Interval of flushing data. --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>7500<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>query_log</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Trace log. Stores stack traces collected by query profilers.
         See query_profiler_real_time_period_ns and query_profiler_cpu_time_period_ns settings. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trace_log</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>database</span><span class="token punctuation">&gt;</span></span>system<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>database</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>trace_log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>partition_by</span><span class="token punctuation">&gt;</span></span>toYYYYMM(event_date)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>partition_by</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>7500<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trace_log</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Query thread log. Has information about all threads participated in query execution.
         Used only for queries with setting log_query_threads = 1. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>query_thread_log</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>database</span><span class="token punctuation">&gt;</span></span>system<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>database</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>query_thread_log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>partition_by</span><span class="token punctuation">&gt;</span></span>toYYYYMM(event_date)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>partition_by</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>7500<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>query_thread_log</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>part_log</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>database</span><span class="token punctuation">&gt;</span></span>system<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>database</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>part_log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>7500<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>part_log</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Uncomment to write text log into table.
         Text log contains all information from usual server log but stores it in structured and efficient way.
         The level of the messages that goes to the table can be limited (&lt;level&gt;), if not specified all messages will go to the table.
    &lt;text_log&gt;
        &lt;database&gt;system&lt;/database&gt;
        &lt;table&gt;text_log&lt;/table&gt;
        &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt;
        &lt;level&gt;&lt;/level&gt;
    &lt;/text_log&gt;
    --&gt;</span>

    <span class="token comment">&lt;!-- Metric log contains rows with current values of ProfileEvents, CurrentMetrics collected with "collect_interval_milliseconds" interval. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>metric_log</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>database</span><span class="token punctuation">&gt;</span></span>system<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>database</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>metric_log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>7500<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collect_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>1000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>collect_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>metric_log</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--
        Asynchronous metric log contains values of metrics from
        system.asynchronous_metrics.
    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>asynchronous_metric_log</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>database</span><span class="token punctuation">&gt;</span></span>system<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>database</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>asynchronous_metric_log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--
            Asynchronous metrics are updated once a minute, so there is
            no need to flush more often.
        --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>60000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>asynchronous_metric_log</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Crash log. Stores stack traces for fatal errors.
         This table is normally empty. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crash_log</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>database</span><span class="token punctuation">&gt;</span></span>system<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>database</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>crash_log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>partition_by</span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>1000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>flush_interval_milliseconds</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crash_log</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Parameters for embedded dictionaries, used in Yandex.Metrica.
         See https://clickhouse.yandex/docs/en/dicts/internal_dicts/
    --&gt;</span>

    <span class="token comment">&lt;!-- Path to file with region hierarchy. --&gt;</span>
    <span class="token comment">&lt;!-- &lt;path_to_regions_hierarchy_file&gt;/opt/geo/regions_hierarchy.txt&lt;/path_to_regions_hierarchy_file&gt; --&gt;</span>

    <span class="token comment">&lt;!-- Path to directory with files containing names of regions --&gt;</span>
    <span class="token comment">&lt;!-- &lt;path_to_regions_names_files&gt;/opt/geo/&lt;/path_to_regions_names_files&gt; --&gt;</span>


    <span class="token comment">&lt;!-- Configuration of external dictionaries. See:
         https://clickhouse.yandex/docs/en/dicts/external_dicts/
    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dictionaries_config</span><span class="token punctuation">&gt;</span></span>*_dictionary.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dictionaries_config</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Uncomment if you want data to be compressed 30-100% better.
         Don't do that if you just started using ClickHouse.
      --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>compression</span> <span class="token attr-name">incl</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clickhouse_compression<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--
        &lt;!- - Set of variants. Checked in order. Last matching case wins. If nothing matches, lz4 will be used. - -&gt;
        &lt;case&gt;

            &lt;!- - Conditions. All must be satisfied. Some conditions may be omitted. - -&gt;
            &lt;min_part_size&gt;10000000000&lt;/min_part_size&gt;        &lt;!- - Min part size in bytes. - -&gt;
            &lt;min_part_size_ratio&gt;0.01&lt;/min_part_size_ratio&gt;   &lt;!- - Min size of part relative to whole table size. - -&gt;

            &lt;!- - What compression method to use. - -&gt;
            &lt;method&gt;zstd&lt;/method&gt;
        &lt;/case&gt;
    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>compression</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Allow to execute distributed DDL queries (CREATE, DROP, ALTER, RENAME) on cluster.
         Works only if ZooKeeper is enabled. Comment it if such functionality isn't required. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>distributed_ddl</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Path in ZooKeeper to queue with DDL queries --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span><span class="token punctuation">&gt;</span></span>/clickhouse/task_queue/ddl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>path</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- Settings from this profile will be used to execute DDL queries --&gt;</span>
        <span class="token comment">&lt;!-- &lt;profile&gt;default&lt;/profile&gt; --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>distributed_ddl</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Settings to fine tune MergeTree tables. See documentation in source code, in MergeTreeSettings.h --&gt;</span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>merge_tree</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parts_to_delay_insert</span><span class="token punctuation">&gt;</span></span>300<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parts_to_delay_insert</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parts_to_throw_insert</span><span class="token punctuation">&gt;</span></span>1200<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parts_to_throw_insert</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max_delay_to_insert</span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max_delay_to_insert</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max_suspicious_broken_parts</span><span class="token punctuation">&gt;</span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max_suspicious_broken_parts</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>merge_tree</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Protection from accidental DROP.
         If size of a MergeTree table is greater than max_table_size_to_drop (in bytes) than table could not be dropped with any DROP query.
         If you want do delete one table and don't want to change clickhouse-server config, you could create special file &lt;clickhouse-path&gt;/flags/force_drop_table and make DROP once.
         By default max_table_size_to_drop is 50GB; max_table_size_to_drop=0 allows to DROP any tables.
         The same for max_partition_size_to_drop.
         Uncomment to disable protection.
    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max_table_size_to_drop</span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max_table_size_to_drop</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max_partition_size_to_drop</span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max_partition_size_to_drop</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Example of parameters for GraphiteMergeTree table engine --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>graphite_rollup_example</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>regexp</span><span class="token punctuation">&gt;</span></span>click_cost<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>regexp</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span><span class="token punctuation">&gt;</span></span>any<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>retention</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>age</span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>age</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>precision</span><span class="token punctuation">&gt;</span></span>3600<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>precision</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>retention</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>retention</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>age</span><span class="token punctuation">&gt;</span></span>86400<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>age</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>precision</span><span class="token punctuation">&gt;</span></span>60<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>precision</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>retention</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>default</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span><span class="token punctuation">&gt;</span></span>max<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>retention</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>age</span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>age</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>precision</span><span class="token punctuation">&gt;</span></span>60<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>precision</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>retention</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>retention</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>age</span><span class="token punctuation">&gt;</span></span>3600<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>age</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>precision</span><span class="token punctuation">&gt;</span></span>300<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>precision</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>retention</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>retention</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>age</span><span class="token punctuation">&gt;</span></span>86400<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>age</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>precision</span><span class="token punctuation">&gt;</span></span>3600<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>precision</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>retention</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>default</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>graphite_rollup_example</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Directory in &lt;clickhouse-path&gt; containing schema files for various input formats.
         The directory will be created if it doesn't exist.
      --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>format_schema_path</span><span class="token punctuation">&gt;</span></span>/app/clickhouse/format_schemas/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>format_schema_path</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Uncomment to use query masking rules.
        name - name for the rule (optional)
        regexp - RE2 compatible regular expression (mandatory)
	replace - substitution string for sensitive data (optional, by default - six asterisks)
    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>query_masking_rules</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>hide SSN<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>regexp</span><span class="token punctuation">&gt;</span></span>\b\d{3}-\d{2}-\d{4}\b<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>regexp</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replace</span><span class="token punctuation">&gt;</span></span>000-00-0000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replace</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>query_masking_rules</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Uncomment to use custom http handlers.
        rules are checked from top to bottom, first match runs the handler
            url - to match request URL, you can use 'regex:' prefix to use regex match(optional)
            methods - to match request method, you can use commas to separate multiple method matches(optional)
            headers - to match request headers, match each child element(child element name is header name), you can use 'regex:' prefix to use regex match(optional)
        handler is request handler
            type - supported types: static, dynamic_query_handler, predefined_query_handler
            query - use with predefined_query_handler type, executes query when the handler is called
            query_param_name - use with dynamic_query_handler type, extracts and executes the value corresponding to the &lt;query_param_name&gt; value in HTTP request params
            status - use with static type, response status code
            content_type - use with static type, response content-type
            response_content - use with static type, Response content sent to client, when using the prefix 'file://' or 'config://', find the content from the file or configuration send to client.

    &lt;http_handlers&gt;
        &lt;rule&gt;
            &lt;url&gt;/&lt;/url&gt;
            &lt;methods&gt;POST,GET&lt;/methods&gt;
            &lt;headers&gt;&lt;pragma&gt;no-cache&lt;/pragma&gt;&lt;/headers&gt;
            &lt;handler&gt;
                &lt;type&gt;dynamic_query_handler&lt;/type&gt;
                &lt;query_param_name&gt;query&lt;/query_param_name&gt;
            &lt;/handler&gt;
        &lt;/rule&gt;

        &lt;rule&gt;
            &lt;url&gt;/predefined_query&lt;/url&gt;
            &lt;methods&gt;POST,GET&lt;/methods&gt;
            &lt;handler&gt;
                &lt;type&gt;predefined_query_handler&lt;/type&gt;
                &lt;query&gt;SELECT * FROM system.settings&lt;/query&gt;
            &lt;/handler&gt;
        &lt;/rule&gt;

        &lt;rule&gt;
            &lt;handler&gt;
                &lt;type&gt;static&lt;/type&gt;
                &lt;status&gt;200&lt;/status&gt;
                &lt;content_type&gt;text/plain; charset=UTF-8&lt;/content_type&gt;
                &lt;response_content&gt;config://http_server_default_response&lt;/response_content&gt;
            &lt;/handler&gt;
        &lt;/rule&gt;
    &lt;/http_handlers&gt;
    --&gt;</span>

    <span class="token comment">&lt;!-- Uncomment to disable ClickHouse internal DNS caching. --&gt;</span>
    <span class="token comment">&lt;!-- &lt;disable_internal_dns_cache&gt;1&lt;/disable_internal_dns_cache&gt; --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>yandex</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ul><li>config.d/metrika.xml</li></ul> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>yandex</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clickhouse_remote_servers</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prd_zz</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>internal_replication</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>internal_replication</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>10.***.***.16<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>*******<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>10.***.***.19<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>*******<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>internal_replication</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>internal_replication</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>10.***.***.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>*******<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>10.***.***.20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>*******<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">&gt;</span></span>
      
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>internal_replication</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>internal_replication</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>10.***.***.18<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>*******<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>10.***.***.21<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>*******<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>prd_zz</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>clickhouse_remote_servers</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>zookeeper-servers</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>10.***.***.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>10.***.***.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>10.***.***.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>zookeeper-servers</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>macros</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layer</span><span class="token punctuation">&gt;</span></span>01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layer</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">&gt;</span></span>01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>10.***.***.16-01-1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>macros</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>networks</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ip</span><span class="token punctuation">&gt;</span></span>::/0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ip</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>networks</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>yandex</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>说明：<code>10.***.***.16-01-1</code> 表示第一分片上的第一副本，相应的<code>10.***.***.19-01-2</code> 表示第一分片上的第二副本，<code>10.***.***.17-02-1</code> 表示第二分片上的第一副本，依此类推，在相应的节点上配置。</p> 
<ul><li>users.xml</li></ul> 
<p>记得把 <code>&lt;access_management&gt;1&lt;/access_management&gt;</code> 的注释去掉即可，<code>max_memory_usage</code> 根据需要调整</p> 
<ul><li>users.d/default-password.xml（default密码设置）</li></ul> 
<pre><code>&lt;yandex&gt;&lt;users&gt;&lt;default&gt;&lt;password&gt;*******&lt;/password&gt;&lt;/default&gt;&lt;/users&gt;&lt;/yandex&gt;
</code></pre> 
<p>二、启动服务</p> 
<p>执行 <code>sudo useradd clickhouse</code> 创建clickhouse用户，启动用户是clickhouse。</p> 
<p>执行 <code>sudo systemctl start clickhouse-server</code></p> 
<p>可能会遇到 <code>permission denied</code> 错误导致启动失败，检查目录的clickhouse用户读写权限，有必要可以提前创建好目录。</p> 
<p><img src="https://images2.imgbox.com/cc/f1/6e0Tm0sP_o.png" alt="集群信息"></p> 
<p>三、配置chproxy</p> 
<p>集群配置成功后，为防止直接写分布式表（不建议）出现写放大的问题，还需配置写入分布式表的代理chproxy。创建目录chproxy，将官网下载的chproxy执行文件放在这个目录下。</p> 
<p><img src="https://images2.imgbox.com/5b/03/IR5mTz1Q_o.png" alt="chproxy目录"></p> 
<ul><li>conf.d/config.yml</li></ul> 
<pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">listen_addr</span><span class="token punctuation">:</span> <span class="token string">":9090"</span>
      <span class="token key atrule">allowed_networks</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"10.0.0.0/8"</span><span class="token punctuation">]</span>

<span class="token key atrule">users</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"write"</span>
    <span class="token key atrule">to_cluster</span><span class="token punctuation">:</span> <span class="token string">"write"</span>
    <span class="token key atrule">to_user</span><span class="token punctuation">:</span> <span class="token string">"default"</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"*********"</span>
    <span class="token key atrule">allow_cors</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">max_concurrent_queries</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">max_execution_time</span><span class="token punctuation">:</span> 1m
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"readonly"</span>
    <span class="token key atrule">to_cluster</span><span class="token punctuation">:</span> <span class="token string">"read"</span>
    <span class="token key atrule">to_user</span><span class="token punctuation">:</span> <span class="token string">"readonly"</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"*********"</span>
    <span class="token key atrule">allow_cors</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">clusters</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"write"</span>
    <span class="token key atrule">nodes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"10.***.***.16:8123"</span><span class="token punctuation">,</span><span class="token string">"10.***.***.17:8123"</span><span class="token punctuation">,</span><span class="token string">"10.***.***.18:8123"</span><span class="token punctuation">]</span>
    <span class="token key atrule">users</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"default"</span>
        <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"*******"</span>
    <span class="token key atrule">kill_query_user</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"default"</span>
        <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"*******"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"read"</span>
    <span class="token key atrule">nodes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">"10.***.***.19:8123"</span><span class="token punctuation">,</span>
      <span class="token string">"10.***.***.20:8123"</span><span class="token punctuation">,</span>
      <span class="token string">"10.***.***.21:8123"</span>
    <span class="token punctuation">]</span>
    <span class="token key atrule">users</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"readonly"</span>
      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"Pass1234"</span>

<span class="token key atrule">caches</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"shortterm"</span>
    <span class="token key atrule">dir</span><span class="token punctuation">:</span> <span class="token string">"/app/chproxy/cache/shortterm"</span>
    <span class="token key atrule">max_size</span><span class="token punctuation">:</span> 500Mb
    <span class="token key atrule">expire</span><span class="token punctuation">:</span> 130s
</code></pre> 
<ul><li>restart.sh</li></ul> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token builtin class-name">cd</span> /data/chproxy

<span class="token assign-left variable">PORT_PROCESS1</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">netstat</span> <span class="token parameter variable">-nlpt</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">9090</span> <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span><span class="token variable">`</span></span>
<span class="token comment">#ps -ef | grep chproxy | head -2 | tail -1 | awk '{print $2}' | xargs kill -9</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$PORT_PROCESS1</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
   <span class="token function">nohup</span> ./chproxy <span class="token parameter variable">-config</span><span class="token operator">=</span>./conf.d/config.yml <span class="token operator">&gt;&gt;</span> ./logs/chproxy.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
<span class="token keyword">else</span>
   <span class="token builtin class-name">exit</span> <span class="token number">0</span>
<span class="token keyword">fi</span>
</code></pre> 
<ul><li>启动chproxy <code>nohup ./chproxy -config=./conf.d/config.yml &gt;&gt; ./logs/chproxy.log 2&gt;&amp;1 &amp;</code></li><li>将restart.sh加入crontab <code>*/1 * * * * bash /data/chproxy/restart.sh</code>，实现自动拉起。</li></ul> 
<p>四、安装keepalived（保证高可用）</p> 
<ul><li>修改keepalived配置：/etc/keepalived/keepalived.conf</li></ul> 
<pre><code>vrrp_script check_http {
    script "/app/chproxy/keepalivedscripts/check_port.sh 9090"
    interval 2
    weight -30
}

vrrp_instance VI_1 {
    interface bond0
    state MASTER/BACKUP
    priority 200/100
    advert_init 1
    virtual_router_id 33
    unicast_src_ip 10.***.***.16/10.***.***.17
    unicast_peer {
        10.***.***.17/10.***.***.16
    }

    authentication {
        auth_type PASS
        auth_pass chproxy@123
    }
    virtual_ipaddress {
        10.***.***.100
   }
   track_script {
        check_http
  }
notify_master "/app/chproxy/keepalivedscripts/arp.sh"
}
</code></pre> 
<ul><li>启动keepalived <code>sudo systemctl start keepalived</code></li></ul> 
<p>与keepalived相关脚本如下：</p> 
<ul><li>keepalivedscripts/arp.sh</li></ul> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token assign-left variable">VIP</span><span class="token operator">=</span><span class="token number">10</span>.***.***.100
<span class="token assign-left variable">GATEWAY</span><span class="token operator">=</span><span class="token number">10</span>.***.***.1
/sbin/arping <span class="token parameter variable">-I</span> bond0 <span class="token parameter variable">-c</span> <span class="token number">5</span> <span class="token parameter variable">-s</span> <span class="token variable">$VIP</span> <span class="token variable">$GATEWAY</span> <span class="token operator">&amp;&gt;</span>/dev/null
</code></pre> 
<ul><li>keepalivedscripts/check_port.sh</li></ul> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token assign-left variable">CHK_PORT1</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token comment">#CHK_PORT2=$2</span>

<span class="token assign-left variable">PORT_PROCESS1</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">netstat</span> <span class="token parameter variable">-nlpt</span> <span class="token operator">|</span> <span class="token function">grep</span> :$CHK_PORT1 <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span><span class="token variable">`</span></span>
<span class="token comment">#PORT_PROCESS2=`netstat -nlpt | grep :$CHK_PORT2 | wc -l`</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$PORT_PROCESS1</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
   <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token comment">#elif [ $PORT_PROCESS2 -eq 0 ];then</span>
<span class="token comment">#   exit 2</span>
<span class="token keyword">else</span>
   <span class="token builtin class-name">exit</span> <span class="token number">0</span>
<span class="token keyword">fi</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/090de7bf4fa9d47edc01ff334b1f71d0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">OpenVas扫描器更新扫描引擎</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/429337bf272351385df8de12a5d90d37/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue3获取组件名，自定义缓存组件，自定义清除缓存组件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>