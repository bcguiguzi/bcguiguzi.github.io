<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Microsoft VBA Excel 规律的Text文件转工作表Sheet - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Microsoft VBA Excel 规律的Text文件转工作表Sheet" />
<meta property="og:description" content="问题场景 简述：
在Excel的.xlsm文件中，有一个&#34;RunControl&#34;的sheet用来操控转换Text到指定的sheet中，需要在这个sheet上增加一个按钮，并在按钮上链接一个VBA程序，实现指定的功能。
以下是&#34;RunControl&#34;内的控制表格，五个标题名称以及另一名称（“FileName”）都已经通过名称管理器定义了各自的单元格。
ItemFolderNameIndicatorFilePathTime1ROEC:\User\Path12PEYC:\User\Path23PBC:\User\Path3 需要循环&#34;Item&#34;这一列数据，从被定义为&#34;Item&#34;的单元格开始直到取不到数据为止，这是主循环是否结束的判断；接着在每一次循环中先判断对应的&#34;Indicator&#34;是否是&#34;Y&#34;，如果是&#34;Y&#34;则执行两个操作：①新建一个sheet（名称是对应的&#34;FolderName&#34;），②需要组合读取对应的&#34;FilePath&#34;和&#34;FolderName&#34;和另一个独立的单元格&#34;FileName&#34;，这样就可以打开对应位置的文件执行后续的操作。
举个例子，现在主循环是&#34;Item&#34;为&#34;2&#34;的这一行，“Indicator&#34;是&#34;Y”，所以需要完成两个操作：①新建sheet命名为&#34;PE&#34;，②把对应的&#34;FilePath&#34;和&#34;FolderName&#34;和独立的&#34;FileName&#34;组合变成地址&#34;C:\User\Path2\PE\Information.text&#34;，通过地址打开&#34;Information.text&#34;这个文件。
文件打开后每一行的格式是这样的：“S=1234|T=ABCD|N=Sample|Location=\Path”，需要按分隔符&#34;|“切分每一列，使得全部数据都保存到对应的sheet（名称是对应的&#34;FolderName”）中。每一行只需要直接根据每一行的分隔符判断是放入对应sheet的哪一列即可，无视连续的多个分隔符&#34;|&#34;。并且在切分完成后加入一个判断：如果切分结果中有某一行结果和其他行不一致，给出警告弹窗。完成以上操作后，记录操作的时间放入对应的&#34;Time&#34;中。
代码描述 Sub Run_Text() Dim wsRun As Worksheet Set wsRun = ThisWorkbook.Sheets(&#34;RunControl&#34;) Dim cell As Range Dim folderName As String, filePath As String, fileName As String Dim fullFilePath As String Dim newWs As Worksheet Dim lastRow As Long &#39; Turn off screen updating to reduce memory pressure Application.ScreenUpdating = False &#39; Get the value of the FileName named range fileName = ThisWorkbook.Names(&#34;FileName&#34;).RefersToRange.Value &#39; Get the last row of the Item named range lastRow = wsRun." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/a3dff045f3365b12e7248d4784b175af/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-15T13:42:30+08:00" />
<meta property="article:modified_time" content="2024-03-15T13:42:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Microsoft VBA Excel 规律的Text文件转工作表Sheet</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>问题场景</h2> 
<p><code>简述：</code><br> 在Excel的.xlsm文件中，有一个"RunControl"的sheet用来操控转换Text到指定的sheet中，需要在这个sheet上增加一个按钮，并在按钮上链接一个VBA程序，实现指定的功能。</p> 
<p>以下是"RunControl"内的控制表格，五个标题名称以及另一名称（“FileName”）都已经通过名称管理器定义了各自的单元格。</p> 
<table><thead><tr><th>Item</th><th>FolderName</th><th>Indicator</th><th>FilePath</th><th>Time</th></tr></thead><tbody><tr><td>1</td><td>ROE</td><td></td><td>C:\User\Path1</td><td></td></tr><tr><td>2</td><td>PE</td><td>Y</td><td>C:\User\Path2</td><td></td></tr><tr><td>3</td><td>PB</td><td></td><td>C:\User\Path3</td><td></td></tr></tbody></table> 
<ol><li> <p>需要循环"Item"这一列数据，从被定义为"Item"的单元格开始直到取不到数据为止，这是主循环是否结束的判断；接着在每一次循环中先判断对应的"Indicator"是否是"Y"，如果是"Y"则执行两个操作：①新建一个sheet（名称是对应的"FolderName"），②需要组合读取对应的"FilePath"和"FolderName"和另一个独立的单元格"FileName"，这样就可以打开对应位置的文件执行后续的操作。</p> <p>举个例子，现在主循环是"Item"为"2"的这一行，“Indicator"是"Y”，所以需要完成两个操作：①新建sheet命名为"PE"，②把对应的"FilePath"和"FolderName"和独立的"FileName"组合变成地址"C:\User\Path2\PE\Information.text"，通过地址打开"Information.text"这个文件。</p> </li><li> <p>文件打开后每一行的格式是这样的：“S=1234|T=ABCD|N=Sample|Location=\Path”，需要按分隔符"|“切分每一列，使得全部数据都保存到对应的sheet（名称是对应的"FolderName”）中。每一行只需要直接根据每一行的分隔符判断是放入对应sheet的哪一列即可，无视连续的多个分隔符"|"。并且在切分完成后加入一个判断：如果切分结果中有某一行结果和其他行不一致，给出警告弹窗。完成以上操作后，记录操作的时间放入对应的"Time"中。</p> </li></ol> 
<hr> 
<h2><a id="_19"></a>代码描述</h2> 
<pre><code class="prism language-matlab">Sub <span class="token function">Run_Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    Dim wsRun As Worksheet
    Set wsRun <span class="token operator">=</span> ThisWorkbook<span class="token punctuation">.</span><span class="token function">Sheets</span><span class="token punctuation">(</span>"RunControl"<span class="token punctuation">)</span>
    
    Dim cell As Range
    Dim folderName As String<span class="token punctuation">,</span> filePath As String<span class="token punctuation">,</span> fileName As String
    Dim fullFilePath As String
    Dim newWs As Worksheet
    Dim lastRow As Long
    
    <span class="token operator">'</span> Turn off screen updating to reduce memory pressure
    Application<span class="token punctuation">.</span>ScreenUpdating <span class="token operator">=</span> False
    
    <span class="token operator">'</span> Get the value of the FileName named range
    fileName <span class="token operator">=</span> ThisWorkbook<span class="token punctuation">.</span><span class="token function">Names</span><span class="token punctuation">(</span>"FileName"<span class="token punctuation">)</span><span class="token punctuation">.</span>RefersToRange<span class="token punctuation">.</span>Value
    
    <span class="token operator">'</span> Get the last row of the Item named range
    lastRow <span class="token operator">=</span> wsRun<span class="token punctuation">.</span><span class="token function">Cells</span><span class="token punctuation">(</span>wsRun<span class="token punctuation">.</span>Rows<span class="token punctuation">.</span>Count<span class="token punctuation">,</span> wsRun<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span>"Item"<span class="token punctuation">)</span><span class="token punctuation">.</span>Column<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span>xlUp<span class="token punctuation">)</span><span class="token punctuation">.</span>Row

    For Each cell In wsRun<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span>"Item"<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Resize</span><span class="token punctuation">(</span>lastRow <span class="token operator">-</span> wsRun<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span>"Item"<span class="token punctuation">)</span><span class="token punctuation">.</span>Row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        If wsRun<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span>"Indicator"<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>cell<span class="token punctuation">.</span>Row <span class="token operator">-</span> wsRun<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span>"Item"<span class="token punctuation">)</span><span class="token punctuation">.</span>Row<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> "Y" Then
        
            folderName <span class="token operator">=</span> wsRun<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span>"FolderName"<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>cell<span class="token punctuation">.</span>Row <span class="token operator">-</span> wsRun<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span>"Item"<span class="token punctuation">)</span><span class="token punctuation">.</span>Row<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value
            filePath <span class="token operator">=</span> wsRun<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span>"FilePath"<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>cell<span class="token punctuation">.</span>Row <span class="token operator">-</span> wsRun<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span>"Item"<span class="token punctuation">)</span><span class="token punctuation">.</span>Row<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value

            <span class="token string">' Create a new sheet with the folder name if it doesn'</span>t exist
            On Error Resume Next <span class="token operator">'</span> Ignore the error <span class="token keyword">if</span> the sheet exists
            Set newWs <span class="token operator">=</span> ThisWorkbook<span class="token punctuation">.</span><span class="token function">Sheets</span><span class="token punctuation">(</span>folderName<span class="token punctuation">)</span>
            If newWs Is Nothing Then <span class="token operator">'</span> Only add a new sheet <span class="token keyword">if</span> it does not exist
                Set newWs <span class="token operator">=</span> ThisWorkbook<span class="token punctuation">.</span>Sheets<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>After<span class="token operator">:</span><span class="token operator">=</span>ThisWorkbook<span class="token punctuation">.</span><span class="token function">Sheets</span><span class="token punctuation">(</span>ThisWorkbook<span class="token punctuation">.</span>Sheets<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">)</span>
                newWs<span class="token punctuation">.</span>Name <span class="token operator">=</span> folderName
            Else 
            	newWs<span class="token punctuation">.</span>Cells<span class="token punctuation">.</span>Clear
            End If
            On Error GoTo <span class="token number">0</span> <span class="token operator">'</span> Stop ignoring errors

            <span class="token operator">'</span> Combine the FilePath<span class="token punctuation">,</span> FolderName and FileName
            fullFilePath <span class="token operator">=</span> filePath <span class="token operator">&amp;</span> "<span class="token operator">\</span>" <span class="token operator">&amp;</span> folderName <span class="token operator">&amp;</span> "<span class="token operator">\</span>" <span class="token operator">&amp;</span> fileName

            <span class="token operator">'</span> Open and read the file
            Dim expectedColumnCount As Integer<span class="token punctuation">,</span> currentColumnCount As Integer
		    Dim inconsistentData As Boolean
		    inconsistentData <span class="token operator">=</span> False
		    expectedColumnCount <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
		    
			<span class="token operator">'</span> Declare a variable <span class="token keyword">for</span> the file number
			Dim fileNum As Integer
			fileNum <span class="token operator">=</span> FreeFile
			
			<span class="token operator">'</span> Open the text file <span class="token keyword">for</span> reading
			Open fullFilePath For Input As #fileNum
			
			<span class="token operator">'</span> Read the entire file content into a string variable
			Dim fileContent As String
			fileContent <span class="token operator">=</span> Input$<span class="token punctuation">(</span><span class="token function">LOF</span><span class="token punctuation">(</span>fileNum<span class="token punctuation">)</span><span class="token punctuation">,</span> #fileNum<span class="token punctuation">)</span>
			
			<span class="token operator">'</span> Close the file
			Close #fileNum
			
			<span class="token operator">'</span> Split the file content into lines
			Dim <span class="token function">fileLines</span><span class="token punctuation">(</span><span class="token punctuation">)</span> As String
			fileLines <span class="token operator">=</span> <span class="token function">Split</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> vbCrLf<span class="token punctuation">)</span>
			
            For Each line In fileLines
                If <span class="token function">Trim</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">&gt;</span> "" Then <span class="token operator">'</span> Ignore empty lines
                    lineData <span class="token operator">=</span> <span class="token function">Split</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> "<span class="token operator">|</span>"<span class="token punctuation">)</span>
                    currentColumnCount <span class="token operator">=</span> <span class="token function">UBound</span><span class="token punctuation">(</span>lineData<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">'</span> The number of columns in the current row

                    <span class="token operator">'</span> Set the expected number of columns at the first line of data
                    If expectedColumnCount <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> Then
                        expectedColumnCount <span class="token operator">=</span> currentColumnCount
                    End If

                    <span class="token string">' If the number of columns in the current row doesn'</span>t match the expected number<span class="token punctuation">,</span> record the inconsistency
                    If currentColumnCount <span class="token operator">&lt;</span><span class="token operator">&gt;</span> expectedColumnCount Then
                        inconsistentData <span class="token operator">=</span> True
                        <span class="token string">' Exit For '</span> Do not <span class="token keyword">continue</span> processing the file<span class="token punctuation">,</span> exit the loop directly
                    End If

                    <span class="token operator">'</span> Fill the data into the appropriate position on the worksheet
                    With newWs
                        lastRow <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token function">Cells</span><span class="token punctuation">(</span><span class="token punctuation">.</span>Rows<span class="token punctuation">.</span>Count<span class="token punctuation">,</span> "A"<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span>xlUp<span class="token punctuation">)</span><span class="token punctuation">.</span>Row <span class="token operator">+</span> <span class="token number">1</span>
                        <span class="token operator">'</span> lastRow <span class="token operator">=</span> <span class="token number">1</span>
                        For colIndex <span class="token operator">=</span> <span class="token number">0</span> To <span class="token function">UBound</span><span class="token punctuation">(</span>lineData<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">Cells</span><span class="token punctuation">(</span>lastRow<span class="token punctuation">,</span> colIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token function">Trim</span><span class="token punctuation">(</span><span class="token function">Mid</span><span class="token punctuation">(</span><span class="token function">lineData</span><span class="token punctuation">(</span>colIndex<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">InStr</span><span class="token punctuation">(</span><span class="token function">lineData</span><span class="token punctuation">(</span>colIndex<span class="token punctuation">)</span><span class="token punctuation">,</span> "<span class="token operator">=</span>"<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        Next colIndex
                    End With
                End If
            Next line

            <span class="token operator">'</span> Check <span class="token keyword">for</span> inconsistent data
            If inconsistentData Then
                MsgBox "Please note<span class="token punctuation">,</span> extra delimiters have caused abnormal splitting<span class="token punctuation">!</span>"<span class="token punctuation">,</span> vbExclamation<span class="token punctuation">,</span> "Data Split Warning"
            End If

            <span class="token operator">'</span> Record the time of the operation
            wsRun<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span>"Time"<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>cell<span class="token punctuation">.</span>Row <span class="token operator">-</span> wsRun<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span>"Item"<span class="token punctuation">)</span><span class="token punctuation">.</span>Row<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			Set newWs <span class="token operator">=</span> Nothing
        End If
    Next cell
End Sub
</code></pre> 
<hr>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1b0913d0bdc4751977479ce5c0790db1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python keyword-only参数</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/42a58afba005e316b7bef412d80acfd3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java毕业设计-基于springboot开发的广场舞团系统-毕业论文&#43;答辩PPT（附源代码&#43;演示视频）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>