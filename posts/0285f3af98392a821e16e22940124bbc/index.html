<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring Boot 之 SpringSecurity、Shiro - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Spring Boot 之 SpringSecurity、Shiro" />
<meta property="og:description" content="文章目录 安全框架SpringSecurity特点配置请求拦截配置类常用方法 权限认证内存认证JDBC 认证LDAP用户存储 MyBatisUserServceSecurityConf 表单登录验证状态权限 shiro核心组件特点配置MyControllerRealmShiroConfigShiro 过滤器过滤器分类 常见shiro异常页面 安全框架 安全框架：对访问权限进行控制 安全性包括用户认证（Authentication）和用户授权（Authorization）两部分 用户认证：指验证某个用户是否为系统中的合法主体 即用户能否访问该系统一般要求用户提供用户名和密码，系统通过校验用户名和密码来完成认证过程 用户授权：指验证某个用户是否有权限执行某个操作 不同用户所具有的权限是不同的一般系统为不同的用户分配不同的角色，而每个角色则对应一系列的权限 SpringSecurity Spring Security：在架构上将认证与授权分离，并提供了扩展点 充分利用 Spring IoC（控制反转），DI（依赖注入）和 AOP（面向切面编程）功能为应用系统提供声明式的安全访问控制功能，减少了为系统安全控制编写大量重复代码的工作确保基于 Spring 的应用程序提供身份验证和授权支持与 Spring MVC 有很好地集成 ，并配备了流行的安全算法实现捆绑在一起 对 Web 资源进行保护，最好于 Filter；对方法调用进行保护，最好于 AOP Spring Security 在进行用户认证以及授予权限时通过各种各样的拦截器来控制权限的访问，从而实现安全 特点 Spring Security 对 Web 安全性的支持大量地依赖于 Servlet 过滤器 过滤器拦截进入请求，并且在应用程序处理该请求之前进行某些安全处理 Spring Security 提供有若干个过滤器，能够拦截 Servlet 请求 并将请求转给认证和访问决策管理器处理，从而增强安全性 根据需要使用适当的过滤器来保护自己的应用程序 要使用 Servlet 过滤器且令其正常工作必须在 web.xml 文件中使用 &lt;filter&gt; 和 &lt;filter-mapping&gt; 元素配置 但并不适用于使用依赖注入进行的配置 FilterToBeanProxy 是特殊的Servlet过滤器 将委托转发给 Spring 应用程序上下文中的一个 Bean 来完成 被委托的 Bean 几乎和 Servlet 过滤器一样 实现 javax." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/0285f3af98392a821e16e22940124bbc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-02T22:18:11+08:00" />
<meta property="article:modified_time" content="2022-11-02T22:18:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring Boot 之 SpringSecurity、Shiro</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">安全框架</a></li><li><ul><li><a href="#SpringSecurity_12" rel="nofollow">SpringSecurity</a></li><li><ul><li><a href="#_22" rel="nofollow">特点</a></li><li><a href="#_61" rel="nofollow">配置</a></li><li><ul><li><a href="#_87" rel="nofollow">请求拦截</a></li><li><ul><li><a href="#_89" rel="nofollow">配置类</a></li><li><a href="#_143" rel="nofollow">常用方法</a></li></ul> 
      </li><li><a href="#_171" rel="nofollow">权限认证</a></li><li><ul><li><a href="#_175" rel="nofollow">内存认证</a></li><li><a href="#JDBC__213" rel="nofollow">JDBC 认证</a></li><li><a href="#LDAP_256" rel="nofollow">LDAP用户存储</a></li></ul> 
      </li><li><a href="#MyBatis_290" rel="nofollow">MyBatis</a></li><li><ul><li><a href="#UserServce_299" rel="nofollow">UserServce</a></li><li><a href="#SecurityConf_343" rel="nofollow">SecurityConf</a></li></ul> 
      </li><li><a href="#_372" rel="nofollow">表单登录</a></li><li><a href="#_387" rel="nofollow">验证状态权限</a></li></ul> 
    </li></ul> 
    </li><li><a href="#shiro_411" rel="nofollow">shiro</a></li><li><ul><li><a href="#_421" rel="nofollow">核心组件</a></li><li><a href="#_469" rel="nofollow">特点</a></li><li><a href="#_480" rel="nofollow">配置</a></li><li><ul><li><a href="#MyController_506" rel="nofollow">MyController</a></li><li><a href="#Realm_547" rel="nofollow">Realm</a></li><li><a href="#ShiroConfig_598" rel="nofollow">ShiroConfig</a></li><li><a href="#Shiro__670" rel="nofollow">Shiro 过滤器</a></li><li><ul><li><a href="#_681" rel="nofollow">过滤器分类</a></li></ul> 
      </li><li><a href="#shiro_698" rel="nofollow">常见shiro异常</a></li><li><a href="#_721" rel="nofollow">页面</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>安全框架</h3> 
<ul><li>安全框架：对访问权限进行控制 
  <ul><li>安全性包括用户认证（Authentication）和用户授权（Authorization）两部分</li></ul> </li><li>用户认证：指验证某个用户是否为系统中的合法主体 
  <ul><li>即用户能否访问该系统</li><li>一般要求用户提供用户名和密码，系统通过校验用户名和密码来完成认证过程</li></ul> </li><li>用户授权：指验证某个用户是否有权限执行某个操作 
  <ul><li>不同用户所具有的权限是不同的</li><li>一般系统为不同的用户分配不同的角色，而每个角色则对应一系列的权限</li></ul> </li></ul> 
<h4><a id="SpringSecurity_12"></a>SpringSecurity</h4> 
<ul><li><code>Spring Security</code>：在架构上将认证与授权分离，并提供了扩展点 
  <ul><li>充分利用 <code>Spring IoC</code>（控制反转），<code>DI</code>（依赖注入）和 <code>AOP</code>（面向切面编程）功能</li><li>为应用系统提供声明式的安全访问控制功能，减少了为系统安全控制编写大量重复代码的工作</li><li>确保基于 <code>Spring</code> 的应用程序提供身份验证和授权支持</li><li>与 <code>Spring MVC</code> 有很好地集成 ，并配备了流行的安全算法实现捆绑在一起</li></ul> </li><li>对 Web 资源进行保护，最好于 <code>Filter</code>；对方法调用进行保护，最好于 <code>AOP</code> 
  <ul><li><code>Spring Security</code> 在进行用户认证以及授予权限时通过各种各样的拦截器来控制权限的访问，从而实现安全</li></ul> </li></ul> 
<h5><a id="_22"></a>特点</h5> 
<ul><li><code>Spring Security</code> 对 <code>Web</code> 安全性的支持大量地依赖于 <code>Servlet</code> 过滤器 
  <ul><li>过滤器拦截进入请求，并且在应用程序处理该请求之前进行某些安全处理 
    <ul><li><code>Spring Security</code> 提供有若干个过滤器，能够拦截 <code>Servlet</code> 请求 
      <ul><li>并将请求转给认证和访问决策管理器处理，从而增强安全性</li></ul> </li><li>根据需要使用适当的过滤器来保护自己的应用程序</li></ul> </li><li>要使用 <code>Servlet</code> 过滤器且令其正常工作必须在 <code>web.xml</code> 文件中使用 <code>&lt;filter&gt;</code> 和 <code>&lt;filter-mapping&gt;</code> 元素配置 
    <ul><li>但并不适用于使用依赖注入进行的配置</li></ul> </li></ul> </li><li><code>FilterToBeanProxy</code> 是特殊的Servlet过滤器 
  <ul><li>将委托转发给 <code>Spring</code> 应用程序上下文中的一个 <code>Bean</code> 来完成 
    <ul><li>被委托的 <code>Bean</code> 几乎和 <code>Servlet</code> 过滤器一样 
      <ul><li>实现 <code>javax.servlet.Filter</code> 接口</li></ul> </li><li>但在 <code>Spring</code> 配置文件非 <code>web.xml</code> 文件中配置</li></ul> </li><li><code>FilterToBeanProxy</code> 代理给的 <code>Bean</code> 可以是 <code>javax.servlet.Filter</code> 的任意实现 
    <ul><li>可以是 <code>Spring Security</code> 的任何过滤器 
      <ul><li>或自己创建的一个过滤器</li></ul> </li><li>但是 <code>Spring Security</code> 要求至少配置四个而且可能一打或者更多的过滤器</li></ul> </li></ul> </li><li>除了<strong>不能脱离Spring</strong>，<code>shiro</code> 的功能都有 
  <ul><li>且 <code>Spring Security</code> 对 <code>Oauth</code>、<code>OpenID</code> 也有支持 
    <ul><li>Shiro 则需要手动实现</li><li>现租户与各个产品间单点登录已经通过 cookies 实现 
      <ul><li>Spring Security的这两个功能可以不考虑。</li></ul> </li></ul> </li><li>Spring Security 的权限细粒度更高</li></ul> </li></ul> 
<p>注：</p> 
<ul><li>OAuth 在客户端与服务提供商之间，设置了一个授权层（authorization layer） 
  <ul><li>客户端不能直接登录服务提供商，只能登录授权层，将用户与客户端区分开</li><li>客户端登录授权层所用的令牌（token），与用户的密码不同 
    <ul><li>用户可在登录的时候指定授权层令牌的权限范围和有效期</li></ul> </li><li>客户端登录授权层 
    <ul><li>服务提供商根据令牌的权限范围和有效期向客户端开放用户储存的资料</li></ul> </li></ul> </li><li>OpenID 系统的第一部分是身份验证 
  <ul><li>即通过 URI 来认证用户身份 
    <ul><li>目前的网站依靠用户名和密码来登录认证</li></ul> </li><li>使用 OpenID ，网站地址（URI）就是用户名 
    <ul><li>密码安全的存储在一个 OpenID 服务网站上</li></ul> </li></ul> </li></ul> 
<h5><a id="_61"></a>配置</h5> 
<ul><li> <p>添加相应依赖信息：包括 Thymeleaf 整合 security 依赖</p> 
  <ul><li> <pre><code class="prism language-xml"><span class="token comment">&lt;!-- 其他需要依赖信息略：包括数据库依赖 ---&gt;</span>
<span class="token comment">&lt;!-- security --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--  模板支持安全框架 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.thymeleaf.extras<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>thymeleaf-extras-springsecurity5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li></ul> </li></ul> 
<ol><li>导入 Spring Security 依赖</li><li>创建配置类继承 <code>WebSecurityConfigurerAdapter</code> 
  <ul><li>重写方法完成认证与授权</li><li><code>WebSecurityConfigurerAdapter</code>：自定义 Security 策略</li><li><code>AuthenticationManagerBuilder</code>：自定义认证策略</li><li><code>@EnableWebSecurity</code>：开启 WebSecurity 模式</li></ul> </li><li>在 页面中添加相应请求或方法验证权限</li></ol> 
<h6><a id="_87"></a>请求拦截</h6> 
<h6><a id="_89"></a>配置类</h6> 
<ul><li>配置需要成对出现，并且配置的顺序也很重要 
  <ul><li><strong>声明在前面的规则拥有更高的优先级</strong></li></ul> </li></ul> 
<pre><code class="prism language-java"><span class="token comment">// AOP 实现</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConf</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 请求授权</span>
    <span class="token annotation punctuation">@Override</span> 
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 链式编写：不同模块使用 and() 连接，也可以分开写</span>
        <span class="token comment">// 对请求授权 </span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			
            	<span class="token comment">// 不需要通过登录验证就可以被访问的资源路径</span>
            	<span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">"/index"</span><span class="token punctuation">,</span> <span class="token string">"/toLogin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            	<span class="token comment">// 需要对应权限、角色访问</span>
            	<span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/level1/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"vip1"</span><span class="token punctuation">)</span>
            	<span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/level2/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"vip2"</span><span class="token punctuation">)</span>
            	<span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/level3/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"vip3"</span><span class="token punctuation">)</span>
            	<span class="token comment">// 上面的任何请求都必须经过身份验证</span>
            	<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 表单登录，用户未登录时，访问任何资源都转跳到该路径，即登录页面</span>
		http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            	<span class="token comment">// 登录页面，设置为自定义的登录页面</span>
            	<span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/toLogin"</span><span class="token punctuation">)</span>
            	<span class="token comment">// 登录表单中 action 的地址，即实际处理认证请求的路径</span>
            	<span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
            	<span class="token comment">// 获取用户名输入框参数：默认 username</span>
            	<span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
            	<span class="token comment">// 获取密码输入框参数：默认 password</span>
            	<span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>
            	<span class="token comment">// 登录认证成功后默认转跳的路径，登陆失败后返回原页面</span>
            	<span class="token punctuation">.</span><span class="token function">successForwardUrl</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">failureForwardUrl</span><span class="token punctuation">(</span><span class="token string">"/toLogin"</span><span class="token punctuation">)</span>
            	<span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment">// 注销</span>
		http<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            	<span class="token comment">// 登出成功后返回的请求</span>
           		<span class="token punctuation">.</span><span class="token function">logoutSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
            	<span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment">// 关闭 csrf 功能：跨站请求伪造，默认只能通过 post 方式提交请求</span>
         http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 记住我功能，使用 Cookie 缓存，默认有效期14天</span>
            <span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rememberMeParameter</span><span class="token punctuation">(</span><span class="token string">"remember"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><code>?</code>：匹配任何单字符</li><li><code>*</code>：匹配 0 或者任意数量的字符</li><li><code>**</code>：匹配 0 或更多目录</li></ul> 
<h6><a id="_143"></a>常用方法</h6> 
<ul><li><code>permitAll()</code>：允许任何访问</li><li><code>denyAll()</code>：拒绝所有访问</li><li><code>anonymous()</code>：允许匿名用户访问</li><li><code>authenticated()</code>：允许认证的用户进行访问</li><li><code>hasRole(String)</code> ： 
  <ul><li>用户具备给定角色、用户组 允许访问</li></ul> </li><li><code>hasAnyRole(String…)</code> ： 
  <ul><li>用户具有给定角色、用户组 中的一个允许访问</li></ul> </li><li><code>hasAuthority(String)</code>： 
  <ul><li>用户具备给定权限允许访问</li></ul> </li><li><code>hasAnyAuthority(String…)</code> ： 
  <ul><li>用户具备给定权限中的某一个允许访问</li></ul> </li><li><code>principal</code>： 
  <ul><li>允许直接访问代表当前用户的主体对象</li></ul> </li><li><code>rememberMe()</code> ： 
  <ul><li>用户是通过<code>Remember-me</code>功能认证允许访问</li></ul> </li><li><code>fullyAuthenticated()</code>： 
  <ul><li>如果用户是完整认证允许访问</li><li>不是通过Remember-me功能认证的</li></ul> </li><li><code>hasIpAddress(String)</code>： 
  <ul><li>请求来自给定ip地址允许访问</li></ul> </li><li><code>isAnonymous()</code>：当前委托人是否为匿名用户</li><li><code>isRememberMe()</code>：当前主体是否是“记住我”的用户</li><li><code>not()</code> ：对其他访问结果求反</li><li></ul> 
<h6><a id="_171"></a>权限认证</h6> 
<ul><li>权限认证和授权在同一配置类中</li></ul> 
<h6><a id="_175"></a>内存认证</h6> 
<ul><li><code>AuthenticationManagerBuilder</code>：使用构造者方式来构建 
  <ul><li>先调用 <code>inMemoryAuthentication()</code> 
    <ul><li>指定用户存储在内存中</li></ul> </li><li>调用了 <code>passwordEncoder()</code> 
    <ul><li>指定认证密码的加密方式</li><li>在<code>Spring security5</code>后，必须指定加密方式，不然程序会报错</li></ul> </li><li>调用的 <code>withUser()、password()、authorities()</code> 
    <ul><li>指定用户的账号、密码以及权限名</li><li>添加完一个用户后，使用 <code>and()</code> 方法来连接下一个用户的添加</li></ul> </li></ul> </li><li>这种配置在修改用户时必须修改代码 
  <ul><li>甚至无法注册</li></ul> </li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConf</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 权限认证</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 在内存里面存储用户的身份认证和授权信息</span>
        auth<span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	
            <span class="token comment">// 添加用户权限：用户名、密码（加密）、角色信息    </span>
            <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"vip1"</span><span class="token punctuation">)</span>
            <span class="token comment">// 添加多个用户使用 and()</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"vip1"</span><span class="token punctuation">,</span> <span class="token string">"vip2"</span><span class="token punctuation">,</span> <span class="token string">"vip3"</span><span class="token punctuation">)</span>
            <span class="token comment">// 配置BCrypt加密</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

    <span class="token comment">// 加密对象，密码需要加密才能安全保存</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="JDBC__213"></a>JDBC 认证</h6> 
<ul><li>将用户信息存储在数据库中 
  <ul><li>方便对用户信息进行增删改查</li><li>还可以添加除认证信息外的附加信息</li></ul> </li><li>调用 <code>jdbcAuthentication()</code> 
  <ul><li>指定使用 <code>jdbc</code> 的方式来查询用户和权限</li></ul> </li><li><code>dataSource()</code>：指定数据库连接信息</li><li><code>passwordEncoder()</code>：指定密码加密规则 
  <ul><li>用户的密码数据应该以同样的方式进行加密存储 
    <ul><li>否则两个加密方式不同无法匹配</li></ul> </li></ul> </li><li><code>usersByUsernameQuery()</code>、<code>authoritiesByUsernameQuery()</code> 
  <ul><li>定义了查询用户和权限信息的 sql 语句</li><li><code>Spring security</code> 默认了查询用户、权限甚至还有群组用户授权的sql 
    <ul><li>三条默认的 sql 存放在 <code>org......userdetails.jdbc.JdbcDaoImpl</code> 中</li><li>使用默认的，那表中关键性的字段必须和语句中的一致</li></ul> </li></ul> </li></ul> 
<pre><code class="prism language-java"><span class="token comment">// 自动装配数据源对象</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 使用 JDBC 存储身份认证信息</span>
    auth<span class="token punctuation">.</span><span class="token function">jdbcAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 传入数据源</span>
        <span class="token punctuation">.</span><span class="token function">dataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span>
        <span class="token comment">// 指定密码加密方式</span>
        <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// 根据用户名获取用户信息</span>
        <span class="token punctuation">.</span><span class="token function">usersByUsernameQuery</span><span class="token punctuation">(</span><span class="token string">"select username, password, status from Users where username = ?"</span><span class="token punctuation">)</span>
        <span class="token comment">// 根据用户名获取认证权限</span>
        <span class="token punctuation">.</span><span class="token function">authoritiesByUsernameQuery</span><span class="token punctuation">(</span><span class="token string">"select username, authority from Authority where username = ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//定义加密对象</span>
<span class="token annotation punctuation">@Bean</span>  
<span class="token keyword">private</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="LDAP_256"></a>LDAP用户存储</h6> 
<ul><li><code>LDAP</code>：轻型目录访问协议，一个开放的，中立的，工业标准的应用协议 
  <ul><li>通过IP协议提供访问控制和维护分布式信息的目录信息</li><li>即：将用户信息存放在另外一台服务器中</li></ul> </li><li><code>userSearchFilter()</code>、<code>groupSearchFilter()</code> 
  <ul><li>设置用户和群组的过滤条件</li></ul> </li><li><code>userSearchBase()</code>、<code>groupSearchBase()</code> 
  <ul><li>设置了搜索起始位置</li></ul> </li><li><code>contextSource().url()</code>： 
  <ul><li>设置<code>LDAP</code>服务器的地址</li></ul> </li><li>没有远程的服务器可以使用 <code>contextSource().root()</code> 使用嵌入式 <code>LDAP</code> 服务器 
  <ul><li>将使用项目中的用户数据文件来提供认证服务</li></ul> </li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">LdapAuthenticationProviderConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthenticationManagerBuilder</span><span class="token punctuation">&gt;</span></span> configurer <span class="token operator">=</span>                     auth<span class="token punctuation">.</span><span class="token function">ldapAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">userSearchBase</span><span class="token punctuation">(</span><span class="token string">"ou=people"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">userSearchFilter</span><span class="token punctuation">(</span><span class="token string">"(uid={0})"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">groupSearchBase</span><span class="token punctuation">(</span><span class="token string">"ou=groups"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">groupSearchFilter</span><span class="token punctuation">(</span><span class="token string">"member={0}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    configurer<span class="token punctuation">.</span><span class="token function">passwordCompare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">passwordAttribute</span><span class="token punctuation">(</span><span class="token string">"passcode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    configurer<span class="token punctuation">.</span><span class="token function">contextSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"ldap://xxxxx.com:33389/dc=xxxxxx,dc=com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="MyBatis_290"></a>MyBatis</h6> 
<p>自定义认证方式：<strong>不仅限于 MyBatis 使用</strong></p> 
<ul><li>自行使用认证名称来查找对应的用户数据 
  <ul><li>然后交给 Spring Security 使用</li></ul> </li><li>需要定义一个实现 <code>UserDetailsService</code> 的 <code>service</code> 类 
  <ul><li>得到用户对象</li></ul> </li></ul> 
<h6><a id="UserServce_299"></a>UserServce</h6> 
<ul><li>只需要实现一个方法：<code>loadUserByUsername()</code> 
  <ul><li>使用传过来的 <code>username</code> 来匹配带有密码等信息的用户实体 
    <ul><li><code>User </code>类需要实现 <code>UserDetails</code></li><li>这是 Security 中的 user 类，而非自定义 User 类</li></ul> </li><li>即：查到的信息里必须得有 <code>Spring Security</code> 所需要的信息</li></ul> </li><li>类中可以注入 mapper 等等查用户 
  <ul><li>如果查不到，留在这个页面</li><li>如果查到了，做出一定逻辑（例如判空等等） 
    <ul><li>把用户信息封装到 <code>Spring Security</code> 的 <code>User</code>类中 
      <ul><li>区分自定义自定义 <code>User</code> 和 <code>Spring Security</code> 的 <code>User</code></li></ul> </li><li><code>Spring Security</code> 拿前台的数据比较，做出操作 
      <ul><li>例如：认证成功或者错误</li></ul> </li></ul> </li></ul> </li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"userDao"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserDao</span> userDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">"用户名不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取用户对象</span>
        <span class="token class-name"><span class="token namespace">security<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span>User</span> user <span class="token operator">=</span> userDao<span class="token punctuation">.</span><span class="token function">getUserByName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorityList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 得到用户权限</span>
        <span class="token class-name">String</span> role <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 权限不为空放到到 List 集合中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>role <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            authorityList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span>role<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 封装到框架的 USer 类中并提交</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>authorityList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h6><a id="SecurityConf_343"></a>SecurityConf</h6> 
<ul><li>指定 <code>Spring Security</code> 自定义的 <code>UserDetailsService</code> 实现类 
  <ul><li>会自动去调用 <code>loadUserByUsername()</code> 来查找用户</li><li>用户的密码和提交密码加密方式要相同 
    <ul><li>否则两个加密方式不同无法匹配</li></ul> </li></ul> </li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyUserDetailsService</span> userDetailsService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span>
            <span class="token comment">//密码加密方式和数据库密码加密方式要相同</span>
            <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">private</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="_372"></a>表单登录</h6> 
<pre><code class="prism language-html"><span class="token comment">&lt;!-- action 请求和 loginProcessingUrl 保持一致--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@{/login}<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 用户名输入框 name 属性对应 usernameParameter() --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Username<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 密码输入框 name 属性对应 passwordParameter() --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PassWord<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 保存账号按钮 name 属性对应 rememberMeParameter() --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ui checkbox bordered<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>保存账号密码
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>提交<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h6><a id="_387"></a>验证状态权限</h6> 
<ul><li> <p>整合 Thymeleaf 模板使用</p> </li><li> <p>命名空间</p> <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.thymeleaf.org<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>sec</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.thymeleaf.org/extras/spring-security<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> </li></ul> 
<pre><code class="prism language-html"><span class="token comment">&lt;!-- 判读未登录时进行操作 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">sec:</span>authorize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>!isAuthenticated()<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>  
<span class="token comment">&lt;!-- 判断已登录时进行操作 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">sec:</span>authorize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>isAuthenticated()<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>   
<span class="token comment">&lt;!-- 当前用户有其中任一角色时进行操作 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">sec:</span>authorize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hasAnyRole(<span class="token punctuation">'</span>vip1<span class="token punctuation">'</span>,<span class="token punctuation">'</span>vip2<span class="token punctuation">'</span>,<span class="token punctuation">'</span>vip3<span class="token punctuation">'</span>)<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>  
<span class="token comment">&lt;!-- 当前用户有这个角色时进行操作 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">sec:</span>authorize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hasRole(<span class="token punctuation">'</span>vip1<span class="token punctuation">'</span>)<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>     
<span class="token comment">&lt;!-- 显示当前账号所有角色 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">sec:</span>authentication</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>principal.authorities<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  
</code></pre> 
<h4><a id="shiro_411"></a>shiro</h4> 
<ul><li><code>Apache Shiro</code>：一个强大且易用的 Java 安全框架 
  <ul><li>能够非常清晰的处理身份验证、授权、管理会话以及密码加密</li></ul> </li><li>利用其易于理解的 API，可以快速、轻松地获得任何应用程序 
  <ul><li>从最小的移动应用程序到最大的网络和企业应用程序</li></ul> </li><li>Shiro：主要分为两个部分：认证和授权 
  <ul><li>Shiro 只是一个框架而已，内容需要自己去构建</li><li>前后是自己的，中间是 Shiro 去搭建和配置好的</li></ul> </li></ul> 
<h5><a id="_421"></a>核心组件</h5> 
<ul><li>三个核心组件：<code>Subject</code>、 <code>SecurityManager</code> 和 <code>Realms</code></li><li><code>Subject</code>：当前操作用户 
  <ul><li>在 <code>Shiro</code> 中，<code>Subject</code> 并不仅仅指人 
    <ul><li>也可以是第三方进程、后台帐户（Daemon Account）或其他类似事物</li><li>仅仅意味着当前跟软件交互的东西</li></ul> </li><li><code>Subject</code> 代表当前用户的安全操作，<code>SecurityManager</code> 则管理所有用户的安全操作</li></ul> </li><li><code>SecurityManager</code>：<code>Shiro</code> 框架的核心，典型的 <code>Facade</code> 模式 
  <ul><li>通过 <code>SecurityManager</code> 来管理内部组件实例，并提供安全管理的各种服务</li></ul> </li><li><code>Realm</code>：充当<code> Shiro</code> 与应用安全数据间的 桥梁 或 连接器 
  <ul><li>当对用户执行认证（登录）和授权（访问控制）验证</li><li><code>Shiro</code> 从应用配置的 <code>Realm</code> 中查找用户及其权限信息 
    <ul><li><code>Realm</code> 实质上是安全相关的 <code>DAO</code> 
      <ul><li>封装了数据源的连接细节，并在需要时将相关数据提供给 <code>Shiro</code></li></ul> </li><li>当配置 <code>Shiro</code> 时，必须至少指定一个 <code>Realm</code>，用于认证和（或）授权 
      <ul><li>配置多个 <code>Realm</code> 是可以的，但至少需要一个</li></ul> </li></ul> </li><li><code>Shiro</code> 内置了可连接大量安全数据源（又名目录）的 <code>Realm</code> 
    <ul><li>如 <code>LDAP</code>、关系数据库（<code>JDBC</code>）、类似 <code>INI</code> 的文本配置资源以及属性文件等</li><li>若缺省的 <code>Realm</code> 不能满足需求，可以插入代表自定义数据源的 <code>Realm</code> 实现</li></ul> </li></ul> </li></ul> 
<p>组件</p> 
<ul><li><code>UsernamePasswordToken</code>： 
  <ul><li><code>Shiro</code> 用来封装用户登录信息，使用用户的登录信息创建令牌 <code>Token</code></li><li>登录的过程即 <code>Shiro</code> 验证令牌是否具有合法身份以及相关权限</li></ul> </li><li><code>AuthenticationInfo</code>：用户的角色信息集合，认证时使用</li><li><code>AuthorizationInfo</code>，角色的权限信息集合，授权时使用</li><li><code>DefaultWebSecurityManager</code>：安全管理器 
  <ul><li>自定义的 <code>Realm</code> 需要注入到 <code>DefaultWebSecurityManager</code> 进行管理才能生效</li></ul> </li><li><code>ShiroFilterFactoryBean</code>：过滤器工厂 
  <ul><li><code>Shiro</code> 的基本运行机制是开发者定制规则，Shiro 去执行</li><li>即 <code>ShiroFilterFactoryBean</code> 创建 <code>Filter</code> 对象来完成</li></ul> </li></ul> 
<p>功能模块</p> 
<ul><li><code>Session Manager</code>：会话管理，用户登录后的session相关管理</li><li><code>Cryptography</code>：加密，密码加密等</li><li><code>Web Support</code>：Web支持，集成Web环境</li><li><code>Caching</code>：缓存，用户信息、角色、权限等缓存到如redis等缓存中</li><li><code>Concurrency</code>：多线程并发验证，在一个线程中开启另一个线程，可以把权限自动传播过去</li><li><code>Testing</code>：测试支持</li><li><code>Run As</code>：允许一个用户假装为另一个用户（如果他们允许）的身份进行访问</li><li><code>Remember Me</code>：记住我</li></ul> 
<p><img src="https://images2.imgbox.com/68/88/9ZKKoF9h_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_469"></a>特点</h5> 
<ul><li>易于理解的 <code>Java Security API</code></li><li>简单的身份认证（登录），支持多种数据源（LDAP，JDBC，Kerberos，ActiveDirectory 等）</li><li>对角色的简单的签权（访问控制），支持细粒度的签权</li><li>支持一级缓存，以提升应用程序的性能</li><li>内置的基于 POJO 企业会话管理，适用于 Web 以及非 Web 的环境</li><li>异构客户端会话访问</li><li>非常简单的加密 API</li><li>不跟任何的框架或者容器捆绑，可以独立运行</li></ul> 
<h5><a id="_480"></a>配置</h5> 
<ul><li>添加依赖信息：包括模板支持、shiro、日志 以及数据库等其他依赖</li></ul> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- thymeleaf 整合 shiro --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.theborakompanioni<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>thymeleaf-extras-shiro<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- shiro --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shiro<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shiro-spring-boot-web-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 日志 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.logging.log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j-to-slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h6><a id="MyController_506"></a>MyController</h6> 
<pre><code class="prism language-java"><span class="token comment">//仅有部分相关方法</span>

<span class="token comment">// 要登录请求处理：跳转到登录页面</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/toLogin"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"login"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 登录处理</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取当前用户 subject 对象</span>
    <span class="token class-name">Subject</span> subject <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用传进来的用户名、密码创建令牌</span>
    <span class="token class-name">UsernamePasswordToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 执行登录操作：由框架进行处理</span>
        <span class="token comment">// 认证、授权在 realm 中</span>
        <span class="token comment">// 拦截规则在过滤器中定义</span>
        subject<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"index"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnknownAccountException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 拦截异常情况</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"用户名不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"login"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IncorrectCredentialsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"密码错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"login"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token comment">// 认证异常请求处理</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/unauthorized"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">unauthorized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"未获得权限，无法访问"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="Realm_547"></a>Realm</h6> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRealm</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizingRealm</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 注入对象从数据库中查找用户信息</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserDao</span> userDao<span class="token punctuation">;</span>
    
    <span class="token comment">// 授权</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">AuthorizationInfo</span> <span class="token function">doGetAuthorizationInfo</span><span class="token punctuation">(</span><span class="token class-name">PrincipalCollection</span> principalCollection<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SimpleAuthorizationInfo</span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAuthorizationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 得到认证时传入的用户对象（或用户名、id 等对象）</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span>principalCollection<span class="token punctuation">.</span><span class="token function">getPrimaryPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 或得到 Subject 当前用户对象</span>
		<span class="token comment">// Subject subject = SecurityUtils.getSubject();</span>
        <span class="token comment">// 转为自定义的 User 对象</span>
        <span class="token comment">// User user = (User)subject.getPrincipal();</span>
        
        <span class="token comment">// 硬授权：所有进入的用户都会授权 user:add</span>
		<span class="token comment">// info.addStringPermission("user:add");</span>
        
        <span class="token comment">// 获取用户角色信息并添加角色（或使用授权）</span>
        info<span class="token punctuation">.</span><span class="token function">addRole</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> info<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 认证</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">AuthenticationInfo</span> <span class="token function">doGetAuthenticationInfo</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationToken</span> authenticationToken<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 得到传进来的用户名</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> authenticationToken<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过用户名查询用户</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userDao<span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果用户为 null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 不正确时直接返回 null，会自动捕捉异常</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
		<span class="token comment">// 传入用户对象、密码、自定义 Realm 类名传进去由框架自动匹配</span>
        <span class="token keyword">return</span>  <span class="token keyword">new</span> <span class="token class-name">SimpleAuthenticationInfo</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 
        第一个参数可以是用户对象、用户名、用户id 等
        可以在授权时获取此时传入的信息，密码会由框架自动匹配
        */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="ShiroConfig_598"></a>ShiroConfig</h6> 
<ul><li>将 <code>CustomRealm</code> 和 <code>SecurityManager</code> 等注入到 <code>spring</code> 容器</li><li>自动装配 3 个 bean 实例 
  <ol><li>自定义过滤器 <code>MyRealm</code> 
    <ul><li>业务逻辑全部定义在这个 bean 中</li></ul> </li><li><code>DefaultWebSecurityManager</code> 
    <ul><li>将 <code>MyRealm</code> 注入到 <code>DefaultWebSecurityManager</code> 完成注册</li></ul> </li><li><code>ShiroFilterFactoryBean</code> 
    <ul><li>Shiro 自带的一个 <code>Filter</code> 工厂实例</li><li>所有的认证和授权判断都是由这个 bean 生成的 Filter 对象来完成的</li></ul> </li></ol> </li><li>Shiro 框架的运行机制 
  <ul><li>开发者只需要定义规则，进行配置</li><li>具体的执行者全部由 Shiro 自己创建的 Filter 来完成</li></ul> </li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShiroCong</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// Realm 对象，将自定义验证方式加入容器</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">UserRealm</span> <span class="token function">userRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// DefaultWebSecurityManager: 安全管理器</span>
    <span class="token comment">// 权限管理，配置主要是 Realm 的管理认证</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DefaultWebSecurityManager</span> <span class="token function">securityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 关联 Realm 对象</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultWebSecurityManager</span><span class="token punctuation">(</span><span class="token function">userRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ShiroFilterFactoryBean:过滤器对象</span>
    <span class="token comment">// Filter 工厂，设置对应的过滤条件和跳转条件</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ShiroFilterFactoryBean</span> <span class="token function">shiroFilterFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ShiroFilterFactoryBean</span> bean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShiroFilterFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关联 SecurityManager 对象</span>
        bean<span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span><span class="token function">securityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 使用 LinkHashMap 存放路径拦截规则，有序：先配置先生效</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> filterMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 默认无法配置多角色访问同一权限，需要自定义修改 shiro 过滤器配置</span>
        <span class="token comment">// 授权: 有 add 角色才能访问 add 请求</span>
        filterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"/user/add"</span><span class="token punctuation">,</span> <span class="token string">"roles[add]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 授权：必须有 user:update 权限才能访问 update</span>
        filterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"/user/update"</span><span class="token punctuation">,</span> <span class="token string">"perms[user:update]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 拦截: 对 user下资源必须登陆后才能访问</span>
        filterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"/user/**"</span><span class="token punctuation">,</span> <span class="token string">"authc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 登出</span>
        filterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">,</span> <span class="token string">"logout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对所有用户认证必须登录后访问</span>
        filterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">,</span> <span class="token string">"authc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将设置了请求权限的 Map 集合放到 过滤器对象中</span>
        bean<span class="token punctuation">.</span><span class="token function">setFilterChainDefinitionMap</span><span class="token punctuation">(</span>filterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 未登录跳转到登录页</span>
        bean<span class="token punctuation">.</span><span class="token function">setLoginUrl</span><span class="token punctuation">(</span><span class="token string">"/toLogin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 登陆成功请求；跳转首页</span>
        bean<span class="token punctuation">.</span><span class="token function">setSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 认证异常请求处理：权限不足</span>
        bean<span class="token punctuation">.</span><span class="token function">setUnauthorizedUrl</span><span class="token punctuation">(</span><span class="token string">"/unauthorized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 配置 ShiroDialect 方言标签整合 Thymeleaf</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ShiroDialect</span> <span class="token function">shiroDialect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ShiroDialect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="Shiro__670"></a>Shiro 过滤器</h6> 
<p>自定义 Shiro 过滤器</p> 
<ul><li>对 URL 进行拦截 
  <ul><li>没有认证的需要认证</li><li>认证成功的则可以根据需要判断角色及权限</li></ul> </li><li>过滤器需要自定义 
  <ul><li>然后指定认证和授权的逻辑</li><li>继承抽象类 <code>AuthorizingRealm</code>，实现两个抽象方法分别完成授权和认证的逻辑</li></ul> </li></ul> 
<h6><a id="_681"></a>过滤器分类</h6> 
<ul><li>认证过滤器 
  <ul><li><code>anon</code>：无需认证即可访问，游客身份</li><li><code>authc</code>：必须认证、登录 才能访问</li><li><code>authcBasic</code>：需要通过 httpBasic 认证</li><li><code>user</code>：不一定已通过认证 
    <ul><li>只要曾经被 Shiro 记录登录状态的用户就可以正常发起请求</li><li>比如 <code>rememberMe</code></li></ul> </li></ul> </li><li>授权过滤器 
  <ul><li><code>perms</code>：必须拥有对某个资源的访问权限（授权）才能访问</li><li><code>role</code>：必须拥有某个角色权限才能访问</li><li><code>port</code>：请求的端口必须为指定值才可以访问</li><li><code>rest</code>：请求必须是 RESTful 
    <ul><li>method 为 post、get、delete、put</li></ul> </li><li><code>ssl</code>：必须是安全的 URL 请求，协议为 HTTPS</li></ul> </li></ul> 
<h6><a id="shiro_698"></a>常见shiro异常</h6> 
<ul><li><code>AuthenticationException</code>：认证异常 
  <ul><li><code>Shiro</code> 在登录认证过程中，认证失败需要抛出的异常 
    <ul><li>包含以下子类</li></ul> </li><li><code>CredentitalsException</code>：凭证异常 
    <ul><li><code>IncorrectCredentialsException</code>：不正确的凭证</li><li><code>ExpiredCredentialsException</code>：凭证过期</li></ul> </li><li><code>AccountException</code>：账号异常 
    <ul><li><code>ConcurrentAccessException</code>：并发访问异常，多个用户同时登录时抛出</li><li><code>UnknownAccountException</code>：未知的账号</li><li><code>ExcessiveAttemptsException</code>：认证次数超过限制</li><li><code>DisabledAccountException</code>： 禁用的账号</li><li><code>LockedAccountException</code>：账号被锁定</li><li><code>UnsupportedTokenException</code>：使用了不支持的Token</li></ul> </li></ul> </li><li><code>AuthorizationException</code>: 授权异常 
  <ul><li><code>Shiro</code>在登录认证过程中，授权失败需要抛出的异常 
    <ul><li>包含以下子类</li></ul> </li><li><code>UnauthorizedException</code> 
    <ul><li>抛出以指示请求的操作或对请求的资源的访问是不允许的</li></ul> </li><li><code>UnanthenticatedException</code> 
    <ul><li>当尚未完成成功认证时，尝试执行授权操作时引发异常</li></ul> </li></ul> </li></ul> 
<h6><a id="_721"></a>页面</h6> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/1999/xhtml<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Thymeleaf<span class="token punctuation">"</span></span>
      <span class="token attr-name"><span class="token namespace">xmlns:</span>shiro</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.pollix.at/thymeleaf/shiro<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Insert title here<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>index<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 验证当前用户是否为“访客”，即未认证（包含未记住）的用户。 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name"><span class="token namespace">shiro:</span>guest</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Please <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>login.html<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 认证通过或已记住的用户。 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name"><span class="token namespace">shiro:</span>user</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            Welcome back John! Not John? Click <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>login.html<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>here<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> to login.
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 已认证通过的用户。不包含已记住的用户，这是与user标签的区别所在。 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name"><span class="token namespace">shiro:</span>authenticated</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            Hello, <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">shiro:</span>principal</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>, how are you today?
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">shiro:</span>authenticated</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>updateAccount.html<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Update your contact information<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 输出当前用户信息，通常为登录帐号信息。 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Hello, <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">shiro:</span>principal</span><span class="token punctuation">/&gt;</span></span>, how are you today?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 未认证通过用户，与authenticated标签相对应。与guest标签的区别是，该标签包含已记住用户。 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name"><span class="token namespace">shiro:</span>notAuthenticated</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            Please <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>login.html<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> in order to update your credit card information.
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 验证当前用户是否属于该角色。 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">shiro:</span>hasRole</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>admin<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>admin.html<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Administer the system<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 拥有该角色 --&gt;</span>
        <span class="token comment">&lt;!-- 与hasRole标签逻辑相反，当用户不属于该角色时验证通过。 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name"><span class="token namespace">shiro:</span>lacksRole</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>developer<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 没有该角色 --&gt;</span>
            Sorry, you are not allowed to developer the system.
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 验证当前用户是否属于以下所有角色。 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name"><span class="token namespace">shiro:</span>hasAllRoles</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>developer, 2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 角色与判断 --&gt;</span>
            You are a developer and a admin.
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 验证当前用户是否属于以下任意一个角色。 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name"><span class="token namespace">shiro:</span>hasAnyRoles</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>admin, vip, developer,1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 角色或判断 --&gt;</span>
            You are a admin, vip, or developer.
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--验证当前用户是否拥有指定权限。 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">shiro:</span>hasPermission</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userInfo:add<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>createUser.html<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>添加用户<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 拥有权限 --&gt;</span>
        <span class="token comment">&lt;!-- 与hasPermission标签逻辑相反，当前用户没有制定权限时，验证通过。 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name"><span class="token namespace">shiro:</span>lacksPermission</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userInfo:del<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 没有权限 --&gt;</span>
            Sorry, you are not allowed to delete user accounts.
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 验证当前用户是否拥有以下所有角色。 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name"><span class="token namespace">shiro:</span>hasAllPermissions</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userInfo:view, userInfo:add<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 权限与判断 --&gt;</span>
            You can see or add users.
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 验证当前用户是否拥有以下任意一个权限。 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name"><span class="token namespace">shiro:</span>hasAnyPermissions</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userInfo:view, userInfo:del<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 权限或判断 --&gt;</span>
            You can see or delete users.
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">shiro:</span>hasPermission</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pp<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>createUser.html<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Create a new User<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8b5415d71256512b82535bdba9074016/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue配置文件中的proxy中配置多个接口地址</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4fb90b6f53360f15b9e654c1fcb4a7a8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring Boot 整合 ...</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>