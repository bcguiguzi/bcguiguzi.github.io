<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>django开发小程序实现openid登录功能 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="django开发小程序实现openid登录功能" />
<meta property="og:description" content="侃后端django django是一个Python栈的重型框架，可以说web开发中遇到的相关技术栈在这个框架中都能找到身影，如果说要学习PythonWeb开发，自然是绕不开的存在，如果能再深入其源码内部窥视一番，那收获绝对满满，他的架构设计思路，各种插件机制的开发，以及眼花缭乱的函数式装饰器，类装饰器等等的一些酷炫技巧，真的是让人不得不感叹一句，牛逼！
django&#43;小程序 擦出爱情的火花 正式进入正题，实现微信小程序登录逻辑！首先我们需要搞清楚，微信小程序登录的一逻辑套路，如下图！
图：来自小程序官方文档
说明 调用 wx.login() 获取 临时登录凭证code ，并回传到开发者服务器。调用 auth.code2Session 接口，换取 用户唯一标识 OpenID 、 用户在微信开放平台帐号下的唯一标识UnionID（若当前小程序已绑定到微信开放平台帐号） 和 会话密钥 session_key。 之后开发者服务器可以根据用户标识来生成自定义登录态，用于后续业务逻辑中前后端交互时识别用户身份。
注意事项 会话密钥 session_key 是对用户数据进行 加密签名 的密钥。为了应用自身的数据安全，开发者服务器不应该把会话密钥下发到小程序，也不应该对外提供这个密钥。临时登录凭证 code 只能使用一次。 困惑 其实上边的图和文字都已经说的非常清楚，稍微有点概念的开发者基本上都可以读懂和看懂，但很多初学者却仍然是一脸懵逼，没有概念，什么开发者服务器，回传，换取code等等这些词汇搞懵逼了，其实代码很简单一看就，喔，原来这样啊的豁然开朗，那么就带你用代码解读上边那句话！
流程解读 前端通过wx.login() 就可以在返回值中拿到一个code也就是只能使用一次的那个code, 之后再在回调方法success()中将这个code，通过wx.request() 方法向django后端发起一个post请求，并携带这个code,这就是回传code到开发者服务器，之后在django后端构造的这个post请求中就可以获取到这个code,再携带微信小程序的appid和appsecret，向微信的这个 https://api.weixin.qq.com/sns/jscode2session 接口携带那几个参数发送get请求即可，如下所示！
https://api.weixin.qq.com/sns/jscode2session?appid={appid}&amp;secret={appsecret}&amp;js_code={code}&amp;grant_type=authorization_code&#34; 到这里基本的流程就跑通了，下面我们直接来看看前端代码和后端代码，就能够一目了然的看懂！
前端代码 wx.login({ success (res) { // 判断是否获取到了code if (res.code) { // 向开发者服务器回传code wx.request({ url: `http://127.0.0.1:8000/wechat/login/`, method: &#39;POST&#39;, data: { code: res.code }, success: res =&gt; { // 拿到开发者服务器返回的用户信息及openid等逻辑需要的信息 console." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/eb5938e439b44105376f12e29b80e6d8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-03T10:47:54+08:00" />
<meta property="article:modified_time" content="2023-04-03T10:47:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">django开发小程序实现openid登录功能</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="django_0"></a>侃后端django</h2> 
<p><img src="https://images2.imgbox.com/73/9b/WYHNIWHN_o.png" alt="logo-django.42234b631760.svg"><br> django是一个Python栈的重型框架，可以说web开发中遇到的相关技术栈在这个框架中都能找到身影，如果说要学习PythonWeb开发，自然是绕不开的存在，如果能再深入其源码内部窥视一番，那收获绝对满满，他的架构设计思路，各种插件机制的开发，以及眼花缭乱的函数式装饰器，类装饰器等等的一些酷炫技巧，真的是让人不得不感叹一句，<strong>牛逼</strong>！</p> 
<h2><a id="django__6"></a>django+小程序 擦出爱情的火花</h2> 
<p>正式进入正题，实现微信小程序登录逻辑！首先我们需要搞清楚，微信小程序登录的一逻辑套路，如下图！</p> 
<p><img src="https://images2.imgbox.com/57/c9/LwjPLfZp_o.png" alt="微信截图_20230403092119.png"><br> 图：来自小程序官方文档</p> 
<h3><a id="_12"></a>说明</h3> 
<ol><li>调用 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html" rel="nofollow">wx.login()</a> 获取 <strong>临时登录凭证code</strong> ，并回传到开发者服务器。</li><li>调用 <a href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html" rel="nofollow">auth.code2Session</a> 接口，换取 <strong>用户唯一标识 OpenID</strong> 、 用户在微信开放平台帐号下的<strong>唯一标识UnionID</strong>（若当前小程序已绑定到微信开放平台帐号） 和 <strong>会话密钥 session_key</strong>。</li></ol> 
<p>之后开发者服务器可以根据用户标识来生成自定义登录态，用于后续业务逻辑中前后端交互时识别用户身份。</p> 
<h3><a id="httpsdevelopersweixinqqcomminiprogramdevframeworkopenabilityloginhtmlE6B3A8E6848FE4BA8BE9A1B9_19"></a><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" rel="nofollow"></a>注意事项</h3> 
<ol><li>会话密钥 <code>session_key</code> 是对用户数据进行 <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html" rel="nofollow">加密签名</a> 的密钥。为了应用自身的数据安全，开发者服务器<strong>不应该把会话密钥下发到小程序，也不应该对外提供这个密钥</strong>。</li><li>临时登录凭证 code 只能使用一次。</li></ol> 
<h3><a id="_24"></a>困惑</h3> 
<p>其实上边的图和文字都已经说的非常清楚，稍微有点概念的开发者基本上都可以读懂和看懂，但很多初学者却仍然是一脸懵逼，没有概念，什么开发者服务器，回传，换取code等等这些词汇搞懵逼了，其实代码很简单一看就，喔，原来这样啊的豁然开朗，那么就带你用代码解读上边那句话！</p> 
<h3><a id="_27"></a>流程解读</h3> 
<p>前端通过<strong>wx.login()</strong> 就可以在返回值中拿到一个code也就是只能使用一次的那个<strong>code</strong>, 之后再在回调方法success()中将这个code，通过<strong>wx.request()</strong> 方法向django后端发起一个post请求，并携带这个code,<strong>这就是回传code到开发者服务器</strong>，之后在django后端构造的这个post请求中就可以获取到这个code,再携带微信小程序的<strong>appid</strong>和<strong>appsecret</strong>，向微信的这个 <strong>https://api.weixin.qq.com/sns/jscode2session</strong> 接口携带那几个参数发送get请求即可，如下所示！</p> 
<pre><code class="prism language-html">https://api.weixin.qq.com/sns/jscode2session?appid={appid}&amp;secret={appsecret}&amp;js_code={code}&amp;grant_type=authorization_code"
</code></pre> 
<p>到这里基本的流程就跑通了，下面我们直接来看看前端代码和后端代码，就能够一目了然的看懂！</p> 
<h2><a id="_34"></a>前端代码</h2> 
<pre><code class="prism language-js">wx<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">success</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断是否获取到了code</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 向开发者服务器回传code</span>
            wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://127.0.0.1:8000/wechat/login/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
				<span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token literal-property property">code</span><span class="token operator">:</span> res<span class="token punctuation">.</span>code
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 拿到开发者服务器返回的用户信息及openid等逻辑需要的信息</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_56"></a>后端代码</h2> 
<pre><code class="prism language-python">
<span class="token keyword">class</span> <span class="token class-name">WechatLogin</span><span class="token punctuation">(</span>APIView<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token triple-quoted-string string">""" 获取opeid存储用户信息"""</span>

    appid <span class="token operator">=</span> <span class="token string">'wxxxxxxxx'</span>
    appsecret <span class="token operator">=</span> <span class="token string">''</span>
    jscode2session_url <span class="token operator">=</span> <span class="token string">"https://api.weixin.qq.com/sns/jscode2session"</span>

    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 获取到前端回传过来的code</span>
        code <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span>  <span class="token comment"># 这个code有效期为5分钟</span>
        <span class="token comment"># 构造向wx发送请求的url</span>
        url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>jscode2session_url<span class="token punctuation">}</span></span><span class="token string">?appid=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>appid<span class="token punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>appsecret<span class="token punctuation">}</span></span><span class="token string">&amp;js_code=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>code<span class="token punctuation">}</span></span><span class="token string">&amp;grant_type=authorization_code"</span></span>
        <span class="token comment"># 向微信服务器发起get请求</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 这里就是拿到的openid和session_key</span>
            openid <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'openid'</span><span class="token punctuation">]</span>
            session_key <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'session_key'</span><span class="token punctuation">]</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'code'</span><span class="token punctuation">:</span> <span class="token string">'fail'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 主代码块执行完执行到这里，获取或保存用户</span>
            user<span class="token punctuation">,</span> iscreated <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_or_create<span class="token punctuation">(</span>
                username<span class="token operator">=</span>openid<span class="token punctuation">,</span> 
                password<span class="token operator">=</span>openid<span class="token punctuation">,</span> 
                defaults<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'username'</span><span class="token punctuation">:</span> openid<span class="token punctuation">}</span>
            <span class="token punctuation">)</span>

            <span class="token comment"># 采用JWT登录的话，这里就返回token信息</span>
            <span class="token keyword">from</span> foodapi<span class="token punctuation">.</span>utils <span class="token keyword">import</span> get_tokens_for_user
            token_dict <span class="token operator">=</span> get_tokens_for_user<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                userinfo <span class="token operator">=</span> user<span class="token punctuation">.</span>userinfo
            <span class="token keyword">except</span> UserInfo<span class="token punctuation">.</span>DoesNotExist<span class="token punctuation">:</span>
                userinfo<span class="token punctuation">,</span> isupdated <span class="token operator">=</span> UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>update_or_create<span class="token punctuation">(</span>owner<span class="token operator">=</span>user<span class="token punctuation">,</span> name<span class="token operator">=</span>openid<span class="token punctuation">,</span> defaults<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'owner'</span><span class="token punctuation">:</span> user<span class="token punctuation">}</span><span class="token punctuation">)</span>
            avatar <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"http://</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>request<span class="token punctuation">.</span>get_host<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>userinfo<span class="token punctuation">.</span>avatar<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span> <span class="token string">"openid"</span><span class="token punctuation">:</span> openid<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> userinfo<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"avatar"</span><span class="token punctuation">:</span> avatar<span class="token punctuation">,</span> <span class="token operator">**</span>token_dict<span class="token punctuation">}</span><span class="token punctuation">,</span> status<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_200_OK<span class="token punctuation">)</span>
</code></pre> 
<p>到这里，这个基本的逻辑就完成了，用户信息就已经在前端可以拿到了，前端就可以把相关信息进行存储并使用状态管理来管理和获取这些信息，前端的逻辑还有很长的路要走，这里我们主要就是掩饰这个小程序登录的一个基本的流程！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/45d25724fecce5cdd9e163600b959090/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux块设备IO子系统_驱动模型</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fe6925e712e07660fa189a988af2b154/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于 ant-design-vue a-table 表格的使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>