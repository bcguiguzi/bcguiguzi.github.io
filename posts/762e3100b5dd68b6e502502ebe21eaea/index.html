<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>阿里云-零基础入门推荐系统 【排序模型&#43;模型融合】 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="阿里云-零基础入门推荐系统 【排序模型&#43;模型融合】" />
<meta property="og:description" content="文章目录 学习过程赛题介绍评价方式理解赛题理解排序模型读取排序特征转化类型返回排序后的结果排序结果归一化LGB排序模型定义特征列排序模型分组排序模型定义排序模型训练lgb_ranker模型预测lgb_ranker预测结果重新排序及生成提交结果lgb_ranker五折交叉验证lgb_ranker五折交叉验证预测结果重新排序, 及生成提交结果 LGB分类模型模型训练模型预测lgb_cls预测结果重新排序, 及生成提交结果lgb_cls五折交叉验证lgb_cls五折交叉验证预测结果重新排序 模型融合加权融合Staking将多个模型输出的特征进行拼接定义一个逻辑回归模型再次拟合交叉验证产生的特征对测试集进行预测ensumble_staking预测结果重新排序及生成提交结果 学习过程 20年当时自身功底是比较零基础(会写些基础的Python[三个科学计算包]数据分析)，一开始看这块其实挺懵的，不会就去问百度或其他人，当时遇见困难挺害怕的，但22后面开始力扣题【目前已刷好几轮，博客没写力扣文章之前，力扣排名靠前已刷有5遍左右，排名靠后刷3次左右，代码功底也在一步一步提升】不断地刷、遇见代码不懂的代码，也开始去打印print去理解，到后面问其他人的问题越来越少，个人自主学习、自主解决能力也得到了进一步增强。
赛题介绍 该赛题是以新闻APP中的新闻推荐为背景， 目的是要求我们根据用户历史浏览点击新闻文章的数据信息预测用户未来的点击行为， 即用户的最后一次点击的新闻文章。
评价方式理解 最后提交的格式是针对每个用户， 我们都会给出五篇文章的推荐结果，按照点击概率从前往后排序。 而真实的每个用户最后一次点击的文章只会有一篇的真实答案， 所以我们就看我们推荐的这五篇里面是否有命中真实答案的。比如对于user1来说， 我们的提交会是：
user1, article1, article2, article3, article4, article5. 评价指标的公式如下：
假如article1就是真实的用户点击文章，也就是article1命中， 则s(user1,1)=1, s(user1,2-4)都是0， 如果article2是用户点击的文章， 则s(user,2)=1/2,s(user,1,3,4,5)都是0。也就是score(user)=命中第几条的倒数。如果都没中， 则score(user1)=0。 这个是合理的， 因为我们希望的就是命中的结果尽量靠前， 而此时分数正好比较高。
赛题理解 根据赛题简介，我们首先要明确我们此次比赛的目标： 根据用户历史浏览点击新闻的数据信息预测用户最后一次点击的新闻文章。从这个目标上看， 会发现此次比赛和我们之前遇到的普通的结构化比赛不太一样， 主要有两点：
首先是目标上， 要预测最后一次点击的新闻文章，也就是我们给用户推荐的是新闻文章， 并不是像之前那种预测一个数或者预测数据哪一类那样的问题数据上， 通过给出的数据我们会发现， 这种数据也不是我们之前遇到的那种特征&#43;标签的数据，而是基于了真实的业务场景， 拿到的用户的点击日志 所以拿到这个题目，我们的思考方向就是结合我们的目标，把该预测问题转成一个监督学习的问题(特征&#43;标签)，然后我们才能进行ML，DL等建模预测。
排序模型 通过召回的操作， 我们已经进行了问题规模的缩减， 对于每个用户， 选择出了N篇文章作为了候选集，并基于召回的候选集构建了与用户历史相关的特征，以及用户本身的属性特征，文章本省的属性特征，以及用户与文章之间的特征，下面就是使用机器学习模型来对构造好的特征进行学习，然后对测试集进行预测，得到测试集中的每个候选集用户点击的概率，返回点击概率最大的topk个文章，作为最终的结果。
排序阶段选择了三个比较有代表性的排序模型，它们分别是：
LGB的排序模型LGB的分类模型深度学习的分类模型DIN 得到了最终的排序模型输出的结果之后，还选择了两种比较经典的模型集成的方法：
输出结果加权融合Staking（将模型的输出结果再使用一个简单模型进行预测） import numpy as np import pandas as pd import pickle from tqdm import tqdm import gc, os import time from datetime import datetime import lightgbm as lgb from sklearn." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/762e3100b5dd68b6e502502ebe21eaea/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-18T06:00:00+08:00" />
<meta property="article:modified_time" content="2024-03-18T06:00:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">阿里云-零基础入门推荐系统 【排序模型&#43;模型融合】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_3" rel="nofollow">学习过程</a></li><li><a href="#_6" rel="nofollow">赛题介绍</a></li><li><a href="#_9" rel="nofollow">评价方式理解</a></li><li><a href="#_22" rel="nofollow">赛题理解</a></li><li><a href="#_30" rel="nofollow">排序模型</a></li><li><ul><li><a href="#_59" rel="nofollow">读取排序特征</a></li><li><a href="#_70" rel="nofollow">转化类型</a></li><li><a href="#_89" rel="nofollow">返回排序后的结果</a></li><li><a href="#_112" rel="nofollow">排序结果归一化</a></li><li><a href="#LGB_127" rel="nofollow">LGB排序模型</a></li><li><ul><li><a href="#_138" rel="nofollow">定义特征列</a></li><li><a href="#_148" rel="nofollow">排序模型分组</a></li><li><a href="#_158" rel="nofollow">排序模型定义</a></li><li><a href="#_165" rel="nofollow">排序模型训练</a></li><li><a href="#lgb_ranker_175" rel="nofollow">lgb_ranker模型预测</a></li><li><a href="#lgb_ranker_182" rel="nofollow">lgb_ranker预测结果重新排序及生成提交结果</a></li><li><a href="#lgb_ranker_189" rel="nofollow">lgb_ranker五折交叉验证</a></li><li><a href="#lgb_ranker__258" rel="nofollow">lgb_ranker五折交叉验证预测结果重新排序, 及生成提交结果</a></li></ul> 
   </li><li><a href="#LGB_266" rel="nofollow">LGB分类模型</a></li><li><ul><li><a href="#_274" rel="nofollow">模型训练</a></li><li><a href="#_284" rel="nofollow">模型预测</a></li><li><a href="#lgb_cls__292" rel="nofollow">lgb_cls预测结果重新排序, 及生成提交结果</a></li><li><a href="#lgb_cls_300" rel="nofollow">lgb_cls五折交叉验证</a></li><li><a href="#lgb_cls_363" rel="nofollow">lgb_cls五折交叉验证预测结果重新排序</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_371" rel="nofollow">模型融合</a></li><li><ul><li><a href="#_372" rel="nofollow">加权融合</a></li><li><a href="#Staking_400" rel="nofollow">Staking</a></li><li><ul><li><a href="#_418" rel="nofollow">将多个模型输出的特征进行拼接</a></li><li><a href="#_434" rel="nofollow">定义一个逻辑回归模型再次拟合交叉验证产生的特征对测试集进行预测</a></li><li><a href="#ensumble_staking_456" rel="nofollow">ensumble_staking预测结果重新排序及生成提交结果</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_3"></a>学习过程</h2> 
<p>20年当时自身功底是比较零基础(会写些基础的Python[三个科学计算包]数据分析)，一开始看这块其实挺懵的，不会就去问百度或其他人，当时遇见困难挺害怕的，但22后面开始力扣题【目前已刷好几轮，博客没写力扣文章之前，力扣排名靠前已刷有5遍左右，排名靠后刷3次左右，代码功底也在一步一步提升】不断地刷、遇见代码不懂的代码，也开始去打印print去理解，到后面问其他人的问题越来越少，个人自主学习、自主解决能力也得到了进一步增强。</p> 
<h2><a id="_6"></a>赛题介绍</h2> 
<p>该赛题是以新闻APP中的新闻推荐为背景， 目的是<strong>要求我们根据用户历史浏览点击新闻文章的数据信息预测用户未来的点击行为， 即用户的最后一次点击的新闻文章</strong>。</p> 
<h2><a id="_9"></a>评价方式理解</h2> 
<p>最后提交的格式是针对每个用户， 我们都会给出五篇文章的推荐结果，按照点击概率从前往后排序。 而真实的每个用户最后一次点击的文章只会有一篇的真实答案， 所以我们就看我们推荐的这五篇里面是否有命中真实答案的。比如对于user1来说， 我们的提交会是：</p> 
<pre><code class="prism language-python">user1<span class="token punctuation">,</span> article1<span class="token punctuation">,</span> article2<span class="token punctuation">,</span> article3<span class="token punctuation">,</span> article4<span class="token punctuation">,</span> article5<span class="token punctuation">.</span>
</code></pre> 
<p>评价指标的公式如下：<br> <img src="https://images2.imgbox.com/ad/79/GGmGDh5t_o.png" alt="在这里插入图片描述"></p> 
<p>假如article1就是真实的用户点击文章，也就是article1命中， 则s(user1,1)=1, s(user1,2-4)都是0， 如果article2是用户点击的文章， 则s(user,2)=1/2,s(user,1,3,4,5)都是0。也就是score(user)=命中第几条的倒数。如果都没中， 则score(user1)=0。 这个是合理的， 因为我们希望的就是命中的结果尽量靠前， 而此时分数正好比较高。</p> 
<h2><a id="_22"></a>赛题理解</h2> 
<p>根据赛题简介，我们首先要明确我们此次比赛的目标： 根据用户历史浏览点击新闻的数据信息预测用户最后一次点击的新闻文章。从这个目标上看， 会发现此次比赛和我们之前遇到的普通的结构化比赛不太一样， 主要有两点：</p> 
<ul><li>首先是目标上， 要预测最后一次点击的新闻文章，也就是我们给用户推荐的是新闻文章， 并不是像之前那种预测一个数或者预测数据哪一类那样的问题</li><li>数据上， 通过给出的数据我们会发现， 这种数据也不是我们之前遇到的那种特征+标签的数据，而是基于了真实的业务场景， 拿到的用户的点击日志</li></ul> 
<p>所以拿到这个题目，我们的思考方向就是结合我们的目标，把该预测问题转成一个监督学习的问题(特征+标签)，然后我们才能进行ML，DL等建模预测。</p> 
<h2><a id="_30"></a>排序模型</h2> 
<p>通过召回的操作， 我们已经进行了问题规模的缩减， 对于每个用户， 选择出了N篇文章作为了候选集，并基于召回的候选集构建了与用户历史相关的特征，以及用户本身的属性特征，文章本省的属性特征，以及用户与文章之间的特征，下面就是使用机器学习模型来对构造好的特征进行学习，然后对测试集进行预测，得到测试集中的每个候选集用户点击的概率，返回点击概率最大的topk个文章，作为最终的结果。</p> 
<p>排序阶段选择了三个比较有代表性的排序模型，它们分别是：</p> 
<ul><li>LGB的排序模型</li><li>LGB的分类模型</li><li>深度学习的分类模型DIN</li></ul> 
<p>得到了最终的排序模型输出的结果之后，还选择了两种比较经典的模型集成的方法：</p> 
<ul><li>输出结果加权融合</li><li>Staking（将模型的输出结果再使用一个简单模型进行预测）</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> pickle
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">import</span> gc<span class="token punctuation">,</span> os
<span class="token keyword">import</span> time
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">import</span> lightgbm <span class="token keyword">as</span> lgb
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> MinMaxScaler
<span class="token keyword">import</span> warnings
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_59"></a>读取排序特征</h3> 
<pre><code class="prism language-python"><span class="token comment">#data_path = './data_raw/'</span>
<span class="token comment">#save_path = './temp_results/'</span>
data_path <span class="token operator">=</span> <span class="token string">'/data/temp/用户行为预测数据集/'</span> <span class="token comment"># '/home/admin/jupyter/data/' # 天池平台路径</span>
save_path <span class="token operator">=</span> <span class="token string">'results/0227/'</span> <span class="token comment"># '/home/admin/jupyter/temp_results/'  # 天池平台路径</span>

offline <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre> 
<h3><a id="_70"></a>转化类型</h3> 
<pre><code class="prism language-python"><span class="token comment"># 重新读取数据的时候，发现click_article_id是一个浮点数，所以将其转换成int类型</span>
trn_user_item_feats_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'trn_user_item_feats_df.csv'</span><span class="token punctuation">)</span>
trn_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> trn_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> offline<span class="token punctuation">:</span>
    val_user_item_feats_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'val_user_item_feats_df.csv'</span><span class="token punctuation">)</span>
    val_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> val_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    val_user_item_feats_df <span class="token operator">=</span> <span class="token boolean">None</span>
    
tst_user_item_feats_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'tst_user_item_feats_df.csv'</span><span class="token punctuation">)</span>
tst_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tst_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>

<span class="token comment"># 做特征的时候为了方便，给测试集也打上了一个无效的标签，这里直接删掉就行</span>
<span class="token keyword">del</span> tst_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span>
</code></pre> 
<h3><a id="_89"></a>返回排序后的结果</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">submit</span><span class="token punctuation">(</span>recall_df<span class="token punctuation">,</span> topk<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> model_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    recall_df <span class="token operator">=</span> recall_df<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    recall_df<span class="token punctuation">[</span><span class="token string">'rank'</span><span class="token punctuation">]</span> <span class="token operator">=</span> recall_df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rank<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'first'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 判断是不是每个用户都有5篇文章及以上</span>
    tmp <span class="token operator">=</span> recall_df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token string">'rank'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> tmp<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> topk
    
    <span class="token keyword">del</span> recall_df<span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span>
    submit <span class="token operator">=</span> recall_df<span class="token punctuation">[</span>recall_df<span class="token punctuation">[</span><span class="token string">'rank'</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> topk<span class="token punctuation">]</span><span class="token punctuation">.</span>set_index<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'rank'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unstack<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    submit<span class="token punctuation">.</span>columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>col<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">else</span> col <span class="token keyword">for</span> col <span class="token keyword">in</span> submit<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>droplevel<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token comment"># 按照提交格式定义列名</span>
    submit <span class="token operator">=</span> submit<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">''</span><span class="token punctuation">:</span> <span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">'article_1'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'article_2'</span><span class="token punctuation">,</span> 
                                                  <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">'article_3'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">'article_4'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span> <span class="token string">'article_5'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    save_name <span class="token operator">=</span> save_path <span class="token operator">+</span> model_name <span class="token operator">+</span> <span class="token string">'_'</span> <span class="token operator">+</span> datetime<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%m-%d'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.csv'</span>
    submit<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>save_name<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="_112"></a>排序结果归一化</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">norm_sim</span><span class="token punctuation">(</span>sim_df<span class="token punctuation">,</span> weight<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># print(sim_df.head())</span>
    min_sim <span class="token operator">=</span> sim_df<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    max_sim <span class="token operator">=</span> sim_df<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> max_sim <span class="token operator">==</span> min_sim<span class="token punctuation">:</span>
        sim_df <span class="token operator">=</span> sim_df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> sim<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        sim_df <span class="token operator">=</span> sim_df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> sim<span class="token punctuation">:</span> <span class="token number">1.0</span> <span class="token operator">*</span> <span class="token punctuation">(</span>sim <span class="token operator">-</span> min_sim<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>max_sim <span class="token operator">-</span> min_sim<span class="token punctuation">)</span><span class="token punctuation">)</span>

    sim_df <span class="token operator">=</span> sim_df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> sim<span class="token punctuation">:</span> sim <span class="token operator">+</span> weight<span class="token punctuation">)</span>  <span class="token comment"># plus one</span>
    <span class="token keyword">return</span> sim_df
</code></pre> 
<h3><a id="LGB_127"></a>LGB排序模型</h3> 
<pre><code class="prism language-python"><span class="token comment"># 防止中间出错之后重新读取数据</span>
trn_user_item_feats_df_rank_model <span class="token operator">=</span> trn_user_item_feats_df<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> offline<span class="token punctuation">:</span>
    val_user_item_feats_df_rank_model <span class="token operator">=</span> val_user_item_feats_df<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
tst_user_item_feats_df_rank_model <span class="token operator">=</span> tst_user_item_feats_df<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_138"></a>定义特征列</h4> 
<pre><code class="prism language-python">lgb_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'sim0'</span><span class="token punctuation">,</span> <span class="token string">'time_diff0'</span><span class="token punctuation">,</span> <span class="token string">'word_diff0'</span><span class="token punctuation">,</span><span class="token string">'sim_max'</span><span class="token punctuation">,</span> <span class="token string">'sim_min'</span><span class="token punctuation">,</span> <span class="token string">'sim_sum'</span><span class="token punctuation">,</span> 
            <span class="token string">'sim_mean'</span><span class="token punctuation">,</span> <span class="token string">'score'</span><span class="token punctuation">,</span><span class="token string">'click_size'</span><span class="token punctuation">,</span> <span class="token string">'time_diff_mean'</span><span class="token punctuation">,</span> <span class="token string">'active_level'</span><span class="token punctuation">,</span>
            <span class="token string">'click_environment'</span><span class="token punctuation">,</span><span class="token string">'click_deviceGroup'</span><span class="token punctuation">,</span> <span class="token string">'click_os'</span><span class="token punctuation">,</span> <span class="token string">'click_country'</span><span class="token punctuation">,</span> 
            <span class="token string">'click_region'</span><span class="token punctuation">,</span><span class="token string">'click_referrer_type'</span><span class="token punctuation">,</span> <span class="token string">'user_time_hob1'</span><span class="token punctuation">,</span> <span class="token string">'user_time_hob2'</span><span class="token punctuation">,</span>
            <span class="token string">'words_hbo'</span><span class="token punctuation">,</span> <span class="token string">'category_id'</span><span class="token punctuation">,</span> <span class="token string">'created_at_ts'</span><span class="token punctuation">,</span><span class="token string">'words_count'</span><span class="token punctuation">]</span>
</code></pre> 
<h4><a id="_148"></a>排序模型分组</h4> 
<pre><code class="prism language-python">trn_user_item_feats_df_rank_model<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
g_train <span class="token operator">=</span> trn_user_item_feats_df_rank_model<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> as_index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values

<span class="token keyword">if</span> offline<span class="token punctuation">:</span>
    val_user_item_feats_df_rank_model<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    g_val <span class="token operator">=</span> val_user_item_feats_df_rank_model<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> as_index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values
</code></pre> 
<h4><a id="_158"></a>排序模型定义</h4> 
<pre><code class="prism language-python">lgb_ranker <span class="token operator">=</span> lgb<span class="token punctuation">.</span>LGBMRanker<span class="token punctuation">(</span>boosting_type<span class="token operator">=</span><span class="token string">'gbdt'</span><span class="token punctuation">,</span> num_leaves<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">,</span> reg_alpha<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> reg_lambda<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                            max_depth<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> n_estimators<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> subsample<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> colsample_bytree<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> subsample_freq<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                            learning_rate<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> min_child_weight<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">2018</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">)</span>  
</code></pre> 
<h4><a id="_165"></a>排序模型训练</h4> 
<pre><code class="prism language-python"><span class="token keyword">if</span> offline<span class="token punctuation">:</span>
    lgb_ranker<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>trn_user_item_feats_df_rank_model<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> trn_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> group<span class="token operator">=</span>g_train<span class="token punctuation">,</span>
                eval_set<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span>val_user_item_feats_df_rank_model<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> val_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                eval_group<span class="token operator">=</span> <span class="token punctuation">[</span>g_val<span class="token punctuation">]</span><span class="token punctuation">,</span> eval_at<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> eval_metric<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'ndcg'</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> early_stopping_rounds<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    lgb_ranker<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>trn_user_item_feats_df<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> trn_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> group<span class="token operator">=</span>g_train<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="lgb_ranker_175"></a>lgb_ranker模型预测</h4> 
<pre><code class="prism language-python">tst_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span> <span class="token operator">=</span> lgb_ranker<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>tst_user_item_feats_df<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> num_iteration<span class="token operator">=</span>lgb_ranker<span class="token punctuation">.</span>best_iteration_<span class="token punctuation">)</span>

<span class="token comment"># 将这里的排序结果保存一份，用户后面的模型融合</span>
tst_user_item_feats_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'lgb_ranker_score.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="lgb_ranker_182"></a>lgb_ranker预测结果重新排序及生成提交结果</h4> 
<pre><code class="prism language-python">rank_results <span class="token operator">=</span> tst_user_item_feats_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
rank_results<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> rank_results<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
submit<span class="token punctuation">(</span>rank_results<span class="token punctuation">,</span> topk<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> model_name<span class="token operator">=</span><span class="token string">'lgb_ranker'</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="lgb_ranker_189"></a>lgb_ranker五折交叉验证</h4> 
<pre><code class="prism language-python"><span class="token comment"># 五折交叉验证，这里的五折交叉是以用户为目标进行五折划分</span>
<span class="token comment">#  这一部分与前面的单独训练和验证是分开的</span>
<span class="token keyword">def</span> <span class="token function">get_kfold_users</span><span class="token punctuation">(</span>trn_df<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_ids <span class="token operator">=</span> trn_df<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span>
    user_set <span class="token operator">=</span> <span class="token punctuation">[</span>user_ids<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> user_set

k_fold <span class="token operator">=</span> <span class="token number">5</span>
trn_df <span class="token operator">=</span> trn_user_item_feats_df_rank_model
user_set <span class="token operator">=</span> get_kfold_users<span class="token punctuation">(</span>trn_df<span class="token punctuation">,</span> n<span class="token operator">=</span>k_fold<span class="token punctuation">)</span>

score_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
score_df <span class="token operator">=</span> trn_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
sub_preds <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>tst_user_item_feats_df_rank_model<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 五折交叉验证，并将中间结果保存用于staking</span>
<span class="token keyword">for</span> n_fold<span class="token punctuation">,</span> valid_user <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>user_set<span class="token punctuation">)</span><span class="token punctuation">:</span>
    train_idx <span class="token operator">=</span> trn_df<span class="token punctuation">[</span><span class="token operator">~</span>trn_df<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>valid_user<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># add slide user</span>
    valid_idx <span class="token operator">=</span> trn_df<span class="token punctuation">[</span>trn_df<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>valid_user<span class="token punctuation">)</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 训练集与验证集的用户分组</span>
    train_idx<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    g_train <span class="token operator">=</span> train_idx<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> as_index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values
    
    valid_idx<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    g_val <span class="token operator">=</span> valid_idx<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> as_index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values
    
    <span class="token comment"># 定义模型</span>
    lgb_ranker <span class="token operator">=</span> lgb<span class="token punctuation">.</span>LGBMRanker<span class="token punctuation">(</span>boosting_type<span class="token operator">=</span><span class="token string">'gbdt'</span><span class="token punctuation">,</span> num_leaves<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">,</span> reg_alpha<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> reg_lambda<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                            max_depth<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> n_estimators<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> subsample<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> colsample_bytree<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> subsample_freq<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                            learning_rate<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> min_child_weight<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">2018</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">)</span>  
    <span class="token comment"># 训练模型</span>
    lgb_ranker<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_idx<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> train_idx<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> group<span class="token operator">=</span>g_train<span class="token punctuation">,</span>
                   eval_set<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span>valid_idx<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> valid_idx<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> eval_group<span class="token operator">=</span> <span class="token punctuation">[</span>g_val<span class="token punctuation">]</span><span class="token punctuation">,</span> 
                   eval_at<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> eval_metric<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'ndcg'</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> early_stopping_rounds<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
    
    <span class="token comment"># 预测验证集结果</span>
    valid_idx<span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span> <span class="token operator">=</span> lgb_ranker<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>valid_idx<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> num_iteration<span class="token operator">=</span>lgb_ranker<span class="token punctuation">.</span>best_iteration_<span class="token punctuation">)</span>
    
    <span class="token comment"># 对输出结果进行归一化</span>
    valid_idx<span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span> <span class="token operator">=</span> valid_idx<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transform<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> norm_sim<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    valid_idx<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    valid_idx<span class="token punctuation">[</span><span class="token string">'pred_rank'</span><span class="token punctuation">]</span> <span class="token operator">=</span> valid_idx<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rank<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'first'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 将验证集的预测结果放到一个列表中，后面进行拼接</span>
    score_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>valid_idx<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">,</span> <span class="token string">'pred_rank'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 如果是线上测试，需要计算每次交叉验证的结果相加，最后求平均</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> offline<span class="token punctuation">:</span>
        sub_preds <span class="token operator">+=</span> lgb_ranker<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>tst_user_item_feats_df_rank_model<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> lgb_ranker<span class="token punctuation">.</span>best_iteration_<span class="token punctuation">)</span>
    
score_df_ <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>score_list<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
score_df <span class="token operator">=</span> score_df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>score_df_<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 保存训练集交叉验证产生的新特征</span>
score_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">,</span> <span class="token string">'pred_rank'</span><span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'trn_lgb_ranker_feats.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    
<span class="token comment"># 测试集的预测结果，多次交叉验证求平均,将预测的score和对应的rank特征保存，可以用于后面的staking，这里还可以构造其他更多的特征</span>
tst_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span> <span class="token operator">=</span> sub_preds <span class="token operator">/</span> k_fold
tst_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tst_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transform<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> norm_sim<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
tst_user_item_feats_df_rank_model<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
tst_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token string">'pred_rank'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tst_user_item_feats_df_rank_model<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rank<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'first'</span><span class="token punctuation">)</span>

<span class="token comment"># 保存测试集交叉验证的新特征</span>
tst_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">,</span> <span class="token string">'pred_rank'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'tst_lgb_ranker_feats.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="lgb_ranker__258"></a>lgb_ranker五折交叉验证预测结果重新排序, 及生成提交结果</h4> 
<pre><code class="prism language-python"><span class="token comment"># 单模型生成提交结果</span>
rank_results <span class="token operator">=</span> tst_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
rank_results<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> rank_results<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
submit<span class="token punctuation">(</span>rank_results<span class="token punctuation">,</span> topk<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> model_name<span class="token operator">=</span><span class="token string">'lgb_ranker_5zhe'</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="LGB_266"></a>LGB分类模型</h3> 
<pre><code class="prism language-python"><span class="token comment"># 模型及参数的定义</span>
lgb_Classfication <span class="token operator">=</span> lgb<span class="token punctuation">.</span>LGBMClassifier<span class="token punctuation">(</span>boosting_type<span class="token operator">=</span><span class="token string">'gbdt'</span><span class="token punctuation">,</span> num_leaves<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">,</span> reg_alpha<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> reg_lambda<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                            max_depth<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> n_estimators<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> subsample<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> colsample_bytree<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> subsample_freq<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                            learning_rate<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> min_child_weight<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">2018</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>  
</code></pre> 
<h4><a id="_274"></a>模型训练</h4> 
<pre><code class="prism language-python"><span class="token keyword">if</span> offline<span class="token punctuation">:</span>
    lgb_Classfication<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>trn_user_item_feats_df_rank_model<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> trn_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    eval_set<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span>val_user_item_feats_df_rank_model<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> val_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                    eval_metric<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'auc'</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>early_stopping_rounds<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    lgb_Classfication<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>trn_user_item_feats_df_rank_model<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> trn_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_284"></a>模型预测</h4> 
<pre><code class="prism language-python">tst_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span> <span class="token operator">=</span> lgb_Classfication<span class="token punctuation">.</span>predict_proba<span class="token punctuation">(</span>tst_user_item_feats_df<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>

<span class="token comment"># 将这里的排序结果保存一份，用户后面的模型融合</span>
tst_user_item_feats_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'lgb_cls_score.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="lgb_cls__292"></a>lgb_cls预测结果重新排序, 及生成提交结果</h4> 
<pre><code class="prism language-python">rank_results <span class="token operator">=</span> tst_user_item_feats_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
rank_results<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> rank_results<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
submit<span class="token punctuation">(</span>rank_results<span class="token punctuation">,</span> topk<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> model_name<span class="token operator">=</span><span class="token string">'lgb_cls'</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="lgb_cls_300"></a>lgb_cls五折交叉验证</h4> 
<pre><code class="prism language-python"><span class="token comment"># 五折交叉验证，这里的五折交叉是以用户为目标进行五折划分</span>
<span class="token comment">#  这一部分与前面的单独训练和验证是分开的</span>
<span class="token keyword">def</span> <span class="token function">get_kfold_users</span><span class="token punctuation">(</span>trn_df<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_ids <span class="token operator">=</span> trn_df<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span>
    user_set <span class="token operator">=</span> <span class="token punctuation">[</span>user_ids<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> user_set

k_fold <span class="token operator">=</span> <span class="token number">5</span>
trn_df <span class="token operator">=</span> trn_user_item_feats_df_rank_model
user_set <span class="token operator">=</span> get_kfold_users<span class="token punctuation">(</span>trn_df<span class="token punctuation">,</span> n<span class="token operator">=</span>k_fold<span class="token punctuation">)</span>

score_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
score_df <span class="token operator">=</span> trn_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
sub_preds <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>tst_user_item_feats_df_rank_model<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 五折交叉验证，并将中间结果保存用于staking</span>
<span class="token keyword">for</span> n_fold<span class="token punctuation">,</span> valid_user <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>user_set<span class="token punctuation">)</span><span class="token punctuation">:</span>
    train_idx <span class="token operator">=</span> trn_df<span class="token punctuation">[</span><span class="token operator">~</span>trn_df<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>valid_user<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># add slide user</span>
    valid_idx <span class="token operator">=</span> trn_df<span class="token punctuation">[</span>trn_df<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>valid_user<span class="token punctuation">)</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 模型及参数的定义</span>
    lgb_Classfication <span class="token operator">=</span> lgb<span class="token punctuation">.</span>LGBMClassifier<span class="token punctuation">(</span>boosting_type<span class="token operator">=</span><span class="token string">'gbdt'</span><span class="token punctuation">,</span> num_leaves<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">,</span> reg_alpha<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> reg_lambda<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                            max_depth<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> n_estimators<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> subsample<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> colsample_bytree<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> subsample_freq<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                            learning_rate<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> min_child_weight<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">2018</span><span class="token punctuation">,</span> n_jobs<span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>  
    <span class="token comment"># 训练模型</span>
    lgb_Classfication<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_idx<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> train_idx<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>eval_set<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span>valid_idx<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> valid_idx<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                          eval_metric<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'auc'</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>early_stopping_rounds<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
    
    <span class="token comment"># 预测验证集结果</span>
    valid_idx<span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span> <span class="token operator">=</span> lgb_Classfication<span class="token punctuation">.</span>predict_proba<span class="token punctuation">(</span>valid_idx<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> 
                                                              num_iteration<span class="token operator">=</span>lgb_Classfication<span class="token punctuation">.</span>best_iteration_<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 对输出结果进行归一化 分类模型输出的值本身就是一个概率值不需要进行归一化</span>
    <span class="token comment"># valid_idx['pred_score'] = valid_idx[['pred_score']].transform(lambda x: norm_sim(x))</span>
    
    valid_idx<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    valid_idx<span class="token punctuation">[</span><span class="token string">'pred_rank'</span><span class="token punctuation">]</span> <span class="token operator">=</span> valid_idx<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rank<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'first'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 将验证集的预测结果放到一个列表中，后面进行拼接</span>
    score_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>valid_idx<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">,</span> <span class="token string">'pred_rank'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 如果是线上测试，需要计算每次交叉验证的结果相加，最后求平均</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> offline<span class="token punctuation">:</span>
        sub_preds <span class="token operator">+=</span> lgb_Classfication<span class="token punctuation">.</span>predict_proba<span class="token punctuation">(</span>tst_user_item_feats_df_rank_model<span class="token punctuation">[</span>lgb_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> 
                                                     num_iteration<span class="token operator">=</span>lgb_Classfication<span class="token punctuation">.</span>best_iteration_<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>
    
score_df_ <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>score_list<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
score_df <span class="token operator">=</span> score_df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>score_df_<span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 保存训练集交叉验证产生的新特征</span>
score_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">,</span> <span class="token string">'pred_rank'</span><span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'trn_lgb_cls_feats.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    
<span class="token comment"># 测试集的预测结果，多次交叉验证求平均,将预测的score和对应的rank特征保存，可以用于后面的staking，这里还可以构造其他更多的特征</span>
tst_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span> <span class="token operator">=</span> sub_preds <span class="token operator">/</span> k_fold
tst_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tst_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transform<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> norm_sim<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
tst_user_item_feats_df_rank_model<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
tst_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token string">'pred_rank'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tst_user_item_feats_df_rank_model<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rank<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'first'</span><span class="token punctuation">)</span>

<span class="token comment"># 保存测试集交叉验证的新特征</span>
tst_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">,</span> <span class="token string">'pred_rank'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'tst_lgb_cls_feats.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="lgb_cls_363"></a>lgb_cls五折交叉验证预测结果重新排序</h4> 
<pre><code class="prism language-python"><span class="token comment"># 预测结果重新排序, 及生成提交结果</span>
rank_results <span class="token operator">=</span> tst_user_item_feats_df_rank_model<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
rank_results<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> rank_results<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
submit<span class="token punctuation">(</span>rank_results<span class="token punctuation">,</span> topk<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> model_name<span class="token operator">=</span><span class="token string">'lgb_cls_5zhe'</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_371"></a>模型融合</h2> 
<h3><a id="_372"></a>加权融合</h3> 
<pre><code class="prism language-python"><span class="token comment"># 读取多个模型的排序结果文件</span>
lgb_ranker <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'lgb_ranker_score.csv'</span><span class="token punctuation">)</span>
lgb_cls <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'lgb_cls_score.csv'</span><span class="token punctuation">)</span>
<span class="token comment">#din_ranker = pd.read_csv(save_path + 'din_rank_score.csv')</span>
<span class="token comment"># 这里也可以换成交叉验证输出的测试结果进行加权融合</span>


rank_model <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'lgb_ranker'</span><span class="token punctuation">:</span> lgb_ranker<span class="token punctuation">,</span> 
              <span class="token string">'lgb_cls'</span><span class="token punctuation">:</span> lgb_cls<span class="token punctuation">}</span>
              <span class="token comment">#'din_ranker': din_ranker}</span>


<span class="token keyword">def</span> <span class="token function">get_ensumble_predict_topk</span><span class="token punctuation">(</span>rank_model<span class="token punctuation">,</span> topk<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#final_recall = rank_model['lgb_cls'].append(rank_model['din_ranker'])</span>
    final_recall <span class="token operator">=</span> rank_model<span class="token punctuation">[</span><span class="token string">'lgb_cls'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>rank_model<span class="token punctuation">[</span><span class="token string">'lgb_ranker'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    rank_model<span class="token punctuation">[</span><span class="token string">'lgb_ranker'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span> <span class="token operator">=</span> rank_model<span class="token punctuation">[</span><span class="token string">'lgb_ranker'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transform<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> norm_sim<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment">#final_recall = final_recall.append(rank_model['lgb_ranker'])</span>
    final_recall <span class="token operator">=</span> final_recall<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    submit<span class="token punctuation">(</span>final_recall<span class="token punctuation">,</span> topk<span class="token operator">=</span>topk<span class="token punctuation">,</span> model_name<span class="token operator">=</span><span class="token string">'ensemble_fuse'</span><span class="token punctuation">)</span>


get_ensumble_predict_topk<span class="token punctuation">(</span>rank_model<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="Staking_400"></a>Staking</h3> 
<p><img src="https://images2.imgbox.com/c5/fd/0qZ4rg6z_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token comment"># 读取多个模型的交叉验证生成的结果文件</span>
<span class="token comment"># 训练集</span>
trn_lgb_ranker_feats <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'trn_lgb_ranker_feats.csv'</span><span class="token punctuation">)</span>
trn_lgb_cls_feats <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'trn_lgb_cls_feats.csv'</span><span class="token punctuation">)</span>
<span class="token comment">#trn_din_cls_feats = pd.read_csv(save_path + 'trn_din_cls_feats.csv')</span>

<span class="token comment"># 测试集</span>
tst_lgb_ranker_feats <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'tst_lgb_ranker_feats.csv'</span><span class="token punctuation">)</span>
tst_lgb_cls_feats <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'tst_lgb_cls_feats.csv'</span><span class="token punctuation">)</span>
<span class="token comment">#tst_din_cls_feats = pd.read_csv(save_path + 'tst_din_cls_feats.csv')</span>
</code></pre> 
<h4><a id="_418"></a>将多个模型输出的特征进行拼接</h4> 
<pre><code class="prism language-python">finall_trn_ranker_feats <span class="token operator">=</span> trn_lgb_ranker_feats<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
finall_tst_ranker_feats <span class="token operator">=</span> tst_lgb_ranker_feats<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> idx<span class="token punctuation">,</span> trn_model <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>trn_lgb_ranker_feats<span class="token punctuation">,</span> trn_lgb_cls_feats<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> feat <span class="token keyword">in</span> <span class="token punctuation">[</span> <span class="token string">'pred_score'</span><span class="token punctuation">,</span> <span class="token string">'pred_rank'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        col_name <span class="token operator">=</span> feat <span class="token operator">+</span> <span class="token string">'_'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
        finall_trn_ranker_feats<span class="token punctuation">[</span>col_name<span class="token punctuation">]</span> <span class="token operator">=</span> trn_model<span class="token punctuation">[</span>feat<span class="token punctuation">]</span>

<span class="token keyword">for</span> idx<span class="token punctuation">,</span> tst_model <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>tst_lgb_ranker_feats<span class="token punctuation">,</span> tst_lgb_cls_feats<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> feat <span class="token keyword">in</span> <span class="token punctuation">[</span> <span class="token string">'pred_score'</span><span class="token punctuation">,</span> <span class="token string">'pred_rank'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        col_name <span class="token operator">=</span> feat <span class="token operator">+</span> <span class="token string">'_'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
        finall_tst_ranker_feats<span class="token punctuation">[</span>col_name<span class="token punctuation">]</span> <span class="token operator">=</span> tst_model<span class="token punctuation">[</span>feat<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="_434"></a>定义一个逻辑回归模型再次拟合交叉验证产生的特征对测试集进行预测</h4> 
<pre><code class="prism language-python"><span class="token comment"># 这里需要注意的是，在做交叉验证的时候可以构造多一些与输出预测值相关的特征，来丰富这里简单模型的特征</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> LogisticRegression

feat_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'pred_score_0'</span><span class="token punctuation">,</span> <span class="token string">'pred_rank_0'</span><span class="token punctuation">,</span> <span class="token string">'pred_score_1'</span><span class="token punctuation">,</span> <span class="token string">'pred_rank_1'</span><span class="token punctuation">]</span>

trn_x <span class="token operator">=</span> finall_trn_ranker_feats<span class="token punctuation">[</span>feat_cols<span class="token punctuation">]</span>
trn_y <span class="token operator">=</span> finall_trn_ranker_feats<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span>

tst_x <span class="token operator">=</span> finall_tst_ranker_feats<span class="token punctuation">[</span>feat_cols<span class="token punctuation">]</span>

<span class="token comment"># 定义模型</span>
lr <span class="token operator">=</span> LogisticRegression<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 模型训练</span>
lr<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>trn_x<span class="token punctuation">,</span> trn_y<span class="token punctuation">)</span>

<span class="token comment"># 模型预测</span>
finall_tst_ranker_feats<span class="token punctuation">[</span><span class="token string">'pred_score'</span><span class="token punctuation">]</span> <span class="token operator">=</span> lr<span class="token punctuation">.</span>predict_proba<span class="token punctuation">(</span>tst_x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
</code></pre> 
<h4><a id="ensumble_staking_456"></a>ensumble_staking预测结果重新排序及生成提交结果</h4> 
<pre><code class="prism language-python">rank_results <span class="token operator">=</span> finall_tst_ranker_feats<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'pred_score'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
submit<span class="token punctuation">(</span>rank_results<span class="token punctuation">,</span> topk<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> model_name<span class="token operator">=</span><span class="token string">'ensumble_staking'</span><span class="token punctuation">)</span>
</code></pre> 
<p>比赛源自：阿里云天池大赛 - 零基础入门推荐系统 - 新闻推荐</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3e5f0ab5d99d28b266136332d84f5575/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【excel】常用的50个函数与基础操作(统计函数)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/409f7db651f5906bc8370ca731380aae/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Python实用技能】爬虫升级之路：从专用爬虫到用AI Agent实现通用网络爬虫（适合小白）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>