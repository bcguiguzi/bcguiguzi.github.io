<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Java开发学习(四十六)----MyBatisPlus新增语句之id生成策略控制及其简化配置 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Java开发学习(四十六)----MyBatisPlus新增语句之id生成策略控制及其简化配置" />
<meta property="og:description" content="在前面有一篇博客：Java开发学习(四十一)----MyBatisPlus标准数据层（增删查改分页）开发，我们在新增的时候留了一个问题，就是新增成功后，主键ID是一个很长串的内容。
我们更想要的是按照数据库表字段进行自增长，在解决这个问题之前，我们先来分析下ID该如何选择:
不同的表应用不同的id生成策略
日志：自增（1,2,3,4，……）
购物订单：特殊规则（FQ23948AK3843）
外卖单：关联地区日期等信息（10 04 20200314 34 91）
关系表：可省略id
……
不同的业务采用的ID生成方式应该是不一样的，那么在MyBatisPlus中都提供了哪些主键生成策略，以及我们该如何进行选择?
在这里我们又需要用到MyBatisPlus的一个注解叫@TableId
知识点1：@TableId
名称@TableId类型属性注解位置模型类中用于表示主键的属性定义上方作用设置当前类中主键属性的生成策略相关属性value(默认)：设置数据库表主键名称 type:设置主键属性的生成策略，值查照IdType的枚举值 1、环境构建 在构建条件查询之前，我们先来准备下环境
创建一个SpringBoot项目
参考Java开发学习(三十五)----SpringBoot快速入门及起步依赖解析
pom.xml中添加对应的依赖
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt; &lt;project xmlns=&#34;http://maven.apache.org/POM/4.0.0&#34; xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34; xsi:schemaLocation=&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.5.0&lt;/version&gt; &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt; &lt;/parent&gt; &lt;groupId&gt;com.itheima&lt;/groupId&gt; &lt;artifactId&gt;mybatisplus_03_dml&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;/properties&gt; &lt;dependencies&gt; ​ &lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt; &lt;version&gt;3.4.1&lt;/version&gt; &lt;/dependency&gt; ​ &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; ​ &lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;druid&lt;/artifactId&gt; &lt;version&gt;1.1.16&lt;/version&gt; &lt;/dependency&gt; ​ &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;scope&gt;runtime&lt;/scope&gt; &lt;/dependency&gt; ​ &lt;dependency&gt; &lt;groupId&gt;org." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/c4bd272cf8f48e9c5dc04b9b82873327/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-09T20:48:23+08:00" />
<meta property="article:modified_time" content="2023-02-09T20:48:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Java开发学习(四十六)----MyBatisPlus新增语句之id生成策略控制及其简化配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>在前面有一篇博客：<a href="https://www.cnblogs.com/xiaoyh/p/16468175.html" rel="nofollow" id="cb_post_title_url" title="Java开发学习(四十一)----MyBatisPlus标准数据层（增删查改分页）开发">Java开发学习(四十一)----MyBatisPlus标准数据层（增删查改分页）开发</a>，我们在新增的时候留了一个问题，就是新增成功后，主键ID是一个很长串的内容。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/44/ff/ug0Jkxxz_o.png"></p> 
<p>我们更想要的是按照数据库表字段进行自增长，在解决这个问题之前，我们先来分析下ID该如何选择:</p> 
<ul><li> <p>不同的表应用不同的id生成策略</p> 
  <ul><li> <p>日志：自增（1,2,3,4，……）</p> </li><li> <p>购物订单：特殊规则（FQ23948AK3843）</p> </li><li> <p>外卖单：关联地区日期等信息（10 04 20200314 34 91）</p> </li><li> <p>关系表：可省略id</p> </li><li> <p>……</p> </li></ul></li></ul> 
<p>不同的业务采用的ID生成方式应该是不一样的，那么在MyBatisPlus中都提供了哪些主键生成策略，以及我们该如何进行选择?</p> 
<p>在这里我们又需要用到MyBatisPlus的一个注解叫<code>@TableId</code></p> 
<p><strong>知识点1：@TableId</strong></p> 
<table><thead><tr><th>名称</th><th>@TableId</th></tr></thead><tbody><tr><td>类型</td><td><strong>属性注解</strong></td></tr><tr><td>位置</td><td>模型类中用于表示主键的属性定义上方</td></tr><tr><td>作用</td><td>设置当前类中主键属性的生成策略</td></tr><tr><td>相关属性</td><td>value(默认)：设置数据库表主键名称 type:设置主键属性的生成策略，值查照IdType的枚举值</td></tr></tbody></table> 
<h3>1、环境构建</h3> 
<p>在构建条件查询之前，我们先来准备下环境</p> 
<ul><li> <p>创建一个SpringBoot项目</p> </li></ul> 
<p>    参考<a href="https://www.cnblogs.com/xiaoyh/p/16464327.html" rel="nofollow" title="Java开发学习(三十五)----SpringBoot快速入门及起步依赖解析">Java开发学习(三十五)----SpringBoot快速入门及起步依赖解析</a></p> 
<ul><li> <p>pom.xml中添加对应的依赖</p> <pre><code class="language-XML">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.5.0&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
    &lt;/parent&gt;
    &lt;groupId&gt;com.itheima&lt;/groupId&gt;
    &lt;artifactId&gt;mybatisplus_03_dml&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
​
        &lt;dependency&gt;
            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;3.4.1&lt;/version&gt;
        &lt;/dependency&gt;
​
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
        &lt;/dependency&gt;
​
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;druid&lt;/artifactId&gt;
            &lt;version&gt;1.1.16&lt;/version&gt;
        &lt;/dependency&gt;
​
        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
​
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
​
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;version&gt;1.18.12&lt;/version&gt;
        &lt;/dependency&gt;
​
    &lt;/dependencies&gt;
​
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
​
&lt;/project&gt;
​</code></pre> </li><li> <p>编写UserDao接口</p> <pre><code class="language-java">@Mapper
public interface UserDao extends BaseMapper&lt;User&gt; {
}</code></pre> </li><li> <p>编写模型类</p> <pre><code class="language-java">@Data
@TableName("tbl_user")
public class User {
    private Long id;
    private String name;
    @TableField(value="pwd",select=false)
    private String password;
    private Integer age;
    private String tel;
    @TableField(exist=false)
    private Integer online;
}</code></pre> </li><li> <p>编写引导类</p> <pre><code class="language-java">@SpringBootApplication
public class Mybatisplus03DqlApplication {
​
    public static void main(String[] args) {
        SpringApplication.run(Mybatisplus03DqlApplication.class, args);
    }
​
}</code></pre> </li><li> <p>编写配置文件</p> <pre><code># dataSource
spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/mybatisplus_db?serverTimezone=UTC
    username: root
    password: root
# mp日志
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl</code></pre> </li><li> <p>编写测试类</p> <pre><code class="language-java">@SpringBootTest
class Mybatisplus02DqlApplicationTests {
​
    @Autowired
    private UserDao userDao;
    
    @Test
    void testGetAll(){
        List&lt;User&gt; userList = userDao.selectList(null);
        System.out.println(userList);
    }
}</code></pre> </li><li> <p>测试</p> <pre><code class="language-java">@SpringBootTest
class Mybatisplus03DqlApplicationTests {
​
    @Autowired
    private UserDao userDao;
    
}</code></pre> </li><li> <p>最终创建的项目结构为:</p> <p class="img-center"><img alt="" src="https://images2.imgbox.com/62/df/YwzU5oOx_o.png"></p> </li></ul> 
<h3>2、代码演示</h3> 
<p>AUTO策略</p> 
<pre><code class="language-java">@Data
@TableName("tbl_user")
public class User {
    @TableId(type = IdType.AUTO)
    private Long id;
    private String name;
    @TableField(value="pwd",select=false)
    private String password;
    private Integer age;
    private String tel;
    @TableField(exist=false)
    private Integer online;
}</code></pre> 
<p>会发现，新增成功，并且主键id自动增长</p> 
<p>我们会发现<code>AUTO</code>的作用是使用数据库ID自增，在使用该策略的时候一定要确保对应的数据库表设置了ID主键自增，否则无效。</p> 
<p>接下来，我们可以进入源码查看下ID的生成策略有哪些?打开源码后，你会发现并没有看到中文注释，这就需要我们点击右上角的<code>Download Sources</code>,会自动帮你把这个类的java文件下载下来，我们就能看到具体的注释内容。因为这个技术是国人制作的，所以他代码中的注释还是比较容易看懂的。</p> 
<p>当把源码下载完后，就可以看到如下内容:</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/2c/ff/sYYiLN1w_o.png"></p> 
<p>从源码中可以看到，除了AUTO这个策略以外，还有如下几种生成策略:</p> 
<ul><li> <p>NONE: 不设置id生成策略</p> </li><li> <p>INPUT:用户手工输入id</p> </li><li> <p>ASSIGN_ID:雪花算法生成id(可兼容数值型与字符串型)</p> </li><li> <p>ASSIGN_UUID:以UUID生成算法作为id生成策略</p> </li><li> <p>其他的几个策略均已过时，都将被ASSIGN_ID和ASSIGN_UUID代替掉。</p> </li></ul> 
<p><strong>拓展:</strong></p> 
<p>分布式ID是什么?</p> 
<ul><li> <p>当数据量足够大的时候，一台数据库服务器存储不下，这个时候就需要多台数据库服务器进行存储</p> </li><li> <p>比如订单表就有可能被存储在不同的服务器上</p> </li><li> <p>如果用数据库表的自增主键，因为在两台服务器上所以会出现冲突</p> </li><li> <p>这个时候就需要一个全局唯一ID,这个ID就是分布式ID。</p> </li></ul> 
<p>INPUT策略</p> 
<p>步骤1:设置生成策略为INPUT</p> 
<pre><code class="language-java">@Data
@TableName("tbl_user")
public class User {
    @TableId(type = IdType.INPUT)
    private Long id;
    private String name;
    @TableField(value="pwd",select=false)
    private String password;
    private Integer age;
    private String tel;
    @TableField(exist=false)
    private Integer online;
}</code></pre> 
<p><strong>注意:</strong>这种ID生成策略，需要将表的自增策略删除掉</p> 
<p>步骤2:添加数据手动设置ID</p> 
<pre><code class="language-java">@SpringBootTest
class Mybatisplus03DqlApplicationTests {
​
    @Autowired
    private UserDao userDao;
    
    @Test
    void testSave(){
        User user = new User();
        //设置主键ID的值
        user.setId(666L);
        user.setName("黑马程序员");
        user.setPassword("itheima");
        user.setAge(12);
        user.setTel("4006184000");
        userDao.insert(user);
    }
}</code></pre> 
<p>ASSIGN_ID策略</p> 
<p>步骤1:设置生成策略为ASSIGN_ID</p> 
<pre><code class="language-java">@Data
@TableName("tbl_user")
public class User {
    @TableId(type = IdType.ASSIGN_ID)
    private Long id;
    private String name;
    @TableField(value="pwd",select=false)
    private String password;
    private Integer age;
    private String tel;
    @TableField(exist=false)
    private Integer online;
}</code></pre> 
<p>步骤2:添加数据不设置ID</p> 
<pre><code class="language-java">@SpringBootTest
class Mybatisplus03DqlApplicationTests {
​
    @Autowired
    private UserDao userDao;
    
    @Test
    void testSave(){
        User user = new User();
        user.setName("黑马程序员");
        user.setPassword("itheima");
        user.setAge(12);
        user.setTel("4006184000");
        userDao.insert(user);
    }
}</code></pre> 
<p><strong>注意:</strong>这种生成策略，不需要手动设置ID，如果手动设置ID，则会使用自己设置的值。</p> 
<p>生成的ID就是一个Long类型的数据。</p> 
<p>ASSIGN_UUID策略</p> 
<p>步骤1:设置生成策略为ASSIGN_UUID</p> 
<p>使用uuid需要注意的是，主键的类型不能是Long，而应该改成String类型</p> 
<pre><code class="language-java">@Data
@TableName("tbl_user")
public class User {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;
    private String name;
    @TableField(value="pwd",select=false)
    private String password;
    private Integer age;
    private String tel;
    @TableField(exist=false)
    private Integer online;
}</code></pre> 
<p>步骤2:修改表的主键类型</p> 
<p>主键类型设置为varchar，长度要大于32，因为UUID生成的主键为32位，如果长度小的话就会导致插入失败。</p> 
<p>步骤3:添加数据不设置ID</p> 
<pre><code class="language-java">@SpringBootTest
class Mybatisplus03DqlApplicationTests {
​
    @Autowired
    private UserDao userDao;
    
    @Test
    void testSave(){
        User user = new User();
        user.setName("黑马程序员");
        user.setPassword("itheima");
        user.setAge(12);
        user.setTel("4006184000");
        userDao.insert(user);
    }
}</code></pre> 
<p>接下来我们来聊一聊雪花算法:</p> 
<p>雪花算法(SnowFlake),是Twitter官方给出的算法实现 是用Scala写的。其生成的结果是一个64bit大小整数，它的结构如下图:</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/6d/47/nJn7JIkZ_o.png"></p> 
<ol><li> <p>1bit,不用,因为二进制中最高位是符号位，1表示负数，0表示正数。生成的id一般都是用整数，所以最高位固定为0。</p> </li><li> <p>41bit-时间戳，用来记录时间戳，毫秒级</p> </li><li> <p>10bit-工作机器id，用来记录工作机器id,其中高位5bit是数据中心ID其取值范围0-31，低位5bit是工作节点ID其取值范围0-31，两个组合起来最多可以容纳1024个节点</p> </li><li> <p>序列号占用12bit，每个节点每毫秒0开始不断累加，最多可以累加到4095，一共可以产生4096个ID</p> </li></ol> 
<h3>3、ID生成策略对比</h3> 
<p>介绍了这些主键ID的生成策略，我们以后该用哪个呢?</p> 
<ul><li> <p>NONE: 不设置id生成策略，MyBatisPlus不自动生成，约等于INPUT,所以这两种方式都需要用户手动设置，但是手动设置第一个问题是容易出现相同的ID造成主键冲突，为了保证主键不冲突就需要做很多判定，实现起来比较复杂</p> </li><li> <p>AUTO:数据库ID自增,这种策略适合在数据库服务器只有1台的情况下使用,不可作为分布式ID使用</p> </li><li> <p>ASSIGN_UUID:可以在分布式的情况下使用，而且能够保证唯一，但是生成的主键是32位的字符串，长度过长占用空间而且还不能排序，查询性能也慢</p> </li><li> <p>ASSIGN_ID:可以在分布式的情况下使用，生成的是Long类型的数字，可以排序性能也高，但是生成的策略和服务器时间有关，如果修改了系统时间就有可能导致出现重复主键</p> </li><li> <p>综上所述，每一种主键策略都有自己的优缺点，根据自己项目业务的实际情况来选择使用才是最明智的选择。</p> </li></ul> 
<h3>4、简化配置</h3> 
<p>模型类主键策略设置</p> 
<p>对于主键ID的策略已经介绍完，但是如果要在项目中的每一个模型类上都需要使用相同的生成策略，如:</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/50/21/rUpLIKEc_o.png"></p> 
<p>确实是稍微有点繁琐，我们能不能在某一处进行配置，就能让所有的模型类都可以使用该主键ID策略呢?</p> 
<p>答案是肯定有，我们只需要在配置文件中添加如下内容:</p> 
<pre><code>mybatis-plus:
  global-config:
    db-config:
        id-type: assign_id</code></pre> 
<p>配置完成后，每个模型类的主键ID策略都将成为assign_id.</p> 
<p>数据库表与模型类的映射关系</p> 
<p>MyBatisPlus会默认将模型类的类名名首字母小写作为表名使用，假如数据库表的名称都以<code>tbl_</code>开头，那么我们就需要将所有的模型类上添加<code>@TableName</code>，如:</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ca/ba/i7K3J6jO_o.png"></p> 
<p>配置起来还是比较繁琐，简化方式为在配置文件中配置如下内容:</p> 
<pre><code>mybatis-plus:
  global-config:
    db-config:
        table-prefix: tbl_</code></pre> 
<p>设置表的前缀内容，这样MyBatisPlus就会拿 <code>tbl_</code>加上模型类的首字母小写，就刚好组装成数据库的表名。</p> 
<h4></h4> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9f887d98f6a8ec0e1c6249e9f3a3f2fa/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue2仿网易云风格音乐播放器（附源码）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cef23d747b3cd651b02b6d747aae53d7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决SSL routines:ssl3_get_record:wrong version number</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>