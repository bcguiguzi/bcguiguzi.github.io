<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>qemu与gdb内核调试环境搭建 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="qemu与gdb内核调试环境搭建" />
<meta property="og:description" content="调试环境基于韦东山系列开发板IMX6ull虚拟环境搭建，韦东山给了详细的教程Qemu - 百问网嵌入式Linux wiki 。本篇文章主要是研究linux-4.9.88内核的基本架构，所以不对开发相关驱动进行太多的研究，所以整理出来的也是内核从编译到开发基本路径。环境基于Ubuntu18.04系统，可以通过VMware&#43;Ubuntu的形式搭建环境，也可以直接使用独立的服务器Ubuntu进行。
1. qemu环境下载与配置 1.1 下载qemu整个开发包 在视频中演示的方法可能是直接下载压缩包，但是由于GIT仓库改版，只能使用下面方法下载使用GIT clone方式下载 请在ubuntu终端下执行如下命令，直接在线克隆整个仓库
git clone https://e.coding.net/weidongshan/ubuntu-16.04_imx6ul_qemu_system.git 如果使用GIT命令失败，有如下提示时 fatal: Out of memory, malloc failed (tried to allocate 314572801 bytes) fatal: index-pack failed 先执行下列命令增加swap分区
sudo dd if=/dev/zero of=/root/myswapfile bs=1M count=1024 sudo chmod 600 /root/myswapfile sudo mkswap /root/myswapfile sudo swapon /root/myswapfile 然后修改/etc/fstab，增加如下一行
/root/myswapfile swap swap defaults 0 0 最后重新执行上面的GIT命令进行下载，下载结束以后下载包镜像目录结构说明如下，在后续的开发过程中，我们有可能更换红框中的文件：
1.2 运行QEMU系统 假设你已经按照上文下载、解压好了QEMU镜像文件，你需要进入QEMU的目录，执行下列命令。
首次运行需要安装SDL环境
使用脚本自动解压安装：
$./install_sdl.sh // 提示输入用户密码，等待安装完成 如果出现报错 Package xxxx is not installed.，可使用apt命令修复：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/13d1802625ac8b9a5d95ac5870184382/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-31T15:52:53+08:00" />
<meta property="article:modified_time" content="2022-08-31T15:52:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">qemu与gdb内核调试环境搭建</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>调试环境基于韦东山系列开发板IMX6ull虚拟环境搭建，韦东山给了详细的教程<a href="http://wiki.100ask.org/Qemu#Part_B._QEMU.E5.BC.80.E5.8F.91.E6.89.8B.E5.86.8C" rel="nofollow" title="Qemu - 百问网嵌入式Linux wiki">Qemu - 百问网嵌入式Linux wiki</a> 。本篇文章主要是研究linux-4.9.88内核的基本架构，所以不对开发相关驱动进行太多的研究，所以整理出来的也是内核从编译到开发基本路径。环境基于Ubuntu18.04系统，可以通过VMware+Ubuntu的形式搭建环境，也可以直接使用独立的服务器Ubuntu进行。</p> 
<h3>1. qemu环境下载与配置</h3> 
<h4>1.1 下载qemu整个开发包</h4> 
<ul><li>在视频中演示的方法可能是直接下载压缩包，但是由于GIT仓库改版，只能使用下面方法下载</li><li>使用GIT clone方式下载</li></ul> 
<p>请在ubuntu终端下执行如下命令，直接在线克隆整个仓库</p> 
<pre><code>git  clone  https://e.coding.net/weidongshan/ubuntu-16.04_imx6ul_qemu_system.git</code></pre> 
<ul><li>如果使用GIT命令失败，有如下提示时</li></ul> 
<pre><code>fatal: Out of memory, malloc failed (tried to allocate 314572801 bytes)
fatal: index-pack failed</code></pre> 
<p>先执行下列命令增加swap分区</p> 
<pre><code>sudo dd if=/dev/zero of=/root/myswapfile bs=1M count=1024
sudo chmod 600 /root/myswapfile
sudo mkswap /root/myswapfile
sudo swapon /root/myswapfile</code></pre> 
<p>然后修改/etc/fstab，增加如下一行</p> 
<pre><code>/root/myswapfile               swap                    swap    defaults        0 0</code></pre> 
<p>最后重新执行上面的GIT命令进行下载，下载结束以后下载包镜像目录结构说明如下，在后续的开发过程中，我们有可能更换红框中的文件：</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/e3/62/0lbopC9N_o.png"></p> 
<h4>1.2 运行QEMU系统</h4> 
<p>假设你已经按照上文下载、解压好了QEMU镜像文件，你需要进入QEMU的目录，执行下列命令。</p> 
<p>首次运行需要安装SDL环境</p> 
<p>使用脚本自动解压安装：</p> 
<pre><code>    $./install_sdl.sh // 提示输入用户密码，等待安装完成</code></pre> 
<p>如果出现报错 <em>Package xxxx is not installed.</em>，可使用apt命令修复：</p> 
<pre><code>    $sudo apt --fix-broken install</code></pre> 
<p> 运行带GUI的imx6ul模拟器，模拟百问网imx6ull-qemu开发板</p> 
<pre><code>    $./qemu-imx6ull-gui.sh // 启动后，登录名是root，无需密码</code></pre> 
<p>如上命令可能出现ERROR: Could not initialize SDL video.问题，目前没有查看具体解决原因，在进行linux内核调试中不需要使用中断界面的形式，而是命令行输出的形式。</p> 
<p>在目录中修改 qemu-imx6ull-nogui.sh 脚本添加-s -S使得GDB启动本地127IP调试端口1234，这样可以在另外一个串口中进行内核内容加载与调试。然后运行这个脚本就会启动调试终端并卡在了如下命令，这个时候需要在另外一个终端通过gdb挂在本终端上面进行内核文件的调试。下面就下一个打的流程，将我们要调试的linux内核文件编译出来。</p> 
<pre><code>book@100ask:~/ubuntu-18.04_imx6ul_qemu_system$ ./qemu-imx6ull-nogui.sh 
qemu-system-arm: warning: nic imx.enet.0 has no peer
qemu-system-arm: warning: nic imx.enet.1 has no peer</code></pre> 
<h3>2. linux内核编译</h3> 
<h4>2.1.安装kvm</h4> 
<pre><code>sudo apt-get update
sudo apt-get install qemu qemu-kvm libvirt-bin bridge-utils virt-manager</code></pre> 
<p><br> 注：可以起到加速的效果</p> 
<p>2.2.获取百问网imx6ull-qemu开发镜像</p> 
<pre><code>git clone https://e.coding.net/weidongshan/ubuntu-16.04_imx6ul_qemu_system.git
git clone https://e.coding.net/weidongshan/ubuntu-18.04_imx6ul_qemu_system.git</code></pre> 
<p>注：对应不同的ubuntu系统</p> 
<p>2.3.运行百问网imx6ull-qemu开发镜像</p> 
<pre><code>./install_sdl.sh
./qemu-imx6ull-gui.sh</code></pre> 
<p>2. 4.获取百问网imx6ull-qemu开发板内核源码和工具链</p> 
<pre><code>book\@100ask:\~\$ git clone https://e.coding.net/codebug8/repo.git
book\@100ask:\~\$ mkdir -p 100ask_imx6ull-qemu &amp;&amp; cd 100ask_imx6ull-qemu
book\@100ask:\~/100ask_imx6ull-qemu\$ ../repo/repo init -u https://e.coding.net/weidongshan/manifests.git -b linux-sdk -m  imx6ull/100ask-imx6ull_qemu_release_v1.0.xml --no-repo-verify
book\@100ask:\~/100ask_imx6ull-qemu\$ ../repo/repo sync -j4</code></pre> 
<p>2.5.下载百问网快速入门资料<br> git clone https://e.coding.net/weidongshan/01_all_series_quickstart.git</p> 
<p>2.6.设置环境变量</p> 
<p>环境变量生效方式有永久、临时和当前终端这么三种方式，分别配置方式如下：<br> 永久生效</p> 
<pre><code>book\@100ask:\~\$ vi ~/.bashrc</code></pre> 
<p>在行尾添加或修改：</p> 
<pre><code>export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-
export PATH=$PATH:/home/book/100ask_imx6ull-qemu/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin
</code></pre> 
<p>使环境变量生效：</p> 
<pre><code>    source ~/.bashrc</code></pre> 
<p>临时生效<br> 如果你有很多单板，为了不冲突，你不能使用“永久生效”的办法。比如你有32位的ARM板，也有64位的ARM板，在使用前者时需要设置ARCH=arm，在使用后者时需要设置ARCH=arm64。<br> 这种情况下，可以使用“export”命令设置环境变量，这种设置方法只对当前终端有效：</p> 
<pre><code>book\@100ask:\~\$ export PATH=$PATH:/home/book/100ask_imx6ull-qemu/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin
book\@100ask:\~\$ export ARCH=arm
book\@100ask:\~\$ export CROSS_COMPILE=arm-linux-gnueabihf-</code></pre> 
<p><br> 手动指定<br> 执行make命令时，可以手工指定ARCH架构、CROSS_COMPILE等变量：</p> 
<pre><code>book\@100ask:\~\$ export PATH=$PATH:/home/book/100ask_imx6ull-qemu/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin
book\@100ask:\~\$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf-</code></pre> 
<p>2.7.为了后续编译驱动，需要先编译内核</p> 
<pre><code>book\@100ask:\~/100ask_imx6ull-qemu\$ cd linux-4.9.88
book\@100ask:\~/100ask_imx6ull-qemu/linux-4.9.88\$ make mrproper
book\@100ask:\~/100ask_imx6ull-qemu/linux-4.9.88\$ make 100ask_imx6ull_qemu_defconfig
book\@100ask:\~/100ask_imx6ull-qemu/linux-4.9.88\$ make zImage -jN //编译zImage内核镜像，其中N参数可以根据CPU个数，来加速编译系统。
book\@100ask:\~/100ask_imx6ull-qemu/linux-4.9.88\$ make dtbs //编译设备树文件</code></pre> 
<p>内核编译过程中我们是要对内核进行调试的，所有需要对内核进行调试开关打开的修改，具体是打开调试开关的vmlinux输出文件大小在150M左右，没有打开大概再30M左右。</p> 
<p>1.配置内核<br> Kernel hacking ---&gt;</p> 
<p>        Compile-time checks and compiler options  ---&gt;</p> 
<p>                [*] Compile the kernel with debug info </p> 
<p>                [*]   Provide GDB scripts for kernel debugging </p> 
<p>        [*] Kernel debugging </p> 
<p>配置完重新编译内核。当然韦东山给的已经是打开这个开关的版本。具体可以通过便已结束以后的</p> 
<p>注：为了后续编译驱动，需要先编译内核</p> 
<p></p> 
<p>2.8.编译驱动<br> 测试驱动为此目录下的led驱动，可以稍作修改，然后编译<br> 01_all_series_quickstart/05_嵌入式Linux驱动开发基础知识/source/02_led_drv/02_led_drv_for_boards/100ask_imx6ull-qemu_src_bin</p> 
<p>9.上传驱动以及应用程序<br> ubuntu主机启动nfs<br> sudo apt-get install nfs-kernel-server<br> 修改/etc/exports，添加类似以下的内容，<br> /home/book *(rw,nohide,insecure,no_subtree_check,async,no_root_squash)<br> /work *(rw,nohide,insecure,no_subtree_check,async,no_root_squash)<br> 注:以上的例子里允许开发板通过NFS访问Ubuntu的/home/book、/work两个目录<br> ubuntu主机 重启nfs<br> sudo /etc/init.d/nfs-kernel-server restart<br> ubuntu主机 测试nfs<br> 可以在Ubuntu上通过NFS挂载自己，验证一下NFS可用：<br> sudo mount -t nfs -o nolock,vers=3 127.0.0.1:/home/book /mnt<br> ls /mnt</p> 
<p>开发板配置网络<br> QEMU运行时，Ubuntu是Host即宿主机，QEMU给它分配的IP是10.0.2.2。<br> QEMU模拟的imx6ull板子是Guest即客户机，它会自动获取IP，也可以自己设置。<br> Guest可以通过10.0.2.2访问Host，Host不能访问Guest。<br> Guest中可以使用ifconfig命令查看IP，如果没有IP，可以如下设置：<br> [root@qemu_imx6ul:~]# ifconfig eth0 10.0.2.15<br> 开发板挂载主机nfs目录<br> QEMU模拟的imx6ull开发板，可以去访问10.0.2.2，比如使用NFS挂载：<br> [root@qemu_imx6ul:~]# mount -t nfs -o nolock,vers=3 10.0.2.2:/home/book/nfs_rootfs /mnt<br> 如果一切正常，在开发板上就可以通过/mnt目录访问Ubuntu的/home/book/nfs_rootfs目录了。</p> 
<p>10.更换文件系统<br> 如果你修改过内核，或是修改过设备树文件。<br> 那么可以用上面2个文件去替换QEMU中的zImage和100ask_imx6ull_qemu.dtb。<br> QEMU中的zImage和100ask_imx6ull_qemu.dtb，通过打开qemu-imx6ull-gui.sh就可以知道这2个文件的位置，一般是位于imx6ull-system-image目录<br> 安装好百问网提供的QEMU后，你可以得到一个imx6ull-system-image目录，里面有名为rootfs.img的文件，它就是根文件系统：<br> 你可以在Ubuntu下直接修改rootfs.img，不过要先挂载，执行以下命令：<br> sudo mount -o loop rootfs.img /mnt<br> 你就可以在/mnt目录下对其中的文件进行操作了，也可以把Ubuntu中的文件复制进去。<br> 注意：修改完毕后，要执行以下命令：<br> sudo umount /mnt</p> 
<h3>3. 调试启动与开发</h3> 
<p>在一个中断中启动调试 ./qemu-imx6ull-nogui.sh 接口，然后再另外一个终端中启动需要调试的程序，这个中断具体启动界面见下图：</p> 
<p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/ad/49/dBsUH9XG_o.png"></p> 
<p></p> 
<pre><code class="hljs">arm-linux-gnueabihf-gdb vmlinux
target remote 127.0.0.1:1234
b start_kernel
c</code></pre> 
<p>启动以后会发现在当前调试中断进行函数和整个代码流程打断点等内容调试，在原来那个中断中会有内核内部许多打印函数的输出信息打印出来。两个中断配合完成linux-4.9学习。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/83b950211f482db6a9552ae7eb831ccd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">网页开发基础之HTML最常见的标记汇总</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8e2ca4ca0fa783deb450220a463ef44d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vm虚拟机安装centos7</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>