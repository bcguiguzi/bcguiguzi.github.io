<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>二层交换机转发原理 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="二层交换机转发原理" />
<meta property="og:description" content="1 目录
1 802.1Q定义
1.1 LAN
1.2 VLAN
1.2.1 VLAN定义
1.2.2 802.1Q tag
2 二层转发流程
当报文中的源mac在mac地址表中不存在时，会生成新的mac地址表项。
5 出口vlan过滤
6 出口vlan处理
2.2 Vlan Table的内容
2.3 PVID
2.1 Mac地址表的学习
2.1 Mac地址表的洪泛
2.1 单播与广播
2.2 Mac地址表的查找
2.3 Mac地址表的老化
2.4 Mac地址表的迁移
2.6 Mac地址表的冲突
2.7 Mac地址表的特殊机制
2.5.1 Mac地址表的源查找
2.5.2 Mac地址表的Class ID
2.5.3 Mac地址表的源hit
3 IVL与SVL
4 Acces .Trunk.Hybird
1 定义 1.1 LAN LAN(Local Area Network):局域网，同一个局域网内的终端可以通信。
1.2 VLAN 1.2.1 VLAN定义 VLAN(Virtual LAN)：即虚拟局域网，这项技术可以根据功能、应用或者管理的需要将局域网内部的设备逻辑地划分到一个个网段中，从而形成一个个虚拟的工作组，并且不需要考虑设备的实际物理位置。 IEEE 颁布了 IEEE802.1Q 协议以规定标准化VLAN 的实现方案，交换机的 VLAN 功能即按照 802." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/171ca6391f6ba035da8bcfab625c2333/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-29T16:41:41+08:00" />
<meta property="article:modified_time" content="2022-04-29T16:41:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">二层交换机转发原理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 id="1%20802.1Q%E5%AE%9A%E4%B9%89">1</h2> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="1%20802.1Q%E5%AE%9A%E4%B9%89-toc" style="margin-left:0px;"><a href="#1%20802.1Q%E5%AE%9A%E4%B9%89" rel="nofollow">1 802.1Q定义</a></p> 
<p id="1.1%20LAN-toc" style="margin-left:40px;"><a href="#1.1%20LAN" rel="nofollow">1.1 LAN</a></p> 
<p id="1.2%20VLAN-toc" style="margin-left:40px;"><a href="#1.2%20VLAN" rel="nofollow">1.2 VLAN</a></p> 
<p id="%C2%A0%20%C2%A0%201.2.1%C2%A0%20%C2%A0VLAN%E5%AE%9A%E4%B9%89-toc" style="margin-left:80px;"><a href="#%C2%A0%20%C2%A0%201.2.1%C2%A0%20%C2%A0VLAN%E5%AE%9A%E4%B9%89" rel="nofollow">    1.2.1   VLAN定义</a></p> 
<p id="%C2%A0%20%C2%A0%201.2.2%C2%A0%20%C2%A0802.1Q%C2%A0tag-toc" style="margin-left:80px;"><a href="#%C2%A0%20%C2%A0%201.2.2%C2%A0%20%C2%A0802.1Q%C2%A0tag" rel="nofollow">    1.2.2   802.1Q tag</a></p> 
<p id="2%20%E4%BA%8C%E5%B1%82%E8%BD%AC%E5%8F%91%E6%B5%81%E7%A8%8B-toc" style="margin-left:40px;"><a href="#2%20%E4%BA%8C%E5%B1%82%E8%BD%AC%E5%8F%91%E6%B5%81%E7%A8%8B" rel="nofollow">2 二层转发流程</a></p> 
<p id="%C2%A0%20%C2%A0%E5%BD%93%E6%8A%A5%E6%96%87%E4%B8%AD%E7%9A%84%E6%BA%90mac%E5%9C%A8mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E4%B8%AD%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%97%B6%EF%BC%8C%E4%BC%9A%E7%94%9F%E6%88%90%E6%96%B0%E7%9A%84mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E9%A1%B9%E3%80%82-toc" style="margin-left:80px;"><a href="#%C2%A0%20%C2%A0%E5%BD%93%E6%8A%A5%E6%96%87%E4%B8%AD%E7%9A%84%E6%BA%90mac%E5%9C%A8mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E4%B8%AD%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%97%B6%EF%BC%8C%E4%BC%9A%E7%94%9F%E6%88%90%E6%96%B0%E7%9A%84mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E9%A1%B9%E3%80%82" rel="nofollow">   当报文中的源mac在mac地址表中不存在时，会生成新的mac地址表项。</a></p> 
<p id="%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%205%20%E5%87%BA%E5%8F%A3vlan%E8%BF%87%E6%BB%A4-toc" style="margin-left:80px;"><a href="#%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%205%20%E5%87%BA%E5%8F%A3vlan%E8%BF%87%E6%BB%A4" rel="nofollow">          5 出口vlan过滤</a></p> 
<p id="%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A06%20%E5%87%BA%E5%8F%A3vlan%E5%A4%84%E7%90%86-toc" style="margin-left:80px;"><a href="#%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A06%20%E5%87%BA%E5%8F%A3vlan%E5%A4%84%E7%90%86" rel="nofollow">           6 出口vlan处理</a></p> 
<p id="%C2%A0%20%C2%A0%20%C2%A0%202.2%C2%A0Vlan%20Table%E7%9A%84%E5%86%85%E5%AE%B9-toc" style="margin-left:40px;"><a href="#%C2%A0%20%C2%A0%20%C2%A0%202.2%C2%A0Vlan%20Table%E7%9A%84%E5%86%85%E5%AE%B9" rel="nofollow">      2.2 Vlan Table的内容</a></p> 
<p id="%C2%A0%20%C2%A0%20%C2%A0%202.3%20PVID-toc" style="margin-left:40px;"><a href="#%C2%A0%20%C2%A0%20%C2%A0%202.3%20PVID" rel="nofollow">      2.3 PVID</a></p> 
<p id="%C2%A0%20%C2%A0%20%C2%A02.1%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E5%AD%A6%E4%B9%A0-toc" style="margin-left:0px;"><a href="#%C2%A0%20%C2%A0%20%C2%A02.1%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E5%AD%A6%E4%B9%A0" rel="nofollow">     2.1 Mac地址表的学习</a></p> 
<p id="2.1%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E6%B4%AA%E6%B3%9B-toc" style="margin-left:40px;"><a href="#2.1%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E6%B4%AA%E6%B3%9B" rel="nofollow">2.1 Mac地址表的洪泛</a></p> 
<p id="2.1%20%E5%8D%95%E6%92%AD%E4%B8%8E%E5%B9%BF%E6%92%AD-toc" style="margin-left:40px;"><a href="#2.1%20%E5%8D%95%E6%92%AD%E4%B8%8E%E5%B9%BF%E6%92%AD" rel="nofollow">2.1 单播与广播</a></p> 
<p id="2.2%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E6%9F%A5%E6%89%BE-toc" style="margin-left:40px;"><a href="#2.2%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E6%9F%A5%E6%89%BE" rel="nofollow">2.2 Mac地址表的查找</a></p> 
<p id="2.3%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E8%80%81%E5%8C%96-toc" style="margin-left:40px;"><a href="#2.3%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E8%80%81%E5%8C%96" rel="nofollow">2.3 Mac地址表的老化</a></p> 
<p id="2.4%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E8%BF%81%E7%A7%BB-toc" style="margin-left:40px;"><a href="#2.4%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E8%BF%81%E7%A7%BB" rel="nofollow">2.4 Mac地址表的迁移</a></p> 
<p id="2.6%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E5%86%B2%E7%AA%81-toc" style="margin-left:40px;"><a href="#2.6%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E5%86%B2%E7%AA%81" rel="nofollow">2.6 Mac地址表的冲突</a></p> 
<p id="2.7%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E7%89%B9%E6%AE%8A%E6%9C%BA%E5%88%B6-toc" style="margin-left:40px;"><a href="#2.7%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E7%89%B9%E6%AE%8A%E6%9C%BA%E5%88%B6" rel="nofollow">2.7 Mac地址表的特殊机制</a></p> 
<p id="2.5.1%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E6%BA%90%E6%9F%A5%E6%89%BE-toc" style="margin-left:80px;"><a href="#2.5.1%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E6%BA%90%E6%9F%A5%E6%89%BE" rel="nofollow">2.5.1 Mac地址表的源查找</a></p> 
<p id="2.5.2%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84Class%20ID-toc" style="margin-left:80px;"><a href="#2.5.2%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84Class%20ID" rel="nofollow">2.5.2 Mac地址表的Class ID</a></p> 
<p id="2.5.3%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E6%BA%90hit-toc" style="margin-left:80px;"><a href="#2.5.3%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E6%BA%90hit" rel="nofollow">2.5.3 Mac地址表的源hit</a></p> 
<p id="3%20IVL%E4%B8%8ESVL-toc" style="margin-left:0px;"><a href="#3%20IVL%E4%B8%8ESVL" rel="nofollow">3 IVL与SVL</a></p> 
<p id="4%20Acces%20.Trunk.Hybird-toc" style="margin-left:0px;"><a href="#4%20Acces%20.Trunk.Hybird" rel="nofollow">4 Acces .Trunk.Hybird</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2>1 定义</h2> 
<h3 id="1.1%20LAN">1.1 LAN</h3> 
<p>LAN(Local Area Network):局域网，同一个局域网内的终端可以通信。</p> 
<h3 id="1.2%20VLAN">1.2 VLAN</h3> 
<h4 id="%C2%A0%20%C2%A0%201.2.1%C2%A0%20%C2%A0VLAN%E5%AE%9A%E4%B9%89">    1.2.1   VLAN定义</h4> 
<p>    VLAN(Virtual LAN)：即虚拟局域网，这项技术可以根据功能、应用或者管理的需要将局域网内部的设备逻辑地划分到一个个网段中，从而形成一个个虚拟的工作组，并且不需要考虑设备的实际物理位置。 IEEE 颁布了 IEEE802.1Q 协议以规定标准化VLAN 的实现方案，交换机的 VLAN 功能即按照 802.1Q 的标准实现。VLAN 技术的特点在于可以根据需要动态的将一个大的局域网划分成许多不同的广播域。</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" src="https://images2.imgbox.com/ba/9f/DSyMOqdO_o.jpg"></p> 
<p>        每个广播域即一个VLAN，VLAN和物理上的局域网有相同的属性，不同之处只在于VLAN是逻辑的而不是物理的划分，所以VLAN的划分不必根据实际的物理位置，而每个VLAN内部的广播、组播和单播流量都是与其它VLAN隔绝的。</p> 
<h4 id="%C2%A0%20%C2%A0%201.2.2%C2%A0%20%C2%A0802.1Q%C2%A0tag">    1.2.2   802.1Q tag</h4> 
<p>       802.1q定义了tag（标签），通过比较报文标签中VID与本端口中的VID信息来决定是否丢弃报文，来实现虚拟VLAN的功能。</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/f2/27/l6IKjgxN_o.jpg"></p> 
<p></p> 
<p>     <strong>标签协议识别符</strong>(Tag Protocol Identifier, TPID):交换芯片通过该字段来判断是否为T带有Tag，如果为TAG报文，会将后续的2个字节解析成Priority和VID。通常情况下，这个字段为0X8100，表明通过0X8100来识别VID，另外常用的有0X9100/0X9200/0X8200等。</p> 
<p>   交换芯片通常支持多个TPID的使用，能够同时将多种TPID值的报文识别成Tag报文。</p> 
<p>    <strong>优先权代码点</strong>(Priority Code Point, PCP): 以一组3比特的域当作<a href="https://baike.baidu.com/item/IEEE%20802.1p" rel="nofollow" title="IEEE 802.1p">IEEE 802.1p</a>优先权的参考，优先级通常应用于交换机QoS，当发生拥塞时，根据PCP来调度报文，除了PCP以外，IP报文中的DSCP和MPLS报文中的EXP都可以用来做优先级使用。</p> 
<p>    <strong> CFI:</strong>为0表示MAC地址以标准格式进行封装，为1表示MAC地址以非标准格式进行封装。</p> 
<p>     <strong>VID</strong>:长度为12bit，范围为0~4095。由于0和4095位保留值，所以VID的范围为1~4094。</p> 
<p></p> 
<h2 id="2%20%E4%BA%8C%E5%B1%82%E8%BD%AC%E5%8F%91%E6%B5%81%E7%A8%8B">2 二层转发流程</h2> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/3e/3e/ZBxOf7Y9_o.jpg"></p> 
<p>     如图所示，报文从E1端口进入以后，要经过以下步骤：</p> 
<p>   <em><strong>       1 PVID处理</strong></em></p> 
<p>             如果从端口收到的报文是untag报文，需要给报文加上一层Vlan Tag，其中的Vid就是端口PVID的值。</p> 
<p>           为什么需要PVID呢？因为<span style="color:#ed7976;"><strong>交换芯片内部处理的报文都是要带Vlan</strong></span>的，交换芯片的Mac地址学习、Vlan过滤都需要根据报文中的VID来完成。</p> 
<p>          <span style="color:#fe2c24;"><strong>PVID的作用是端口给Untag报文打上的VLan ID。</strong></span></p> 
<p>           如果从端口收到的报文是tag报文，则无需PVID处理。 </p> 
<pre><code>        查看BCM的PVID信息如：
BCM.0&gt; pvlan
Port ge0 default VLAN is 1
Port ge1 default VLAN is 1
Port ge2 default VLAN is 1
Port ge3 default VLAN is 100
Port ge4 default VLAN is 100
Port ge5 default VLAN is 100
Port ge6 default VLAN is 1
Port ge7 default VLAN is 1
Port ge8 default VLAN is 1000
Port ge9 default VLAN is 1
Port ge10 default VLAN is 555
Port ge11 default VLAN is 1
Port ge12 default VLAN is 1
Port ge13 default VLAN is 666
Port ge14 default VLAN is 1
Port ge15 default VLAN is 3000
Port ge16 default VLAN is 1
</code></pre> 
<p></p> 
<p><em><strong>           2 入口Vlan过滤</strong></em></p> 
<p>             Vlan过滤功能由Vlan表来完成，Vlan表的内容描述某个Vlan包含了哪些端口以及报文从该端口发出时，是否剥掉tag。</p> 
<p><img alt="" height="127" src="https://images2.imgbox.com/b2/d4/CjvVE7ew_o.png" width="702"></p> 
<p></p> 
<p>             例如，从端口E1收到的报文Vlan为1000（或者说untag报文打上了PVID 1000），但VLan表中的VLan 100中没有E1端口，就会把该报文丢弃（过滤），如果VLan表中的VLan 100中有E1端口，则会进入后续的流程。            </p> 
<p></p> 
<pre><code>查看BCM 的vlan信息：
BCM.0&gt; vlan show 
vlan 198        ports ge21,hg (0x00000000000000000000000000000000000000000000000000c4000000400000), untagged none (0x0000000000000000000000000000000000000000000000000000000000000000) MCAST_FLOOD_UNKNOWN
vlan 199        ports ge21,hg (0x00000000000000000000000000000000000000000000000000c4000000400000), untagged none (0x0000000000000000000000000000000000000000000000000000000000000000) MCAST_FLOOD_UNKNOWN
vlan 200        ports ge21,hg (0x00000000000000000000000000000000000000000000000000c4000000400000), untagged none (0x0000000000000000000000000000000000000000000000000000000000000000) MCAST_FLOOD_UNKNOWN
vlan 300        ports ge21,hg (0x00000000000000000000000000000000000000000000000000c4000000400000), untagged ge21 (0x0000000000000000000000000000000000000000000000000000000000400000) MCAST_FLOOD_UNKNOWN
vlan 400        ports ge21,hg (0x00000000000000000000000000000000000000000000000000c4000000400000), untagged none (0x0000000000000000000000000000000000000000000000000000000000000000) MCAST_FLOOD_UNKNOWN
vlan 555        ports ge10,ge21,hg (0x00000000000000000000000000000000000000000000000000c4000000400800), untagged ge10 (0x0000000000000000000000000000000000000000000000000000000000000800) MCAST_FLOOD_UNKNOWN
vlan 666        ports ge13,ge21,hg (0x00000000000000000000000000000000000000000000000000c4000000404000), untagged ge13 (0x0000000000000000000000000000000000000000000000000000000000004000) MCAST_FLOOD_UNKNOWN
vlan 777        ports ge21,hg (0x00000000000000000000000000000000000000000000000000c4000000400000), untagged none (0x0000000000000000000000000000000000000000000000000000000000000000) MCAST_FLOOD_UNKNOWN
vlan 1000       ports ge8,ge21,hg (0x00000000000000000000000000000000000000000000000000c4000000400200), untagged ge8 (0x0000000000000000000000000000000000000000000000000000000000000200) MCAST_FLOOD_UNKNOWN
vlan 2000       ports ge21,hg (0x00000000000000000000000000000000000000000000000000c4000000400000), untagged none (0x0000000000000000000000000000000000000000000000000000000000000000) MCAST_FLOOD_UNKNOWN
vlan 3000       ports ge15,ge21,hg (0x00000000000000000000000000000000000000000000000000c4000000410000), untagged ge15 (0x0000000000000000000000000000000000000000000000000000000000010000) MCAST_FLOOD_UNKNOWN
vlan 4095       ports hg (0x00000000000000000000000000000000000000000000000000c4000000000000), untagged none (0x0000000000000000000000000000000000000000000000000000000000000000) MCAST_FLOOD_UNKNOWN</code></pre> 
<p> <em><strong>         3 mac地址学习</strong></em></p> 
<p>           mac地址学习是根据报文的<strong>源mac、源端口</strong>生成mac表项。</p> 
<p>           mac地址表项描述了mac地址在哪个接口，mac地址表的作用是用于转发。</p> 
<pre><code>BCM下的mac地址表
BCM.0&gt;  l2 show
mac=00:01:02:03:33:22 vlan=666 GPORT=0xe modid=2 port=14/ge13 Hit
mac=00:03:0e:23:55:75 vlan=666 GPORT=0xe modid=2 port=14/ge13 Hit
mac=00:03:0f:00:11:11 vlan=1000 GPORT=0x0 modid=255 port=0   Static Hit
mac=00:03:0f:00:11:11 vlan=666 GPORT=0x0 modid=255 port=0   Static
mac=00:03:0f:b1:10:12 vlan=666 GPORT=0xe modid=2 port=14/ge13 Hit
mac=24:69:68:7b:be:2a vlan=1000 GPORT=0x9 modid=2 port=9/ge8 Hit</code></pre> 
<h4 id="%C2%A0%20%C2%A0%E5%BD%93%E6%8A%A5%E6%96%87%E4%B8%AD%E7%9A%84%E6%BA%90mac%E5%9C%A8mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E4%B8%AD%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%97%B6%EF%BC%8C%E4%BC%9A%E7%94%9F%E6%88%90%E6%96%B0%E7%9A%84mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E9%A1%B9%E3%80%82">   当报文中的源mac在mac地址表中不存在时，会生成新的mac地址表项。</h4> 
<p>  <em><strong>         4 mac地址查找/洪泛/广播报文</strong></em></p> 
<p>            当报文中的<span style="color:#fe2c24;"><strong>目的mac为广播mac(即FF:FF:FF:FF:FF:FF)时，会向Vlan内的所有端口发送报文。</strong></span></p> 
<p><span style="color:#fe2c24;"><strong>             当报文中的目的mac为单播mac时，会在mac地址表中查找该mac，如果能够找到，会把报文转发到对应的端口，如果不能找到，会向Vlan内的所有端口发送报文，这个过程称为洪泛。</strong></span></p> 
<p><span style="color:#fe2c24;"><strong>             洪泛是指单播报文查找失败以后往各端口转发。</strong></span></p> 
<h4 id="%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%205%20%E5%87%BA%E5%8F%A3vlan%E8%BF%87%E6%BB%A4">          5 出口vlan过滤</h4> 
<p style="text-align:center;"> <img alt="" src="https://images2.imgbox.com/59/5b/oTScrqAu_o.png"></p> 
<p></p> 
<p>            这个过程是可选的，与入口VLan检查失败类似，出口检查失败以后，报文被丢弃。</p> 
<pre><code> dump EGR_VLAN 100
EGR_VLAN.epipe0[100]: &lt;VP_GROUP_BITMAP=0x0000000000000000,VALID=1,UT_PORT_BITMAP_W1=0,UT_PORT_BITMAP_W0=0x60,UT_PORT_BITMAP=0x0000000000000060,UT_BITMAP_W1=0,UT_BITMAP_W0=0x60,UT_BITMAP=0x0000000000000060,STG=1,RESERVED_0=0,REMARK_DOT1P=0,REMARK_CFI=0,PORT_BITMAP_W1=0xc40000,PORT_BITMAP_W0=0x68,PORT_BITMAP=0x00c4000000000068,OUTER_TPID_INDEX=0,FLEX_CTR_POOL_NUMBER=0,FLEX_CTR_OFFSET_MODE=0,FLEX_CTR_BASE_COUNTER_IDX=0,EVEN_PARITY=0,DOT1P_MAPPING_PTR=0&gt;</code></pre> 
<p></p> 
<h4 id="%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A06%20%E5%87%BA%E5%8F%A3vlan%E5%A4%84%E7%90%86">           6 出口vlan处理</h4> 
<p>              报文从端口出去时，是否携带Vlan Tag实在出口Vlan完成的。</p> 
<pre><code>BCM.0&gt; dump EGR_VLAN 1   
EGR_VLAN.epipe0[1]: &lt;VP_GROUP_BITMAP=0x0000000000000000,VALID=1,UT_PORT_BITMAP_W1=0,UT_PORT_BITMAP_W0=0x1feb5de,UT_PORT_BITMAP=0x0000000001feb5de,UT_BITMAP_W1=0,UT_BITMAP_W0=0x1feb5de,UT_BITMAP=0x0000000001feb5de,STG=1,RESERVED_0=0,REMARK_DOT1P=0,REMARK_CFI=0,PORT_BITMAP_W1=0xc40000,PORT_BITMAP_W0=0x1feb5fe,PORT_BITMAP=0x00c4000001feb5fe,OUTER_TPID_INDEX=0,FLEX_CTR_POOL_NUMBER=0,FLEX_CTR_OFFSET_MODE=0,FLEX_CTR_BASE_COUNTER_IDX=0,EVEN_PARITY=0,DOT1P_MAPPING_PTR=0&gt;</code></pre> 
<p> UT表示Untag Port Bitmap.,表明报文出去时为untagged.</p> 
<h3>      2.1 端口入方向对报文的处理</h3> 
<p>                根据芯片TPID信息，识别报文中Vid，通常芯片支持多个TPID，报文携带的Vlan ID是多少是根据TPID字段的得到的。</p> 
<h3 id="%C2%A0%20%C2%A0%20%C2%A0%202.2%C2%A0Vlan%20Table%E7%9A%84%E5%86%85%E5%AE%B9"><strong>      2.2 Vlan Table的内容</strong></h3> 
<p><strong>               </strong><span style="color:#fe2c24;">mac=00:03:0f:ab:ba:b2 vlan=3000 GPORT=0x10 modid=2 port=16/ge15 Hit</span></p> 
<p><span style="color:#fe2c24;">               芯片支持的mac地址信息比命令行看到的信息要多，一般包含：</span></p> 
<p><span style="color:#fe2c24;">               mac 地址、vlan id、端口号(由modid/port两部分组成)、是否为静态、是否源命中.</span></p> 
<h3 id="%C2%A0%20%C2%A0%20%C2%A0%202.3%20PVID">      2.3 PVID</h3> 
<p>                 端口上配置的VID，给Untag报文加上的Tag。只有收到的报文不带Tag时，PVID才会发生作用。</p> 
<h3 id="%C2%A0%20%C2%A0%20%C2%A02.1%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E5%AD%A6%E4%B9%A0">     2.4 Mac地址表的学习</h3> 
<p>                根据报文中Mac地址源地址、端口号、vlan生成表项，后续其它端口收到的报文，目的地址与mac表中的内容相同时，往该端口转发。</p> 
<h3 id="2.1%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E6%B4%AA%E6%B3%9B">     2.5 Mac地址表的洪泛</h3> 
<p>             当收到的报文的目的mac在mac地址表中查找失败时，会向所有端口发出。</p> 
<h3>     2.6 单播/广播/组播mac</h3> 
<p>             三类mac地址：单播mac、广播mac、组播mac。</p> 
<h3 id="2.3%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E8%80%81%E5%8C%96">     2.7 Mac地址表的老化</h3> 
<p>               mac地址表有老化机制，当一个长时间没有收到以mac地址表为<strong>源mac</strong>的报文的报文时，mac地址表项会删除。</p> 
<h3>       2.8 Mac地址表的迁移</h3> 
<p>             在mac地址存续期间，从其它端口收到同样的一个源mac相同的报文，这会导致原来的mac地址表被删除。所谓迁移，指的是端口改变了。</p> 
<h3 id="2.6%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E5%86%B2%E7%AA%81"><strong>       2.9 Mac地址表的冲突</strong></h3> 
<p><strong>                 Mac地址表通常采用Hash算法</strong></p> 
<p>         2.5.1 Mac地址表的源查找</p> 
<h4 id="2.5.2%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84Class%20ID">2.5.2 Mac地址表的Class ID</h4> 
<h4 id="2.5.3%20Mac%E5%9C%B0%E5%9D%80%E8%A1%A8%E7%9A%84%E6%BA%90hit">2.5.3 Mac地址表的源hit</h4> 
<h2 id="3%20IVL%E4%B8%8ESVL">3 IVL与SVL</h2> 
<h2 id="4%20Acces%20.Trunk.Hybird">4 Acces .Trunk.Hybird</h2>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e840f85c47eb9d2c7fe130536730ccab/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">在Chrome中拦截替换远程js资源</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b5680ad069573d0562f83d71151e80cd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Tabnine 和 Codota 选择对比</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>