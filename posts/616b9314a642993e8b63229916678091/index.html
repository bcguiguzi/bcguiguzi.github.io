<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ubuntu重启后进入initramfs的解决方法，以及关于initramfs的相关知识 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ubuntu重启后进入initramfs的解决方法，以及关于initramfs的相关知识" />
<meta property="og:description" content="问题描述 进入到Ubuntu16.04后发现无法复制、粘贴，但是用ls -l查看权限都是正常的。重启发现一直卡在关机的界面，于是硬重启（按下机箱的reset按钮），重启后进入到initramfs的shell提示符。
原因分析 回顾Linux系统启动过程，进入initramfs就意味着kernel已经load了，就差挂载rootfs了。说明是rootfs所在的磁盘出现了问题。
解决方法 用cat /proc/cmdline会找到rootfs所在磁盘的UUID。
用sudo blkid会找到所有磁盘的UUID和它对应的dev/下的设备号，比如说/dev/sdc1。
用fsck -l /dev/sdc1来修复磁盘文件系统（innodes、blocks），一路按y就可以修复磁盘了。
最终成功。
相关知识 1.initramfs是什么？ The initramfs is a gzipped cpio archive. At boot time, the kernel unpacks that archive into RAM disk, mounts and uses it as initial root file system. All finding of the root device happens in this early user space.
在initramfs的提示符下，也可以看到和rootfs差不多的文件夹：bin、lib等。
2.initramfs的作用是？ It is used for mounting the real rootfs which has all your data." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/616b9314a642993e8b63229916678091/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-22T14:18:13+08:00" />
<meta property="article:modified_time" content="2020-03-22T14:18:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ubuntu重启后进入initramfs的解决方法，以及关于initramfs的相关知识</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>问题描述</h2> 
<p>进入到Ubuntu16.04后发现无法复制、粘贴，但是用ls -l查看权限都是正常的。重启发现一直卡在关机的界面，于是硬重启（按下机箱的reset按钮），重启后进入到initramfs的shell提示符。</p> 
<h2><a id="_3"></a>原因分析</h2> 
<p>回顾Linux系统启动过程，进入initramfs就意味着kernel已经load了，就差挂载rootfs了。说明是rootfs所在的磁盘出现了问题。</p> 
<h2><a id="_6"></a>解决方法</h2> 
<ol><li> <p>用cat /proc/cmdline会找到rootfs所在磁盘的UUID。</p> </li><li> <p>用sudo blkid会找到所有磁盘的UUID和它对应的dev/下的设备号，比如说/dev/sdc1。</p> </li><li> <p>用fsck -l /dev/sdc1来修复磁盘文件系统（innodes、blocks），一路按y就可以修复磁盘了。</p> </li></ol> 
<p>最终成功。</p> 
<h2><a id="_16"></a>相关知识</h2> 
<h3><a id="1initramfs_17"></a>1.initramfs是什么？</h3> 
<p>The initramfs is a <strong>gzipped cpio archive</strong>. At boot time, the kernel unpacks that archive into <strong>RAM</strong> disk, mounts and uses it as initial root file system. All finding of the root device happens in this early user space.<br> 在initramfs的提示符下，也可以看到和rootfs差不多的文件夹：bin、lib等。</p> 
<h3><a id="2initramfs_20"></a>2.initramfs的作用是？</h3> 
<p>It is used for mounting the real rootfs which has all your data. The initramfs carries the modules needed for mounting your rootfs.</p> 
<h3><a id="3_initramfs_22"></a>3. 一定要有initramfs吗？</h3> 
<p>initramfs中包含的module都是为了mount rootfs，但是这些module其实都可以编译到kernel中，那么还需要initramfs吗？<br> 答案是：“depends on your system”。<br> 一个必须需要initramfs的例子就是对加密设备的访问。现在考虑一下没有initramfs、但是在挂载rootfs前需要向用户询问密码的场景。这个询问密码是需要在user space执行的，但是只有rootfs挂载后，才可以在user space中执行这个功能。于是这显然是一个chicken and egg problem，无解。<br> 因此对于这种情况，除了rootfs之外，必须有一个临时的、可以实现在user space实现相关功能的fs，即initramfs。<br> 那么这些user space的utility都来自与哪里？实际上都来自于rootfs。因此，可以把initramfs理解为是rootfs的精简版。</p> 
<h3><a id="4_initramfs_28"></a>4. initramfs在哪里?</h3> 
<p>进入ubuntu后，在/boot/grub目录下，有一个grub.ctg文件，有这样一段：</p> 
<pre><code class="prism language-bash">menuentry <span class="token string">'Ubuntu'</span> --class ubuntu --class gnu-linux --class gnu --class os <span class="token variable">$menuentry_id_option</span> <span class="token string">'gnulinux-simple-95e0c7e4-bca0-4431-b225-c5a27347c8e7'</span> <span class="token punctuation">{<!-- --></span>
	recordfail
	load_video
	gfxmode <span class="token variable">$linux_gfx_mode</span>
	insmod gzio
	<span class="token keyword">if</span> <span class="token punctuation">[</span> x<span class="token variable">$grub_platform</span> <span class="token operator">=</span> xxen <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> insmod xzio<span class="token punctuation">;</span> insmod lzopio<span class="token punctuation">;</span> <span class="token keyword">fi</span>
	insmod part_msdos
	insmod ext2
	<span class="token keyword">set</span> root<span class="token operator">=</span><span class="token string">'hd2,msdos1'</span>
	<span class="token keyword">if</span> <span class="token punctuation">[</span> x<span class="token variable">$feature_platform_search_hint</span> <span class="token operator">=</span> xy <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
	  search --no-floppy --fs-uuid --set<span class="token operator">=</span>root --hint-bios<span class="token operator">=</span>hd2,msdos1 --hint-efi<span class="token operator">=</span>hd2,msdos1 --hint-baremetal<span class="token operator">=</span>ahci2,msdos1  95e0c7e4-bca0-4431-b225-c5a27347c8e7
	<span class="token keyword">else</span>
	  search --no-floppy --fs-uuid --set<span class="token operator">=</span>root 95e0c7e4-bca0-4431-b225-c5a27347c8e7
	<span class="token keyword">fi</span>
    linux	/boot/vmlinuz-4.15.0-88-generic root<span class="token operator">=</span>UUID<span class="token operator">=</span>95e0c7e4-bca0-4431-b225-c5a27347c8e7 ro  quiet splash <span class="token variable">$vt_handoff</span>
	initrd	/boot/initrd.img-4.15.0-88-generic
<span class="token punctuation">}</span>
</code></pre> 
<p>最后一行的initrd就是initramfs对应的文件：/boot/initrd.img-4.15.0-88-generic。<br> 用file指令查看这个文件：</p> 
<pre><code class="prism language-bash">$ <span class="token function">file</span> initrd.img-4.15.0-45-generic 
initrd.img-4.15.0-45-generic: ASCII cpio archive <span class="token punctuation">(</span>SVR4 with no CRC<span class="token punctuation">)</span>
</code></pre> 
<p>可以看出它是一个cpio的档案文件，大小只有60多MB。而Ubuntu一个完整的rootfs大概是GB的级别。</p> 
<h3><a id="5_initramfs_58"></a>5. initramfs中都有哪些文件？</h3> 
<p>如何解压缩initrd.img-4.15.0-45-generic？<br> 虽然用file指令可以看出该文件是一个ASCII cpio文件，但是用cpio -id &lt; initrd.img-4.15.0-45-generic却只能得到如下的文件：</p> 
<pre><code class="prism language-handlebars"><span class="token variable">└──</span> <span class="token variable">kernel</span>
    <span class="token variable">└──</span> <span class="token variable">x86</span>
        <span class="token variable">└──</span> <span class="token variable">microcode</span>
            <span class="token variable">└──</span> <span class="token variable">AuthenticAMD</span><span class="token punctuation">.</span><span class="token variable">bin</span>
</code></pre> 
<p>这显然不对，因为initrd.img-4.15.0-45-generic的大小是68.5MB，而这个AuthenticAMD.bin只有27.4KB。顺便说一句，这个AuthenticAMD.bin文件是对AMD CPU的microcode<a href="https://wiki.gentoo.org/wiki/AMD_microcode" rel="nofollow">打补丁的文件</a>。更过关于microcode的知识，可以看<a href="https://zhuanlan.zhihu.com/p/86432216" rel="nofollow">这篇</a>。</p> 
<p>正确提取initrd.img-4.15.0-45-generic的方法如下，首先用binwalk来查看initrd.img-4.15.0-45-generic的组成：</p> 
<pre><code class="prism language-bash">$ binwalk initrd.img-4.15.0-45-generic 

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             ASCII cpio archive <span class="token punctuation">(</span>SVR4 with no CRC<span class="token punctuation">)</span>, <span class="token function">file</span> name: <span class="token string">"."</span>, <span class="token function">file</span> name length: <span class="token string">"0x00000002"</span>, <span class="token function">file</span> size: <span class="token string">"0x00000000"</span>
112           0x70            ASCII cpio archive <span class="token punctuation">(</span>SVR4 with no CRC<span class="token punctuation">)</span>, <span class="token function">file</span> name: <span class="token string">"kernel"</span>, <span class="token function">file</span> name length: <span class="token string">"0x00000007"</span>, <span class="token function">file</span> size: <span class="token string">"0x00000000"</span>
232           0xE8            ASCII cpio archive <span class="token punctuation">(</span>SVR4 with no CRC<span class="token punctuation">)</span>, <span class="token function">file</span> name: <span class="token string">"kernel/x86"</span>, <span class="token function">file</span> name length: <span class="token string">"0x0000000B"</span>, <span class="token function">file</span> size: <span class="token string">"0x00000000"</span>
356           0x164           ASCII cpio archive <span class="token punctuation">(</span>SVR4 with no CRC<span class="token punctuation">)</span>, <span class="token function">file</span> name: <span class="token string">"kernel/x86/microcode"</span>, <span class="token function">file</span> name length: <span class="token string">"0x00000015"</span>, <span class="token function">file</span> size: <span class="token string">"0x00000000"</span>
488           0x1E8           ASCII cpio archive <span class="token punctuation">(</span>SVR4 with no CRC<span class="token punctuation">)</span>, <span class="token function">file</span> name: <span class="token string">"kernel/x86/microcode/AuthenticAMD.bin"</span>, <span class="token function">file</span> name length: <span class="token string">"0x00000026"</span>, <span class="token function">file</span> size: <span class="token string">"0x00006B2A"</span>
28072         0x6DA8          ASCII cpio archive <span class="token punctuation">(</span>SVR4 with no CRC<span class="token punctuation">)</span>, <span class="token function">file</span> name: <span class="token string">"TRAILER!!!"</span>, <span class="token function">file</span> name length: <span class="token string">"0x0000000B"</span>, <span class="token function">file</span> size: <span class="token string">"0x00000000"</span>
28672         0x7000          ASCII cpio archive <span class="token punctuation">(</span>SVR4 with no CRC<span class="token punctuation">)</span>, <span class="token function">file</span> name: <span class="token string">"kernel"</span>, <span class="token function">file</span> name length: <span class="token string">"0x00000007"</span>, <span class="token function">file</span> size: <span class="token string">"0x00000000"</span>
28792         0x7078          ASCII cpio archive <span class="token punctuation">(</span>SVR4 with no CRC<span class="token punctuation">)</span>, <span class="token function">file</span> name: <span class="token string">"kernel/x86"</span>, <span class="token function">file</span> name length: <span class="token string">"0x0000000B"</span>, <span class="token function">file</span> size: <span class="token string">"0x00000000"</span>
28916         0x70F4          ASCII cpio archive <span class="token punctuation">(</span>SVR4 with no CRC<span class="token punctuation">)</span>, <span class="token function">file</span> name: <span class="token string">"kernel/x86/microcode"</span>, <span class="token function">file</span> name length: <span class="token string">"0x00000015"</span>, <span class="token function">file</span> size: <span class="token string">"0x00000000"</span>
29048         0x7178          ASCII cpio archive <span class="token punctuation">(</span>SVR4 with no CRC<span class="token punctuation">)</span>, <span class="token function">file</span> name: <span class="token string">"kernel/x86/microcode/GenuineIntel.bin"</span>, <span class="token function">file</span> name length: <span class="token string">"0x0000002A"</span>, <span class="token function">file</span> size: <span class="token string">"0x002D2C00"</span>
2989584       0x2D9E10        ASCII cpio archive <span class="token punctuation">(</span>SVR4 with no CRC<span class="token punctuation">)</span>, <span class="token function">file</span> name: <span class="token string">"TRAILER!!!"</span>, <span class="token function">file</span> name length: <span class="token string">"0x0000000B"</span>, <span class="token function">file</span> size: <span class="token string">"0x00000000"</span>
2990080       0x2DA000        <span class="token function">gzip</span> compressed data, from Unix, last modified: 2020-02-23 06:04:02
24602446      0x177674E       xz compressed data
40511347      0x26A2773       MySQL ISAM compressed data <span class="token function">file</span> Version 9
60684299      0x39DF80B       MySQL ISAM compressed data <span class="token function">file</span> Version 3

</code></pre> 
<p>可以看出，该文件后面还有gzip、xz、MYSQL ISAM压缩文件。<br> 提取出gzip文件、并依次通过gzip和cpio对其解压：</p> 
<pre><code class="prism language-bash"><span class="token function">dd</span> if<span class="token operator">=</span>initrd.img-4.15.0-45-generic of<span class="token operator">=</span>image.gz bs<span class="token operator">=</span>2990080 skip<span class="token operator">=</span>1
gunzip image.gz 
cpio -i <span class="token operator">&lt;</span> image
</code></pre> 
<p>得到以下文件夹，这个就和我们在initramfs提示符下看到的差不多了：</p> 
<pre><code class="prism language-bash"><span class="token keyword">.</span>
├── bin
├── conf
├── etc
├── image
├── init
├── lib
├── lib64
├── run
├── sbin
├── scripts
├── usr
└── var
</code></pre> 
<p>上述方法参考了<a href="https://askubuntu.com/questions/1094854/how-to-modify-initrd-initial-ramdisk-of-ubuntu-18-10-cosmic-cuttlefish" rel="nofollow">Ubuntu18.04的解决方法</a>。<br> 我没有对initrd.img-4.15.0-45-generic剩下的两个文件xz compressed data和MYSQL ISAM继续研究。</p> 
<h3><a id="6_initramfs_121"></a>6. initramfs中的文件如何执行？</h3> 
<p><a href="https://wiki.ubuntu.com/Initramfs" rel="nofollow">ubuntu的wiki</a>详细描述了这个过程。<br> 总的来说，initramfs的执行过程是：</p> 
<ol><li>执行init进程</li><li>init调用scripts文件夹其他脚本<br> 1）init-top<br> 2）init-premount<br> 3）boot-top (your crypt scripts execute here - to ask the user password for eg)<br> 4）boot-premount<br> 5）boot：mount rootfs到/initramfs/root/<br> 6）boot-bottom<br> 7）init-bottom</li><li>init进程重新得到控制权，然后执行：<br> 1）moves the /sys from initramfs to /initramfs/root/sys (in your real rootfs)<br> 2）moves /proc from initramfs to /initramfs/root/proc<br> 3）calls <strong>run-init</strong> to run the real init in your real rootfs kept in /root. run-init does something like<br> <strong>chroot</strong> to the real rootfs and then executes the init kept in /sbin/ or /bin or whatever user requested as a boot parameter.</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/57702a755cc610d978614d1cafa9c39c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Http Headers各属性简介及常见安全攻击</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4bdf35069d91fdf446eaca31227d2641/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">高数中的取整函数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>