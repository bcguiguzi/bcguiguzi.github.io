<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[Kernel_exception6] BUG: scheduling while atomic - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[Kernel_exception6] BUG: scheduling while atomic" />
<meta property="og:description" content="一、实际问题：
1、开机出现原子上下文调度的bug：
[ 6.290494] &lt;1&gt;.(1)[285:init]BUG: scheduling while atomic: init/285/0x00000000 [ 6.290528] &lt;1&gt;-(1)[285:init][&lt;c010e61c&gt;] (dump_backtrace) from [&lt;c010e954&gt;] (show_stack&#43;0x18/0x1c) [ 6.290533] &lt;1&gt;-(1)[285:init] r6:600b0013 r5:c14556d0 r4:00000000 r3:00040975 [ 6.290543] &lt;1&gt;-(1)[285:init][&lt;c010e93c&gt;] (show_stack) from [&lt;c04b5e88&gt;] (dump_stack&#43;0x94/0xa8) [ 6.290551] &lt;1&gt;-(1)[285:init][&lt;c04b5df4&gt;] (dump_stack) from [&lt;c0159a14&gt;] (__schedule_bug&#43;0x58/0x6c) [ 6.290555] &lt;1&gt;-(1)[285:init] r6:c1404a54 r5:c13a4b00 r4:00000000 r3:600b0013 [ 6.290561] &lt;1&gt;-(1)[285:init][&lt;c01599bc&gt;] (__schedule_bug) from [&lt;c0ddf568&gt;] (__schedule&#43;0x660/0xa68) [ 6.290564] &lt;1&gt;-(1)[285:init] r4:df68bb00 r3:c13a4b00 [ 6.290568] &lt;1&gt;-(1)[285:init][&lt;c0ddef08&gt;] (__schedule) from [&lt;c0ddf9c4&gt;] (schedule&#43;0x54/0xb8) [ 6.290572] &lt;1&gt;-(1)[285:init] r10:00000000 r9:00000000 r8:00000000 r7:00000000 r6:00000000 r5:00000000 [ 6." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/d0d6bebd92da35d4ff893e6f4223a9ee/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-08-23T14:36:35+08:00" />
<meta property="article:modified_time" content="2019-08-23T14:36:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[Kernel_exception6] BUG: scheduling while atomic</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>一、实际问题：</strong></p> 
<p>1、开机出现原子上下文调度的bug：</p> 
<pre class="has"><code class="language-cpp">[    6.290494] &lt;1&gt;.(1)[285:init]BUG: scheduling while atomic: init/285/0x00000000
[    6.290528] &lt;1&gt;-(1)[285:init][&lt;c010e61c&gt;] (dump_backtrace) from [&lt;c010e954&gt;] (show_stack+0x18/0x1c)
[    6.290533] &lt;1&gt;-(1)[285:init] r6:600b0013 r5:c14556d0 r4:00000000 r3:00040975
[    6.290543] &lt;1&gt;-(1)[285:init][&lt;c010e93c&gt;] (show_stack) from [&lt;c04b5e88&gt;] (dump_stack+0x94/0xa8)
[    6.290551] &lt;1&gt;-(1)[285:init][&lt;c04b5df4&gt;] (dump_stack) from [&lt;c0159a14&gt;] (__schedule_bug+0x58/0x6c)
[    6.290555] &lt;1&gt;-(1)[285:init] r6:c1404a54 r5:c13a4b00 r4:00000000 r3:600b0013
[    6.290561] &lt;1&gt;-(1)[285:init][&lt;c01599bc&gt;] (__schedule_bug) from [&lt;c0ddf568&gt;] (__schedule+0x660/0xa68)
[    6.290564] &lt;1&gt;-(1)[285:init] r4:df68bb00 r3:c13a4b00
[    6.290568] &lt;1&gt;-(1)[285:init][&lt;c0ddef08&gt;] (__schedule) from [&lt;c0ddf9c4&gt;] (schedule+0x54/0xb8)
[    6.290572] &lt;1&gt;-(1)[285:init] r10:00000000 r9:00000000 r8:00000000 r7:00000000 r6:00000000 r5:00000000
[    6.290574] &lt;1&gt;-(1)[285:init] r4:dd7ca000
[    6.290579] &lt;1&gt;-(1)[285:init][&lt;c0ddf970&gt;] (schedule) from [&lt;c0de3668&gt;] (schedule_hrtimeout_range_clock+0x1ac/0x1b8)
[    6.290582] &lt;1&gt;-(1)[285:init] r4:c1404548 r3:00040975
[    6.290587] &lt;1&gt;-(1)[285:init][&lt;c0de34bc&gt;] (schedule_hrtimeout_range_clock) from [&lt;c0de3694&gt;] (schedule_hrtimeout_range+0x20/0x28)
</code></pre> 
<pre class="has"><code class="language-cpp">[    6.290647] &lt;1&gt;-(1)[285:init]Kernel BUG at c0159a24 [verbose debug info unavailable]
[    6.290649] &lt;1&gt;-(1)[285:init]Internal error: Oops - BUG: 0 [#1] PREEMPT SMP ARM

[    7.290612] &lt;1&gt;-(1)[285:init]PC is at __schedule_bug+0x68/0x6c
[    7.290617] &lt;1&gt;-(1)[285:init]LR is at add_taint+0x28/0x6c</code></pre> 
<p>2、使用GDB 解析对应的堆栈信息如下：</p> 
<pre class="has"><code class="language-cpp">(gdb) bt
#0  0xc0159a24 in __schedule_bug (prev=&lt;optimized out&gt;)
    at /home/rlk-buildsrv-tf29/jenkins/workspace/BAK_PY_UNIFIED_VERSION_BUILD/code/kernel-4.9/kernel/sched/core.c:3633
#1  0xc0ddf568 in schedule_debug (prev=&lt;optimized out&gt;)
    at /home/rlk-buildsrv-tf29/jenkins/workspace/BAK_PY_UNIFIED_VERSION_BUILD/code/kernel-4.9/kernel/sched/core.c:3647
#2  __schedule (preempt=&lt;optimized out&gt;)
    at /home/rlk-buildsrv-tf29/jenkins/workspace/BAK_PY_UNIFIED_VERSION_BUILD/code/kernel-4.9/kernel/sched/core.c:3748
#3  0xc0ddf9c4 in schedule ()
    at /home/rlk-buildsrv-tf29/jenkins/workspace/BAK_PY_UNIFIED_VERSION_BUILD/code/kernel-4.9/kernel/sched/core.c:3876
#4  0xc0de3668 in schedule_hrtimeout_range_clock (expires=0x0, delta=0, mode=HRTIMER_MODE_ABS, clock=1)
    at /home/rlk-buildsrv-tf29/jenkins/workspace/BAK_PY_UNIFIED_VERSION_BUILD/code/kernel-4.9/kernel/time/hrtimer.c:1847
#5  0xc0de3694 in schedule_hrtimeout_range (expires=&lt;optimized out&gt;, delta=&lt;optimized out&gt;, 
    mode=&lt;optimized out&gt;)
    at /home/rlk-buildsrv-tf29/jenkins/workspace/BAK_PY_UNIFIED_VERSION_BUILD/code/kernel-4.9/kernel/time/hrtimer.c:1900
#6  0xc02ccbd8 in poll_schedule_timeout (pwq=0xdd7cbcb0, state=&lt;optimized out&gt;, expires=&lt;optimized out&gt;, 
    slack=0)
    at /home/rlk-buildsrv-tf29/jenkins/workspace/BAK_PY_UNIFIED_VERSION_BUILD/code/kernel-4.9/fs/select.c:246
#7  0xc02ce8a0 in do_poll (end_time=&lt;optimized out&gt;, wait=&lt;optimized out&gt;, list=0x0)</code></pre> 
<pre class="has"><code class="language-cpp">(gdb) p {struct thread_info}0xdd7ca000
$2 = {flags = 0, preempt_count = 0, addr_limit = 3204448256, task = 0xdda93000, cpu = 1, cpu_domain = 0, 
  cpu_context = {r4 = 3748182784, r5 = 3736350720, r6 = 0, r7 = 3717657024, r8 = 3718852608, r9 = 3718854016, </code></pre> 
<p>这里我们重点关注preempt_count = 0；</p> 
<p><strong>二、代码解析：</strong></p> 
<p>1、可以看到看到是如下地方报的BUG：</p> 
<pre class="has"><code class="language-cpp">/*
 * Print scheduling while atomic bug:
 */
static noinline void __schedule_bug(struct task_struct *prev)
{
	printk(KERN_ERR "BUG: scheduling while atomic: %s/%d/0x%08x\n",
		prev-&gt;comm, prev-&gt;pid, preempt_count());
        //......

	dump_stack();
	add_taint(TAINT_WARN, LOCKDEP_STILL_OK);
	BUG_ON(1);
}</code></pre> 
<p>2、下面可以看到如下进入的__schedule_bug：</p> 
<p>（1）查看schedule（）函数：</p> 
<pre class="has"><code class="language-cpp">asmlinkage __visible void __sched schedule(void)
{
	struct task_struct *tsk = current;

	sched_submit_work(tsk);
	do {
		preempt_disable();//发生__schedule 前关闭抢占，preempt_count + 1
		__schedule(false);
		sched_preempt_enable_no_resched();
	} while (need_resched());
}

#define __preempt_count_inc() __preempt_count_add(1)
#define __preempt_count_dec() __preempt_count_sub(1)

#define preempt_count_inc() preempt_count_add(1)
#define preempt_count_dec() preempt_count_sub(1)</code></pre> 
<p>（2）__schedule会调用schedule_debug：</p> 
<pre class="has"><code class="language-cpp">static void __sched notrace __schedule(bool preempt)
{
	cpu = smp_processor_id();
	rq = cpu_rq(cpu);
	prev = rq-&gt;curr;

	schedule_debug(prev);
......
}</code></pre> 
<p>（3）我们重点看in_atomic_preempt_off：</p> 
<pre class="has"><code class="language-cpp">
static inline void schedule_debug(struct task_struct *prev)
{

	if (unlikely(in_atomic_preempt_off())) {//对原子上下文进行判断
		__schedule_bug(prev);
		preempt_count_set(PREEMPT_DISABLED);
	}
	rcu_sleep_check();

	profile_hit(SCHED_PROFILING, __builtin_return_address(0));

	schedstat_inc(this_rq()-&gt;sched_count);
}</code></pre> 
<p>这里in_atomic_preempt_off()：</p> 
<pre class="has"><code class="language-cpp">/*
 * Check whether we were atomic before we did preempt_disable():
 * (used by the scheduler)
 */
#define PREEMPT_SHIFT	0

#define PREEMPT_OFFSET	(1UL &lt;&lt; PREEMPT_SHIFT)

# define PREEMPT_DISABLE_OFFSET	PREEMPT_OFFSET

#define in_atomic_preempt_off() (preempt_count() != PREEMPT_DISABLE_OFFSET)</code></pre> 
<p>可知这里判断preempt_count 是否等于1，不等于1时返回true，也就是判断在调用schedule前的环境：</p> 
<p>A、处于可调度状态preempt_count = 0，在执行preempt_disable时会进行+1操作，in_atomic_preempt_off返回false；</p> 
<p>B、处于不可调度状态preempt_count != 0，这里preempt_count的值又存在两种情况：</p> 
<ul><li>preempt_count = 1，比如调用在spin_lock中调用了sleep，发生原子调度的情况；</li><li>preempt_count = 0xffffffff，这种可能是调用了两次spin_unlock之后的preempt_count的值；</li></ul> 
<p>       <img alt="" class="has" height="286" src="https://images2.imgbox.com/ec/24/NLD3e5ry_o.png" width="596"></p> 
<p>3、分析到这里可以知道，我们的这个BUG的出现是因为在调用schdule前，preempt_count = 0xffffffff，</p> 
<p>在schedule()时，preempt_count + 1 = 0，所以这里in_atomic_preempt_off()返回了true出现的问题，</p> 
<p>这个bug我们并没有找到问题的根源，可以打开spin_lock debug的宏去复现问题，才可以找到问题根源。</p> 
<p> </p> 
<p>作者：frank_zyp<br> 您的支持是对博主最大的鼓励，感谢您的认真阅读。<br> 本文无所谓版权，欢迎转载。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bacfd39126c8b5795c6643486331acf7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43; Primer知识点整理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9e933f51276ab4e1ca56bc403f993a2d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java深究之Vector、ArrayList、LinkedList的区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>