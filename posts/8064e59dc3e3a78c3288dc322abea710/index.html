<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ElasticSearch 8.x 创建父子文档，用Join类型字段以及用has_child、has_parent 检索 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ElasticSearch 8.x 创建父子文档，用Join类型字段以及用has_child、has_parent 检索" />
<meta property="og:description" content="ElasticSearch 1、ElasticSearch学习随笔之基础介绍
2、ElasticSearch学习随笔之简单操作
3、ElasticSearch学习随笔之java api 操作
4、ElasticSearch学习随笔之SpringBoot Starter 操作
5、ElasticSearch学习随笔之嵌套操作
6、ElasticSearch学习随笔之分词算法
7、ElasticSearch学习随笔之高级检索
8、ELK技术栈介绍
9、Logstash部署与使用
10、ElasticSearch 7.x 版本使用 BulkProcessor 实现批量添加数据
11、ElasticSearch 8.x 弃用了 High Level REST Client，移除了 Java Transport Client，推荐使用 Elasticsearch Java API
12、ElasticSearch 8.x 使用 snapshot（快照）进行数据迁移
13、ElasticSearch 8.x 版本如何使用 SearchRequestBuilder 检索
14、ElasticSearch 8.x 使用 High Level Client 以 HTTPS 方式链接，SSL 证书、主机名验证器 各是什么，如何忽略
15、ElasticSearch 8.x 创建父子文档，用Join类型字段以及用has_child、has_parent 检索
ElasticSearch，创始人 Shay Banon（谢巴农）
本文主要讲解ElasticSearch 父子文档实战，来满足复杂的业务场景，还是用 Kibana 来操作。
文章目录 ElasticSearch前言一、Kibana 中操作1.1 Join 类型字段1.2、写入关联数据1.3、数据检索1.3.1 has_child 检索1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/8064e59dc3e3a78c3288dc322abea710/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-27T09:53:26+08:00" />
<meta property="article:modified_time" content="2024-02-27T09:53:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ElasticSearch 8.x 创建父子文档，用Join类型字段以及用has_child、has_parent 检索</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="ElasticSearch_0"></a>ElasticSearch</h2> 
<p>1、<a href="https://blog.csdn.net/qq_19283249/article/details/124222352">ElasticSearch学习随笔之基础介绍</a><br> 2、<a href="https://blog.csdn.net/qq_19283249/article/details/124225211">ElasticSearch学习随笔之简单操作</a><br> 3、<a href="https://blog.csdn.net/qq_19283249/article/details/124227307">ElasticSearch学习随笔之java api 操作</a><br> 4、<a href="https://blog.csdn.net/qq_19283249/article/details/124832230">ElasticSearch学习随笔之SpringBoot Starter 操作</a><br> 5、<a href="https://blog.csdn.net/qq_19283249/article/details/127000665">ElasticSearch学习随笔之嵌套操作</a><br> 6、<a href="https://blog.csdn.net/qq_19283249/article/details/130470805">ElasticSearch学习随笔之分词算法</a><br> 7、<a href="https://blog.csdn.net/qq_19283249/article/details/130473909">ElasticSearch学习随笔之高级检索</a><br> 8、<a href="https://blog.csdn.net/qq_19283249/article/details/130790590">ELK技术栈介绍</a><br> 9、<a href="https://blog.csdn.net/qq_19283249/article/details/130839158">Logstash部署与使用</a><br> 10、<a href="https://blog.csdn.net/qq_19283249/article/details/135352497">ElasticSearch 7.x 版本使用 BulkProcessor 实现批量添加数据</a><br> 11、<a href="https://blog.csdn.net/qq_19283249/article/details/135352522">ElasticSearch 8.x 弃用了 High Level REST Client，移除了 Java Transport Client，推荐使用 Elasticsearch Java API</a><br> 12、<a href="https://blog.csdn.net/qq_19283249/article/details/135581208">ElasticSearch 8.x 使用 snapshot（快照）进行数据迁移</a><br> 13、<a href="https://blog.csdn.net/qq_19283249/article/details/135818373">ElasticSearch 8.x 版本如何使用 SearchRequestBuilder 检索</a><br> 14、<a href="https://blog.csdn.net/qq_19283249/article/details/135971652">ElasticSearch 8.x 使用 High Level Client 以 HTTPS 方式链接，SSL 证书、主机名验证器 各是什么，如何忽略</a><br> 15、<a href="https://blog.csdn.net/qq_19283249/article/details/136041108">ElasticSearch 8.x 创建父子文档，用Join类型字段以及用has_child、has_parent 检索</a></p> 
<p>ElasticSearch，创始人 Shay Banon（谢巴农）<br> 本文主要讲解ElasticSearch 父子文档实战，来满足复杂的业务场景，还是用 Kibana 来操作。</p> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#ElasticSearch_0" rel="nofollow">ElasticSearch</a></li><li><a href="#_27" rel="nofollow">前言</a></li><li><a href="#Kibana__31" rel="nofollow">一、Kibana 中操作</a></li><li><ul><li><a href="#11_Join__32" rel="nofollow">1.1 Join 类型字段</a></li><li><a href="#12_56" rel="nofollow">1.2、写入关联数据</a></li><li><a href="#13_103" rel="nofollow">1.3、数据检索</a></li><li><ul><li><a href="#131_has_child__105" rel="nofollow">1.3.1 has_child 检索</a></li><li><a href="#132_has_parent__120" rel="nofollow">1.3.2 has_parent 检索</a></li></ul> 
  </li></ul> 
  </li><li><a href="#High_Level_REST_Client__135" rel="nofollow">四、High Level REST Client 操作</a></li><li><ul><li><a href="#40__ES__136" rel="nofollow">4.0 初始化 ES 客户端</a></li><li><a href="#41_join_154" rel="nofollow">4.1 创建索引（join字段）</a></li><li><a href="#42__212" rel="nofollow">4.2 添加数据</a></li><li><a href="#43__282" rel="nofollow">4.3 检索数据</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_27"></a>前言</h2> 
<p>经常在工作中遇到如下情况，就是一对多的情况，数据 A 关联到多个 数据 B，那这种情况在关系型数据库中存储是非常简单且方便的，只需要加入一个外键就可以用 join 来检索了，不用很关心 数据 B 的量有多大，反正对于关系型数据库来说一个 join 不成大问题；<br> 那对于 ES 来说，这种情况只能有两种方式来做了，第一就是字段嵌套，需要定义一个 nested（嵌套）类型的字段，字段中有多个 对象，第二就是本文要讲到的 父子文档嵌套并用 has_child、has_parent 来检索。</p> 
<h2><a id="Kibana__31"></a>一、Kibana 中操作</h2> 
<h3><a id="11_Join__32"></a>1.1 Join 类型字段</h3> 
<p>首先我们在 Kibana 中用如下指令创建一个<strong>索引</strong>（my-index-000001），并且添加 添加 <code>join</code> 类型的字段，下面案例摘自官网，感兴趣可以点击 “我要去官网学习” 去瞅瞅。<br> <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.7/parent-join.html" rel="nofollow">我要去官网学习！</a></p> 
<pre><code class="prism language-java"><span class="token constant">PUT</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"my_id"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"my_join_field"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"join"</span><span class="token punctuation">,</span>
        <span class="token string">"relations"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"question"</span><span class="token operator">:</span> <span class="token string">"answer"</span> 
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>my_join_field：</strong> <code>join</code> 类型字段名称。<br> <strong>relations：</strong> 定义关系，“question”: “answer” 表示 <code>question</code> 是 <code>answer</code> 的父文档。</p> 
<h3><a id="12_56"></a>1.2、写入关联数据</h3> 
<ol><li>首先写入父文档，也就是我们定义的 <strong>mapping</strong> 中的 <strong>relations</strong> 的关系是 <strong>question</strong>，可以看下面两条示例数据，字段 <code>my_join_field</code> 的值是 <code>question</code>。</li></ol> 
<pre><code class="prism language-java"><span class="token constant">PUT</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span><span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span><span class="token operator">?</span>refresh
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"my_id"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
  <span class="token string">"text"</span><span class="token operator">:</span> <span class="token string">"This is a question 001"</span><span class="token punctuation">,</span>
  <span class="token string">"my_join_field"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"question"</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token constant">PUT</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span><span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">2</span><span class="token operator">?</span>refresh
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"my_id"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
  <span class="token string">"text"</span><span class="token operator">:</span> <span class="token string">"This is another question 002"</span><span class="token punctuation">,</span>
  <span class="token string">"my_join_field"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"question"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>紧接着写入子文档，也就是定义的 <strong>relation</strong> 的关系是 <strong>answer</strong>，可以看下面两条示例数据，字段 <code>my_join_field</code> 的值是 <code>answer</code>。</li></ol> 
<pre><code class="prism language-java"><span class="token constant">PUT</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span><span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">3</span><span class="token operator">?</span>routing<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>refresh 
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"my_id"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>
  <span class="token string">"text"</span><span class="token operator">:</span> <span class="token string">"This is an answer for question 001"</span><span class="token punctuation">,</span>
  <span class="token string">"my_join_field"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"answer"</span><span class="token punctuation">,</span> 
    <span class="token string">"parent"</span><span class="token operator">:</span> <span class="token string">"1"</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token constant">PUT</span> my<span class="token operator">-</span>index<span class="token operator">-</span><span class="token number">000001</span><span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">4</span><span class="token operator">?</span>routing<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>refresh
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"my_id"</span><span class="token operator">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span>
  <span class="token string">"text"</span><span class="token operator">:</span> <span class="token string">"This is another answer for question 001"</span><span class="token punctuation">,</span>
  <span class="token string">"my_join_field"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"answer"</span><span class="token punctuation">,</span>
    <span class="token string">"parent"</span><span class="token operator">:</span> <span class="token string">"1"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>注意：</code> 在写入子文档时，要注意以下三点：</p> 
<ul><li>必须指定 routing，routing 表示路由，路由值是必须的，因为父子文档必须在同一分片上进行索引。</li><li>my_join_field 字段需要指定是 answer。</li><li>需要指定 parent，就是父文档的 id。</li></ul> 
<h3><a id="13_103"></a>1.3、数据检索</h3> 
<p>下面通过 has_child 和 has_parent 来执行检索，需要注意的是如果你是要在父或者子文档中继续用条件检索，在 里面的 query 中继续添加检索条件，下面示例中都是 <strong>match_all</strong> 。</p> 
<h4><a id="131_has_child__105"></a>1.3.1 has_child 检索</h4> 
<pre><code class="prism language-bash">GET my-index-000001/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"has_child"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"answer"</span>,
      <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"match_all"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过 has_child 就可以检索出来拥有子文档的文档，也就是我们最终得到的是 <strong>父文档</strong> 的内容，也就是 <code>question</code>。</p> 
<h4><a id="132_has_parent__120"></a>1.3.2 has_parent 检索</h4> 
<pre><code class="prism language-bash">GET my-index-000001/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"has_parent"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"parent_type"</span><span class="token builtin class-name">:</span> <span class="token string">"question"</span>,
      <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"match_all"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过 has_child 就可以检索出拥有父文档的子文档，那我们最终拿到的是 “<strong>子文档</strong>” 的内容，也就是 <code>answer</code>。</p> 
<h2><a id="High_Level_REST_Client__135"></a>四、High Level REST Client 操作</h2> 
<h3><a id="40__ES__136"></a>4.0 初始化 ES 客户端</h3> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 通过认证连接ES，获取客户端
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> hostname <span class="token operator">=</span> <span class="token string">"192.168.*.*"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token number">9200</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token string">"your es username"</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token string">"your es password"</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">CredentialsProvider</span> credentialsProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicCredentialsProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    credentialsProvider<span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span><span class="token class-name">AuthScope</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentials</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RestClientBuilder</span> restClientBuilder <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setHttpClientConfigCallback</span><span class="token punctuation">(</span>httpAsyncClientBuilder <span class="token operator">-&gt;</span> httpAsyncClientBuilder<span class="token punctuation">.</span><span class="token function">setDefaultCredentialsProvider</span><span class="token punctuation">(</span>credentialsProvider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>restClientBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="41_join_154"></a>4.1 创建索引（join字段）</h3> 
<p>我们要创建一个带有 join 字段的索引，所以在创建索引的时候需要提供 <code>mapping</code>，下面是 mapping 示例，是一个 json 文件。</p> 
<pre><code class="prism language-bash">src/main/resources/mapping/myIndexMapping.json
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"mappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"my_id"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"my_join_field"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"join"</span>,
        <span class="token string">"relations"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"question"</span><span class="token builtin class-name">:</span> <span class="token string">"answer"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>写好了 mapping ，下面就来创建索引。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 *创建 mapping 索引
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createSchemaIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> indexName <span class="token operator">=</span> <span class="token string">"my-index-000001"</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取客户端实例</span>
    <span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 读取 classpath 下的 JSON 文件内容</span>
        <span class="token class-name">String</span> file <span class="token operator">=</span> <span class="token class-name">ClasspathResourceLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/mapping/myIndexMapping.json"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BufferedInputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>inputStream<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonMapping <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建索引请求</span>
        <span class="token class-name">CreateIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置 schema</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>jsonMapping<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CreateIndexResponse</span> createIndexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>createIndexResponse<span class="token punctuation">.</span><span class="token function">isAcknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"成功创建索引："</span> <span class="token operator">+</span> indexName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"创建索引失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="42__212"></a>4.2 添加数据</h3> 
<ol><li>添加 <code>question</code> 数据，代码如下：</li></ol> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 添加 question 数据
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addData2Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> indexName <span class="token operator">=</span> <span class="token string">"my-index-000001"</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取客户端实例</span>
    <span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 准备question测试数据</span>
    <span class="token class-name">JSONObject</span> question <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    question<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"my_id"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    question<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token string">"This is a question 001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JSONObject</span> join <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    join<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"question"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    question<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"my_join_field"</span><span class="token punctuation">,</span> join<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>question<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IndexResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 打印插入结果</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>添加 <code>answer</code> 数据，代码如下：</li></ol> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 添加 answer 数据
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addData2Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> indexName <span class="token operator">=</span> <span class="token string">"my-index-000001"</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取客户端实例</span>
    <span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 准备question测试数据</span>
    <span class="token class-name">JSONObject</span> question <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    question<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"my_id"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    question<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token string">"This is an answer for question 001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JSONObject</span> join <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    join<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"answer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    join<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"parent"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    question<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"my_join_field"</span><span class="token punctuation">,</span> join<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">routing</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>question<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IndexResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 打印插入结果</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="43__282"></a>4.3 检索数据</h3> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 查询
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">searchIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> indexName <span class="token operator">=</span> <span class="token string">"my-index-000001"</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取客户端实例</span>
    <span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// has_child 查询</span>
        <span class="token comment">//HasChildQueryBuilder hasChildQueryBuilder = JoinQueryBuilders.hasChildQuery("answer", QueryBuilders.matchAllQuery(), ScoreMode.None);</span>
        <span class="token comment">//builder.query(hasChildQueryBuilder);</span>
        
        <span class="token comment">// has_parent 查询</span>
        <span class="token class-name">HasParentQueryBuilder</span> hasParentQueryBuilder <span class="token operator">=</span> <span class="token class-name">JoinQueryBuilders</span><span class="token punctuation">.</span><span class="token function">hasParentQuery</span><span class="token punctuation">(</span><span class="token string">"question"</span><span class="token punctuation">,</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>hasParentQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/199b501271f99b84b9e8faab60875fbb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux第66步_linux字符设备驱动_挂载和卸载</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4ec8a751a4d7d0ba1200a242f0a80bd6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">部首礻和衤的区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>