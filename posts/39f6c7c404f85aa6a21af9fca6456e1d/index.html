<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux第75步_pinctrl子系统驱动和gpio子系统的常用函数 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux第75步_pinctrl子系统驱动和gpio子系统的常用函数" />
<meta property="og:description" content="1、STM32MP1的pinctrl子系统驱动
pinctrl子系统源码目录为drivers/pinctrl，一个PIN最好只能被一个外设使用。
“stm32mp151.dtsi”中有一个“pin-controller节点标签”叫pinctrl
pinctrl: pin-controller@50002000 {
#address-cells = &lt;1&gt;;
/*定义子节点的reg和ranges的addres长度为32个位*/
#size-cells = &lt;1&gt;; /*定义子节点的reg和ranges的length长度为32个位*/
compatible = &#34;st,stm32mp157-pinctrl&#34;;
/*compatible属性用于将设备和驱动绑定起来*/
ranges = &lt;0 0x50002000 0xa400&gt;; /*子节点寄存器起始地址为0*/
/*父节点寄存器起始地址为0x50002000*/
/*寄存器最大偏移地址为0xa400*/
interrupt-parent = &lt;&amp;exti&gt;;
st,syscfg = &lt;&amp;exti 0x60 0xff&gt;;
hwlocks = &lt;&amp;hsem 0 1&gt;;
pins-are-numbered;
gpioa: gpio@50002000 { /*子节点gpio起始地址为0x50002000*/
gpio-controller;
#gpio-cells = &lt;2&gt;;
/*定义描述使用一个gpio口需要提供2个指定的参数*/
interrupt-controller;
#interrupt-cells = &lt;2&gt;;
reg = &lt;0x0 0x400&gt;; /*reg属性的值:当前节点寄存器起始地址为0，长度为0x400*/
clocks = &lt;&amp;rcc GPIOA&gt;;
st,bank-name = &#34;GPIOA&#34;;
status = &#34;disabled&#34;;
};" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/39f6c7c404f85aa6a21af9fca6456e1d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-11T20:29:46+08:00" />
<meta property="article:modified_time" content="2024-03-11T20:29:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux第75步_pinctrl子系统驱动和gpio子系统的常用函数</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:.0001pt;text-align:justify;">1、STM32MP1的pinctrl子系统驱动</p> 
<p style="margin-left:.0001pt;text-align:justify;">pinctrl子系统源码目录为drivers/pinctrl，一个PIN最好只能被一个外设使用。</p> 
<p style="margin-left:.0001pt;text-align:justify;">“stm32mp151.dtsi”中有一个“<span style="color:#00b0f0;">pin-controller</span>节点标签”叫<span style="color:#984806;">pinctrl</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">pinctrl</span>: <span style="color:#00b0f0;">pin-controller@50002000</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">#address-cells = &lt;1&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*定义子节点的</span><span style="color:#00b0f0;">reg和</span><span style="color:#00b0f0;">ranges</span><span style="color:#00b050;">的</span><span style="color:#ff0000;">addres</span><span style="color:#00b050;">长度为32个位*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">#size-cells = &lt;1&gt;; </p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*定义子节点的</span><span style="color:#00b0f0;">reg和</span><span style="color:#00b0f0;">ranges</span><span style="color:#00b050;">的</span><span style="color:#ff0000;">length</span><span style="color:#00b050;">长度为32个位*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">compatible = "st,stm32mp157-pinctrl";</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*compatible属性用于将设备和驱动绑定起来*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">ranges = &lt;0 0x50002000 0xa400&gt;; </p> 
<p style="margin-left:.0001pt;text-align:justify;">            <span style="color:#00b050;">/*子节点寄存器起始地址为0*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*父节点</span><span style="color:#00b050;">寄存器起始地址为</span><span style="color:#00b050;">0x50002000</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">寄存器</span><span style="color:#00b050;">最大偏移地址为</span><span style="color:#00b050;">0xa400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-parent = &lt;&amp;exti&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,syscfg = &lt;&amp;exti 0x60 0xff&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">hwlocks = &lt;&amp;hsem 0 1&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">pins-are-numbered;</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">gpioa</span>: <span style="color:#00b0f0;">gpio@50002000</span> {<!-- --><span style="color:#00b050;">  /*子节点</span><span style="color:#00b050;">gpio</span><span style="color:#00b050;">起始地址为0x</span><span style="color:#00b050;">50002000</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#gpio-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*定义描述使用一个gpio口需要提供2个指定的参数*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#interrupt-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0x0 0x400&gt;; </p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">reg属性的值:当前</span><span style="color:#00b050;">节点寄存器起始地址为0，长度为</span><span style="color:#00b050;">0x400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">clocks = &lt;&amp;rcc GPIOA&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,bank-name = "GPIOA";</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "disabled";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">gpiob</span>: <span style="color:#00b0f0;">gpio@50003000</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#gpio-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#interrupt-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*表明引用这个中断控制器需要2个cell*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*一个是使用哪个中断，另外一个是中断触发类型*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0x1000 0x400&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">reg属性的值:</span><span style="color:#00b050;">当前节点寄存器起始地址为0x1000，长度为</span><span style="color:#00b050;">0x400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">clocks = &lt;&amp;rcc GPIOB&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,bank-name = "GPIOB";</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "disabled";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">gpioc</span>: <span style="color:#00b0f0;">gpio@50004000</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#gpio-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#interrupt-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0x2000 0x400&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">reg属性的值:</span><span style="color:#00b050;">当前节点寄存器起始地址为0x2000，长度为</span><span style="color:#00b050;">0x400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">clocks = &lt;&amp;rcc GPIOC&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,bank-name = "GPIOC";</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "disabled";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">gpiod</span>: <span style="color:#00b0f0;">gpio@50005000</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#gpio-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#interrupt-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0x3000 0x400&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">reg属性的值:</span><span style="color:#00b050;">当前节点寄存器起始地址为0x3000，长度为</span><span style="color:#00b050;">0x400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">clocks = &lt;&amp;rcc GPIOD&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,bank-name = "GPIOD";</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "disabled";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">gpioe</span>: <span style="color:#00b0f0;">gpio@50006000</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#gpio-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#interrupt-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0x4000 0x400&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">reg属性的值:</span><span style="color:#00b050;">当前节点寄存器起始地址为0x4000，长度为</span><span style="color:#00b050;">0x400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">clocks = &lt;&amp;rcc GPIOE&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,bank-name = "GPIOE";</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "disabled";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">gpiof</span>: <span style="color:#00b0f0;">gpio@50007000</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#gpio-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#interrupt-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0x5000 0x400&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">reg属性的值:</span><span style="color:#00b050;">当前节点寄存器起始地址为0x5000，长度为</span><span style="color:#00b050;">0x400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">clocks = &lt;&amp;rcc GPIOF&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,bank-name = "GPIOF";</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "disabled";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">gpiog</span>: <span style="color:#00b0f0;">gpio@50008000</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#gpio-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#interrupt-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0x6000 0x400&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">reg属性的值:</span><span style="color:#00b050;">当前节点寄存器起始地址为0x6000，长度为</span><span style="color:#00b050;">0x400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">clocks = &lt;&amp;rcc GPIOG&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,bank-name = "GPIOG";</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "disabled";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">gpioh</span>: <span style="color:#00b0f0;">gpio@50009000</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#gpio-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#interrupt-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0x7000 0x400&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">reg属性的值:</span><span style="color:#00b050;">当前节点寄存器起始地址为0x7000，长度为</span><span style="color:#00b050;">0x400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">clocks = &lt;&amp;rcc GPIOH&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,bank-name = "GPIOH";</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "disabled";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">gpioi</span>: <span style="color:#00b0f0;">gpio@5000a000</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#gpio-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#interrupt-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0x8000 0x400&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">reg属性的值:</span><span style="color:#00b050;">当前节点寄存器起始地址为0x8000，长度为</span><span style="color:#00b050;">0x400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">clocks = &lt;&amp;rcc GPIOI&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,bank-name = "GPIOI";</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "disabled";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">gpioj</span>: <span style="color:#00b0f0;">gpio@5000b000</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#gpio-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#interrupt-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0x9000 0x400&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">reg属性的值:</span><span style="color:#00b050;">当前节点寄存器起始地址为0x9000，长度为</span><span style="color:#00b050;">0x400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">clocks = &lt;&amp;rcc GPIOJ&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,bank-name = "GPIOJ";</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "disabled";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">gpiok</span>: <span style="color:#00b0f0;">gpio@5000c000</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#gpio-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#interrupt-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0xa000 0x400&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">reg属性的值:</span><span style="color:#00b050;">当前节点寄存器起始地址为0xa000，长度为</span><span style="color:#00b050;">0x400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">clocks = &lt;&amp;rcc GPIOK&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,bank-name = "GPIOK";</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "disabled";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">pinctrl_z</span>: <span style="color:#00b0f0;">pin-controller-z@54004000</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">#address-cells = &lt;1&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#size-cells = &lt;1&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">compatible = "st,stm32mp157-z-pinctrl";</p> 
<p style="margin-left:.0001pt;text-align:justify;">ranges = &lt;0 0x54004000 0x400&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">            <span style="color:#00b050;">/*子节点寄存器起始地址为0*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*父节点</span><span style="color:#00b050;">寄存器起始地址为</span><span style="color:#00b050;">0x5000</span><span style="color:#00b050;">4</span><span style="color:#00b050;">000</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">寄存器</span><span style="color:#00b050;">最大偏移地址为</span><span style="color:#00b050;">0x400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">pins-are-numbered;</p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-parent = &lt;&amp;exti&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,syscfg = &lt;&amp;exti 0x60 0xff&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">hwlocks = &lt;&amp;hsem 0 1&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">gpioz</span>: <span style="color:#00b0f0;">gpio@54004000</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#gpio-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">interrupt-controller;</p> 
<p style="margin-left:.0001pt;text-align:justify;">#interrupt-cells = &lt;2&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0 0x400&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">reg属性的值:</span><span style="color:#00b050;">当前节点寄存器起始地址为0，长度为</span><span style="color:#00b050;">0x400</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">clocks = &lt;&amp;scmi0_clk CK_SCMI0_GPIOZ&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,bank-name = "GPIOZ";</p> 
<p style="margin-left:.0001pt;text-align:justify;">st,bank-ioport = &lt;11&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "disabled";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">stm32mp15-pinctrl.dtsi中有一个<span style="color:#984806;">pinctrl</span>节点</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">&amp;pinctrl</span> {                     <span style="color:#00b050;">/*</span><span style="color:#00b050;">&amp;pinctrl</span><span style="color:#00b050;">为节点名称*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">adc1_in6_pins_a</span>: adc1-in6 {  <span style="color:#00b050;">/*</span><span style="color:#00b050;">adc1-in6</span><span style="color:#00b050;">为设备名*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">pins {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">pinmux = &lt;STM32_PINMUX('F', 12, ANALOG)&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">            <span style="color:#00b050;">/*GPIOF12用做AD输入口*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">m_can1_pins_a</span>: m-can1-0 {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">pins1 {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">pinmux = &lt;STM32_PINMUX('H', 13, AF9)&gt;; <span style="color:#00b050;">/* </span><span style="color:#00b050;">GPIOH13用作</span><span style="color:#00b050;">CAN1_TX */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">slew-rate = &lt;1&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">drive-push-pull;<span style="color:#00b050;">/*推挽输出*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">bias-disable;<span style="color:#00b050;">/*禁止使用内部偏置电压*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">pins2 {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">pinmux = &lt;STM32_PINMUX('I', 9, AF9)&gt;; <span style="color:#00b050;">/*</span><span style="color:#00b050;">GPIOI9用作</span><span style="color:#00b050;">CAN1_RX */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">bias-disable;<span style="color:#00b050;">/*禁止使用内部偏置电压*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">uart4_pins_a</span>: uart4-0 {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">pins1 {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">pinmux = &lt;STM32_PINMUX('G', 11, AF6)&gt;; <span style="color:#00b050;">/*</span><span style="color:#00b050;">GPIOG11用作</span><span style="color:#00b050;">UART4_TX */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">bias-disable;<span style="color:#00b050;">/*禁止使用内部偏置电压*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">drive-push-pull;<span style="color:#00b050;">/*推挽输出*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">slew-rate = &lt;0&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">pins2 {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">pinmux = &lt;STM32_PINMUX('B', 2, AF8)&gt;;<span style="color:#00b050;"> /*</span><span style="color:#00b050;">GPIOB2用作</span><span style="color:#00b050;">UART4_RX */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">bias-disable;<span style="color:#00b050;">/*禁止使用内部偏置电压*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">uart4_pins_b</span>: uart4-1 {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">pins1 {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">pinmux = &lt;STM32_PINMUX('D', 1, AF8)&gt;; <span style="color:#00b050;">/* </span><span style="color:#00b050;">GPIOD1用作</span><span style="color:#00b050;">UART4_TX */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">bias-disable;  <span style="color:#00b050;">/*禁止使用内部偏置电压*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">drive-push-pull; <span style="color:#00b050;">/*推挽输出*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">slew-rate = &lt;0&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">pins2 {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">pinmux = &lt;STM32_PINMUX('B', 2, AF8)&gt;; <span style="color:#00b050;">/* </span><span style="color:#00b050;">GPIOB2用作</span><span style="color:#00b050;">UART4_RX */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">bias-disable;<span style="color:#00b050;">/*禁止使用内部偏置电压*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">pwm1_pins_a</span>: pwm1-0 {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">pins {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">pinmux = &lt;STM32_PINMUX('E', 9, AF1)&gt;, <span style="color:#00b050;">/* </span><span style="color:#00b050;">GPIOE9用作</span><span style="color:#00b050;">TIM1_CH1 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"> &lt;STM32_PINMUX('E', 11, AF1)&gt;, <span style="color:#00b050;">/*</span><span style="color:#00b050;">GPIOE11用作</span><span style="color:#00b050;">TIM1_CH2 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"> &lt;STM32_PINMUX('E', 14, AF1)&gt;; <span style="color:#00b050;">/* </span><span style="color:#00b050;">GPIOE14用作</span><span style="color:#00b050;">TIM1_CH4 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">bias-pull-down;<span style="color:#00b050;">/*内部下拉*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">drive-push-pull;<span style="color:#00b050;">/*推挽输出*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">slew-rate = &lt;0&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="549" src="https://images2.imgbox.com/68/04/v3qOelvx_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">2、gpio子系统提供的常用API函数：</p> 
<p style="margin-left:.0001pt;text-align:justify;">需要包含头文件<span style="color:#00b0f0;">#include</span> &lt;linux/gpio.h&gt;</p> 
<p style="margin-left:.0001pt;text-align:justify;">1)、申请“gpio编号”</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> gpio_request(<span style="color:#0000ff;">unsigned</span> gpio, <span style="color:#0000ff;">const char</span> *label)</p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio：要申请的“gpio编号”</p> 
<p style="margin-left:.0001pt;text-align:justify;">Iabel：给这个gpio引脚设置个名字为label所指向的字符串</p> 
<p style="margin-left:.0001pt;text-align:justify;">返回值：0，申请“gpio编号”成功;其他值，申请“gpio编号”失败；</p> 
<p style="margin-left:.0001pt;text-align:justify;">注意：<span style="color:#ff0000;">GPIOA有16个引脚，因此GA0的“gpio编号”为0，GA15的“gpio编号”为15；GPIOB有16个引脚，因此GB0的“gpio编号”为16，GB15的“gpio编号”为31；GPIOC有16个引脚，因此GC0的“gpio编号”为32，GC15的“gpio编号”为47；等等以此类推</span>；</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">2)、释放“gpio编号”</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">void</span> gpio_free(<span style="color:#0000ff;">unsigned</span> gpio)</p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio：要释放的“gpio编号”</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">struct</span> MyGpioLED_dev{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">  dev_t devid; <span style="color:#00b050;">/*声明32位变量devid用来给保存设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> major; <span style="color:#00b050;">/* 主设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> minor; <span style="color:#00b050;">/* 次设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> cdev  cdev; <span style="color:#00b050;">/*字符设备结构变量cdev */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> class *class;<span style="color:#00b050;"> /* 类 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> device *device;<span style="color:#00b050;">/*设备*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> device_node *nd;<span style="color:#00b050;">/* 设备节点 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> led_gpio; <span style="color:#00b050;">/* led所使用的GPIO编号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">struct</span> MyGpioLED_dev strMyGpioLED;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">int</span> ret;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">strMyGpioLED.nd</span> = of_find_node_by_path("<span style="color:#984806;">/gpio_led</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//path="/gpio_led，使用“全路径的节点名“在“stm32mp157d-atk.dts“中查找节点“gpio_led”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//返回值:返回找到的节点，如果为NULL，表示查找失败。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">if</span>(<span style="color:#ff0000;">strMyGpioLED.nd</span> == NULL) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk("gpio_led node not find!\r\n");</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">return</span> -EINVAL;</p> 
<p style="margin-left:.0001pt;text-align:justify;">}</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">strMyGpioLED.led_gpio = of_get_named_gpio(strMyGpioLED.nd, "<span style="color:#984806;">led-gpio</span>", 0);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //在gpio_led节点中，led-gpio = &lt;&amp;gpioi 0 GPIO_ACTIVE_LOW&gt;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //np=strMyGpioLED.nd,指定的“设备节点”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //propname="led-gpio"，给定要读取的属性名字</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //Index=0,给定的GPIO索引为0</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值：正值，获取到的GPIO编号；负值，失败。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">if</span>(strMyGpioLED.led_gpio &lt; 0) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk("<span style="color:#984806;">can't get led-gpio</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">return</span> -EINVAL;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;">printk("<span style="color:#984806;">led-gpio num = %d\r\n</span>", strMyGpioLED.led_gpio);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //打印结果为：“led-gpio num = 128“</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //因为GPIO编号是从0开始的，GPIOI端口的序号是8，每个端口有16个IO口，因此GPIOI0的编号为8*16=12</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">ret = gpio_request(<span style="color:#ff0000;">strMyGpioLED</span>.led_gpio, "<span style="color:#984806;">LED-GPIO</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //gpio=strMyGpioLED.led_gpio，指定要申请的“gpio编号”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //Iabel="LED-GPIO"，给这个gpio引脚设置个名字为"LED-GPIO"</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值：0，申请“gpio编号”成功;其他值，申请“gpio编号”失败；</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">if</span> (ret) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk(KERN_ERR "<span style="color:#984806;">strMyGpioLED: Failed to request led-gpio\n</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">return</span> ret;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio_free(<span style="color:#ff0000;">strMyGpioLED</span>.led_gpio);<span style="color:#00b050;">//释放“gpio编号”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">3)、设置“某个GPIO为输入口”</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> gpio_direction_input(<span style="color:#0000ff;">unsigned</span> gpio)</p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio：要设置为输入的“gpio编号”；</p> 
<p style="margin-left:.0001pt;text-align:justify;">返回值：0，设置“某个GPIO为输入口”成功;负值，设置“某个GPIO为输入口”失败。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">4)、设置“某个GPIO为输出口”</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> gpio_direction_output(<span style="color:#0000ff;">unsigned</span> gpio, <span style="color:#0000ff;">int</span> value)</p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio：要设置为输出的“gpio编号”；</p> 
<p style="margin-left:.0001pt;text-align:justify;">Value：GPIO 默认输出值；<br> 返回值：0，设置“某个GPIO为输出口”成功;负值，设置“某个GPIO为输出口”失败。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">5)、读取某个gpio口的值</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#define</span> gpio_get_value  __gpio_get_value</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> __gpio_get_value(<span style="color:#0000ff;">unsigned</span> gpio)</p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio：要获取的“gpio编号”；</p> 
<p style="margin-left:.0001pt;text-align:justify;">返回值：非负值，返回“gpio口的值”;负值，获取“gpio口的值”失败。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">6)、设置gpio口的值为value</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#define</span> gpio_set_value  __gpio_set_value</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">void</span> __gpio_set_value(<span style="color:#0000ff;">unsigned</span> gpio, <span style="color:#0000ff;">int</span> value)</p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio：要设置的“gpio编号”；</p> 
<p style="margin-left:.0001pt;text-align:justify;">Value：要设置的值；</p> 
<p style="margin-left:.0001pt;text-align:justify;">举例：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">struct</span> MyGpioLED_dev{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">  dev_t devid; <span style="color:#00b050;">/*声明32位变量devid用来给保存设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> major; <span style="color:#00b050;">/* 主设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> minor; <span style="color:#00b050;">/* 次设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> cdev  cdev; <span style="color:#00b050;">/*字符设备结构变量cdev */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> class *class;<span style="color:#00b050;"> /* 类 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> device *device;<span style="color:#00b050;">/*设备*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> device_node *nd;<span style="color:#00b050;">/* 设备节点 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> led_gpio; <span style="color:#00b050;">/* led所使用的GPIO编号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">struct</span> MyGpioLED_dev strMyGpioLED;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">int</span> ret;</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">strMyGpioLED.nd</span> = of_find_node_by_path("<span style="color:#984806;">/gpio_led</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//path="/gpio_led，使用“全路径的节点名“在“stm32mp157d-atk.dts“中查找节点“gpio_led”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//返回值:返回找到的节点，如果为NULL，表示查找失败。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">if</span>(<span style="color:#ff0000;">strMyGpioLED.nd</span> == NULL) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk("gpio_led node not find!\r\n");</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">return</span> -EINVAL;</p> 
<p style="margin-left:.0001pt;text-align:justify;">}</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">strMyGpioLED.led_gpio = of_get_named_gpio(<span style="color:#ff0000;">strMyGpioLED</span>.nd, "<span style="color:#984806;">led-gpio</span>", 0);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //在gpio_led节点中，led-gpio = &lt;&amp;gpioi 0 GPIO_ACTIVE_LOW&gt;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //np=strMyGpioLED.nd,指定的“设备节点”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //propname="led-gpio"，给定要读取的属性名字</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //Index=0,给定的GPIO索引为0</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值：正值，获取到的GPIO编号；负值，失败。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">if</span>(strMyGpioLED.led_gpio &lt; 0) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk("<span style="color:#984806;">can't get led-gpio</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">return</span> -EINVAL;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;">printk("<span style="color:#984806;">led-gpio num = %d\r\n</span>", strMyGpioLED.led_gpio);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //打印结果为：“led-gpio num = 128“</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //因为GPIO编号是从0开始的，GPIOI端口的序号是8，每个端口有16个IO口，因此GPIOI0的编号为8*16=12</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio_set_value(strMyGpioLED-&gt;led_gpio, 0); <span style="color:#00b050;">/* 打开LED灯 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">3、与gpio相关的of函数</p> 
<p style="margin-left:.0001pt;text-align:justify;">需要包含头文件<span style="color:#00b0f0;">#include</span> &lt;linux/of_gpio.h&gt;</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">1)、根据给定的“设备节点”和“GPIO属性”，统计GPIO的数量</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> of_gpio_named_count(<span style="color:#0000ff;">struct</span> device_node *np, <span style="color:#0000ff;">const char</span> *propname)</p> 
<p style="margin-left:.0001pt;text-align:justify;">np：指定的“设备节点”。</p> 
<p style="margin-left:.0001pt;text-align:justify;">propname：要统计的GPIO属性。</p> 
<p style="margin-left:.0001pt;text-align:justify;">返回值：正值，统计到的GPIO数量；负值，失败。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">2)、根据给定的“设备节点”，统计具有“gpios属性”的GPIO的数量</p> 
<p style="margin-left:.0001pt;text-align:justify;">int of_gpio_count(struct device_node *np)</p> 
<p style="margin-left:.0001pt;text-align:justify;">np：指定的“设备节点”。</p> 
<p style="margin-left:.0001pt;text-align:justify;">返回值：正值，返回具有“gpios属性”的GPIO的数量；负值，失败。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">3)、根据给定的“设备节点”，属性名和GPIO索引，读取GPIO编号</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> of_get_named_gpio(<span style="color:#0000ff;">struct</span> device_node *np, <span style="color:#0000ff;">const char</span> *propname, <span style="color:#0000ff;">int</span> index)</p> 
<p style="margin-left:.0001pt;text-align:justify;">np：指定的“设备节点”。</p> 
<p style="margin-left:.0001pt;text-align:justify;">propname：包含要获取GPIO信息的属性名；</p> 
<p style="margin-left:.0001pt;text-align:justify;">Index：GPIO索引，因为一个属性里面可能包含多个GPIO，此参数指定要获取哪个GPIO的编号，如果只有一个GPIO信息的话此参数为0；</p> 
<p style="margin-left:.0001pt;text-align:justify;">返回值：正值，获取到的GPIO编号；负值，失败。</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">struct</span> MyGpioLED_dev{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">  dev_t devid; <span style="color:#00b050;">/*声明32位变量devid用来给保存设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> major; <span style="color:#00b050;">/* 主设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> minor; <span style="color:#00b050;">/* 次设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> cdev  cdev; <span style="color:#00b050;">/*字符设备结构变量cdev */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> class *class;<span style="color:#00b050;"> /* 类 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> device *device;<span style="color:#00b050;">/*设备*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> device_node *nd;<span style="color:#00b050;">/* 设备节点 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> led_gpio; <span style="color:#00b050;">/* led所使用的GPIO编号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">struct</span> MyGpioLED_dev strMyGpioLED;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">int</span> ret;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">strMyGpioLED.nd</span> = of_find_node_by_path("<span style="color:#984806;">/gpio_led</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//path="/gpio_led，使用“全路径的节点名“在“stm32mp157d-atk.dts“中查找节点“gpio_led”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//返回值:返回找到的节点，如果为NULL，表示查找失败。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">if</span>(<span style="color:#ff0000;">strMyGpioLED.nd</span> == NULL) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk("gpio_led node not find!\r\n");</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">return</span> -EINVAL;</p> 
<p style="margin-left:.0001pt;text-align:justify;">}</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:left;">strMyGpioLED.led_gpio = of_get_named_gpio(strMyGpioLED.nd, "<span style="color:#984806;">led-gpio</span>", 0);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //在gpio_led节点中，led-gpio = &lt;&amp;gpioi 0 GPIO_ACTIVE_LOW&gt;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //np=strMyGpioLED.nd,指定的“设备节点”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //propname="led-gpio"，给定要读取的属性名字</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //Index=0,给定的GPIO索引为0</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值：正值，获取到的GPIO编号；负值，失败。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">if</span>(strMyGpioLED.led_gpio &lt; 0) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk("<span style="color:#984806;">can't get led-gpio</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">return</span> -EINVAL;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;">printk("<span style="color:#984806;">led-gpio num = %d\r\n</span>", strMyGpioLED.led_gpio);</p> 
<p style="margin-left:.0001pt;text-align:justify;"> <span style="color:#00b050;"> //打印结果为：“led-gpio num = 128“</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //因为GPIO编号是从0开始的，GPIOI端口的序号是8，每个端口有16个IO口，因此GPIOI0的编号为8*16=128</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/521f8ee1de1287655ee0e1dfc69b33f9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux第76步_“gpio子系统”下的LED驱动</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/644278fef7f318e1b394fa94ad52a027/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">LM2904DT运算放大器中文资料规格书PDF数据手册引脚图参数图片功能概述</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>