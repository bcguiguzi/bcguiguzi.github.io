<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Python爬虫】5行代码破解验证码&#43;网页数据爬取全步骤详细记录 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Python爬虫】5行代码破解验证码&#43;网页数据爬取全步骤详细记录" />
<meta property="og:description" content="文章目录 前言一、抓包分析二、编写模块代码1.引入库2.获取验证码图片3.识别验证码4.爬取列表页5.爬取详情页6.完整代码 总结1.TIPS2.如需交流，可在代码头找到我，或者用base64解密：5b6u5L&#43;h77yabGluZ2ppZTIwMTQ= 前言 提示：内容仅限学习交流使用，切勿用于非法用途
本文用到的网址：aHR0cDovL3d3dy5jaGljdHIub3JnLmNuLw==（base64解密查看）
破解验证码方法挺多，本文介绍的是其中一种比较轻便的解决方案，适合小白上手。
爬虫需求：遍历列表页爬取每个详情页内容，需求很简单，但很多新手会卡在验证码这步，下面我们来实操一下：
一、抓包分析 通过抓包看到并没有json数据包，直接请求asp网页的，看网页设计风格估计这个网站也挺老了，搜索条件里写了几个参数，在请求的时候带上需要的字段就好
前面3页都很友好，但是从第4页开始，就出现了验证码：
输入验证码，再次抓包看请求参数，发现是多了一个验证码的参数：verifycode
看到这里，思路也就出来了，直接对网页发请求，只要带上对应的验证码参数就能正确返回数据，所以我们要在网页请求前，先得到这个验证码，因为验证码是图片格式的，而且每次点击都会自动刷新，所以要怎么样才能保证刷新的这次验证码是正确的？我们来对验证码图片抓包分析看看：
经过几次查看验证码图片包，对比请求参数，发现只有time这个参数是每次会变的，其他参数都固定
在js里面可以看到这个time其实就是JAVA里的Math.random()方法生成出来的一个0-1的随机数，而在Python里，我们可以用random.uniform(0, 1)来生成
抓包分析完，到这所有问题其实都已经解决完了，整个步骤其实就是：获取验证码-识别验证码-请求列表页-请求内容页-数据提取-数据储存。
二、编写模块代码 1.引入库 import random import requests from lxml import etree import ddddocr import openpyxl import logging 2.获取验证码图片 def getVerifyimagepage(): # 获取验证码图片 api = &#39;http://xxxxx.cn/Tools/verifyimagepage.aspx&#39; t = random.uniform(0, 1) paramas = { &#39;textcolor&#39;: 2, &#39;bgcolor&#39;: &#39;F4F4F4&#39;, &#39;ut&#39;: 1, &#39;time&#39;: t, } try: res = requests.get(api, headers=headers, params=paramas) with open(&#39;img.jpg&#39;, &#39;wb&#39;) as img: img.write(res.content) except Exception as e: print(e) 将获取到的验证码图片存储到本地目录" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/2271e686ae84bd6153959e82de790fa0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-22T16:52:33+08:00" />
<meta property="article:modified_time" content="2022-06-22T16:52:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Python爬虫】5行代码破解验证码&#43;网页数据爬取全步骤详细记录</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_4" rel="nofollow">前言</a></li><li><a href="#_15" rel="nofollow">一、抓包分析</a></li><li><a href="#_43" rel="nofollow">二、编写模块代码</a></li><li><ul><li><a href="#1_44" rel="nofollow">1.引入库</a></li><li><a href="#2_55" rel="nofollow">2.获取验证码图片</a></li><li><a href="#3_77" rel="nofollow">3.识别验证码</a></li><li><a href="#4_93" rel="nofollow">4.爬取列表页</a></li><li><a href="#5_123" rel="nofollow">5.爬取详情页</a></li><li><a href="#6_145" rel="nofollow">6.完整代码</a></li></ul> 
  </li><li><a href="#_267" rel="nofollow">总结</a></li><li><ul><li><a href="#1TIPS_268" rel="nofollow">1.TIPS</a></li><li><a href="#2base645b6u5Lh77yabGluZ2ppZTIwMTQ_271" rel="nofollow">2.如需交流，可在代码头找到我，或者用base64解密：5b6u5L+h77yabGluZ2ppZTIwMTQ=</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_4"></a>前言</h2> 
<p><code>提示：内容仅限学习交流使用，切勿用于非法用途</code></p> 
<p>本文用到的网址：aHR0cDovL3d3dy5jaGljdHIub3JnLmNuLw==（base64解密查看）</p> 
<p>破解验证码方法挺多，本文介绍的是其中一种比较轻便的解决方案，适合小白上手。</p> 
<p>爬虫需求：遍历列表页爬取每个详情页内容，需求很简单，但很多新手会卡在验证码这步，下面我们来实操一下：</p> 
<hr> 
<h2><a id="_15"></a>一、抓包分析</h2> 
<p>通过抓包看到并没有json数据包，直接请求asp网页的，看网页设计风格估计这个网站也挺老了，搜索条件里写了几个参数，在请求的时候带上需要的字段就好</p> 
<p><img src="https://images2.imgbox.com/ba/3a/J0lcuqpt_o.png" alt="在这里插入图片描述"></p> 
<p>前面3页都很友好，但是从第4页开始，就出现了验证码：</p> 
<p><img src="https://images2.imgbox.com/ef/2a/hT5heyP6_o.png" alt="在这里插入图片描述"></p> 
<p>输入验证码，再次抓包看请求参数，发现是多了一个验证码的参数：verifycode</p> 
<p><img src="https://images2.imgbox.com/34/ea/5w5Jjw6k_o.png" alt="在这里插入图片描述"></p> 
<p>看到这里，思路也就出来了，直接对网页发请求，只要带上对应的验证码参数就能正确返回数据，所以我们要在网页请求前，先得到这个验证码，因为验证码是图片格式的，而且每次点击都会自动刷新，所以要怎么样才能保证刷新的这次验证码是正确的？我们来对验证码图片抓包分析看看：</p> 
<p><img src="https://images2.imgbox.com/24/99/ea3sgjo9_o.png" alt="在这里插入图片描述"></p> 
<p>经过几次查看验证码图片包，对比请求参数，发现只有time这个参数是每次会变的，其他参数都固定</p> 
<p><img src="https://images2.imgbox.com/61/da/Gh1j7hRH_o.png" alt="在这里插入图片描述"></p> 
<p>在js里面可以看到这个time其实就是JAVA里的Math.random()方法生成出来的一个0-1的随机数，而在Python里，我们可以用random.uniform(0, 1)来生成</p> 
<p><img src="https://images2.imgbox.com/b7/13/38JQxdHY_o.png" alt="在这里插入图片描述"></p> 
<p>抓包分析完，到这所有问题其实都已经解决完了，整个步骤其实就是：获取验证码-识别验证码-请求列表页-请求内容页-数据提取-数据储存。</p> 
<h2><a id="_43"></a>二、编写模块代码</h2> 
<h3><a id="1_44"></a>1.引入库</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> random
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
<span class="token keyword">import</span> ddddocr
<span class="token keyword">import</span> openpyxl
<span class="token keyword">import</span> logging
</code></pre> 
<h3><a id="2_55"></a>2.获取验证码图片</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">getVerifyimagepage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取验证码图片</span>
    api <span class="token operator">=</span> <span class="token string">'http://xxxxx.cn/Tools/verifyimagepage.aspx'</span>
    t <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    paramas <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'textcolor'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token string">'bgcolor'</span><span class="token punctuation">:</span> <span class="token string">'F4F4F4'</span><span class="token punctuation">,</span>
        <span class="token string">'ut'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">'time'</span><span class="token punctuation">:</span> t<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>api<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> params<span class="token operator">=</span>paramas<span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'img.jpg'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> img<span class="token punctuation">:</span>
            img<span class="token punctuation">.</span>write<span class="token punctuation">(</span>res<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
</code></pre> 
<p>将获取到的验证码图片存储到本地目录</p> 
<h3><a id="3_77"></a>3.识别验证码</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">imgRecognition</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 识别验证码</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        ocr <span class="token operator">=</span> ddddocr<span class="token punctuation">.</span>DdddOcr<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            img_bytes <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        res <span class="token operator">=</span> ocr<span class="token punctuation">.</span>classification<span class="token punctuation">(</span>img_bytes<span class="token punctuation">)</span>
        <span class="token keyword">return</span> res
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
</code></pre> 
<p>识别验证码这里是引用了一个第三方库：ddddocr，对于这种大小写英文+数字的验证码足够满足需求了，识别正确率也很高，推荐新手使用。</p> 
<h3><a id="4_93"></a>4.爬取列表页</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">getList</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> verifycode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取列表页上的url</span>
    api <span class="token operator">=</span> <span class="token string">'http://xxxxx.cn/searchproj.aspx'</span>
    params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'minstudyexecutetime'</span><span class="token punctuation">:</span> <span class="token string">'2020-07-01'</span><span class="token punctuation">,</span>
        <span class="token string">'province'</span><span class="token punctuation">:</span> <span class="token string">'北京'</span><span class="token punctuation">,</span>
        <span class="token string">'btngo'</span><span class="token punctuation">:</span> <span class="token string">'btn'</span><span class="token punctuation">,</span>
        <span class="token string">'page'</span><span class="token punctuation">:</span> page<span class="token punctuation">,</span>
        <span class="token string">'verifycode'</span><span class="token punctuation">:</span> verifycode<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>api<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span>
        e <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        link_list <span class="token operator">=</span> e<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//table[@class="table_list"]/tbody/tr/td[3]/p/a/@href'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> link <span class="token keyword">in</span> link_list<span class="token punctuation">:</span>
            link <span class="token operator">=</span> <span class="token string">'http://xxxxx.cn/'</span> <span class="token operator">+</span> link
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">','</span> <span class="token operator">+</span> link <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> link<span class="token punctuation">)</span>
        <span class="token keyword">if</span> link_list<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'ok'</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
</code></pre> 
<p>把页数和识别出来的验证码文本传进来，就可以直接请求出来列表页的数据</p> 
<h3><a id="5_123"></a>5.爬取详情页</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">getDetailInfo</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 提取详情页信息</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
        e <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        title <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>e<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//div[@class="ProjetInfo_ms"][1]//tr[10]/td[2]/p/text()'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        item_info <span class="token operator">=</span> e<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//div[@class="ProjetInfo_ms"][2]'</span><span class="token punctuation">)</span>
        left_name <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>item_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//tr[1]/td[2]/p/text()'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        right_name <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>item_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//tr[1]/td[4]/p/text()'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        left_phone <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>item_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//tr[3]/td[2]/text()'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        right_phone <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>item_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//tr[3]/td[4]/text()'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        unit <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>item_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//tr[10]/td[2]/p/text()'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> title<span class="token punctuation">,</span> left_name<span class="token punctuation">,</span> right_name<span class="token punctuation">,</span> left_phone<span class="token punctuation">,</span> right_phone<span class="token punctuation">,</span> unit<span class="token punctuation">)</span>
        sh1<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>url<span class="token punctuation">,</span> title<span class="token punctuation">,</span> left_name<span class="token punctuation">,</span> left_phone<span class="token punctuation">,</span> right_name<span class="token punctuation">,</span> right_phone<span class="token punctuation">,</span> unit<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>index<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string">\n'</span></span><span class="token punctuation">)</span>
</code></pre> 
<p>详情页就非常简单了，直接请求页面没有任何限制，用xpath提取内容，最后用openpyxl做数据存储，大功告成！</p> 
<h3><a id="6_145"></a>6.完整代码</h3> 
<pre><code class="prism language-python"><span class="token comment"># !/usr/bin/env python</span>
<span class="token comment"># -*- coding:utf-8 -*-</span>
<span class="token comment"># FileName  :chictrSpider.py</span>
<span class="token comment"># Time      :2022/6/7 14:41</span>
<span class="token comment"># Author    :JACK</span>
<span class="token comment"># VX        :lingjie2014</span>
<span class="token keyword">import</span> random
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
<span class="token keyword">import</span> ddddocr
<span class="token keyword">import</span> openpyxl
<span class="token keyword">import</span> logging

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>filename<span class="token operator">=</span><span class="token string">'logging.log'</span><span class="token punctuation">,</span> level<span class="token operator">=</span>logging<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">getList</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> verifycode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取列表页的url</span>
    api <span class="token operator">=</span> <span class="token string">'http://xxxxx.cn/searchproj.aspx'</span>
    params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'minstudyexecutetime'</span><span class="token punctuation">:</span> <span class="token string">'2020-07-01'</span><span class="token punctuation">,</span>
        <span class="token string">'province'</span><span class="token punctuation">:</span> <span class="token string">'北京'</span><span class="token punctuation">,</span>
        <span class="token string">'btngo'</span><span class="token punctuation">:</span> <span class="token string">'btn'</span><span class="token punctuation">,</span>
        <span class="token string">'page'</span><span class="token punctuation">:</span> page<span class="token punctuation">,</span>
        <span class="token string">'verifycode'</span><span class="token punctuation">:</span> verifycode<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>api<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span>
        e <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        link_list <span class="token operator">=</span> e<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//table[@class="table_list"]/tbody/tr/td[3]/p/a/@href'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> link <span class="token keyword">in</span> link_list<span class="token punctuation">:</span>
            link <span class="token operator">=</span> <span class="token string">'http://xxxxx.cn/'</span> <span class="token operator">+</span> link
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">','</span> <span class="token operator">+</span> link <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> link<span class="token punctuation">)</span>
        <span class="token keyword">if</span> link_list<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'ok'</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">getVerifyimagepage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取验证码图片</span>
    api <span class="token operator">=</span> <span class="token string">'http://xxxxx.cn/Tools/verifyimagepage.aspx'</span>
    t <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    paramas <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'textcolor'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token string">'bgcolor'</span><span class="token punctuation">:</span> <span class="token string">'F4F4F4'</span><span class="token punctuation">,</span>
        <span class="token string">'ut'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">'time'</span><span class="token punctuation">:</span> t<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>api<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> params<span class="token operator">=</span>paramas<span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'img.jpg'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> img<span class="token punctuation">:</span>
            img<span class="token punctuation">.</span>write<span class="token punctuation">(</span>res<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">imgRecognition</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 识别验证码</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        ocr <span class="token operator">=</span> ddddocr<span class="token punctuation">.</span>DdddOcr<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            img_bytes <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        res <span class="token operator">=</span> ocr<span class="token punctuation">.</span>classification<span class="token punctuation">(</span>img_bytes<span class="token punctuation">)</span>
        <span class="token keyword">return</span> res
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

<span class="token keyword">def</span> <span class="token function">getDetailInfo</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 提取详情页信息</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
        e <span class="token operator">=</span> etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        title <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>e<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//div[@class="ProjetInfo_ms"][1]//tr[10]/td[2]/p/text()'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        item_info <span class="token operator">=</span> e<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//div[@class="ProjetInfo_ms"][2]'</span><span class="token punctuation">)</span>
        left_name <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>item_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//tr[1]/td[2]/p/text()'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        right_name <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>item_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//tr[1]/td[4]/p/text()'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        left_phone <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>item_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//tr[3]/td[2]/text()'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        right_phone <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>item_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//tr[3]/td[4]/text()'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        unit <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>item_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//tr[10]/td[2]/p/text()'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> title<span class="token punctuation">,</span> left_name<span class="token punctuation">,</span> right_name<span class="token punctuation">,</span> left_phone<span class="token punctuation">,</span> right_phone<span class="token punctuation">,</span> unit<span class="token punctuation">)</span>
        sh1<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>url<span class="token punctuation">,</span> title<span class="token punctuation">,</span> left_name<span class="token punctuation">,</span> left_phone<span class="token punctuation">,</span> right_name<span class="token punctuation">,</span> right_phone<span class="token punctuation">,</span> unit<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>index<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string">\n'</span></span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'Host'</span><span class="token punctuation">:</span> <span class="token string">'xxxxx.cn'</span><span class="token punctuation">,</span>
        <span class="token string">'Cookie'</span><span class="token punctuation">:</span> <span class="token string">'onlineusercount=1'</span><span class="token punctuation">,</span>
        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.60 Safari/537.36'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'url.txt'</span><span class="token punctuation">,</span> <span class="token string">'a+'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> page <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">336</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># time.sleep(1)</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'正在采集第 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>page<span class="token punctuation">}</span></span><span class="token string"> 页...'</span></span><span class="token punctuation">)</span>
            getVerifyimagepage<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 获取验证码</span>
            verifycode <span class="token operator">=</span> imgRecognition<span class="token punctuation">(</span><span class="token string">'img.jpg'</span><span class="token punctuation">)</span>   <span class="token comment"># 识别验证码</span>
            result <span class="token operator">=</span> getList<span class="token punctuation">(</span>page<span class="token punctuation">,</span> verifycode<span class="token punctuation">)</span>
            <span class="token comment"># 如果有返回数据，退出循环，否则重新获取识别验证码，重新请求</span>
            <span class="token keyword">if</span> result<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    wb <span class="token operator">=</span> openpyxl<span class="token punctuation">.</span>Workbook<span class="token punctuation">(</span><span class="token punctuation">)</span>
    all_sheetnames <span class="token operator">=</span> wb<span class="token punctuation">.</span>sheetnames
    sh1 <span class="token operator">=</span> wb<span class="token punctuation">[</span>all_sheetnames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    sh1<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'链接'</span><span class="token punctuation">,</span> <span class="token string">'标题'</span><span class="token punctuation">,</span> <span class="token string">'申请注册联系人'</span><span class="token punctuation">,</span> <span class="token string">'申请注册联系人电话'</span><span class="token punctuation">,</span> <span class="token string">'研究负责人'</span><span class="token punctuation">,</span> <span class="token string">'研究负责人电话'</span><span class="token punctuation">,</span> <span class="token string">'申请人所在单位'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    url_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'url.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
        <span class="token keyword">for</span> line <span class="token keyword">in</span> fp<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            url_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> url <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>url_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
        getDetailInfo<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token comment"># break</span>
    wb<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'all_data.xlsx'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'DONE!'</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<h2><a id="_267"></a>总结</h2> 
<h3><a id="1TIPS_268"></a>1.TIPS</h3> 
<p>本案例实际上难度不大，唯一难点也只是验证码的获取与识别，在此再次推荐一下ddddocr这个包，方便快捷，几行代码即可准确识别验证码，但如果防识别较高的验证码估计就很吃力了，另外还可以试下百度云的api也挺好用。</p> 
<h3><a id="2base645b6u5Lh77yabGluZ2ppZTIwMTQ_271"></a>2.如需交流，可在代码头找到我，或者用base64解密：5b6u5L+h77yabGluZ2ppZTIwMTQ=</h3>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a5bb8d38bcef36c05e6133147dea71e5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">meson中自定义变量的使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fa8e1fed0ecdc268d10510a77ea90d77/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java bitmap 位图</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>