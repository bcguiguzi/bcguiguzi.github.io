<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>UmiJs使用 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="UmiJs使用" />
<meta property="og:description" content="1.0 什么是UmiJs? 插件化的企业级前端应用框架 当前学习文档基于v3.x版本, 当前v4已发布
2.0 为什么使用UmiJs? 2.1 特点： 开箱即用 Umi内置了路由、构建、部署等，仅需一个依赖即可上手开发，可满足日常开发。完备路由 同时支持配置式路由和约定式路由，支持动态、权限、嵌套等功能。可扩展 Umi内容由插件完成，支持插件和插件集，以支持完成不同功能需要。业务整合 Umi因为是阿里系的前端框架，对自家的antd、ahooks、dva等整合度比较高。 2.2 对比creat-react-app? cra是封装了webpack的一个打包方案，无路由，无数据量，不支持配置，且当遇到需要修改配置时会比较困难。 2.3 缺点 umijs官方文档不明确 很多不知所云高度藕合 适合快速开发的项目 3.0 如何使用 3.1 启动 推荐使用官方推荐的工具进行项目搭建
tyarn create @umijs/umi-app 框架结构 app.ts app.tsx 在src下新建app.ts文件 启动运行时配置文件或在src下新建app.tsx文件 启动运行时配置。
import React from &#39;react&#39;; import { BasicLayoutProps, Settings as LayoutSettings, } from &#39;@ant-design/pro-layout&#39;; import he from &#39;@/assets/he.jpg&#39;; import UserInfo from &#39;@/components/UserInfo&#39;; import axios from &#39;axios&#39;; export async function getInitialState() { try { const res = await axios({ url: &#39;/yiyu/getUserInfo/&#39;, method: &#39;GET&#39; }); // 这里异步请求数据 const data = res." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/78e9a6724d640c194036d6ae6573f251/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-01T15:58:19+08:00" />
<meta property="article:modified_time" content="2023-02-01T15:58:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">UmiJs使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="10_UmiJs_0"></a>1.0 什么是UmiJs?</h2> 
<h3><a id="_2"></a>插件化的企业级前端应用框架</h3> 
<p><em>当前学习文档基于v3.x版本, 当前v4已发布</em></p> 
<h2><a id="20_UmiJs_6"></a>2.0 为什么使用UmiJs?</h2> 
<h3><a id="21__8"></a>2.1 特点：</h3> 
<ul><li><strong>开箱即用</strong> Umi内置了路由、构建、部署等，仅需一个依赖即可上手开发，可满足日常开发。</li><li><strong>完备路由</strong> 同时支持配置式路由和约定式路由，支持动态、权限、嵌套等功能。</li><li><strong>可扩展</strong> Umi内容由插件完成，支持插件和插件集，以支持完成不同功能需要。</li><li><strong>业务整合</strong> Umi因为是阿里系的前端框架，对自家的antd、ahooks、dva等整合度比较高。</li></ul> 
<h3><a id="22_creatreactapp_14"></a>2.2 对比creat-react-app?</h3> 
<ul><li>cra是封装了webpack的一个打包方案，无路由，无数据量，不支持配置，且当遇到需要修改配置时会比较困难。</li></ul> 
<h3><a id="23__17"></a>2.3 缺点</h3> 
<ul><li>umijs官方文档不明确 很多不知所云</li><li>高度藕合 适合快速开发的项目</li></ul> 
<h2><a id="30__21"></a>3.0 如何使用</h2> 
<h3><a id="31__23"></a>3.1 启动</h3> 
<p>推荐使用官方推荐的工具进行项目搭建</p> 
<pre><code class="prism language-JS"> tyarn create @umijs/umi-app
</code></pre> 
<p><a href="https://imgse.com/i/pSiai01" rel="nofollow"><img src="https://images2.imgbox.com/49/e0/Yqza2Con_o.png" alt="pSiai01.png"></a></p> 
<h4><a id="_33"></a>框架结构</h4> 
<p><a href="https://imgse.com/i/pSiaSl4" rel="nofollow"><img src="https://images2.imgbox.com/1d/6e/L7Eyy0uE_o.png" alt="pSiaSl4.png"></a></p> 
<h4><a id="appts_apptsx_36"></a>app.ts app.tsx</h4> 
<p>在src下新建app.ts文件 启动运行时配置文件或在src下新建app.tsx文件 启动运行时配置。</p> 
<pre><code class="prism language-JS">import React from 'react';
import {
  BasicLayoutProps,
  Settings as LayoutSettings,
} from '@ant-design/pro-layout';
import he from '@/assets/he.jpg';
import UserInfo from '@/components/UserInfo';
import axios from 'axios';

export async function getInitialState() {
    try {
        const res = await axios({
            url: '/yiyu/getUserInfo/',
            method: 'GET'
        });
        // 这里异步请求数据
        const data = res.data.data;
        return data;
    } catch (error) {
        console.error('获取用户信息失败', error);        
    }
}

export const layout = ({
  initialState
}): BasicLayoutProps =&gt; {
  return {
    logo: he,
    rightContentRender: () =&gt; &lt;UserInfo/&gt;,
    menuHeaderRender: undefined,
    ...initialState?.settings,
  };
};


</code></pre> 
<p>安装依赖&amp;&amp;启动</p> 
<pre><code class="prism language-JS">tyarn

tyarn start
</code></pre> 
<h4><a id="_84"></a>启动</h4> 
<p><a href="https://imgse.com/i/pSia9X9" rel="nofollow"><img src="https://images2.imgbox.com/68/7a/H8ZbkTK1_o.png" alt="pSia9X9.png"></a></p> 
<h3><a id="32__87"></a>3.2 配置</h3> 
<p>Umi是在 <strong>.umirc.ts</strong> 中进行配置</p> 
<p>常用配置</p> 
<pre><code class="prism language-JS">import { defineConfig } from 'umi';
import routes from './config/routes';

// defineConfig 增加配置提示
export default defineConfig({
  nodeModulesTransform: {   //依赖打包方式
    type: 'none',
  },
  outputPath: 'build',      //输出路径 不配置默认dist
  hash: true,               //是否启用编译hash  每次编译后文件后缀会生成hash 以防浏览器缓存
  history: {                //路由方式
    type: 'hash',
  },
  routes: routes,           //配置式路由 如果写约定式 可以不用配置
  fastRefresh: {},          //快速刷新
  locale: {                 //本地化
    antd: true,
  },
  mfsu: {},                 //提升打包速度 再非首次启动热更新时 速度非常快 依赖越多 效果越明显
  dva: {                    //dva数据流的配置项
    immer: true,
    hmr: false
  },
  devServer: {              //服务启动项配置
    port: 3000,
  },
  proxy: {                  //代理
    '/yiyunadmin': {
      'target': 'http://127.0.0.1:9999/',
      'changeOrigin': true,
      // 'pathRewrite': { '^/lk' : '' },
    },
  },
  dynamicImport: {          //组件的异步加载 开启之后 只有当使用到某个界面之后 才加载对应的
    loading: '@/components/PageLoading',  //异步加载是的自定义loading效果
  },
  title: "亿云管理平台",    //网站标题
  favicon: './hreflogo.png',  //网站标题图片
  alias: {                    //配置别名
    demo1: '/src/pages/Demo1',
  },
  layout: {                 //umi内置集成了antd Layout 可以直接通过配置进行生成layout
    name: '集成antd',
    navTheme: 'dark',
    locale: true,
    layout: 'side',
  },
});


</code></pre> 
<h3><a id="33__146"></a>3.3 路由</h3> 
<p>在配置文件中通过 routes 进行配置，格式为路由信息的数组。<br> 如果路由过多，可将路由文件提出来。新建config/routes.ts文件</p> 
<p>基本路由数据格式如下<br> 下面样例展示了 <strong>重定向 菜单权限 子路由</strong> 等路由功能</p> 
<pre><code class="prism language-JS">export default [
    { exact: true, path: '/', redirect: '/home' },
    {
        path: '/login',
        component: '@/pages/Login',
        // 不展示菜单
        menuRender: false,
        // 不展示导航
        headerRender: false,
    },
    {
        path: '/home',
        name: '首页',
        component: '@/pages/index',
        icon: 'FontColors',
    },
    {
        path: '/account',
        name: '用户',
        component: '@/pages/Account/list',
        icon: 'FontColors',
        access: 'canQuery',   //配置该路由权限
    },
    {
        path: '/test',
        component: '@/layouts/index',
        name: '测试',
        routes: [
            { path: '/test/testa', name: '测试A', component: '@/pages/Test/TestA' },
            { path: '/test/testb', name: '测试B', component: '@/pages/Test/TestB' },
        ],
    },
];

</code></pre> 
<p><em>如果不在.umirc.ts中声明路由 umijs会根据约定目录。 生成约定式路由 当你访问对应路径时 依旧可以直接访问</em></p> 
<p>路由中常用api</p> 
<p><strong>history、useLocation</strong></p> 
<p>history支持的动作 <strong>push、replace、pop</strong><br> history中location 对象，包含 <strong>pathname、search 和 hash</strong><br> 也可以直接使用<strong>useLocation</strong>获取location对象</p> 
<pre><code class="prism language-JS">
  import { history } from 'umi';

  // 跳转到指定路由
  history.push('/testa');

  // 带参数跳转到指定路由
  history.push('/list?a=b');
  history.push({
    pathname: '/list',
    query: {
      a: 'b',
    },
  });

  // 跳转到上一个路由
  history.goBack();

</code></pre> 
<h3><a id="34_Mock_220"></a>3.4 Mock</h3> 
<p>Umijs内置了mock，可以直接使用。UmiJs约定了 <strong>/mock</strong>下的所有文件均为mock文件</p> 
<p><strong>定义</strong></p> 
<pre><code class="prism language-JS">export default {
    // GET POST 可省略
    'POST /yiyu/login/': {
        code: 0,
        data: {
            name: '早坂爱',
            role: 'admin',
            id: '1001',
            token: '1213213545',
            avatar: 'https://s1.ax1x.com/2023/01/05/pSkz8gA.jpg'
        },
        message: '成功',
    },

    // 支持自定义函数
    'POST /api/users/create': (req, res) =&gt; {
        res.end('OK');
    },
};

</code></pre> 
<p><strong>使用</strong></p> 
<pre><code class="prism language-JS">const res = await axios({
            url: '/yiyu/login/',
            method: 'POST'
        });
        // 这里异步请求数据
        const data = res.data.data;
        return data;

</code></pre> 
<p><strong>效果</strong></p> 
<p><a href="https://imgse.com/i/pSiR7dO" rel="nofollow"><img src="https://images2.imgbox.com/9b/d0/Ey77OOt7_o.png" alt="pSiR7dO.png"></a></p> 
<p><a href="https://imgse.com/i/pSkzBCQ" rel="nofollow"><img src="https://images2.imgbox.com/96/b1/xj0jING9_o.png" alt="pSkzBCQ.png"></a></p> 
<p><em>更多mock使用 请参考<a href="http://mockjs.com/" rel="nofollow">Mock.JS</a></em></p> 
<h3><a id="35__267"></a>3.5 插件</h3> 
<h4><a id="351_umijspresetreact_269"></a>3.5.1 @umijs/preset-react</h4> 
<p>umijs 针对react的一个插件集合</p> 
<ul><li>plugin-antd 整合 antd UI 组件</li><li>plugin-layout 配置启用 ant-design-pro 的布局</li><li>plugin-model 基于 hooks 的简易数据流</li><li>plugin-initial-state 初始化数据管理</li><li>plugin-access 权限管理</li><li><em>plugin-request 基于 umi-request 和 umi-hooks 的请求方案</em></li><li><em>plugin-dva 整合 dva</em></li><li><em>plugin-locale 国际化能力</em></li><li><em>plugin-analytics 统计管理</em></li><li><em>plugin-crossorigin 通常用于 JS 出错统计</em></li><li><em>plugin-helmet 整合 react-helmet 管理 HTML 文档标签（如标题、描述等）</em></li></ul> 
<h4><a id="352_pluginantd_285"></a>3.5.2 plugin-antd</h4> 
<p>在umijs中 无需yarn add antd 以及配置按需加载 umijs 一步到位，可直接使用antd组件。</p> 
<h4><a id="353_pluginlayout_288"></a>3.5.3 plugin-layout</h4> 
<p>通过配置启动ant-design-pro 布局。</p> 
<p>可以配置产品名称、logo、主题色等。以及通过运行时配置登录用户展示、登出操作等。</p> 
<p>具体使用可参考3.1章节 app.tsx示例</p> 
<h4><a id="354_pluginmodel_295"></a>3.5.4 plugin-model</h4> 
<p>基于hooks的简易数据流，数据生产消费非常简单，用于项目中的全局共享数据。</p> 
<p><strong>启用</strong><br> 在src/models 目录下所有hooks modal均被认为为model</p> 
<pre><code class="prism language-JS">/**
 * 计数model
 */
import { useState } from 'react';

export default function testModel() {
    const [count, setCount] = useState(0)
  
    return {
      count,
      setCount
    }
  }

</code></pre> 
<p><strong>使用</strong></p> 
<p>通过使用useModal hooks可以拿到存在modal中的数据。</p> 
<p>useModal接受两个参数 第一个是model名。第二个是可选参数，当该组件引用了model中的某个状态，并且希望只有这个状态更新时才render。</p> 
<pre><code class="prism language-JS">import { history, useModel } from 'umi';
import { Button } from 'antd';
import { useEffect } from 'react';
export default function TestA() {
    // const { count, setCount } = useModel('testModel');
    const { count, setCount } = useModel('testModel', model =&gt; ({ count: model.count, setCount: model.setCount }));
    useEffect(() =&gt; {
        console.log('新的count来了:' + count);
    }, [count]);

    return (
        &lt;div&gt;
            &lt;h2&gt;TestA&lt;/h2&gt;
            &lt;h3&gt;{count}&lt;/h3&gt;
            &lt;Button
                onClick={() =&gt; {
                    setCount(count + 1);
                }}
            &gt;
                +
            &lt;/Button&gt;
        &lt;/div&gt;
    );
}

</code></pre> 
<p><strong>副作用</strong></p> 
<p>类比react-redux,你也可以在model中进行副作用的操作。</p> 
<pre><code class="prism language-JS">/*
 * @file: 服务列表model
 */

import { getServiceListByDoctorId } from '../service/api';

export default {
    namespace: 'serviceModel',
    state: {
        serviceNoList: [],
        selectServiceNo: null,
    },
    reducers: {
        saveServiceList(state, { payload }) {
            return {
                ...state,
                serviceNoList: payload,
            };
        },
        saveSelectService(state, { payload }) {
            return {
                ...state,
                selectServiceNo: payload,
            };
        },
    },
    effects: {
        // 查询服务列表
        *queryServiceList({ payload }, { call, put }) {
            const { data } = yield call(getServiceListByDoctorId, payload);
            let list = [];
            if(data &amp;&amp; data.info &amp;&amp; data.info instanceof Array &amp;&amp; data.info.length) {
                data.info.forEach(item =&gt; {
                    list.push({
                        ...item,
                        value: item.serviceid,
                        label: item.title
                    });
                });
                // 判断下是否正常
                yield put({
                    type: 'saveServiceList',
                    payload:  list
                });
                yield put({
                    type: 'saveSelectService',
                    payload: list[0].value
                });
            }
        },
    },
};


</code></pre> 
<h4><a id="355_plugininitialstate_412"></a>3.5.5 plugin-initial-state</h4> 
<p>在src下新建app.ts并在次文件中导出<strong>getInitialState</strong>方法时启动。</p> 
<p><strong>定义</strong><br> 在此方法中 可以放一些需要全局消费的数据 比如当前登录者的信息</p> 
<pre><code class="prism language-JS">//src/app.ts
export async function getInitialState() {
    try {
        const res = await axios({
            url: '/yiyu/getUserInfo/',
            method: 'GET'
        });
        // 这里异步请求数据
        const data = res.data.data;
        return data;
    } catch (error) {
        console.error('获取用户信息失败', error);        
    }
}
</code></pre> 
<p><strong>使用</strong></p> 
<pre><code class="prism language-JS">import { useModal } from 'umi';

export default function index() {

  const { initialState } = useModel('@@initialState');
  const loginInfo = initialState;

  return (
    &lt;span&gt;{loginInfo?.name}欢迎您&lt;/span&gt;
  );
}

</code></pre> 
<h4><a id="356_pluginaccess_453"></a>3.5.6 plugin-access</h4> 
<p>权限插件，关于路由权限或者页面操作级别的权限均可通过此插件实现。<br> 约定创建src/access.ts启用，改文件在项目初始时被执行，文件内需要返回一个对象，该对象的每个键值对代表定义的权限。</p> 
<p><strong>定义权限</strong></p> 
<pre><code class="prism language-JS">
// 权限插件  新建access.tsx 代表开启该插件
interface User {
    role: string;
    userId: string;
}

export default function (initialState: User) {
    const { userId, role } = initialState;

    return {
        // 定义是否可查询
        // canQuery: true,
        canQuery: false,
        // 定义是否可新增
        canAdd: role === 'admin',
        // 定义是否可批量删除
        canBatchDelete: role === 'admin',
        // 定义只能删除普通用户
        canDeleteFoo: (role: string) =&gt; {
            return role === 'ordinary';
        },
    };
}

</code></pre> 
<p><strong>使用权限</strong></p> 
<p>可以通过useAccess hooks获取权限对象，通过Access包裹需要控制权限的组件。<br> 以此达到对操作级别的权限控制。</p> 
<pre><code class="prism language-JS">import { useAccess, Access } from 'umi';

// 获取权限对象
const access = useAccess();

&lt;Access accessible={access.canDeleteFoo(record.role)}&gt;
  &lt;span&gt;删除&lt;/span&gt;
&lt;/Access&gt;

// 通过权限Access包裹组件
&lt;Access accessible={access.canBatchDelete}&gt;
  &lt;Button className="delete" disabled={!selectKeyTable.length}&gt;
    批量删除
  &lt;/Button&gt;
&lt;/Access&gt;

</code></pre> 
<p><strong>配合路由使用</strong></p> 
<p>可以在路由配置项中增加access字段。以此来达到控制菜单的权限</p> 
<pre><code class="prism language-JS">
/*
 * @file:全局路由
 */
export default [
    {
        path: '/account',
        name: '用户',
        component: '@/pages/Account/list',
        icon: 'FontColors',
        // 只有用户权限canQuery为true的才能查看用户这个菜单 否则不显示此菜单
        access: 'canQuery',
    }
];

</code></pre> 
<p><em>其他插件大家有兴趣或需要用到的可以自己研究下</em></p> 
<h2><a id="40__537"></a>4.0 结语</h2> 
<p>以上是目前学到并用到的umijs的知识</p> 
<p><a href="https://gitee.com/NaMiSuang/umijs-demo" rel="nofollow">文档中的demo</a><br> <a href="https://v3.umijs.org/zh-CN/docs" rel="nofollow">umijs文档</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d1420bb28df6b5e40bde9423c54e51ab/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Tomcat线程池重复使用，threadloacl使用不释放问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/111ed9d8746c78daf5084d7b7ac52c0d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">iptables-1.8.4 版本 -m state模块加载出错</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>