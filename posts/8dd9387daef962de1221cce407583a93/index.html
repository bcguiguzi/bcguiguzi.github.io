<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Go操作Redis - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Go操作Redis" />
<meta property="og:description" content="准备环境 首先需要安装docker， 可参考菜鸟教程， docker环境配置好后，从docker hub 上拉一个redis镜像：
docker pull nginx 默认拉取最新版本的镜像
拉取镜像后可以运行容器：
docker run -d -p 6379:6379 --name redis redis 参数说明
-d指定后台运行容器 -p配置内外端口映射 --name 指定运行容器的名字
再启动一个redis-cli连接上面启动的redis服务
docker run -it --network host --rm redis redis-cli 参数说明
-it进入到运行的容器中 --network指定网络模式为host模式 --rm停止容器后自动删除挂载点
go-redis库 使用go-redis库连接操作redis数据库，go-redis库支持连接哨兵及集群模式的redis
使用以下命令安装
go get -u github.com/go-redis/redis 运行go get -u将会升级到最新的次要版本或者修订版本(x.y.z, z是修订版本号， y是次要版本号)
连接 import &#34;github.com/go-redis/redis&#34; // 声明全局rdb变量 var rdb *redis.Client func initClient() (err error) { rdb = redis.NewClient(&amp;redis.Options{ Addr: &#34;localhost:6379&#34;, Password: &#34;&#34;, DB: 0, }) _, err = rdb." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/8dd9387daef962de1221cce407583a93/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-09T14:11:01+08:00" />
<meta property="article:modified_time" content="2022-01-09T14:11:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Go操作Redis</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>准备环境</h2> 
<p>首先需要安装docker， 可参考<a href="https://www.runoob.com/docker/docker-tutorial.html" rel="nofollow">菜鸟教程</a>， docker环境配置好后，从docker hub 上拉一个redis镜像：</p> 
<pre><code>docker pull nginx
</code></pre> 
<blockquote> 
 <p>默认拉取最新版本的镜像</p> 
</blockquote> 
<p>拉取镜像后可以运行容器：</p> 
<pre><code>docker run -d -p 6379:6379 --name redis redis
</code></pre> 
<blockquote> 
 <p>参数说明<br> -d指定后台运行容器 -p配置内外端口映射 --name 指定运行容器的名字<br> 再启动一个redis-cli连接上面启动的redis服务</p> 
</blockquote> 
<pre><code>docker run -it --network host --rm redis redis-cli
</code></pre> 
<blockquote> 
 <p>参数说明<br> -it进入到运行的容器中 --network指定网络模式为<a href="https://www.cnblogs.com/freeaihub/p/13197292.html" rel="nofollow">host模式</a> --rm停止容器后自动删除挂载点</p> 
</blockquote> 
<h2><a id="goredis_20"></a>go-redis库</h2> 
<p>使用go-redis库连接操作redis数据库，go-redis库支持连接哨兵及集群模式的redis<br> 使用以下命令安装</p> 
<pre><code>go get -u github.com/go-redis/redis
</code></pre> 
<blockquote> 
 <p>运行go get -u将会升级到最新的次要版本或者修订版本(x.y.z, z是修订版本号， y是次要版本号)</p> 
</blockquote> 
<h3><a id="_28"></a>连接</h3> 
<pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token string">"github.com/go-redis/redis"</span>

<span class="token comment">// 声明全局rdb变量</span>
<span class="token keyword">var</span> rdb <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client

<span class="token keyword">func</span> <span class="token function">initClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	rdb <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>Options<span class="token punctuation">{<!-- --></span>
		Addr<span class="token punctuation">:</span>     <span class="token string">"localhost:6379"</span><span class="token punctuation">,</span>
		Password<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
		DB<span class="token punctuation">:</span>       <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> rdb<span class="token punctuation">.</span><span class="token function">Ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_48"></a>基本使用</h3> 
<h4><a id="setget_49"></a>set/get示例</h4> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">redisExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"set score failed, err: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	val<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"get score faild, err: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>
	val2<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> redis<span class="token punctuation">.</span>Nil <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"name dose not exist\n"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"get name failed , err: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> val2<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="zset_75"></a>zset示例</h4> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">redisExample2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	zsetKey <span class="token operator">:=</span> <span class="token string">"language_rank"</span>
	languages <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>redis<span class="token punctuation">.</span>Z<span class="token punctuation">{<!-- --></span>
		redis<span class="token punctuation">.</span>Z<span class="token punctuation">{<!-- --></span>Score<span class="token punctuation">:</span> <span class="token number">90.0</span><span class="token punctuation">,</span> Member<span class="token punctuation">:</span> <span class="token string">"Golang"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		redis<span class="token punctuation">.</span>Z<span class="token punctuation">{<!-- --></span>Score<span class="token punctuation">:</span> <span class="token number">98.0</span><span class="token punctuation">,</span> Member<span class="token punctuation">:</span> <span class="token string">"Java"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		redis<span class="token punctuation">.</span>Z<span class="token punctuation">{<!-- --></span>Score<span class="token punctuation">:</span> <span class="token number">95.0</span><span class="token punctuation">,</span> Member<span class="token punctuation">:</span> <span class="token string">"Python"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		redis<span class="token punctuation">.</span>Z<span class="token punctuation">{<!-- --></span>Score<span class="token punctuation">:</span> <span class="token number">97.0</span><span class="token punctuation">,</span> Member<span class="token punctuation">:</span> <span class="token string">"JavaScript"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		redis<span class="token punctuation">.</span>Z<span class="token punctuation">{<!-- --></span>Score<span class="token punctuation">:</span> <span class="token number">99.0</span><span class="token punctuation">,</span> Member<span class="token punctuation">:</span> <span class="token string">"c/c++"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// ZADD</span>
	num<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">ZAdd</span><span class="token punctuation">(</span>zsetKey<span class="token punctuation">,</span> languages<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"zadd failed err: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"zadd %d succ. \n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span>

	<span class="token comment">// 把Golang的分数加10</span>
	newScore<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">ZIncrBy</span><span class="token punctuation">(</span>zsetKey<span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token string">"Golang"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"zincrby failed err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Golang's score is %f now.\n"</span><span class="token punctuation">,</span> newScore<span class="token punctuation">)</span>

	<span class="token comment">// 取分数最高的三个</span>
	ret<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">ZRevRangeWithScores</span><span class="token punctuation">(</span>zsetKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"zrevrange failed, err: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> z <span class="token operator">:=</span> <span class="token keyword">range</span> ret <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span>Member<span class="token punctuation">,</span> z<span class="token punctuation">.</span>Score<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 取 95~100分的</span>
	op <span class="token operator">:=</span> redis<span class="token punctuation">.</span>ZRangeBy<span class="token punctuation">{<!-- --></span>Min<span class="token punctuation">:</span> <span class="token string">"95"</span><span class="token punctuation">,</span> Max<span class="token punctuation">:</span> <span class="token string">"100"</span><span class="token punctuation">}</span>
	ret<span class="token punctuation">,</span> err <span class="token operator">=</span> rdb<span class="token punctuation">.</span><span class="token function">ZRangeByScoreWithScores</span><span class="token punctuation">(</span>zsetKey<span class="token punctuation">,</span> op<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"zrangeByscore failed err: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> z <span class="token operator">:=</span> <span class="token keyword">range</span> ret <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span>Member<span class="token punctuation">,</span> z<span class="token punctuation">.</span>Score<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="key_124"></a>根据前缀获取key</h4> 
<pre><code class="prism language-go">keys<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Keys</span><span class="token punctuation">(</span><span class="token string">"pattern*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_128"></a>执行自定义命令</h4> 
<pre><code class="prism language-go">res<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token string">"set"</span><span class="token punctuation">,</span> <span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="key_132"></a>按照通配符删除key</h4> 
<p>当通配符匹配的key的数量不多时，可以使用Keys()得到所有的key在使用Del命令删除。 如果key的数量非常多的时候，我们可以搭配使用Scan命令和Del命令完成删除</p> 
<pre><code class="prism language-go">iter <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"pattern*"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> iter<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">Val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> iter<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="pipeline_146"></a>pipeline</h4> 
<p>客户端缓存一堆命令，一次性发送到服务器，这些命令不能保证在事务中执行，但好处是节省了命令的网络往返时间（<a href="https://www.zhihu.com/question/39244840" rel="nofollow">RTT</a>）<br> 基本示例：</p> 
<pre><code class="prism language-go">pipe <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

incr <span class="token operator">:=</span> pipe<span class="token punctuation">.</span><span class="token function">Incr</span><span class="token punctuation">(</span><span class="token string">"pipeline_counter"</span><span class="token punctuation">)</span>
pipe<span class="token punctuation">.</span><span class="token function">Expire</span><span class="token punctuation">(</span><span class="token string">"pipeline_counter"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>

<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> pipe<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>incr<span class="token punctuation">.</span><span class="token function">Val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
</code></pre> 
<p>相当于发送一下两个命令给redis server，节省了一次RTT时间</p> 
<pre><code>INCR pipeline_counter
EXPIRE pipeline_counts 3600
</code></pre> 
<p>同样可以使用<code>Pipelined</code></p> 
<pre><code class="prism language-go"><span class="token keyword">var</span> incr <span class="token operator">*</span>redis<span class="token punctuation">.</span>IntCmd
<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Pipelined</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>pipe redis<span class="token punctuation">.</span>Pipeliner<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	incr <span class="token operator">=</span> pipe<span class="token punctuation">.</span><span class="token function">Incr</span><span class="token punctuation">(</span><span class="token string">"pipelined_counter"</span><span class="token punctuation">)</span>
	pipe<span class="token punctuation">.</span><span class="token function">Expire</span><span class="token punctuation">(</span><span class="token string">"pipelined_counter"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>incr<span class="token punctuation">.</span><span class="token function">Val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_176"></a>事务</h4> 
<p>redis是单线程的，因而每个命令都是原子的，但是不同客户端发送的命令可能会交错执行，通过事务可以<strong>串联多个命令</strong>防止别的命令插队<br> 在这种场景我们需要使用TxPipeline。TxPipeline总体上类似于上面的Pipeline，但是它内部会使用MULTI/EXEC包裹排队的命令。例如：</p> 
<pre><code class="prism language-go">pipe <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">TxPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

incr <span class="token operator">:=</span> pipe<span class="token punctuation">.</span><span class="token function">Incr</span><span class="token punctuation">(</span><span class="token string">"tx_pipeline_counter"</span><span class="token punctuation">)</span>
pipe<span class="token punctuation">.</span><span class="token function">Expire</span><span class="token punctuation">(</span><span class="token string">"tx_pipeline_counter"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>

<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> pipe<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>incr<span class="token punctuation">.</span><span class="token function">Val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
</code></pre> 
<p>相当于在一个RTT下执行了以下命令</p> 
<pre><code class="prism language-go">MULTI
INCR pipeline_counter
EXPIRE pipeline_counts <span class="token number">3600</span>
EXEC
</code></pre> 
<p>类似的TxPipelined如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">var</span> incr <span class="token operator">*</span>redis<span class="token punctuation">.</span>IntCmd
<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">TxPipelined</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>pipe redis<span class="token punctuation">.</span>Pipeliner<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	incr <span class="token operator">=</span> pipe<span class="token punctuation">.</span><span class="token function">Incr</span><span class="token punctuation">(</span><span class="token string">"tx_pipelined_counter"</span><span class="token punctuation">)</span>
	pipe<span class="token punctuation">.</span><span class="token function">Expire</span><span class="token punctuation">(</span><span class="token string">"tx_pipelined_counter"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>incr<span class="token punctuation">.</span><span class="token function">Val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="watch_208"></a>watch</h4> 
<p>在执行multi之前，先执行watch key1 [key2],可以监视一个(或多个) key ，如果在事务执行之前这个(或这些) key 被其他命令所改动，那么事务将被打断，返回一个错误，用户可以根据这个错误选择重试或者放弃这个事务。</p> 
<p>Watch方法接收一个函数和一个或多个key作为参数。基本使用示例如下：</p> 
<pre><code class="prism language-go"><span class="token comment">// 监视watch_count的值，并在值不变的前提下将其值+1</span>
key <span class="token operator">:=</span> <span class="token string">"watch_count"</span>
err <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">Watch</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>redis<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	n<span class="token punctuation">,</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> redis<span class="token punctuation">.</span>Nil <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Pipelined</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>pipe redis<span class="token punctuation">.</span>Pipeliner<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
		pipe<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
</code></pre> 
<p>下面是go-redisV8版本的官方文档中使用GET和SET命令以事务方式递增Key的值的示例，仅当Key的值不发生变化时提交一个事务。</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">transactionDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		maxRetries   <span class="token operator">=</span> <span class="token number">1000</span>
		routineCount <span class="token operator">=</span> <span class="token number">10</span>
	<span class="token punctuation">)</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Increment 使用GET和SET命令以事务方式递增Key的值</span>
	increment <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 事务函数</span>
		txf <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>redis<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 获得key的当前值或零值</span>
			n<span class="token punctuation">,</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> redis<span class="token punctuation">.</span>Nil <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>

			<span class="token comment">// 实际的操作代码（乐观锁定中的本地操作）</span>
			n<span class="token operator">++</span>

			<span class="token comment">// 操作仅在 Watch 的 Key 没发生变化的情况下提交</span>
			<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">TxPipelined</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>pipe redis<span class="token punctuation">.</span>Pipeliner<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
				pipe<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>

		<span class="token comment">// 最多重试 maxRetries 次</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxRetries<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
			err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Watch</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> txf<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 成功</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> redis<span class="token punctuation">.</span>TxFailedErr <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 乐观锁丢失 重试</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 返回其他的错误</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"increment reached maximum number of retries"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 模拟 routineCount 个并发同时去修改 counter3 的值</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>routineCount<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> routineCount<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">"counter3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"increment error:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	n<span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"counter3"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ended with"</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_295"></a>参考</h2> 
<p><a href="https://www.liwenzhou.com/posts/Go/go_redis/#autoid-2-2-1" rel="nofollow">Go语言操作Redis</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f0523543b0b3782491418b41dee161ee/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">这可能是最好的Redis分布式锁实现了</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e0c547ca347afd0e90899c1dd61a079f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android 12 系统源码分析 | Native Binder 代码变迁</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>