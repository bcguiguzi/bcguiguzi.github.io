<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android Wi-Fi Ethernet新IP获取机制—IpManager(Android 7.0) - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android Wi-Fi Ethernet新IP获取机制—IpManager(Android 7.0)" />
<meta property="og:description" content="1 android N之前 Ethernet旧的ip获取 Android N之前，即android 5.0和android 6.0的IP获取机制都是通过/system/bin下面的dhcpcd的bin档去拿的ip
//EthernetNetworkFactory.java (frameworks\opt\net\ethernet\java\com\android\server\ethernet) public void onRequestNetwork() { // TODO: Handle DHCP renew. Thread dhcpThread = new Thread(new Runnable() { public void run() { ... DhcpResults dhcpResults = new DhcpResults(); // TODO: Handle DHCP renewals better. // In general runDhcp handles DHCP renewals for us, because // the dhcp client stays running, but if the renewal fails, // we will lose our IP address and connectivity without // noticing." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/95f15ec25dc748601dac1de54dd0a23c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-07-17T10:22:46+08:00" />
<meta property="article:modified_time" content="2017-07-17T10:22:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android Wi-Fi Ethernet新IP获取机制—IpManager(Android 7.0)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3 style="color:inherit; font-family:inherit; widows:1; margin:1em 0px 0.6em; font-weight:500; line-height:40px; font-size:31.5px"> <span class="mark" style="border:0px; color:rgb(41,117,77); font-size:28.35px; padding:2px 4px; background-color:rgb(221,243,231)">1 android N之前 Ethernet旧的ip获取</span></h3> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> Android N之前，即android 5.0和android 6.0的IP获取机制都是通过/system/bin下面的dhcpcd的bin档去拿的ip</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'><span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//EthernetNetworkFactory.java (frameworks\opt\net\ethernet\java\com\android\server\ethernet)</span><br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">onRequestNetwork</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// TODO: Handle DHCP renew.</span><br style="margin:0px; border:0px; background-color:inherit">        Thread dhcpThread = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> Thread(<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> Runnable() {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">run</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        ...<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">                    DhcpResults dhcpResults = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> DhcpResults();<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// TODO: Handle DHCP renewals better.</span><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// In general runDhcp handles DHCP renewals for us, because</span><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// the dhcp client stays running, but if the renewal fails,</span><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// we will lose our IP address and connectivity without</span><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// noticing.</span><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//通过这个函数call到jni之后，最后run /system/bin/dhcpcd</span><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (!NetworkUtils.runDhcp(mIface, dhcpResults)) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        Log.e(TAG, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"DHCP request error:"</span> + NetworkUtils.getDhcpError());<br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// set our score lower than any network could go</span><br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// so we get dropped.</span><br style="margin:0px; border:0px; background-color:inherit">                        mFactory.setScoreFilter(-<span class="hljs-number" style="background-color:inherit">1</span>);<br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span>;<br style="margin:0px; border:0px; background-color:inherit">                    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 不知道是不是dhcpcd本身的问题，这段code其实不是稳定，超时拿不到ip的现象经常可以遇到。只能在这里多加几次try runDhcp。</p> 
<div class="xiaoshujiang_element xsj_anchor" style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:1"> 
 <a target="_blank" class="blank_anchor_name" href="http://undefined/" rel="nofollow noopener noreferrer" style="color:rgb(0,136,204); background-color:inherit"></a> 
 <a target="_blank" class="blank_anchor_id" href="http://undefined/" rel="nofollow noopener noreferrer" style="color:rgb(0,136,204); float:left; visibility:hidden; background-color:inherit"></a> 
</div> 
<h3 style="color:inherit; font-family:inherit; widows:1; margin:1em 0px 0.6em; font-weight:500; line-height:40px; font-size:31.5px"> <span class="mark" style="border:0px; color:rgb(41,117,77); font-size:28.35px; padding:2px 4px; background-color:rgb(221,243,231)">2 android N新的拿IP的机制</span></h3> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> android N不要了runDhcpcd(),而是通过DhcpClient，这个是android M引入的wifi那边另外一种获得ip的方式，DhcpClient是通过framework发送dhcpcd协议的UDP请求包直接去拿IP，不再使用开源的dhcpcd。在调用DhcpClient的基础之前，google还用了一个状态机IpManager来管理dhcpcd成功还是失败等状态，将ip赋值给IpConfiguration和LinkProperties传递到上层的framework。还有就是加入ipv6的支持，不过ipv6的部分目前还没做好。</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'><span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//EthernetNetworkFactory.java (frameworks\opt\net\ethernet\java\com\android\server\ethernet)    </span><br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">final</span> Thread ipProvisioningThread = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> Thread(<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> Runnable() {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">run</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (DBG) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                    Log.d(TAG, String.format(<span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"starting ipProvisioningThread(%s): mNetworkInfo=%s"</span>,<br style="margin:0px; border:0px; background-color:inherit">                            mIface, mNetworkInfo));<br style="margin:0px; border:0px; background-color:inherit">                }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">                LinkProperties linkProperties;<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">                IpConfiguration config = mEthernetManager.getConfiguration();<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (config.getIpAssignment() == IpAssignment.STATIC) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (!setStaticIpAddress(config.getStaticIpConfiguration())) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// We've already logged an error.</span><br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span>;<br style="margin:0px; border:0px; background-color:inherit">                    }<br style="margin:0px; border:0px; background-color:inherit">                    linkProperties = config.getStaticIpConfiguration().toLinkProperties(mIface);<br style="margin:0px; border:0px; background-color:inherit">                } <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">else</span> {<!-- --><br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">                    mNetworkInfo.setDetailedState(DetailedState.OBTAINING_IPADDR, <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>, mHwAddr);<br style="margin:0px; border:0px; background-color:inherit">                    WaitForProvisioningCallback ipmCallback = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> WaitForProvisioningCallback() {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">onLinkPropertiesChange</span><span class="hljs-params" style="background-color:inherit">(LinkProperties newLp)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">                            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">synchronized</span>(EthernetNetworkFactory.<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">this</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (mNetworkAgent != <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span> &amp;&amp; mNetworkInfo.isConnected()) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                                    mLinkProperties = newLp;<br style="margin:0px; border:0px; background-color:inherit">                                    mNetworkAgent.sendLinkProperties(newLp);<br style="margin:0px; border:0px; background-color:inherit">                                }<br style="margin:0px; border:0px; background-color:inherit">                            }<br style="margin:0px; border:0px; background-color:inherit">                        }<br style="margin:0px; border:0px; background-color:inherit">                    };<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">synchronized</span>(EthernetNetworkFactory.<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">this</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        stopIpManagerLocked();<br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//IPManger，用这个代替之前的runDhcpcd（）</span><br style="margin:0px; border:0px; background-color:inherit">                        mIpManager = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> IpManager(mContext, mIface, ipmCallback);<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (config.getProxySettings() == ProxySettings.STATIC ||<br style="margin:0px; border:0px; background-color:inherit">                                config.getProxySettings() == ProxySettings.PAC) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                            mIpManager.setHttpProxy(config.getHttpProxy());<br style="margin:0px; border:0px; background-color:inherit">                        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">final</span> String tcpBufferSizes = mContext.getResources().getString(<br style="margin:0px; border:0px; background-color:inherit">                                com.android.internal.R.string.config_ethernet_tcp_buffers);<br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (!TextUtils.isEmpty(tcpBufferSizes)) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                            mIpManager.setTcpBufferSizes(tcpBufferSizes);<br style="margin:0px; border:0px; background-color:inherit">                        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">final</span> ProvisioningConfiguration provisioningConfiguration =<br style="margin:0px; border:0px; background-color:inherit">                                mIpManager.buildProvisioningConfiguration()<br style="margin:0px; border:0px; background-color:inherit">                                        .withProvisioningTimeoutMs(<span class="hljs-number" style="background-color:inherit">0</span>)<br style="margin:0px; border:0px; background-color:inherit">                                        .build();<br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//start</span><br style="margin:0px; border:0px; background-color:inherit">                        mIpManager.startProvisioning(provisioningConfiguration);<br style="margin:0px; border:0px; background-color:inherit">                    }<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//通过callback去拿到新的IP</span><br style="margin:0px; border:0px; background-color:inherit">                    linkProperties = ipmCallback.waitForProvisioning();<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (linkProperties == <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        Log.e(TAG, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"IP provisioning error"</span>);<br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// set our score lower than any network could go</span><br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// so we get dropped.</span><br style="margin:0px; border:0px; background-color:inherit">                        mFactory.setScoreFilter(-<span class="hljs-number" style="background-color:inherit">1</span>);<br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">synchronized</span>(EthernetNetworkFactory.<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">this</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                            stopIpManagerLocked();<br style="margin:0px; border:0px; background-color:inherit">                        }<br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span>;<br style="margin:0px; border:0px; background-color:inherit">                    }<br style="margin:0px; border:0px; background-color:inherit">                }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> IpManager</p> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> IpManager，是wifi和Ethernet都会用到。把它定义为获取ip的管理器好了。</p> 
<div class="xiaoshujiang_element xsj_anchor" style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:1"> 
 <a target="_blank" class="blank_anchor_name" href="http://undefined/" rel="nofollow noopener noreferrer" style="color:rgb(0,136,204); background-color:inherit"></a> 
 <a target="_blank" class="blank_anchor_id" href="http://undefined/" rel="nofollow noopener noreferrer" style="color:rgb(0,136,204); float:left; visibility:hidden; background-color:inherit"></a> 
</div> 
<h4 style="color:inherit; font-family:inherit; widows:1; margin:1em 0px 0.6em; font-weight:500; line-height:1.1; font-size:24.5px"> <span class="mark" style="border:0px; color:rgb(41,117,77); font-size:22.05px; padding:2px 4px; background-color:rgb(221,243,231)">2.1 构造函数</span></h4> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">IpManager</span><span class="hljs-params" style="background-color:inherit">(Context context, String ifName, Callback callback)</span><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">throws</span> IllegalArgumentException </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">this</span>(context, ifName, callback, INetworkManagementService.Stub.asInterface(<br style="margin:0px; border:0px; background-color:inherit">                ServiceManager.getService(Context.NETWORKMANAGEMENT_SERVICE)));<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">    <span class="hljs-javadoc" style="color:rgb(128,128,128); background-color:inherit">/**<br style="margin:0px; border:0px; background-color:inherit">     * An expanded constructor, useful for dependency injection.<br style="margin:0px; border:0px; background-color:inherit">     */</span><br style="margin:0px; border:0px; background-color:inherit">    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">IpManager</span><span class="hljs-params" style="background-color:inherit">(Context context, String ifName, Callback callback,<br style="margin:0px; border:0px; background-color:inherit">            INetworkManagementService nwService)</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">throws</span> IllegalArgumentException </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">super</span>(IpManager.class.getSimpleName() + <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"."</span> + ifName);<br style="margin:0px; border:0px; background-color:inherit">        mTag = getName();<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        mContext = context;<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//网口的名字,eth0 or wlan0</span><br style="margin:0px; border:0px; background-color:inherit">        mInterfaceName = ifName;<br style="margin:0px; border:0px; background-color:inherit">        mClatInterfaceName = CLAT_PREFIX + ifName;<br style="margin:0px; border:0px; background-color:inherit">        mCallback = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> LoggingCallbackWrapper(callback);<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//NetworkManagementService对象，可以对Interface做一些操作</span><br style="margin:0px; border:0px; background-color:inherit">        mNwService = nwService;<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//检测Interface的状态变化</span><br style="margin:0px; border:0px; background-color:inherit">        mNetlinkTracker = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> NetlinkTracker(<br style="margin:0px; border:0px; background-color:inherit">                mInterfaceName,<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> NetlinkTracker.Callback() {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">update</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        sendMessage(EVENT_NETLINK_LINKPROPERTIES_CHANGED);<br style="margin:0px; border:0px; background-color:inherit">                    }<br style="margin:0px; border:0px; background-color:inherit">                }) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">interfaceAdded</span><span class="hljs-params" style="background-color:inherit">(String iface)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">super</span>.interfaceAdded(iface);<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (mClatInterfaceName.equals(iface)) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                    mCallback.setNeighborDiscoveryOffload(<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">false</span>);<br style="margin:0px; border:0px; background-color:inherit">                }<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">interfaceRemoved</span><span class="hljs-params" style="background-color:inherit">(String iface)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">super</span>.interfaceRemoved(iface);<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (mClatInterfaceName.equals(iface)) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// TODO: consider sending a message to the IpManager main</span><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// StateMachine thread, in case "NDO enabled" state becomes</span><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// tied to more things that 464xlat operation.</span><br style="margin:0px; border:0px; background-color:inherit">                    mCallback.setNeighborDiscoveryOffload(<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">true</span>);<br style="margin:0px; border:0px; background-color:inherit">                }<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        };<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">try</span> {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            mNwService.registerObserver(mNetlinkTracker);<br style="margin:0px; border:0px; background-color:inherit">        } <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">catch</span> (RemoteException e) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            Log.e(mTag, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Couldn't register NetlinkTracker: "</span> + e.toString());<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//LinkProperties里面记录着网络相关的ip和dns等信息，这个在connectivityservice中会被使用到</span><br style="margin:0px; border:0px; background-color:inherit">        resetLinkProperties();<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        mProvisioningTimeoutAlarm = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> WakeupMessage(mContext, getHandler(),<br style="margin:0px; border:0px; background-color:inherit">                mTag + <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">".EVENT_PROVISIONING_TIMEOUT"</span>, EVENT_PROVISIONING_TIMEOUT);<br style="margin:0px; border:0px; background-color:inherit">        mDhcpActionTimeoutAlarm = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> WakeupMessage(mContext, getHandler(),<br style="margin:0px; border:0px; background-color:inherit">                mTag + <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">".EVENT_DHCPACTION_TIMEOUT"</span>, EVENT_DHCPACTION_TIMEOUT);<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// Super simple StateMachine.</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//状态机，很简单，才三个状态</span><br style="margin:0px; border:0px; background-color:inherit">        addState(mStoppedState);<br style="margin:0px; border:0px; background-color:inherit">        addState(mStartedState);<br style="margin:0px; border:0px; background-color:inherit">        addState(mStoppingState);<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        setInitialState(mStoppedState);<br style="margin:0px; border:0px; background-color:inherit">        mLocalLog = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> LocalLog(MAX_LOG_RECORDS);<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">super</span>.start();<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<div class="xiaoshujiang_element xsj_anchor" style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:1"> 
 <a target="_blank" class="blank_anchor_name" href="http://undefined/" rel="nofollow noopener noreferrer" style="color:rgb(0,136,204); background-color:inherit"></a> 
 <a target="_blank" class="blank_anchor_id" href="http://undefined/" rel="nofollow noopener noreferrer" style="color:rgb(0,136,204); float:left; visibility:hidden; background-color:inherit"></a> 
</div> 
<h4 style="color:inherit; font-family:inherit; widows:1; margin:1em 0px 0.6em; font-weight:500; line-height:1.1; font-size:24.5px"> <span class="mark" style="border:0px; color:rgb(41,117,77); font-size:22.05px; padding:2px 4px; background-color:rgb(221,243,231)">2.2 ProvisioningConfiguration配置类</span></h4> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 前面再IpManager开始之前，会new一个provisioningConfiguration对象，这个configuration就指明，是否enabled ipv6，静态ip的对象是哪个，还有timeout的时间。</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">final</span> ProvisioningConfiguration provisioningConfiguration = <br style="margin:0px; border:0px; background-color:inherit">mIpManager.buildProvisioningConfiguration() <br style="margin:0px; border:0px; background-color:inherit">.withProvisioningTimeoutMs(<span class="hljs-number" style="background-color:inherit">0</span>) <br style="margin:0px; border:0px; background-color:inherit">.build();<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">ProvisioningConfiguration</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{}<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">ProvisioningConfiguration</span><span class="hljs-params" style="background-color:inherit">(ProvisioningConfiguration other)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            mEnableIPv4 = other.mEnableIPv4;<br style="margin:0px; border:0px; background-color:inherit">            mEnableIPv6 = other.mEnableIPv6;<br style="margin:0px; border:0px; background-color:inherit">            mUsingIpReachabilityMonitor = other.mUsingIpReachabilityMonitor;<br style="margin:0px; border:0px; background-color:inherit">            mRequestedPreDhcpActionMs = other.mRequestedPreDhcpActionMs;<br style="margin:0px; border:0px; background-color:inherit">            mStaticIpConfig = other.mStaticIpConfig;<br style="margin:0px; border:0px; background-color:inherit">            mApfCapabilities = other.mApfCapabilities;<br style="margin:0px; border:0px; background-color:inherit">            mProvisioningTimeoutMs = other.mProvisioningTimeoutMs;<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<div class="xiaoshujiang_element xsj_anchor" style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:1"> 
 <a target="_blank" class="blank_anchor_name" href="http://undefined/" rel="nofollow noopener noreferrer" style="color:rgb(0,136,204); background-color:inherit"></a> 
 <a target="_blank" class="blank_anchor_id" href="http://undefined/" rel="nofollow noopener noreferrer" style="color:rgb(0,136,204); float:left; visibility:hidden; background-color:inherit"></a> 
</div> 
<h4 style="color:inherit; font-family:inherit; widows:1; margin:1em 0px 0.6em; font-weight:500; line-height:1.1; font-size:24.5px"> <span class="mark" style="border:0px; color:rgb(41,117,77); font-size:22.05px; padding:2px 4px; background-color:rgb(221,243,231)">2.3 mIpManager.startProvisioning(provisioningConfiguration)</span></h4> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 开始获取IP啦~</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">startProvisioning</span><span class="hljs-params" style="background-color:inherit">(ProvisioningConfiguration req)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        getNetworkInterface();<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        mCallback.setNeighborDiscoveryOffload(<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">true</span>);<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//发送CMD_START出来</span><br style="margin:0px; border:0px; background-color:inherit">        sendMessage(CMD_START, <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> ProvisioningConfiguration(req));<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 一开始的状态时在StoppedState中，收到CMD_START跟着就会跳转到mStartedState</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-class" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">class</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">StoppedState</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">extends</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">State</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">enter</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">try</span> {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                mNwService.disableIpv6(mInterfaceName);<br style="margin:0px; border:0px; background-color:inherit">                mNwService.clearInterfaceAddresses(mInterfaceName);<br style="margin:0px; border:0px; background-color:inherit">            } <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">catch</span> (Exception e) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                Log.e(mTag, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Failed to clear addresses or disable IPv6"</span> + e);<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">            resetLinkProperties();<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (mStartTimeMillis &gt; <span class="hljs-number" style="background-color:inherit">0</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                recordMetric(IpManagerEvent.COMPLETE_LIFECYCLE);<br style="margin:0px; border:0px; background-color:inherit">                mStartTimeMillis = <span class="hljs-number" style="background-color:inherit">0</span>;<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">boolean</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">processMessage</span><span class="hljs-params" style="background-color:inherit">(Message msg)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">switch</span> (msg.what) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">case</span> CMD_STOP:<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">break</span>;<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">case</span> CMD_START:<br style="margin:0px; border:0px; background-color:inherit">                    mConfiguration = (ProvisioningConfiguration) msg.obj;<br style="margin:0px; border:0px; background-color:inherit">                    transitionTo(mStartedState);<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">break</span>;<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 先跑StartedState的enter函数</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-class" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">class</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">StartedState</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">extends</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">State</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">boolean</span> mDhcpActionInFlight;<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">enter</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//开始的时间</span><br style="margin:0px; border:0px; background-color:inherit">            mStartTimeMillis = SystemClock.elapsedRealtime();<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-javadoc" style="color:rgb(128,128,128); background-color:inherit">/**<br style="margin:0px; border:0px; background-color:inherit">         * For networks that support packet filtering via APF programs, {@code ApfFilter}<br style="margin:0px; border:0px; background-color:inherit">         * listens for IPv6 ICMPv6 router advertisements (RAs) and generates APF programs to<br style="margin:0px; border:0px; background-color:inherit">         * filter out redundant duplicate ones.<br style="margin:0px; border:0px; background-color:inherit">         *<br style="margin:0px; border:0px; background-color:inherit">         * Threading model:<br style="margin:0px; border:0px; background-color:inherit">         * A collection of RAs we've received is kept in mRas. Generating APF programs uses mRas to<br style="margin:0px; border:0px; background-color:inherit">         * know what RAs to filter for, thus generating APF programs is dependent on mRas.<br style="margin:0px; border:0px; background-color:inherit">         * mRas can be accessed by multiple threads:<br style="margin:0px; border:0px; background-color:inherit">         * - ReceiveThread, which listens for RAs and adds them to mRas, and generates APF programs.<br style="margin:0px; border:0px; background-color:inherit">         * - callers of:<br style="margin:0px; border:0px; background-color:inherit">         *    - setMulticastFilter(), which can cause an APF program to be generated.<br style="margin:0px; border:0px; background-color:inherit">         *    - dump(), which dumps mRas among other things.<br style="margin:0px; border:0px; background-color:inherit">         *    - shutdown(), which clears mRas.<br style="margin:0px; border:0px; background-color:inherit">         * So access to mRas is synchronized.<br style="margin:0px; border:0px; background-color:inherit">         *<br style="margin:0px; border:0px; background-color:inherit">         *<span class="hljs-javadoctag" style="background-color:inherit"> @hide</span><br style="margin:0px; border:0px; background-color:inherit">         */</span><br style="margin:0px; border:0px; background-color:inherit">            mApfFilter = ApfFilter.maybeCreate(mConfiguration.mApfCapabilities, mNetworkInterface,<br style="margin:0px; border:0px; background-color:inherit">                    mCallback, mMulticastFiltering);<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// TODO: investigate the effects of any multicast filtering racing/interfering with the</span><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// rest of this IP configuration startup.</span><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (mApfFilter == <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                mCallback.setFallbackMulticastFilter(mMulticastFiltering);<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//如果ipv6如果这么写的话，如果timout会存在卡到ipv4?ipv6和ipv4之间的逻辑关系应该是怎么样的？</span><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (mConfiguration.mEnableIPv6) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// TODO: Consider transitionTo(mStoppingState) if this fails.</span><br style="margin:0px; border:0px; background-color:inherit">                startIPv6();<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//这个是arp邻居表的检测</span><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (mConfiguration.mUsingIpReachabilityMonitor) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                mIpReachabilityMonitor = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> IpReachabilityMonitor(<br style="margin:0px; border:0px; background-color:inherit">                        mContext,<br style="margin:0px; border:0px; background-color:inherit">                        mInterfaceName,<br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> IpReachabilityMonitor.Callback() {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                            <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">                            <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">notifyLost</span><span class="hljs-params" style="background-color:inherit">(InetAddress ip, String logMsg)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">                                mCallback.onReachabilityLost(logMsg);<br style="margin:0px; border:0px; background-color:inherit">                            }<br style="margin:0px; border:0px; background-color:inherit">                        });<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//启动ipv4</span><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (mConfiguration.mEnableIPv4) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (!startIPv4()) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                    transitionTo(mStoppingState);<br style="margin:0px; border:0px; background-color:inherit">                }<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> startIPv6的部分还没写好，跳过，看ipv4的部分</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">boolean</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">startIPv4</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// If we have a StaticIpConfiguration attempt to apply it and</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// handle the result accordingly.</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//如果是静态ip，在这里设置一下</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (mConfiguration.mStaticIpConfig != <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (setIPv4Address(mConfiguration.mStaticIpConfig.ipAddress)) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                handleIPv4Success(<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> DhcpResults(mConfiguration.mStaticIpConfig));<br style="margin:0px; border:0px; background-color:inherit">            } <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">else</span> {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (VDBG) { Log.d(mTag, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"onProvisioningFailure()"</span>); }<br style="margin:0px; border:0px; background-color:inherit">                recordMetric(IpManagerEvent.PROVISIONING_FAIL);<br style="margin:0px; border:0px; background-color:inherit">                mCallback.onProvisioningFailure(<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> LinkProperties(mLinkProperties));<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">false</span>;<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        } <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">else</span> {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// Start DHCPv4.</span><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//构造DhcpClient对象，发送dhcp client请求</span><br style="margin:0px; border:0px; background-color:inherit">            mDhcpClient = DhcpClient.makeDhcpClient(mContext, IpManager.<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">this</span>, mInterfaceName);<br style="margin:0px; border:0px; background-color:inherit">            mDhcpClient.registerForPreDhcpNotification();<br style="margin:0px; border:0px; background-color:inherit">            mDhcpClient.sendMessage(DhcpClient.CMD_START_DHCP);<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (mConfiguration.mProvisioningTimeoutMs &gt; <span class="hljs-number" style="background-color:inherit">0</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">final</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">long</span> alarmTime = SystemClock.elapsedRealtime() +<br style="margin:0px; border:0px; background-color:inherit">                        mConfiguration.mProvisioningTimeoutMs;<br style="margin:0px; border:0px; background-color:inherit">                 <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//通过闹钟去叫醒</span><br style="margin:0px; border:0px; background-color:inherit">                 <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">/*<br style="margin:0px; border:0px; background-color:inherit">                         mProvisioningTimeoutAlarm = new WakeupMessage(mContext, getHandler(),<br style="margin:0px; border:0px; background-color:inherit">                mTag + ".EVENT_PROVISIONING_TIMEOUT", EVENT_PROVISIONING_TIMEOUT);<br style="margin:0px; border:0px; background-color:inherit">                 */</span><br style="margin:0px; border:0px; background-color:inherit">                mProvisioningTimeoutAlarm.schedule(alarmTime);<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">true</span>;<br style="margin:0px; border:0px; background-color:inherit">    }</code></pre> 
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:1"> 
 <h3 style="color:inherit; font-family:inherit; font-size:31.5px; font-weight:500"> <span style="color:rgb(41,117,77); font-size:28.35px; background-color:rgb(221,243,231)">2.4 DhcpClient</span></h3> 
 <br style="background-color:inherit"> 
</div> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 接收前面发过来的mDhcpClient.sendMessage(DhcpClient.CMD_START_DHCP);, 跟着跳转到DhcpInitState:</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-class" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">class</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">StoppedState</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">extends</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">LoggingState</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">boolean</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">processMessage</span><span class="hljs-params" style="background-color:inherit">(Message message)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">super</span>.processMessage(message);<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">switch</span> (message.what) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">case</span> CMD_START_DHCP:<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (mRegisteredForPreDhcpNotification) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        transitionTo(mWaitBeforeStartState);<br style="margin:0px; border:0px; background-color:inherit">                    } <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">else</span> {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        transitionTo(mDhcpInitState);<br style="margin:0px; border:0px; background-color:inherit">                    }<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> HANDLED;<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">default</span>:<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> NOT_HANDLED;<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-class" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">class</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">DhcpInitState</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">extends</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">PacketRetransmittingState</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">DhcpInitState</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">super</span>();<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//跑DhcpInitState的父类PacketRetransmittingState的enter</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">enter</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">super</span>.enter();<br style="margin:0px; border:0px; background-color:inherit">            startNewTransaction();<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">protected</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">boolean</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">sendPacket</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> sendDiscoverPacket();<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">protected</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">receivePacket</span><span class="hljs-params" style="background-color:inherit">(DhcpPacket packet)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (!isValidPacket(packet)) <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span>;<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (!(packet <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">instanceof</span> DhcpOfferPacket)) <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span>;<br style="margin:0px; border:0px; background-color:inherit">            mOffer = packet.toDhcpResults();<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (mOffer != <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                Log.d(TAG, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Got pending lease: "</span> + mOffer);<br style="margin:0px; border:0px; background-color:inherit">                transitionTo(mDhcpRequestingState);<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 重点是这里的CMD_KICK命令，发送这个命令，之后会调用sendPacket()函数，去发送请求包.</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-javadoc" style="color:rgb(128,128,128); background-color:inherit">/**<br style="margin:0px; border:0px; background-color:inherit">     * Retransmits packets using jittered exponential backoff with an optional timeout. Packet<br style="margin:0px; border:0px; background-color:inherit">     * transmission is triggered by CMD_KICK, which is sent by an AlarmManager alarm. If a subclass<br style="margin:0px; border:0px; background-color:inherit">     * sets mTimeout to a positive value, then timeout() is called by an AlarmManager alarm mTimeout<br style="margin:0px; border:0px; background-color:inherit">     * milliseconds after entering the state. Kicks and timeouts are cancelled when leaving the<br style="margin:0px; border:0px; background-color:inherit">     * state.<br style="margin:0px; border:0px; background-color:inherit">     *<br style="margin:0px; border:0px; background-color:inherit">     * Concrete subclasses must implement sendPacket, which is called when the alarm fires and a<br style="margin:0px; border:0px; background-color:inherit">     * packet needs to be transmitted, and receivePacket, which is triggered by CMD_RECEIVED_PACKET<br style="margin:0px; border:0px; background-color:inherit">     * sent by the receive thread. They may also set mTimeout and implement timeout.<br style="margin:0px; border:0px; background-color:inherit">     */</span><br style="margin:0px; border:0px; background-color:inherit">    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">abstract</span> <span class="hljs-class" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">class</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">PacketRetransmittingState</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">extends</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">LoggingState</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">int</span> mTimer;<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">protected</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">int</span> mTimeout = <span class="hljs-number" style="background-color:inherit">0</span>;<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">enter</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">super</span>.enter();<br style="margin:0px; border:0px; background-color:inherit">            initTimer();<br style="margin:0px; border:0px; background-color:inherit">            maybeInitTimeout();<br style="margin:0px; border:0px; background-color:inherit">            sendMessage(CMD_KICK);<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 这里发送的是DHCPDISCOVER dhcp协议的DISCOVER包</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">boolean</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">sendDiscoverPacket</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        ByteBuffer packet = DhcpPacket.buildDiscoverPacket(<br style="margin:0px; border:0px; background-color:inherit">                DhcpPacket.ENCAP_L2, mTransactionId, getSecs(), mHwAddr,<br style="margin:0px; border:0px; background-color:inherit">                DO_UNICAST, REQUESTED_PARAMS);<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> transmitPacket(packet, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"DHCPDISCOVER"</span>, DhcpPacket.ENCAP_L2, INADDR_BROADCAST);<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 另外一边有一个接收函数，一直在收dhcp server的的数据包。</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-class" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">class</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">ReceiveThread</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">extends</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">Thread</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">final</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">byte</span>[] mPacket = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">byte</span>[DhcpPacket.MAX_LENGTH];<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">volatile</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">boolean</span> mStopped = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">false</span>;<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">halt</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            mStopped = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">true</span>;<br style="margin:0px; border:0px; background-color:inherit">            closeSockets();  <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// Interrupts the read() call the thread is blocked in.</span><br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">run</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (DBG) Log.d(TAG, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Receive thread started"</span>);<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">while</span> (!mStopped) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">int</span> length = <span class="hljs-number" style="background-color:inherit">0</span>;  <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// Or compiler can't tell it's initialized if a parse error occurs.</span><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">try</span> {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                    length = Os.read(mPacketSock, mPacket, <span class="hljs-number" style="background-color:inherit">0</span>, mPacket.length);<br style="margin:0px; border:0px; background-color:inherit">                    DhcpPacket packet = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>;<br style="margin:0px; border:0px; background-color:inherit">                    packet = DhcpPacket.decodeFullPacket(mPacket, length, DhcpPacket.ENCAP_L2);<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (DBG) Log.d(TAG, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Received packet: "</span> + packet);<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//发送CMD_RECEIVED_PACKET，把数据包往上面送</span><br style="margin:0px; border:0px; background-color:inherit">                    sendMessage(CMD_RECEIVED_PACKET, packet);<br style="margin:0px; border:0px; background-color:inherit">                } <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">catch</span> (IOException|ErrnoException e) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (!mStopped) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        Log.e(TAG, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Read error"</span>, e);<br style="margin:0px; border:0px; background-color:inherit">                        DhcpErrorEvent.logReceiveError(mIfaceName);<br style="margin:0px; border:0px; background-color:inherit">                    }<br style="margin:0px; border:0px; background-color:inherit">                } <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">catch</span> (DhcpPacket.ParseException e) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                    Log.e(TAG, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Can't parse packet: "</span> + e.getMessage());<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (PACKET_DBG) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        Log.d(TAG, HexDump.dumpHexString(mPacket, <span class="hljs-number" style="background-color:inherit">0</span>, length));<br style="margin:0px; border:0px; background-color:inherit">                    }<br style="margin:0px; border:0px; background-color:inherit">                    DhcpErrorEvent.logParseError(mIfaceName, e.errorCode);<br style="margin:0px; border:0px; background-color:inherit">                }<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (DBG) Log.d(TAG, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Receive thread stopped"</span>);<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 接收CMD_RECEIVED_PACKET,我们还在PacketRetransmittingState 这个state中，所以他会处理这个CMD</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">abstract</span> <span class="hljs-class" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">class</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">PacketRetransmittingState</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">extends</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">LoggingState</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">int</span> mTimer;<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">protected</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">int</span> mTimeout = <span class="hljs-number" style="background-color:inherit">0</span>;<br style="margin:0px; border:0px; background-color:inherit">        ...<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">boolean</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">processMessage</span><span class="hljs-params" style="background-color:inherit">(Message message)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">super</span>.processMessage(message);<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">switch</span> (message.what) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">case</span> CMD_KICK:<br style="margin:0px; border:0px; background-color:inherit">                    sendPacket();<br style="margin:0px; border:0px; background-color:inherit">                    scheduleKick();<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> HANDLED;<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">case</span> CMD_RECEIVED_PACKET:<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//这个会call到DhcpInitState的receivePacket函数</span><br style="margin:0px; border:0px; background-color:inherit">                    receivePacket((DhcpPacket) message.obj);<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> HANDLED;<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">case</span> CMD_TIMEOUT:<br style="margin:0px; border:0px; background-color:inherit">                    timeout();<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> HANDLED;<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">default</span>:<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> NOT_HANDLED;<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 接收的数据在这里被处理，处理完之后，将结果赋值给mOffer，意思是dhcp的offer数据包，里面当然就是存着ip的值，然后跳转到mDhcpRequestingState</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">protected</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">receivePacket</span><span class="hljs-params" style="background-color:inherit">(DhcpPacket packet)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (!isValidPacket(packet)) <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span>;<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//判断是不是server 放回的offer包</span><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (!(packet <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">instanceof</span> DhcpOfferPacket)) <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span>;<br style="margin:0px; border:0px; background-color:inherit">            mOffer = packet.toDhcpResults();<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (mOffer != <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                Log.d(TAG, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Got pending lease: "</span> + mOffer);<br style="margin:0px; border:0px; background-color:inherit">                transitionTo(mDhcpRequestingState);<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 这个DhcpRequestingState 是继承了PacketRetransmittingState ，还记得前面的CMD_KICK吗？scheduleKick()函数的调用，这个CMD_KICK会定时发送,理论上dicover包要发4次。server offer之后，就要跑client发送request了，当跑到这个statemachine里面的时候，就会跑DhcpRequestingState 这个里面的sendPacket()了，google大神真是牛。那这次send的是dhcp协议的什么数据包呢？</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-class" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">class</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">DhcpRequestingState</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">extends</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">PacketRetransmittingState</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">DhcpRequestingState</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            mTimeout = DHCP_TIMEOUT_MS / <span class="hljs-number" style="background-color:inherit">2</span>;<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">protected</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">boolean</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">sendPacket</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> sendRequestPacket(<br style="margin:0px; border:0px; background-color:inherit">                    INADDR_ANY,                                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// ciaddr</span><br style="margin:0px; border:0px; background-color:inherit">                    (Inet4Address) mOffer.ipAddress.getAddress(),  <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// DHCP_REQUESTED_IP</span><br style="margin:0px; border:0px; background-color:inherit">                    (Inet4Address) mOffer.serverAddress,           <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// DHCP_SERVER_IDENTIFIER</span><br style="margin:0px; border:0px; background-color:inherit">                    INADDR_BROADCAST);                             <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// packet destination address</span><br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">protected</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">receivePacket</span><span class="hljs-params" style="background-color:inherit">(DhcpPacket packet)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (!isValidPacket(packet)) <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span>;<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> ((packet <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">instanceof</span> DhcpAckPacket)) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                DhcpResults results = packet.toDhcpResults();<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (results != <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                    setDhcpLeaseExpiry(packet);<br style="margin:0px; border:0px; background-color:inherit">                    acceptDhcpResults(results, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Confirmed"</span>);<br style="margin:0px; border:0px; background-color:inherit">                    transitionTo(mConfiguringInterfaceState);<br style="margin:0px; border:0px; background-color:inherit">                }<br style="margin:0px; border:0px; background-color:inherit">            } <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">else</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">if</span> <span class="hljs-params" style="background-color:inherit">(packet <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">instanceof</span> DhcpNakPacket)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// TODO: Wait a while before returning into INIT state.</span><br style="margin:0px; border:0px; background-color:inherit">                Log.d(TAG, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Received NAK, returning to INIT"</span>);<br style="margin:0px; border:0px; background-color:inherit">                mOffer = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>;<br style="margin:0px; border:0px; background-color:inherit">                transitionTo(mDhcpInitState);<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">protected</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">timeout</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// After sending REQUESTs unsuccessfully for a while, go back to init.</span><br style="margin:0px; border:0px; background-color:inherit">            transitionTo(mDhcpInitState);<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> DHCPREQUEST ciaddr 知道知道dhcp的协议，就知道发完discover包之后，要再发一个DHCPREQUEST。相当是这个ip我要了，然后等sever的ACK。</p> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> DHCP Client会以广播形式向DHCP Server发送DHCPRequest报文来续租IP地址。如果DHCP Client成功收到DHCP Server发送的DHCP ACK报文.</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">boolean</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">sendRequestPacket</span><span class="hljs-params" style="background-color:inherit">(<br style="margin:0px; border:0px; background-color:inherit">            Inet4Address clientAddress, Inet4Address requestedAddress,<br style="margin:0px; border:0px; background-color:inherit">            Inet4Address serverAddress, Inet4Address to)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// TODO: should we use the transaction ID from the server?</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">final</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">int</span> encap = INADDR_ANY.equals(clientAddress)<br style="margin:0px; border:0px; background-color:inherit">                ? DhcpPacket.ENCAP_L2 : DhcpPacket.ENCAP_BOOTP;<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        ByteBuffer packet = DhcpPacket.buildRequestPacket(<br style="margin:0px; border:0px; background-color:inherit">                encap, mTransactionId, getSecs(), clientAddress,<br style="margin:0px; border:0px; background-color:inherit">                DO_UNICAST, mHwAddr, requestedAddress,<br style="margin:0px; border:0px; background-color:inherit">                serverAddress, REQUESTED_PARAMS, <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>);<br style="margin:0px; border:0px; background-color:inherit">        String serverStr = (serverAddress != <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>) ? serverAddress.getHostAddress() : <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>;<br style="margin:0px; border:0px; background-color:inherit">        String description = <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"DHCPREQUEST ciaddr="</span> + clientAddress.getHostAddress() +<br style="margin:0px; border:0px; background-color:inherit">                             <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">" request="</span> + requestedAddress.getHostAddress() +<br style="margin:0px; border:0px; background-color:inherit">                             <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">" serverid="</span> + serverStr;<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> transmitPacket(packet, description, encap, to);<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> sever ack之后，我们再次处理接收包。</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">protected</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">receivePacket</span><span class="hljs-params" style="background-color:inherit">(DhcpPacket packet)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (!isValidPacket(packet)) <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span>;<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> ((packet <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">instanceof</span> DhcpAckPacket)) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                DhcpResults results = packet.toDhcpResults();<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (results != <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                    setDhcpLeaseExpiry(packet);<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//这里会调用notifySuccess，发送CMD去通知IpManager说，IP拿到了</span><br style="margin:0px; border:0px; background-color:inherit">                    acceptDhcpResults(results, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Confirmed"</span>);<span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//①</span><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//自己调到mConfiguringInterfaceState</span><br style="margin:0px; border:0px; background-color:inherit">                    transitionTo(mConfiguringInterfaceState);<span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//②</span><br style="margin:0px; border:0px; background-color:inherit">                }<br style="margin:0px; border:0px; background-color:inherit">            } <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">else</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">if</span> <span class="hljs-params" style="background-color:inherit">(packet <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">instanceof</span> DhcpNakPacket)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// TODO: Wait a while before returning into INIT state.</span><br style="margin:0px; border:0px; background-color:inherit">                Log.d(TAG, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Received NAK, returning to INIT"</span>);<br style="margin:0px; border:0px; background-color:inherit">                mOffer = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>;<br style="margin:0px; border:0px; background-color:inherit">                transitionTo(mDhcpInitState);<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> ①这里调用了notifySuccess()发生CMD去通知IpManager，IP获取成功了。</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">acceptDhcpResults</span><span class="hljs-params" style="background-color:inherit">(DhcpResults results, String msg)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        mDhcpLease = results;<br style="margin:0px; border:0px; background-color:inherit">        mOffer = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>;<br style="margin:0px; border:0px; background-color:inherit">        Log.d(TAG, msg + <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">" lease: "</span> + mDhcpLease);<br style="margin:0px; border:0px; background-color:inherit">        notifySuccess();<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 这里的mController指的是IpManager里面的接收者，发送CMD_POST_DHCP_ACTION</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">notifySuccess</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        mController.sendMessage(<br style="margin:0px; border:0px; background-color:inherit">                CMD_POST_DHCP_ACTION, DHCP_SUCCESS, <span class="hljs-number" style="background-color:inherit">0</span>, <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> DhcpResults(mDhcpLease));<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>   <span class="hljs-class" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">class</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">StartedState</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">extends</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">State</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">                ....<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// This message is only received when:</span><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//</span><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//     a) initial address acquisition succeeds,</span><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//     b) renew succeeds or is NAK'd,</span><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//     c) rebind succeeds or is NAK'd, or</span><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//     c) the lease expires,</span><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//</span><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// but never when initial address acquisition fails. The latter</span><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">// condition is now governed by the provisioning timeout.</span><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">case</span> DhcpClient.CMD_POST_DHCP_ACTION:<br style="margin:0px; border:0px; background-color:inherit">                    stopDhcpAction();<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">switch</span> (msg.arg1) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">case</span> DhcpClient.DHCP_SUCCESS:<br style="margin:0px; border:0px; background-color:inherit">                            handleIPv4Success((DhcpResults) msg.obj);<br style="margin:0px; border:0px; background-color:inherit">                            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">break</span>;<br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">case</span> DhcpClient.DHCP_FAILURE:<br style="margin:0px; border:0px; background-color:inherit">                            handleIPv4Failure();<br style="margin:0px; border:0px; background-color:inherit">                            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">break</span>;<br style="margin:0px; border:0px; background-color:inherit">                        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">default</span>:<br style="margin:0px; border:0px; background-color:inherit">                            Log.e(mTag, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Unknown CMD_POST_DHCP_ACTION status:"</span> + msg.arg1);<br style="margin:0px; border:0px; background-color:inherit">                    }<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">break</span>;<br style="margin:0px; border:0px; background-color:inherit">          .....<br style="margin:0px; border:0px; background-color:inherit">     }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">handleIPv4Success</span><span class="hljs-params" style="background-color:inherit">(DhcpResults dhcpResults)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        mDhcpResults = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> DhcpResults(dhcpResults);<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">final</span> LinkProperties newLp = assembleLinkProperties();<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">final</span> ProvisioningChange delta = setLinkProperties(newLp);<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (VDBG) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            Log.d(mTag, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"onNewDhcpResults("</span> + Objects.toString(dhcpResults) + <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">")"</span>);<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit">        mCallback.onNewDhcpResults(dhcpResults);<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//这里分发dhcpResults</span><br style="margin:0px; border:0px; background-color:inherit">        dispatchCallback(delta, newLp);<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">dispatchCallback</span><span class="hljs-params" style="background-color:inherit">(ProvisioningChange delta, LinkProperties newLp)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">switch</span> (delta) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">case</span> GAINED_PROVISIONING:<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (VDBG) { Log.d(mTag, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"onProvisioningSuccess()"</span>); }<br style="margin:0px; border:0px; background-color:inherit">                recordMetric(IpManagerEvent.PROVISIONING_OK);<br style="margin:0px; border:0px; background-color:inherit">                mCallback.onProvisioningSuccess(newLp);<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">break</span>;<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">case</span> LOST_PROVISIONING:<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (VDBG) { Log.d(mTag, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"onProvisioningFailure()"</span>); }<br style="margin:0px; border:0px; background-color:inherit">                recordMetric(IpManagerEvent.PROVISIONING_FAIL);<br style="margin:0px; border:0px; background-color:inherit">                mCallback.onProvisioningFailure(newLp);<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">break</span>;<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">default</span>:<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (VDBG) { Log.d(mTag, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"onLinkPropertiesChange()"</span>); }<br style="margin:0px; border:0px; background-color:inherit">                mCallback.onLinkPropertiesChange(newLp);<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">break</span>;<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> dispatchCallback的结果最后会作用到WaitForProvisioningCallback ，这个就是前面EthernetNetworkFactory 中 linkProperties = ipmCallback.waitForProvisioning();，等待的结果。</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">static</span> <span class="hljs-class" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">class</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">WaitForProvisioningCallback</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">extends</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">Callback</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> LinkProperties mCallbackLinkProperties;<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> LinkProperties <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">waitForProvisioning</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">synchronized</span> (<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">this</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">try</span> {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                    wait();<br style="margin:0px; border:0px; background-color:inherit">                } <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">catch</span> (InterruptedException e) {}<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> mCallbackLinkProperties;<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">onProvisioningSuccess</span><span class="hljs-params" style="background-color:inherit">(LinkProperties newLp)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">synchronized</span> (<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">this</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                mCallbackLinkProperties = newLp;<br style="margin:0px; border:0px; background-color:inherit">                notify();<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">onProvisioningFailure</span><span class="hljs-params" style="background-color:inherit">(LinkProperties newLp)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">synchronized</span> (<span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">this</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                mCallbackLinkProperties = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>;<br style="margin:0px; border:0px; background-color:inherit">                notify();<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> ②这里跑入enter(),给IpManager发了一个CMD_CONFIGURE_LINKADDRESS 的CMD</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-class" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">class</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">ConfiguringInterfaceState</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">extends</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">LoggingState</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">enter</span><span class="hljs-params" style="background-color:inherit">()</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">super</span>.enter();<br style="margin:0px; border:0px; background-color:inherit">            mController.sendMessage(CMD_CONFIGURE_LINKADDRESS, mDhcpLease.ipAddress);<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">boolean</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">processMessage</span><span class="hljs-params" style="background-color:inherit">(Message message)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">super</span>.processMessage(message);<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">switch</span> (message.what) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">case</span> EVENT_LINKADDRESS_CONFIGURED:<br style="margin:0px; border:0px; background-color:inherit">                    transitionTo(mDhcpBoundState);<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> HANDLED;<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">default</span>:<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> NOT_HANDLED;<br style="margin:0px; border:0px; background-color:inherit">            }<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 我们返回到IpManager中去看，在IpManger中，我们还处于StartedState中</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>   <span class="hljs-class" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">class</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">StartedState</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">extends</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">State</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">                ......<br style="margin:0px; border:0px; background-color:inherit">                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">case</span> DhcpClient.CMD_CONFIGURE_LINKADDRESS: {<!-- --><br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">final</span> LinkAddress ipAddress = (LinkAddress) msg.obj;<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//将IP通过NetworkManagerService写到Interface上面</span><br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (setIPv4Address(ipAddress)) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        mDhcpClient.sendMessage(DhcpClient.EVENT_LINKADDRESS_CONFIGURED);<br style="margin:0px; border:0px; background-color:inherit">                    } <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">else</span> {<!-- --><br style="margin:0px; border:0px; background-color:inherit">                        Log.e(mTag, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Failed to set IPv4 address!"</span>);<br style="margin:0px; border:0px; background-color:inherit">                        dispatchCallback(ProvisioningChange.LOST_PROVISIONING,<br style="margin:0px; border:0px; background-color:inherit">                                <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> LinkProperties(mLinkProperties));<br style="margin:0px; border:0px; background-color:inherit">                        transitionTo(mStoppingState);<br style="margin:0px; border:0px; background-color:inherit">                    }<br style="margin:0px; border:0px; background-color:inherit">                    <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">break</span>;<br style="margin:0px; border:0px; background-color:inherit">                }<br style="margin:0px; border:0px; background-color:inherit">                ......<br style="margin:0px; border:0px; background-color:inherit">   }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 这个setIPv4Address很简单，调用了NetworkManagementService.setInterfaceConfig()</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'>    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">private</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">boolean</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">setIPv4Address</span><span class="hljs-params" style="background-color:inherit">(LinkAddress address)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">final</span> InterfaceConfiguration ifcg = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> InterfaceConfiguration();<br style="margin:0px; border:0px; background-color:inherit">        ifcg.setLinkAddress(address);<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">try</span> {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            mNwService.setInterfaceConfig(mInterfaceName, ifcg);<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (VDBG) Log.d(mTag, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"IPv4 configuration succeeded"</span>);<br style="margin:0px; border:0px; background-color:inherit">        } <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">catch</span> (IllegalStateException | RemoteException e) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            Log.e(mTag, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"IPv4 configuration failed: "</span>, e);<br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">false</span>;<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">return</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">true</span>;<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 调用Netd，通过Commandlisten.Java去往下跑，这里不跟了。</p> 
<pre class="xiaoshujiang_code_container" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; font-size:14px; line-height:21px; widows:1; word-wrap:break-word; position:relative; padding-bottom:2em; background-color:rgb(255,255,255)'><code class="language-java hljs" style='font-family:Monaco,Consolas,Courier,"Lucida Console",monospace; border:0px; font-size:12.6px; padding:0.5em; display:block; overflow-x:auto'><span class="hljs-comment" style="color:rgb(0,128,0); background-color:inherit">//NetworkManagementService.java (frameworks\base\services\core\java\com\android\server) </span><br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">    <span class="hljs-annotation" style="color:rgb(0,128,0); background-color:inherit">@Override</span><br style="margin:0px; border:0px; background-color:inherit">    <span class="hljs-function" style="background-color:inherit"><span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">void</span> <span class="hljs-title" style="color:rgb(163,21,21); background-color:inherit">setInterfaceConfig</span><span class="hljs-params" style="background-color:inherit">(String iface, InterfaceConfiguration cfg)</span> </span>{<!-- --><br style="margin:0px; border:0px; background-color:inherit">        mContext.enforceCallingOrSelfPermission(CONNECTIVITY_INTERNAL, TAG);<br style="margin:0px; border:0px; background-color:inherit">        LinkAddress linkAddr = cfg.getLinkAddress();<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">if</span> (linkAddr == <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span> || linkAddr.getAddress() == <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">null</span>) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">throw</span> <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> IllegalStateException(<span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"Null LinkAddress given"</span>);<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">final</span> Command cmd = <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">new</span> Command(<span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"interface"</span>, <span class="hljs-string" style="color:rgb(163,21,21); background-color:inherit">"setcfg"</span>, iface,<br style="margin:0px; border:0px; background-color:inherit">                linkAddr.getAddress().getHostAddress(),<br style="margin:0px; border:0px; background-color:inherit">                linkAddr.getPrefixLength());<br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">for</span> (String flag : cfg.getFlags()) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            cmd.appendArg(flag);<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit"><br style="margin:0px; border:0px; background-color:inherit">        <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">try</span> {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            mConnector.execute(cmd);<br style="margin:0px; border:0px; background-color:inherit">        } <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">catch</span> (NativeDaemonConnectorException e) {<!-- --><br style="margin:0px; border:0px; background-color:inherit">            <span class="hljs-keyword" style="color:rgb(0,0,255); background-color:inherit">throw</span> e.rethrowAsParcelableException();<br style="margin:0px; border:0px; background-color:inherit">        }<br style="margin:0px; border:0px; background-color:inherit">    }<br style="margin:0px; border:0px; background-color:inherit"></code></pre> 
<div class="xiaoshujiang_element xsj_anchor" style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:1"> 
 <a target="_blank" class="blank_anchor_name" href="http://undefined/" rel="nofollow noopener noreferrer" style="color:rgb(0,136,204); background-color:inherit"></a> 
 <a target="_blank" class="blank_anchor_id" href="http://undefined/" rel="nofollow noopener noreferrer" style="color:rgb(0,136,204); float:left; visibility:hidden; background-color:inherit"></a> 
</div> 
<h3 style="color:inherit; font-family:inherit; widows:1; margin:1em 0px 0.6em; font-weight:500; line-height:40px; font-size:31.5px"> <span class="mark" style="border:0px; color:rgb(41,117,77); font-size:28.35px; padding:2px 4px; background-color:rgb(221,243,231)">3 总结</span></h3> 
<p style="margin-top:0px; margin-bottom:1.1em; font-family:微软雅黑; font-size:14px; widows:1; line-height:1.6"> 不知道google加入的这个IpManager是否又有效，但是从整个框架看下来，为后面ipv6的加入可以说是打好了基础，加速ipv6时代的到来。因为apple已经开始强制要求app support ipv6了，android需要加把劲。</p> 
<div> 
 <br> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ca6cfa77a281a6f280aa9e798de56bb7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于结构体内存对齐总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/61afcb5cef6b2bfbbd3783ddeff36e8e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">初次运行 Git 前的配置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>