<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>redis 三主六从高可用docker(不固定ip) - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="redis 三主六从高可用docker(不固定ip)" />
<meta property="og:description" content="redis集群(cluster)笔记
redis 三主三从高可用集群docker swarm
redis 三主六从高可用docker(不固定ip)
redis 三主六从高可用dockerswarm高级版(不固定ip)
此博客解决，redis加入集群后，是用于停掉后重启，将nodes.conf中的旧的Ip替换为新的IP，从而达到不会因为IP变化导致集群无法正常使用
跨主机安装rediscluster集群，本文采用swarm的方式，使用同一个网络，然后分别在对应的机器启动
1.环境准备 dockerdocker-composeswarm集群安装文件 1.1 swarm环境安装 主机IPnode1192.168.56.100node2192.168.56.101node3192.168.56.102 在三台分别执行 开放防火墙：
firewall-cmd --permanent --add-rich-rule=&#34;rule family=&#34;ipv4&#34; source address=&#34;192.168.56.100&#34; accept&#34; firewall-cmd --permanent --add-rich-rule=&#34;rule family=&#34;ipv4&#34; source address=&#34;192.168.56.101&#34; accept&#34; firewall-cmd --permanent --add-rich-rule=&#34;rule family=&#34;ipv4&#34; source address=&#34;192.168.56.102&#34; accept&#34; firewall-cmd --reload firewall-cmd --list-all systemctl restart docker 1.2 在3台主机上配置swarm 在node1上执行： docker swarm init --advertise-addr 192.168.56.100 docker swarm join-token manager 返回类似以下内容：
docker swarm join --token SWMTKN-1-614xi9dvksycykobgifxb4pgopc1wwgczwqct5wqkq8zao6tmx-0ds4jj3ozclrr2wukcaoakxso 192.168.56.100:2377 在node2、node3上执行上面的返回结果： docker swarm join --token SWMTKN-1-2c2xopn2rld8oltcof24sue370681ijhbo3bwcqarjlhq9lkea-2g53o5qn2anre4j9puv4hecrn 192." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/f1b2e21440ac5b886cf16fff6e788bd9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-03T16:53:20+08:00" />
<meta property="article:modified_time" content="2024-01-03T16:53:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">redis 三主六从高可用docker(不固定ip)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><a href="https://liuhm.blog.csdn.net/article/details/134894475" rel="nofollow">redis集群(cluster)笔记</a></p> 
<p><a href="https://liuhm.blog.csdn.net/article/details/134892732" rel="nofollow">redis 三主三从高可用集群docker swarm</a></p> 
<p><a href="https://liuhm.blog.csdn.net/article/details/135262581" rel="nofollow">redis 三主六从高可用docker(不固定ip)</a></p> 
<p><a href="https://liuhm.blog.csdn.net/article/details/135367801" rel="nofollow">redis 三主六从高可用dockerswarm高级版(不固定ip)</a></p> 
<blockquote> 
 <p>此博客解决，redis加入集群后，是用于停掉后重启，将nodes.conf中的旧的Ip替换为新的IP，从而达到不会因为IP变化导致集群无法正常使用</p> 
</blockquote> 
<p>跨主机安装rediscluster集群，本文采用swarm的方式，使用同一个网络，然后分别在对应的机器启动</p> 
<h3><a id="1_16"></a>1.环境准备</h3> 
<ul><li>docker</li><li>docker-compose</li><li>swarm集群</li><li>安装文件</li></ul> 
<h4><a id="11_swarm_23"></a>1.1 swarm环境安装</h4> 
<table><thead><tr><th>主机</th><th>IP</th></tr></thead><tbody><tr><td>node1</td><td>192.168.56.100</td></tr><tr><td>node2</td><td>192.168.56.101</td></tr><tr><td>node3</td><td>192.168.56.102</td></tr></tbody></table> 
<p>在三台分别执行 开放防火墙：</p> 
<pre><code class="prism language-sh">firewall-cmd <span class="token parameter variable">--permanent</span> --add-rich-rule<span class="token operator">=</span><span class="token string">"rule family="</span>ipv4<span class="token string">" source address="</span><span class="token number">192.168</span>.56.100<span class="token string">" accept"</span>
firewall-cmd <span class="token parameter variable">--permanent</span> --add-rich-rule<span class="token operator">=</span><span class="token string">"rule family="</span>ipv4<span class="token string">" source address="</span><span class="token number">192.168</span>.56.101<span class="token string">" accept"</span>
firewall-cmd <span class="token parameter variable">--permanent</span> --add-rich-rule<span class="token operator">=</span><span class="token string">"rule family="</span>ipv4<span class="token string">" source address="</span><span class="token number">192.168</span>.56.102<span class="token string">" accept"</span>
firewall-cmd <span class="token parameter variable">--reload</span>
firewall-cmd --list-all
systemctl restart <span class="token function">docker</span>
</code></pre> 
<h4><a id="12_3swarm_42"></a>1.2 在3台主机上配置swarm</h4> 
<ul><li>在node1上执行：</li></ul> 
<pre><code class="prism language-sh"><span class="token function">docker</span> swarm init --advertise-addr <span class="token number">192.168</span>.56.100
<span class="token function">docker</span> swarm join-token manager
</code></pre> 
<p>返回类似以下内容：</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> swarm <span class="token function">join</span> <span class="token parameter variable">--token</span> SWMTKN-1-614xi9dvksycykobgifxb4pgopc1wwgczwqct5wqkq8zao6tmx-0ds4jj3ozclrr2wukcaoakxso <span class="token number">192.168</span>.56.100:2377
</code></pre> 
<ul><li>在node2、node3上执行<strong>上面</strong>的返回结果：</li></ul> 
<pre><code class="prism language-sh"><span class="token function">docker</span> swarm <span class="token function">join</span> <span class="token parameter variable">--token</span> SWMTKN-1-2c2xopn2rld8oltcof24sue370681ijhbo3bwcqarjlhq9lkea-2g53o5qn2anre4j9puv4hecrn <span class="token number">192.168</span>.0.101:2377
</code></pre> 
<h4><a id="13_swarm_63"></a>1.3 创建swarm网络</h4> 
<p>在node1上执行以下命令：</p> 
<pre><code class="prism language-text">docker network create -d overlay --attachable redis-net
</code></pre> 
<h4><a id="14_node_71"></a>1.4 查看node</h4> 
<pre><code class="prism language-sh"><span class="token function">docker</span> <span class="token function">node</span> <span class="token function">ls</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/fc/62/6ZiVLp9p_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_78"></a>2.安装文件准备</h3> 
<h4><a id="21_redisnode1_80"></a>2.1 redisnode1文件</h4> 
<pre><code class="prism language-sh"><span class="token assign-left variable">filePath</span><span class="token operator">=</span><span class="token string">"/home/redis/redisnode1"</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$filePath</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$filePath</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${filePath}</span>/docker-compose.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
version: '3'

networks:
  redis-net:
    external: true 

services:
  redis1:
    image: redis:6.0-alpine
    hostname: redis1
    container_name: redis1
    volumes:
      - "\<span class="token environment constant">$PWD</span>/redis1/data:/data"
      - "\<span class="token environment constant">$PWD</span>/redis.conf:/etc/redis.conf"
      - "\<span class="token environment constant">$PWD</span>/redisStart.sh:/redis/redisStart.sh"
    command: "sh /redis/redisStart.sh"
    restart: always
    privileged: true
    networks:
     - redis-net
  redis2:
    image: redis:6.0-alpine
    hostname: redis2
    container_name: redis2
    volumes:
      - "\<span class="token environment constant">$PWD</span>/redis2/data:/data"
      - "\<span class="token environment constant">$PWD</span>/redis.conf:/etc/redis.conf"
      - "\<span class="token environment constant">$PWD</span>/redisStart.sh:/redis/redisStart.sh"
    command: "sh /redis/redisStart.sh"
    restart: always
    privileged: true
    networks:
     - redis-net
  redis3:
    image: redis:6.0-alpine
    hostname: redis3
    container_name: redis3
    volumes:
      - "\<span class="token environment constant">$PWD</span>/redis3/data:/data"
      - "\<span class="token environment constant">$PWD</span>/redis.conf:/etc/redis.conf"
      - "\<span class="token environment constant">$PWD</span>/redisStart.sh:/redis/redisStart.sh"
    command: "sh /redis/redisStart.sh"
    restart: always
    privileged: true
    networks:
     - redis-net
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${filePath}</span>/redis.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
port 6379
masterauth '123456' 
requirepass '123456'
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
appendonly yes
EOF</span>




<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${filePath}</span>/redisStart.sh <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/bin/sh

CURRENT_DIR=\<span class="token variable"><span class="token variable">$(</span>
   <span class="token builtin class-name">cd</span> <span class="token string">"\$(dirname "</span><span class="token punctuation">\</span>$0<span class="token string">")"</span>
   <span class="token builtin class-name">pwd</span>
<span class="token variable">)</span></span>
nowDate=\<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">"+%Y%m%d%H%M%S"</span><span class="token variable">)</span></span>
logFileName="redisStart_"\<span class="token variable">$nowDate</span>.log
touch \<span class="token variable">$CURRENT_DIR</span>/\<span class="token variable">${logFileName}</span>
# 日志函数
log(){
	echo "["\<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">"+%Y-%m-%d %H:%M:%S"</span><span class="token variable">)</span></span>"]"<span class="token variable">$1</span> | tee -a \<span class="token variable">$CURRENT_DIR</span>/\<span class="token variable">$logFileName</span>
}

# 通过ifconfig命令获取IP地址
IP=\<span class="token variable"><span class="token variable">$(</span><span class="token function">ifconfig</span> eth0 <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'inet addr:'</span> <span class="token operator">|</span> <span class="token function">cut</span> -d: <span class="token parameter variable">-f2</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print \$1}'</span><span class="token variable">)</span></span>
log "Container IP Address is: \<span class="token variable">${IP}</span>"
CLUSTER_CONFIG="/data/nodes.conf"

if [ -f \<span class="token variable">${CLUSTER_CONFIG}</span> ]; then
    if [ -z "\<span class="token variable">${IP}</span>" ]; then
	log "Unable to determine IP address!"
	exit 1
    fi     
	log "Updating my IP to \<span class="token variable">${IP}</span> in \<span class="token variable">${CLUSTER_CONFIG}</span>"
	sed -i -e "/myself/s/[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}/\<span class="token variable">${IP}</span>/g" \<span class="token variable">${CLUSTER_CONFIG}</span>
fi

redis-server /etc/redis.conf 

EOF</span>


<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${filePath}</span>/redisSalveTem.sh <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/bin/bash

# redis1 容器内执行集群创建

# redis1  redis4  redis7
# redis2  redis5  redis8
# redis3  redis6  redis9
# 1 5 9
# 4 2 8
# 7 3 6
# 进入 redis1 容器
docker exec -it redis1 /bin/sh
# 指定主从节点交叉分布
# redis1 容器内执行集群创建
# 创建主节点
redis-cli --cluster create REDIS1:6379 REDIS4:6379 REDIS7:6379 -a '123456'

# 确认
yes

# 指定主从节点交叉分布

redis-cli --cluster add-node REDIS5:6379 REDIS1:6379 --cluster-slave -a '123456'
redis-cli --cluster add-node REDIS9:6379 REDIS1:6379 --cluster-slave -a '123456'
redis-cli --cluster add-node REDIS2:6379 REDIS4:6379 --cluster-slave -a '123456'
redis-cli --cluster add-node REDIS8:6379 REDIS4:6379 --cluster-slave -a '123456'
redis-cli --cluster add-node REDIS3:6379 REDIS7:6379 --cluster-slave -a '123456'
redis-cli --cluster add-node REDIS6:6379 REDIS7:6379 --cluster-slave -a '123456'

# 检查集群状态"
redis-cli -c -a '123456'
# 查看集群节点 9个
CLUSTER NODES

# 退出 redis
exit

# 退出容器
exit

EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${filePath}</span>/redisSetIp.sh <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/bin/bash
<span class="token entity" title="\c">\c</span>p redisSalveTem.sh redisSalve.sh

function getIp(){
    redis1=\<span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> redis1 <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">"ping \<span class="token variable">$1</span> -c 1 | sed '1{s/[^(]*(//;s/).*//;q}'"</span><span class="token variable">)</span></span>
    echo "\<span class="token variable">${redis1}</span>"
}



echo "redis1=\<span class="token variable"><span class="token variable">$(</span>getIp redis1<span class="token variable">)</span></span>"
echo "redis2=\<span class="token variable"><span class="token variable">$(</span>getIp redis2<span class="token variable">)</span></span>"
echo "redis3=\<span class="token variable"><span class="token variable">$(</span>getIp redis3<span class="token variable">)</span></span>"
echo "redis4=\<span class="token variable"><span class="token variable">$(</span>getIp redis4<span class="token variable">)</span></span>"
echo "redis5=\<span class="token variable"><span class="token variable">$(</span>getIp redis5<span class="token variable">)</span></span>"
echo "redis6=\<span class="token variable"><span class="token variable">$(</span>getIp redis6<span class="token variable">)</span></span>"
echo "redis7=\<span class="token variable"><span class="token variable">$(</span>getIp redis7<span class="token variable">)</span></span>"
echo "redis8=\<span class="token variable"><span class="token variable">$(</span>getIp redis8<span class="token variable">)</span></span>"
echo "redis9=\<span class="token variable"><span class="token variable">$(</span>getIp redis9<span class="token variable">)</span></span>"


echo 'sed -i "s#REDIS1#\<span class="token variable">$redis1</span>#g" redisSalve.sh'
echo 'sed -i "s#REDIS2#\<span class="token variable">$redis2</span>#g" redisSalve.sh'
echo 'sed -i "s#REDIS3#\<span class="token variable">$redis3</span>#g" redisSalve.sh'
echo 'sed -i "s#REDIS4#\<span class="token variable">$redis4</span>#g" redisSalve.sh'
echo 'sed -i "s#REDIS5#\<span class="token variable">$redis5</span>#g" redisSalve.sh'
echo 'sed -i "s#REDIS6#\<span class="token variable">$redis6</span>#g" redisSalve.sh'
echo 'sed -i "s#REDIS7#\<span class="token variable">$redis7</span>#g" redisSalve.sh'
echo 'sed -i "s#REDIS8#\<span class="token variable">$redis8</span>#g" redisSalve.sh'
echo 'sed -i "s#REDIS9#\<span class="token variable">$redis9</span>#g" redisSalve.sh'
echo 'cat redisSalve.sh'
EOF</span>

</code></pre> 
<h4><a id="22_redisnode2_261"></a>2.2 redisnode2文件</h4> 
<pre><code class="prism language-sh"><span class="token assign-left variable">filePath</span><span class="token operator">=</span><span class="token string">"/home/redis/redisnode2"</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$filePath</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${filePath}</span>/docker-compose.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
version: '3'

networks:
  redis-net:
    external: true 

services:
  redis4:
    image: redis:6.0-alpine
    hostname: redis4
    container_name: redis4
    volumes:
      - "\<span class="token environment constant">$PWD</span>/redis4/data:/data"
      - "\<span class="token environment constant">$PWD</span>/redis.conf:/etc/redis.conf"
      - "\<span class="token environment constant">$PWD</span>/redisStart.sh:/redis/redisStart.sh"
    command: "sh /redis/redisStart.sh"
    restart: always
    privileged: true
    networks:
     - redis-net
  redis5:
    image: redis:6.0-alpine
    hostname: redis5
    container_name: redis5
    volumes:
      - "\<span class="token environment constant">$PWD</span>/redis5/data:/data"
      - "\<span class="token environment constant">$PWD</span>/redis.conf:/etc/redis.conf"
      - "\<span class="token environment constant">$PWD</span>/redisStart.sh:/redis/redisStart.sh"
    command: "sh /redis/redisStart.sh"
    restart: always
    privileged: true
    networks:
     - redis-net
  redis6:
    image: redis:6.0-alpine
    hostname: redis6
    container_name: redis6
    volumes:
      - "\<span class="token environment constant">$PWD</span>/redis6/data:/data"
      - "\<span class="token environment constant">$PWD</span>/redis.conf:/etc/redis.conf"
      - "\<span class="token environment constant">$PWD</span>/redisStart.sh:/redis/redisStart.sh"
    command: "sh /redis/redisStart.sh"
    restart: always
    privileged: true
    networks:
     - redis-net
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${filePath}</span>/redis.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
port 6379
masterauth '123456' 
requirepass '123456'
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
appendonly yes
EOF</span>





<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${filePath}</span>/redisStart.sh <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/bin/sh

CURRENT_DIR=\<span class="token variable"><span class="token variable">$(</span>
   <span class="token builtin class-name">cd</span> <span class="token string">"\$(dirname "</span><span class="token punctuation">\</span>$0<span class="token string">")"</span>
   <span class="token builtin class-name">pwd</span>
<span class="token variable">)</span></span>
nowDate=\<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">"+%Y%m%d%H%M%S"</span><span class="token variable">)</span></span>
logFileName="redisStart_"\<span class="token variable">$nowDate</span>.log
touch \<span class="token variable">$CURRENT_DIR</span>/\<span class="token variable">${logFileName}</span>
# 日志函数
log(){
	echo "["\<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">"+%Y-%m-%d %H:%M:%S"</span><span class="token variable">)</span></span>"]"<span class="token variable">$1</span> | tee -a \<span class="token variable">$CURRENT_DIR</span>/\<span class="token variable">$logFileName</span>
}

# 通过ifconfig命令获取IP地址
IP=\<span class="token variable"><span class="token variable">$(</span><span class="token function">ifconfig</span> eth0 <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'inet addr:'</span> <span class="token operator">|</span> <span class="token function">cut</span> -d: <span class="token parameter variable">-f2</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print \$1}'</span><span class="token variable">)</span></span>
log "Container IP Address is: \<span class="token variable">${IP}</span>"
CLUSTER_CONFIG="/data/nodes.conf"

if [ -f \<span class="token variable">${CLUSTER_CONFIG}</span> ]; then
    if [ -z "\<span class="token variable">${IP}</span>" ]; then
	log "Unable to determine IP address!"
	exit 1
    fi     
	log "Updating my IP to \<span class="token variable">${IP}</span> in \<span class="token variable">${CLUSTER_CONFIG}</span>"
	sed -i -e "/myself/s/[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}/\<span class="token variable">${IP}</span>/g" \<span class="token variable">${CLUSTER_CONFIG}</span>
fi

redis-server /etc/redis.conf 

EOF</span>

</code></pre> 
<h4><a id="23_redisnode3_364"></a>2.3 redisnode3文件</h4> 
<pre><code class="prism language-sh"><span class="token assign-left variable">filePath</span><span class="token operator">=</span><span class="token string">"/home/redis/redisnode3"</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$filePath</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${filePath}</span>/docker-compose.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
version: '3'

networks:
  redis-net:
    external: true 

services:
  redis7:
    image: redis:6.0-alpine
    hostname: redis7
    container_name: redis7
    volumes:
      - "\<span class="token environment constant">$PWD</span>/redis7/data:/data"
      - "\<span class="token environment constant">$PWD</span>/redis.conf:/etc/redis.conf"
      - "\<span class="token environment constant">$PWD</span>/redisStart.sh:/redis/redisStart.sh"
    command: "sh /redis/redisStart.sh"
    restart: always
    privileged: true
    networks:
     - redis-net
  redis8:
    image: redis:6.0-alpine
    hostname: redis8
    container_name: redis8
    volumes:
      - "\<span class="token environment constant">$PWD</span>/redis8/data:/data"
      - "\<span class="token environment constant">$PWD</span>/redis.conf:/etc/redis.conf"
      - "\<span class="token environment constant">$PWD</span>/redisStart.sh:/redis/redisStart.sh"
    command: "sh /redis/redisStart.sh"
    restart: always
    privileged: true
    networks:
     - redis-net
  redis9:
    image: redis:6.0-alpine
    hostname: redis9
    container_name: redis9
    volumes:
      - "\<span class="token environment constant">$PWD</span>/redis9/data:/data"
      - "\<span class="token environment constant">$PWD</span>/redis.conf:/etc/redis.conf"
      - "\<span class="token environment constant">$PWD</span>/redisStart.sh:/redis/redisStart.sh"
    command: "sh /redis/redisStart.sh"
    restart: always
    privileged: true
    networks:
     - redis-net
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${filePath}</span>/redis.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
port 6379
masterauth '123456' 
requirepass '123456'
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
appendonly yes
EOF</span>


<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${filePath}</span>/redisStart.sh <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/bin/sh

CURRENT_DIR=\<span class="token variable"><span class="token variable">$(</span>
   <span class="token builtin class-name">cd</span> <span class="token string">"\$(dirname "</span><span class="token punctuation">\</span>$0<span class="token string">")"</span>
   <span class="token builtin class-name">pwd</span>
<span class="token variable">)</span></span>
nowDate=\<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">"+%Y%m%d%H%M%S"</span><span class="token variable">)</span></span>
logFileName="redisStart_"\<span class="token variable">$nowDate</span>.log
touch \<span class="token variable">$CURRENT_DIR</span>/\<span class="token variable">${logFileName}</span>
# 日志函数
log(){
	echo "["\<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token string">"+%Y-%m-%d %H:%M:%S"</span><span class="token variable">)</span></span>"]"<span class="token variable">$1</span> | tee -a \<span class="token variable">$CURRENT_DIR</span>/\<span class="token variable">$logFileName</span>
}

# 通过ifconfig命令获取IP地址
IP=\<span class="token variable"><span class="token variable">$(</span><span class="token function">ifconfig</span> eth0 <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'inet addr:'</span> <span class="token operator">|</span> <span class="token function">cut</span> -d: <span class="token parameter variable">-f2</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print \$1}'</span><span class="token variable">)</span></span>
log "Container IP Address is: \<span class="token variable">${IP}</span>"
CLUSTER_CONFIG="/data/nodes.conf"

if [ -f \<span class="token variable">${CLUSTER_CONFIG}</span> ]; then
    if [ -z "\<span class="token variable">${IP}</span>" ]; then
	log "Unable to determine IP address!"
	exit 1
    fi     
	log "Updating my IP to \<span class="token variable">${IP}</span> in \<span class="token variable">${CLUSTER_CONFIG}</span>"
	sed -i -e "/myself/s/[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}/\<span class="token variable">${IP}</span>/g" \<span class="token variable">${CLUSTER_CONFIG}</span>
fi

redis-server /etc/redis.conf 

EOF</span>

</code></pre> 
<h3><a id="3__redisnode1_466"></a>3. 启动 redisnode1</h3> 
<p>进入 <code>node1</code>服务器</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /home/redis/redisnode1

<span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> 
</code></pre> 
<h3><a id="4__redisnode2_476"></a>4. 启动 redisnode2</h3> 
<p>进入 <code>node2</code>服务器</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /home/redis/redisnode2

<span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> 
</code></pre> 
<h3><a id="5__redisnode3_486"></a>5. 启动 redisnode3</h3> 
<p>进入 <code>node3</code>服务器</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /home/redis/redisnode3

<span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> 
</code></pre> 
<h3><a id="6__496"></a>6. 创建集群</h3> 
<p>进入 <code>node1</code>服务器</p> 
<pre><code class="prism language-sh"><span class="token function">bash</span> redisSetIp.sh
</code></pre> 
<p><img src="https://images2.imgbox.com/76/50/Uzq7jdEh_o.png" alt="在这里插入图片描述"></p> 
<p>复制上面打印的命令进行执行生成加入集群的语句<br> <img src="https://images2.imgbox.com/0c/85/hYLTyn2U_o.png" alt="在这里插入图片描述"></p> 
<p>按照步骤一步一步的加入</p> 
<pre><code class="prism language-sh"><span class="token comment"># redis1 容器内执行集群创建</span>

<span class="token comment"># redis1  redis4  redis7</span>
<span class="token comment"># redis2  redis5  redis8</span>
<span class="token comment"># redis3  redis6  redis9</span>
<span class="token comment"># 1 5 9</span>
<span class="token comment"># 4 2 8</span>
<span class="token comment"># 7 3 6</span>
<span class="token comment"># 进入 redis1 容器</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> redis1 /bin/sh
<span class="token comment"># 指定主从节点交叉分布</span>
<span class="token comment"># redis1 容器内执行集群创建</span>
<span class="token comment"># 创建主节点</span>
redis-cli <span class="token parameter variable">--cluster</span> create <span class="token number">10.0</span>.1.149:6379 <span class="token number">10.0</span>.1.157:6379 <span class="token number">10.0</span>.1.29:6379 <span class="token parameter variable">-a</span> <span class="token string">'123456'</span>

<span class="token comment"># 确认</span>
<span class="token function">yes</span>

<span class="token comment"># 指定主从节点交叉分布</span>

redis-cli <span class="token parameter variable">--cluster</span> add-node <span class="token number">10.0</span>.1.156:6379 <span class="token number">10.0</span>.1.149:6379 --cluster-slave <span class="token parameter variable">-a</span> <span class="token string">'123456'</span>
redis-cli <span class="token parameter variable">--cluster</span> add-node <span class="token number">10.0</span>.1.176:6379 <span class="token number">10.0</span>.1.149:6379 --cluster-slave <span class="token parameter variable">-a</span> <span class="token string">'123456'</span>
redis-cli <span class="token parameter variable">--cluster</span> add-node <span class="token number">10.0</span>.1.150:6379 <span class="token number">10.0</span>.1.157:6379 --cluster-slave <span class="token parameter variable">-a</span> <span class="token string">'123456'</span>
redis-cli <span class="token parameter variable">--cluster</span> add-node <span class="token number">10.0</span>.1.175:6379 <span class="token number">10.0</span>.1.157:6379 --cluster-slave <span class="token parameter variable">-a</span> <span class="token string">'123456'</span>
redis-cli <span class="token parameter variable">--cluster</span> add-node <span class="token number">10.0</span>.1.146:6379 <span class="token number">10.0</span>.1.29:6379 --cluster-slave <span class="token parameter variable">-a</span> <span class="token string">'123456'</span>
redis-cli <span class="token parameter variable">--cluster</span> add-node <span class="token number">10.0</span>.1.158:6379 <span class="token number">10.0</span>.1.29:6379 --cluster-slave <span class="token parameter variable">-a</span> <span class="token string">'123456'</span>

<span class="token comment"># 检查集群状态"</span>
redis-cli <span class="token parameter variable">-c</span> <span class="token parameter variable">-a</span> <span class="token string">'123456'</span>
<span class="token comment"># 查看集群节点 9个</span>
CLUSTER NODES

<span class="token comment"># 退出 redis</span>
<span class="token builtin class-name">exit</span>

<span class="token comment"># 退出容器</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/dd/d3/5J3zCgYD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="7_554"></a>7.测试用例</h3> 
<h4><a id="71_1_556"></a>7.1 用例1</h4> 
<pre><code class="prism language-sh">设置一个值
将对应值的节点关闭
查看集群，查看设置的参数
启动关闭的节点，查看集群是否加入
</code></pre> 
<p><img src="https://images2.imgbox.com/ad/80/MF7OIwag_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b2/ab/LWKqwuDx_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/17/f7/OOr48yeQ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7f/b2/AixJcEBb_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/94/4b/RivvSUqj_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5f77c22734f000fd310f702a3ddcd654/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">redis 三主六从高可用dockerswarm高级版(不固定ip)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/67643bc409019ced924a7299f520680c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">go.mod与module</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>