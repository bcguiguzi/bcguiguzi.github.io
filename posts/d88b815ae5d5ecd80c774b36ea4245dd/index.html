<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>c&#43;&#43;与python进行管道通信，内附详细代码 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="c&#43;&#43;与python进行管道通信，内附详细代码" />
<meta property="og:description" content="因项目需求，需要实现python与c&#43;&#43;间的通信。由于代码都在本地，因此采用管道通信的方式。
文章目录 一、管道简介 二、struct模块相关内容 三、代码demo 一、管道简介 管道是用于连接读/写进程的共享文件，pipe文件，本质上是内存中固定大小的缓冲区。管道通信的特点如下：
1.以流的形式读写：未满不读，已满不写，未空不写，已空不读，读后删除
2.同一时段只能单向通信，属于半双工通信
3.以先进先出（FIFO）方式组织数据传输
4.通过系统调用read()/write()函数进行读写操作
二、struct模块相关内容 此模块用于解析从c&#43;&#43;端获取的数据，以及打包从python端发送的数据。 对齐方式：
格式符：
三、代码demo 下面是代码demo：
1.python创建管道，c&#43;&#43;先写再读，python先读再写
python端代码：
import torch import win32file import win32pipe import struct from alog import MyAdd class Mypipe(): def __init__(self): # 数据内容 self.end_context = None # 初始化模型 self.model = torch.jit.load(&#34;model.pt&#34;) def pipe_init(self): # 创建管道 self.python_pipe = win32pipe.CreateNamedPipe(r&#34;\\.\\Pipe\\JUECE1-1&#34;, win32pipe.PIPE_ACCESS_DUPLEX, win32pipe.PIPE_TYPE_MESSAGE|win32pipe.PIPE_WAIT|win32pipe.PIPE_READMODE_MESSAGE, win32pipe.PIPE_UNLIMITED_INSTANCES, 65536, 65536, 500, None) def pipe_connect(self): win32pipe.ConnectNamedPipe(self.python_pipe, None) print(&#34;python 管道链接成功！&#34;) def pipe_run(self): print(&#34;管道开始运行！&#34;) while(1): # 计算格式大小 formats = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/d88b815ae5d5ecd80c774b36ea4245dd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-07T23:03:28+08:00" />
<meta property="article:modified_time" content="2023-06-07T23:03:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">c&#43;&#43;与python进行管道通信，内附详细代码</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>因项目需求，需要实现python与c++间的通信。由于代码都在本地，因此采用管道通信的方式。</p> 
<h3><a id="_2"></a>文章目录</h3> 
<h3><a id="a_hrefbt1a_3"></a><a href="#bt1" rel="nofollow">一、管道简介</a></h3> 
<h3><a id="a_hrefbt2structa_5"></a><a href="#bt2" rel="nofollow">二、struct模块相关内容</a></h3> 
<h3><a id="a_hrefbt3demoa_7"></a><a href="#bt3" rel="nofollow">三、代码demo</a></h3> 
<h3 id="bt1">一、管道简介</h3> 
<p>管道是用于连接读/写进程的共享文件，pipe文件，本质上是内存中固定大小的缓冲区。管道通信的特点如下：<br> 1.以流的形式读写：未满不读，已满不写，未空不写，已空不读，读后删除<br> 2.同一时段只能单向通信，属于半双工通信<br> 3.以先进先出（FIFO）方式组织数据传输<br> 4.通过系统调用read()/write()函数进行读写操作</p> 
<h3 id="bt2">二、struct模块相关内容</h3> 此模块用于解析从c++端获取的数据，以及打包从python端发送的数据。 
<p><img src="https://images2.imgbox.com/43/d9/sfd71ORo_o.png" alt="在这里插入图片描述"><br> 对齐方式：<br> <img src="https://images2.imgbox.com/04/20/0r3W28Y5_o.png" alt="在这里插入图片描述"><br> 格式符：<br> <img src="https://images2.imgbox.com/70/7c/v5gOCpWq_o.png" alt="在这里插入图片描述"></p> 
<h3 id="bt3">三、代码demo</h3> 
<p>下面是代码demo：<br> 1.python创建管道，c++先写再读，python先读再写<br> python端代码：</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> torch
<span class="token function">import</span> win32file
<span class="token function">import</span> win32pipe
<span class="token function">import</span> struct
from alog <span class="token function">import</span> MyAdd


class Mypipe<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token comment"># 数据内容</span>
        self.end_context <span class="token operator">=</span> None
        <span class="token comment"># 初始化模型</span>
        self.model <span class="token operator">=</span> torch.jit.load<span class="token punctuation">(</span><span class="token string">"model.pt"</span><span class="token punctuation">)</span>

    def pipe_init<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token comment"># 创建管道</span>
        self.python_pipe <span class="token operator">=</span> win32pipe.CreateNamedPipe<span class="token punctuation">(</span>r<span class="token string">"<span class="token entity" title="\\">\\</span>.<span class="token entity" title="\\">\\</span>Pipe<span class="token entity" title="\\">\\</span>JUECE1-1"</span>,
                                                     win32pipe.PIPE_ACCESS_DUPLEX,
                                                     win32pipe.PIPE_TYPE_MESSAGE<span class="token operator">|</span>win32pipe.PIPE_WAIT<span class="token operator">|</span>win32pipe.PIPE_READMODE_MESSAGE,
                                                     win32pipe.PIPE_UNLIMITED_INSTANCES,
                                                     <span class="token number">65536</span>,
                                                     <span class="token number">65536</span>,
                                                     <span class="token number">500</span>,
                                                     None<span class="token punctuation">)</span>

    def pipe_connect<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        win32pipe.ConnectNamedPipe<span class="token punctuation">(</span>self.python_pipe, None<span class="token punctuation">)</span>
        print<span class="token punctuation">(</span><span class="token string">"python 管道链接成功！"</span><span class="token punctuation">)</span>

    def pipe_run<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        print<span class="token punctuation">(</span><span class="token string">"管道开始运行！"</span><span class="token punctuation">)</span>
        while<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>:
            <span class="token comment"># 计算格式大小</span>
            formats <span class="token operator">=</span> <span class="token string">"&lt;"</span> + <span class="token string">'f'</span> + <span class="token string">'d'</span> * <span class="token number">10</span> + <span class="token string">'i'</span> + <span class="token string">"I"</span> + <span class="token string">'d'</span> + <span class="token string">'f'</span>*6
            size <span class="token operator">=</span> struct.calcsize<span class="token punctuation">(</span>formats<span class="token punctuation">)</span>
            print<span class="token punctuation">(</span>size<span class="token punctuation">)</span>

            res <span class="token operator">=</span> win32file.ReadFile<span class="token punctuation">(</span>self.python_pipe, size, None<span class="token punctuation">)</span>
            res <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            res <span class="token operator">=</span> struct.unpack<span class="token punctuation">(</span>formats, res<span class="token punctuation">)</span>
            print<span class="token punctuation">(</span><span class="token string">"接收到的数据："</span><span class="token punctuation">)</span>
            print<span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>,
                  res<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>,
                  res<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span>,
                  res<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span>,
                  res<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span>, <span class="token punctuation">)</span>

            <span class="token comment"># 算法一：调用pt模型</span>
            res <span class="token operator">=</span> res<span class="token punctuation">[</span>:10<span class="token punctuation">]</span>
            tensor_data <span class="token operator">=</span> torch.tensor<span class="token punctuation">(</span>res, <span class="token assign-left variable">dtype</span><span class="token operator">=</span>torch.float32<span class="token punctuation">)</span>
            res_algo_1 <span class="token operator">=</span> self.model<span class="token punctuation">(</span>tensor_data<span class="token punctuation">)</span>.detach<span class="token punctuation">(</span><span class="token punctuation">)</span>.numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 算法二：调用普通算法</span>
            res_algo_2 <span class="token operator">=</span> MyAdd<span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

            res_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> res_algo_1:
                res_list.append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            res_list.append<span class="token punctuation">(</span>res_algo_2<span class="token punctuation">)</span>

            print<span class="token punctuation">(</span><span class="token string">"计算出的数据："</span><span class="token punctuation">)</span>
            print<span class="token punctuation">(</span>res_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, res_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>,res_list<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>,res_list<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>,res_list<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>,res_list<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self.end_context <span class="token operator">=</span> struct.pack<span class="token punctuation">(</span><span class="token string">"f"</span>*6, *res_list<span class="token punctuation">)</span>
            win32file.WriteFile<span class="token punctuation">(</span>self.python_pipe, self.end_context<span class="token punctuation">)</span>

    def pipe_close<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        print<span class="token punctuation">(</span><span class="token string">"python 管道关闭！"</span><span class="token punctuation">)</span>
        win32pipe.DisconnectNamedPipe<span class="token punctuation">(</span>self.python_pipe<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    mypipe <span class="token operator">=</span> Mypipe<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mypipe.pipe_init<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mypipe.pipe_connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mypipe.pipe_run<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mypipe.pipe_close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>c++端代码：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;tchar.h&gt;</span></span>
<span class="token comment">//发送数据的字节数</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUF_SIZE</span> <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RUNTIME</span> <span class="token expression"><span class="token number">10</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NODENUM</span> <span class="token expression"><span class="token number">3</span></span></span>
<span class="token comment">//字节对齐</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">pack</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">MMF</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> num<span class="token punctuation">;</span>
	<span class="token keyword">double</span> kkk<span class="token punctuation">;</span>
	<span class="token keyword">float</span> mmf<span class="token punctuation">;</span>
	<span class="token keyword">float</span> mmf1<span class="token punctuation">;</span>
	<span class="token keyword">float</span> mmf2<span class="token punctuation">;</span>
	<span class="token keyword">float</span> mmf3<span class="token punctuation">;</span>
	<span class="token keyword">float</span> mmf4<span class="token punctuation">;</span>
	<span class="token keyword">float</span> mmf5<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">StructReq</span> 
<span class="token punctuation">{<!-- --></span>	
	<span class="token keyword">float</span> params2<span class="token punctuation">;</span>
	<span class="token keyword">double</span> params<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> params3<span class="token punctuation">;</span>
	MMF mmf<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">StructRes</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">float</span> params<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> result<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	DWORD rLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	DWORD wLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	HANDLE hPipe<span class="token punctuation">;</span>
	string pName<span class="token punctuation">;</span>
	LPCWSTR wpName<span class="token punctuation">;</span>
	StructRes res<span class="token punctuation">;</span>
	StructReq req<span class="token punctuation">;</span>

	req<span class="token punctuation">.</span>params2 <span class="token operator">=</span> <span class="token number">1.2</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span>params3 <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		req<span class="token punctuation">.</span>params<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	req<span class="token punctuation">.</span>mmf<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span>mmf<span class="token punctuation">.</span>kkk <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span>mmf<span class="token punctuation">.</span>mmf <span class="token operator">=</span> <span class="token number">4.5</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span>mmf<span class="token punctuation">.</span>mmf1 <span class="token operator">=</span> <span class="token number">5.5</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span>mmf<span class="token punctuation">.</span>mmf2 <span class="token operator">=</span> <span class="token number">5.6</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span>mmf<span class="token punctuation">.</span>mmf3 <span class="token operator">=</span> <span class="token number">5.7</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span>mmf<span class="token punctuation">.</span>mmf4 <span class="token operator">=</span> <span class="token number">5.8</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span>mmf<span class="token punctuation">.</span>mmf5 <span class="token operator">=</span> <span class="token number">5.9</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WaitNamedPipe</span><span class="token punctuation">(</span><span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"\\\\.\\Pipe\\JUECE1-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> NMPWAIT_WAIT_FOREVER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Connect NP Failed!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	hPipe <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span>
			    <span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"\\\\.\\Pipe\\JUECE1-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				GENERIC_READ <span class="token operator">|</span> GENERIC_WRITE<span class="token punctuation">,</span>
				<span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token constant">NULL</span><span class="token punctuation">,</span>
				OPEN_EXISTING<span class="token punctuation">,</span>
				FILE_ATTRIBUTE_NORMAL<span class="token punctuation">,</span>
				<span class="token constant">NULL</span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>INVALID_HANDLE_VALUE <span class="token operator">==</span> hPipe<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Open Pipe Failed!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">WriteFile</span><span class="token punctuation">(</span>hPipe<span class="token punctuation">,</span> <span class="token punctuation">(</span>byte<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>req<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>StructReq<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wLen<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ReadFile</span><span class="token punctuation">(</span>hPipe<span class="token punctuation">,</span> <span class="token punctuation">(</span>byte<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>StructRes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rLen<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	cout <span class="token operator">&lt;&lt;</span> res<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\t"</span> <span class="token operator">&lt;&lt;</span> res<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\t"</span> <span class="token operator">&lt;&lt;</span> res<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\t"</span> <span class="token operator">&lt;&lt;</span> res<span class="token punctuation">.</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\t"</span>
		<span class="token operator">&lt;&lt;</span> res<span class="token punctuation">.</span>result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\t"</span> <span class="token operator">&lt;&lt;</span> res<span class="token punctuation">.</span>result<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2.c++创建管道，c++先写再读，python先读再写<br> python端代码：</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> torch
<span class="token function">import</span> win32file
<span class="token function">import</span> win32pipe
<span class="token function">import</span> struct
from alog <span class="token function">import</span> MyAdd


class Mypipe<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token comment"># 数据内容</span>
        self.end_context <span class="token operator">=</span> None
        <span class="token comment"># 初始化模型</span>
        self.model <span class="token operator">=</span> torch.jit.load<span class="token punctuation">(</span><span class="token string">"model.pt"</span><span class="token punctuation">)</span>

    def pipe_init<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token comment"># 创建管道文件</span>
        PIPE_NAME <span class="token operator">=</span> r<span class="token string">"<span class="token entity" title="\\">\\</span>.\Pipe\mypipe"</span>
        self.python_pipe <span class="token operator">=</span> win32file.CreateFile<span class="token punctuation">(</span>
                                  PIPE_NAME,
                                  win32file.GENERIC_READ <span class="token operator">|</span> win32file.GENERIC_WRITE,
                                  win32file.FILE_SHARE_WRITE, None,
                                  win32file.OPEN_EXISTING, <span class="token number">0</span>, None<span class="token punctuation">)</span>

    def pipe_run<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        print<span class="token punctuation">(</span><span class="token string">"管道开始运行！"</span><span class="token punctuation">)</span>
        while<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>:
            formats <span class="token operator">=</span> <span class="token string">"&lt;"</span> + <span class="token string">'f'</span> + <span class="token string">'d'</span> * <span class="token number">10</span> + <span class="token string">'i'</span> + <span class="token string">"I"</span> + <span class="token string">'d'</span> + <span class="token string">'f'</span>*6
            <span class="token comment"># formats = "&lt;" + 'f' + 's'*10 + 'i'</span>
            size <span class="token operator">=</span> struct.calcsize<span class="token punctuation">(</span>formats<span class="token punctuation">)</span>
            print<span class="token punctuation">(</span>size<span class="token punctuation">)</span>

            res <span class="token operator">=</span> win32file.ReadFile<span class="token punctuation">(</span>self.python_pipe, size, None<span class="token punctuation">)</span>
            res <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            res <span class="token operator">=</span> struct.unpack<span class="token punctuation">(</span>formats, res<span class="token punctuation">)</span>
            print<span class="token punctuation">(</span><span class="token string">"接收到的数据："</span><span class="token punctuation">)</span>
            print<span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>,
                  res<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>,
                  res<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span>,
                  res<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span>,
                  res<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span>, <span class="token punctuation">)</span>

            <span class="token comment"># 算法一：调用pt模型</span>
            res <span class="token operator">=</span> res<span class="token punctuation">[</span>:10<span class="token punctuation">]</span>
            tensor_data <span class="token operator">=</span> torch.tensor<span class="token punctuation">(</span>res, <span class="token assign-left variable">dtype</span><span class="token operator">=</span>torch.float32<span class="token punctuation">)</span>
            res_algo_1 <span class="token operator">=</span> self.model<span class="token punctuation">(</span>tensor_data<span class="token punctuation">)</span>.detach<span class="token punctuation">(</span><span class="token punctuation">)</span>.numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 算法二：调用普通算法</span>
            res_algo_2 <span class="token operator">=</span> MyAdd<span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

            res_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> res_algo_1:
                res_list.append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            res_list.append<span class="token punctuation">(</span>res_algo_2<span class="token punctuation">)</span>

            print<span class="token punctuation">(</span><span class="token string">"计算出的数据："</span><span class="token punctuation">)</span>
            print<span class="token punctuation">(</span>res_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, res_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>,res_list<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>,res_list<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>,res_list<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>,res_list<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self.end_context <span class="token operator">=</span> struct.pack<span class="token punctuation">(</span><span class="token string">"f"</span>*6, *res_list<span class="token punctuation">)</span>
            win32file.WriteFile<span class="token punctuation">(</span>self.python_pipe, self.end_context<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    mypipe <span class="token operator">=</span> Mypipe<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mypipe.pipe_init<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mypipe.pipe_run<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>c++端代码：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//cpp创建管道</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"创建命名管道并等待连接\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> pipeName<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\\\\.\\Pipe\\mypipe"</span><span class="token punctuation">;</span>
	HANDLE hPipe <span class="token operator">=</span> <span class="token function">CreateNamedPipe</span><span class="token punctuation">(</span>pipeName<span class="token punctuation">,</span> PIPE_ACCESS_DUPLEX<span class="token punctuation">,</span> PIPE_TYPE_MESSAGE <span class="token operator">|</span> PIPE_READMODE_MESSAGE <span class="token operator">|</span> PIPE_WAIT
		<span class="token punctuation">,</span> PIPE_UNLIMITED_INSTANCES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NMPWAIT_WAIT_FOREVER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	StructRes res<span class="token punctuation">;</span>
	StructReq req<span class="token punctuation">;</span>
	DWORD rLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	DWORD wLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Client Started!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

	<span class="token comment">//waiting to be connected</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ConnectNamedPipe</span><span class="token punctuation">(</span>hPipe<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"连接成功，开始发送数据\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>hPipe<span class="token punctuation">,</span> <span class="token punctuation">(</span>byte<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>req<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>StructReq<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wLen<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>
						cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Request Failed!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>hPipe<span class="token punctuation">,</span> <span class="token punctuation">(</span>byte<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>StructRes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rLen<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
						<span class="token punctuation">{<!-- --></span>
							cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Response Failede!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
							cout <span class="token operator">&lt;&lt;</span> res<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span><span class="token string">"\t"</span><span class="token operator">&lt;&lt;</span> res<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\t"</span> <span class="token operator">&lt;&lt;</span> res<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\t"</span> <span class="token operator">&lt;&lt;</span> res<span class="token punctuation">.</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\t"</span>
								<span class="token operator">&lt;&lt;</span> res<span class="token punctuation">.</span>result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\t"</span> <span class="token operator">&lt;&lt;</span> res<span class="token punctuation">.</span>result<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>



	<span class="token function">DisconnectNamedPipe</span><span class="token punctuation">(</span>hPipe<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">CloseHandle</span><span class="token punctuation">(</span>hPipe<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭管道</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"关闭管道\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>注意事项：<br> 1.c++端要加pragma pack(1)，按一字节对齐<br> 2.python端采用小端对齐的方式获取字节数</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/519d9381b0235b7e01a472ea396b46f0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">分享mysql创建索引的3种方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c1fe76698b95d8b5100b32622690112d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue3中集成Unreal 5.2 像素流(Pixel Streaming插件)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>