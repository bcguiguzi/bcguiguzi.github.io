<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL-数据库事务详解 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL-数据库事务详解" />
<meta property="og:description" content="目录
一、事务的ACID特性
二、事务的状态
三、使用事务
3.1、事务完成的过程
3.2、显示事务
3.3、隐式事务
3.4、事务隔离级别
3.4.1、事务问题
3.4.2 SQL的隔离级别
四、事务日志
4.1、redo 日志
4.2、undo日志
一、事务的ACID特性 原子性：事务是一个不可分割的工作单位，要么全部提交，要么全部失败回滚；基础。一致性：数据从一个合法性变化成另一个合法性，这种状态是指语义上的，跟业务要求有关，需要满足约束，例如转账时超出总额；手段。隔离性：一个事务执行时不能被其他事务干扰，使用的数据对于其他并发的事务是隔离的，并发执行的各个事务之间不能互相干扰；约束条件。持久性：一个事务一旦提交，它对数据库中数据的改变是永久的，接下来的数据操作和故障不应该对其有任何影响。目的。 二、事务的状态 活动的：事务对应的数据库操作正在执行过程中时；部分提交的：事务中的最后一个操作执行完成，但由于操作是在内存中执行的，所造成的影响并没有刷新到磁盘时，此时的状态为部分提交状态；失败的：事务处于活动的或者部分提交的状态时，可能遇到某些错误无法继续执行，此时为失败的状态；中止的：事务执行了一部分而变为失败的状态，那么就需要把已经修改的事务中的操作还原到事务执行前的状态。回滚完成时的状态；提交的：部分提交的数据修改持久化到磁盘上。 三、使用事务 3.1、事务完成的过程 步骤一：开启事务
步骤二：一系列的DML操作
步骤三：事务结束的状态：提交的状态(COMMIT）、中止的状态(ROLLBACK)
3.2、显示事务 步骤一：开启 使用关键字：start transaction 或 begin
start transation 后面可以跟：read only / read write (默认) / with consistent snapshot（启动一致性读）
步骤二：保存点
3.3、隐式事务 autocommit:是否自动提交
3.4、事务隔离级别 多个请求分布在不同事务中，可能同时请求更改一条数据，这时需要一种机制权衡并发性和隔离性。
3.4.1、事务问题 脏写：一个事务A修改B未提交事务，此时B回滚，A修改的数据是无效的； 脏读：事务A读到了B未提交的事务，之后B回滚，A读取的内容是临时且无效的； 不可重复读：事务A读取一个字段，事务B更新一个字段，之后A再读同一个字段，值不同； 幻读：事务A从表中读取一个字段，事务B插入一些行，A再读同一个表就会多出几行； 3.4.2 SQL的隔离级别 mysql默认是可重复度隔离级别。
# 查看隔离级别 show variables like &#39;tx_isolation&#39;; show variables like &#39;transaction_isolation&#39;; # 设置隔离级别 set [global|session] transaction isolation level 隔离级别; set [global|session] transaction_isolation =&#39;隔离级别&#39; # 中划线链接 四、事务日志 实现事务特性的机制。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/b7415ab8b12153fed89abde88d82a97f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-01T23:13:32+08:00" />
<meta property="article:modified_time" content="2022-08-01T23:13:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL-数据库事务详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:0px;"></p> 
<p id="oLY1F-toc" style="margin-left:0px;"><a href="#oLY1F" rel="nofollow">一、事务的ACID特性</a></p> 
<p id="OCtY4-toc" style="margin-left:0px;"><a href="#OCtY4" rel="nofollow">二、事务的状态</a></p> 
<p id="lq1j9-toc" style="margin-left:0px;"><a href="#lq1j9" rel="nofollow">三、使用事务</a></p> 
<p id="3.1%E3%80%81%E4%BA%8B%E5%8A%A1%E5%AE%8C%E6%88%90%E7%9A%84%E8%BF%87%E7%A8%8B-toc" style="margin-left:40px;"><a href="#3.1%E3%80%81%E4%BA%8B%E5%8A%A1%E5%AE%8C%E6%88%90%E7%9A%84%E8%BF%87%E7%A8%8B" rel="nofollow">3.1、事务完成的过程</a></p> 
<p id="3.2%E3%80%81%E6%98%BE%E7%A4%BA%E4%BA%8B%E5%8A%A1-toc" style="margin-left:40px;"><a href="#3.2%E3%80%81%E6%98%BE%E7%A4%BA%E4%BA%8B%E5%8A%A1" rel="nofollow">3.2、显示事务</a></p> 
<p id="3.3%E3%80%81%E9%9A%90%E5%BC%8F%E4%BA%8B%E5%8A%A1-toc" style="margin-left:40px;"><a href="#3.3%E3%80%81%E9%9A%90%E5%BC%8F%E4%BA%8B%E5%8A%A1" rel="nofollow">3.3、隐式事务</a></p> 
<p id="3.4%E3%80%81%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB-toc" style="margin-left:40px;"><a href="#3.4%E3%80%81%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB" rel="nofollow">3.4、事务隔离级别</a></p> 
<p id="3.4.1%E3%80%81%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98-toc" style="margin-left:80px;"><a href="#3.4.1%E3%80%81%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98" rel="nofollow">3.4.1、事务问题</a></p> 
<p id="3.4.2%20SQL%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB-toc" style="margin-left:80px;"><a href="#3.4.2%20SQL%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB" rel="nofollow">3.4.2 SQL的隔离级别</a></p> 
<p id="FLO0G-toc" style="margin-left:0px;"><a href="#FLO0G" rel="nofollow">四、事务日志</a></p> 
<p id="4.1%E3%80%81redo%20%E6%97%A5%E5%BF%97-toc" style="margin-left:40px;"><a href="#4.1%E3%80%81redo%20%E6%97%A5%E5%BF%97" rel="nofollow">4.1、redo 日志</a></p> 
<p id="4.2%E3%80%81undo%E6%97%A5%E5%BF%97-toc" style="margin-left:40px;"><a href="#4.2%E3%80%81undo%E6%97%A5%E5%BF%97" rel="nofollow">4.2、undo日志</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="oLY1F">一、事务的ACID特性</h2> 
<ul><li id="u3c5e1d10"><span style="color:#fe2c24;">原子性</span>：事务是一个不可分割的工作单位，要么全部提交，要么全部失败回滚；基础。</li><li id="ue36ff7b3"><span style="color:#fe2c24;">一致性</span>：数据从一个合法性变化成另一个合法性，这种状态是指语义上的，跟业务要求有关，需要满足约束，例如转账时超出总额；手段。</li><li id="u34d6ba22"><span style="color:#fe2c24;">隔离性</span>：一个事务执行时不能被其他事务干扰，使用的数据对于其他并发的事务是隔离的，并发执行的各个事务之间不能互相干扰；约束条件。</li><li id="u08f18e19"><span style="color:#fe2c24;">持久性</span>：一个事务一旦提交，它对数据库中数据的改变是永久的，接下来的数据操作和故障不应该对其有任何影响。目的。</li></ul> 
<h2 id="OCtY4">二、事务的状态</h2> 
<ul><li id="u77474f8a">活动的：事务对应的数据库操作正在执行过程中时；</li><li id="u970d67e2">部分提交的：事务中的最后一个操作执行完成，但由于操作是在内存中执行的，所造成的影响并没有刷新到磁盘时，此时的状态为部分提交状态；</li><li id="ufe2bdb46">失败的：事务处于活动的或者部分提交的状态时，可能遇到某些错误无法继续执行，此时为失败的状态；</li><li id="u34602ec8">中止的：事务执行了一部分而变为失败的状态，那么就需要把已经修改的事务中的操作还原到事务执行前的状态。回滚完成时的状态；</li><li id="u408cc8a8">提交的：部分提交的数据修改持久化到磁盘上。</li></ul> 
<h2 id="lq1j9">三、使用事务</h2> 
<h3 id="3.1%E3%80%81%E4%BA%8B%E5%8A%A1%E5%AE%8C%E6%88%90%E7%9A%84%E8%BF%87%E7%A8%8B">3.1、事务完成的过程</h3> 
<p id="uf80a16b4">步骤一：开启事务</p> 
<p id="udda0465b">步骤二：一系列的DML操作</p> 
<p id="u645e242e">步骤三：事务结束的状态：提交的状态(COMMIT）、中止的状态(ROLLBACK)</p> 
<h3 id="3.2%E3%80%81%E6%98%BE%E7%A4%BA%E4%BA%8B%E5%8A%A1">3.2、显示事务</h3> 
<p id="u1072c47e">步骤一：开启 使用关键字：start transaction 或 begin</p> 
<p id="ua21f49a0">start transation 后面可以跟：read only / read write (默认) / with consistent snapshot（启动一致性读）</p> 
<p id="u75824d28">步骤二：保存点</p> 
<h3 id="3.3%E3%80%81%E9%9A%90%E5%BC%8F%E4%BA%8B%E5%8A%A1">3.3、隐式事务</h3> 
<p id="u3d0f98a9">autocommit:是否自动提交</p> 
<h3 id="3.4%E3%80%81%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB">3.4、事务隔离级别</h3> 
<p id="u225632ce">多个请求分布在不同事务中，可能同时请求更改一条数据，这时需要一种机制权衡并发性和隔离性。</p> 
<h4 id="3.4.1%E3%80%81%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98">3.4.1、事务问题</h4> 
<ul><li id="u45398a6e">脏写：一个事务A修改B未提交事务，此时B回滚，A修改的数据是无效的；</li></ul> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/f6/b0/2pcu6UGN_o.png"></p> 
<ul><li id="ub55ef90c">脏读：事务A读到了B未提交的事务，之后B回滚，A读取的内容是临时且无效的；</li></ul> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/a3/e6/RiloxzsK_o.png"></p> 
<ul><li id="uf4dbfa61">不可重复读：事务A读取一个字段，事务B更新一个字段，之后A再读同一个字段，值不同；</li></ul> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/86/03/tqTq3oIc_o.png"></p> 
<ul><li id="u42c55562">幻读：事务A从表中读取一个字段，事务B插入一些行，A再读同一个表就会多出几行；</li></ul> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/89/31/1MB4ZvMX_o.png"></p> 
<h4 id="3.4.2%20SQL%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB">3.4.2 SQL的隔离级别</h4> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/bc/52/yUdr3mEX_o.png"></p> 
<p id="u65b7637f">mysql默认是可重复度隔离级别。</p> 
<pre><code class="language-sql"># 查看隔离级别
show variables like 'tx_isolation';
show variables like 'transaction_isolation';

# 设置隔离级别
set [global|session] transaction isolation level 隔离级别; 
set [global|session] transaction_isolation ='隔离级别' # 中划线链接</code></pre> 
<h2 id="FLO0G">四、事务日志</h2> 
<p id="u6dc8b3d2">实现事务特性的机制。</p> 
<ul><li id="u8ee97b2e">事务的隔离都是由锁机制实现的；</li><li id="u88c0e9c5">事务的原子性、一致性、持久性是由事务的redo日志和undo日志来保证；</li><li id="uf1948b8f">redo log：重做日志，提供再写入操作，恢复提交事务修改的页操作，用来保证事务的持久性；物理级别上的修改。</li><li id="u6a52fe0c">undo log: 回滚日志，回滚行记录到某个特定版本，用来保证事务的原子性、一致性。逻辑上的修改。</li></ul> 
<h3 id="4.1%E3%80%81redo%20%E6%97%A5%E5%BF%97">4.1、redo 日志</h3> 
<p id="u59b83ca2">好处：</p> 
<ul><li id="uab1c60b8">redo日志降低了刷盘频率；</li><li id="u251e274b">redo日志占用的空间非常小；</li></ul> 
<p id="ud73a3e9d">存储表空间id、页面、偏移量以及需要更新的值，所需的存储空间是很小的，刷盘快。</p> 
<p id="ub12992f3">特点:</p> 
<ul><li id="u494e9ae9">redo 日志是顺序写入磁盘的；</li><li id="u098d1972">事务执行过程中，redo log 不断记录；</li></ul> 
<p id="ue86cca68">redo 的组成：</p> 
<ul><li id="u66d6f509">重做日志的缓冲，保存在内存中，是易失的；</li></ul> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/04/32/hXyFLmbe_o.png"></p> 
<p id="u0cf3c0d3">刷盘并不是真正刷入到磁盘，而是到文件系统缓冲中，再到磁盘中</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/c4/b9/3vaMzXrU_o.png"></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/36/90/zTMVN4q7_o.png"></p> 
<h3 id="4.2%E3%80%81undo%E6%97%A5%E5%BF%97">4.2、undo日志</h3> 
<p id="uef740d53">redo log是事务持久性的保证，undo log是日志原子性的保证，事务更新数据的前置操作其实是要先写入一个undo log。</p> 
<ul><li id="ufe1142da">插入数据需要记录主键，回滚的时候根据主键对应的值进行删除；</li><li id="u6f08c353">删除记录需要记录内容，回滚时再把由这些内容组成的记录插入到表中；</li><li id="ua15d5114">修改记录需要把这条记录的旧值记录下来，回滚时再把这条记录更新为旧值就好了，对于每个update操作，Innodb存储引擎会执行一个相反的update，将修改前的行放回去；</li><li id="ue36528b8">undo日志的操作也会记录到redo 日志中，需要持久性的保护。</li><li id="u06cb9cf4">作用：回滚数据；多版本并发控制</li></ul> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ae/67/1XLcBK6W_o.png"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/67d7075ecc29dd0b066dcfe51fc4d270/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android启动流程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e83021a43be6d7dfd35e75e4f8d7613e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">QT之多个界面相互切换 (stackedWidget控件)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>