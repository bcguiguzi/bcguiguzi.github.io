<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>阿里云-零基础入门推荐系统 【特征工程】 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="阿里云-零基础入门推荐系统 【特征工程】" />
<meta property="og:description" content="文章目录 学习过程赛题介绍评价方式理解赛题理解制作特征和标签， 转成监督学习问题导包df节省内存函数训练和验证集的划分获取历史点击和最后一次点击读取训练、验证及测试集读取召回列表读取各种Embedding读取文章信息读取数据对训练数据做负采样将召回数据转换成字典制作与用户历史行为相关特征用户相关特征用户的设备习惯用户的时间习惯用户的主题爱好用户的字数偏好特征用户的信息特征合并保存用户特征直接读入文章的特征直接读入召回文章的主题是否在用户的爱好里面保存特征 期间报错解决方案汇总 学习过程 20年当时自身功底是比较零基础(会写些基础的Python[三个科学计算包]数据分析)，一开始看这块其实挺懵的，不会就去问百度或其他人，当时遇见困难挺害怕的，但22后面开始力扣题【目前已刷好几轮，博客没写力扣文章之前，力扣排名靠前已刷有5遍左右，排名靠后刷3次左右，代码功底也在一步一步提升】不断地刷、遇见代码不懂的代码，也开始去打印print去理解，到后面问其他人的问题越来越少，个人自主学习、自主解决能力也得到了进一步增强。
赛题介绍 该赛题是以新闻APP中的新闻推荐为背景， 目的是要求我们根据用户历史浏览点击新闻文章的数据信息预测用户未来的点击行为， 即用户的最后一次点击的新闻文章。
评价方式理解 最后提交的格式是针对每个用户， 我们都会给出五篇文章的推荐结果，按照点击概率从前往后排序。 而真实的每个用户最后一次点击的文章只会有一篇的真实答案， 所以我们就看我们推荐的这五篇里面是否有命中真实答案的。比如对于user1来说， 我们的提交会是：
user1, article1, article2, article3, article4, article5. 评价指标的公式如下：
假如article1就是真实的用户点击文章，也就是article1命中， 则s(user1,1)=1, s(user1,2-4)都是0， 如果article2是用户点击的文章， 则s(user,2)=1/2,s(user,1,3,4,5)都是0。也就是score(user)=命中第几条的倒数。如果都没中， 则score(user1)=0。 这个是合理的， 因为我们希望的就是命中的结果尽量靠前， 而此时分数正好比较高。
赛题理解 根据赛题简介，我们首先要明确我们此次比赛的目标： 根据用户历史浏览点击新闻的数据信息预测用户最后一次点击的新闻文章。从这个目标上看， 会发现此次比赛和我们之前遇到的普通的结构化比赛不太一样， 主要有两点：
首先是目标上， 要预测最后一次点击的新闻文章，也就是我们给用户推荐的是新闻文章， 并不是像之前那种预测一个数或者预测数据哪一类那样的问题数据上， 通过给出的数据我们会发现， 这种数据也不是我们之前遇到的那种特征&#43;标签的数据，而是基于了真实的业务场景， 拿到的用户的点击日志 所以拿到这个题目，我们的思考方向就是结合我们的目标，把该预测问题转成一个监督学习的问题(特征&#43;标签)，然后我们才能进行ML，DL等建模预测。
制作特征和标签， 转成监督学习问题 我们先捋一下基于原始的给定数据， 有哪些特征可以直接利用：
文章的自身特征， category_id表示这文章的类型， created_at_ts表示文章建立的时间， 这个关系着文章的时效性， words_count是文章的字数， 一般字数太长我们不太喜欢点击, 也不排除有人就喜欢读长文。
文章的内容embedding特征， 这个召回的时候用过， 这里可以选择使用， 也可以选择不用， 也可以尝试其他类型的embedding特征， 比如W2V等
用户的设备特征信息
构造监督数据集的思路， 根据召回结果， 我们会得到一个{user_id: [可能点击的文章列表]}形式的字典。 那么我们就可以对于每个用户， 每篇可能点击的文章构造一个监督测试集， 比如对于用户user1， 假设得到的他的召回列表{user1: [item1, item2, item3]}， 我们就可以得到三行数据(user1, item1), (user1, item2), (user1, item3)的形式， 这就是监督测试集时候的前两列特征。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/b7eb0605d1f78c9a8df99c88517423cc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-17T15:05:38+08:00" />
<meta property="article:modified_time" content="2024-03-17T15:05:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">阿里云-零基础入门推荐系统 【特征工程】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_3" rel="nofollow">学习过程</a></li><li><a href="#_5" rel="nofollow">赛题介绍</a></li><li><a href="#_8" rel="nofollow">评价方式理解</a></li><li><a href="#_21" rel="nofollow">赛题理解</a></li><li><a href="#__30" rel="nofollow">制作特征和标签， 转成监督学习问题</a></li><li><ul><li><a href="#_54" rel="nofollow">导包</a></li><li><a href="#df_73" rel="nofollow">df节省内存函数</a></li><li><a href="#_123" rel="nofollow">训练和验证集的划分</a></li><li><a href="#_156" rel="nofollow">获取历史点击和最后一次点击</a></li><li><a href="#_180" rel="nofollow">读取训练、验证及测试集</a></li><li><a href="#_203" rel="nofollow">读取召回列表</a></li><li><a href="#Embedding_223" rel="nofollow">读取各种Embedding</a></li><li><a href="#_263" rel="nofollow">读取文章信息</a></li><li><a href="#_275" rel="nofollow">读取数据</a></li><li><a href="#_299" rel="nofollow">对训练数据做负采样</a></li><li><a href="#_418" rel="nofollow">将召回数据转换成字典</a></li><li><a href="#_449" rel="nofollow">制作与用户历史行为相关特征</a></li><li><a href="#_548" rel="nofollow">用户相关特征</a></li><li><a href="#_670" rel="nofollow">用户的设备习惯</a></li><li><a href="#_696" rel="nofollow">用户的时间习惯</a></li><li><a href="#_727" rel="nofollow">用户的主题爱好</a></li><li><a href="#_753" rel="nofollow">用户的字数偏好特征</a></li><li><a href="#_767" rel="nofollow">用户的信息特征合并保存</a></li><li><a href="#_789" rel="nofollow">用户特征直接读入</a></li><li><a href="#_831" rel="nofollow">文章的特征直接读入</a></li><li><a href="#_854" rel="nofollow">召回文章的主题是否在用户的爱好里面</a></li><li><a href="#_890" rel="nofollow">保存特征</a></li></ul> 
  </li><li><a href="#_904" rel="nofollow">期间报错解决方案汇总</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_3"></a>学习过程</h2> 
<p>20年当时自身功底是比较零基础(会写些基础的Python[三个科学计算包]数据分析)，一开始看这块其实挺懵的，不会就去问百度或其他人，当时遇见困难挺害怕的，但22后面开始力扣题【目前已刷好几轮，博客没写力扣文章之前，力扣排名靠前已刷有5遍左右，排名靠后刷3次左右，代码功底也在一步一步提升】不断地刷、遇见代码不懂的代码，也开始去打印print去理解，到后面问其他人的问题越来越少，个人自主学习、自主解决能力也得到了进一步增强。</p> 
<h2><a id="_5"></a>赛题介绍</h2> 
<p>该赛题是以新闻APP中的新闻推荐为背景， 目的是<strong>要求我们根据用户历史浏览点击新闻文章的数据信息预测用户未来的点击行为， 即用户的最后一次点击的新闻文章</strong>。</p> 
<h2><a id="_8"></a>评价方式理解</h2> 
<p>最后提交的格式是针对每个用户， 我们都会给出五篇文章的推荐结果，按照点击概率从前往后排序。 而真实的每个用户最后一次点击的文章只会有一篇的真实答案， 所以我们就看我们推荐的这五篇里面是否有命中真实答案的。比如对于user1来说， 我们的提交会是：</p> 
<pre><code class="prism language-python">user1<span class="token punctuation">,</span> article1<span class="token punctuation">,</span> article2<span class="token punctuation">,</span> article3<span class="token punctuation">,</span> article4<span class="token punctuation">,</span> article5<span class="token punctuation">.</span>
</code></pre> 
<p>评价指标的公式如下：<br> <img src="https://images2.imgbox.com/d1/da/uq8jKITZ_o.png" alt="在这里插入图片描述"></p> 
<p>假如article1就是真实的用户点击文章，也就是article1命中， 则s(user1,1)=1, s(user1,2-4)都是0， 如果article2是用户点击的文章， 则s(user,2)=1/2,s(user,1,3,4,5)都是0。也就是score(user)=命中第几条的倒数。如果都没中， 则score(user1)=0。 这个是合理的， 因为我们希望的就是命中的结果尽量靠前， 而此时分数正好比较高。</p> 
<h2><a id="_21"></a>赛题理解</h2> 
<p>根据赛题简介，我们首先要明确我们此次比赛的目标： 根据用户历史浏览点击新闻的数据信息预测用户最后一次点击的新闻文章。从这个目标上看， 会发现此次比赛和我们之前遇到的普通的结构化比赛不太一样， 主要有两点：</p> 
<ul><li>首先是目标上， 要预测最后一次点击的新闻文章，也就是我们给用户推荐的是新闻文章， 并不是像之前那种预测一个数或者预测数据哪一类那样的问题</li><li>数据上， 通过给出的数据我们会发现， 这种数据也不是我们之前遇到的那种特征+标签的数据，而是基于了真实的业务场景， 拿到的用户的点击日志</li></ul> 
<p>所以拿到这个题目，我们的思考方向就是结合我们的目标，把该预测问题转成一个监督学习的问题(特征+标签)，然后我们才能进行ML，DL等建模预测。</p> 
<p><img src="https://images2.imgbox.com/bf/90/eyDSPYdW_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="__30"></a>制作特征和标签， 转成监督学习问题</h2> 
<p>我们先捋一下基于原始的给定数据， 有哪些特征可以直接利用：</p> 
<p>文章的自身特征， category_id表示这文章的类型， created_at_ts表示文章建立的时间， 这个关系着文章的时效性， words_count是文章的字数， 一般字数太长我们不太喜欢点击, 也不排除有人就喜欢读长文。<br> 文章的内容embedding特征， 这个召回的时候用过， 这里可以选择使用， 也可以选择不用， 也可以尝试其他类型的embedding特征， 比如W2V等<br> 用户的设备特征信息</p> 
<p>构造监督数据集的思路， 根据召回结果， 我们会得到一个{user_id: [可能点击的文章列表]}形式的字典。 那么我们就可以对于每个用户， 每篇可能点击的文章构造一个监督测试集， 比如对于用户user1， 假设得到的他的召回列表{user1: [item1, item2, item3]}， 我们就可以得到三行数据(user1, item1), (user1, item2), (user1, item3)的形式， 这就是监督测试集时候的前两列特征。</p> 
<p>构造特征的思路是这样， 我们知道每个用户的点击文章是与其历史点击的文章信息是有很大关联的， 比如同一个主题， 相似等等。 所以特征构造这块很重要的一系列特征是要结合用户的历史点击文章信息。我们已经得到了每个用户及点击候选文章的两列的一个数据集， 而我们的目的是要预测最后一次点击的文章， 比较自然的一个思路就是和其最后几次点击的文章产生关系， 这样既考虑了其历史点击文章信息， 又得离最后一次点击较近，因为新闻很大的一个特点就是注重时效性。 往往用户的最后一次点击会和其最后几次点击有很大的关联。 所以我们就可以对于每个候选文章， 做出与最后几次点击相关的特征如下：</p> 
<ul><li>候选item与最后几次点击的相似性特征(embedding内积） — 这个直接关联用户历史行为</li><li>候选item与最后几次点击的相似性特征的统计特征 — 统计特征可以减少一些波动和异常</li><li>候选item与最后几次点击文章的字数差的特征 — 可以通过字数看用户偏好</li><li>候选item与最后几次点击的文章建立的时间差特征 — 时间差特征可以看出该用户对于文章的实时性的偏好</li></ul> 
<p>当然， 上面只是提供了一种基于用户历史行为做特征工程的思路， 大家也可以思维风暴一下，尝试一些其他的特征。 下面我们就实现上面的这些特征的制作， 下面的逻辑是这样：</p> 
<p>我们首先获得用户的最后一次点击操作和用户的历史点击， 这个基于我们的日志数据集做<br> 基于用户的历史行为制作特征， 这个会用到用户的历史点击表， 最后的召回列表， 文章的信息表和embedding向量<br> 制作标签， 形成最后的监督学习数据集</p> 
<h3><a id="_54"></a>导包</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> pickle
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">import</span> gc<span class="token punctuation">,</span> os
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> time
<span class="token comment">#import lightgbm as lgb</span>
<span class="token keyword">from</span> gensim<span class="token punctuation">.</span>models <span class="token keyword">import</span> Word2Vec
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> MinMaxScaler
<span class="token keyword">import</span> warnings
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束导包结束"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="df_73"></a>df节省内存函数</h3> 
<pre><code class="prism language-python"><span class="token comment"># 节省内存的一个函数</span>
<span class="token comment"># 减少内存</span>
<span class="token keyword">def</span> <span class="token function">reduce_mem</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">:</span>
    starttime <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    numerics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'int16'</span><span class="token punctuation">,</span> <span class="token string">'int32'</span><span class="token punctuation">,</span> <span class="token string">'int64'</span><span class="token punctuation">,</span> <span class="token string">'float16'</span><span class="token punctuation">,</span> <span class="token string">'float32'</span><span class="token punctuation">,</span> <span class="token string">'float64'</span><span class="token punctuation">]</span>
    start_mem <span class="token operator">=</span> df<span class="token punctuation">.</span>memory_usage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token operator">**</span><span class="token number">2</span>
    <span class="token keyword">for</span> col <span class="token keyword">in</span> df<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        col_type <span class="token operator">=</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>dtypes
        <span class="token keyword">if</span> col_type <span class="token keyword">in</span> numerics<span class="token punctuation">:</span>
            c_min <span class="token operator">=</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            c_max <span class="token operator">=</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>c_min<span class="token punctuation">)</span> <span class="token keyword">or</span> pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>c_max<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> <span class="token builtin">str</span><span class="token punctuation">(</span>col_type<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'int'</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> c_min <span class="token operator">&gt;</span> np<span class="token punctuation">.</span>iinfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int8<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span> <span class="token keyword">and</span> c_max <span class="token operator">&lt;</span> np<span class="token punctuation">.</span>iinfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int8<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">:</span>
                    df<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int8<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> c_min <span class="token operator">&gt;</span> np<span class="token punctuation">.</span>iinfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int16<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span> <span class="token keyword">and</span> c_max <span class="token operator">&lt;</span> np<span class="token punctuation">.</span>iinfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int16<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">:</span>
                    df<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int16<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> c_min <span class="token operator">&gt;</span> np<span class="token punctuation">.</span>iinfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span> <span class="token keyword">and</span> c_max <span class="token operator">&lt;</span> np<span class="token punctuation">.</span>iinfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">:</span>
                    df<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> c_min <span class="token operator">&gt;</span> np<span class="token punctuation">.</span>iinfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int64<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span> <span class="token keyword">and</span> c_max <span class="token operator">&lt;</span> np<span class="token punctuation">.</span>iinfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int64<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">:</span>
                    df<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> c_min <span class="token operator">&gt;</span> np<span class="token punctuation">.</span>finfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float16<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span> <span class="token keyword">and</span> c_max <span class="token operator">&lt;</span> np<span class="token punctuation">.</span>finfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float16<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">:</span>
                    df<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float16<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> c_min <span class="token operator">&gt;</span> np<span class="token punctuation">.</span>finfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span> <span class="token keyword">and</span> c_max <span class="token operator">&lt;</span> np<span class="token punctuation">.</span>finfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">:</span>
                    df<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    df<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float64<span class="token punctuation">)</span>
    end_mem <span class="token operator">=</span> df<span class="token punctuation">.</span>memory_usage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token operator">**</span><span class="token number">2</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-- Mem. usage decreased to {:5.2f} Mb ({:.1f}% reduction),time spend:{:2.2f} min'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>end_mem<span class="token punctuation">,</span>
                                                                                                           <span class="token number">100</span><span class="token operator">*</span><span class="token punctuation">(</span>start_mem<span class="token operator">-</span>end_mem<span class="token punctuation">)</span><span class="token operator">/</span>start_mem<span class="token punctuation">,</span>
                                                                                                           <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>starttime<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df



<span class="token comment">#data_path = './data_raw/'</span>
<span class="token comment">#save_path = './temp_results/'</span>
data_path <span class="token operator">=</span> <span class="token string">'/data/temp/用户行为预测数据集/'</span> <span class="token comment"># '/home/admin/jupyter/data/' # 天池平台路径</span>
save_path <span class="token operator">=</span> <span class="token string">'results/0227/'</span> <span class="token comment"># '/home/admin/jupyter/temp_results/'  # 天池平台路径</span>
</code></pre> 
<h3><a id="_123"></a>训练和验证集的划分</h3> 
<pre><code class="prism language-python"><span class="token comment"># all_click_df指的是训练集</span>
<span class="token comment"># sample_user_nums 采样作为验证集的用户数量</span>
<span class="token keyword">def</span> <span class="token function">trn_val_split</span><span class="token punctuation">(</span>all_click_df<span class="token punctuation">,</span> sample_user_nums<span class="token punctuation">)</span><span class="token punctuation">:</span>
    all_click <span class="token operator">=</span> all_click_df
    all_user_ids <span class="token operator">=</span> all_click<span class="token punctuation">.</span>user_id<span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># replace=True表示可以重复抽样，反之不可以</span>
    sample_user_ids <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>all_user_ids<span class="token punctuation">,</span> size<span class="token operator">=</span>sample_user_nums<span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> 
    
    click_val <span class="token operator">=</span> all_click<span class="token punctuation">[</span>all_click<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>sample_user_ids<span class="token punctuation">)</span><span class="token punctuation">]</span>
    click_trn <span class="token operator">=</span> all_click<span class="token punctuation">[</span><span class="token operator">~</span>all_click<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>sample_user_ids<span class="token punctuation">)</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 将验证集中的最后一次点击给抽取出来作为答案</span>
    click_val <span class="token operator">=</span> click_val<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    val_ans <span class="token operator">=</span> click_val<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tail<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    click_val <span class="token operator">=</span> click_val<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 去除val_ans中某些用户只有一个点击数据的情况，如果该用户只有一个点击数据，又被分到ans中，</span>
    <span class="token comment"># 那么训练集中就没有这个用户的点击数据，出现用户冷启动问题，给自己模型验证带来麻烦</span>
    val_ans <span class="token operator">=</span> val_ans<span class="token punctuation">[</span>val_ans<span class="token punctuation">.</span>user_id<span class="token punctuation">.</span>isin<span class="token punctuation">(</span>click_val<span class="token punctuation">.</span>user_id<span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># 保证答案中出现的用户再验证集中还有</span>
    click_val <span class="token operator">=</span> click_val<span class="token punctuation">[</span>click_val<span class="token punctuation">.</span>user_id<span class="token punctuation">.</span>isin<span class="token punctuation">(</span>val_ans<span class="token punctuation">.</span>user_id<span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    
    <span class="token keyword">return</span> click_trn<span class="token punctuation">,</span> click_val<span class="token punctuation">,</span> val_ans
</code></pre> 
<h3><a id="_156"></a>获取历史点击和最后一次点击</h3> 
<pre><code class="prism language-python"><span class="token comment"># 获取当前数据的历史点击和最后一次点击</span>
<span class="token keyword">def</span> <span class="token function">get_hist_and_last_click</span><span class="token punctuation">(</span>all_click<span class="token punctuation">)</span><span class="token punctuation">:</span>
    all_click <span class="token operator">=</span> all_click<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    click_last_df <span class="token operator">=</span> all_click<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tail<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># 如果用户只有一个点击，hist为空了，会导致训练的时候这个用户不可见，此时默认泄露一下</span>
    <span class="token keyword">def</span> <span class="token function">hist_func</span><span class="token punctuation">(</span>user_df<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>user_df<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> user_df
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> user_df<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

    click_hist_df <span class="token operator">=</span> all_click<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>hist_func<span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> click_hist_df<span class="token punctuation">,</span> click_last_df
</code></pre> 
<h3><a id="_180"></a>读取训练、验证及测试集</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_trn_val_tst_data</span><span class="token punctuation">(</span>data_path<span class="token punctuation">,</span> offline<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> offline<span class="token punctuation">:</span>
        click_trn_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>data_path<span class="token operator">+</span><span class="token string">'train_click_log.csv'</span><span class="token punctuation">)</span>  <span class="token comment"># 训练集用户点击日志</span>
        click_trn_data <span class="token operator">=</span> reduce_mem<span class="token punctuation">(</span>click_trn_data<span class="token punctuation">)</span>
        click_trn<span class="token punctuation">,</span> click_val<span class="token punctuation">,</span> val_ans <span class="token operator">=</span> trn_val_split<span class="token punctuation">(</span>click_trn_data<span class="token punctuation">,</span> sample_user_nums<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        click_trn <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>data_path<span class="token operator">+</span><span class="token string">'train_click_log.csv'</span><span class="token punctuation">)</span>
        click_trn <span class="token operator">=</span> reduce_mem<span class="token punctuation">(</span>click_trn<span class="token punctuation">)</span>
        click_val <span class="token operator">=</span> <span class="token boolean">None</span>
        val_ans <span class="token operator">=</span> <span class="token boolean">None</span>
    
    click_tst <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>data_path<span class="token operator">+</span><span class="token string">'testA_click_log.csv'</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> click_trn<span class="token punctuation">,</span> click_val<span class="token punctuation">,</span> click_tst<span class="token punctuation">,</span> val_a
</code></pre> 
<h3><a id="_203"></a>读取召回列表</h3> 
<pre><code class="prism language-python"><span class="token comment"># 返回多路召回列表或者单路召回</span>
<span class="token keyword">def</span> <span class="token function">get_recall_list</span><span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> single_recall_model<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> multi_recall<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> multi_recall<span class="token punctuation">:</span>
        <span class="token keyword">return</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'final_recall_items_dict.pkl'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> single_recall_model <span class="token operator">==</span> <span class="token string">'i2i_itemcf'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'itemcf_recall_dict.pkl'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> single_recall_model <span class="token operator">==</span> <span class="token string">'i2i_emb_itemcf'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'itemcf_emb_dict.pkl'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> single_recall_model <span class="token operator">==</span> <span class="token string">'user_cf'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'youtubednn_usercf_dict.pkl'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> single_recall_model <span class="token operator">==</span> <span class="token string">'youtubednn'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'youtube_u2i_dict.pkl'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a9/7f/N980KkQ1_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Embedding_223"></a>读取各种Embedding</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">trian_item_word2vec</span><span class="token punctuation">(</span>click_df<span class="token punctuation">,</span> embed_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> save_name<span class="token operator">=</span><span class="token string">'item_w2v_emb.pkl'</span><span class="token punctuation">,</span> split_char<span class="token operator">=</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    click_df <span class="token operator">=</span> click_df<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token string">'click_timestamp'</span><span class="token punctuation">)</span>
    <span class="token comment"># 只有转换成字符串才可以进行训练</span>
    click_df<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> click_df<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span>
    <span class="token comment"># 转换成句子的形式</span>
    docs <span class="token operator">=</span> click_df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
    docs <span class="token operator">=</span> docs<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 为了方便查看训练的进度，这里设定一个log信息</span>
    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s:%(levelname)s:%(message)s'</span><span class="token punctuation">,</span> level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>

    <span class="token comment"># 这里的参数对训练得到的向量影响也很大,默认负采样为5</span>
    w2v <span class="token operator">=</span> Word2Vec<span class="token punctuation">(</span>docs<span class="token punctuation">,</span> vector_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> sg<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> window<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token number">2020</span><span class="token punctuation">,</span> workers<span class="token operator">=</span><span class="token number">24</span><span class="token punctuation">,</span> min_count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 备注：size 改成 vector_size, iter 改成 epochs</span>
    
    <span class="token comment"># 保存成字典的形式</span>
    item_w2v_emb_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>k<span class="token punctuation">:</span> w2v<span class="token punctuation">.</span>wv<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token keyword">for</span> k <span class="token keyword">in</span> click_df<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>   <span class="token comment"># w2v 改成 w2v.wv</span>
    pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>item_w2v_emb_dict<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'item_w2v_emb.pkl'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> item_w2v_emb_dict



<span class="token comment"># 可以通过字典查询对应的item的Embedding</span>
<span class="token keyword">def</span> <span class="token function">get_embedding</span><span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> all_click_df<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'item_content_emb.pkl'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        item_content_emb_dict <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'item_content_emb.pkl'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'item_content_emb.pkl 文件不存在...'</span><span class="token punctuation">)</span>
        
    <span class="token comment"># w2v Embedding是需要提前训练好的</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'item_w2v_emb.pkl'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        item_w2v_emb_dict <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'item_w2v_emb.pkl'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        item_w2v_emb_dict <span class="token operator">=</span> trian_item_word2vec<span class="token punctuation">(</span>all_click_df<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> item_content_emb_dict<span class="token punctuation">,</span> item_w2v_emb_dict
</code></pre> 
<h3><a id="_263"></a>读取文章信息</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_article_info_df</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    article_info_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>data_path <span class="token operator">+</span> <span class="token string">'articles.csv'</span><span class="token punctuation">)</span>
    article_info_df <span class="token operator">=</span> reduce_mem<span class="token punctuation">(</span>article_info_df<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> article
</code></pre> 
<h3><a id="_275"></a>读取数据</h3> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始读取数据"</span><span class="token punctuation">)</span>
<span class="token comment"># 读取数据</span>
<span class="token comment"># 这里offline的online的区别就是验证集是否为空</span>
click_trn<span class="token punctuation">,</span> click_val<span class="token punctuation">,</span> click_tst<span class="token punctuation">,</span> val_ans <span class="token operator">=</span> get_trn_val_tst_data<span class="token punctuation">(</span>data_path<span class="token punctuation">,</span> offline<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束读取数据"</span><span class="token punctuation">)</span>


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始获取历史点击和最后一次点击"</span><span class="token punctuation">)</span>
click_trn_hist<span class="token punctuation">,</span> click_trn_last <span class="token operator">=</span> get_hist_and_last_click<span class="token punctuation">(</span>click_trn<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束获取历史点击和最后一次点击"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> click_val <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    click_val_hist<span class="token punctuation">,</span> click_val_last <span class="token operator">=</span> click_val<span class="token punctuation">,</span> val_ans
<span class="token keyword">else</span><span class="token punctuation">:</span>
    click_val_hist<span class="token punctuation">,</span> click_val_last <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span>
    
click_tst_hist <span class="token operator">=</span> click_tst

</code></pre> 
<h3><a id="_299"></a>对训练数据做负采样</h3> 
<pre><code class="prism language-python"><span class="token comment"># 将召回列表转换成df的形式</span>
<span class="token keyword">def</span> <span class="token function">recall_dict_2_df</span><span class="token punctuation">(</span>recall_list_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    df_row_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># [user, item, score]</span>
    <span class="token keyword">for</span> user<span class="token punctuation">,</span> recall_list <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>recall_list_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> item<span class="token punctuation">,</span> score <span class="token keyword">in</span> recall_list<span class="token punctuation">:</span>
            df_row_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>user<span class="token punctuation">,</span> item<span class="token punctuation">,</span> score<span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    col_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'sim_item'</span><span class="token punctuation">,</span> <span class="token string">'score'</span><span class="token punctuation">]</span>
    recall_list_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>df_row_list<span class="token punctuation">,</span> columns<span class="token operator">=</span>col_names<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> recall_list_df



<span class="token comment"># 负采样函数，这里可以控制负采样时的比例, 这里给了一个默认的值</span>
<span class="token keyword">def</span> <span class="token function">neg_sample_recall_data</span><span class="token punctuation">(</span>recall_items_df<span class="token punctuation">,</span> sample_rate<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pos_data <span class="token operator">=</span> recall_items_df<span class="token punctuation">[</span>recall_items_df<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">]</span>
    neg_data <span class="token operator">=</span> recall_items_df<span class="token punctuation">[</span>recall_items_df<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'pos_data_num:'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pos_data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'neg_data_num:'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>neg_data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'pos/neg:'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pos_data<span class="token punctuation">)</span><span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>neg_data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 分组采样函数</span>
    <span class="token keyword">def</span> <span class="token function">neg_sample_func</span><span class="token punctuation">(</span>group_df<span class="token punctuation">)</span><span class="token punctuation">:</span>
        neg_num <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>group_df<span class="token punctuation">)</span>
        sample_num <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>neg_num <span class="token operator">*</span> sample_rate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 保证最少有一个</span>
        sample_num <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>sample_num<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment"># 保证最多不超过5个，这里可以根据实际情况进行选择</span>
        <span class="token keyword">return</span> group_df<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>n<span class="token operator">=</span>sample_num<span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 对用户进行负采样，保证所有用户都在采样后的数据中</span>
    neg_data_user_sample <span class="token operator">=</span> neg_data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> group_keys<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>neg_sample_func<span class="token punctuation">)</span>
    <span class="token comment"># 对文章进行负采样，保证所有文章都在采样后的数据中</span>
    neg_data_item_sample <span class="token operator">=</span> neg_data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'sim_item'</span><span class="token punctuation">,</span> group_keys<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>neg_sample_func<span class="token punctuation">)</span>
    
    <span class="token comment"># 将上述两种情况下的采样数据合并</span>
    neg_data_new <span class="token operator">=</span> neg_data_user_sample<span class="token punctuation">.</span>append<span class="token punctuation">(</span>neg_data_item_sample<span class="token punctuation">)</span>
    <span class="token comment"># 由于上述两个操作是分开的，可能将两个相同的数据给重复选择了，所以需要对合并后的数据进行去重</span>
    neg_data_new <span class="token operator">=</span> neg_data_new<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'sim_item'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keep<span class="token operator">=</span><span class="token string">'last'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 将正样本数据合并</span>
    data_new <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>pos_data<span class="token punctuation">,</span> neg_data_new<span class="token punctuation">]</span><span class="token punctuation">,</span> ignore_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> data_new



<span class="token comment"># 召回数据打标签</span>
<span class="token keyword">def</span> <span class="token function">get_rank_label_df</span><span class="token punctuation">(</span>recall_list_df<span class="token punctuation">,</span> label_df<span class="token punctuation">,</span> is_test<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 测试集是没有标签了，为了后面代码同一一些，这里直接给一个负数替代</span>
    <span class="token keyword">if</span> is_test<span class="token punctuation">:</span>
        recall_list_df<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token keyword">return</span> recall_list_df
    
    label_df <span class="token operator">=</span> label_df<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'click_article_id'</span><span class="token punctuation">:</span> <span class="token string">'sim_item'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    recall_list_df_ <span class="token operator">=</span> recall_list_df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>label_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'sim_item'</span><span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> \
                                               how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'sim_item'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    recall_list_df_<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span> <span class="token operator">=</span> recall_list_df_<span class="token punctuation">[</span><span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token number">0.0</span> <span class="token keyword">if</span> np<span class="token punctuation">.</span>isnan<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
    <span class="token keyword">del</span> recall_list_df_<span class="token punctuation">[</span><span class="token string">'click_timestamp'</span><span class="token punctuation">]</span>
    
    <span class="token keyword">return</span> recall_list_df_






<span class="token keyword">def</span> <span class="token function">get_user_recall_item_label_df</span><span class="token punctuation">(</span>click_trn_hist<span class="token punctuation">,</span> click_val_hist<span class="token punctuation">,</span> click_tst_hist<span class="token punctuation">,</span>click_trn_last<span class="token punctuation">,</span> click_val_last<span class="token punctuation">,</span> recall_list_df<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取训练数据的召回列表</span>
    trn_user_items_df <span class="token operator">=</span> recall_list_df<span class="token punctuation">[</span>recall_list_df<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>click_trn_hist<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token comment"># 训练数据打标签</span>
    trn_user_item_label_df <span class="token operator">=</span> get_rank_label_df<span class="token punctuation">(</span>trn_user_items_df<span class="token punctuation">,</span> click_trn_last<span class="token punctuation">,</span> is_test<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练数据负采样</span>
    trn_user_item_label_df <span class="token operator">=</span> neg_sample_recall_data<span class="token punctuation">(</span>trn_user_item_label_df<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> click_val <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        val_user_items_df <span class="token operator">=</span> recall_list_df<span class="token punctuation">[</span>recall_list_df<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>click_val_hist<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        val_user_item_label_df <span class="token operator">=</span> get_rank_label_df<span class="token punctuation">(</span>val_user_items_df<span class="token punctuation">,</span> click_val_last<span class="token punctuation">,</span> is_test<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        val_user_item_label_df <span class="token operator">=</span> neg_sample_recall_data<span class="token punctuation">(</span>val_user_item_label_df<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        val_user_item_label_df <span class="token operator">=</span> <span class="token boolean">None</span>
        
    <span class="token comment"># 测试数据不需要进行负采样，直接对所有的召回商品进行打-1标签</span>
    tst_user_items_df <span class="token operator">=</span> recall_list_df<span class="token punctuation">[</span>recall_list_df<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>click_tst_hist<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    tst_user_item_label_df <span class="token operator">=</span> get_rank_label_df<span class="token punctuation">(</span>tst_user_items_df<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> is_test<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> trn_user_item_label_df<span class="token punctuation">,</span> val_user_item_label_df<span class="token punctuation">,</span> tst_user_item_label_df




<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始读取召回列表"</span><span class="token punctuation">)</span>
<span class="token comment"># 读取召回列表</span>
recall_list_dict <span class="token operator">=</span> get_recall_list<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> single_recall_model<span class="token operator">=</span><span class="token string">'i2i_itemcf'</span><span class="token punctuation">)</span> <span class="token comment"># 这里只选择了单路召回的结果，也可以选择多路召回结果</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束读取召回列表"</span><span class="token punctuation">)</span>


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始将召回数据转换成df"</span><span class="token punctuation">)</span>
<span class="token comment"># 将召回数据转换成df</span>
recall_list_df <span class="token operator">=</span> recall_dict_2_df<span class="token punctuation">(</span>recall_list_dict<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束将召回数据转换成df"</span><span class="token punctuation">)</span>


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"给训练验证数据打标签，并负采样（这一部分时间比较久）"</span><span class="token punctuation">)</span>
<span class="token comment"># 给训练验证数据打标签，并负采样（这一部分时间比较久）</span>
trn_user_item_label_df<span class="token punctuation">,</span> val_user_item_label_df<span class="token punctuation">,</span> tst_user_item_label_df <span class="token operator">=</span> get_user_recall_item_label_df<span class="token punctuation">(</span>click_trn_hist<span class="token punctuation">,</span> 
                                                                                                       click_val_hist<span class="token punctuation">,</span> 
                                                                                                       click_tst_hist<span class="token punctuation">,</span>
                                                                                                       click_trn_last<span class="token punctuation">,</span> 
                                                                                                       click_val_last<span class="token punctuation">,</span> 
                                                                                                       recall_list_df<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"给训练验证数据打标签，并负采样（这一部分时间比较久）"</span><span class="token punctuation">)</span>


<span class="token comment">#trn_user_item_label_df.label</span>
</code></pre> 
<h3><a id="_418"></a>将召回数据转换成字典</h3> 
<pre><code class="prism language-python"><span class="token comment"># 将最终的召回的df数据转换成字典的形式做排序特征</span>
<span class="token keyword">def</span> <span class="token function">make_tuple_func</span><span class="token punctuation">(</span>group_df<span class="token punctuation">)</span><span class="token punctuation">:</span>
    row_data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> name<span class="token punctuation">,</span> row_df <span class="token keyword">in</span> group_df<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        row_data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>row_df<span class="token punctuation">[</span><span class="token string">'sim_item'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row_df<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row_df<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> row_data

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始将召回数据转换成字典"</span><span class="token punctuation">)</span>
trn_user_item_label_tuples <span class="token operator">=</span> trn_user_item_label_df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>make_tuple_func<span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
trn_user_item_label_tuples_dict <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>trn_user_item_label_tuples<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trn_user_item_label_tuples<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> val_user_item_label_df <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    val_user_item_label_tuples <span class="token operator">=</span> val_user_item_label_df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>make_tuple_func<span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
    val_user_item_label_tuples_dict <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>val_user_item_label_tuples<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val_user_item_label_tuples<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    val_user_item_label_tuples_dict <span class="token operator">=</span> <span class="token boolean">None</span>
    
tst_user_item_label_tuples <span class="token operator">=</span> tst_user_item_label_df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>make_tuple_func<span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
tst_user_item_label_tuples_dict <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>tst_user_item_label_tuples<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tst_user_item_label_tuples<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束将召回数据转换成字典"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_449"></a>制作与用户历史行为相关特征</h3> 
<pre><code class="prism language-python"><span class="token comment"># 下面基于data做历史相关的特征</span>
<span class="token keyword">def</span> <span class="token function">create_feature</span><span class="token punctuation">(</span>users_id<span class="token punctuation">,</span> recall_list<span class="token punctuation">,</span> click_hist_df<span class="token punctuation">,</span>  articles_info<span class="token punctuation">,</span> articles_emb<span class="token punctuation">,</span> user_emb<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> N<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    基于用户的历史行为做相关特征
    :param users_id: 用户id
    :param recall_list: 对于每个用户召回的候选文章列表
    :param click_hist_df: 用户的历史点击信息
    :param articles_info: 文章信息
    :param articles_emb: 文章的embedding向量, 这个可以用item_content_emb, item_w2v_emb, item_youtube_emb
    :param user_emb: 用户的embedding向量， 这个是user_youtube_emb, 如果没有也可以不用， 但要注意如果要用的话， articles_emb就要用item_youtube_emb的形式， 这样维度才一样
    :param N: 最近的N次点击  由于testA日志里面很多用户只存在一次历史点击， 所以为了不产生空值，默认是1
    """</span>
    
    <span class="token comment"># 建立一个二维列表保存结果， 后面要转成DataFrame</span>
    all_user_feas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> user_id <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>users_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 该用户的最后N次点击</span>
        hist_user_items <span class="token operator">=</span> click_hist_df<span class="token punctuation">[</span>click_hist_df<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token operator">==</span>user_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span>N<span class="token punctuation">:</span><span class="token punctuation">]</span>
        
        <span class="token comment"># 遍历该用户的召回列表</span>
        <span class="token keyword">for</span> rank<span class="token punctuation">,</span> <span class="token punctuation">(</span>article_id<span class="token punctuation">,</span> score<span class="token punctuation">,</span> label<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>recall_list<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 该文章建立时间, 字数</span>
            a_create_time <span class="token operator">=</span> articles_info<span class="token punctuation">[</span>articles_info<span class="token punctuation">[</span><span class="token string">'article_id'</span><span class="token punctuation">]</span><span class="token operator">==</span>article_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'created_at_ts'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            a_words_count <span class="token operator">=</span> articles_info<span class="token punctuation">[</span>articles_info<span class="token punctuation">[</span><span class="token string">'article_id'</span><span class="token punctuation">]</span><span class="token operator">==</span>article_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'words_count'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            single_user_fea <span class="token operator">=</span> <span class="token punctuation">[</span>user_id<span class="token punctuation">,</span> article_id<span class="token punctuation">]</span>
            <span class="token comment"># 计算与最后点击的商品的相似度的和， 最大值和最小值， 均值</span>
            sim_fea <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            time_fea <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            word_fea <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token comment"># 遍历用户的最后N次点击文章</span>
            <span class="token keyword">for</span> hist_item <span class="token keyword">in</span> hist_user_items<span class="token punctuation">:</span>
                b_create_time <span class="token operator">=</span> articles_info<span class="token punctuation">[</span>articles_info<span class="token punctuation">[</span><span class="token string">'article_id'</span><span class="token punctuation">]</span><span class="token operator">==</span>hist_item<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'created_at_ts'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                b_words_count <span class="token operator">=</span> articles_info<span class="token punctuation">[</span>articles_info<span class="token punctuation">[</span><span class="token string">'article_id'</span><span class="token punctuation">]</span><span class="token operator">==</span>hist_item<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'words_count'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                
                sim_fea<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>articles_emb<span class="token punctuation">[</span>hist_item<span class="token punctuation">]</span><span class="token punctuation">,</span> articles_emb<span class="token punctuation">[</span>article_id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                time_fea<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">(</span>a_create_time<span class="token operator">-</span>b_create_time<span class="token punctuation">)</span><span class="token punctuation">)</span>
                word_fea<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">(</span>a_words_count<span class="token operator">-</span>b_words_count<span class="token punctuation">)</span><span class="token punctuation">)</span>
                
            single_user_fea<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>sim_fea<span class="token punctuation">)</span>      <span class="token comment"># 相似性特征</span>
            single_user_fea<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>time_fea<span class="token punctuation">)</span>    <span class="token comment"># 时间差特征</span>
            single_user_fea<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>word_fea<span class="token punctuation">)</span>    <span class="token comment"># 字数差特征</span>
            single_user_fea<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">max</span><span class="token punctuation">(</span>sim_fea<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>sim_fea<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>sim_fea<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>sim_fea<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sim_fea<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 相似性的统计特征</span>
            
            <span class="token keyword">if</span> user_emb<span class="token punctuation">:</span>  <span class="token comment"># 如果用户向量有的话， 这里计算该召回文章与用户的相似性特征 </span>
                single_user_fea<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>user_emb<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">,</span> articles_emb<span class="token punctuation">[</span>article_id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                
            single_user_fea<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span>score<span class="token punctuation">,</span> rank<span class="token punctuation">,</span> label<span class="token punctuation">]</span><span class="token punctuation">)</span>    
            <span class="token comment"># 加入到总的表中</span>
            all_user_feas<span class="token punctuation">.</span>append<span class="token punctuation">(</span>single_user_fea<span class="token punctuation">)</span>
    
    <span class="token comment"># 定义列名</span>
    id_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">]</span>
    sim_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'sim'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">]</span>
    time_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'time_diff'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">]</span>
    word_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'word_diff'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">]</span>
    sat_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'sim_max'</span><span class="token punctuation">,</span> <span class="token string">'sim_min'</span><span class="token punctuation">,</span> <span class="token string">'sim_sum'</span><span class="token punctuation">,</span> <span class="token string">'sim_mean'</span><span class="token punctuation">]</span>
    user_item_sim_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'user_item_sim'</span><span class="token punctuation">]</span> <span class="token keyword">if</span> user_emb <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    user_score_rank_label <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">,</span> <span class="token string">'rank'</span><span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">]</span>
    cols <span class="token operator">=</span> id_cols <span class="token operator">+</span> sim_cols <span class="token operator">+</span> time_cols <span class="token operator">+</span> word_cols <span class="token operator">+</span> sat_cols <span class="token operator">+</span> user_item_sim_cols <span class="token operator">+</span> user_score_rank_label
            
    <span class="token comment"># 转成DataFrame</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span> all_user_feas<span class="token punctuation">,</span> columns<span class="token operator">=</span>cols<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> df



<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始取文章信息"</span><span class="token punctuation">)</span>
article_info_df <span class="token operator">=</span> get_article_info_df<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束取文章信息"</span><span class="token punctuation">)</span>
all_click <span class="token operator">=</span> click_trn<span class="token punctuation">.</span>append<span class="token punctuation">(</span>click_tst<span class="token punctuation">)</span>


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始可以通过字典查询对应的item的Embedding"</span><span class="token punctuation">)</span>
item_content_emb_dict<span class="token punctuation">,</span> item_w2v_emb_dict <span class="token operator">=</span> get_embedding<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> all_click<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束可以通过字典查询对应的item的Embedding"</span><span class="token punctuation">)</span>


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始制作与用户历史行为相关特征"</span><span class="token punctuation">)</span>
<span class="token comment"># 获取训练验证及测试数据中召回列文章相关特征</span>
trn_user_item_feats_df <span class="token operator">=</span> create_feature<span class="token punctuation">(</span>trn_user_item_label_tuples_dict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> trn_user_item_label_tuples_dict<span class="token punctuation">,</span> \
                                            click_trn_hist<span class="token punctuation">,</span> article_info_df<span class="token punctuation">,</span> item_content_emb_dict<span class="token punctuation">)</span>

<span class="token keyword">if</span> val_user_item_label_tuples_dict <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    val_user_item_feats_df <span class="token operator">=</span> create_feature<span class="token punctuation">(</span>val_user_item_label_tuples_dict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> val_user_item_label_tuples_dict<span class="token punctuation">,</span> \
                                                click_val_hist<span class="token punctuation">,</span> article_info_df<span class="token punctuation">,</span> item_content_emb_dict<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    val_user_item_feats_df <span class="token operator">=</span> <span class="token boolean">None</span>
    
tst_user_item_feats_df <span class="token operator">=</span> create_feature<span class="token punctuation">(</span>tst_user_item_label_tuples_dict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tst_user_item_label_tuples_dict<span class="token punctuation">,</span> \
                                            click_tst_hist<span class="token punctuation">,</span> article_info_df<span class="token punctuation">,</span> item_content_emb_dict<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束制作与用户历史行为相关特征"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_548"></a>用户相关特征</h3> 
<pre><code class="prism language-python">click_tst<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始读取文章特征，df节省内存函数"</span><span class="token punctuation">)</span>
<span class="token comment"># 读取文章特征</span>
articles <span class="token operator">=</span>  pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>data_path<span class="token operator">+</span><span class="token string">'articles.csv'</span><span class="token punctuation">)</span>
articles <span class="token operator">=</span> reduce_mem<span class="token punctuation">(</span>articles<span class="token punctuation">)</span>



<span class="token comment"># 日志数据，就是前面的所有数据</span>
<span class="token keyword">if</span> click_val <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    all_data <span class="token operator">=</span> click_trn<span class="token punctuation">.</span>append<span class="token punctuation">(</span>click_val<span class="token punctuation">)</span>
all_data <span class="token operator">=</span> click_trn<span class="token punctuation">.</span>append<span class="token punctuation">(</span>click_tst<span class="token punctuation">)</span>
all_data <span class="token operator">=</span> reduce_mem<span class="token punctuation">(</span>all_data<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束读取文章特征，df节省内存函数"</span><span class="token punctuation">)</span>



<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始拼上文章信息"</span><span class="token punctuation">)</span>
<span class="token comment"># 拼上文章信息</span>
all_data <span class="token operator">=</span> all_data<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>articles<span class="token punctuation">,</span> left_on<span class="token operator">=</span><span class="token string">'click_article_id'</span><span class="token punctuation">,</span> right_on<span class="token operator">=</span><span class="token string">'article_id'</span><span class="token punctuation">)</span>
<span class="token comment">#all_data.shape</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"all_data.shape："</span><span class="token punctuation">,</span> all_data<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束拼上文章信息"</span><span class="token punctuation">)</span>






<span class="token comment"># 分析一下点击时间和点击文章的次数，区分用户活跃度</span>
<span class="token keyword">def</span> <span class="token function">active_level</span><span class="token punctuation">(</span>all_data<span class="token punctuation">,</span> cols<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    制作区分用户活跃度的特征
    :param all_data: 数据集
    :param cols: 用到的特征列
    """</span>
    data <span class="token operator">=</span> all_data<span class="token punctuation">[</span>cols<span class="token punctuation">]</span>
    data<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    user_act <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> as_index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>\
                            agg<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'click_article_id'</span><span class="token punctuation">:</span>np<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token builtin">list</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_size'</span><span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 计算时间间隔的均值</span>
    <span class="token keyword">def</span> <span class="token function">time_diff_mean</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">1</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">[</span>j<span class="token operator">-</span>i <span class="token keyword">for</span> i<span class="token punctuation">,</span> j <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>l<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> l<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
    user_act<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_act<span class="token punctuation">[</span><span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> time_diff_mean<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 点击次数取倒数</span>
    user_act<span class="token punctuation">[</span><span class="token string">'click_size'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> user_act<span class="token punctuation">[</span><span class="token string">'click_size'</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 两者归一化</span>
    user_act<span class="token punctuation">[</span><span class="token string">'click_size'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>user_act<span class="token punctuation">[</span><span class="token string">'click_size'</span><span class="token punctuation">]</span> <span class="token operator">-</span> user_act<span class="token punctuation">[</span><span class="token string">'click_size'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>user_act<span class="token punctuation">[</span><span class="token string">'click_size'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> user_act<span class="token punctuation">[</span><span class="token string">'click_size'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    user_act<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>user_act<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span> <span class="token operator">-</span> user_act<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>user_act<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> user_act<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     
    user_act<span class="token punctuation">[</span><span class="token string">'active_level'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_act<span class="token punctuation">[</span><span class="token string">'click_size'</span><span class="token punctuation">]</span> <span class="token operator">+</span> user_act<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span>
    
    user_act<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_act<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int'</span><span class="token punctuation">)</span>
    <span class="token keyword">del</span> user_act<span class="token punctuation">[</span><span class="token string">'click_timestamp'</span><span class="token punctuation">]</span>
    
    <span class="token keyword">return</span> user_act

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始分析一下点击时间和点击文章的次数，区分用户活跃度"</span><span class="token punctuation">)</span>
user_act_fea <span class="token operator">=</span> active_level<span class="token punctuation">(</span>all_data<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">#user_act_fea.head()</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"user_act_fea.head(1)："</span><span class="token punctuation">,</span> user_act_fea<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束分析一下点击时间和点击文章的次数，区分用户活跃度"</span><span class="token punctuation">)</span>





<span class="token comment"># 分析一下点击时间和被点击文章的次数， 衡量文章热度特征</span>
<span class="token keyword">def</span> <span class="token function">hot_level</span><span class="token punctuation">(</span>all_data<span class="token punctuation">,</span> cols<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    制作衡量文章热度的特征
    :param all_data: 数据集
    :param cols: 用到的特征列
    """</span>
    data <span class="token operator">=</span> all_data<span class="token punctuation">[</span>cols<span class="token punctuation">]</span>
    data<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    article_hot <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'click_article_id'</span><span class="token punctuation">,</span> as_index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>\
                               agg<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'user_id'</span><span class="token punctuation">:</span>np<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token builtin">list</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'user_num'</span><span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 计算被点击时间间隔的均值</span>
    <span class="token keyword">def</span> <span class="token function">time_diff_mean</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">1</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">[</span>j<span class="token operator">-</span>i <span class="token keyword">for</span> i<span class="token punctuation">,</span> j <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>l<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> l<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
    article_hot<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span> <span class="token operator">=</span> article_hot<span class="token punctuation">[</span><span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> time_diff_mean<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 点击次数取倒数</span>
    article_hot<span class="token punctuation">[</span><span class="token string">'user_num'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> article_hot<span class="token punctuation">[</span><span class="token string">'user_num'</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 两者归一化</span>
    article_hot<span class="token punctuation">[</span><span class="token string">'user_num'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>article_hot<span class="token punctuation">[</span><span class="token string">'user_num'</span><span class="token punctuation">]</span> <span class="token operator">-</span> article_hot<span class="token punctuation">[</span><span class="token string">'user_num'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>article_hot<span class="token punctuation">[</span><span class="token string">'user_num'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> article_hot<span class="token punctuation">[</span><span class="token string">'user_num'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    article_hot<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>article_hot<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span> <span class="token operator">-</span> article_hot<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>article_hot<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> article_hot<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     
    article_hot<span class="token punctuation">[</span><span class="token string">'hot_level'</span><span class="token punctuation">]</span> <span class="token operator">=</span> article_hot<span class="token punctuation">[</span><span class="token string">'user_num'</span><span class="token punctuation">]</span> <span class="token operator">+</span> article_hot<span class="token punctuation">[</span><span class="token string">'time_diff_mean'</span><span class="token punctuation">]</span>
    
    article_hot<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> article_hot<span class="token punctuation">[</span><span class="token string">'click_article_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int'</span><span class="token punctuation">)</span>
    
    <span class="token keyword">del</span> article_hot<span class="token punctuation">[</span><span class="token string">'click_timestamp'</span><span class="token punctuation">]</span>
    
    <span class="token keyword">return</span> article_hot



<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始分析一下点击时间和被点击文章的次数， 衡量文章热度特征"</span><span class="token punctuation">)</span>
article_hot_fea <span class="token operator">=</span> hot_level<span class="token punctuation">(</span>all_data<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_article_id'</span><span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
<span class="token comment"># article_hot_fea.head()</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"article_hot_fea.head(1)："</span><span class="token punctuation">,</span> article_hot_fea<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束分析一下点击时间和被点击文章的次数， 衡量文章热度特征"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_670"></a>用户的设备习惯</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">device_fea</span><span class="token punctuation">(</span>all_data<span class="token punctuation">,</span> cols<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    制作用户的设备特征
    :param all_data: 数据集
    :param cols: 用到的特征列
    """</span>
    user_device_info <span class="token operator">=</span> all_data<span class="token punctuation">[</span>cols<span class="token punctuation">]</span>
    
    <span class="token comment"># 用众数来表示每个用户的设备信息</span>
    user_device_info <span class="token operator">=</span> user_device_info<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> user_device_info


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始用户的设备习惯"</span><span class="token punctuation">)</span>
<span class="token comment"># 设备特征(这里时间会比较长)</span>
device_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_environment'</span><span class="token punctuation">,</span> <span class="token string">'click_deviceGroup'</span><span class="token punctuation">,</span> <span class="token string">'click_os'</span><span class="token punctuation">,</span> <span class="token string">'click_country'</span><span class="token punctuation">,</span> <span class="token string">'click_region'</span><span class="token punctuation">,</span> <span class="token string">'click_referrer_type'</span><span class="token punctuation">]</span>
user_device_info <span class="token operator">=</span> device_fea<span class="token punctuation">(</span>all_data<span class="token punctuation">,</span> device_cols<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"user_device_info.head(1)："</span><span class="token punctuation">,</span> user_device_info<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束用户的设备习惯"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_696"></a>用户的时间习惯</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">user_time_hob_fea</span><span class="token punctuation">(</span>all_data<span class="token punctuation">,</span> cols<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    制作用户的时间习惯特征
    :param all_data: 数据集
    :param cols: 用到的特征列
    """</span>
    user_time_hob_info <span class="token operator">=</span> all_data<span class="token punctuation">[</span>cols<span class="token punctuation">]</span>
    
    <span class="token comment"># 先把时间戳进行归一化</span>
    mm <span class="token operator">=</span> MinMaxScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
    user_time_hob_info<span class="token punctuation">[</span><span class="token string">'click_timestamp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> mm<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>user_time_hob_info<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'click_timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    user_time_hob_info<span class="token punctuation">[</span><span class="token string">'created_at_ts'</span><span class="token punctuation">]</span> <span class="token operator">=</span> mm<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>user_time_hob_info<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'created_at_ts'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    user_time_hob_info <span class="token operator">=</span> user_time_hob_info<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span><span class="token string">'mean'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    user_time_hob_info<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'click_timestamp'</span><span class="token punctuation">:</span> <span class="token string">'user_time_hob1'</span><span class="token punctuation">,</span> <span class="token string">'created_at_ts'</span><span class="token punctuation">:</span> <span class="token string">'user_time_hob2'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> user_time_hob_info


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始用户的时间习惯"</span><span class="token punctuation">)</span>
user_time_hob_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'click_timestamp'</span><span class="token punctuation">,</span> <span class="token string">'created_at_ts'</span><span class="token punctuation">]</span>
user_time_hob_info <span class="token operator">=</span> user_time_hob_fea<span class="token punctuation">(</span>all_data<span class="token punctuation">,</span> user_time_hob_cols<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"user_time_hob_info.head(1)："</span><span class="token punctuation">,</span> user_time_hob_info<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束用户的时间习惯"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_727"></a>用户的主题爱好</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">user_cat_hob_fea</span><span class="token punctuation">(</span>all_data<span class="token punctuation">,</span> cols<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    用户的主题爱好
    :param all_data: 数据集
    :param cols: 用到的特征列
    """</span>
    user_category_hob_info <span class="token operator">=</span> all_data<span class="token punctuation">[</span>cols<span class="token punctuation">]</span>
    user_category_hob_info <span class="token operator">=</span> user_category_hob_info<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token builtin">list</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    user_cat_hob_info <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
    user_cat_hob_info<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_category_hob_info<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span>
    user_cat_hob_info<span class="token punctuation">[</span><span class="token string">'cate_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_category_hob_info<span class="token punctuation">[</span><span class="token string">'category_id'</span><span class="token punctuation">]</span>
    
    <span class="token keyword">return</span> user_cat_hob_info


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始用户的主题爱好"</span><span class="token punctuation">)</span>
user_category_hob_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> <span class="token string">'category_id'</span><span class="token punctuation">]</span>
user_cat_hob_info <span class="token operator">=</span> user_cat_hob_fea<span class="token punctuation">(</span>all_data<span class="token punctuation">,</span> user_category_hob_cols<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"user_cat_hob_info.head(1)："</span><span class="token punctuation">,</span> user_cat_hob_info<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束用户的主题爱好"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_753"></a>用户的字数偏好特征</h3> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始用户的字数偏好特征"</span><span class="token punctuation">)</span>
<span class="token comment"># 用户的字数偏好特征</span>
user_wcou_info <span class="token operator">=</span> all_data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'words_count'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span><span class="token string">'mean'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
user_wcou_info<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'words_count'</span><span class="token punctuation">:</span> <span class="token string">'words_hbo'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"user_wcou_info.head(1)："</span><span class="token punctuation">,</span> user_wcou_info<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束用户的字数偏好特征"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_767"></a>用户的信息特征合并保存</h3> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始用户的信息特征合并保存"</span><span class="token punctuation">)</span>
<span class="token comment"># 用户的信息特征合并保存</span>
<span class="token comment"># 所有表进行合并</span>
user_info <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>user_act_fea<span class="token punctuation">,</span> user_device_info<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'user_id'</span><span class="token punctuation">)</span>
user_info <span class="token operator">=</span> user_info<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>user_time_hob_info<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'user_id'</span><span class="token punctuation">)</span>
user_info <span class="token operator">=</span> user_info<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>user_cat_hob_info<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'user_id'</span><span class="token punctuation">)</span>
user_info <span class="token operator">=</span> user_info<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>user_wcou_info<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'user_id'</span><span class="token punctuation">)</span>


<span class="token comment"># 这样用户特征以后就可以直接读取了</span>
user_info<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'user_info.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>   
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"user_info.head(1)："</span><span class="token punctuation">,</span> user_info<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束用户的信息特征合并保存"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_789"></a>用户特征直接读入</h3> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始用户特征直接读入"</span><span class="token punctuation">)</span>
<span class="token comment">## 用户特征直接读入</span>
<span class="token comment"># 把用户信息直接读入进来</span>
user_info <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'user_info.csv'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'trn_user_item_feats_df.csv'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    trn_user_item_feats_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'trn_user_item_feats_df.csv'</span><span class="token punctuation">)</span>
    
<span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'tst_user_item_feats_df.csv'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    tst_user_item_feats_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'tst_user_item_feats_df.csv'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'val_user_item_feats_df.csv'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    val_user_item_feats_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'val_user_item_feats_df.csv'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    val_user_item_feats_df <span class="token operator">=</span> <span class="token boolean">None</span>



<span class="token comment"># 拼上用户特征</span>
<span class="token comment"># 下面是线下验证的</span>
trn_user_item_feats_df <span class="token operator">=</span> trn_user_item_feats_df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>user_info<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> val_user_item_feats_df <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    val_user_item_feats_df <span class="token operator">=</span> val_user_item_feats_df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>user_info<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    val_user_item_feats_df <span class="token operator">=</span> <span class="token boolean">None</span>
    
tst_user_item_feats_df <span class="token operator">=</span> tst_user_item_feats_df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>user_info<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'user_id'</span><span class="token punctuation">,</span>how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span>



trn_user_item_feats_df<span class="token punctuation">.</span>columns
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"trn_user_item_feats_df.columns:"</span><span class="token punctuation">,</span> trn_user_item_feats_df<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束用户特征直接读入"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_831"></a>文章的特征直接读入</h3> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始文章的特征直接读入"</span><span class="token punctuation">)</span>
<span class="token comment">## 文章的特征直接读入</span>
articles <span class="token operator">=</span>  pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>data_path<span class="token operator">+</span><span class="token string">'articles.csv'</span><span class="token punctuation">)</span>
articles <span class="token operator">=</span> reduce_mem<span class="token punctuation">(</span>articles<span class="token punctuation">)</span>


<span class="token comment"># 拼上文章特征</span>
trn_user_item_feats_df <span class="token operator">=</span> trn_user_item_feats_df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>articles<span class="token punctuation">,</span> left_on<span class="token operator">=</span><span class="token string">'click_article_id'</span><span class="token punctuation">,</span> right_on<span class="token operator">=</span><span class="token string">'article_id'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> val_user_item_feats_df <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    val_user_item_feats_df <span class="token operator">=</span> val_user_item_feats_df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>articles<span class="token punctuation">,</span> left_on<span class="token operator">=</span><span class="token string">'click_article_id'</span><span class="token punctuation">,</span> right_on<span class="token operator">=</span><span class="token string">'article_id'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    val_user_item_feats_df <span class="token operator">=</span> <span class="token boolean">None</span>

tst_user_item_feats_df <span class="token operator">=</span> tst_user_item_feats_df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>articles<span class="token punctuation">,</span> left_on<span class="token operator">=</span><span class="token string">'click_article_id'</span><span class="token punctuation">,</span> right_on<span class="token operator">=</span><span class="token string">'article_id'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"tst_user_item_feats_df.head(1)："</span><span class="token punctuation">,</span> tst_user_item_feats_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束文章的特征直接读入"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_854"></a>召回文章的主题是否在用户的爱好里面</h3> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始召回文章的主题是否在用户的爱好里面"</span><span class="token punctuation">)</span>
<span class="token comment">## 召回文章的主题是否在用户的爱好里面</span>
trn_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'is_cat_hab'</span><span class="token punctuation">]</span> <span class="token operator">=</span> trn_user_item_feats_df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token keyword">if</span> x<span class="token punctuation">.</span>category_id <span class="token keyword">in</span> <span class="token builtin">set</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>cate_list<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> val_user_item_feats_df <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    val_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'is_cat_hab'</span><span class="token punctuation">]</span> <span class="token operator">=</span> val_user_item_feats_df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token keyword">if</span> x<span class="token punctuation">.</span>category_id <span class="token keyword">in</span> <span class="token builtin">set</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>cate_list<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    val_user_item_feats_df <span class="token operator">=</span> <span class="token boolean">None</span>
tst_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'is_cat_hab'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tst_user_item_feats_df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token keyword">if</span> x<span class="token punctuation">.</span>category_id <span class="token keyword">in</span> <span class="token builtin">set</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>cate_list<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"tst_user_item_feats_df.head(1)："</span><span class="token punctuation">,</span> tst_user_item_feats_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment"># 线下验证</span>
<span class="token keyword">del</span> trn_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'cate_list'</span><span class="token punctuation">]</span>

<span class="token keyword">if</span> val_user_item_feats_df <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">del</span> val_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'cate_list'</span><span class="token punctuation">]</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    val_user_item_feats_df <span class="token operator">=</span> <span class="token boolean">None</span>
    
<span class="token keyword">del</span> tst_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'cate_list'</span><span class="token punctuation">]</span>

<span class="token keyword">del</span> trn_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'article_id'</span><span class="token punctuation">]</span>

<span class="token keyword">if</span> val_user_item_feats_df <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">del</span> val_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'article_id'</span><span class="token punctuation">]</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    val_user_item_feats_df <span class="token operator">=</span> <span class="token boolean">None</span>
    
<span class="token keyword">del</span> tst_user_item_feats_df<span class="token punctuation">[</span><span class="token string">'article_id'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束召回文章的主题是否在用户的爱好里面"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_890"></a>保存特征</h3> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始保存特征"</span><span class="token punctuation">)</span>
<span class="token comment">## 保存特征</span>
<span class="token comment"># 训练验证特征</span>
trn_user_item_feats_df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'trn_user_item_feats_df.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"trn_user_item_feats_df.head(1)："</span><span class="token punctuation">,</span> trn_user_item_feats_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> val_user_item_feats_df <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    val_user_item_feats_df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'val_user_item_feats_df.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
tst_user_item_feats_df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>save_path <span class="token operator">+</span> <span class="token string">'tst_user_item_feats_df.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"tst_user_item_feats_df.head(1)："</span><span class="token punctuation">,</span> tst_user_item_feats_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束保存特征"</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_904"></a>期间报错解决方案汇总</h2> 
<p><a href="https://blog.csdn.net/weixin_42504788/article/details/136285206">字典不能用to_pickle存储数据，得用dump存储数据</a><br> <a href="https://blog.csdn.net/weixin_42504788/article/details/136486854">w2v参数报错_TypeError: init() got an unexpected keyword argument ‘size‘</a></p> 
<p>比赛源自：阿里云天池大赛 - 零基础入门推荐系统 - 新闻推荐</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e1bf078a7b0aadaa45906b8419baa148/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">论文阅读_参数微调_P-tuning_v2</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/285dfc47ebcf2cb7efc612f9b6c10183/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">论文阅读——SpectralGPT</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>