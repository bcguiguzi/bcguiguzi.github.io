<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql慢查询 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql慢查询" />
<meta property="og:description" content="一、sql慢查询介绍 SQL慢查询定义:
慢查询就是那些执行慢的sql语句，包括crud（创建（Create）、更新（Update）、读取（Read）和删除（Delete）操作），一般是查询，所以称为慢查询。
如何查看哪些sql是慢查询：
开启慢查询⽇志，可以让MySQL记录下查询超过指定时间的语句，通过定位分析性能的瓶颈，才能更好的优化数 据库系统的性能。
顾名思义，慢查询⽇志中记录的是执⾏时间较⻓的query，也就是我们常说的slowquery，通过 设–log-slow-queries[=file_name]来打开该功能并设置记录位置和⽂件名。
慢查询⽇志采⽤的是简单的⽂本格式，可以通过各种⽂本编辑器查看其中的内容。
其中记录了语句执⾏的时刻，执 ⾏所消耗的时间，执⾏⽤户，连接主机等相关信息。
MySQL 还提供了专⻔⽤来分析满查询⽇志的⼯具程序 mysqlslowdump，⽤来帮助数据库管理⼈员解决可能存在的性能问题。
二、配置Mysql慢查询 2.1 查看慢查询相关参数 查询慢查询的开启状态及日志位置
mysql&gt; show variables like &#39;slow_query%&#39;; &#43;---------------------&#43;-------------------------------------------------&#43; | Variable_name | Value | &#43;---------------------&#43;-------------------------------------------------&#43; | slow_query_log | OFF | | slow_query_log_file | /var/lib/mysql/iz2ze2w3v37sit3vf71kuez-slow.log | &#43;---------------------&#43;-------------------------------------------------&#43; 2 rows in set (0.00 sec) slow_query_log 慢查询开启状态
slow_query_log_file 慢查询⽇志存放的位置
（这个⽬录需要MySQL的运⾏帐号的可写权限，⼀般设置为MySQL的 数据存放⽬录）
查询慢查询时长
long_query_time 查询超过多少秒才记录，默认为10秒
mysql&gt; show variables like &#39;long_query_time&#39;; &#43;-----------------&#43;-----------&#43; | Variable_name | Value | &#43;-----------------&#43;-----------&#43; | long_query_time | 10." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/990f6ca8d57c28c446f635f2caa0bbbf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-29T14:06:57+08:00" />
<meta property="article:modified_time" content="2022-09-29T14:06:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql慢查询</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>一、sql慢查询介绍</h2> 
<p><strong>SQL慢查询定义:</strong></p> 
<p>慢查询就是那些执行慢的<a href="https://so.csdn.net/so/search?q=sql%E8%AF%AD%E5%8F%A5&amp;spm=1001.2101.3001.7020" title="sql语句">sql语句</a>，包括crud（创建（Create）、更新（Update）、读取（Read）和删除（Delete）操作），<strong>一般是查询，所以称为慢查询</strong>。</p> 
<p><strong>如何查看哪些sql是慢查询：</strong></p> 
<p>开启慢查询⽇志，可以让MySQL记录下查询超过指定时间的语句，通过定位分析性能的瓶颈，才能更好的优化数 据库系统的性能。</p> 
<p>顾名思义，慢查询⽇志中记录的是执⾏时间较⻓的query，也就是我们常说的slowquery，通过 设–log-slow-queries[=file_name]来打开该功能并设置记录位置和⽂件名。</p> 
<p>慢查询⽇志采⽤的是简单的⽂本格式，可以通过各种⽂本编辑器查看其中的内容。</p> 
<p>其中记录了语句执⾏的时刻，执 ⾏所消耗的时间，执⾏⽤户，连接主机等相关信息。</p> 
<p>MySQL 还提供了专⻔⽤来分析满查询⽇志的⼯具程序<span style="color:#be191c;"><strong> mysqlslowdump</strong></span>，⽤来帮助数据库管理⼈员解决可能存在的性能问题。</p> 
<p></p> 
<h2>二、配置Mysql慢查询</h2> 
<h3>2.1 查看慢查询相关参数</h3> 
<p><strong>查询慢查询的开启状态及日志位置</strong></p> 
<pre><code class="language-sql">mysql&gt; show variables like 'slow_query%';
+---------------------+-------------------------------------------------+
| Variable_name       | Value                                           |
+---------------------+-------------------------------------------------+
| slow_query_log      | OFF                                             |
| slow_query_log_file | /var/lib/mysql/iz2ze2w3v37sit3vf71kuez-slow.log |
+---------------------+-------------------------------------------------+
2 rows in set (0.00 sec)
</code></pre> 
<p>slow_query_log 慢查询开启状态</p> 
<p>slow_query_log_file 慢查询⽇志存放的位置</p> 
<p>（这个⽬录需要MySQL的运⾏帐号的可写权限，⼀般设置为MySQL的 数据存放⽬录）</p> 
<p></p> 
<p><strong>查询慢查询时长</strong></p> 
<p>long_query_time 查询超过多少秒才记录，默认为10秒</p> 
<pre><code class="language-sql">mysql&gt; show variables like 'long_query_time';
+-----------------+-----------+
| Variable_name   | Value     |
+-----------------+-----------+
| long_query_time | 10.000000 |
+-----------------+-----------+
1 row in set (0.00 sec)</code></pre> 
<h2></h2> 
<h2>2.2  配置Mysql慢查询</h2> 
<p></p> 
<p>修改mysql慢查询，2种方式:</p> 
<p>一种是修改配置文件（永久修改），一种是通过命令临时修改（重启数据库后就失效了）。</p> 
<p></p> 
<h3>2.1 使⽤命令临时修改MySQL慢查询</h3> 
<p>修改慢查询配置</p> 
<p>修改开启状态配置</p> 
<p></p> 
<pre><code class="language-sql">一、先查看开启状态
mysql&gt; show variables like 'slow_query%';


二、将 slow_query_log 全局变量设置为“ON”/OFF状态 
mysql&gt; set global slow_query_log='ON';

三、修改完成后，查看开启状态
mysql&gt; show variables like 'slow_query%';


设置慢查询⽇志存放的位置
mysql&gt; set global slow_query_log_file='/op/slow.log/';
</code></pre> 
<p>修改慢查询时长配置</p> 
<pre><code class="language-sql">一、查询时长
mysql&gt; show variables like 'long_query_time';

二、修改时长，查询超过1秒就记录 
mysql&gt; set global long_query_time=1;

三、查看时长
mysql&gt; show variables like 'long_query_time';</code></pre> 
<p></p> 
<p>注意：</p> 
<p>修改时长后，在当前窗口，再次查看时长，发现没有变化。</p> 
<p>直接修改global 的long_query_time 之后在当前的的窗口中是没有效果的，修改之后，在新打开的窗口中才会有效果或者先关闭数据库连接，再重新连接，再次查询就可以看到实际上是修改了的。</p> 
<p>如果想让本窗口也有效果 的话，不用加 global关键字。</p> 
<p></p> 
<pre><code class="language-sql">退出数据库
mysql&gt; quit

再次连接数据库
mysql -u root -p
密码 12345678

再次查询时长，此时时长就变了
mysql&gt; show variables like 'long_query_time';
</code></pre> 
<p>我们通过命令设置，都属于临时修改，重启数据库后，就恢复默认值了。</p> 
<pre><code class="language-sql">查看当前值
mysql&gt; show variables like 'slow_query%';
mysql&gt; show variables like 'long_query_time';

重启数据库
service mysqld restart

重启成功后，再次查看，发现恢复默认值
mysql&gt; show variables like 'slow_query%';
mysql&gt; show variables like 'long_query_time';</code></pre> 
<h3>2.2 通过修改配置文件修改MySQL慢查询</h3> 
<p>（Windows是my.ini，Linux是my.conf）</p> 
<p>mysql 配置文件为my.cnf，默认路径/etc/my.cnf</p> 
<p>使用find / -name my.cnf 查找文件路径</p> 
<p></p> 
<pre><code class="language-bash">Linux: 
在mysql配置⽂件my.cnf中增加： 


[mysqld] 
slow_query_log = ON
slow_query_log_file = /opt/logs/slow.log 
long_query_time=2</code></pre> 
<p></p> 
<p>在/etc/my.cnf修改配置后，不会立即生效，只有重启mysql后才会生效。</p> 
<p></p> 
<pre><code>重启
[root@iz2ze2w3v37sit3vf71kuez ~]# service mysqld restart</code></pre> 
<p></p> 
<h2>3.Mysqlslowdump介绍</h2> 
<p></p> 
<p>MySQL 还提供了专⻔⽤来分析满查询⽇志的⼯具程序 mysqlslowdump，⽤来帮助数据库管理⼈员解决可能存在的性能问题。</p> 
<p>查看帮助说明</p> 
<pre><code>[root@iz2ze2w3v37sit3vf71kuez ~]# mysqldumpslow -h
Option h requires an argument
ERROR: bad option

Usage: mysqldumpslow [ OPTS... ] [ LOGS... ]

Parse and summarize the MySQL slow query log. Options are

  --verbose    verbose
  --debug      debug</code></pre> 
<p></p> 
<pre><code>-s, 是表示按照何种方式排序，
c: 访问计数
l: 锁定时间
r: 返回记录
t: 查询时间
al:平均锁定时间
ar:平均返回记录数
at:平均查询时间

-t, 是top n的意思，即为返回前面多少条的数据；
-g, 后边可以写一个正则匹配模式，大小写不敏感的；
</code></pre> 
<p></p> 
<p><strong>举栗子，Mysqldumpslow命令</strong></p> 
<pre><code>mysqldumpslow -s c -t 10 /database/mysql/slow-log 
#这会输出记录次数最多的10条SQL语句，其中：

-s, 是表示按照何种⽅式排序，c、t、l、r分别是按照记录次数、时间、查询时间、返回的记录数来排序，ac、at、 al、ar，表示相应的倒叙
-t, 是top n的意思，即为返回前⾯多少条的数据；
-g, 后边可以写⼀个正则匹配模式，⼤⼩写不敏感的；

得到返回记录集最多的10个SQL。
mysqldumpslow -s r -t 10 /database/mysql/mysql06_slow.log

得到访问次数最多的10个SQL
mysqldumpslow -s c -t 10 /database/mysql/mysql06_slow.log

得到按照时间排序的前10条里面含有左连接的查询语句。
mysqldumpslow -s t -t 10 -g “left join” /database/mysql/mysql06_slow.log
另外建议在使用这些命令时结合 | 和more 使用 ，否则有可能出现刷屏的情况。
mysqldumpslow -s r -t 20 /mysqldata/mysql/mysql06-slow.log | more

</code></pre> 
<p></p> 
<p>假如真正的sql语句如下：</p> 
<p>SELECT * FROM sms_send WHERE service_id=10 GROUP BY content LIMIT 0, 1000;</p> 
<p></p> 
<p>mysqldumpslow显示的结果会是：</p> 
<p>Count: 1 Time=1.91s (1s) Lock=0.00s (0s) Rows=1000.0 (1000), vgos_dba[vgos_dba]@[10.130.229.196]</p> 
<p><strong><span style="color:#be191c;">SELECT * FROM sms_send WHERE service_id=N GROUP BY content LIMIT N, N;</span></strong></p> 
<p><strong>注意，结果显示的不是某个具体的sql语句，而是这一类型的sql语句。</strong></p> 
<p>在我服务器，上传了一份慢查询日志，/opt/slow.log</p> 
<pre><code>访问计数,前10条
[root@iz2ze2w3v37sit3vf71kuez opt]# mysqldumpslow -s c -t 10 /opt/slow.log

Reading mysql slow query log from /opt/slow.log
Count: 2  Time=2.46s (4s)  Lock=0.00s (0s)  Rows=19.0 (38), root[root]@[39.105.54.6]
  # Rows_affected: N
  SET timestamp=N;
  SELECT wp_posts.* FROM wp_posts WHERE ID IN (N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N)

Count: 2  Time=2.28s (4s)  Lock=0.00s (0s)  Rows=20.0 (40), root[root]@[39.105.54.6]
  # Rows_affected: N
  SET timestamp=N;
  SELECT wp_posts.* FROM wp_posts WHERE ID IN (N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N)
</code></pre> 
<p></p> 
<p>解释：</p> 
<p></p> 
<pre><code>Count: 2  Time=2.28s (4s)  Lock=0.00s (0s)  Rows=20.0 (40), root[root]@[39.105.54.6]

Count会告诉我们这种类型的语句执行了几次，告诉我们执行了2次
Time会告诉我们这种类型的语句执行的最大时间，Time=2.28s (4s)中（4s）是指这类型的语句执行总共花费的时间，最大时间是2.28s，总共花费时间4s
lock时间0s
单次返回的结果数是20条记录</code></pre> 
<p><span style="color:#be191c;"><strong>注意：sql调优，优先解决的不是耗时最长的sql语句，而是执行次数最多的sql语句。</strong></span></p> 
<p></p> 
<p></p> 
<h2>分析语句 explain</h2> 
<p>前⾯分析出了具体是哪⼀条SQL导致的查询速度过慢，那么我们该如何针对这些占⽤资源严重的SQL来进⼀步的分 析呢？？答案就是使⽤explain</p> 
<p></p> 
<p>Explain :该命令是查看查询优化器如何决定执⾏查询的主要⽅法，这个功能有局限性，只是⼀个近似结果，有时它 是⼀个很好的近似，有时可能相差甚远。</p> 
<p>但它的输出是可以获取的最准确信息，值得仔细学习。使⽤⽅法如下：</p> 
<p></p> 
<p><span style="color:#be191c;"><strong>这个以后再学习吧，现阶段有点吃力</strong></span></p> 
<p></p> 
<h2>数据查询逻辑</h2> 
<p><strong><span style="color:#be191c;">这个以后再学习吧，现阶段有点吃力</span></strong></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/935ac77b4397b2e00aaca85249434de2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">移动端布局之postcss-px-to-viewport</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/46fe2230e3de07abf1c06045292fa05d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">《lwip学习6》-- ARP协议</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>