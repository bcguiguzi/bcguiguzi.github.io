<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>分布式事务实现方案 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="分布式事务实现方案" />
<meta property="og:description" content="分布式事务 1.基础概念1.1.什么是事务1.2.本地事务1.3.分布式事务1.4 分布式事务产生的场景 2.分布式事务基础理论2.1.CAP理论2.1.1.理解CAP2.1.2.CAP组合方式2.1.3 总结 2.2.BASE理论 3.分布式事务解决方案之2PC(两阶段提交)3.1.什么是2PC3.2.解决方案3.2.1 XA方案3.2.2 Seata方案 3.3.seata实现2PC事务3.3.1.业务说明3.3.2.程序组成部分3.3.3.创建数据库3.3.4.启动TC(事务协调器)3.3.5 discover-server3.3.6 Seata执行流程3.3.7 导入案例工程dtx-seata-demo3.3.8 dtx-seata-demo-bank13.3.9 dtx-seata-demo-bank23.3.10 测试场景3.4.小结 4.分布式事务解决方案之TCC4.1.什么是TCC事务4.2.TCC 解决方案4.3.Hmily实现TCC事务4.3.1.业务说明4.3.2.程序组成部分4.3.3.创建数据库4.3.4 discover-server4.3.5 导入案例工程dtx-tcc-demo4.3.6 dtx-tcc-demo-bank14.3.7 dtx-tcc-demo-bank24.3.8 测试场景 4.4.小结 5.分布式事务解决方案之可靠消息最终一致性5.1.什么是可靠消息最终一致性事务5.2.解决方案5.2.1.本地消息表方案5.2.2.RocketMQ事务消息方案 5.3.RocketMQ实现可靠消息最终一致性事务5.3.1.业务说明5.3.2.程序组成部分5.3.3.创建数据库5.3.4.启动RocketMQ5.3.5 导入dtx-txmsg-demo5.3.6 消息发送发：dtx-txmsg-demo-bank15.3.7 消息消费者：dtx-txmsg-demo-bank25.3.8 测试场景 5.4.小结 6.分布式事务解决方案之最大努力通知6.1.什么是最大努力通知6.2.解决方案6.3.RocketMQ实现最大努力通知型事务6.3.1.业务说明6.3.2.程序组成部分6.3.3.创建数据库6.3.4.启动RocketMQ6.3.5 discover-server6.3.6 导入dtx-notifymsg-demo6.3.7 消息发送方：dtx-notifydemo-pay6.3.8 消息接收方：dtx-notifydemo-bank16.3.9 测试场景 6.4.小结 7.分布式事务综合案例分析7.1.系统介绍7.1.1.P2P介绍7.1.2.总体业务流程7.1.2.业务术语7.1.2.模块说明 7.2.注册账号案例分析7.2.1.业务流程7.2.2.解决方案分析 7.3.存管开户7.3.1.业务流程7.3.2.解决方案分析 7.4.满标审核7.4.1.业务流程7.4.2.解决方案分析 8.课程总结重点知识回顾:分布式事务对比分析:总结： 1.基础概念 1.1.什么是事务 什么是事务？举个生活中的例子：你去小卖铺买东西，“一手交钱，一手交货”就是一个事务的例子，交钱和交货必须全部成功，事务才算成功，任一个活动失败，事务将撤销所有已成功的活动。
明白上述例子，再来看事务的定义：
事务可以看做是一次大的活动，它由不同的小活动组成，这些活动要么全部成功，要么全部失败。
1.2.本地事务 在计算机系统中，更多的是通过关系型数据库来控制事务，这是利用数据库本身的事务特性来实现的，因此叫数据库事务，由于应用主要靠关系数据库来控制事务，而数据库通常和应用在同一个服务器，所以基于关系型数据库的事务又被称为本地事务。 回顾一下数据库事务的四大特性 ACID：
A（Atomic）：原子性，构成事务的所有操作，要么都执行完成，要么全部不执行，不可能出现部分成功部分失败的情况。C（Consistency）：一致性，在事务执行前后，数据库的一致性约束没有被破坏。比如：张三向李四转100元，转账前和转账后的数据是正确状态这叫一致性，如果出现张三转出100元，李四账户没有增加100元这就出现了数据错误，就没有达到一致性。I（Isolation）：隔离性，数据库中的事务一般都是并发的，隔离性是指并发的两个事务的执行互不干扰，一个事务不能看到其他事务运行过程的中间状态。通过配置事务隔离级别可以避脏读、重复读等问题。D（Durability）：持久性，事务完成之后，该事务对数据的更改会被持久化到数据库，且不会被回滚。 数据库事务在实现时会将一次事务涉及的所有操作全部纳入到一个不可分割的执行单元，该执行单元中的所有操作要么都成功，要么都失败，只要其中任一操作执行失败，都将导致整个事务的回滚
1.3.分布式事务 随着互联网的快速发展，软件系统由原来的单体应用转变为分布式应用，下图描述了单体应用向微服务的演变：
![image.png](https://img-blog.csdnimg.cn/img_convert/d1815887bb5cf25d430e38269e6292f0.png#clientId=ua0e439fe-59ad-4&amp;errorMessage=unknown error&amp;from=paste&amp;height=393&amp;id=ud558beeb&amp;name=image.png&amp;originHeight=491&amp;originWidth=1410&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=111525&amp;status=error&amp;style=none&amp;taskId=u594810ea-35b1-4e9c-a6a8-fc124a5d3a5&amp;title=&amp;width=1128)
分布式系统会把一个应用系统拆分为可独立部署的多个服务，因此需要服务与服务之间远程协作才能完成事务操作，这种分布式系统环境下由不同的服务之间通过网络远程协作完成事务称之为分布式事务，例如用户注册送积分事务、创建订单减库存事务，银行转账事务等都是分布式事务。
我们知道本地事务依赖数据库本身提供的事务特性来实现，因此以下逻辑可以控制本地事务：
begin transaction； //1.本地数据库操作：张三减少金额 //2.本地数据库操作：李四增加金额 commit transation; 但是在分布式环境下，会变成下边这样：
begin transaction； //1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/23fabb4b6ab4b9c54a089d6099a54004/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-23T17:20:34+08:00" />
<meta property="article:modified_time" content="2023-03-23T17:20:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">分布式事务实现方案</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>分布式事务</h4> 
 <ul><li><ul><li><a href="#1_2" rel="nofollow">1.基础概念</a></li><li><ul><li><a href="#11_3" rel="nofollow">1.1.什么是事务</a></li><li><a href="#12_7" rel="nofollow">1.2.本地事务</a></li><li><a href="#13_18" rel="nofollow">1.3.分布式事务</a></li><li><a href="#14__41" rel="nofollow">1.4 分布式事务产生的场景</a></li></ul> 
   </li><li><a href="#2_50" rel="nofollow">2.分布式事务基础理论</a></li><li><ul><li><a href="#21CAP_54" rel="nofollow">2.1.CAP理论</a></li><li><ul><li><a href="#211CAP_55" rel="nofollow">2.1.1.理解CAP</a></li><li><a href="#212CAP_99" rel="nofollow">2.1.2.CAP组合方式</a></li><li><a href="#213__127" rel="nofollow">2.1.3 总结</a></li></ul> 
    </li><li><a href="#22BASE_129" rel="nofollow">2.2.BASE理论</a></li></ul> 
   </li><li><a href="#32PC_140" rel="nofollow">3.分布式事务解决方案之2PC(两阶段提交)</a></li><li><ul><li><a href="#312PC_143" rel="nofollow">3.1.什么是2PC</a></li><li><a href="#32_167" rel="nofollow">3.2.解决方案</a></li><li><ul><li><a href="#321_XA_168" rel="nofollow">3.2.1 XA方案</a></li><li><a href="#322_Seata_203" rel="nofollow">3.2.2 Seata方案</a></li></ul> 
    </li><li><a href="#33seata2PC_236" rel="nofollow">3.3.seata实现2PC事务</a></li><li><ul><li><a href="#331_237" rel="nofollow">3.3.1.业务说明</a></li><li><a href="#332_245" rel="nofollow">3.3.2.程序组成部分</a></li><li><a href="#333_266" rel="nofollow">3.3.3.创建数据库</a></li><li><a href="#334TC_308" rel="nofollow">3.3.4.启动TC(事务协调器)</a></li><li><a href="#335_discoverserver_321" rel="nofollow">3.3.5 discover-server</a></li><li><a href="#336_Seata_326" rel="nofollow">3.3.6 Seata执行流程</a></li><li><a href="#337_dtxseatademo_340" rel="nofollow">3.3.7 导入案例工程dtx-seata-demo</a></li><li><a href="#338_dtxseatademobank1_417" rel="nofollow">3.3.8 dtx-seata-demo-bank1</a></li><li><a href="#339_dtxseatademobank2_503" rel="nofollow">3.3.9 dtx-seata-demo-bank2</a></li><li><a href="#3310__558" rel="nofollow">3.3.10 测试场景</a></li><li><a href="#34_565" rel="nofollow">3.4.小结</a></li></ul> 
   </li></ul> 
   </li><li><a href="#4TCC_573" rel="nofollow">4.分布式事务解决方案之TCC</a></li><li><ul><li><a href="#41TCC_575" rel="nofollow">4.1.什么是TCC事务</a></li><li><a href="#42TCC__590" rel="nofollow">4.2.TCC 解决方案</a></li><li><a href="#43HmilyTCC_697" rel="nofollow">4.3.Hmily实现TCC事务</a></li><li><ul><li><a href="#431_698" rel="nofollow">4.3.1.业务说明</a></li><li><a href="#432_705" rel="nofollow">4.3.2.程序组成部分</a></li><li><a href="#433_717" rel="nofollow">4.3.3.创建数据库</a></li><li><a href="#434_discoverserver_764" rel="nofollow">4.3.4 discover-server</a></li><li><a href="#435_dtxtccdemo_768" rel="nofollow">4.3.5 导入案例工程dtx-tcc-demo</a></li><li><a href="#436_dtxtccdemobank1_839" rel="nofollow">4.3.6 dtx-tcc-demo-bank1</a></li><li><a href="#437_dtxtccdemobank2_1033" rel="nofollow">4.3.7 dtx-tcc-demo-bank2</a></li><li><a href="#438__1159" rel="nofollow">4.3.8 测试场景</a></li></ul> 
    </li><li><a href="#44_1167" rel="nofollow">4.4.小结</a></li></ul> 
   </li><li><a href="#5_1173" rel="nofollow">5.分布式事务解决方案之可靠消息最终一致性</a></li><li><ul><li><a href="#51_1174" rel="nofollow">5.1.什么是可靠消息最终一致性事务</a></li><li><a href="#52_1207" rel="nofollow">5.2.解决方案</a></li><li><ul><li><a href="#521_1211" rel="nofollow">5.2.1.本地消息表方案</a></li><li><a href="#522RocketMQ_1239" rel="nofollow">5.2.2.RocketMQ事务消息方案</a></li></ul> 
    </li><li><a href="#53RocketMQ_1285" rel="nofollow">5.3.RocketMQ实现可靠消息最终一致性事务</a></li><li><ul><li><a href="#531_1287" rel="nofollow">5.3.1.业务说明</a></li><li><a href="#532_1295" rel="nofollow">5.3.2.程序组成部分</a></li><li><a href="#533_1316" rel="nofollow">5.3.3.创建数据库</a></li><li><a href="#534RocketMQ_1358" rel="nofollow">5.3.4.启动RocketMQ</a></li><li><a href="#535_dtxtxmsgdemo_1372" rel="nofollow">5.3.5 导入dtx-txmsg-demo</a></li><li><a href="#536_dtxtxmsgdemobank1_1430" rel="nofollow">5.3.6 消息发送发：dtx-txmsg-demo-bank1</a></li><li><a href="#537_dtxtxmsgdemobank2_1586" rel="nofollow">5.3.7 消息消费者：dtx-txmsg-demo-bank2</a></li><li><a href="#538__1649" rel="nofollow">5.3.8 测试场景</a></li></ul> 
    </li><li><a href="#54_1655" rel="nofollow">5.4.小结</a></li></ul> 
   </li><li><a href="#6_1664" rel="nofollow">6.分布式事务解决方案之最大努力通知</a></li><li><ul><li><a href="#61_1666" rel="nofollow">6.1.什么是最大努力通知</a></li><li><a href="#62_1695" rel="nofollow">6.2.解决方案</a></li><li><a href="#63RocketMQ_1724" rel="nofollow">6.3.RocketMQ实现最大努力通知型事务</a></li><li><ul><li><a href="#631_1725" rel="nofollow">6.3.1.业务说明</a></li><li><a href="#632_1738" rel="nofollow">6.3.2.程序组成部分</a></li><li><a href="#633_1759" rel="nofollow">6.3.3.创建数据库</a></li><li><a href="#634RocketMQ_1795" rel="nofollow">6.3.4.启动RocketMQ</a></li><li><a href="#635_discoverserver_1798" rel="nofollow">6.3.5 discover-server</a></li><li><a href="#636_dtxnotifymsgdemo_1802" rel="nofollow">6.3.6 导入dtx-notifymsg-demo</a></li><li><a href="#637_dtxnotifydemopay_1848" rel="nofollow">6.3.7 消息发送方：dtx-notifydemo-pay</a></li><li><a href="#_1924" rel="nofollow"></a></li><li><a href="#638_dtxnotifydemobank1_1925" rel="nofollow">6.3.8 消息接收方：dtx-notifydemo-bank1</a></li><li><a href="#639__2057" rel="nofollow">6.3.9 测试场景</a></li></ul> 
    </li><li><a href="#64_2061" rel="nofollow">6.4.小结</a></li></ul> 
   </li><li><a href="#7_2067" rel="nofollow">7.分布式事务综合案例分析</a></li><li><ul><li><a href="#71_2071" rel="nofollow">7.1.系统介绍</a></li><li><ul><li><a href="#711P2P_2073" rel="nofollow">7.1.1.P2P介绍</a></li><li><a href="#712_2082" rel="nofollow">7.1.2.总体业务流程</a></li><li><a href="#712_2084" rel="nofollow">7.1.2.业务术语</a></li><li><a href="#712_2095" rel="nofollow">7.1.2.模块说明</a></li></ul> 
    </li><li><a href="#72_2112" rel="nofollow">7.2.注册账号案例分析</a></li><li><ul><li><a href="#721_2114" rel="nofollow">7.2.1.业务流程</a></li><li><a href="#722_2120" rel="nofollow">7.2.2.解决方案分析</a></li></ul> 
    </li><li><a href="#73_2147" rel="nofollow">7.3.存管开户</a></li><li><ul><li><a href="#731_2149" rel="nofollow">7.3.1.业务流程</a></li><li><a href="#732_2155" rel="nofollow">7.3.2.解决方案分析</a></li></ul> 
    </li><li><a href="#74_2178" rel="nofollow">7.4.满标审核</a></li><li><ul><li><a href="#741_2180" rel="nofollow">7.4.1.业务流程</a></li><li><a href="#742_2186" rel="nofollow">7.4.2.解决方案分析</a></li></ul> 
   </li></ul> 
   </li><li><a href="#8_2202" rel="nofollow">8.课程总结</a></li><li><ul><li><a href="#_2204" rel="nofollow">重点知识回顾:</a></li><li><a href="#_2212" rel="nofollow">分布式事务对比分析:</a></li><li><a href="#_2232" rel="nofollow">总结：</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1_2"></a>1.基础概念</h3> 
<h4><a id="11_3"></a>1.1.什么是事务</h4> 
<p>什么是事务？举个生活中的例子：你去小卖铺买东西，“一手交钱，一手交货”就是一个事务的例子，交钱和交货必须全部成功，事务才算成功，任一个活动失败，事务将撤销所有已成功的活动。<br> 明白上述例子，再来看事务的定义：<br> <strong>事务可以看做是一次大的活动，它由不同的小活动组成，这些活动要么全部成功，要么全部失败。</strong></p> 
<h4><a id="12_7"></a>1.2.本地事务</h4> 
<pre><code>在计算机系统中，更多的是通过关系型数据库来控制事务，这是利用数据库本身的事务特性来实现的，因此叫数据库事务，由于应用主要靠关系数据库来控制事务，而数据库通常和应用在同一个服务器，所以基于关系型数据库的事务又被称为本地事务。
</code></pre> 
<p>回顾一下数据库事务的四大特性 ACID：</p> 
<ul><li><strong>A（Atomic）</strong>：原子性，构成事务的所有操作，要么都执行完成，要么全部不执行，不可能出现部分成功部分失败的情况。</li><li><strong>C（Consistency）</strong>：一致性，在事务执行前后，数据库的一致性约束没有被破坏。比如：张三向李四转100元，转账前和转账后的数据是正确状态这叫一致性，如果出现张三转出100元，李四账户没有增加100元这就出现了数据错误，就没有达到一致性。</li><li><strong>I（Isolation）</strong>：隔离性，数据库中的事务一般都是并发的，隔离性是指并发的两个事务的执行互不干扰，一个事务不能看到其他事务运行过程的中间状态。通过配置事务隔离级别可以避脏读、重复读等问题。</li><li><strong>D（Durability）</strong>：持久性，事务完成之后，该事务对数据的更改会被持久化到数据库，且不会被回滚。</li></ul> 
<p>数据库事务在实现时会将一次事务涉及的所有操作全部纳入到一个不可分割的执行单元，该执行单元中的所有操作要么都成功，要么都失败，只要其中任一操作执行失败，都将导致整个事务的回滚</p> 
<h4><a id="13_18"></a>1.3.分布式事务</h4> 
<p>随着互联网的快速发展，软件系统由原来的单体应用转变为分布式应用，下图描述了单体应用向微服务的演变：<br> ![image.png](https://img-blog.csdnimg.cn/img_convert/d1815887bb5cf25d430e38269e6292f0.png#clientId=ua0e439fe-59ad-4&amp;errorMessage=unknown error&amp;from=paste&amp;height=393&amp;id=ud558beeb&amp;name=image.png&amp;originHeight=491&amp;originWidth=1410&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=111525&amp;status=error&amp;style=none&amp;taskId=u594810ea-35b1-4e9c-a6a8-fc124a5d3a5&amp;title=&amp;width=1128)<br> 分布式系统会把一个应用系统拆分为可独立部署的多个服务，因此需要服务与服务之间远程协作才能完成事务操作，这种分布式系统环境下由不同的服务之间通过网络远程协作完成事务称之为<strong>分布式事务</strong>，例如用户注册送积分事务、创建订单减库存事务，银行转账事务等都是分布式事务。</p> 
<p>我们知道本地事务依赖数据库本身提供的事务特性来实现，因此以下逻辑可以控制本地事务：</p> 
<pre><code class="prism language-shell">begin transaction；
	//1.本地数据库操作：张三减少金额
	//2.本地数据库操作：李四增加金额
commit transation<span class="token punctuation">;</span>
</code></pre> 
<p>但是在分布式环境下，会变成下边这样：</p> 
<pre><code class="prism language-shell">begin transaction；
//1.本地数据库操作：张三减少金额
//2.远程调用：让李四增加金额
commit transation<span class="token punctuation">;</span>
</code></pre> 
<p>可以设想，当远程调用让李四增加金额成功了，由于网络问题远程调用并没有返回，此时本地事务提交失败就回滚了张三减少金额的操作，此时张三和李四的数据就不一致了。<br> 因此在分布式架构的基础上，传统数据库事务就无法使用了，张三和李四的账户不在一个数据库中甚至不在一个应用系统里，实现转账事务需要通过远程调用，由于网络问题就会导致分布式事务问题。</p> 
<h4><a id="14__41"></a>1.4 分布式事务产生的场景</h4> 
<p>1、典型的场景就是微服务架构 微服务之间通过远程调用完成事务操作。 比如：订单微服务和库存微服务，下单的同时订单微服务请求库存微服务减库存。 简言之：跨JVM进程产生分布式事务。<br> ![image.png](https://img-blog.csdnimg.cn/img_convert/4c180e26cd05877a2d945d9700df6155.png#clientId=ua0e439fe-59ad-4&amp;errorMessage=unknown error&amp;from=paste&amp;height=382&amp;id=uc6ca998a&amp;name=image.png&amp;originHeight=478&amp;originWidth=916&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=64221&amp;status=error&amp;style=none&amp;taskId=u432b0f26-31e4-4f71-84cd-973b4b483b2&amp;title=&amp;width=732.8)</p> 
<p>2、单体系统访问多个数据库实例 当单体系统需要访问多个数据库（实例）时就会产生分布式事务。 比如：用户信息和订单信息分别在两个MySQL实例存储，用户管理系统删除用户信息，需要分别删除用户信息及用户的订单信息，由于数据分布在不同的数据实例，需要通过不同的数据库链接去操作数据，此时产生分布式事务。 简言之：跨数据库实例产生分布式事务。<br> ![image.png](https://img-blog.csdnimg.cn/img_convert/0bf77cd71818648f635c7bd8421fbd52.png#clientId=ua0e439fe-59ad-4&amp;errorMessage=unknown error&amp;from=paste&amp;height=352&amp;id=u2b09ba82&amp;name=image.png&amp;originHeight=452&amp;originWidth=759&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=53113&amp;status=error&amp;style=none&amp;taskId=u7ce8200f-59ec-4507-8756-2399e59ddc4&amp;title=&amp;width=591)<br> 3、多服务访问同一个数据库实例 比如：订单微服务和库存微服务即使访问同一个数据库也会产生分布式事务，原因就是跨JVM进程，两个微服务持有了不同的数据库链接进行数据库操作，此时产生分布式事务。<br> ![image.png](https://img-blog.csdnimg.cn/img_convert/9928295a5eed825c23325321209788fa.png#clientId=u0e36982b-0e42-4&amp;errorMessage=unknown error&amp;from=paste&amp;height=369&amp;id=u229bfd97&amp;name=image.png&amp;originHeight=461&amp;originWidth=832&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=63412&amp;status=error&amp;style=none&amp;taskId=u9161177c-346f-418d-9439-eed939982b2&amp;title=&amp;width=665.6)</p> 
<h3><a id="2_50"></a>2.分布式事务基础理论</h3> 
<p>通过前面的学习，我们了解到了分布式事务的基础概念。与本地事务不同的是，分布式系统之所以叫分布式，是因为提供服务的各个节点分布在不同机器上，相互之间通过网络交互。不能因为有一点网络问题就导致整个系统无法提供服务，网络因素成为了分布式事务的考量标准之一。因此，分布式事务需要更进一步的理论支持，接下来，我们先来学习一下分布式事务的CAP理论。<br> 在讲解分布式事务控制解决方案之前需要先学习一些基础理论，通过理论知识指导我们确定分布式事务控制的目标，从而帮助我们理解每个解决方案。</p> 
<h4><a id="21CAP_54"></a>2.1.CAP理论</h4> 
<h5><a id="211CAP_55"></a>2.1.1.理解CAP</h5> 
<p>**CAP是Consistency（一致性），Availability（可用性）、Partition tolerance（分区容忍性）**三个词语的缩写。<br> 下边我们分别来解释：为了方便对CAP理论的理解，我们结合电商系统中的一些业务场景来理解CAP。如下图，是商品信息管理的执行流程：<br> ![image.png](https://img-blog.csdnimg.cn/img_convert/9dffd000db2403642a0719ef850bec50.png#clientId=u0e36982b-0e42-4&amp;errorMessage=unknown error&amp;from=paste&amp;height=442&amp;id=u29bef378&amp;name=image.png&amp;originHeight=553&amp;originWidth=771&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=46079&amp;status=error&amp;style=none&amp;taskId=uc7c319c9-2320-4f0e-bcbc-354d9edb435&amp;title=&amp;width=616.8)<br> 整体执行流程如下：<br> 1、商品服务请求主数据库写入商品信息（添加商品、修改商品、删除商品）<br> 2、主数据库向商品服务响应写入成功。<br> 3、商品服务请求从数据库读取商品信息。</p> 
<p><strong>C - Consistency</strong>：一致性是指写操作后的读操作可以读取到最新的数据状态，当数据分布在多个节点上，从任意结点读取到的数据都是最新的状态。</p> 
<ul><li>上图中，商品信息的读写要满足一致性就是要实现如下目标： 
  <ul><li>1、商品服务写入主数据库成功，则向从数据库查询新数据也成功。</li><li>2、商品服务写入主数据库失败，则向从数据库查询新数据也失败。</li></ul> </li><li>如何实现一致性？ 
  <ul><li>1、写入主数据库后要将数据同步到从数据库。</li><li>2、写入主数据库后，在向从数据库同步期间要将从数据库锁定，待同步完成后再释放锁，以免在新数据写入成功后，向从数据库查询到旧的数据。</li></ul> </li><li>分布式系统一致性的特点： 
  <ul><li>1、由于存在数据同步的过程，写操作的响应会有一定的延迟。</li><li>2、为了保证数据一致性会对资源暂时锁定，待数据同步完成释放锁定资源。</li><li>3、如果请求数据同步失败的结点则会返回错误信息，一定不会返回旧数据。</li></ul> </li></ul> 
<p>**A - Availability **：可用性是指任何事务操作都可以得到响应结果，且不会出现响应超时或响应错误。</p> 
<ul><li>上图中，商品信息读取满足可用性就是要实现如下目标： 
  <ul><li>1、从数据库接收到数据查询的请求则立即能够响应数据查询结果。</li><li>2、从数据库不允许出现响应超时或响应错误。</li></ul> </li><li>如何实现可用性？ 
  <ul><li>1、写入主数据库后要将数据同步到从数据库。</li><li>2、由于要保证从数据库的可用性，不可将从数据库中的资源进行锁定。</li><li>3、即时数据还没有同步过来，从数据库也要返回要查询的数据，哪怕是旧数据，如果连旧数据也没有则可以按照约定返回一个默认信息，但不能返回错误或响应超时。</li></ul> </li><li>分布式系统可用性的特点： 
  <ul><li>1、 所有请求都有响应，且不会出现响应超时或响应错误。</li></ul> </li></ul> 
<p>**P - Partition tolerance **：通常分布式系统的各各结点部署在不同的子网，这就是网络分区，不可避免的会出现由于网络问题而导致结点之间通信失败，此时仍可对外提供服务，这叫分区容忍性。</p> 
<ul><li>上图中，商品信息读写满足分区容忍性就是要实现如下目标： 
  <ul><li>1、主数据库向从数据库同步数据失败不影响读写操作。</li><li>2、其一个结点挂掉不影响另一个结点对外提供服务。</li></ul> </li><li>如何实现分区容忍性？ 
  <ul><li>1、尽量使用异步取代同步操作，例如使用异步方式将数据从主数据库同步到从数据，这样结点之间能有效的实现松耦合。</li><li>2、添加从数据库结点，其中一个从结点挂掉其它从结点提供服务。</li></ul> </li><li>分布式分区容忍性的特点： 
  <ul><li>1、分区容忍性分是布式系统具备的基本能力。</li></ul> </li></ul> 
<h5><a id="212CAP_99"></a>2.1.2.CAP组合方式</h5> 
<p>1、上边商品管理的例子是否同时具备 CAP呢？<br> <strong>在所有分布式事务场景中不会同时具备CAP三个特性，因为在具备了P的前提下C和A是不能共存的。</strong><br> 比如：<br> 下图满足了P即表示实现分区容忍：</p> 
<p>![image.png](https://img-blog.csdnimg.cn/img_convert/051d7b0f675e550dd388d810c482046e.png#clientId=u0e36982b-0e42-4&amp;errorMessage=unknown error&amp;from=paste&amp;height=448&amp;id=u8796364d&amp;name=image.png&amp;originHeight=560&amp;originWidth=784&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=46405&amp;status=error&amp;style=none&amp;taskId=uc8347b19-2ae1-462f-ad34-5e036388860&amp;title=&amp;width=627.2)<br> 本图分区容忍的含义是：</p> 
<ul><li>1）主数据库通过网络向从数据同步数据，可以认为主从数据库部署在不同的分区，通过网络进行交互。</li><li>2）当主数据库和从数据库之间的网络出现问题不影响主数据库和从数据库对外提供服务。</li><li>3）其一个结点挂掉不影响另一个结点对外提供服务。</li></ul> 
<p>如果要实现C则必须保证数据一致性，在数据同步的时候为防止向从数据库查询不一致的数据则需要将从数据库数据锁定，待同步完成后解锁，如果同步失败从数据库要返回错误信息或超时信息。<br> 如果要实现A则必须保证数据可用性，不管任何时候都可以向从数据查询数据，则不会响应超时或返回错误信息。<br> 通过分析发现在满足P的前提下C和A存在矛盾性。</p> 
<p>2、CAP有哪些组合方式呢？<br> 所以在生产中对分布式事务处理时要根据需求来确定满足CAP的哪两个方面。</p> 
<ul><li>1）AP：放弃一致性，追求分区容忍性和可用性。这是很多分布式系统设计时的选择。 
  <ul><li>例如：上边的商品管理，完全可以实现AP，前提是只要用户可以接受所查询的到数据在一定时间内不是最新的即可。通常实现AP都会保证最终一致性，后面讲的BASE理论就是根据AP来扩展的，一些业务场景 比如：订单退款，今日退款成功，明日账户到账，只要用户可以接受在一定时间内到账即可。</li></ul> </li><li>2）CP：放弃可用性，追求一致性和分区容错性，我们的zookeeper其实就是追求的强一致，又比如跨行转账，一次转账请求要等待双方银行系统都完成整个事务才算完成。</li><li>3）CA：放弃分区容忍性，即不进行分区，不考虑由于网络不通或结点挂掉的问题，则可以实现一致性和可用性。那么系统将不是一个标准的分布式系统，我们最常用的关系型数据就满足了CA。</li></ul> 
<p>上边的商品管理，如果要实现CA则架构如下：<br> ![image.png](https://img-blog.csdnimg.cn/img_convert/1ea9255cde28a56da076e9e354b29795.png#clientId=u0e36982b-0e42-4&amp;errorMessage=unknown error&amp;from=paste&amp;height=416&amp;id=u8ac8940e&amp;name=image.png&amp;originHeight=520&amp;originWidth=541&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=20709&amp;status=error&amp;style=none&amp;taskId=uc2d87633-0b99-4a35-b516-01b83c54c68&amp;title=&amp;width=432.8)<br> 主数据库和从数据库中间不再进行数据同步，数据库可以响应每次的查询请求，通过事务隔离级别实现每个查询请求都可以返回最新的数据。</p> 
<h5><a id="213__127"></a>2.1.3 总结</h5> 
<p>通过上面我们已经学习了CAP理论的相关知识，CAP是一个已经被证实的理论：一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容忍性（Partition tolerance）这三项中的两项。它可以作为我们进行架构设计、技术选型的考量标准。对于多数大型互联网应用的场景，结点众多、部署分散，而且现在的集群规模越来越大，所以节点故障、网络故障是常态，而且要保证服务可用性达到N个9（99.99…%），并要达到良好的响应性能来提高用户体验，因此一般都会做出如下选择：保证P和A，舍弃C强一致，保证最终一致性。</p> 
<h4><a id="22BASE_129"></a>2.2.BASE理论</h4> 
<p>1、理解强一致性和最终一致性<br> CAP理论告诉我们一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容忍性（Partition tolerance）这三项中的两项，其中AP在实际应用中较多，AP即舍弃一致性，保证可用性和分区容忍性，但是在实际生产中很多场景都要实现一致性，比如前边我们举的例子主数据库向从数据库同步数据，即使不要一致性，但是最终也要将数据同步成功来保证数据一致，这种一致性和CAP中的一致性不同，CAP中的一致性要求在任何时间查询每个结点数据都必须一致，它强调的是强一致性，但是最终一致性是允许可以在一段时间内每个结点的数据不一致，但是经过一段时间每个结点的数据必须一致，它强调的是最终数据的一致性。</p> 
<p>2、Base理论介绍<br> BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写。BASE理论是对CAP中AP的一个扩展，通过牺牲强一致性来获得可用性，当出现故障允许部分不可用但要保证核心功能可用，允许数据在一段时间内是不一致的，但最终达到一致状态。满足BASE理论的事务，我们称之为“<strong>柔性事务</strong>”。</p> 
<ul><li>基本可用：分布式系统在出现故障时，允许损失部分可用功能，保证核心功能可用。如，电商网站交易付款出现问题了，商品依然可以正常浏览。</li><li>软状态：由于不要求强一致性，所以BASE允许系统中存在中间状态（也叫<strong>软状态</strong>），这个状态不影响系统可用性，如订单的"支付中"、“数据同步中”等状态，待数据最终一致后状态改为“成功”状态。</li><li>最终一致：最终一致是指经过一段时间后，所有节点数据都将会达到一致。如订单的"支付中"状态，最终会变为“支付成功”或者"支付失败"，使订单状态与实际交易结果达成一致，但需要一定时间的延迟、等待。</li></ul> 
<h3><a id="32PC_140"></a>3.分布式事务解决方案之2PC(两阶段提交)</h3> 
<p>前面已经学习了分布式事务的基础理论，以理论为基础，针对不同的分布式场景业界常见的解决方案有2PC、TCC、可靠消息最终一致性、最大努力通知这几种。</p> 
<h4><a id="312PC_143"></a>3.1.什么是2PC</h4> 
<p>2PC即两阶段提交协议，是将整个事务流程分为两个阶段，准备阶段（Prepare phase）、提交阶段（commit phase），2是指两个阶段，P是指准备阶段，C是指提交阶段。<br> 举例：张三和李四好久不见，老友约起聚餐，饭店老板要求先买单，才能出票。这时张三和李四分别抱怨近况不如意，囊中羞涩，都不愿意请客，这时只能AA。只有张三和李四都付款，老板才能出票安排就餐。但由于张三和李四都是铁公鸡，形成了尴尬的一幕：</p> 
<ul><li>准备阶段：老板要求张三付款，张三付款。老板要求李四付款，李四付款。</li><li>提交阶段：老板出票，两人拿票纷纷落座就餐。</li></ul> 
<p>例子中形成了一个事务，若张三或李四其中一人拒绝付款，或钱不够，店老板都不会给出票，并且会把已收款退回。<br> 整个事务过程由事务管理器和参与者组成，店老板就是事务管理器，张三、李四就是事务参与者，事务管理器负责决策整个分布式事务的提交和回滚，事务参与者负责自己本地事务的提交和回滚。</p> 
<p>在计算机中部分关系数据库如Oracle、MySQL支持两阶段提交协议，如下图：</p> 
<ul><li>准备阶段（Prepare phase）：事务管理器给每个参与者发送Prepare消息，每个数据库参与者在本地执行事务，并写本地的Undo/Redo日志，此时事务没有提交。（Undo日志是记录修改前的数据，用于数据库回滚，Redo日志是记录修改后的数据，用于提交事务后写入数据文件）</li><li>提交阶段（commit phase）：如果事务管理器收到了参与者的执行失败或者超时消息时，直接给每个参与者发送回滚(Rollback)消息；否则，发送提交(Commit)消息；参与者根据事务管理器的指令执行提交或者回滚操作，并释放事务处理过程中使用的锁资源。注意:必须在最后阶段释放锁资源。</li></ul> 
<p>下图展示了2PC的两个阶段，分成功和失败两个情况说明：</p> 
<ul><li>成功情况：</li></ul> 
<p>![image.png](https://img-blog.csdnimg.cn/img_convert/36c2830c4711cdd35c36535f03e590a1.png#clientId=u31d4324d-ece3-4&amp;errorMessage=unknown error&amp;from=paste&amp;height=458&amp;id=u1d778add&amp;name=image.png&amp;originHeight=573&amp;originWidth=1360&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=122345&amp;status=error&amp;style=none&amp;taskId=u8285fe60-68d1-49a6-8654-e07f8959866&amp;title=&amp;width=1088)</p> 
<ul><li>失败情况：</li></ul> 
<p>![image.png](https://img-blog.csdnimg.cn/img_convert/715684783ed188f74767d9d24eb9733a.png#clientId=u31d4324d-ece3-4&amp;errorMessage=unknown error&amp;from=paste&amp;height=446&amp;id=u62644d4e&amp;name=image.png&amp;originHeight=558&amp;originWidth=1248&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=102485&amp;status=error&amp;style=none&amp;taskId=ua49d7c61-bb29-474d-87f9-d391690dbdd&amp;title=&amp;width=998.4)</p> 
<h4><a id="32_167"></a>3.2.解决方案</h4> 
<h5><a id="321_XA_168"></a>3.2.1 XA方案</h5> 
<p>2PC的传统方案是在数据库层面实现的，如Oracle、MySQL都支持2PC协议，为了统一标准减少行业内不必要的对接成本，需要制定标准化的处理模型及接口标准，国际开放标准组织Open Group定义了分布式事务处理模型<strong>DTP</strong>（Distributed Transaction Processing Reference Model）。</p> 
<p>为了让大家更明确XA方案的内容程，下面新用户注册送积分为例来说明：<br> ![image.png](https://img-blog.csdnimg.cn/img_convert/9a8ab5516bf98982e3ef4c69082019f5.png#clientId=u31d4324d-ece3-4&amp;errorMessage=unknown error&amp;from=paste&amp;height=389&amp;id=uc363581d&amp;name=image.png&amp;originHeight=486&amp;originWidth=550&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=50856&amp;status=error&amp;style=none&amp;taskId=u410393e6-2e33-4410-b017-ab59f89cecc&amp;title=&amp;width=440)<br> 执行流程如下：</p> 
<ul><li>1、应用程序（AP）持有用户库和积分库两个数据源。</li><li>2、应用程序（AP）通过TM通知用户库RM新增用户，同时通知积分库RM为该用户新增积分，RM此时并未提交事务，此时用户和积分资源锁定。</li><li>3、TM收到执行回复，只要有一方失败则分别向其他RM发起回滚事务，回滚完毕，资源锁释放。</li><li>4、TM收到执行回复，全部成功，此时向所有RM发起提交事务，提交完毕，资源锁释放。</li></ul> 
<p>DTP模型定义如下角色：</p> 
<ul><li><strong>AP</strong>(Application Program)：即应用程序，可以理解为使用DTP分布式事务的程序。</li><li><strong>RM</strong>(Resource Manager)：即资源管理器，可以理解为事务的参与者，一般情况下是指一个数据库实例，通过资源管理器对该数据库进行控制，资源管理器控制着分支事务。</li><li><strong>TM</strong>(Transaction Manager)：事务管理器，负责协调和管理事务，事务管理器控制着全局事务，管理事务生命周期，并协调各个RM。<strong>全局事务</strong>是指分布式事务处理环境中，需要操作多个数据库共同完成一个工作，这个工作即是一个全局事务。</li><li>DTP模型定义TM和RM之间通讯的接口规范叫<strong>XA</strong>，简单理解为数据库提供的2PC接口协议，<strong>基于数据库的XA协议来实现2PC又称为XA方案</strong>。</li></ul> 
<p>以上三个角色之间的交互方式如下：</p> 
<ul><li>1）TM向AP提供 应用程序编程接口，AP通过TM提交及回滚事务。</li><li>2）TM交易中间件通过XA接口来通知RM数据库事务的开始、结束以及提交、回滚等。</li></ul> 
<p>总结：</p> 
<ul><li>整个2PC的事务流程涉及到三个角色AP、RM、TM。AP指的是使用2PC分布式事务的应用程序；RM指 的是资源管理器，它控制着分支事务；TM指的是事务管理器，它控制着整个全局事务。 
  <ul><li>1）在<strong>准备阶段</strong>RM执行实际的业务操作，但不提交事务，资源锁定；</li><li>2）在<strong>提交阶段</strong>TM会接受RM在准备阶段的执行回复，只要有任一个RM执行失败，TM会通知所有RM执行回滚操作，否则，TM将会通知所有RM提交该事务。提交阶段结束资源锁释放。</li></ul> </li></ul> 
<p>XA方案的问题：</p> 
<ul><li>1、需要本地数据库支持XA协议。</li><li>2、资源锁需要等到两个阶段结束才释放，性能较差。</li></ul> 
<h5><a id="322_Seata_203"></a>3.2.2 Seata方案</h5> 
<p>Seata是由阿里中间件团队发起的开源项目 Fescar，后更名为Seata，它是一个是开源的分布式事务框架。<br> 传统2PC的问题在Seata中得到了解决，它通过对本地关系数据库的分支事务的协调来驱动完成全局事务，是工作在应用层的中间件。主要优点是性能较好，且不长时间占用连接资源，它以高效并且对业务0侵入的方式解决微服务场景下面临的分布式事务问题，它目前提供AT模式(即2PC)及TCC模式的分布式事务解决方案。<br> <strong>Seata的设计思想如下：</strong></p> 
<p>Seata的设计目标其一是对业务无侵入，因此从业务无侵入的2PC方案着手，在<strong>传统2PC</strong>的基础上演进，并解决2PC方案面临的问题。<br> Seata把一个分布式事务理解成一个包含了若干<strong>分支事务</strong>的<strong>全局事务</strong>。全局事务的职责是协调其下管辖的分支事务达成一致，要么一起成功提交，要么一起失败回滚。此外，通常分支事务本身就是一个关系数据库的本地事务，下图是全局事务与分支事务的关系图：<br> <img src="https://images2.imgbox.com/f9/1e/Gdml7QRM_o.png" alt="image.png"></p> 
<p>与 传统2PC 的模型类似，Seata定义了3个组件来协议分布式事务的处理过程：<br> <img src="https://images2.imgbox.com/50/87/SJcZFMUg_o.png" alt="image.png"></p> 
<ul><li>Transaction Coordinator (TC)： 事务协调器，它是独立的中间件，需要独立部署运行，它维护全局事务的运行状态，接收TM指令发起全局事务的提交与回滚，负责与RM通信协调各各分支事务的提交或回滚。</li><li>Transaction Manager ™： 事务管理器，TM需要嵌入应用程序中工作，它负责开启一个全局事务，并最终向TC发起全局提交或全局回滚的指令。</li><li>Resource Manager (RM)： 控制分支事务，负责分支注册、状态汇报，并接收事务协调器TC的指令，驱动分支（本地）事务的提交和回滚。</li></ul> 
<p>还拿<strong>新用户注册送积分</strong>举例Seata的分布式事务过程：<br> <img src="https://images2.imgbox.com/b1/43/2h6FuFtH_o.png" alt="image.png"><br> 具体的执行流程如下：</p> 
<ol><li>用户服务的 TM 向 TC 申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的XID。</li><li>用户服务的 RM 向 TC 注册 分支事务，该分支事务在用户服务执行新增用户逻辑，并将其纳入 XID 对应全局事务的管辖。</li><li>用户服务执行分支事务，向用户表插入一条记录。</li><li>逻辑执行到远程调用积分服务时(XID 在微服务调用链路的上下文中传播)。积分服务的RM 向 TC 注册分支事务，该分支事务执行增加积分的逻辑，并将其纳入 XID 对应全局事务的管辖。</li><li>积分服务执行分支事务，向积分记录表插入一条记录，执行完毕后，返回用户服务。</li><li>用户服务分支事务执行完毕。</li><li>TM 向 TC 发起针对 XID 的全局提交或回滚决议。</li><li>TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求。</li></ol> 
<p><strong>Seata实现2PC与传统2PC的差别</strong>：</p> 
<ul><li>架构层次方面，<strong>传统2PC</strong>方案的 RM 实际上是在数据库层，RM 本质上就是数据库自身，通过 XA 协议实现，而Seata的 RM 是以jar包的形式作为中间件层部署在应用程序这一侧的。</li><li>两阶段提交方面，<strong>传统2PC</strong>无论第二阶段的决议是commit还是rollback，事务性资源的锁都要保持到Phase2完成才释放。而Seata的做法是在Phase1 就将本地事务提交，这样就可以省去Phase2持锁的时间，整体提高效率。</li></ul> 
<h4><a id="33seata2PC_236"></a>3.3.seata实现2PC事务</h4> 
<h5><a id="331_237"></a>3.3.1.业务说明</h5> 
<p>本示例通过Seata中间件实现分布式事务，模拟三个账户的转账交易过程。</p> 
<p>两个账户在三个不同的银行(张三在bank1、李四在bank2)，bank1和bank2是两个个微服务。交易过程是，张三给李四转账指定金额。</p> 
<p>上述交易步骤，要么一起成功，要么一起失败，必须是一个整体性的事务。<br> <img src="https://images2.imgbox.com/72/f3/oiY0IGZW_o.png" alt="image.png"></p> 
<h5><a id="332_245"></a>3.3.2.程序组成部分</h5> 
<p>本示例程序组成部分如下：<br> 数据库：MySQL-5.7.25。包括bank1和bank2两个数据库。<br> JDK：64位 jdk1.8.0_201<br> 微服务框架：spring-boot-2.1.3、spring-cloud-Greenwich.RELEASE<br> seata客户端（RM、TM）：spring-cloud-alibaba-seata-2.1.0.RELEASE<br> seata服务端(TC)：seata-server-0.7.1<br> 微服务及数据库的关系 ：</p> 
<ul><li>dtx/dtx-seata-demo/seata-demo-bank1 银行1，操作张三账户， 连接数据库bank1</li><li>dtx/dtx-seata-demo/seata-demo-bank2 银行2，操作李四账户，连接数据库bank2</li><li>服务注册中心：dtx/discover-server</li></ul> 
<p>本示例程序技术架构如下：<br> <img src="https://images2.imgbox.com/dc/6b/zQLYidBu_o.png" alt="image.png"><br> 交互流程如下：<br> 1、请求bank1进行转账，传入转账金额。<br> 2、bank1减少转账金额，调用bank2，传入转账金额。</p> 
<h5><a id="333_266"></a>3.3.3.创建数据库</h5> 
<p>导入数据库脚本：资料\sql\bank1.sql、资料\sql\bank2.sql</p> 
<p>包括如下数据库：<strong>bank1库，包含张三账户</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token identifier"><span class="token punctuation">`</span>bank1<span class="token punctuation">`</span></span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token string">'utf8'</span> <span class="token keyword">COLLATE</span> <span class="token string">'utf8_general_ci'</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span><span class="token punctuation">;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span>   <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_name<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'户主姓名'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_no<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'银行卡号'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_password<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span> <span class="token string">'帐户密码'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_balance<span class="token punctuation">`</span></span> <span class="token keyword">double</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'帐户余额'</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span>  <span class="token keyword">KEY</span>  <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>  <span class="token keyword">USING</span>  <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span>  <span class="token operator">=</span>  <span class="token keyword">InnoDB</span>  <span class="token keyword">AUTO_INCREMENT</span>  <span class="token operator">=</span>  <span class="token number">5</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  <span class="token operator">=</span>  utf8  <span class="token keyword">COLLATE</span>  <span class="token operator">=</span>  utf8_bin  ROW_FORMAT  <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'张三的账户'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>bank2库，包含李四账户</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token identifier"><span class="token punctuation">`</span>bank2<span class="token punctuation">`</span></span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token string">'utf8'</span> <span class="token keyword">COLLATE</span> <span class="token string">'utf8_general_ci'</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span>   <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_name<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'户主姓名'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_no<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'银行卡号'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_password<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span> <span class="token string">'帐户密码'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_balance<span class="token punctuation">`</span></span> <span class="token keyword">double</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'帐户余额'</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span>  <span class="token keyword">KEY</span>  <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>  <span class="token keyword">USING</span>  <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span>  <span class="token operator">=</span>  <span class="token keyword">InnoDB</span>  <span class="token keyword">AUTO_INCREMENT</span>  <span class="token operator">=</span>  <span class="token number">5</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  <span class="token operator">=</span>  utf8  <span class="token keyword">COLLATE</span>  <span class="token operator">=</span>  utf8_bin  ROW_FORMAT  <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'李四的账户'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>分别在bank1、bank2库中创建undo_log表，此表为seata框架使用：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span>  <span class="token keyword">TABLE</span>  <span class="token identifier"><span class="token punctuation">`</span>undo_log<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>context<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>rollback_info<span class="token punctuation">`</span></span> <span class="token keyword">longblob</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>log_status<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>log_created<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>log_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>ext<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>ux_undo_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>  <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span>  <span class="token keyword">DEFAULT</span>  <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="334TC_308"></a>3.3.4.启动TC(事务协调器)</h5> 
<p>（1）下载seata服务器</p> 
<p>下载地址：<a href="https://github.com/seata/seata/releases/download/v0.7.1/seata-server-0.7.1.zip">https://github.com/seata/seata/releases/download/v0.7.1/seata-server-0.7.1.zip</a>也可以直接解压：资料\seata-server-0.7.1.zip<br> （2）解压并启动</p> 
<p>[seata服务端解压路径]/bin/seata-server.bat -p 8888 -m file</p> 
<p>注：其中8888为服务端口号；file为启动模式，这里指seata服务将采用文件的方式存储信息。<br> <img src="https://images2.imgbox.com/6c/e2/bjSuof0u_o.png" alt="image.png"><br> 如上图出现“Server started…”的字样则表示启动成功。</p> 
<h5><a id="335_discoverserver_321"></a>3.3.5 discover-server</h5> 
<p>discover-server是服务注册中心，测试工程将自己注册至discover-server。</p> 
<blockquote> 
 <p>导入：资料\基础代码\dtx 父工程，此工程自带了discover-server，discover-server基于Eureka实现。</p> 
</blockquote> 
<h5><a id="336_Seata_326"></a>3.3.6 Seata执行流程</h5> 
<p>1、正常提交流程<br> <img src="https://images2.imgbox.com/0d/e2/gPWqIJ12_o.png" alt="image.png"><br> 2、回滚流程<br> 回滚流程省略前的RM注册过程。<br> <img src="https://images2.imgbox.com/07/5d/zne3FwnI_o.png" alt="image.png"><br> 要点说明：</p> 
<ul><li>1、每个RM使用DataSourceProxy连接数据库，其目的是使用ConnectionProxy，使用数据源和数据连接代理的目的就是在第一阶段将undo_log和业务数据放在一个本地事务提交，这样就保存了只要有业务操作就一定有undo_log。</li><li>2、在第一阶段undo_log中存放了数据修改前和修改后的值，为事务回滚作好准备，所以第一阶段完成就已经将分支事务提交，也就释放了锁资源。</li><li>3、TM开启全局事务开始，将XID全局事务id放在事务上下文中，通过feign调用也将XID传入下游分支事务，每个分支事务将自己的Branch ID分支事务ID与XID关联。</li><li>4、第二阶段全局事务提交，TC会通知各各分支参与者提交分支事务，在第一阶段就已经提交了分支事务，这里各各参与者只需要删除undo_log即可，并且可以异步执行，第二阶段很快可以完成。</li><li>5、第二阶段全局事务回滚，TC会通知各各分支参与者回滚分支事务，通过 XID 和 Branch ID 找到相应的回滚日志，通过回滚日志生成反向的 SQL 并执行，以完成分支事务回滚到之前的状态，如果回滚失败则会重试回滚操作。</li></ul> 
<h5><a id="337_dtxseatademo_340"></a>3.3.7 导入案例工程dtx-seata-demo</h5> 
<p>dtx-seata-demo是seata的测试工程，根据业务需求需要创建两个dtx-seata-demo工程。<br> <strong>（1）导入dtx-seata-demo</strong><br> 导入：资料\基础代码\dtx-seata-demo到父工程dtx下。两个测试工程如下：</p> 
<ul><li>dtx/dtx-seata-demo/dtx-seata-demo-bank1 ，操作张三账户，连接数据库bank1</li><li>dtx/dtx-seata–demo/dtx-seata-demo-bank2 ，操作李四账户，连接数据库bank2</li></ul> 
<p><strong>（2）父工程maven依赖说明</strong><br> 在dtx父工程中指定了SpringBoot和SpringCloud版本</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring‐boot‐dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.3.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring‐cloud‐dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>Greenwich.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>在dtx-seata-demo父工程中指定了spring-cloud-alibaba-dependencies的版本。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring‐cloud‐alibaba‐dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><strong>（3）配置seata，主要是配置registry.conf、file.conf文件</strong><br> 从seata-server-0.7.1中的配置文件目录拷贝registry.conf、file.conf文件，到src/main/resource目录下：<br> <img src="https://images2.imgbox.com/f7/3c/hvRr2MXl_o.png" alt="image.png"></p> 
<ul><li>修改registry.conf文件</li></ul> 
<p><img src="https://images2.imgbox.com/3a/34/lxFwemQg_o.png" alt="image.png"></p> 
<ul><li>在file.conf中更改两个地方：service.vgroup_mapping和service.default.grouplist 
  <ul><li>service.vgroup_mapping.[springcloud服务名]-fescar-service-group = “default”，并修改</li><li>service.default.grouplist =[seata服务端地址]</li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/46/3d/ZQpbxB0L_o.png" alt="image.png"><br> 关于vgroup_mapping的配置：</p> 
<ul><li>vgroup_mapping.事务分组服务名=Seata Server集群名称（默认名称为default）</li><li>default.grouplist = Seata Server集群地址</li><li>在seata源码org.springframework.cloud.alibaba.seata.GlobalTransactionAutoConfiguration 类中，默认会使用 ${spring.application.name}-fescar-service-group 作为事务分组服务名注册到 Seata Server上，如果和file.conf 中的配置不一致，会提示 no available server to connect 错误 。</li><li>可以通过配置 spring.cloud.alibaba.seata.tx-service-group 修改后缀，但是必须和 file.conf 中的配置保持 一致。 【一般使用默认的】</li></ul> 
<p><strong>（4）创建代理数据源</strong><br> 新增DatabaseConfiguration.java，Seata的RM通过DataSourceProxy才能在业务代码的事务提交时，通过这个切入点，与TC进行通信交互、记录undo_log等。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DatabaseConfiguration</span> <span class="token punctuation">{<!-- --></span> 
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource.ds0"</span><span class="token punctuation">)</span> 
    <span class="token keyword">public</span> <span class="token class-name">DruidDataSource</span> <span class="token function">ds0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token class-name">DruidDataSource</span> druidDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">return</span> druidDataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Primary</span> <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token class-name">DruidDataSource</span> ds0<span class="token punctuation">)</span>   <span class="token punctuation">{<!-- --></span> 
        <span class="token class-name">DataSourceProxy</span> pds0 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceProxy</span><span class="token punctuation">(</span>ds0<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> pds0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="338_dtxseatademobank1_417"></a>3.3.8 dtx-seata-demo-bank1</h5> 
<p>dtx-seata-demo-bank1实现如下功能：</p> 
<ul><li>1、张三账户减少金额，开启全局事务。</li><li>2、远程调用bank2向李四转账。</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Mapper</span> <span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccountInfoDao</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//更新账户金额</span>
    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">"update account_info set account_balance = account_balance + #{amount} where account_no = #{accountNo}"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">updateAccountBalance</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"accountNo"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>（2）FeignClient远程调用bank2的客户端</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"seata-demo-bank2"</span><span class="token punctuation">,</span>fallback<span class="token operator">=</span><span class="token class-name">Bank2ClientFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Bank2Client</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//远程调用李四的微服务</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/bank2/transfer"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span>  <span class="token class-name">String</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Bank2ClientFallback</span> <span class="token keyword">implements</span> <span class="token class-name">Bank2Client</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Double</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"fallback"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（3）Service</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountInfoServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AccountInfoService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoDao</span> accountInfoDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">Bank2Client</span> bank2Client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token annotation punctuation">@GlobalTransactional</span><span class="token comment">//开启全局事务</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateAccountBalance</span><span class="token punctuation">(</span><span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank1 service begin,XID：{}"</span><span class="token punctuation">,</span> <span class="token class-name">RootContext</span><span class="token punctuation">.</span><span class="token function">getXID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//扣减张三的金额</span>
        accountInfoDao<span class="token punctuation">.</span><span class="token function">updateAccountBalance</span><span class="token punctuation">(</span>accountNo<span class="token punctuation">,</span>amount <span class="token operator">*</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用李四微服务，转账</span>
        <span class="token class-name">String</span> transfer <span class="token operator">=</span> bank2Client<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"fallback"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>transfer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//调用李四微服务异常</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"调用李四微服务异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>amount <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//人为制造异常</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"bank1 make exception.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>将@GlobalTransactional注解标注在全局事务发起的Service实现方法上，开启全局事务：GlobalTransactionalInterceptor会拦截@GlobalTransactional注解的方法，生成全局事务ID(XID)，XID会在整个分布式事务中传递。<br> 在远程调用时，spring-cloud-alibaba-seata会拦截Feign调用将XID传递到下游服务。</p> 
<p>（4）Controller</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Bank1Controller</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoService</span> accountInfoService<span class="token punctuation">;</span>

    <span class="token comment">//张三转账</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/transfer"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        accountInfoService<span class="token punctuation">.</span><span class="token function">updateAccountBalance</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"bank1"</span><span class="token operator">+</span>amount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="339_dtxseatademobank2_503"></a>3.3.9 dtx-seata-demo-bank2</h5> 
<p>dtx-seata-demo-bank2实现如下功能：<br> 1、李四账户增加金额。<br> dtx-seata-demo-bank2在本账号事务中作为分支事务不使用@GlobalTransactional。<br> （1）DAO</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Mapper</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccountInfoDao</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//更新账户</span>
    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">"UPDATE account_info SET account_balance = account_balance + #{amount} WHERE account_no = #{accountNo}"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">updateAccountBalance</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"accountNo"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>（2）Service</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountInfoServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AccountInfoService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoDao</span> accountInfoDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateAccountBalance</span><span class="token punctuation">(</span><span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank2 service begin,XID：{}"</span><span class="token punctuation">,</span><span class="token class-name">RootContext</span><span class="token punctuation">.</span><span class="token function">getXID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//李四增加金额</span>
        accountInfoDao<span class="token punctuation">.</span><span class="token function">updateAccountBalance</span><span class="token punctuation">(</span>accountNo<span class="token punctuation">,</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>amount<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//人为制造异常</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"bank2 make exception.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（3）Controller</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Bank2Controller</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoService</span> accountInfoService<span class="token punctuation">;</span>

    <span class="token comment">//接收张三的转账</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/transfer"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//李四增加金额</span>
        accountInfoService<span class="token punctuation">.</span><span class="token function">updateAccountBalance</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">,</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"bank2"</span><span class="token operator">+</span>amount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="3310__558"></a>3.3.10 测试场景</h5> 
<ul><li>张三向李四转账成功。</li><li>李四事务失败，张三事务回滚成功。</li><li>张三事务失败，李四事务回滚成功。</li><li>分支事务超时测试。</li></ul> 
<h5><a id="34_565"></a>3.4.小结</h5> 
<p>本节讲解了传统2PC（基于数据库XA协议）和Seata实现2PC的两种2PC方案，由于Seata的0侵入性并且解决了传统2PC长期锁资源的问题，所以推荐采用Seata实现2PC。<br> Seata实现2PC要点：</p> 
<ul><li>1、全局事务开始使用 @GlobalTransactional标识 。</li><li>2、每个本地事务方案仍然使用@Transactional标识。</li><li>3、每个数据都需要创建undo_log表，此表是seata保证本地事务一致性的关键。</li></ul> 
<h3><a id="4TCC_573"></a>4.分布式事务解决方案之TCC</h3> 
<h4><a id="41TCC_575"></a>4.1.什么是TCC事务</h4> 
<p>TCC是Try、Confirm、Cancel三个词语的缩写，TCC要求每个分支事务实现三个操作：预处理Try、确认Confirm、撤销Cancel。Try操作做业务检查及资源预留，Confirm做业务确认操作，Cancel实现一个与Try相反的操作即回滚操作。TM首先发起所有的分支事务的try操作，任何一个分支事务的try操作执行失败，TM将会发起所有分支事务的Cancel操作，若try操作全部成功，TM将会发起所有分支事务的Confirm操作，其中Confirm/Cancel操作若执行失败，TM会进行重试。<br> <img src="https://images2.imgbox.com/ca/7f/1YIzTkvI_o.png" alt="image.png"><br> 分支事务失败的情况：<br> <img src="https://images2.imgbox.com/22/e2/KZbsOBKR_o.png" alt="image.png"><br> TCC分为三个阶段：</p> 
<ol><li>**Try **阶段是做业务检查(一致性)及资源预留(隔离)，此阶段仅是一个初步操作，它和后续的Confirm 一起才能真正构成一个完整的业务逻辑。2</li><li>**Confirm **阶段是做确认提交，Try阶段所有分支事务执行成功后开始执行 Confirm。通常情况下，采用TCC则认为 Confirm阶段是不会出错的。即：只要Try成功，Confirm一定成功。若Confirm阶段真的出错了，需引入重试机制或人工处理。</li><li>**Cancel **阶段是在业务执行错误需要回滚的状态下执行分支事务的业务取消，预留资源释放。通常情况下，采用TCC则认为Cancel阶段也是一定成功的。若Cancel阶段真的出错了，需引入重试机制或人工处理。</li><li>TM事务管理器：TM事务管理器可以实现为独立的服务，也可以让<strong>全局事务发起方</strong>充当TM的角色，TM独立出来是为了成为公用组件，是为了考虑系统结构和软件复用。</li></ol> 
<p>TM在发起全局事务时生成全局事务记录，全局事务ID贯穿整个分布式事务调用链条，用来记录事务上下文，追踪和记录状态，由于Confirm 和cancel失败需进行重试，因此需要实现为幂等，幂等性是指同一个操作无论请求多少次，其结果都相同。</p> 
<h4><a id="42TCC__590"></a>4.2.TCC 解决方案</h4> 
<p>目前市面上的TCC框架众多比如下面这几种：（以下数据采集日为2019年07月11日）</p> 
<table><thead><tr><th><strong>框架名称</strong></th><th><strong>Gitbub地址</strong></th><th><strong>star数量</strong></th></tr></thead><tbody><tr><td>tcc-transaction</td><td><a href="https://github.com/changmingxie/tcc-transaction">https://github.com/changmingxie/tcc-transaction</a></td><td>3850</td></tr><tr><td>Hmily</td><td><a href="https://github.com/yu199195/hmily">https://github.com/yu199195/hmily</a></td><td>2407</td></tr><tr><td>ByteTCC</td><td><a href="https://github.com/liuyangming/ByteTCC">https://github.com/liuyangming/ByteTCC</a></td><td>1947</td></tr><tr><td>EasyTransaction</td><td><a href="https://github.com/QNJR-GROUP/EasyTransaction">https://github.com/QNJR-GROUP/EasyTransaction</a></td><td>1690</td></tr></tbody></table> 
<p>上一节所讲的Seata也支持TCC，但Seata的TCC模式对Spring Cloud并没有提供支持。我们的目标是理解TCC的原理以及事务协调运作的过程，因此更请倾向于轻量级易于理解的框架，因此最终确定了Hmily。</p> 
<p>Hmily是一个高性能分布式事务TCC开源框架。基于Java语言来开发（JDK1.8），支持Dubbo，Spring Cloud等RPC框架进行分布式事务。它目前支持以下特性：</p> 
<ul><li>支持嵌套事务(Nested transaction support).</li><li>采用disruptor框架进行事务日志的异步读写，与RPC框架的性能毫无差别。支持SpringBoot-starter 项目启动，使用简单。</li><li>RPC框架支持 : dubbo,motan,springcloud。</li><li>本地事务存储支持 : redis,mongodb,zookeeper,file,mysql。事务日志序列化支持 ：java，hessian，kryo，protostuff。</li><li>采用Aspect AOP 切面思想与Spring无缝集成，天然支持集群。</li><li>RPC事务恢复，超时异常恢复等。</li></ul> 
<p>Hmily利用AOP对参与分布式事务的本地方法与远程方法进行拦截处理，通过多方拦截，事务参与者能透明的调用到另一方的Try、Confirm、Cancel方法；传递事务上下文；并记录事务日志，酌情进行补偿，重试等。<br> Hmily不需要事务协调服务，但需要提供一个数据库(mysql/mongodb/zookeeper/redis/file)来进行日志存储。<br> Hmily实现的TCC服务与普通的服务一样，只需要暴露一个接口，也就是它的Try业务。Confirm/Cancel业务逻辑，只是因为全局事务提交/回滚的需要才提供的，因此Confirm/Cancel业务只需要被Hmily TCC事务框架发现即可，不需要被调用它的其他业务服务所感知。<br> 官网介绍：<a href="https://dromara.org/website/zh-cn/docs/hmily/index.html" rel="nofollow">https://dromara.org/website/zh-cn/docs/hmily/index.html</a></p> 
<p><strong>TCC需要注意三种异常处理分别是空回滚、幂等、悬挂:</strong></p> 
<p><strong>空回滚</strong>：</p> 
<ul><li><strong>现象</strong>：在没有调用 TCC 资源 Try 方法的情况下，调用了二阶段的 Cancel 方法，Cancel 方法需要识别出这是一个空回滚，然后直接返回成功。</li><li><strong>出现原因</strong>：是当一个分支事务所在服务宕机或网络异常，分支事务调用记录为失败，这个时候其实是没有执行Try阶段，当故障恢复后，分布式事务进行回滚则会调用二阶段的Cancel方法，从而形成空回滚。</li><li><strong>解决思路</strong>：关键就是要识别出这个空回滚。思路很简单就是需要知道一阶段是否执行，如果执行了，那就是正常回滚；如果没执行，那就是空回滚。前面已经说过TM在发起全局事务时生成全局事务记录，全局事务ID贯穿整个分布式事务调用链条。再额外增加一张分支事务记录表，其中有全局事务 ID 和分支事务 ID，第一阶段 Try 方法里会插入一条记录，表示一阶段执行了。Cancel 接口里读取该记录，如果该记录存在，则正常回滚；如果该记录不存在，则是空回滚。</li></ul> 
<p><strong>幂等</strong>：</p> 
<ul><li>通过前面介绍已经了解到，为了保证TCC二阶段提交重试机制不会引发数据不一致，要求 TCC 的二阶段 Try、Confirm 和 Cancel 接口保证幂等，这样不会重复使用或者释放资源。如果幂等控制没有做好，很有可能导致数据不一致等严重问题。</li><li>解决思路在上述“分支事务记录”中增加执行状态，每次执行前都查询该状态。</li></ul> 
<p><strong>悬挂</strong>：</p> 
<ul><li>悬挂就是对于一个分布式事务，其二阶段 Cancel 接口比 Try 接口先执行。</li><li><strong>出现原因</strong>：是在 RPC 调用分支事务try时，先注册分支事务，再执行RPC调用，如果此时 RPC 调用的网络发生拥堵，通常 RPC 调用是有超时时间的，RPC 超时以后，TM就会通知RM回滚该分布式事务，可能回滚完成后，RPC 请求才到达参与者真正执行，而一个 Try 方法预留的业务资源，只有该分布式事务才能使用，该分布式事务第一阶段预留的业务资源就再也没有人能够处理了，对于这种情况，我们就称为悬挂，即业务资源预留后没法继续处理。</li><li><strong>解决思路</strong>：如果二阶段执行完成，那一阶段就不能再继续执行。在执行一阶段事务时判断在该全局事务下，“分支事务记录”表中是否已经有二阶段事务记录，如果有则不执行Try。</li></ul> 
<p><strong>举例，场景为 A 转账 30 元给 B，A和B账户在不同的服务。</strong><br> <strong>方案1</strong>：</p> 
<pre><code class="prism language-java"><span class="token keyword">try</span>：
	检查余额是否够<span class="token number">30</span>元扣减<span class="token number">30</span>元

confirm：
    空
    
cancel：
	增加<span class="token number">30</span>元
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">try</span>：
	增加<span class="token number">30</span>元
confirm：
	空
cancel：
	减少<span class="token number">30</span>元
</code></pre> 
<p><strong>方案1说明：</strong><br> 1）账户A，这里的余额就是所谓的业务资源，按照前面提到的原则，在第一阶段需要检查并预留业务资源，因此，我们在扣钱 TCC 资源的 Try 接口里先检查 A 账户余额是否足够，如果足够则扣除 30 元。 Confirm 接口表示正式提交，由于业务资源已经在 Try 接口里扣除掉了，那么在第二阶段的 Confirm 接口里可以什么都不用做。Cancel接口的执行表示整个事务回滚，账户A回滚则需要把 Try 接口里扣除掉的 30 元还给账户。<br> 2）账号B，在第一阶段 Try 接口里实现给账户B加钱，Cancel 接口的执行表示整个事务回滚，账户B回滚则需要把Try 接口里加的 30 元再减去。<br> <strong>方案1的问题分析：</strong><br> 1）如果账户A的try没有执行在cancel则就多加了30元。<br> 2）由于try，cancel、confirm都是由单独的线程去调用，且会出现重复调用，所以都需要实现幂等。<br> 3）账号B在try中增加30元，当try执行完成后可能会其它线程给消费了。<br> 4）如果账户B的try没有执行在cancel则就多减了30元。</p> 
<p><strong>问题解决：</strong><br> 1）账户A的cancel方法需要判断try方法是否执行，正常执行try后方可执行cancel。<br> 2）try，cancel、confirm方法实现幂等。<br> 3）账号B在try方法中不允许更新账户金额，在confirm中更新账户金额。<br> 4）账户B的cancel方法需要判断try方法是否执行，正常执行try后方可执行cancel。</p> 
<p><strong>优化方案</strong>：</p> 
<pre><code class="prism language-java"><span class="token keyword">try</span>：
	<span class="token keyword">try</span>幂等校验
	<span class="token keyword">try</span>悬挂处理
	检查余额是否够<span class="token number">30</span>元
    扣减<span class="token number">30</span>元

confirm：
    空

cancel：
	cancel幂等校验
    cancel空回滚处理
    增加可用余额<span class="token number">30</span>元
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">try</span>：
    空
confirm：
	confirm幂等校验
    正式增加<span class="token number">30</span>元
cancel：
    空
</code></pre> 
<h4><a id="43HmilyTCC_697"></a>4.3.Hmily实现TCC事务</h4> 
<h5><a id="431_698"></a>4.3.1.业务说明</h5> 
<p>本实例通过Hmily实现TCC分布式事务，模拟两个账户的转账交易过程。</p> 
<p>两个账户分别在不同的银行(张三在bank1、李四在bank2)，bank1、bank2是两个微服务。交易过程是，张三给李四转账指定金额。<br> 上述交易步骤，要么一起成功，要么一起失败，必须是一个整体性的事务。<br> <img src="https://images2.imgbox.com/e6/3c/I3LJOYML_o.png" alt="image.png"></p> 
<h5><a id="432_705"></a>4.3.2.程序组成部分</h5> 
<ul><li>数据库：MySQL-5.7.25</li><li>JDK：64位 jdk1.8.0_201</li><li>微服务： 
  <ul><li>spring-boot-2.1.3、</li><li>spring-cloud-Greenwich.RELEASE</li><li>Hmily：hmily-springcloud.2.0.4-RELEASE</li></ul> </li><li>微服务及数据库的关系 ： 
  <ul><li>dtx/dtx-tcc-demo/dtx-tcc-demo-bank1 银行1，操作张三账户， 连接数据库bank1</li><li>dtx/dtx-tcc-demo/dtx-tcc-demo-bank2 银行2，操作李四账户，连接数据库bank2</li></ul> </li><li>服务注册中心：dtx/discover-server</li></ul> 
<h5><a id="433_717"></a>4.3.3.创建数据库</h5> 
<p>导入数据库脚本：资料\sql\bank1.sql、资料\sql\bank2.sql、已经导过不用重复导入。<br> 创建hmily数据库，用于存储hmily框架记录的数据。</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token identifier"><span class="token punctuation">`</span>hmily<span class="token punctuation">`</span></span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token string">'utf8'</span> <span class="token keyword">COLLATE</span> <span class="token string">'utf8_general_ci'</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>创建bank1库，并导入以下表结构和数据(包含张三账户)</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token identifier"><span class="token punctuation">`</span>bank1<span class="token punctuation">`</span></span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token string">'utf8'</span> <span class="token keyword">COLLATE</span> <span class="token string">'utf8_general_ci'</span><span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span><span class="token punctuation">;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span>   <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_name<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'户主姓名'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_no<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'银行卡号'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_password<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span> <span class="token string">'帐户密码'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_balance<span class="token punctuation">`</span></span> <span class="token keyword">double</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'帐户余额'</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span>  <span class="token keyword">KEY</span>  <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>  <span class="token keyword">USING</span>  <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span>  <span class="token operator">=</span>  <span class="token keyword">InnoDB</span>  <span class="token keyword">AUTO_INCREMENT</span>  <span class="token operator">=</span>  <span class="token number">5</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  <span class="token operator">=</span>  utf8  <span class="token keyword">COLLATE</span>  <span class="token operator">=</span>  utf8_bin  ROW_FORMAT  <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'张三的账户'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>创建bank2库，并导入以下表结构和数据(包含李四账户)</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token identifier"><span class="token punctuation">`</span>bank2<span class="token punctuation">`</span></span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token string">'utf8'</span> <span class="token keyword">COLLATE</span> <span class="token string">'utf8_general_ci'</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span>   <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_name<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'户主姓名'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_no<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'银行卡号'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_password<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span> <span class="token string">'帐户密码'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_balance<span class="token punctuation">`</span></span> <span class="token keyword">double</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'帐户余额'</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span>  <span class="token keyword">KEY</span>  <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>  <span class="token keyword">USING</span>  <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span>  <span class="token operator">=</span>  <span class="token keyword">InnoDB</span>  <span class="token keyword">AUTO_INCREMENT</span>  <span class="token operator">=</span>  <span class="token number">5</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  <span class="token operator">=</span>  utf8  <span class="token keyword">COLLATE</span>  <span class="token operator">=</span>  utf8_bin  ROW_FORMAT  <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'李四的账户'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>每个数据库都创建try、confirm、cancel三张日志表：</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>local_try_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>tx_no<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'事务id'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>tx_no<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>  <span class="token keyword">DEFAULT</span>  <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span> 
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>local_confirm_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>tx_no<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'事务id'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>  <span class="token keyword">DEFAULT</span>  <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
 <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>local_cancel_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>tx_no<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'事务id'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>tx_no<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>  <span class="token keyword">DEFAULT</span>  <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8
</code></pre> 
<h5><a id="434_discoverserver_764"></a>4.3.4 discover-server</h5> 
<p>discover-server是服务注册中心，测试工程将自己注册至discover-server。<br> 导入：资料\基础代码\dtx 父工程，此工程自带了discover-server，discover-server基于Eureka实现。已经导过不用重复导入。</p> 
<h5><a id="435_dtxtccdemo_768"></a>4.3.5 导入案例工程dtx-tcc-demo</h5> 
<p>dtx-tcc-demo是tcc的测试工程，根据业务需求需要创建两个dtx-tcc-demo工程。<br> （1）导入dtx-tcc-demo：资料\基础代码\dtx-tcc-demo到父工程dtx下。两个测试工程如下：<br> dtx/dtx-tcc-demo/dtx-tcc-demo-bank1 银行1，操作张三账户，连接数据库bank1<br> dtx/dtx-tcc-demo/dtx-tcc-demo-bank2 银行2，操作李四账户，连接数据库bank2</p> 
<p>（2）引入maven依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.dromara<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hmily‐springcloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.4‐RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>（3）配置hmily</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">org</span><span class="token punctuation">:</span>
  <span class="token key atrule">dromara</span><span class="token punctuation">:</span>
    <span class="token key atrule">hmily</span> <span class="token punctuation">:</span>
      <span class="token key atrule">serializer</span> <span class="token punctuation">:</span> kryo
      <span class="token key atrule">recoverDelayTime</span> <span class="token punctuation">:</span> <span class="token number">30</span>
      <span class="token key atrule">retryMax</span> <span class="token punctuation">:</span> <span class="token number">30</span>
      <span class="token key atrule">scheduledDelay</span> <span class="token punctuation">:</span> <span class="token number">30</span>
      <span class="token key atrule">scheduledThreadMax</span> <span class="token punctuation">:</span>  <span class="token number">10</span>
      <span class="token key atrule">repositorySupport</span> <span class="token punctuation">:</span> db
      <span class="token key atrule">started</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">hmilyDbConfig</span> <span class="token punctuation">:</span>
        <span class="token key atrule">driverClassName</span>  <span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">url</span> <span class="token punctuation">:</span>  jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/hmily<span class="token punctuation">?</span>useUnicode=true
        <span class="token key atrule">username</span> <span class="token punctuation">:</span> root
        <span class="token key atrule">password</span> <span class="token punctuation">:</span> mysql
</code></pre> 
<p>新增配置类接收application.yml中的Hmily配置信息，并创建HmilyTransactionBootstrap：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">HmilyTransactionBootstrap</span> <span class="token function">hmilyTransactionBootstrap</span><span class="token punctuation">(</span><span class="token class-name">HmilyInitService</span> hmilyInitService<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">HmilyTransactionBootstrap</span> hmilyTransactionBootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HmilyTransactionBootstrap</span><span class="token punctuation">(</span>hmilyInitService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        hmilyTransactionBootstrap<span class="token punctuation">.</span><span class="token function">setSerializer</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"org.dromara.hmily.serializer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hmilyTransactionBootstrap<span class="token punctuation">.</span><span class="token function">setRecoverDelayTime</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"org.dromara.hmily.recoverDelayTime"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hmilyTransactionBootstrap<span class="token punctuation">.</span><span class="token function">setRetryMax</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"org.dromara.hmily.retryMax"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hmilyTransactionBootstrap<span class="token punctuation">.</span><span class="token function">setScheduledDelay</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"org.dromara.hmily.scheduledDelay"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hmilyTransactionBootstrap<span class="token punctuation">.</span><span class="token function">setScheduledThreadMax</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"org.dromara.hmily.scheduledThreadMax"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hmilyTransactionBootstrap<span class="token punctuation">.</span><span class="token function">setRepositorySupport</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"org.dromara.hmily.repositorySupport"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hmilyTransactionBootstrap<span class="token punctuation">.</span><span class="token function">setStarted</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"org.dromara.hmily.started"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HmilyDbConfig</span> hmilyDbConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HmilyDbConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hmilyDbConfig<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"org.dromara.hmily.hmilyDbConfig.driverClassName"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hmilyDbConfig<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"org.dromara.hmily.hmilyDbConfig.url"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hmilyDbConfig<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"org.dromara.hmily.hmilyDbConfig.username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hmilyDbConfig<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"org.dromara.hmily.hmilyDbConfig.password"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hmilyTransactionBootstrap<span class="token punctuation">.</span><span class="token function">setHmilyDbConfig</span><span class="token punctuation">(</span>hmilyDbConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> hmilyTransactionBootstrap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>启动类增加@EnableAspectJAutoProxy并增加org.dromara.hmily的扫描项：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableHystrix</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"cn.itcast.dtx.tccdemo.bank1.spring"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"cn.itcast.dtx.tccdemo.bank1"</span><span class="token punctuation">,</span><span class="token string">"org.dromara.hmily"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Bank1TccServer</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Bank1TccServer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="436_dtxtccdemobank1_839"></a>4.3.6 dtx-tcc-demo-bank1</h5> 
<p>dtx-tcc-demo-bank1实现try和cancel方法，如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">try</span>：
    <span class="token keyword">try</span>幂等校验
    <span class="token keyword">try</span>悬挂处理
    检查余额是够扣减金额扣减金额

confirm：
	空cancel：
cancel
    幂等校验
    cancel空回滚处理增加可用余额
</code></pre> 
<p>1）Dao</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Mapper</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccountInfoDao</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">"update account_info set account_balance=account_balance - #{amount} where account_balance&gt;=#{amount} and account_no=#{accountNo} "</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">subtractAccountBalance</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"accountNo"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">"update account_info set account_balance=account_balance + #{amount} where account_no=#{accountNo} "</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">addAccountBalance</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"accountNo"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * 增加某分支事务try执行记录
     * @param localTradeNo 本地事务编号
     * @return
     */</span>
    <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token string">"insert into local_try_log values(#{txNo},now());"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">addTry</span><span class="token punctuation">(</span><span class="token class-name">String</span> localTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token string">"insert into local_confirm_log values(#{txNo},now());"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">addConfirm</span><span class="token punctuation">(</span><span class="token class-name">String</span> localTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token string">"insert into local_cancel_log values(#{txNo},now());"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">addCancel</span><span class="token punctuation">(</span><span class="token class-name">String</span> localTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 查询分支事务try是否已执行
     * @param localTradeNo 本地事务编号
     * @return
     */</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select count(1) from local_try_log where tx_no = #{txNo} "</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">isExistTry</span><span class="token punctuation">(</span><span class="token class-name">String</span> localTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 查询分支事务confirm是否已执行
     * @param localTradeNo 本地事务编号
     * @return
     */</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select count(1) from local_confirm_log where tx_no = #{txNo} "</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">isExistConfirm</span><span class="token punctuation">(</span><span class="token class-name">String</span> localTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 查询分支事务cancel是否已执行
     * @param localTradeNo 本地事务编号
     * @return
     */</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select count(1) from local_cancel_log where tx_no = #{txNo} "</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">isExistCancel</span><span class="token punctuation">(</span><span class="token class-name">String</span> localTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>2）Service层</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountInfoServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AccountInfoService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoDao</span> accountInfoDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">Bank2Client</span> bank2Client<span class="token punctuation">;</span>

    <span class="token comment">// 账户扣款，就是tcc的try方法</span>

    <span class="token comment">/**
     * 	try幂等校验
     * 	try悬挂处理
     * 	检查余额是够扣减金额
     * 	扣减金额
     * @param accountNo
     * @param amount
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token comment">//只要标记@Hmily就是try方法，在注解中指定confirm、cancel两个方法的名字</span>
    <span class="token annotation punctuation">@Hmily</span><span class="token punctuation">(</span>confirmMethod<span class="token operator">=</span><span class="token string">"commit"</span><span class="token punctuation">,</span>cancelMethod<span class="token operator">=</span><span class="token string">"rollback"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateAccountBalance</span><span class="token punctuation">(</span><span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取全局事务id</span>
        <span class="token class-name">String</span> transId <span class="token operator">=</span> <span class="token class-name">HmilyTransactionContextLocal</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank1 try begin 开始执行...xid:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//幂等判断 判断local_try_log表中是否有try日志记录，如果有则不再执行</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>accountInfoDao<span class="token punctuation">.</span><span class="token function">isExistTry</span><span class="token punctuation">(</span>transId<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank1 try 已经执行，无需重复执行,xid:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//try悬挂处理，如果cancel、confirm有一个已经执行了，try不再执行</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>accountInfoDao<span class="token punctuation">.</span><span class="token function">isExistConfirm</span><span class="token punctuation">(</span>transId<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">||</span> accountInfoDao<span class="token punctuation">.</span><span class="token function">isExistCancel</span><span class="token punctuation">(</span>transId<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank1 try悬挂处理  cancel或confirm已经执行，不允许执行try,xid:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//扣减金额</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>accountInfoDao<span class="token punctuation">.</span><span class="token function">subtractAccountBalance</span><span class="token punctuation">(</span>accountNo<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//扣减失败</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"bank1 try 扣减金额失败,xid:{}"</span><span class="token operator">+</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//插入try执行记录,用于幂等判断</span>
        accountInfoDao<span class="token punctuation">.</span><span class="token function">addTry</span><span class="token punctuation">(</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//远程调用李四，转账</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bank2Client<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"bank1 远程调用李四微服务失败,xid:{}"</span><span class="token operator">+</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>amount <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"人为制造异常,xid:{}"</span><span class="token operator">+</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank1 try end 结束执行...xid:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//confirm方法</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取全局事务id</span>
        <span class="token class-name">String</span> transId <span class="token operator">=</span> <span class="token class-name">HmilyTransactionContextLocal</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank1 confirm begin 开始执行...xid:{},accountNo:{},amount:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">,</span>accountNo<span class="token punctuation">,</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token comment">/** cancel方法
     * 	cancel幂等校验
     * 	cancel空回滚处理
     * 	增加可用余额
     * @param accountNo
     * @param amount
     */</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取全局事务id</span>
        <span class="token class-name">String</span> transId <span class="token operator">=</span> <span class="token class-name">HmilyTransactionContextLocal</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank1 cancel begin 开始执行...xid:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//	cancel幂等校验</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>accountInfoDao<span class="token punctuation">.</span><span class="token function">isExistCancel</span><span class="token punctuation">(</span>transId<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank1 cancel 已经执行，无需重复执行,xid:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//cancel空回滚处理，如果try没有执行，cancel不允许执行</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>accountInfoDao<span class="token punctuation">.</span><span class="token function">isExistTry</span><span class="token punctuation">(</span>transId<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank1 空回滚处理，try没有执行，不允许cancel执行,xid:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//	增加可用余额</span>
        accountInfoDao<span class="token punctuation">.</span><span class="token function">addAccountBalance</span><span class="token punctuation">(</span>accountNo<span class="token punctuation">,</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//插入一条cancel的执行记录</span>
        accountInfoDao<span class="token punctuation">.</span><span class="token function">addCancel</span><span class="token punctuation">(</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank1 cancel end 结束执行...xid:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>3）feignClient</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"tcc-demo-bank2"</span><span class="token punctuation">,</span>fallback<span class="token operator">=</span><span class="token class-name">Bank2ClientFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Bank2Client</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//远程调用bank2微服务</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/bank2/transfer"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Hmily</span> <span class="token comment">// 作用：将当前全局事务的信息带给远程调用的服务</span>
    <span class="token keyword">public</span>  <span class="token class-name">Boolean</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>Controller</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Bank1Controller</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoService</span> accountInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/transfer"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accountInfoService<span class="token punctuation">.</span><span class="token function">updateAccountBalance</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="437_dtxtccdemobank2_1033"></a>4.3.7 dtx-tcc-demo-bank2</h5> 
<p>dtx-tcc-demo-bank2实现如下功能：</p> 
<pre><code class="prism language-java"><span class="token keyword">try</span>：
	空
confirm：
	confirm幂等校验正式
    增加金额
cancel：
	空
</code></pre> 
<p>1）Dao</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccountInfoDao</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">"update account_info set account_balance=account_balance + #{amount} where  account_no=#{accountNo} "</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">addAccountBalance</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"accountNo"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 增加某分支事务try执行记录
     * @param localTradeNo 本地事务编号
     * @return
     */</span>
    <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token string">"insert into local_try_log values(#{txNo},now());"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">addTry</span><span class="token punctuation">(</span><span class="token class-name">String</span> localTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token string">"insert into local_confirm_log values(#{txNo},now());"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">addConfirm</span><span class="token punctuation">(</span><span class="token class-name">String</span> localTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token string">"insert into local_cancel_log values(#{txNo},now());"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">addCancel</span><span class="token punctuation">(</span><span class="token class-name">String</span> localTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 查询分支事务try是否已执行
     * @param localTradeNo 本地事务编号
     * @return
     */</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select count(1) from local_try_log where tx_no = #{txNo} "</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">isExistTry</span><span class="token punctuation">(</span><span class="token class-name">String</span> localTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 查询分支事务confirm是否已执行
     * @param localTradeNo 本地事务编号
     * @return
     */</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select count(1) from local_confirm_log where tx_no = #{txNo} "</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">isExistConfirm</span><span class="token punctuation">(</span><span class="token class-name">String</span> localTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 查询分支事务cancel是否已执行
     * @param localTradeNo 本地事务编号
     * @return
     */</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select count(1) from local_cancel_log where tx_no = #{txNo} "</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">isExistCancel</span><span class="token punctuation">(</span><span class="token class-name">String</span> localTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2）Service</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountInfoServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AccountInfoService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoDao</span> accountInfoDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Hmily</span><span class="token punctuation">(</span>confirmMethod<span class="token operator">=</span><span class="token string">"confirmMethod"</span><span class="token punctuation">,</span> cancelMethod<span class="token operator">=</span><span class="token string">"cancelMethod"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateAccountBalance</span><span class="token punctuation">(</span><span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取全局事务id</span>
        <span class="token class-name">String</span> transId <span class="token operator">=</span> <span class="token class-name">HmilyTransactionContextLocal</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank2 try begin 开始执行...xid:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * confirm方法
     * 	confirm幂等校验
     * 	正式增加金额
     * @param accountNo
     * @param amount
     */</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirmMethod</span><span class="token punctuation">(</span><span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取全局事务id</span>
        <span class="token class-name">String</span> transId <span class="token operator">=</span> <span class="token class-name">HmilyTransactionContextLocal</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank2 confirm begin 开始执行...xid:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>accountInfoDao<span class="token punctuation">.</span><span class="token function">isExistConfirm</span><span class="token punctuation">(</span>transId<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank2 confirm 已经执行，无需重复执行...xid:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//增加金额</span>
        accountInfoDao<span class="token punctuation">.</span><span class="token function">addAccountBalance</span><span class="token punctuation">(</span>accountNo<span class="token punctuation">,</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//增加一条confirm日志，用于幂等</span>
        accountInfoDao<span class="token punctuation">.</span><span class="token function">addConfirm</span><span class="token punctuation">(</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank2 confirm end 结束执行...xid:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token comment">/**
     * @param accountNo
     * @param amount
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancelMethod</span><span class="token punctuation">(</span><span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取全局事务id</span>
        <span class="token class-name">String</span> transId <span class="token operator">=</span> <span class="token class-name">HmilyTransactionContextLocal</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank2 cancel begin 开始执行...xid:{}"</span><span class="token punctuation">,</span>transId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3）Controller</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Bank2Controller</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoService</span> accountInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/transfer"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accountInfoService<span class="token punctuation">.</span><span class="token function">updateAccountBalance</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="438__1159"></a>4.3.8 测试场景</h5> 
<ul><li>张三向李四转账成功。</li><li>李四事务失败，张三事务回滚成功。</li><li>张三事务失败，李四分支事务回滚成功。</li><li>分支事务超时测试。</li></ul> 
<h4><a id="44_1167"></a>4.4.小结</h4> 
<p>如果拿TCC事务的处理流程与2PC两阶段提交做比较，2PC通常都是在跨库的DB层面，而TCC则在应用层面的处理，需要通过业务逻辑来实现。这种分布式事务的实现方式的优势在于，可以让<strong>应用自己定义数据操作的粒度，使得降低锁冲突、提高吞吐量成为可能</strong>。</p> 
<p>而不足之处则在于对应用的侵入性非常强，业务逻辑的每个分支都需要实现try、confirm、cancel三个操作。此外，其实现难度也比较大，需要按照网络状态、系统故障等不同的失败原因实现不同的回滚策略。</p> 
<h3><a id="5_1173"></a>5.分布式事务解决方案之可靠消息最终一致性</h3> 
<h4><a id="51_1174"></a>5.1.什么是可靠消息最终一致性事务</h4> 
<p>可靠消息最终一致性方案是指当事务发起方执行完成本地事务后并发出一条消息，事务参与方(消息消费者)一定能够接收消息并处理事务成功，此方案强调的是只要消息发给事务参与方最终事务要达到一致。<br> 此方案是利用消息中间件完成，如下图：</p> 
<p>事务发起方（消息生产方）将消息发给消息中间件，事务参与方从消息中间件接收消息，事务发起方和消息中间件之间，事务参与方（消息消费方）和消息中间件之间都是通过网络通信，由于网络通信的不确定性会导致分布式事务问题。<br> <img src="https://images2.imgbox.com/5e/27/jnqXZAVR_o.png" alt="image.png"><br> 因此可靠消息最终一致性方案要解决以下几个问题：<br> <strong>1.本地事务与消息发送的原子性问题</strong><br> 本地事务与消息发送的原子性问题即：事务发起方在本地事务执行成功后消息必须发出去，否则就丢弃消息。即实现本地事务和消息发送的原子性，要么都成功，要么都失败。本地事务与消息发送的原子性问题是实现可靠消息最终一致性方案的关键问题。</p> 
<p>先来尝试下这种操作，先发送消息，再操作数据库：</p> 
<pre><code class="prism language-java">begin transaction；
<span class="token comment">//1.发送MQ</span>
<span class="token comment">//2.数据库操作</span>
commit transation<span class="token punctuation">;</span>
</code></pre> 
<p>这种情况下无法保证数据库操作与发送消息的一致性，因为可能发送消息成功，数据库操作失败。你立马想到第二种方案，先进行数据库操作，再发送消息：</p> 
<pre><code class="prism language-java">begin transaction；
<span class="token comment">//1.数据库操作</span>
<span class="token comment">//2.发送MQ</span>
commit transation<span class="token punctuation">;</span>
</code></pre> 
<p>这种情况下貌似没有问题，如果发送MQ消息失败，就会抛出异常，导致数据库事务回滚。但如果是超时异常，数据库回滚，但MQ其实已经正常发送了，同样会导致不一致。</p> 
<p><strong>2、事务参与方接收消息的可靠性</strong><br> 事务参与方必须能够从消息队列接收到消息，如果接收消息失败可以重复接收消息。</p> 
<p><strong>3、消息重复消费的问题</strong><br> 由于网络2的存在，若某一个消费节点超时但是消费成功，此时消息中间件会重复投递此消息，就导致了消息的重复消费。要解决消息重复消费的问题就要实现事务参与方的方法幂等性。</p> 
<h4><a id="52_1207"></a>5.2.解决方案</h4> 
<p>上节讨论了可靠消息最终一致性事务方案需要解决的问题，本节讨论具体的解决方案。</p> 
<h5><a id="521_1211"></a>5.2.1.本地消息表方案</h5> 
<p>本地消息表这个方案最初是eBay提出的，此方案的核心是通过本地事务保证数据业务操作和消息的一致性，然后通过定时任务将消息发送至消息中间件，待确认消息发送给消费方成功再将消息删除。</p> 
<p>下面以注册送积分为例来说明：</p> 
<p>下例共有两个微服务交互，用户服务和积分服务，用户服务负责添加用户，积分服务负责增加积分。<br> <img src="https://images2.imgbox.com/90/39/hEBC8SD6_o.png" alt="image.png"><br> 交互流程如下：<br> **1、用户注册：**用户服务在本地事务新增用户和增加 ”积分消息日志“。（用户表和消息表通过本地事务保证一致）下边是伪代码</p> 
<pre><code class="prism language-java">begin transaction；
<span class="token comment">//1.新增用户</span>
<span class="token comment">//2.存储积分消息日志</span>
commit transation<span class="token punctuation">;</span>
</code></pre> 
<p>这种情况下，本地数据库操作与存储积分消息日志处于同一个事务中，本地数据库操作与记录消息日志操作具备原子性。</p> 
<p><strong>2、定时任务扫描日志</strong><br> 如何保证将消息发送给消息队列呢？<br> 经过第一步消息已经写到消息日志表中，可以启动独立的线程，定时对消息日志表中的消息进行扫描并发送至消息中间件，在消息中间件反馈发送成功后删除该消息日志，否则等待定时任务下一周期重试。<br> <strong>3、消费消息</strong><br> 如何保证消费者一定能消费到消息呢？<br> 这里可以使用MQ的ack（即消息确认）机制，消费者监听MQ，如果消费者接收到消息并且业务处理完成后向MQ发送ack（即消息确认），此时说明消费者正常消费消息完成，MQ将不再向消费者推送消息，否则消费者会不断重试向消费者来发送消息。<br> 积分服务接收到”增加积分“消息，开始增加积分，积分增加成功后向消息中间件回应ack，否则消息中间件将重复投递此消息。</p> 
<p>由于消息会重复投递，积分服务的”增加积分“功能需要实现幂等性。</p> 
<h5><a id="522RocketMQ_1239"></a>5.2.2.RocketMQ事务消息方案</h5> 
<p>RocketMQ 是一个来自阿里巴巴的分布式消息中间件，于 2012 年开源，并在 2017 年正式成为 Apache 顶级项目。据了解，包括阿里云上的消息产品以及收购的子公司在内，阿里集团的消息产品全线都运行在 RocketMQ 之<br> 上，并且最近几年的双十一大促中，RocketMQ 都有抢眼表现。Apache RocketMQ 4.3之后的版本正式支持事务消息，为分布式事务实现提供了便利性支持。<br> RocketMQ 事务消息设计则主要是为了解决 Producer 端的消息发送与本地事务执行的原子性问题，RocketMQ 的设计中 broker 与 producer 端的双向通信能力，使得 broker 天生可以作为一个事务协调者存在；而 RocketMQ<br> 本身提供的存储机制为事务消息提供了持久化能力；RocketMQ 的高可用机制以及可靠消息设计则为事务消息在系统发生异常时依然能够保证达成事务的最终一致性。</p> 
<p>在RocketMQ 4.3后实现了完整的事务消息，实际上其实是对本地消息表的一个封装，将本地消息表移动到了MQ内部，解决 Producer 端的消息发送与本地事务执行的原子性问题。<br> <img src="https://images2.imgbox.com/73/9a/3p3HRzwq_o.png" alt="image.png"><br> 为方便理解我们还以注册送积分的例子来描述整个流程。<br> Producer 即MQ发送方，本例中是用户服务，负责新增用户。MQ订阅方即消息消费方，本例中是积分服务，负责新增积分。<br> 执行流程如下：</p> 
<ul><li>1、Producer 发送事务消息：Producer （MQ发送方）发送事务消息至MQ Server，MQ Server将消息状态标记为Prepared（预备状态），注意此时这条消息消费者（MQ订阅方）是无法消费到的。本例中，Producer 发送 ”增加积分消息“ 到MQ Server。</li><li>2、MQ Server回应消息发送成功MQ Server接收到Producer 发送给的消息则回应发送成功表示MQ已接收到消息。</li><li>3、Producer 执行本地事务Producer 端执行业务代码逻辑，通过本地数据库事务控制。本例中，Producer 执行添加用户操作。</li><li>4、消息投递若Producer 本地事务执行成功则自动向MQServer发送commit消息，MQ Server接收到commit消息后将”增加积分消息“ 状态标记为可消费，此时MQ订阅方（积分服务）即正常消费消息；若Producer 本地事务执行失败则自动向MQServer发送rollback消息，MQ Server接收到rollback消息后 将删除”增加积分消息“ 。MQ订阅方（积分服务）消费消息，消费成功则向MQ回应ack，否则将重复接收消息。这里ack默认自动回应，即程序执行正常则自动回应ack。</li><li>5、事务回查 
  <ul><li>如果执行Producer端本地事务过程中，执行端挂掉，或者超时，MQ Server将会不停的询问同组的其他 Producer来获取事务执行状态，这个过程叫<strong>事务回查</strong>。MQ Server会根据事务回查结果来决定是否投递消息。</li><li>以上主干流程已由RocketMQ实现，对用户侧来说，用户需要分别实现本地事务执行以及本地事务回查方法，因此只需关注本地事务的执行状态即可。RoacketMQ提供RocketMQLocalTransactionListener接口：</li></ul> </li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RocketMQLocalTransactionListener</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
    ‐ 发送prepare消息成功此方法被回调，该方法用于执行本地事务
    ‐ @param msg 回传的消息，利用transactionId即可获取到该消息的唯一Id
    ‐ @param arg 调用send方法时传递的参数，当send时候若有额外的参数可以传递到send方法中，这里能获取到‐  @return  返回事务状态，COMMIT：提交  ROLLBACK：回滚  UNKNOW：回调
    */</span>
    <span class="token class-name">RocketMQLocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/**
    ‐ @param msg 通过获取transactionId来判断这条消息的本地事务执行状态‐  @return  返回事务状态，COMMIT：提交  ROLLBACK：回滚  UNKNOW：回调
    */</span>
    <span class="token class-name">RocketMQLocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>发送事务消息：以下是RocketMQ提供用于发送事务消息的API：</li></ul> 
<pre><code class="prism language-java"><span class="token class-name">TransactionMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionMQProducer</span><span class="token punctuation">(</span><span class="token string">"ProducerGroup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置TransactionListener实现producer.setTransactionListener(transactionListener）；</span>
<span class="token comment">//发送事务消息</span>
<span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="53RocketMQ_1285"></a>5.3.RocketMQ实现可靠消息最终一致性事务</h4> 
<h5><a id="531_1287"></a>5.3.1.业务说明</h5> 
<p>本实例通过RocketMQ中间件实现可靠消息最终一致性分布式事务，模拟两个账户的转账交易过程。</p> 
<p>两个账户在分别在不同的银行(张三在bank1、李四在bank2)，bank1、bank2是两个微服务。交易过程是，张三给李四转账指定金额。</p> 
<p>上述交易步骤，张三扣减金额与给bank2发转账消息，两个操作必须是一个整体性的事务。<br> <img src="https://images2.imgbox.com/13/48/ROXyIJ2K_o.png" alt="image.png"></p> 
<h5><a id="532_1295"></a>5.3.2.程序组成部分</h5> 
<p>本示例程序组成部分如下：</p> 
<ul><li>数据库：MySQL-5.7.25，包括bank1和bank2两个数据库。</li><li>JDK：64位 jdk1.8.0_201</li><li>rocketmq 服务端：RocketMQ-4.5.0</li><li>rocketmq 客户端：RocketMQ-Spring-Boot-starter.2.0.2-RELEASE</li><li>微服务框架：spring-boot-2.1.3、spring-cloud-Greenwich.RELEASE</li><li>微服务及数据库的关系 ： 
  <ul><li>dtx/dtx-txmsg-demo/dtx-txmsg-demo-bank1 银行1，操作张三账户， 连接数据库bank1</li><li>dtx/dtx-txmsg-demo/dtx-txmsg-demo-bank2 银行2，操作李四账户，连接数据库bank2</li></ul> </li></ul> 
<p>本示例程序技术架构如下：<br> <img src="https://images2.imgbox.com/be/53/Jav4UbJa_o.png" alt="image.png"><br> 交互流程如下：</p> 
<ul><li>1、Bank1向MQ Server发送转账消息</li><li>2、Bank1执行本地事务，扣减金额</li><li>3、Bank2接收消息，执行本地事务，添加金额</li></ul> 
<h5><a id="533_1316"></a>5.3.3.创建数据库</h5> 
<p>导入数据库脚本：资料\sql\bank1.sql、资料\sql\bank2.sql，已经导过不用重复导入。<br> <strong>创建bank1库，并导入以下表结构和数据(包含张三账户)</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token identifier"><span class="token punctuation">`</span>bank1<span class="token punctuation">`</span></span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token string">'utf8'</span> <span class="token keyword">COLLATE</span> <span class="token string">'utf8_general_ci'</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span><span class="token punctuation">;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span>   <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_name<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'户主姓名'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_no<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'银行卡号'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_password<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span> <span class="token string">'帐户密码'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_balance<span class="token punctuation">`</span></span> <span class="token keyword">double</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'帐户余额'</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span>  <span class="token keyword">KEY</span>  <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>  <span class="token keyword">USING</span>  <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span>  <span class="token operator">=</span>  <span class="token keyword">InnoDB</span>  <span class="token keyword">AUTO_INCREMENT</span>  <span class="token operator">=</span>  <span class="token number">5</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  <span class="token operator">=</span>  utf8  <span class="token keyword">COLLATE</span>  <span class="token operator">=</span>  utf8_bin  ROW_FORMAT  <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'张三的账户'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>创建bank2库，并导入以下表结构和数据(包含李四账户)</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token identifier"><span class="token punctuation">`</span>bank2<span class="token punctuation">`</span></span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token string">'utf8'</span> <span class="token keyword">COLLATE</span> <span class="token string">'utf8_general_ci'</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span>   <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_name<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'户主姓名'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_no<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'银行卡号'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_password<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span> <span class="token string">'帐户密码'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_balance<span class="token punctuation">`</span></span> <span class="token keyword">double</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'帐户余额'</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span>  <span class="token keyword">KEY</span>  <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>  <span class="token keyword">USING</span>  <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span>  <span class="token operator">=</span>  <span class="token keyword">InnoDB</span>  <span class="token keyword">AUTO_INCREMENT</span>  <span class="token operator">=</span>  <span class="token number">5</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  <span class="token operator">=</span>  utf8  <span class="token keyword">COLLATE</span>  <span class="token operator">=</span>  utf8_bin  ROW_FORMAT  <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'李四的账户'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>在bank1、bank2数据库中新增de_duplication，交易记录表(去重表)，用于交易幂等控制。</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>de_duplication<span class="token punctuation">`</span></span><span class="token punctuation">;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>de_duplication<span class="token punctuation">`</span></span>   <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>tx_no<span class="token punctuation">`</span></span>   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> 
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span>  <span class="token keyword">KEY</span>  <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>tx_no<span class="token punctuation">`</span></span><span class="token punctuation">)</span>  <span class="token keyword">USING</span>  <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span>  <span class="token operator">=</span>  <span class="token keyword">InnoDB</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  <span class="token operator">=</span>  utf8  <span class="token keyword">COLLATE</span>  <span class="token operator">=</span>  utf8_bin  ROW_FORMAT  <span class="token operator">=</span>  Dynamic<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="534RocketMQ_1358"></a>5.3.4.启动RocketMQ</h5> 
<p>（1）下载RocketMQ服务器</p> 
<p><a href="http://mirrors.tuna.tsinghua.edu.cn/apache/rocketmq/4.5.0/rocketmq-all-4.5.0-bin-release.zip" rel="nofollow">下载地址：<strong>http://mirrors.tuna.tsinghua.edu.cn/apache/rocketmq/4.5.0/rocketmq-all-4.5.0-bin-</strong></a>** **<a href="http://mirrors.tuna.tsinghua.edu.cn/apache/rocketmq/4.5.0/rocketmq-all-4.5.0-bin-release.zip" rel="nofollow"><strong>release.zip</strong></a></p> 
<p>（2）解压并启动启动nameserver:</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">set</span>  <span class="token assign-left variable">ROCKETMQ_HOME</span><span class="token operator">=</span><span class="token punctuation">[</span>rocketmq服务端解压路径<span class="token punctuation">]</span>

start <span class="token punctuation">[</span>rocketmq服务端解压路径<span class="token punctuation">]</span>/bin/mqbroker.cmd ‐n <span class="token number">127.0</span>.0.1:9876 <span class="token assign-left variable">autoCreateTopicEnable</span><span class="token operator">=</span>true
</code></pre> 
<h5><a id="535_dtxtxmsgdemo_1372"></a>5.3.5 导入dtx-txmsg-demo</h5> 
<p>dtx-txmsg-demo是本方案的测试工程，根据业务需求需要创建两个dtx-txmsg-demo工程。</p> 
<p>（1）导入dtx-txmsg-demo<br> 导入：资料\基础代码\dtx-txmsg-demo到父工程dtx下。<br> 两个测试工程如下：</p> 
<ul><li>dtx/dtx-txmsg-demo/dtx-txmsg-demo-bank1 ，操作张三账户，连接数据库bank1</li><li>dtx/dtx-txmsg-demo/dtx-txmsg-demo-bank2 ，操作李四账户，连接数据库bank2</li></ul> 
<p>（2）父工程maven依赖说明<br> 在dtx父工程中指定了SpringBoot和SpringCloud版本</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring‐boot‐dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.3.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring‐cloud‐dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>Greenwich.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>在dtx-txmsg-demo父工程中指定了rocketmq-spring-boot-starter的版本。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq‐spring‐boot‐starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>（3）配置rocketMQ<br> 在application-local.propertis中配置rocketMQ nameServer地址及生产组：</p> 
<pre><code class="prism language-properties">server.port=56081
swagger.enable = true

spring.datasource.driver-class-name = com.mysql.jdbc.Driver
spring.datasource.url = jdbc:mysql://localhost:3306/bank1?useUnicode=true
spring.datasource.username = root
spring.datasource.password = mysql

rocketmq.producer.group = producer_bank1
rocketmq.name-server = 127.0.0.1:9876

logging.level.root = info
logging.level.org.springframework.web = info
logging.level.cn.itcast.wanxintx.ensuredemo  = debug
</code></pre> 
<h5><a id="536_dtxtxmsgdemobank1_1430"></a>5.3.6 消息发送发：dtx-txmsg-demo-bank1</h5> 
<p>dtx-txmsg-demo-bank1实现如下功能：</p> 
<ul><li>1、张三扣减金额，提交本地事务。</li><li>2、向MQ发送转账消息。</li></ul> 
<p>1）Dao层</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Mapper</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccountInfoDao</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">"update account_info set account_balance=account_balance+#{amount} where account_no=#{accountNo}"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">updateAccountBalance</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"accountNo"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from account_info where where account_no=#{accountNo}"</span><span class="token punctuation">)</span>
    <span class="token class-name">AccountInfo</span> <span class="token function">findByIdAccountNo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"accountNo"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> accountNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select count(1) from de_duplication where tx_no = #{txNo}"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">isExistTx</span><span class="token punctuation">(</span><span class="token class-name">String</span> txNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token string">"insert into de_duplication values(#{txNo},now());"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">addTx</span><span class="token punctuation">(</span><span class="token class-name">String</span> txNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3）Service层</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountInfoServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AccountInfoService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoDao</span> accountInfoDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RocketMQTemplate</span> rocketMQTemplate<span class="token punctuation">;</span>


    <span class="token comment">//向mq发送转账消息</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendUpdateAccountBalance</span><span class="token punctuation">(</span><span class="token class-name">AccountChangeEvent</span> accountChangeEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">//将accountChangeEvent转成json</span>
        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"accountChange"</span><span class="token punctuation">,</span>accountChangeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//生成message类型</span>
        <span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> message <span class="token operator">=</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//发送一条事务消息</span>
        <span class="token comment">/**
         * String txProducerGroup 生产组
         * String destination topic，
         * Message&lt;?&gt; message, 消息内容
         * Object arg 参数
         */</span>
        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span><span class="token string">"producer_group_txmsg_bank1"</span><span class="token punctuation">,</span><span class="token string">"topic_txmsg"</span><span class="token punctuation">,</span>message<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//更新账户，扣减金额</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doUpdateAccountBalance</span><span class="token punctuation">(</span><span class="token class-name">AccountChangeEvent</span> accountChangeEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//幂等判断</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>accountInfoDao<span class="token punctuation">.</span><span class="token function">isExistTx</span><span class="token punctuation">(</span>accountChangeEvent<span class="token punctuation">.</span><span class="token function">getTxNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//扣减金额</span>
        accountInfoDao<span class="token punctuation">.</span><span class="token function">updateAccountBalance</span><span class="token punctuation">(</span>accountChangeEvent<span class="token punctuation">.</span><span class="token function">getAccountNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>accountChangeEvent<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//添加事务日志</span>
        accountInfoDao<span class="token punctuation">.</span><span class="token function">addTx</span><span class="token punctuation">(</span>accountChangeEvent<span class="token punctuation">.</span><span class="token function">getTxNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>accountChangeEvent<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"人为制造异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>4）RocketMQLocalTransactionListener，提供事务回查<br> 编写RocketMQLocalTransactionListener接口实现类，实现执行本地事务和事务回查两个方法。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RocketMQTransactionListener</span><span class="token punctuation">(</span>txProducerGroup <span class="token operator">=</span> <span class="token string">"producer_group_txmsg_bank1"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerTxmsgListener</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQLocalTransactionListener</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoService</span> accountInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoDao</span> accountInfoDao<span class="token punctuation">;</span>

    <span class="token comment">//事务消息发送后的回调方法，当消息发送给mq成功，此方法被回调</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">RocketMQLocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//解析message，转成AccountChangeEvent</span>
            <span class="token class-name">String</span> messageString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>messageString<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> accountChangeString <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"accountChange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将accountChange（json）转成AccountChangeEvent</span>
            <span class="token class-name">AccountChangeEvent</span> accountChangeEvent <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>accountChangeString<span class="token punctuation">,</span> <span class="token class-name">AccountChangeEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//执行本地事务，扣减金额</span>
            accountInfoService<span class="token punctuation">.</span><span class="token function">doUpdateAccountBalance</span><span class="token punctuation">(</span>accountChangeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//当返回RocketMQLocalTransactionState.COMMIT，自动向mq发送commit消息，mq将消息的状态改为可消费</span>
            <span class="token keyword">return</span> <span class="token class-name">RocketMQLocalTransactionState</span><span class="token punctuation">.</span>COMMIT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">RocketMQLocalTransactionState</span><span class="token punctuation">.</span>ROLLBACK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


    <span class="token punctuation">}</span>

    <span class="token comment">//事务状态回查，查询是否扣减金额</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RocketMQLocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//解析message，转成AccountChangeEvent</span>
        <span class="token class-name">String</span> messageString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>messageString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> accountChangeString <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"accountChange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将accountChange（json）转成AccountChangeEvent</span>
        <span class="token class-name">AccountChangeEvent</span> accountChangeEvent <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>accountChangeString<span class="token punctuation">,</span> <span class="token class-name">AccountChangeEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//事务id</span>
        <span class="token class-name">String</span> txNo <span class="token operator">=</span> accountChangeEvent<span class="token punctuation">.</span><span class="token function">getTxNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> existTx <span class="token operator">=</span> accountInfoDao<span class="token punctuation">.</span><span class="token function">isExistTx</span><span class="token punctuation">(</span>txNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>existTx<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">RocketMQLocalTransactionState</span><span class="token punctuation">.</span>COMMIT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">RocketMQLocalTransactionState</span><span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>5）Controller</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountInfoController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AccountInfoService</span> accountInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/transfer"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"accountNo"</span><span class="token punctuation">)</span><span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建一个事务id，作为消息内容发到mq</span>
        <span class="token class-name">String</span> tx_no <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AccountChangeEvent</span> accountChangeEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountChangeEvent</span><span class="token punctuation">(</span>accountNo<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>tx_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//发送消息</span>
        accountInfoService<span class="token punctuation">.</span><span class="token function">sendUpdateAccountBalance</span><span class="token punctuation">(</span>accountChangeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"转账成功"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="537_dtxtxmsgdemobank2_1586"></a>5.3.7 消息消费者：dtx-txmsg-demo-bank2</h5> 
<p>dtx-txmsg-demo-bank2需要实现如下功能：</p> 
<ul><li>1、监听MQ，接收消息。</li><li>2、接收到消息增加账户金额。</li></ul> 
<p>1） Service</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountInfoServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AccountInfoService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoDao</span> accountInfoDao<span class="token punctuation">;</span>

    <span class="token comment">//更新账户，增加金额</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addAccountInfoBalance</span><span class="token punctuation">(</span><span class="token class-name">AccountChangeEvent</span> accountChangeEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bank2更新本地账号，账号：{},金额：{}"</span><span class="token punctuation">,</span>accountChangeEvent<span class="token punctuation">.</span><span class="token function">getAccountNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>accountChangeEvent<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>accountInfoDao<span class="token punctuation">.</span><span class="token function">isExistTx</span><span class="token punctuation">(</span>accountChangeEvent<span class="token punctuation">.</span><span class="token function">getTxNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 注意为避免消息重复发送，这里需要实现幂等。</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//增加金额</span>
        accountInfoDao<span class="token punctuation">.</span><span class="token function">updateAccountBalance</span><span class="token punctuation">(</span>accountChangeEvent<span class="token punctuation">.</span><span class="token function">getAccountNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>accountChangeEvent<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//添加事务记录，用于幂等</span>
        accountInfoDao<span class="token punctuation">.</span><span class="token function">addTx</span><span class="token punctuation">(</span>accountChangeEvent<span class="token punctuation">.</span><span class="token function">getTxNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>accountChangeEvent<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"人为制造异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2）MQ监听类</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>consumerGroup <span class="token operator">=</span> <span class="token string">"consumer_group_txmsg_bank2"</span><span class="token punctuation">,</span>topic <span class="token operator">=</span> <span class="token string">"topic_txmsg"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TxmsgConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoService</span> accountInfoService<span class="token punctuation">;</span>

    <span class="token comment">//接收消息</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"开始消费消息:{}"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//解析消息</span>
        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> accountChangeString <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"accountChange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//转成AccountChangeEvent</span>
        <span class="token class-name">AccountChangeEvent</span> accountChangeEvent <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>accountChangeString<span class="token punctuation">,</span> <span class="token class-name">AccountChangeEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置账号为李四的</span>
        accountChangeEvent<span class="token punctuation">.</span><span class="token function">setAccountNo</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//更新本地账户，增加金额</span>
        accountInfoService<span class="token punctuation">.</span><span class="token function">addAccountInfoBalance</span><span class="token punctuation">(</span>accountChangeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="538__1649"></a>5.3.8 测试场景</h5> 
<ul><li>bank1本地事务失败，则bank1不发送转账消息。</li><li>bank2接收转账消息失败，会进行重试发送消息。</li><li>bank2多次消费同一个消息，实现幂等。</li></ul> 
<h4><a id="54_1655"></a>5.4.小结</h4> 
<p>可靠消息最终一致性就是保证消息从生产方经过消息中间件传递到消费方的一致性，本案例使用了RocketMQ作为消息中间件，RocketMQ主要解决了两个功能：</p> 
<ul><li>1、本地事务与消息发送的原子性问题。</li><li>2、事务参与方接收消息的可靠性。</li></ul> 
<p>可靠消息最终一致性事务适合执行周期长且实时性要求不高的场景。引入消息机制后，同步的事务操作变为基于消息执行的异步操作, 避免了分布式事务中的同步阻塞操作的影响，并实现了两个服务的解耦。</p> 
<h3><a id="6_1664"></a>6.分布式事务解决方案之最大努力通知</h3> 
<h4><a id="61_1666"></a>6.1.什么是最大努力通知</h4> 
<p>最大努力通知也是一种解决分布式事务的方案，下边是一个是充值的例子：<br> <img src="https://images2.imgbox.com/3c/5b/UFM9tAHe_o.png" alt="image.png"><br> 交互流程:</p> 
<ul><li>1、账户系统调用充值系统接口</li><li>2、充值系统完成支付处理向账户系统发起充值结果通知。若通知失败，则充值系统按策略进行重复通知</li><li>3、账户系统接收到充值结果通知修改充值状态。</li><li>4、账户系统未接收到通知会主动调用充值系统的接口查询充值结果。</li></ul> 
<p><strong>通过上边的例子我们总结最大努力通知方案的目标：</strong></p> 
<ul><li>目标：发起通知方通过一定的机制最大努力将业务处理结果通知到接收方。</li><li>具体包括： 
  <ul><li>1、有一定的消息重复通知机制。因为接收通知方可能没有接收到通知，此时要有一定的机制对消息重复通知。</li><li>2、消息校对机制。如果尽最大努力也没有通知到接收方，或者接收方消费消息后要再次消费，此时可由接收方主动向通知方查询消息信息来满足需求。</li></ul> </li></ul> 
<p><strong>最大努力通知与可靠消息一致性有什么不同？</strong></p> 
<ul><li>1、解决方案思想不同 
  <ul><li>可靠消息一致性，发起通知方需要保证将消息发出去，并且将消息发到接收通知方，消息的可靠性关键由发起通知方来保证。</li><li>最大努力通知，发起通知方尽最大的努力将业务处理结果通知为接收通知方，但是可能消息接收不到，此时需要接收通知方主动调用发起通知方的接口查询业务处理结果，通知的可靠性关键在接收通知方。</li></ul> </li><li>2、两者的业务应用场景不同 
  <ul><li>可靠消息一致性关注的是交易过程的事务一致，以异步的方式完成交易。</li><li>最大努力通知关注的是交易后的通知事务，即将交易结果可靠的通知出去。</li></ul> </li><li>3、技术解决方向不同 
  <ul><li>可靠消息一致性要解决消息从发出到接收的一致性，即消息发出并且被接收到。</li><li>最大努力通知无法保证消息从发出到接收的一致性，只提供消息接收的可靠性机制。可靠机制是，最大努力的将消息通知给接收方，当消息无法被接收方接收时，由接收方主动查询消息（业务处理结果）。</li></ul> </li></ul> 
<h4><a id="62_1695"></a>6.2.解决方案</h4> 
<p>通过对最大努力通知的理解，采用MQ的ack机制就可以实现最大努力通知。</p> 
<ul><li><strong>方案1</strong>：<img src="https://images2.imgbox.com/b6/34/zfUdNyGi_o.png" alt="image.png"></li></ul> 
<p>本方案是利用MQ的ack机制由MQ向接收通知方发送通知，流程如下：</p> 
<ul><li>1、发起通知方将通知发给MQ。使用普通消息机制将通知发给MQ。</li></ul> 
<p>注意：如果消息没有发出去可由接收通知方主动请求发起通知方查询业务执行结果。（后边会 讲）</p> 
<ul><li> <p>2、接收通知方监听 MQ。</p> </li><li> <p>3、接收通知方接收消息，业务处理完成回应ack。</p> </li><li> <p>4、接收通知方若没有回应ack则MQ会重复通知。MQ会**按照间隔1min、5min、10min、30min、1h、2h、5h、10h的方式，逐步拉大通知间隔 **（如果MQ采用rocketMq，在broker中可进行配置），直到达到通知要求的时间窗口上限。</p> </li><li> <p>5、接收通知方可通过消息校对接口来校对消息的一致性。</p> </li><li> <p><strong>方案2：</strong></p> </li></ul> 
<p><img src="https://images2.imgbox.com/87/ba/nfVyYfIJ_o.png" alt="image.png"><br> 本方案也是利用MQ的ack机制，与方案1不同的是应用程序向接收通知方发送通知。交互流程如下：</p> 
<ul><li> <p>1、发起通知方将通知发给MQ。使用可靠消息一致方案中的事务消息保证本地事务与消息的原子性，最终将通知先发给MQ。</p> </li><li> <p>2、通知程序监听 MQ，接收MQ的消息。方案1中接收通知方直接监听MQ，方案2中由通知程序监听MQ。通知程序若没有回应ack则MQ会重复通知。</p> </li><li> <p>3、通知程序通过互联网接口协议（如http、webservice）调用接收通知方案接口，完成通知。通知程序调用接收通知方案接口成功就表示通知成功，即消费MQ消息成功，MQ将不再向通知程序投递通知消息</p> </li><li> <p>4、接收通知方可通过消息校对接口来校对消息的一致性。</p> </li><li> <p><strong>方案1和方案2的不同点：</strong></p> 
  <ul><li>1、方案1中接收通知方与MQ接口，即接收通知方案监听 MQ，<strong>方案1主要应用与内部应用之间的通知</strong>。</li><li>2、方案2中由通知程序与MQ接口，通知程序监听MQ，收到MQ的消息后由通知程序通过互联网接口协议调用接收通知方。<strong>方案2主要应用于外部应用之间的通知，例如支付宝、微信的支付结果通知</strong>。</li></ul> </li></ul> 
<h4><a id="63RocketMQ_1724"></a>6.3.RocketMQ实现最大努力通知型事务</h4> 
<h5><a id="631_1725"></a>6.3.1.业务说明</h5> 
<p>本实例通过RocketMq中间件实现最大努力通知型分布式事务，模拟充值过程。</p> 
<p>本案例有账户系统和充值系统两个微服务，其中账户系统的数据库是bank1数据库，其中有张三账户。充值系统的数据库使用bank1_pay数据库，记录了账户的充值记录。<br> 业务流程如下图：<br> <img src="https://images2.imgbox.com/fc/68/WTR9No6z_o.png" alt="image.png"><br> 交互流程如下：</p> 
<ul><li>1、用户请求充值系统进行充值。</li><li>2、充值系统完成充值将充值结果发给MQ。</li><li>3、账户系统监听MQ，接收充值结果通知，如果接收不到消息，MQ会重复发送通知。接收到充值结果通知账户系统增加充值金额。</li><li>4、账户系统也可以主动查询充值系统的充值结果查询接口，增加金额。</li></ul> 
<h5><a id="632_1738"></a>6.3.2.程序组成部分</h5> 
<p>本示例程序组成部分如下：</p> 
<ul><li>数据库：MySQL-5.7.25：包括bank1和bank1_pay两个数据库。</li><li>JDK：64位 jdk1.8.0_201</li><li>rocketmq 服务端：RocketMQ-4.5.0</li><li>rocketmq 客户端：RocketMQ-Spring-Boot-starter.2.0.2-RELEASE</li><li>微服务框架：spring-boot-2.1.3、spring-cloud-Greenwich.RELEASE</li><li>微服务及数据库的关系 ： 
  <ul><li>dtx/dtx-notifymsg-demo/dtx-notifymsg-demo-bank1 银行1，操作张三账户， 连接数据库bank1</li><li>dtx/dtx-notifymsg-demo/dtx-notifymsg-demo-pay 银行2，操作充值记录，连接数据库bank1_pay</li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/a0/e9/7kx5JGTu_o.png" alt="image.png"><br> 交互流程如下：</p> 
<ul><li>1、用户请求充值系统进行充值。</li><li>2、充值系统完成充值将充值结果发给MQ。</li><li>3、账户系统监听MQ，接收充值结果通知，如果接收不到消息，MQ会重复发送通知。接收到充值结果通知账户系统增加充值金额。</li><li>4、账户系统也可以主动查询充值系统的充值结果查询接口，增加金额。</li></ul> 
<h5><a id="633_1759"></a>6.3.3.创建数据库</h5> 
<p>导入数据库脚本：资料\sql\bank1.sql、资料\sql\bank1_pay.sql，已经导过不用重复导入。<br> <strong>创建bank1库，并导入以下表结构和数据(包含张三账户)</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span>  <span class="token keyword">DATABASE</span>  <span class="token identifier"><span class="token punctuation">`</span>bank1<span class="token punctuation">`</span></span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  <span class="token string">'utf8'</span>  <span class="token keyword">COLLATE</span>  <span class="token string">'utf8_general_ci'</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span>  <span class="token keyword">TABLE</span>  <span class="token keyword">IF</span>  <span class="token keyword">EXISTS</span>  <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span><span class="token punctuation">;</span> <span class="token keyword">CREATE</span>  <span class="token keyword">TABLE</span>  <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span>	<span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>  <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_name<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'户主姓名'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_no<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'银行卡号'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_password<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span> <span class="token string">'帐户密码'</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>account_balance<span class="token punctuation">`</span></span> <span class="token keyword">double</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'帐户余额'</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span>  <span class="token keyword">KEY</span>  <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>  <span class="token keyword">USING</span>  <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span>  <span class="token operator">=</span>  <span class="token keyword">InnoDB</span>  <span class="token keyword">AUTO_INCREMENT</span>  <span class="token operator">=</span>  <span class="token number">5</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  <span class="token operator">=</span>  utf8  <span class="token keyword">COLLATE</span>  <span class="token operator">=</span>  utf8_bin  ROW_FORMAT  <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>account_info<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'张三的账户'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>de_duplication<span class="token punctuation">`</span></span><span class="token punctuation">;</span> 
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>de_duplication<span class="token punctuation">`</span></span>   <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>tx_no<span class="token punctuation">`</span></span>   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> 
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> 
  <span class="token keyword">PRIMARY</span>  <span class="token keyword">KEY</span>  <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>tx_no<span class="token punctuation">`</span></span><span class="token punctuation">)</span>  <span class="token keyword">USING</span>  <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span>  <span class="token operator">=</span>  <span class="token keyword">InnoDB</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  <span class="token operator">=</span>  utf8  <span class="token keyword">COLLATE</span>  <span class="token operator">=</span>  utf8_bin  ROW_FORMAT  <span class="token operator">=</span>  Dynamic<span class="token punctuation">;</span>
</code></pre> 
<p>创建bank1_pay库，并导入以下表结构：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token identifier"><span class="token punctuation">`</span>bank1_pay<span class="token punctuation">`</span></span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token string">'utf8'</span> <span class="token keyword">COLLATE</span> <span class="token string">'utf8_general_ci'</span><span class="token punctuation">;</span> <span class="token keyword">CREATE</span>  <span class="token keyword">TABLE</span>  <span class="token identifier"><span class="token punctuation">`</span>account_pay<span class="token punctuation">`</span></span>	<span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>account_no<span class="token punctuation">`</span></span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  utf8  <span class="token keyword">COLLATE</span>  utf8_bin  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'账号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pay_amount<span class="token punctuation">`</span></span>  <span class="token keyword">double</span>  <span class="token boolean">NULL</span>  <span class="token keyword">DEFAULT</span>  <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span>  <span class="token string">'充值余额'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>result<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'充值结果:success，fail'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span>  <span class="token keyword">KEY</span>  <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>  <span class="token keyword">USING</span>  <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span>  <span class="token keyword">ENGINE</span>  <span class="token operator">=</span>  <span class="token keyword">InnoDB</span>  <span class="token keyword">AUTO_INCREMENT</span>  <span class="token operator">=</span>  <span class="token number">5</span>  <span class="token keyword">CHARACTER</span>  <span class="token keyword">SET</span>  <span class="token operator">=</span>  utf8  <span class="token keyword">COLLATE</span>  <span class="token operator">=</span>  utf8_bin  ROW_FORMAT  <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="634RocketMQ_1795"></a>6.3.4.启动RocketMQ</h5> 
<p>rocketmq启动方式与<strong>RocketMQ实现可靠消息最终一致性事务</strong>中完全一致</p> 
<h5><a id="635_discoverserver_1798"></a>6.3.5 discover-server</h5> 
<p>discover-server是服务注册中心，测试工程将自己注册至discover-server。<br> 导入：资料\基础代码\dtx 父工程，此工程自带了discover-server，discover-server基于Eureka实现。已经导过不用重复导入。</p> 
<h5><a id="636_dtxnotifymsgdemo_1802"></a>6.3.6 导入dtx-notifymsg-demo</h5> 
<p>dtx-notifymsg-demo是本方案的测试工程，根据业务需求需要创建两个dtx-notifymsg-demo工程。</p> 
<p><strong>（1）导入dtx-notifymsg-demo</strong></p> 
<ul><li>导入：资料\基础代码\dtx-notifymsg-demo到父工程dtx下。</li><li>两个测试工程如下： 
  <ul><li>dtx/dtx-notifymsg-demo/dtx-notifymsg-demo-bank1 ，操作张三账户，连接数据库bank1</li><li>dtx/dtx-notifymsg-demo/dtx-notifymsg-demo-pay，操作李四账户，连接数据库bank1_pay</li></ul> </li></ul> 
<p><strong>（2）父工程maven依赖说明</strong></p> 
<ul><li>在dtx父工程中指定了SpringBoot和SpringCloud版本</li></ul> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring‐boot‐dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.3.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring‐cloud‐dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>Greenwich.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ul><li>在dtx-notifymsg-demo父工程中指定了rocketmq-spring-boot-starter的版本。</li></ul> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq‐spring‐boot‐starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><strong>( 3 ) 配置rocketMQ</strong><br> 在application-local.propertis中配置rocketMQ nameServer地址及生产组：</p> 
<pre><code class="prism language-properties">rocketmq.producer.group = producer_notifymsg_bank1
rocketmq.name-server = 127.0.0.1:9876
</code></pre> 
<p>其它详细配置见导入的基础工程。</p> 
<h5><a id="637_dtxnotifydemopay_1848"></a>6.3.7 消息发送方：dtx-notifydemo-pay</h5> 
<p>dtx-notifydemo-pay实现如下功能：</p> 
<ul><li>1、充值接口</li><li>2、充值完成要通知</li><li>3、充值结果查询接口</li></ul> 
<p><strong>1）Dao</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Mapper</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccountPayDao</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token string">"insert into account_pay(id,account_no,pay_amount,result) values(#{id},#{accountNo},#{payAmount},#{result})"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">insertAccountPay</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"accountNo"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"payAmount"</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> pay_amount<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select id,account_no accountNo,pay_amount payAmount,result from account_pay where id=#{txNo}"</span><span class="token punctuation">)</span>
    <span class="token class-name">AccountPay</span> <span class="token function">findByIdTxNo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"txNo"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> txNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>2）Service</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountPayServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AccountPayService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountPayDao</span> accountPayDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RocketMQTemplate</span> rocketMQTemplate<span class="token punctuation">;</span>

    <span class="token comment">//插入充值记录</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AccountPay</span> <span class="token function">insertAccountPay</span><span class="token punctuation">(</span><span class="token class-name">AccountPay</span> accountPay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> success <span class="token operator">=</span> accountPayDao<span class="token punctuation">.</span><span class="token function">insertAccountPay</span><span class="token punctuation">(</span>accountPay<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accountPay<span class="token punctuation">.</span><span class="token function">getAccountNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accountPay<span class="token punctuation">.</span><span class="token function">getPayAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>success<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//发送通知,使用普通消息发送通知</span>
            accountPay<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rocketMQTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"topic_notifymsg"</span><span class="token punctuation">,</span>accountPay<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> accountPay<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//查询充值记录，接收通知方调用此方法来查询充值结果</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AccountPay</span> <span class="token function">getAccountPay</span><span class="token punctuation">(</span><span class="token class-name">String</span> txNo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">AccountPay</span> accountPay <span class="token operator">=</span> accountPayDao<span class="token punctuation">.</span><span class="token function">findByIdTxNo</span><span class="token punctuation">(</span>txNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> accountPay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>3）Controller</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountPayController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountPayService</span> accountPayService<span class="token punctuation">;</span>

    <span class="token comment">//充值</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/paydo"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AccountPay</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token class-name">AccountPay</span> accountPay<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//生成事务编号</span>
        <span class="token class-name">String</span> txNo <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        accountPay<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>txNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> accountPayService<span class="token punctuation">.</span><span class="token function">insertAccountPay</span><span class="token punctuation">(</span>accountPay<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//查询充值结果</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/payresult/{txNo}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AccountPay</span> <span class="token function">payresult</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"txNo"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> txNo<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> accountPayService<span class="token punctuation">.</span><span class="token function">getAccountPay</span><span class="token punctuation">(</span>txNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_1924"></a></h5> 
<h5><a id="638_dtxnotifydemobank1_1925"></a>6.3.8 消息接收方：dtx-notifydemo-bank1</h5> 
<p>dtx-notifydemo-bank1实现如下功能：</p> 
<ul><li>1、监听MQ，接收充值结果，根据充值结果完成账户金额修改。</li><li>2、主动查询充值系统，根据充值结果完成账户金额修改。</li></ul> 
<p><strong>1）Dao</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Mapper</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccountInfoDao</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//修改账户金额</span>
    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">"update account_info set account_balance=account_balance+#{amount} where account_no=#{accountNo}"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">updateAccountBalance</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"accountNo"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> accountNo<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>


   <span class="token comment">//查询幂等记录，用于幂等控制</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select count(1) from de_duplication where tx_no = #{txNo}"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">isExistTx</span><span class="token punctuation">(</span><span class="token class-name">String</span> txNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//添加事务记录，用于幂等控制</span>
    <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token string">"insert into de_duplication values(#{txNo},now());"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">addTx</span><span class="token punctuation">(</span><span class="token class-name">String</span> txNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>2）Service层</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountInfoServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AccountInfoService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoDao</span> accountInfoDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">PayClient</span> payClient<span class="token punctuation">;</span>

    <span class="token comment">//更新账户金额</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateAccountBalance</span><span class="token punctuation">(</span><span class="token class-name">AccountChangeEvent</span> accountChange<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//幂等校验</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>accountInfoDao<span class="token punctuation">.</span><span class="token function">isExistTx</span><span class="token punctuation">(</span>accountChange<span class="token punctuation">.</span><span class="token function">getTxNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> accountInfoDao<span class="token punctuation">.</span><span class="token function">updateAccountBalance</span><span class="token punctuation">(</span>accountChange<span class="token punctuation">.</span><span class="token function">getAccountNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accountChange<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//插入事务记录，用于幂等控制</span>
        accountInfoDao<span class="token punctuation">.</span><span class="token function">addTx</span><span class="token punctuation">(</span>accountChange<span class="token punctuation">.</span><span class="token function">getTxNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//远程调用查询充值结果</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AccountPay</span> <span class="token function">queryPayResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> tx_no<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">//远程调用</span>
        <span class="token class-name">AccountPay</span> payresult <span class="token operator">=</span> payClient<span class="token punctuation">.</span><span class="token function">payresult</span><span class="token punctuation">(</span>tx_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>payresult<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//更新账户金额</span>
            <span class="token class-name">AccountChangeEvent</span> accountChangeEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountChangeEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            accountChangeEvent<span class="token punctuation">.</span><span class="token function">setAccountNo</span><span class="token punctuation">(</span>payresult<span class="token punctuation">.</span><span class="token function">getAccountNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//账号</span>
            accountChangeEvent<span class="token punctuation">.</span><span class="token function">setAmount</span><span class="token punctuation">(</span>payresult<span class="token punctuation">.</span><span class="token function">getPayAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//金额</span>
            accountChangeEvent<span class="token punctuation">.</span><span class="token function">setTxNo</span><span class="token punctuation">(</span>payresult<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//充值事务号</span>
            <span class="token function">updateAccountBalance</span><span class="token punctuation">(</span>accountChangeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> payresult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"dtx-notifymsg-demo-pay"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">PayFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PayClient</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//远程调用充值系统的接口查询充值结果</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/pay/payresult/{txNo}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AccountPay</span> <span class="token function">payresult</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"txNo"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> txNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayFallback</span> <span class="token keyword">implements</span> <span class="token class-name">PayClient</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AccountPay</span> <span class="token function">payresult</span><span class="token punctuation">(</span><span class="token class-name">String</span> txNo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">AccountPay</span> accountPay <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountPay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        accountPay<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token string">"fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> accountPay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>3）监听MQ</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">"topic_notifymsg"</span><span class="token punctuation">,</span>consumerGroup <span class="token operator">=</span> <span class="token string">"consumer_group_notifymsg_bank1"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NotifyMsgListener</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccountPay</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AccountInfoService</span> accountInfoService<span class="token punctuation">;</span>

    <span class="token comment">//接收消息</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">AccountPay</span> accountPay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到消息：{}"</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>accountPay<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>accountPay<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//更新账户金额</span>
            <span class="token class-name">AccountChangeEvent</span> accountChangeEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountChangeEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            accountChangeEvent<span class="token punctuation">.</span><span class="token function">setAccountNo</span><span class="token punctuation">(</span>accountPay<span class="token punctuation">.</span><span class="token function">getAccountNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            accountChangeEvent<span class="token punctuation">.</span><span class="token function">setAmount</span><span class="token punctuation">(</span>accountPay<span class="token punctuation">.</span><span class="token function">getPayAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            accountChangeEvent<span class="token punctuation">.</span><span class="token function">setTxNo</span><span class="token punctuation">(</span>accountPay<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            accountInfoService<span class="token punctuation">.</span><span class="token function">updateAccountBalance</span><span class="token punctuation">(</span>accountChangeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"处理消息完成：{}"</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>accountPay<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>4）Controller</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountInfoController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AccountInfoService</span> accountInfoService<span class="token punctuation">;</span>

    <span class="token comment">//主动查询充值结果</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/payresult/{txNo}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AccountPay</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"txNo"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> txNo<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">AccountPay</span> accountPay <span class="token operator">=</span> accountInfoService<span class="token punctuation">.</span><span class="token function">queryPayResult</span><span class="token punctuation">(</span>txNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> accountPay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="639__2057"></a>6.3.9 测试场景</h5> 
<p>充值系统充值成功，账户系统主动查询充值结果，修改账户金额。<br> 充值系统充值成功，发送消息，账户系统接收消息，修改账户金额。账户系统修改账户金额幂等测试。</p> 
<h4><a id="64_2061"></a>6.4.小结</h4> 
<p>最大努力通知方案是分布式事务中对一致性要求最低的一种,适用于一些最终一致性时间敏感度低的业务；最大努力通知方案需要实现如下功能：<br> 1、消息重复通知机制。2、消息校对机制。</p> 
<h3><a id="7_2067"></a>7.分布式事务综合案例分析</h3> 
<p>前边我们已经学习了四种分布式事务解决方案，2PC、TCC、可靠消息最终一致性、最大努力通知，每种解决方案我们通过案例开发进行学习，本章节我们结合互联网金融项目中的业务场景，来进行分布式事务解决方案可行性分析。</p> 
<h4><a id="71_2071"></a>7.1.系统介绍</h4> 
<h5><a id="711P2P_2073"></a>7.1.1.P2P介绍</h5> 
<p>P2P金融又叫P2P信贷。其中P2P是 peer-to-peer 或 person-to-person 的简写，意思是：个人对个人。P2P金融指个人与个人间的小额借贷交易，一般需要借助电子商务专业网络平台帮助借贷双方确立借贷关系并完成相关交易手续。借款者可自行发布借款信息，包括金额、利息、还款方式和时间，实现自助式借款;投资者根据借款人发布的信息，自行决定出借金额，实现自助式借贷。<br> 目前，国家对P2P行业的监控与规范性控制越来越严格，出台了很多政策来对其专项整治。并主张采用“银行存管模式”来规避P2P平台挪用借投人资金的风险，通过银行开发的“银行存管系统”管理投资者的资金，<strong>每位P2P平台用户在银行的存管系统内都会有一个独立账号</strong>，平台来管理交易，做到资金和交易分开，让P2P平台不能接触到资金，就可以一定程度避免资金被挪用的风险。</p> 
<p>什么是银行存管模式？</p> 
<p>银行存管模式涉及到2套账户体系，P2P平台和银行各一套账户体系。投资人在P2P平台注册后，会同时跳转到银行再开一个电子账户，2个账户间有一一对应的关系。当投资人投资时，资金进入的是平台在银行为投资人开设的二级账户中，每一笔交易，是由银行在投资人与借款人间的交易划转，P2P平台仅能看到信息的流动。<br> <img src="https://images2.imgbox.com/97/c2/7vQfsYEe_o.png" alt="image.png"></p> 
<h5><a id="712_2082"></a>7.1.2.总体业务流程</h5> 
<p><img src="https://images2.imgbox.com/60/8e/6Xzn13qd_o.png" alt="image.png"></p> 
<h5><a id="712_2084"></a>7.1.2.业务术语</h5> 
<p>| <strong>术语</strong> |</p> 
<p><strong>描述</strong> |<br> | — | — |<br> | 银行存管模式 | 此种模式下，涉及到2套账户体系，P2P平台和银行各一套账户体系。投资人在P2P平台注册后，会同时跳转到银行再开一个电子账户，2个账户间有一一对应的关系。当投资人投资时，资金进入的是平台在银行为投资人开设的二级账户中，每一笔交易，是由银行在投资人与借款人间的交易划转，P2P平台仅能看到信息的流动。 |<br> | 标的 | P2P业内，习惯把借款人发布的投资项目称为“标的”。 |<br> | 发标 | 借款人在P2P平台中创建并发布“标的”过程。 |<br> | 投标 | 投资人在认可相关借款人之后进行的一种借贷行为，对自己中意的借款标的进行投资操作，一个借款标可由单个投资人或多个投资人承接。 |<br> | 满标 | 单笔借款标筹集齐所有借款资金即为满标，计息时间是以标满当日开始计息，投资人较多的平台多数会当天满标。 |</p> 
<h5><a id="712_2095"></a>7.1.2.模块说明</h5> 
<p><strong>统一账号服务</strong><br> 用户的登录账号、密码、角色、权限、资源等系统级信息的管理，不包含用户业务信息。</p> 
<p><strong>用户中心</strong><br> 提供用户业务信息的管理，如会员信息、实名认证信息、绑定银行卡信息等，“用户中心”的每个用户与“<strong>统一账号服务</strong>”中的账号关联。</p> 
<p><strong>交易中心</strong><br> 提供发标、投标等业务。</p> 
<p><strong>还款服务</strong><br> 提供还款计划的生成、执行、记录与归档。</p> 
<p><strong>银行存管系统(模拟)</strong><br> 模拟银行存管系统，进行资金的存管，划转。</p> 
<h4><a id="72_2112"></a>7.2.注册账号案例分析</h4> 
<h5><a id="721_2114"></a>7.2.1.业务流程</h5> 
<p>采用用户、账号分离设计(这样设计的好处是，当用户的业务信息发生变化时，不会影响的认证、授权等系统机制)，因此需要保证用户信息与账号信息的一致性。<br> <img src="https://images2.imgbox.com/34/54/OrXbytk2_o.png" alt="image.png"><br> 用户向用户中心发起注册请求，用户中心保存用户业务信息，然后通知统一账号服务新建该用户所对应登录账号。</p> 
<h5><a id="722_2120"></a>7.2.2.解决方案分析</h5> 
<p>针对注册业务，如果用户与账号信息不一致，则会导致严重问题，因此该业务对一致性要求较为严格，即当用户服务和账号服务任意一方出现问题都需要回滚事务。</p> 
<p>根据上述需求进行解决方案分析：1、采用可靠消息一致性方案<br> 可靠消息一致性要求只要消息发出，事务参与者接到消息就要将事务执行成功，不存在回滚的要求，所以不适用。2、采用最大努力通知方案<br> 最大努力通知表示发起通知方执行完本地事务后将结果通知给事务参与者，即使事务参与者执行业务处理失败发起通知方也不会回滚事务，所以不适用。</p> 
<p>3、采用Seata实现2PC</p> 
<p>在用户中心发起全局事务，统一账户服务为事务参与者，用户中心和统一账户服务只要有一方出现问题则全局事务回滚，符合要求。<br> 实现方法如下：</p> 
<p>1、用户中心添加用户信息，开启全局事务</p> 
<p>2、统一账号服务添加账号信息，作为事务参与者</p> 
<p>3、其中一方执行失败Seata对SQL进行逆操作删除用户信息和账号信息，实现回滚。4、采用Hmily实现TCC<br> TCC也可以实现用户中心和统一账户服务只要有一方出现问题则全局事务回滚，符合要求。实现方法如下：<br> 1、用户中心</p> 
<p>try：添加用户，状态为不可用</p> 
<p>confirm：更新用户状态为可用</p> 
<p>cancel：删除用户2、统一账号服务<br> try：添加账号，状态为不可用confirm：更新账号状态为可用cancel：删除账号</p> 
<h4><a id="73_2147"></a>7.3.存管开户</h4> 
<h5><a id="731_2149"></a>7.3.1.业务流程</h5> 
<p>根据政策要求，P2P业务必须让银行存管资金，用户的资金在银行存管系统的账户中，而不在P2P平台中，因此用户要在银行存管系统开户。<br> <img src="https://images2.imgbox.com/b9/9e/JIt0gmNu_o.png" alt="image.png"><br> 用户向用户中心提交开户资料，用户中心生成开户请求号并重定向至银行存管系统开户页面。用户设置存管密码并确认开户后，银行存管立即返回“请求已受理”。在某一时刻，银行存管系统处理完该开户请求后，将调用回调地址通知处理结果，若通知失败，则按一定策略重试通知。同时，银行存管系统应提供<strong>开户结果查询</strong>的接口，供用户中心校对结果。</p> 
<h5><a id="732_2155"></a>7.3.2.解决方案分析</h5> 
<p>P2P平台的用户中心与银行存管系统之间属于跨系统交互，银行存管系统属于外部系统，用户中心无法干预银行存管系统，所以用户中心只能在收到银行存管系统的业务处理结果通知后积极处理，开户后的使用情况完全由用户中心来控制。</p> 
<p>根据上述需求进行解决方案分析：</p> 
<p>1、采用Seata实现2PC</p> 
<p>需要侵入银行存管系统的数据库，由于它的外部系统，所以不适用。</p> 
<p>2、采用Hmily实现TCC</p> 
<p>TCC侵入性更强，所以不适用。3、基于MQ的可靠消息一致性<br> 如果让银行存管系统监听 MQ则不合适 ，因为它的外部系统。</p> 
<p>如果银行存管系统将消息发给MQ用户中心监听MQ是可以的，但是由于相对银行存管系统来说用户中心属于外部系统，银行存管系统是不会让外部系统直接监听自己的MQ的，基于MQ的通信协议也不方便外部系统间的交互，所以本方案不合适。</p> 
<p>4、最大努力通知方案</p> 
<p>银行存管系统内部使用MQ，银行存管系统处理完业务后将处理结果发给MQ，由银行存管的通知程序专门发送通知，并且采用互联网协议通知给第三方系统（用户中心）。</p> 
<p>下图中发起通知即银行存管系统：<br> <img src="https://images2.imgbox.com/c4/94/orgPgs7N_o.png" alt="image.png"></p> 
<h4><a id="74_2178"></a>7.4.满标审核</h4> 
<h5><a id="741_2180"></a>7.4.1.业务流程</h5> 
<p>在借款人标的募集够所有的资金后，P2P运营管理员审批该标的，触发放款，并开启还款流程。<br> <img src="https://images2.imgbox.com/e7/b4/twWy5awi_o.png" alt="image.png"><br> 管理员对某标的满标审批通过，交易中心修改标的状态为“还款中”，同时要通知还款服务生成还款计划。</p> 
<h5><a id="742_2186"></a>7.4.2.解决方案分析</h5> 
<p>生成还款计划是一个执行时长较长的业务，不建议阻塞主业务流程，此业务对一致性要求较低。根据上述需求进行解决方案分析：<br> 1、采用Seata实现2PC</p> 
<p>Seata在事务执行过程会进行数据库资源锁定，由于事务执行时长较长会将资源锁定较长时间，所以不适用。2、采用Hmily实现TCC<br> 本需求对业务一致性要求较低，因为生成还款计划的时长较长，所以不要求交易中心修改标的状态为“还款中”就立即生成还款计划 ，所以本方案不适用。<br> 3、基于MQ的可靠消息一致性</p> 
<p>满标审批通过后由交易中心修改标的状态为“还款中”并且向还款服务发送消息，还款服务接收到消息开始生成还款计划，基本于MQ的可靠消息一致性方案适用此场景 。</p> 
<p>4、最大努力通知方案</p> 
<p>满标审批通过后由交易中心向还款服务发送通知要求生成还款计划，还款服务并且对外提供还款计划生成结果校对接口供其它服务查询，最大努力 通知方案也适用本场景 。</p> 
<h3><a id="8_2202"></a>8.课程总结</h3> 
<h4><a id="_2204"></a>重点知识回顾:</h4> 
<ul><li>事务的基本概念以及本地事务特性。</li><li>CAP、BASE理论的概念。</li><li>2PC、TCC、可靠消息最终一致性、最大努力通知各类型原理及特性。</li><li>不同分布式事务类型的应用场景讨论。</li><li>RocketMQ事务消息机制。</li><li>Seata与传统XA原理上的差异。</li></ul> 
<h4><a id="_2212"></a>分布式事务对比分析:</h4> 
<p>在学习各种分布式事务的解决方案后，我们了解到各种方案的优缺点：</p> 
<p>**2PC **最大的诟病是一个阻塞协议。RM在执行分支事务后需要等待TM的决定，此时服务会阻塞并锁定资源。由于其阻塞机制和最差时间复杂度高， 因此，这种设计不能适应随着事务涉及的服务数量增加而扩展的需要，很难用于并发较高以及子事务生命周期较长 (long-running transactions) 的分布式服务中。</p> 
<p>如果拿<strong>TCC</strong>事务的处理流程与2PC两阶段提交做比较，2PC通常都是在跨库的DB层面，而TCC则在应用层面的处理，需要通过业务逻辑来实现。这种分布式事务的实现方式的优势在于，可以让<strong>应用自己定义数据操作的粒度，使得降低锁冲突、提高吞吐量成为可能</strong>。而不足之处则在于对应用的侵入性非常强，业务逻辑的每个分支都需要实现try、confirm、cancel三个操作。此外，其实现难度也比较大，需要按照网络状态、系统故障等不同的失败原因实现不同的回滚策略。典型的使用场景：满，登录送优惠券等。</p> 
<p><strong>可靠消息最终一致性</strong>事务适合执行周期长且实时性要求不高的场景。引入消息机制后，同步的事务操作变为基于消息执行的异步操作, 避免了分布式事务中的同步阻塞操作的影响，并实现了两个服务的解耦。典型的使用场景：注册送积分，登录送优惠券等。</p> 
<p><strong>最大努力通知</strong>是分布式事务中要求最低的一种,适用于一些最终一致性时间敏感度低的业务；允许发起通知方处理业务失败，在接收通知方收到通知后积极进行失败处理，无论发起通知方如何处理结果都会不影响到接收通知方的后续处理；发起通知方需提供查询执行情况接口，用于接收通知方校对结果。典型的使用场景：银行通知、支付结果通知等。</p> 
<p>|<br> | <strong>2PC</strong> | <strong>TCC</strong> | <strong>可靠消息</strong> | <strong>最大努力通知</strong> |<br> | — | — | — | — | — |<br> | 一致性 | 强一致性 | 最终一致 | 最终一致 | 最终一致 |<br> | 吞吐量 | 低 | 中 | 高 | 高 |<br> | 实现复杂度 | 易 | 难 | 中 | 易 |</p> 
<h4><a id="_2232"></a>总结：</h4> 
<p>在条件允许的情况下，我们尽可能选择本地事务单数据源，因为它减少了网络交互带来的性能损耗，且避免了数据弱一致性带来的种种问题。若某系统频繁且不合理的使用分布式事务，应首先从整体设计角度观察服务的拆分是否合理，是否高内聚低耦合？是否粒度太小？分布式事务一直是业界难题，因为网络的不确定性，而且我们习惯于拿分布式事务与单机事务ACID做对比。<br> 无论是数据库层的XA、还是应用层TCC、可靠消息、最大努力通知等方案，都没有完美解决分布式事务问题，它们不过是各自在性能、一致性、可用性等方面做取舍，寻求某些场景偏好下的权衡。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8fc8296d15d2af50b2960315326c6b07/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">分布式锁实现方案及原理说明</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1fa9eabb9c0f27b8736d1a1011549b10/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【蓝桥杯】时间显示--JAVA</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>