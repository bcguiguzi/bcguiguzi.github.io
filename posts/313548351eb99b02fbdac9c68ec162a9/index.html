<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>运行x509的库做TSL加密的时候报错“调用 SSPI 失败，请参见内部异常”。 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="运行x509的库做TSL加密的时候报错“调用 SSPI 失败，请参见内部异常”。" />
<meta property="og:description" content="运行x509的库报错 调用.net的库运行报错如下。
&#34; at System.Net.Security.SslState.StartSendAuthResetSignal(ProtocolToken message, AsyncProtocolRequest asyncRequest, Exception exception)\r\n at System.Net.Security.SslState.CheckCompletionBeforeNextReceive(ProtocolToken message, AsyncProtocolRequest asyncRequest)\r\n at System.Net.Security.SslState.ProcessReceivedBlob(Byte[] buffer, Int32 count, AsyncProtocolRequest asyncRequest)\r\n at System.Net.Security.SslState.StartReceiveBlob(Byte[] buffer, AsyncProtocolRequest asyncRequest)\r\n at System.Net.Security.SslState.CheckCompletionBeforeNextReceive(ProtocolToken message, AsyncProtocolRequest asyncRequest)\r\n at System.Net.Security.SslState.ProcessReceivedBlob(Byte[] buffer, Int32 count, AsyncProtocolRequest asyncRequest)\r\n at System.Net.Security.SslState.StartReceiveBlob(Byte[] buffer, AsyncProtocolRequest asyncRequest)\r\n at System.Net.Security.SslState.ForceAuthentication(Boolean receiveFirst, Byte[] buffer, AsyncProtocolRequest asyncRequest, Boolean renegotiation)\r\n at System.Net.Security.SslState.ProcessAuthentication(LazyAsyncResult lazyResult)\r\n at console.TLSServer.Main(String[] args) in C:\Users\admin\Desktop\Socket\ssl\Program.cs:line 103&#34; 调用 SSPI 失败，请参见内部异常。
1.在使用 New-SelfSignedCertificate 命令创建自签名证书时，你可以通过 -KeyExportPolicy Exportable 参数来设置私钥可导出，然后你将能够为私钥设置密码。下面是具体步骤：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/313548351eb99b02fbdac9c68ec162a9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-31T11:35:04+08:00" />
<meta property="article:modified_time" content="2023-08-31T11:35:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">运行x509的库做TSL加密的时候报错“调用 SSPI 失败，请参见内部异常”。</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="x509_0"></a>运行x509的库报错</h2> 
<p>调用.net的库运行报错如下。<br> " at System.Net.Security.SslState.StartSendAuthResetSignal(ProtocolToken message, AsyncProtocolRequest asyncRequest, Exception exception)\r\n at System.Net.Security.SslState.CheckCompletionBeforeNextReceive(ProtocolToken message, AsyncProtocolRequest asyncRequest)\r\n at System.Net.Security.SslState.ProcessReceivedBlob(Byte[] buffer, Int32 count, AsyncProtocolRequest asyncRequest)\r\n at System.Net.Security.SslState.StartReceiveBlob(Byte[] buffer, AsyncProtocolRequest asyncRequest)\r\n at System.Net.Security.SslState.CheckCompletionBeforeNextReceive(ProtocolToken message, AsyncProtocolRequest asyncRequest)\r\n at System.Net.Security.SslState.ProcessReceivedBlob(Byte[] buffer, Int32 count, AsyncProtocolRequest asyncRequest)\r\n at System.Net.Security.SslState.StartReceiveBlob(Byte[] buffer, AsyncProtocolRequest asyncRequest)\r\n at System.Net.Security.SslState.ForceAuthentication(Boolean receiveFirst, Byte[] buffer, AsyncProtocolRequest asyncRequest, Boolean renegotiation)\r\n at System.Net.Security.SslState.ProcessAuthentication(LazyAsyncResult lazyResult)\r\n at console.TLSServer.Main(String[] args) in C:\Users\admin\Desktop\Socket\ssl\Program.cs:line 103" 调用 SSPI 失败，请参见内部异常。</p> 
<p>1.在使用 New-SelfSignedCertificate 命令创建自签名证书时，你可以通过 -KeyExportPolicy Exportable 参数来设置私钥可导出，然后你将能够为私钥设置密码。下面是具体步骤：</p> 
<p>2.打开 PowerShell 作为管理员（右键单击 PowerShell，选择“以管理员身份运行”）。</p> 
<p>3.使用以下命令创建自签名证书，并设置私钥可导出：</p> 
<p>New-SelfSignedCertificate -DnsName “YourServerName” -CertStoreLocation “Cert:\LocalMachine\My” -KeyExportPolicy Exportable<br> 请确保将 “YourServerName” 替换为你的服务器名称或域名。</p> 
<p>4.命令执行成功后，它将创建一个新的自签名证书并将其存储在“个人”证书存储区域（My）中，并且私钥可导出。</p> 
<p>5.现在，你可以为私钥设置密码。使用以下命令来为私钥设置密码：</p> 
<p>$cert = Get-ChildItem -Path Cert:\LocalMachine\My | Where-Object { $_.Subject -eq “CN=YourServerName” }<br> $cert | Export-PfxCertificate -FilePath “C:\Path\To\ExportedCertificate.pfx” -Password (ConvertTo-SecureString -String “YourPassword” -Force -AsPlainText)<br> 请将 “YourPassword” 替换为你想要设置的密码，并将输出的证书保存到指定路径。</p> 
<p>这样，你就为自签名证书的私钥设置了密码。确保将密码保存在安全的地方，因为它将用于访问证书的私钥。在你的应用程序中，你需要提供这个密码以访问证书的私钥。</p> 
<pre><code class="prism language-c">

using System<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Net<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Security<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Authentication<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Cryptography<span class="token punctuation">.</span>X509Certificates<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Text<span class="token punctuation">;</span>

namespace console
<span class="token punctuation">{<!-- --></span>
    class TLSServer
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/// &lt;summary&gt;</span>
         <span class="token comment">/// 取整数的某一位</span>
         <span class="token comment">/// &lt;/summary&gt;</span>
         <span class="token comment">/// &lt;param name="_Resource"&gt;要取某一位的整数&lt;/param&gt;</span>
         <span class="token comment">/// &lt;param name="_Mask"&gt;要取的位置索引，自右至左为0-7&lt;/param&gt;</span>
         <span class="token comment">/// &lt;returns&gt;返回某一位的值（0或者1）&lt;/returns&gt;</span>
        public <span class="token keyword">static</span> bool <span class="token function">getIntegerSomeBit</span><span class="token punctuation">(</span><span class="token keyword">int</span> _Resource<span class="token punctuation">,</span> <span class="token keyword">int</span> _Mask<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>_Resource <span class="token operator">&gt;&gt;</span> _Mask <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 将整数的某位置为0或1</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="_Mask"&gt;整数的某位&lt;/param&gt;</span>
        <span class="token comment">/// &lt;param name="a"&gt;整数&lt;/param&gt;</span>
        <span class="token comment">/// &lt;param name="flag"&gt;是否置1，TURE表示置1，FALSE表示置0&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;返回修改过的值&lt;/returns&gt;</span>
        public <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">setIntegerSomeBit</span><span class="token punctuation">(</span><span class="token keyword">int</span> _Mask<span class="token punctuation">,</span> <span class="token keyword">int</span> a<span class="token punctuation">,</span> bool flag<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                a <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> _Mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                a <span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> _Mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> a<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span>string<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//int value= 235;</span>
            <span class="token comment">//value = (value &gt;&gt; 3);</span>
            <span class="token comment">//int g = value &amp; 1;</span>
            <span class="token comment">//List&lt;bool&gt; listbool = new List&lt;bool&gt;();</span>
            <span class="token comment">//for (int i = 0; i &lt; 8; i++)</span>
            <span class="token comment">//{<!-- --></span>
            <span class="token comment">//    bool nn = getIntegerSomeBit(235, i);</span>
            <span class="token comment">//    listbool.Add(nn);</span>
            <span class="token comment">//}</span>
            <span class="token comment">//int ff = 1;</span>
            <span class="token comment">//for (int i = 0; i &lt; 8; i++)</span>
            <span class="token comment">//{<!-- --></span>
            <span class="token comment">//     ff = setIntegerSomeBit(i, ff, true);</span>
            <span class="token comment">//}</span>
          
            <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token number">443</span><span class="token punctuation">;</span>
            string certificatePath <span class="token operator">=</span> <span class="token string">"ExportedCertificate.pfx"</span><span class="token punctuation">;</span> <span class="token comment">// 替换成你的证书路径</span>
            string certificatePassword <span class="token operator">=</span> <span class="token string">"Your-P*/assword"</span><span class="token punctuation">;</span> <span class="token comment">// 替换成你的证书密码</span>

            TcpListener listener <span class="token operator">=</span> new <span class="token function">TcpListener</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span>Any<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            listener<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"加载证书..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 加载服务器证书</span>
            X509Certificate2 serverCertificate <span class="token operator">=</span> new <span class="token function">X509Certificate2</span><span class="token punctuation">(</span>certificatePath<span class="token punctuation">,</span> certificatePassword<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"等待连接..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">using</span> <span class="token punctuation">(</span>TcpClient client <span class="token operator">=</span> listener<span class="token punctuation">.</span><span class="token function">AcceptTcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">using</span> <span class="token punctuation">(</span>SslStream sslStream <span class="token operator">=</span> new <span class="token function">SslStream</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">GetStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        try
                        <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// 在这里设置支持的协议版本</span>
                            SslProtocols enabledProtocols <span class="token operator">=</span> SslProtocols<span class="token punctuation">.</span>Tls12<span class="token punctuation">;</span>
                            sslStream<span class="token punctuation">.</span><span class="token function">AuthenticateAsServer</span><span class="token punctuation">(</span>serverCertificate<span class="token punctuation">,</span> false<span class="token punctuation">,</span> enabledProtocols<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>

                            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"连接已建立，等待客户端发送数据..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token comment">// 从客户端接收数据</span>
                            byte<span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                            <span class="token keyword">int</span> bytesRead<span class="token punctuation">;</span>
                            StringBuilder data <span class="token operator">=</span> new <span class="token function">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">do</span>
                            <span class="token punctuation">{<!-- --></span>
                                bytesRead <span class="token operator">=</span> sslStream<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                string str <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
                                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bytesRead<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                                <span class="token punctuation">{<!-- --></span>
                                    string str1 <span class="token operator">=</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"X2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    str <span class="token operator">+=</span> str1 <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"接收到的HEX数据:{str}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"接收到的STR数据：{Encoding.UTF8.GetString(buffer, 0, bytesRead)}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                data<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"接收到的数据："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token comment">// 在这里可以对接收到的数据进行处理</span>
                        <span class="token punctuation">}</span>
                        <span class="token function">catch</span> <span class="token punctuation">(</span>Exception ex<span class="token punctuation">)</span>
                        <span class="token punctuation">{<!-- --></span>
                            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"发生异常: "</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> 
<h2><a id="_153"></a>原因分析：</h2> 
<p>这个错误通常表示在 SSL/TLS 握手过程中出现了问题。它可能是由于多种原因引起的，包括证书问题、协议不匹配、密钥问题等。在处理此错误时，可以考虑以下步骤来诊断和解决问题：</p> 
<p>证书问题：确保服务器证书正确配置，并且客户端和服务器都可以访问证书。如果证书被密码保护，请确保在应用程序中提供了正确的密码。</p> 
<p>协议匹配：检查客户端和服务器使用的 SSL/TLS 协议版本是否匹配。你的服务器代码中使用的是 TLS 1.2，因此客户端也应该支持 TLS 1.2。确保协议版本配置正确。</p> 
<p>密钥问题：确保服务器证书的私钥与证书匹配，并且私钥没有被破坏或更改。如果证书和私钥是分开存储的，请确保它们都正确。</p> 
<p>异常处理：在你的代码中，你可以添加更多的异常处理来捕获和处理异常情况，以便更好地了解问题所在。你可以查看异常的详细信息，以获取更多的调试信息。</p> 
<p>日志记录：添加详细的日志记录，以便在发生问题时能够更轻松地追踪问题。记录 SSL/TLS 握手和其他重要事件，以帮助诊断问题。</p> 
<p>防火墙和网络问题：确保防火墙或网络设备没有阻止 SSL/TLS 流量。检查网络配置以确保连接可以建立。</p> 
<p>更新和修复：确保你的操作系统和加密库是最新的，并且已应用所有必要的安全补丁。有时，问题可能是由于已知的漏洞引起的，可以通过更新来解决。</p> 
<p>第三方库和框架：如果你使用了第三方库或框架来处理 SSL/TLS，确保它们是最新版本，并且正确配置。</p> 
<p>最终，诊断和解决 SSL/TLS 握手问题可能需要深入的调试和分析。如果以上步骤无法解决问题，可能需要考虑使用专业的安全工具和服务来帮助排除问题。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2f7072ebb5629c174713c508720f22ca/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">pip is configured with locations that require TLS/SSL, however the ssl module in Python is not avail</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4deafb82db5b7568404416e3c254b1e8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【ctf题目系列】ctfwiki pwn类型</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>