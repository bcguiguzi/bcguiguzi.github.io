<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Odoo多公司指南 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Odoo多公司指南" />
<meta property="og:description" content="启动环境 首先新建一个odoo12环境，并在应用列表中搜索sales并安装。
开启多公司功能 打开settings页面，然后点击点击General Settings, 接着再勾选Multi-companies之后点击保存。页面会重新加载，再次回到设定那栏，选择如图中蓝色方框中的companies进入公司列表，再创建一个名为company sub的公司，并把下面选项中的parent字段的值设置成系统默认自带的YourCompany，这代表company sub是YourCompany的子公司，在多公司规则中，子公司记录之前是独立的，同时父公司可以看到所有子公司的记录。
再次刷新页面，此时页面的右上角便会出现一个可点击的下拉列表允许你切换当前使用的公司。
多公司的基本操作 多公司就如字面意思一样简单直了，所以展示起来也很直接。
单据操作 打开sales模块，默认进来的时候可以发现模块自带了一些demo数据，我们随便点击一个单据进去，由于我们开启了多公司功能并且是用Mitchell Admin登录，系统会为我们当前用户分配多公司权利(只有开启了多公司权利的用户才能使用多公司功能，稍后会讲解这个。)，在Other Information中会出现Company字段，这允许我们通过设置这个字段来让单据数据归属到对应公司。
现在我们设置Company字段的值为我们刚创建的公司company sub,并回到列表视图，在右上角切换当前的公司为company sub,页面刷新好后我们便会发现刚刚编辑的单据出现在了company sub公司的列表视图中，并且我们再也看不到其他单据内容。
此时我们再新建一个单据，并随机填入数据，再通过右上角切换回YourCompany公司，我们会发现刚刚在company sub公司新建的单据也在列表中，这就是刚刚提到的，父公司可以看到子公司全部数据。
用户相关操作 在Settings中打开用户列表，并点击我们当前的用户，可以看到视图中多了Multi Companies的操作项，其中Allowed Companies就是允许该用户能切换到哪些公司，Current Company则代表用户当前是归属到哪个公司。
再往下拉点，在Extra Rights中还有一项与多公司有关的选项Multi Companies,也就是多公司权利,这是odoo中实际控制用户是否可以切换公司，是否在页面显示Company字段的重要选项。如果你勾选了Multi Companies，并且用户的Allowed Companies数量 &gt; 1，那么即使不在settings中开启多公司功能，该用户也可以使用多公司功能。
那么读者可能就会好奇了，如果是这样，那么在settings中开启多公司功能有什么作用呢？它们之前的区别在于，如果设定中开启了多公司功能，那么全用户都拥有改多公司权利，可以查看到页面中Company相关字段，同时，除非Allowed Companies数量 = 1，右上角的多公司切换选项才会消失。如果不通过settings中开启多公司的话，那么可以在用户页面主动分配多公司权利和Allowed Companies，这样就可以只允许特定用户使用多公司的功能。需要注意的是单独Allowed Companies是没有效果的,需要同时勾选中Multi Companies。
为自定义模块实现多公司功能 让项目支持多公司不算复杂，因为odoo已经为我们完成了大量基础代码，我们只要通过两个步骤，即可实现基本的多公司功能。
在自定的相关模型中新增company_id字段
在所有需要多公司功能相关的字段中都需要加上以下示例代码 1 company_id = fields.Many2one(&#39;res.company&#39;, string=&#39;Company&#39;, default=lambda self: self.env.user.company_id) 当然如果单据之前是存在明显关联的外键关系，比如订单和订单项，那么订单项定义该字段时可以通过related属性自动从单据身上获取。增加ir.rule过滤规则
在security中新建xml，并定义相关过滤规则并引入，以下是相关的示例代码 1 2 3 4 5 6 &lt;record id=&#34;account_comp_rule&#34; model=&#34;ir.rule&#34;&gt; &lt;field name=&#34;name&#34;&gt;Account multi-company&lt;/field&gt; &lt;field name=&#34;model_id&#34; ref=&#34;model_account_account&#34;/&gt; &lt;field name=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/9b48c424645ae3105b55487c9fca7c1f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-02T09:37:47+08:00" />
<meta property="article:modified_time" content="2021-12-02T09:37:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Odoo多公司指南</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 id="启动环境">启动环境</h2> 
<p>首先新建一个odoo12环境，并在应用列表中搜索<code>sales</code>并安装。</p> 
<h2 id="开启多公司功能">开启多公司功能</h2> 
<p>打开settings页面，然后点击点击<code>General Settings</code>, 接着再勾选<code>Multi-companies</code>之后点击保存。页面会重新加载，再次回到设定那栏，选择如图中蓝色方框中的<code>companies</code>进入公司列表，再创建一个名为<code>company sub</code>的公司，并把下面选项中的<code>parent</code>字段的值设置成系统默认自带的<code>YourCompany</code>，这代表<code>company sub</code>是<code>YourCompany</code>的子公司，在多公司规则中，子公司记录之前是独立的，同时父公司可以看到所有子公司的记录。</p> 
<p style="text-align:center;"><img alt="alt" src="https://images2.imgbox.com/98/0a/D2kXV6AF_o.png"></p> 
<p>再次刷新页面，此时页面的右上角便会出现一个可点击的下拉列表允许你切换当前使用的公司。</p> 
<h2 id="多公司的基本操作">多公司的基本操作</h2> 
<p>多公司就如字面意思一样简单直了，所以展示起来也很直接。</p> 
<h3 id="单据操作">单据操作</h3> 
<p>打开<code>sales</code>模块，默认进来的时候可以发现模块自带了一些demo数据，我们随便点击一个单据进去，由于我们开启了多公司功能并且是用<code>Mitchell Admin</code>登录，系统会为我们当前用户分配<code>多公司权利</code>(只有开启了多公司权利的用户才能使用多公司功能，稍后会讲解这个。)，在<code>Other Information</code>中会出现<code>Company</code>字段，这允许我们通过设置这个字段来让单据数据归属到对应公司。</p> 
<p>现在我们设置<code>Company</code>字段的值为我们刚创建的公司<code>company sub</code>,并回到列表视图，在右上角切换当前的公司为<code>company sub</code>,页面刷新好后我们便会发现刚刚编辑的单据出现在了<code>company sub</code>公司的列表视图中，并且我们再也看不到其他单据内容。</p> 
<p>此时我们再新建一个单据，并随机填入数据，再通过右上角切换回<code>YourCompany</code>公司，我们会发现刚刚在<code>company sub</code>公司新建的单据也在列表中，这就是刚刚提到的，父公司可以看到子公司全部数据。</p> 
<h3 id="用户相关操作">用户相关操作</h3> 
<p>在<code>Settings</code>中打开用户列表，并点击我们当前的用户，可以看到视图中多了<code>Multi Companies</code>的操作项，其中<code>Allowed Companies</code>就是允许该用户能切换到哪些公司，<code>Current Company</code>则代表用户当前是归属到哪个公司。</p> 
<p style="text-align:center;"><img alt="alt" src="https://images2.imgbox.com/d1/c3/6P50D2uL_o.png"></p> 
<p>再往下拉点，在<code>Extra Rights</code>中还有一项与多公司有关的选项<code>Multi Companies</code>,也就是多公司权利,这是odoo中实际控制用户是否可以切换公司，是否在页面显示<code>Company</code>字段的重要选项。如果你勾选了<code>Multi Companies</code>，并且用户的<code>Allowed Companies</code>数量 &gt; 1，那么即使不在<code>settings</code>中开启多公司功能，该用户也可以使用多公司功能。</p> 
<p>那么读者可能就会好奇了，如果是这样，那么在<code>settings</code>中开启多公司功能有什么作用呢？它们之前的区别在于，如果设定中开启了多公司功能，那么全用户都拥有改多公司权利，可以查看到页面中<code>Company</code>相关字段，同时，除非<code>Allowed Companies</code>数量 = 1，右上角的多公司切换选项才会消失。如果不通过<code>settings</code>中开启多公司的话，那么可以在用户页面主动分配多公司权利和<code>Allowed Companies</code>，这样就可以只允许特定用户使用多公司的功能。需要注意的是单独<code>Allowed Companies</code>是没有效果的,需要同时勾选中<code>Multi Companies</code>。</p> 
<h2 id="为自定义模块实现多公司功能">为自定义模块实现多公司功能</h2> 
<p>让项目支持多公司不算复杂，因为odoo已经为我们完成了大量基础代码，我们只要通过两个步骤，即可实现基本的多公司功能。</p> 
<ol><li>在自定的相关模型中新增<code>company_id</code>字段<br> 在所有需要多公司功能相关的字段中都需要加上以下示例代码 
  <table><tbody><tr><td> <pre>1
</pre> </td><td> <pre>company_id = fields.Many2one('res.company', string='Company', default=lambda self: self.env.user.company_id)
</pre> </td></tr></tbody></table> 当然如果单据之前是存在明显关联的外键关系，比如订单和订单项，那么订单项定义该字段时可以通过<code>related</code>属性自动从单据身上获取。</li><li>增加<code>ir.rule</code>过滤规则<br> 在<code>security</code>中新建xml，并定义相关过滤规则并引入，以下是相关的示例代码 
  <table><tbody><tr><td> <pre>1
2
3
4
5
6
</pre> </td><td> <pre>&lt;record id="account_comp_rule" model="ir.rule"&gt;
     &lt;field name="name"&gt;Account multi-company&lt;/field&gt;
     &lt;field name="model_id" ref="model_account_account"/&gt;
     &lt;field name="global" eval="True"/&gt;
     &lt;field name="domain_force"&gt;['|',('company_id','=',False),('company_id','child_of',[user.company_id.id])]&lt;/field&gt;
 &lt;/record&gt;
</pre> </td></tr></tbody></table> 其中<code>domain_force</code>和<code>global</code>不需要改懂，只要略微修改其余选项对应你的模型即可。</li></ol> 
<p>对模块下模型依次执行以上两个步骤，就基本实现多公司功能了。但是这并不意味着万事大吉了。<br> 在上面的定义代码中我们显然可以知道创建记录的默认公司是用户当前的公司，那么在以下情景中就可能产生问题：</p> 
<ol><li>比如我们在A公司创建订单，那么在父公司B是可以查看并操作A公司的订单，如果此时在B公司中对A公司执行的订单生成送货单的操作，如果没相关处理，那么这个送货单的就<code>Company_id</code>字段的值就是B公司的了，这显然不是我们想要的。</li><li>模块中有相关<code>cron</code>时，基本执行<code>cron</code>的对应的用户是基本是超级管理员，那么<code>cron</code>处理的单据，也可能归属错误的公司。</li><li>有些程序员可能会写<code>sql</code>语句来提高查询性能，如果没注意处理多公司，也会导致只想要单个公司相关数据时，查询了多个公司的数据。</li></ol> 
<p>所以实行了多公司功能的模块，在相关的方法处理中需要更小心，一个比较好的解决方案就是生产相关单据时，主动带上当前单据的<code>Company_id</code>，在写sql相关操作时，也主动获取当前用户公司(可能还有子公司),去查询。</p> 
<h2 id="odoo与多公司相关的实现">odoo与多公司相关的实现</h2> 
<p>之前的段落已经介绍了Odoo多公司的基本逻辑与操作，接下来的我再介绍的一部分多公司内部代码实现，以便更进一步了解多公司和方便定制扩展。</p> 
<h3 id="权限组相关">权限组相关</h3> 
<p>在<code>odoo/addons/base/security/base_groups.xml</code>中有个一个<code>group_multi_company</code>的权限组，也就是多公司权利。</p> 
<table><tbody><tr><td> <pre>1
2
3
</pre> </td><td> <pre>&lt;record model="res.groups" id="group_multi_company"&gt;
    &lt;field name="name"&gt;Multi Companies&lt;/field&gt;
&lt;/record&gt;
</pre> </td></tr></tbody></table> 
<p>它的定义十分简单，但是作用很大，多公司相关功能都是围绕着这个权限组做的。简单的就是属于这个权限组，就可以可以使用多公司的全部功能。<br> 比如许多视图文件中定义<code>Company_id</code>字段都是用如下方式：</p> 
<table><tbody><tr><td> <pre>1
</pre> </td><td> <pre>&lt;field name="company_id" groups="base.group_multi_company"/&gt;
</pre> </td></tr></tbody></table> 
<p>也就是只有拥有多公司权利的用户才可以查看并编辑这个字段，不属于这个权限组的用户看不到这个字段。</p> 
<p>odoo也在代码中为这个权限组做了一些自动加入取消的处理：</p> 
<table><tbody><tr><td> <pre>1
2
3
4
5
6
</pre> </td><td> <pre>group_multi_company = self.env.ref('base.group_multi_company', False)
if group_multi_company and 'company_ids' in values:
    if len(user.company_ids) &lt;= 1 and user.id in group_multi_company.users.ids:
        user.write({'groups_id': [(3, group_multi_company.id)]})
    elif len(user.company_ids) &gt; 1 and user.id not in group_multi_company.users.ids:
        user.write({'groups_id': [(4, group_multi_company.id)]})
</pre> </td></tr></tbody></table> 
<p>这也是上文中提到的<code>settings</code>和<code>Allowed Companies</code>之间关系的逻辑，这里就不多做介绍了。</p> 
<h3 id="session相关">session相关</h3> 
<p>odoo也在<code>web/models/ir_http.py</code>文件中重写了<code>session_info</code>方法，这个方法中提供了用户的公司列表，以及是否显示切换公司的下拉框参数：<br> 我们可以在后台以<code>request.session</code>或者前台编写js模块时以<code>var session = require('web.session');</code>方式来接触session以便获取相关变量。</p> 
<table><tbody><tr><td> <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre> </td><td> <pre>def session_info(self):
        user = request.env.user
        display_switch_company_menu = user.has_group('base.group_multi_company') and len(user.company_ids) &gt; 1
        version_info = odoo.service.common.exp_version()
        return {
            "session_id": request.session.sid,
            "uid": request.session.uid,
            "is_system": user._is_system() if request.session.uid else False,
            "is_admin": user._is_admin() if request.session.uid else False,
            "user_context": request.session.get_context() if request.session.uid else {},
            ....
            "company_id": user.company_id.id if request.session.uid else None,
            "partner_id": user.partner_id.id if request.session.uid and user.partner_id else None,
            "user_companies": {'current_company': (user.company_id.id, user.company_id.name), 'allowed_companies': [(comp.id, comp.name) for comp in user.company_ids]} if display_switch_company_menu else False,
            ....
        }
</pre> </td></tr></tbody></table> 
<h3 id="前台显示相关">前台显示相关</h3> 
<p><code>web/static/src/js/widgets/switch_company_menu.js</code>文件包含了多公司下拉框的处理逻辑，主要逻辑也很简单：</p> 
<table><tbody><tr><td> <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre> </td><td> <pre>tart: function () {
        var companiesList = '';
        if (this.isMobile) {
            companiesList = '&lt;li class="bg-info"&gt;' +
                _t('Tap on the list to change company') + '&lt;/li&gt;';
        }
        else {
            this.$('.oe_topbar_name').text(session.user_companies.current_company[1]);
        }
        _.each(session.user_companies.allowed_companies, function(company) {
            var a = '';
            if (company[0] === session.user_companies.current_company[0]) {
                a = '&lt;i class="fa fa-check mr8"&gt;&lt;/i&gt;';
            } else {
                a = '&lt;span style="margin-right: 24px;"/&gt;';
            }
            companiesList += '&lt;a role="menuitem" href="#" class="dropdown-item" data-menu="company" data-company-id="' +
                            company[0] + '"&gt;' + a + company[1] + '&lt;/a&gt;';
        });
        this.$('.dropdown-menu').html(companiesList);
        return this._super();
    },

    //--------------------------------------------------------------------------
    // Handlers
    //--------------------------------------------------------------------------

    /**
     * @private
     * @param {MouseEvent} ev
     */
    _onClick: function (ev) {
        ev.preventDefault();
        var companyID = $(ev.currentTarget).data('company-id');
        this._rpc({
            model: 'res.users',
            method: 'write',
            args: [[session.uid], {'company_id': companyID}],
        })
        .then(function() {
            location.reload();
        });
    },
</pre> </td></tr></tbody></table> 
<p><code>start</code>方法中根据刚刚提到的<code>session</code>获取公司列表并渲染，<code>_onClick</code>则表视用户选了某个公司就把对应公司<code>id</code>写入到用户的<code>company_id</code>字段中，由此也可以用户当前使用的公司是通过<code>company_id</code>来判断的。</p> 
<p>这里渲染出的下拉项是列表的，有的用户可能是希望可以呈现出公司之间上下级关系，那么这时可以重写后台<code>session_info</code>的方法，再配合第三方组件库如<code>ztree</code>重写前台中的<code>js</code>逻辑实现。</p> 
<h3 id="ir-rule相关">ir.rule相关</h3> 
<p>ir.rule规则，除了我在前文提到在<code>xml</code>中定义的相关数据，odoo还特意写了一个特殊的处理。<br> 在<code>base/models/res_users.py</code>的<code>Users</code>模型中的<code>write</code>方法，有这么一小段代码：</p> 
<table><tbody><tr><td> <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre> </td><td> <pre>if 'company_id' in values:
    for user in self:
        # if partner is global we keep it that way
        if user.partner_id.company_id and user.partner_id.company_id.id != values['company_id']:
            user.partner_id.write({'company_id': user.company_id.id})
    # clear default ir values when company changes
    self.env['ir.default'].clear_caches()

# clear caches linked to the users
if 'groups_id' in values:
    self.env['ir.model.access'].call_cache_clearing_methods()
    self.env['ir.rule'].clear_caches()
    self.has_group.clear_cache(self)
</pre> </td></tr></tbody></table> 
<p>这里可能是因为<code>ir.rule</code>相关权限的<code>domain_forece</code>只会计算一次，然后会缓存下来，所以当相关值变更的时候需要执行<code>self.env['ir.default'].clear_caches()</code>方法。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dccdfdda23136d54d34b9fb2dbcba961/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Odoo自定义视图教程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f1858d22f2ca0b389e5b64a013a7d193/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">国旗制作python</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>