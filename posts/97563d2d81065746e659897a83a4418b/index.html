<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于“xxx” Androidx平台的驱动及系统开发 之 触摸板篇 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于“xxx” Androidx平台的驱动及系统开发 之 触摸板篇" />
<meta property="og:description" content="目录 一、基于全志 A133 Android10平台，适配1366x768 - ilitek2511触摸1、原理图分析2、驱动移植与适配3、补丁和资源文件 二、基于瑞芯微 RK3566 Android11平台，适配GT9XX触摸1、原理图分析2、补丁及资源文件 三、遇到的问题与解决1、基于amlogic Android9平台，使用（V-By-One接口LCD屏，USB接口触摸板）的一体式触摸屏2、基于RK3566 Android11平台，使用（LVDS接口LCD屏，I2C接口触摸板）的分离式触摸屏3、基于GT9XX触摸IC 触摸出现 -&gt; &#34;点偏位&#34; 或 &#34;划线异常不连续&#34;◕对该触摸驱动如何通过“CTP_CFG_GROUPx”这个配置组表更新到触摸IC寄存器内部的有些人可能是通过外部去对触摸进行矫正的，那么就需要把自动写入对应的配置信息组表功能给关了 4、在屏幕熄屏情况下做触摸唤醒屏幕功能，但是内核版本原因，无法使用原厂提供的手势识别功能 一、基于全志 A133 Android10平台，适配1366x768 - ilitek2511触摸 1、原理图分析 ilitek2511触摸使用的时I2C通信，因此重点关注SDA（数据）、SCK（时钟）、INT（中断）、RST（复位）这四个引脚即可。
2、驱动移植与适配 首先我们需要弄清除，触摸驱动是干嘛的，其实它只不过是通过I2C通信方式获取触摸板上触发的每个坐标点信息，通过事件方式上报，像这种通用的事件上报方式（触摸屏），上层的HAL、Framework等，原生Android或者原厂都是已经给做好了，已经只需要移植驱动层即可，一般别的层无需做修改的。
通过触摸IC厂商提供的驱动移植资料修改设备树，如下图原厂提供的设备树和我修改好的设备树。
设备树配置好后，直接将相关的驱动文件拷贝到 a\longan\kernel\linux-4.9\drivers\input\touchscreen 目录下创建的ilitek文件夹下即可，如下图所示。
通过以上操作，基本是已经将触摸驱动移植好了。
3、补丁和资源文件 下载链接
二、基于瑞芯微 RK3566 Android11平台，适配GT9XX触摸 1、原理图分析 2、补丁及资源文件 这里就不多分析了，直接给上补丁文件。
下载链接
三、遇到的问题与解决 1、基于amlogic Android9平台，使用（V-By-One接口LCD屏，USB接口触摸板）的一体式触摸屏 出现问题1：明明获取的USB设备，但是一直处于disconnected断开，一直打印不支持该USB设备，日志如下图所示
解决方法1：其实这个是控制板卡上的液晶屏的参数设置不对引起的，使得它们与触摸控制器不匹配，从而使触摸屏功能无法正常工作。因此只需要更具屏幕规格书修改屏幕参数即可。
2、基于RK3566 Android11平台，使用（LVDS接口LCD屏，I2C接口触摸板）的分离式触摸屏 出现问题1：因为触摸板和LCD屏是分离的，因此有可能出现整合者将触摸板和LCD屏摆放的起始方向不一致 或者 触摸板默认竖屏，而屏幕默认横屏， 这两种原因都会导致触摸和显示UI对不上。
解决方法1：在device/rockchip/3566x/目录下的build.prop文件中添加 persist.sys.touch.orientation=90， 如我设置90就是说将触摸板旋转方向为90度，这样就可以使UI和触摸板对上了。
3、基于GT9XX触摸IC 触摸出现 -&gt; “点偏位” 或 “划线异常不连续” 出现的问题1：在原厂提供的文档可以可知，一般每一种触摸IC都有对应的“CTP_CFG_GROUP”这个触摸配置组的，它作用就是优化矫正触摸的。
解决方法1：在drivers\input\touchscreen\gt9xxnew\gt9xx.h文件中将原厂提供的.cfg峰位文件内从内容替换对应CTP_CFG_GROUPx中的内容，如果不确定CTP_CFG_GROUPx是哪个，那可以选择最无脑的方法，将CTP_CFG_GROUP[1~n]中的内容都给替换掉即可。
◕对该触摸驱动如何通过“CTP_CFG_GROUPx”这个配置组表更新到触摸IC寄存器内部的 找到drivers\input\touchscreen\gt9xxnew\gt9xx.c这个文件，该文件是触摸主功能的驱动文件。
在goodix_ts_probe函数下找到如下图的函数调用：
通过该函数索引到函数实现的位置，这里我把源码贴出来，已注释方式解释了。
/******************************************************* Function: Initialize gtp." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/97563d2d81065746e659897a83a4418b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-05T17:32:13+08:00" />
<meta property="article:modified_time" content="2024-03-05T17:32:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于“xxx” Androidx平台的驱动及系统开发 之 触摸板篇</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li>一、基于全志 A133 Android10平台，适配1366x768 - ilitek2511触摸</li><li><ul><li>1、原理图分析</li><li>2、驱动移植与适配</li><li>3、补丁和资源文件</li></ul> 
  </li><li>二、基于瑞芯微 RK3566 Android11平台，适配GT9XX触摸</li><li><ul><li>1、原理图分析</li><li>2、补丁及资源文件</li></ul> 
  </li><li>三、遇到的问题与解决</li><li><ul><li>1、基于amlogic Android9平台，使用（V-By-One接口LCD屏，USB接口触摸板）的一体式触摸屏</li><li>2、基于RK3566 Android11平台，使用（LVDS接口LCD屏，I2C接口触摸板）的分离式触摸屏</li><li>3、基于GT9XX触摸IC 触摸出现 -&gt; "点偏位" 或 "划线异常不连续"</li><li><ul><li>◕对该触摸驱动如何通过“CTP_CFG_GROUPx”这个配置组表更新到触摸IC寄存器内部的</li><li>有些人可能是通过外部去对触摸进行矫正的，那么就需要把自动写入对应的配置信息组表功能给关了</li></ul> 
   </li><li>4、在屏幕熄屏情况下做触摸唤醒屏幕功能，但是内核版本原因，无法使用原厂提供的手势识别功能</li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_A133_Android101366x768__ilitek2511_1"></a>一、基于全志 A133 Android10平台，适配1366x768 - ilitek2511触摸</h2> 
<h3><a id="1_2"></a>1、原理图分析</h3> 
<p><img src="https://images2.imgbox.com/7c/4c/rspjg38f_o.png" alt="在这里插入图片描述">  ilitek2511触摸使用的时I2C通信，因此重点关注SDA（数据）、SCK（时钟）、INT（中断）、RST（复位）这四个引脚即可。</p> 
<h3><a id="2_4"></a>2、驱动移植与适配</h3> 
<p>  <code>首先我们需要弄清除，触摸驱动是干嘛的，其实它只不过是通过I2C通信方式获取触摸板上触发的每个坐标点信息，通过事件方式上报，像这种通用的事件上报方式（触摸屏），上层的HAL、Framework等，原生Android或者原厂都是已经给做好了，已经只需要移植驱动层即可，一般别的层无需做修改的。</code><br>   通过触摸IC厂商提供的驱动移植资料修改设备树，如下图原厂提供的设备树和我修改好的设备树。<br> <img src="https://images2.imgbox.com/9d/ad/6apjgp60_o.png" alt="在这里插入图片描述"><br>   设备树配置好后，直接将相关的驱动文件拷贝到 a\longan\kernel\linux-4.9\drivers\input\touchscreen 目录下创建的ilitek文件夹下即可，如下图所示。<br> <img src="https://images2.imgbox.com/23/05/XeszPNZM_o.png" alt="在这里插入图片描述">  通过以上操作，基本是已经将触摸驱动移植好了。</p> 
<h3><a id="3_10"></a>3、补丁和资源文件</h3> 
<p><a href="https://download.csdn.net/download/morecrazylove/88882235?spm=1001.2014.3001.5503">下载链接</a></p> 
<h2><a id="_RK3566_Android11GT9XX_13"></a>二、基于瑞芯微 RK3566 Android11平台，适配GT9XX触摸</h2> 
<h3><a id="1_14"></a>1、原理图分析</h3> 
<p><img src="https://images2.imgbox.com/ed/78/vs5WESyD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_16"></a>2、补丁及资源文件</h3> 
<p>  这里就不多分析了，直接给上补丁文件。<br> <a href="https://download.csdn.net/download/morecrazylove/88882519?spm=1001.2014.3001.5503">下载链接</a></p> 
<h2><a id="_19"></a>三、遇到的问题与解决</h2> 
<h3><a id="1amlogic_Android9VByOneLCDUSB_20"></a>1、基于amlogic Android9平台，使用（V-By-One接口LCD屏，USB接口触摸板）的一体式触摸屏</h3> 
<p>出现问题1：<code>明明获取的USB设备，但是一直处于disconnected断开，一直打印不支持该USB设备，日志如下图所示</code><br> <img src="https://images2.imgbox.com/63/5f/A0yRmqkN_o.png" alt="在这里插入图片描述"><br> 解决方法1：<code>其实这个是控制板卡上的液晶屏的参数设置不对引起的，使得它们与触摸控制器不匹配，从而使触摸屏功能无法正常工作。因此只需要更具屏幕规格书修改屏幕参数即可。</code></p> 
<h3><a id="2RK3566_Android11LVDSLCDI2C_25"></a>2、基于RK3566 Android11平台，使用（LVDS接口LCD屏，I2C接口触摸板）的分离式触摸屏</h3> 
<p>出现问题1：<code>因为触摸板和LCD屏是分离的，因此有可能出现整合者将触摸板和LCD屏摆放的起始方向不一致 或者 触摸板默认竖屏，而屏幕默认横屏， 这两种原因都会导致触摸和显示UI对不上。</code><br> 解决方法1：<code>在device/rockchip/3566x/目录下的build.prop文件中添加 persist.sys.touch.orientation=90， 如我设置90就是说将触摸板旋转方向为90度，这样就可以使UI和触摸板对上了。</code></p> 
<h3><a id="3GT9XXIC______29"></a>3、基于GT9XX触摸IC 触摸出现 -&gt; “点偏位” 或 “划线异常不连续”</h3> 
<p>出现的问题1：<code>在原厂提供的文档可以可知，一般每一种触摸IC都有对应的“CTP_CFG_GROUP”这个触摸配置组的，它作用就是优化矫正触摸的。</code><br> 解决方法1：<code>在drivers\input\touchscreen\gt9xxnew\gt9xx.h文件中将原厂提供的.cfg峰位文件内从内容替换对应CTP_CFG_GROUPx中的内容，如果不确定CTP_CFG_GROUPx是哪个，那可以选择最无脑的方法，将CTP_CFG_GROUP[1~n]中的内容都给替换掉即可。</code></p> 
<h4><a id="CTP_CFG_GROUPxIC_32"></a>◕对该触摸驱动如何通过“CTP_CFG_GROUPx”这个配置组表更新到触摸IC寄存器内部的</h4> 
<p>  找到drivers\input\touchscreen\gt9xxnew\gt9xx.c这个文件，该文件是触摸主功能的驱动文件。<br>   在goodix_ts_probe函数下找到如下图的函数调用：<br> <img src="https://images2.imgbox.com/2f/bd/mgmrj51y_o.png" alt="在这里插入图片描述"><br>   通过该函数索引到函数实现的位置，这里我把源码贴出来，已注释方式解释了。</p> 
<pre><code class="prism language-c"><span class="token comment">/*******************************************************
Function:
    Initialize gtp.
Input:
    ts: goodix private data
Output:
    Executive outcomes.
        0: succeed, otherwise: failed
*******************************************************/</span>
<span class="token keyword">static</span> s32 <span class="token function">gtp_init_panel</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">goodix_ts_data</span> <span class="token operator">*</span>ts<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    s32 ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">GTP_DRIVER_SEND_CFG</span></span>
    s32 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    u8 check_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    u8 opr_buf<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    u8 sensor_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
	<span class="token comment">/***************************（1）*********************************/</span>
	<span class="token comment">/* 这一部分是获取gt9xx.h文件定义的CTP_CFG_GROUPx配置信息组的信息到cfg_info_groupx[]中 */</span>
    u8 cfg_info_group1<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> CTP_CFG_GROUP1<span class="token punctuation">;</span>
    u8 cfg_info_group2<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> CTP_CFG_GROUP2<span class="token punctuation">;</span>
    u8 cfg_info_group3<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> CTP_CFG_GROUP3<span class="token punctuation">;</span>
    u8 cfg_info_group4<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> CTP_CFG_GROUP4<span class="token punctuation">;</span>
    u8 cfg_info_group5<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> CTP_CFG_GROUP5<span class="token punctuation">;</span>
    u8 cfg_info_group6<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> CTP_CFG_GROUP6<span class="token punctuation">;</span>
    u8 cfg_info_group7<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> CTP_CFG_GROUP7<span class="token punctuation">;</span>
	u8 cfg_info_group8<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> CTP_CFG_GROUP8<span class="token punctuation">;</span>
	<span class="token comment">/***************************（1）*********************************/</span>
	
	<span class="token comment">/***************************（2）*********************************/</span>
	<span class="token comment">/* 这个是创建send_cfg_buf数组，将上面活动的cfg_info_groupx信息保以元素存到该数组里 */</span>
    u8 <span class="token operator">*</span>send_cfg_buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>cfg_info_group1<span class="token punctuation">,</span> cfg_info_group2<span class="token punctuation">,</span> cfg_info_group3<span class="token punctuation">,</span>
                        cfg_info_group4<span class="token punctuation">,</span> cfg_info_group5<span class="token punctuation">,</span> cfg_info_group6<span class="token punctuation">,</span>
						cfg_info_group7<span class="token punctuation">,</span> cfg_info_group8<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">/***************************（2）*********************************/</span>
	
	<span class="token comment">/***************************（3）*********************************/</span>
	<span class="token comment">/* CFG_GROUP_LEN这个方法在gt9xx.h文件中有定义，原型是#define CFG_GROUP_LEN(p_cfg_grp)  (sizeof(p_cfg_grp) / sizeof(p_cfg_grp[0]))，它是计算数组的长度的 */</span>
    u8 cfg_info_len<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token function">CFG_GROUP_LEN</span><span class="token punctuation">(</span>cfg_info_group1<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token function">CFG_GROUP_LEN</span><span class="token punctuation">(</span>cfg_info_group2<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token function">CFG_GROUP_LEN</span><span class="token punctuation">(</span>cfg_info_group3<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token function">CFG_GROUP_LEN</span><span class="token punctuation">(</span>cfg_info_group4<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token function">CFG_GROUP_LEN</span><span class="token punctuation">(</span>cfg_info_group5<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token function">CFG_GROUP_LEN</span><span class="token punctuation">(</span>cfg_info_group6<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token function">CFG_GROUP_LEN</span><span class="token punctuation">(</span>cfg_info_group7<span class="token punctuation">)</span><span class="token punctuation">,</span>
						  <span class="token function">CFG_GROUP_LEN</span><span class="token punctuation">(</span>cfg_info_group8<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">/***************************（3）*********************************/</span>
        <span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"Config Groups Lengths: %d, %d, %d, %d, %d, %d, %d, %d\n"</span><span class="token punctuation">,</span>
        cfg_info_len<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cfg_info_len<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cfg_info_len<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cfg_info_len<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        cfg_info_len<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cfg_info_len<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cfg_info_len<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cfg_info_len<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">GTP_COMPATIBLE_MODE</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CHIP_TYPE_GT9F <span class="token operator">==</span> ts<span class="token operator">-&gt;</span>chip_type<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ts<span class="token operator">-&gt;</span>fw_error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/***************************（4）*********************************/</span>
    <span class="token comment">/* 检测固件是否正常 */</span>
        ret <span class="token operator">=</span> <span class="token function">gtp_i2c_read_dbl_check</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>client<span class="token punctuation">,</span> <span class="token number">0x41E4</span><span class="token punctuation">,</span> opr_buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>SUCCESS <span class="token operator">==</span> ret<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>opr_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0xBE</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                ts<span class="token operator">-&gt;</span>fw_error <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"Firmware error, no config sent!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token comment">/***************************（4）*********************************/</span>
    <span class="token punctuation">}</span>
    
	<span class="token comment">/***************************（5）*********************************/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>cfg_info_len<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>cfg_info_len<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token operator">!</span>cfg_info_len<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>cfg_info_len<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token operator">!</span>cfg_info_len<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>cfg_info_len<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
		<span class="token punctuation">(</span><span class="token operator">!</span>cfg_info_len<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">/* 如果所有配置信息组内容都为空，sensor_id值设置为0 */</span>
        sensor_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">GTP_COMPATIBLE_MODE</span></span>
        <span class="token function">msleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 <span class="token comment">//       ret = gtp_i2c_read_dbl_check(ts-&gt;client, GTP_REG_SENSOR_ID, &amp;sensor_id, 1);</span>
 		
 		<span class="token comment">/* 下面是判断配置信息的名称是对应哪个触摸IC的名称，从而再设置其对应的sensor_id值 */</span>
		<span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"CTP name : %s\n"</span><span class="token punctuation">,</span>config_info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>config_info<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">"gt9271_mb976a9"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"gt9xx:sensor_id = %d\n"</span><span class="token punctuation">,</span>sensor_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>config_info<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">"gt9110_wt097"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            sensor_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"gt9xx:sensor_id = %d\n"</span><span class="token punctuation">,</span>sensor_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>config_info<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">"gt9271_wt097"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            sensor_id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"gt9xx:sensor_id = %d\n"</span><span class="token punctuation">,</span>sensor_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>config_info<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">"gt9110_g200"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            sensor_id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"gt9xx:sensor_id = %d\n"</span><span class="token punctuation">,</span>sensor_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>config_info<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">"gt9271_noah"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            sensor_id <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"gt9xx:sensor_id = %d\n"</span><span class="token punctuation">,</span>sensor_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>config_info<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">"gt9271_p2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            sensor_id <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
            <span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"gt9xx:sensor_id = %d\n"</span><span class="token punctuation">,</span>sensor_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>config_info<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"gt911_1060"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			sensor_id <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
			<span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"gt9xx:sensor_id = %d\n"</span><span class="token punctuation">,</span>sensor_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>config_info<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"gt911_784"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			sensor_id <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
			<span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"gt9xx:sensor_id = %d\n"</span><span class="token punctuation">,</span>sensor_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            sensor_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"gt9xx:sensor_id = %d\n"</span><span class="token punctuation">,</span>sensor_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		ret <span class="token operator">=</span> SUCCESS<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>SUCCESS <span class="token operator">==</span> ret<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sensor_id <span class="token operator">&gt;=</span> <span class="token number">0x08</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"Invalid sensor_id(0x%02X), No Config Sent!\n"</span><span class="token punctuation">,</span> sensor_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ts<span class="token operator">-&gt;</span>pnl_init_error <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"Failed to get sensor_id, No config sent!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ts<span class="token operator">-&gt;</span>pnl_init_error <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"Sensor_ID: %d"</span><span class="token punctuation">,</span> sensor_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">/***************************（5）*********************************/</span>

	<span class="token comment">/***************************（6）*********************************/</span>
	<span class="token comment">/* 上面设置的sensor_id值就是用来选择send_cfg_buf数组对应的触配置信息组元素的，这里获取对应配置信息组表的长度 */</span>
    ts<span class="token operator">-&gt;</span>gtp_cfg_len <span class="token operator">=</span> cfg_info_len<span class="token punctuation">[</span>sensor_id<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/***************************（6）*********************************/</span>
    
    <span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"CTP_CONFIG_GROUP%d used, config length: %d\n"</span><span class="token punctuation">,</span> sensor_id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> ts<span class="token operator">-&gt;</span>gtp_cfg_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/***************************（7）*********************************/</span>
	<span class="token comment">/* 用获取对应配置信息组表的长度与定义的配置信息组表最小长度作对比，确保配置信息组表的数据在长度上是符合的 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>gtp_cfg_len <span class="token operator">&lt;</span> GTP_CONFIG_MIN_LENGTH<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"Config Group%d is INVALID CONFIG GROUP(Len: %d)! NO Config Sent! You need to check you header file CFG_GROUP section!\n"</span><span class="token punctuation">,</span> sensor_id<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> ts<span class="token operator">-&gt;</span>gtp_cfg_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ts<span class="token operator">-&gt;</span>pnl_init_error <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/***************************（7）*********************************/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">GTP_COMPATIBLE_MODE</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CHIP_TYPE_GT9F <span class="token operator">==</span> ts<span class="token operator">-&gt;</span>chip_type<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ts<span class="token operator">-&gt;</span>fixed_cfg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/***************************（8）*********************************/</span>
    <span class="token comment">/* 获取IC寄存器对应的配置信息版本 */</span>
        ret <span class="token operator">=</span> <span class="token function">gtp_i2c_read_dbl_check</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>client<span class="token punctuation">,</span> GTP_REG_CONFIG_DATA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>opr_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> SUCCESS<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"CFG_GROUP%d Config Version: %d, 0x%02X; IC Config Version: %d, 0x%02X\n"</span><span class="token punctuation">,</span> sensor_id<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>
                        send_cfg_buf<span class="token punctuation">[</span>sensor_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> send_cfg_buf<span class="token punctuation">[</span>sensor_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opr_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opr_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>opr_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">155</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                grp_cfg_version <span class="token operator">=</span> send_cfg_buf<span class="token punctuation">[</span>sensor_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">// backup group config version</span>
                send_cfg_buf<span class="token punctuation">[</span>sensor_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
                ts<span class="token operator">-&gt;</span>fixed_cfg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">/* 如果是opr_buf[0] &lt; 155这种条件下，那么这个配置信息组不设置为固定不变标志 */</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>        <span class="token comment">// treated as fixed config, not send config</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">dprintk</span><span class="token punctuation">(</span>DEBUG_INIT<span class="token punctuation">,</span><span class="token string">"Ic fixed config with config version(%d, 0x%02X)\n"</span><span class="token punctuation">,</span> opr_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opr_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ts<span class="token operator">-&gt;</span>fixed_cfg <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">/* 配置信息组设置为固定不变标志 */</span>
                <span class="token function">gtp_get_info</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"Failed to get ic config version!No config sent!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token comment">/***************************（8）*********************************/</span>
    <span class="token punctuation">}</span>
	
	<span class="token comment">/***************************（9）*********************************/</span>
	<span class="token comment">/* 将send_cfg_buf[sensor_id]这个对应的配置信息组表信息拷贝到 config[GTP_ADDR_LENGTH]这个数组指定的开始位置中 */</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">[</span>GTP_ADDR_LENGTH<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GTP_CONFIG_MAX_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">[</span>GTP_ADDR_LENGTH<span class="token punctuation">]</span><span class="token punctuation">,</span> send_cfg_buf<span class="token punctuation">[</span>sensor_id<span class="token punctuation">]</span><span class="token punctuation">,</span> ts<span class="token operator">-&gt;</span>gtp_cfg_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/***************************（9）*********************************/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">GTP_CUSTOM_CFG</span></span>
    config<span class="token punctuation">[</span>RESOLUTION_LOC<span class="token punctuation">]</span>     <span class="token operator">=</span> <span class="token punctuation">(</span>u8<span class="token punctuation">)</span>GTP_MAX_WIDTH<span class="token punctuation">;</span>
    config<span class="token punctuation">[</span>RESOLUTION_LOC <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span>GTP_MAX_WIDTH<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">[</span>RESOLUTION_LOC <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>u8<span class="token punctuation">)</span>GTP_MAX_HEIGHT<span class="token punctuation">;</span>
    config<span class="token punctuation">[</span>RESOLUTION_LOC <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">(</span>GTP_MAX_HEIGHT<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>GTP_INT_TRIGGER <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//RISING</span>
    <span class="token punctuation">{<!-- --></span>
        config<span class="token punctuation">[</span>TRIGGER_LOC<span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token number">0xfe</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>GTP_INT_TRIGGER <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//FALLING</span>
    <span class="token punctuation">{<!-- --></span>
        config<span class="token punctuation">[</span>TRIGGER_LOC<span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// GTP_CUSTOM_CFG</span></span>

	<span class="token comment">/***************************（10）*********************************/</span>
	<span class="token comment">/* 计算校验和，并将校验和设置到config数组中 */</span>
    check_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> GTP_ADDR_LENGTH<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ts<span class="token operator">-&gt;</span>gtp_cfg_len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        check_sum <span class="token operator">+=</span> config<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    config<span class="token punctuation">[</span>ts<span class="token operator">-&gt;</span>gtp_cfg_len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">~</span>check_sum<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">/***************************（10）*********************************/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">// driver not send config</span></span>

    ts<span class="token operator">-&gt;</span>gtp_cfg_len <span class="token operator">=</span> GTP_CONFIG_MAX_LENGTH<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">gtp_i2c_read</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>client<span class="token punctuation">,</span> config<span class="token punctuation">,</span> ts<span class="token operator">-&gt;</span>gtp_cfg_len <span class="token operator">+</span> GTP_ADDR_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">GTP_ERROR</span><span class="token punctuation">(</span><span class="token string">"Read Config Failed, Using Default Resolution &amp; INT Trigger!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ts<span class="token operator">-&gt;</span>abs_x_max <span class="token operator">=</span> GTP_MAX_WIDTH<span class="token punctuation">;</span>
        ts<span class="token operator">-&gt;</span>abs_y_max <span class="token operator">=</span> GTP_MAX_HEIGHT<span class="token punctuation">;</span>
        ts<span class="token operator">-&gt;</span>int_trigger_type <span class="token operator">=</span> GTP_INT_TRIGGER<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// GTP_DRIVER_SEND_CFG</span></span>

	<span class="token comment">/***************************（11）*********************************/</span>
	<span class="token comment">/* 修正abs_x_max、abs_y_max、int_trigger_type的值   */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>abs_x_max <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>abs_y_max <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ts<span class="token operator">-&gt;</span>abs_x_max <span class="token operator">=</span> <span class="token punctuation">(</span>config<span class="token punctuation">[</span>RESOLUTION_LOC <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> config<span class="token punctuation">[</span>RESOLUTION_LOC<span class="token punctuation">]</span><span class="token punctuation">;</span>
        ts<span class="token operator">-&gt;</span>abs_y_max <span class="token operator">=</span> <span class="token punctuation">(</span>config<span class="token punctuation">[</span>RESOLUTION_LOC <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> config<span class="token punctuation">[</span>RESOLUTION_LOC <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        ts<span class="token operator">-&gt;</span>int_trigger_type <span class="token operator">=</span> <span class="token punctuation">(</span>config<span class="token punctuation">[</span>TRIGGER_LOC<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">/***************************（11）*********************************/</span>
	
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">GTP_COMPATIBLE_MODE</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CHIP_TYPE_GT9F <span class="token operator">==</span> ts<span class="token operator">-&gt;</span>chip_type<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        u8 sensor_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        u8 driver_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        u8 have_key <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        have_key <span class="token operator">=</span> <span class="token punctuation">(</span>config<span class="token punctuation">[</span>GTP_REG_HAVE_KEY <span class="token operator">-</span> GTP_REG_CONFIG_DATA <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> ts<span class="token operator">-&gt;</span>is_950<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            driver_num <span class="token operator">=</span> config<span class="token punctuation">[</span>GTP_REG_MATRIX_DRVNUM <span class="token operator">-</span> GTP_REG_CONFIG_DATA <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            sensor_num <span class="token operator">=</span> config<span class="token punctuation">[</span>GTP_REG_MATRIX_SENNUM <span class="token operator">-</span> GTP_REG_CONFIG_DATA <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>have_key<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                driver_num<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ts<span class="token operator">-&gt;</span>bak_ref_len <span class="token operator">=</span> <span class="token punctuation">(</span>driver_num <span class="token operator">*</span> <span class="token punctuation">(</span>sensor_num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            driver_num <span class="token operator">=</span> <span class="token punctuation">(</span>config<span class="token punctuation">[</span>CFG_LOC_DRVA_NUM<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x1F</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>config<span class="token punctuation">[</span>CFG_LOC_DRVB_NUM<span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x1F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>have_key<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                driver_num<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            sensor_num <span class="token operator">=</span> <span class="token punctuation">(</span>config<span class="token punctuation">[</span>CFG_LOC_SENS_NUM<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span>CFG_LOC_SENS_NUM<span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ts<span class="token operator">-&gt;</span>bak_ref_len <span class="token operator">=</span> <span class="token punctuation">(</span>driver_num <span class="token operator">*</span> <span class="token punctuation">(</span>sensor_num <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">GTP_INFO</span><span class="token punctuation">(</span><span class="token string">"Drv * Sen: %d * %d(key: %d), X_MAX: %d, Y_MAX: %d, TRIGGER: 0x%02x"</span><span class="token punctuation">,</span>
           driver_num<span class="token punctuation">,</span> sensor_num<span class="token punctuation">,</span> have_key<span class="token punctuation">,</span> ts<span class="token operator">-&gt;</span>abs_x_max<span class="token punctuation">,</span>ts<span class="token operator">-&gt;</span>abs_y_max<span class="token punctuation">,</span>ts<span class="token operator">-&gt;</span>int_trigger_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">GTP_DRIVER_SEND_CFG</span></span>
    <span class="token comment">/***************************（12）*********************************/</span>
    <span class="token comment">/* 通过调用gtp_send_cfg将已经整好的config配置信息组表数据写入到触摸IC对应的寄存器中 */</span>
        ret <span class="token operator">=</span> <span class="token function">gtp_send_cfg</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">GTP_ERROR</span><span class="token punctuation">(</span><span class="token string">"Send config error."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// set config version to CTP_CFG_GROUP, for resume to send config</span>
        config<span class="token punctuation">[</span>GTP_ADDR_LENGTH<span class="token punctuation">]</span> <span class="token operator">=</span> grp_cfg_version<span class="token punctuation">;</span>
        check_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> GTP_ADDR_LENGTH<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ts<span class="token operator">-&gt;</span>gtp_cfg_len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            check_sum <span class="token operator">+=</span> config<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        config<span class="token punctuation">[</span>ts<span class="token operator">-&gt;</span>gtp_cfg_len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">~</span>check_sum<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">/***************************（12）*********************************/</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token function">GTP_INFO</span><span class="token punctuation">(</span><span class="token string">"X_MAX: %d, Y_MAX: %d, TRIGGER: 0x%02x"</span><span class="token punctuation">,</span> ts<span class="token operator">-&gt;</span>abs_x_max<span class="token punctuation">,</span>ts<span class="token operator">-&gt;</span>abs_y_max<span class="token punctuation">,</span>ts<span class="token operator">-&gt;</span>int_trigger_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">msleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  gtp_send_cfg函数原型，如下所示：</p> 
<pre><code class="prism language-c"><span class="token comment">/*******************************************************
Function:
    Send config.
Input:
    client: i2c device.
Output:
    result of i2c write operation.
        1: succeed, otherwise: failed
*********************************************************/</span>

s32 <span class="token function">gtp_send_cfg</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    s32 ret <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">GTP_DRIVER_SEND_CFG</span></span>
    s32 retry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">goodix_ts_data</span> <span class="token operator">*</span>ts <span class="token operator">=</span> <span class="token function">i2c_get_clientdata</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>fixed_cfg<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">GTP_INFO</span><span class="token punctuation">(</span><span class="token string">"Ic fixed config, no config sent!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>pnl_init_error<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">GTP_INFO</span><span class="token punctuation">(</span><span class="token string">"Error occured in init_panel, no config sent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">GTP_INFO</span><span class="token punctuation">(</span><span class="token string">"Driver send config."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>retry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> retry <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> retry<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">gtp_i2c_write</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> config <span class="token punctuation">,</span> GTP_CONFIG_MAX_LENGTH <span class="token operator">+</span> GTP_ADDR_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_406"></a>有些人可能是通过外部去对触摸进行矫正的，那么就需要把自动写入对应的配置信息组表功能给关了</h4> 
<p>  在gt9xx.h文件中将<code>#define GTP_DRIVER_SEND_CFG 1</code>设置成0即可。</p> 
<h3><a id="4_409"></a>4、在屏幕熄屏情况下做触摸唤醒屏幕功能，但是内核版本原因，无法使用原厂提供的手势识别功能</h3> 
<p>出现问题1：<code>由于我使用的内核版本与移植的触摸驱动使用的内核版本相差较大，导致无法使用原厂提供的手势识别功能。</code><br> 须知：一般来说，触摸芯片厂商提供的触摸驱动内部有自带手势识别处理程序，也就是说一般是带有触摸唤醒的功能的。但是，一般默认是不使能的，也就是需要通过宏定义取打开的，我这里以Goodix Touchscreen驱动举例：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">goodix_ts_work_func</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">work_struct</span> <span class="token operator">*</span>work<span class="token punctuation">)</span>
</code></pre> 
<p>  这个函数就是处理手势识别的处理工作函数，那么这个就需要先启用“GTP_GESTURE_WAKEUP”这个宏定义才能开启手势功能的程序，而手势功能的程序需要启用“CONFIG_HAS_EARLYSUSPEND”这个挂起功能宏定义，才能让手势功能正常使用，但遗憾的是开启“CONFIG_HAS_EARLYSUSPEND”这个挂机功能的宏定义，有几个使用的内核接口函数都不存在，也就说明该驱动程序的手势功能在我这个Linux内核版本不支持。<br> 解决方法1：<code>我的Linux内核版本不支持，因此只能自己手动获取屏幕熄屏和亮屏状态，然后在上报触摸事件是上报“KEY_POWER”事件来开启屏幕。所以我需要先获取屏幕是开启还是休眠状态，通过这个状态去控制是否上报“KEY_POWER”事件来开启屏幕，从而避免在开屏状态下上报了“KEY_POWER”事件导致关屏发生。</code><br>   这里我将我修改的补丁贴出，如下所示：</p> 
<pre><code class="prism language-c">commit cdc3304684b7d6ef469a2e8ef401e5882ef07748
Author<span class="token operator">:</span> dengjiawen <span class="token operator">&lt;</span><span class="token number">1411471554</span>@qq<span class="token punctuation">.</span>com<span class="token operator">&gt;</span>
Date<span class="token operator">:</span>   Fri Oct <span class="token number">20</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">32</span><span class="token operator">:</span><span class="token number">46</span> <span class="token number">2023</span> <span class="token operator">+</span><span class="token number">0800</span>

    屏幕息屏或者睡眠模式下，可触摸唤醒屏幕（基于gt9xx触摸系列添加该功能）

diff <span class="token operator">--</span>git a<span class="token operator">/</span>longan<span class="token operator">/</span>kernel<span class="token operator">/</span>linux<span class="token operator">-</span><span class="token number">4.9</span><span class="token operator">/</span>drivers<span class="token operator">/</span>input<span class="token operator">/</span>touchscreen<span class="token operator">/</span>gt9xxnew<span class="token operator">/</span>gt9xx<span class="token punctuation">.</span>c b<span class="token operator">/</span>longan<span class="token operator">/</span>kernel<span class="token operator">/</span>linux<span class="token operator">-</span><span class="token number">4.9</span><span class="token operator">/</span>drivers<span class="token operator">/</span>input<span class="token operator">/</span>touchscreen<span class="token operator">/</span>gt9xxnew<span class="token operator">/</span>gt9xx<span class="token punctuation">.</span>c
index <span class="token number">77</span>dc9bc566<span class="token punctuation">.</span><span class="token punctuation">.</span>af1bc4be38 <span class="token number">100644</span>
<span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>longan<span class="token operator">/</span>kernel<span class="token operator">/</span>linux<span class="token operator">-</span><span class="token number">4.9</span><span class="token operator">/</span>drivers<span class="token operator">/</span>input<span class="token operator">/</span>touchscreen<span class="token operator">/</span>gt9xxnew<span class="token operator">/</span>gt9xx<span class="token punctuation">.</span>c
<span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>longan<span class="token operator">/</span>kernel<span class="token operator">/</span>linux<span class="token operator">-</span><span class="token number">4.9</span><span class="token operator">/</span>drivers<span class="token operator">/</span>input<span class="token operator">/</span>touchscreen<span class="token operator">/</span>gt9xxnew<span class="token operator">/</span>gt9xx<span class="token punctuation">.</span>c
@@ <span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">7</span> <span class="token operator">+</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">9</span> @@
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/irq.h&gt;</span></span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"gt9xx.h"</span></span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/pm_runtime.h&gt;</span></span>
<span class="token operator">+</span>#include <span class="token string">"../../../video/fbdev/sunxi/disp2/disp/dev_disp.h"</span>
 
<span class="token operator">+</span><span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">get_screen_status</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">/* 声明引入获取屏幕状态函数 */</span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PM</span></span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/pm.h&gt;</span></span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
@@ <span class="token operator">-</span><span class="token number">664</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">666</span><span class="token punctuation">,</span><span class="token number">22</span> @@ <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">gtp_touch_down</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">goodix_ts_data</span><span class="token operator">*</span> ts<span class="token punctuation">,</span>s32 id<span class="token punctuation">,</span>s32 x<span class="token punctuation">,</span>s32 y<span class="token punctuation">,</span>s32 w<span class="token punctuation">)</span>
     <span class="token function">input_report_abs</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>input_dev<span class="token punctuation">,</span> ABS_MT_TOUCH_MAJOR<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">input_report_abs</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>input_dev<span class="token punctuation">,</span> ABS_MT_WIDTH_MAJOR<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">input_report_abs</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>input_dev<span class="token punctuation">,</span> ABS_MT_TRACKING_ID<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token comment">/************************* 获取屏幕状态，上报KEY_POWER事件来打开屏幕 *********************************/</span>
<span class="token operator">+</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"get_screen_status = %d\n"</span><span class="token punctuation">,</span><span class="token function">get_screen_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">get_screen_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        <span class="token comment">/* 亮屏状态，不发出KEY_POWER事件唤醒屏幕 */</span>
<span class="token operator">+</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"screen is open\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        <span class="token comment">/* 熄屏状态，发出KEY_POWER事件唤醒屏幕 */</span>
<span class="token operator">+</span>        <span class="token function">input_event</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>input_dev<span class="token punctuation">,</span>EV_KEY<span class="token punctuation">,</span>KEY_POWER<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token function">input_sync</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>input_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token function">input_event</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>input_dev<span class="token punctuation">,</span>EV_KEY<span class="token punctuation">,</span>KEY_POWER<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token function">input_sync</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>input_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"screen is close,in open the screen......\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span><span class="token comment">/*****************************************************************************************************/</span>
<span class="token operator">+</span>
     <span class="token function">input_mt_sync</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>input_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
@@ <span class="token operator">-</span><span class="token number">2150</span><span class="token punctuation">,</span><span class="token number">7</span> <span class="token operator">+</span><span class="token number">2168</span><span class="token punctuation">,</span><span class="token number">7</span> @@ <span class="token keyword">static</span> s8 <span class="token function">gtp_request_input_dev</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">goodix_ts_data</span> <span class="token operator">*</span>ts<span class="token punctuation">)</span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">GTP_ICS_SLOT_REPORT</span></span>
     <span class="token function">input_mt_init_slots</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>input_dev<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// in case of "out of memory"</span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token operator">-</span>    ts<span class="token operator">-&gt;</span>input_dev<span class="token operator">-&gt;</span>keybit<span class="token punctuation">[</span><span class="token function">BIT_WORD</span><span class="token punctuation">(</span>BTN_TOUCH<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BIT_MASK</span><span class="token punctuation">(</span>BTN_TOUCH<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    ts<span class="token operator">-&gt;</span>input_dev<span class="token operator">-&gt;</span>keybit<span class="token punctuation">[</span><span class="token function">BIT_WORD</span><span class="token punctuation">(</span>BTN_TOUCH<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BIT_MASK</span><span class="token punctuation">(</span>BTN_TOUCH<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">BIT_MASK</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 增加外部按键事件掩码，用于KEY_POWER事件 */</span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
     <span class="token function">__set_bit</span><span class="token punctuation">(</span>INPUT_PROP_DIRECT<span class="token punctuation">,</span> ts<span class="token operator">-&gt;</span>input_dev<span class="token operator">-&gt;</span>propbit<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
@@ <span class="token operator">-</span><span class="token number">2169</span><span class="token punctuation">,</span><span class="token number">7</span> <span class="token operator">+</span><span class="token number">2187</span><span class="token punctuation">,</span><span class="token number">7</span> @@ <span class="token keyword">if</span><span class="token punctuation">(</span>gtp_gesture_wakeup<span class="token punctuation">)</span>
        <span class="token function">input_set_capability</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>input_dev<span class="token punctuation">,</span> EV_KEY<span class="token punctuation">,</span> ctp_key_list<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token comment">//#endif</span>
<span class="token operator">-</span>
<span class="token operator">+</span>    <span class="token function">input_set_capability</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>input_dev<span class="token punctuation">,</span> EV_KEY<span class="token punctuation">,</span> KEY_POWER<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">/* 将按键功能 KEY_POWER 添加到输入设备中的按键功能列表中。这意味着输入设备可以检测到并报告关于电源键的按下和释放事件 */</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> exchange_x_y_flag<span class="token punctuation">)</span>
     <span class="token function">swap</span><span class="token punctuation">(</span>ts<span class="token operator">-&gt;</span>abs_x_max<span class="token punctuation">,</span> ts<span class="token operator">-&gt;</span>abs_y_max<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
diff <span class="token operator">--</span>git a<span class="token operator">/</span>longan<span class="token operator">/</span>kernel<span class="token operator">/</span>linux<span class="token operator">-</span><span class="token number">4.9</span><span class="token operator">/</span>drivers<span class="token operator">/</span>video<span class="token operator">/</span>fbdev<span class="token operator">/</span>sunxi<span class="token operator">/</span>disp2<span class="token operator">/</span>disp<span class="token operator">/</span>dev_disp<span class="token punctuation">.</span>c b<span class="token operator">/</span>longan<span class="token operator">/</span>kernel<span class="token operator">/</span>linux<span class="token operator">-</span><span class="token number">4.9</span><span class="token operator">/</span>drivers<span class="token operator">/</span>video<span class="token operator">/</span>fbdev<span class="token operator">/</span>sunxi<span class="token operator">/</span>disp2<span class="token operator">/</span>disp<span class="token operator">/</span>dev_disp<span class="token punctuation">.</span>c
index <span class="token number">16</span>c45a6529<span class="token punctuation">.</span><span class="token number">.8</span>c3006fd25 <span class="token number">100644</span>
<span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>longan<span class="token operator">/</span>kernel<span class="token operator">/</span>linux<span class="token operator">-</span><span class="token number">4.9</span><span class="token operator">/</span>drivers<span class="token operator">/</span>video<span class="token operator">/</span>fbdev<span class="token operator">/</span>sunxi<span class="token operator">/</span>disp2<span class="token operator">/</span>disp<span class="token operator">/</span>dev_disp<span class="token punctuation">.</span>c
<span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>longan<span class="token operator">/</span>kernel<span class="token operator">/</span>linux<span class="token operator">-</span><span class="token number">4.9</span><span class="token operator">/</span>drivers<span class="token operator">/</span>video<span class="token operator">/</span>fbdev<span class="token operator">/</span>sunxi<span class="token operator">/</span>disp2<span class="token operator">/</span>disp<span class="token operator">/</span>dev_disp<span class="token punctuation">.</span>c
@@ <span class="token operator">-</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">8</span> @@ <span class="token keyword">int</span> <span class="token function">composer_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">disp_drv_info</span> <span class="token operator">*</span>p_disp_drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> <span class="token function">hwc_dump</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
<span class="token operator">+</span><span class="token keyword">static</span> <span class="token keyword">int</span> screen_status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">/* 定义一个静态的屏幕状态变量 */</span>
<span class="token operator">+</span>
 <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">disp_shutdown</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">disp_sys_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
 			     <span class="token keyword">struct</span> <span class="token class-name">device_attribute</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span>
@@ <span class="token operator">-</span><span class="token number">3009</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">3011</span><span class="token punctuation">,</span><span class="token number">7</span> @@ <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">disp_runtime_suspend</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
 		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 			<span class="token function">dev_err</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"can't request output direction lcd_pwr_gpio gpio \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 		<span class="token punctuation">}</span>
<span class="token operator">+</span>		screen_status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 	<span class="token punctuation">}</span>
 	<span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"%s finish\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
@@ <span class="token operator">-</span><span class="token number">3077</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">3080</span><span class="token punctuation">,</span><span class="token number">7</span> @@ <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">disp_runtime_resume</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
 		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 			<span class="token function">dev_err</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">"can't request output direction lcd_pwr_gpio gpio \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 		<span class="token punctuation">}</span>
<span class="token operator">+</span>		screen_status <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 	<span class="token punctuation">}</span>
 	<span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"%s finish\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
@@ <span class="token operator">-</span><span class="token number">3111</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">3115</span><span class="token punctuation">,</span><span class="token number">14</span> @@ <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">disp_runtime_idle</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
<span class="token operator">+</span><span class="token comment">/* 实现获取屏幕状态的函数，并导出共享 */</span>
<span class="token operator">+</span><span class="token keyword">int</span> <span class="token function">get_screen_status</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token operator">+</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>	<span class="token keyword">return</span> screen_status<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span><span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>get_screen_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">/***********************************/</span>
<span class="token operator">+</span>
 <span class="token keyword">int</span> <span class="token function">disp_suspend</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
 	u32 screen_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<p>解决方法2：<code>修改原厂驱动源码，使其手势功能程序兼容本地使用的内核版本。</code><br>   在gt9xx.c文件中找到<code>static void goodix_ts_work_func(struct work_struct *work)</code>这个函数，这个函数就是处理事件上报功能的，如下图是我截取的原厂驱动双击屏幕开屏的程序段。<br> <img src="https://images2.imgbox.com/ad/37/sF9HzCEl_o.png" alt="在这里插入图片描述"><br>   这图程序可以看出，它是通过读取记录触摸手势状态的寄存器值来判断触发双击开屏功能的，如果触发了那么就会上报"KEY_POWER"事件来达到开屏目的，而它的屏幕状态通过<code>doze_status</code>这个静态变量取设置与判断的，最后会清除记录触摸手势状态的寄存器的值。<br>   至于具体修改方法就自行取尝试啦。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ae854d5666af1ec41f586ec5d2899b9f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Nacos基础（注册中心和配置中心）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f32af6e816d041fb045f6ecef029c927/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【深度学习】Pytorch基础</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>