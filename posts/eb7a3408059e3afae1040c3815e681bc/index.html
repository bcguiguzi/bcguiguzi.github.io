<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>调取小程序当前经纬度位置及计算两点之间距离 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="调取小程序当前经纬度位置及计算两点之间距离" />
<meta property="og:description" content="调取小程序公共的getLocation接口，这个接口可以开启高精度模式，但是返回的数据可能会较慢，而且这个接口大概20S内只能调用一次，是无法反复调用的。调取方法如图所示：
wx.getLocation({ //小程序 的获取当前的位置经纬度 type: &#39;gcj02&#39;,
isHighAccuracy: true,
success(res) {
that.setData({ //给经纬度赋个值吧
curLat: res.latitude,
curLon: res.longitude
})
如图所示curLat和curLon就是返回的经纬度，isHighAccuracy代表开启高精度。
如果是要求调取频率较高获取经纬度的话，就不能用上面这个API，要用另外两个API组合调用，分别为startLocationUpdate和onLocationChange，通过这两个API就可以持续性获得当前所在位置的API，但是这种耗电较高。获取到两次经纬度之后进行计算算取两点间距离，使用方法如图所示。
wx.startLocationUpdate({
success: (res) =&gt; {
wx.onLocationChange((data) =&gt; {
//获取当前时间
var currentTime = new Date().getTime();
//获取上次保存的位置信息
var oldLocation = wx.getStorageSync(&#39;oldLocation&#39;);
//获取上次执行的时间
var oldTime = wx.getStorageSync(&#39;oldTime&#39;);
//将经纬度拼接
var newLocation = data.latitude &#43; &#34;&#34; &#43; data.longitude;
console.log(&#34;更新了计算距离&#34;, newLocation,
&#34;精度：&#34;, data.horizontalAccuracy, &#34;距离：&#34;, that.data.distance)
if (currentTime - oldTime &gt; 1000) {
that.setData({ //给经纬度赋个值吧
chooseLat: data.latitude," />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/eb7a3408059e3afae1040c3815e681bc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-09T09:06:09+08:00" />
<meta property="article:modified_time" content="2023-02-09T09:06:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">调取小程序当前经纬度位置及计算两点之间距离</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:.0001pt;text-align:justify;">调取小程序公共的getLocation接口，这个接口可以开启高精度模式，但是返回的数据可能会较慢，而且这个接口大概20S内只能调用一次，是无法反复调用的。调取方法如图所示：</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#61afef;">wx</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">getLocation</span><span style="color:#abb2bf;">(</span><span style="color:#bbbbbb;">{ </span><span style="color:#676f7d;">//</span><span style="color:#676f7d;">小程序</span> <span style="color:#676f7d;">的获取当前的位置经纬度</span> </span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">      type</span><span style="color:#abb2bf;">:</span> <span style="color:#e5c07b;">'gcj02'</span><span style="color:#abb2bf;">,</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">      isHighAccuracy</span><span style="color:#abb2bf;">:</span> <span style="color:#56b6c2;">true</span><span style="color:#abb2bf;">,</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">      <span style="color:#98c379;">success</span><span style="color:#bbbbbb;">(</span><em><span style="color:#d19a66;">res</span></em><span style="color:#bbbbbb;">) {<!-- --></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">        <span style="color:#61afef;">that</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">setData</span><span style="color:#abb2bf;">(</span><span style="color:#bbbbbb;">{ </span><span style="color:#676f7d;">//</span><span style="color:#676f7d;">给经纬度赋个值吧</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">          curLat</span><span style="color:#abb2bf;">:</span> <span style="color:#61afef;">res</span><span style="color:#abb2bf;">.latitude,</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">          curLon</span><span style="color:#abb2bf;">:</span> <span style="color:#61afef;">res</span><span style="color:#abb2bf;">.longitude</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">        }</span><span style="color:#abb2bf;">)</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">如图所示curLat和curLon就是返回的经纬度，isHighAccuracy代表开启高精度。</p> 
<p style="margin-left:.0001pt;text-align:justify;">如果是要求调取频率较高获取经纬度的话，就不能用上面这个API，要用另外两个API组合调用，分别为startLocationUpdate和onLocationChange，通过这两个API就可以持续性获得当前所在位置的API，但是这种耗电较高。获取到两次经纬度之后进行计算算取两点间距离，使用方法如图所示。</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#61afef;">wx</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">startLocationUpdate</span><span style="color:#abb2bf;">(</span><span style="color:#bbbbbb;">{<!-- --></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">      <span style="color:#98c379;">success</span><span style="color:#abb2bf;">:</span><span style="color:#bbbbbb;"> (</span><em><span style="color:#d19a66;">res</span></em><span style="color:#bbbbbb;">) </span><span style="color:#56b6c2;">=&gt;</span><span style="color:#bbbbbb;"> {<!-- --></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">        <span style="color:#61afef;">wx</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">onLocationChange</span><span style="color:#abb2bf;">(</span><span style="color:#bbbbbb;">(</span><em><span style="color:#d19a66;">data</span></em><span style="color:#bbbbbb;">) </span><span style="color:#56b6c2;">=&gt;</span><span style="color:#bbbbbb;"> {<!-- --></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">          <span style="color:#676f7d;">//</span><span style="color:#676f7d;">获取当前时间</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">          <span style="color:#56b6c2;">var</span> <span style="color:#abb2bf;">currentTime</span> <span style="color:#e06c75;">=</span> <span style="color:#e06c75;">new</span> <span style="color:#61afef;">Date</span><span style="color:#abb2bf;">().</span><span style="color:#98c379;">getTime</span><span style="color:#abb2bf;">()</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">          <span style="color:#676f7d;">//</span><span style="color:#676f7d;">获取上次保存的位置信息</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">          <span style="color:#56b6c2;">var</span> <span style="color:#abb2bf;">oldLocation</span> <span style="color:#e06c75;">=</span> <span style="color:#61afef;">wx</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">getStorageSync</span><span style="color:#abb2bf;">(</span><span style="color:#e5c07b;">'oldLocation'</span><span style="color:#abb2bf;">)</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">          <span style="color:#676f7d;">//</span><span style="color:#676f7d;">获取上次执行的时间</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">          <span style="color:#56b6c2;">var</span> <span style="color:#abb2bf;">oldTime</span> <span style="color:#e06c75;">=</span> <span style="color:#61afef;">wx</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">getStorageSync</span><span style="color:#abb2bf;">(</span><span style="color:#e5c07b;">'oldTime'</span><span style="color:#abb2bf;">)</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">          <span style="color:#676f7d;">//</span><span style="color:#676f7d;">将经纬度拼接</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">          <span style="color:#56b6c2;">var</span> <span style="color:#abb2bf;">newLocation</span> <span style="color:#e06c75;">=</span> <span style="color:#61afef;">data</span><span style="color:#abb2bf;">.latitude</span> <span style="color:#e06c75;">+</span> <span style="color:#e5c07b;">""</span> <span style="color:#e06c75;">+</span> <span style="color:#61afef;">data</span><span style="color:#abb2bf;">.longitude</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">          <span style="color:#61afef;">console</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">log</span><span style="color:#abb2bf;">(</span><span style="color:#e5c07b;">"</span><span style="color:#e5c07b;">更新了计算距离</span><span style="color:#e5c07b;">"</span><span style="color:#abb2bf;">,</span> <span style="color:#abb2bf;">newLocation,</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">            <span style="color:#e5c07b;">"</span><span style="color:#e5c07b;">精度：</span><span style="color:#e5c07b;">"</span><span style="color:#abb2bf;">,</span> <span style="color:#61afef;">data</span><span style="color:#abb2bf;">.horizontalAccuracy,</span> <span style="color:#e5c07b;">"</span><span style="color:#e5c07b;">距离：</span><span style="color:#e5c07b;">"</span><span style="color:#abb2bf;">,</span> <span style="color:#61afef;">that</span><span style="color:#abb2bf;">.</span><span style="color:#61afef;">data</span><span style="color:#abb2bf;">.distance)</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">          <span style="color:#e06c75;">if</span> <span style="color:#abb2bf;">(currentTime</span> <span style="color:#e06c75;">-</span> <span style="color:#abb2bf;">oldTime</span> <span style="color:#e06c75;">&gt;</span> <span style="color:#c678dd;">1000</span><span style="color:#abb2bf;">)</span><span style="color:#bbbbbb;"> {<!-- --></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">            <span style="color:#61afef;">that</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">setData</span><span style="color:#abb2bf;">(</span><span style="color:#bbbbbb;">{ </span><span style="color:#676f7d;">//</span><span style="color:#676f7d;">给经纬度赋个值吧</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">              chooseLat</span><span style="color:#abb2bf;">:</span> <span style="color:#61afef;">data</span><span style="color:#abb2bf;">.latitude,</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">              chooseLon</span><span style="color:#abb2bf;">:</span> <span style="color:#61afef;">data</span><span style="color:#abb2bf;">.longitude</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">            }</span><span style="color:#abb2bf;">)</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">            <span style="color:#676f7d;">//</span><span style="color:#676f7d;">计算距离</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">            <span style="color:#61afef;">that</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">getDistance</span><span style="color:#abb2bf;">(</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">              <span style="color:#61afef;">that</span><span style="color:#abb2bf;">.</span><span style="color:#61afef;">data</span><span style="color:#abb2bf;">.chooseLat,</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">              <span style="color:#61afef;">that</span><span style="color:#abb2bf;">.</span><span style="color:#61afef;">data</span><span style="color:#abb2bf;">.chooseLon,</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">              <span style="color:#61afef;">that</span><span style="color:#abb2bf;">.</span><span style="color:#61afef;">data</span><span style="color:#abb2bf;">.curLat,</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">              <span style="color:#61afef;">that</span><span style="color:#abb2bf;">.</span><span style="color:#61afef;">data</span><span style="color:#abb2bf;">.curLon)</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">            <span style="color:#676f7d;">//</span><span style="color:#676f7d;">缓存当前最新位置</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">            <span style="color:#61afef;">wx</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">setStorageSync</span><span style="color:#abb2bf;">(</span><span style="color:#e5c07b;">'oldLocation'</span><span style="color:#abb2bf;">,</span> <span style="color:#abb2bf;">newLocation)</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">            <span style="color:#676f7d;">//</span><span style="color:#676f7d;">缓存当前执行的时间</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">            <span style="color:#61afef;">wx</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">setStorageSync</span><span style="color:#abb2bf;">(</span><span style="color:#e5c07b;">'oldTime'</span><span style="color:#abb2bf;">,</span> <span style="color:#abb2bf;">currentTime)</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">            <span style="color:#676f7d;">//</span><span style="color:#676f7d;">将位置信息上传后台的自己的代码</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">            <span style="color:#676f7d;">// uploadLocation(newLocation);</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">          }</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">        }</span><span style="color:#abb2bf;">)</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">      }</span><span style="color:#abb2bf;">,</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">      <span style="color:#98c379;">fail</span><span style="color:#abb2bf;">:</span><span style="color:#bbbbbb;"> (</span><em><span style="color:#d19a66;">err</span></em><span style="color:#bbbbbb;">) </span><span style="color:#56b6c2;">=&gt;</span><span style="color:#bbbbbb;"> {<!-- --></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">        <span style="color:#61afef;">console</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">log</span><span style="color:#abb2bf;">(err)</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">      }</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">    }</span><span style="color:#abb2bf;">)</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">最后的执行代码阶段，可以根据缓存的前后地点是否为同一地点和时间来进行比较，代码里虽然两种都存了但是只用了时间来控制比较，进入时间1S之后，调取计算经纬度距离的方法来进行计算两点间实际距离。</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">  <span style="color:#98c379;">getDistance</span><span style="color:#abb2bf;">:</span> <span style="color:#56b6c2;">function</span><span style="color:#bbbbbb;"> (</span><em><span style="color:#d19a66;">lat1</span></em><span style="color:#abb2bf;">,</span> <em><span style="color:#d19a66;">lng1</span></em><span style="color:#abb2bf;">,</span> <em><span style="color:#d19a66;">lat2</span></em><span style="color:#abb2bf;">,</span> <em><span style="color:#d19a66;">lng2</span></em><span style="color:#bbbbbb;">) {<!-- --></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#56b6c2;">var</span> <span style="color:#abb2bf;">that</span> <span style="color:#e06c75;">=</span> <span style="color:#e06c75;">this</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#abb2bf;">lat1</span> <span style="color:#e06c75;">=</span> <span style="color:#abb2bf;">lat1</span> <span style="color:#e06c75;">||</span> <span style="color:#c678dd;">0</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#abb2bf;">lng1</span> <span style="color:#e06c75;">=</span> <span style="color:#abb2bf;">lng1</span> <span style="color:#e06c75;">||</span> <span style="color:#c678dd;">0</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#abb2bf;">lat2</span> <span style="color:#e06c75;">=</span> <span style="color:#abb2bf;">lat2</span> <span style="color:#e06c75;">||</span> <span style="color:#c678dd;">0</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#abb2bf;">lng2</span> <span style="color:#e06c75;">=</span> <span style="color:#abb2bf;">lng2</span> <span style="color:#e06c75;">||</span> <span style="color:#c678dd;">0</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#56b6c2;">var</span> <span style="color:#abb2bf;">rad1</span> <span style="color:#e06c75;">=</span> <span style="color:#abb2bf;">lat1</span> <span style="color:#e06c75;">*</span> <span style="color:#56b6c2;">Math</span><span style="color:#abb2bf;">.</span><span style="color:#56b6c2;">PI</span> <span style="color:#e06c75;">/</span> <span style="color:#c678dd;">180.0</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#56b6c2;">var</span> <span style="color:#abb2bf;">rad2</span> <span style="color:#e06c75;">=</span> <span style="color:#abb2bf;">lat2</span> <span style="color:#e06c75;">*</span> <span style="color:#56b6c2;">Math</span><span style="color:#abb2bf;">.</span><span style="color:#56b6c2;">PI</span> <span style="color:#e06c75;">/</span> <span style="color:#c678dd;">180.0</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#56b6c2;">var</span> <span style="color:#abb2bf;">a</span> <span style="color:#e06c75;">=</span> <span style="color:#abb2bf;">rad1</span> <span style="color:#e06c75;">-</span> <span style="color:#abb2bf;">rad2</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#56b6c2;">var</span> <span style="color:#abb2bf;">b</span> <span style="color:#e06c75;">=</span> <span style="color:#abb2bf;">lng1</span> <span style="color:#e06c75;">*</span> <span style="color:#56b6c2;">Math</span><span style="color:#abb2bf;">.</span><span style="color:#56b6c2;">PI</span> <span style="color:#e06c75;">/</span> <span style="color:#c678dd;">180.0</span> <span style="color:#e06c75;">-</span> <span style="color:#abb2bf;">lng2</span> <span style="color:#e06c75;">*</span> <span style="color:#56b6c2;">Math</span><span style="color:#abb2bf;">.</span><span style="color:#56b6c2;">PI</span> <span style="color:#e06c75;">/</span> <span style="color:#c678dd;">180.0</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#56b6c2;">var</span> <span style="color:#abb2bf;">r</span> <span style="color:#e06c75;">=</span> <span style="color:#c678dd;">6378137</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#56b6c2;">var</span> <span style="color:#abb2bf;">distance</span> <span style="color:#e06c75;">=</span> <span style="color:#abb2bf;">r</span> <span style="color:#e06c75;">*</span> <span style="color:#c678dd;">2</span> <span style="color:#e06c75;">*</span> <span style="color:#56b6c2;">Math</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">asin</span><span style="color:#abb2bf;">(</span><span style="color:#56b6c2;">Math</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">sqrt</span><span style="color:#abb2bf;">(</span><span style="color:#56b6c2;">Math</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">pow</span><span style="color:#abb2bf;">(</span><span style="color:#56b6c2;">Math</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">sin</span><span style="color:#abb2bf;">(a</span> <span style="color:#e06c75;">/</span> <span style="color:#c678dd;">2</span><span style="color:#abb2bf;">),</span> <span style="color:#c678dd;">2</span><span style="color:#abb2bf;">)</span> <span style="color:#e06c75;">+</span> <span style="color:#56b6c2;">Math</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">cos</span><span style="color:#abb2bf;">(rad1)</span> <span style="color:#e06c75;">*</span> <span style="color:#56b6c2;">Math</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">cos</span><span style="color:#abb2bf;">(rad2)</span> <span style="color:#e06c75;">*</span> <span style="color:#56b6c2;">Math</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">pow</span><span style="color:#abb2bf;">(</span><span style="color:#56b6c2;">Math</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">sin</span><span style="color:#abb2bf;">(b</span> <span style="color:#e06c75;">/</span> <span style="color:#c678dd;">2</span><span style="color:#abb2bf;">),</span> <span style="color:#c678dd;">2</span><span style="color:#abb2bf;">)))</span><span style="color:#bbbbbb;">;</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;">    <span style="color:#61afef;">that</span><span style="color:#abb2bf;">.</span><span style="color:#98c379;">setData</span><span style="color:#abb2bf;">(</span><span style="color:#bbbbbb;">{<!-- --></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">      long</span><span style="color:#abb2bf;">:</span> <span style="color:#abb2bf;">distance,</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">    }</span><span style="color:#abb2bf;">)</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#282c34;"><span style="color:#bbbbbb;">  }</span><span style="color:#abb2bf;">,</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">后面那种调用的方法精确度会受到室内外的影响，正常情况加获取经纬度误差为5-15米，上述那种方法在室内精确度为35-30，但是在室外为3-5，相差极大，不建议在室内使用。</p> 
<p style="margin-left:.0001pt;text-align:justify;">最后附上该文件地址：（文件里还联网腾讯地图获取了当前所在位置）</p> 
<pre><code class="hljs">var tools = require('../../utils/tool').default
// 引入SDK核心类，js文件根据自己业务，位置可自行放置
var QQMapWX = require("../../libs/qqmap-wx-jssdk1.2/qqmap-wx-jssdk"); //引入插件
var qqmapsdk; //定义变量(文档那的)
const app = getApp()
Page({
  data: {
    choose: true,
    curLat: 100, // 存纬度的 (手动选择地址后 经纬度重新赋值， 打开地图 要用)
    curLon: 100, //存经度的,
    curCityAddress: '', //当前位置
    long: 10, //距离范围
    chooseLat: 0, //纬度
    chooseLon: 0, //经度
    chazhi: "", //差值
    // ---------------
    bgJigsaw: '',
  },
  onLoad() {},
  onShow() {
    tools.getImageBase64('/static/beijing.png').then(res =&gt; {
      this.setData({
        bg: res
      })
    })
    tools.getImageBase64('/static/beijing.png').then(res =&gt; {
      this.setData({
        bgJigsaw: res
      })
    })
  },
  chooseMap() {
    var that = this;
    // -------------------------
    wx.startLocationUpdate({
      success: (res) =&gt; {
        wx.onLocationChange((data) =&gt; {
          //获取当前时间
          var currentTime = new Date().getTime();
          //获取上次保存的位置信息
          var oldLocation = wx.getStorageSync('oldLocation');
          //获取上次执行的时间
          var oldTime = wx.getStorageSync('oldTime');
          //将经纬度拼接
          var newLocation = data.latitude + "" + data.longitude;
          console.log("更新了计算距离", newLocation,
            "精度：", data.horizontalAccuracy, "距离：", that.data.distance)
          if (currentTime - oldTime &gt; 1000) {
            that.setData({ //给经纬度赋个值吧
              chooseLat: data.latitude,
              chooseLon: data.longitude
            })
            //计算距离
            that.getDistance(
              that.data.chooseLat,
              that.data.chooseLon,
              that.data.curLat,
              that.data.curLon)
            //缓存当前最新位置
            wx.setStorageSync('oldLocation', newLocation);
            //缓存当前执行的时间
            wx.setStorageSync('oldTime', currentTime);
          }
        });
      },
      fail: (err) =&gt; {
        console.log(err);
      }
    })

    // ------------------------
  },
  getDistance: function (lat1, lng1, lat2, lng2) {
    var that = this;
    lat1 = lat1 || 0;
    lng1 = lng1 || 0;
    lat2 = lat2 || 0;
    lng2 = lng2 || 0;
    var rad1 = lat1 * Math.PI / 180.0;
    var rad2 = lat2 * Math.PI / 180.0;
    var a = rad1 - rad2;
    var b = lng1 * Math.PI / 180.0 - lng2 * Math.PI / 180.0;
    var r = 6378137;
    var distance = r * 2 * Math.asin(Math.sqrt(Math.pow(Math.sin(a / 2), 2) + Math.cos(rad1) * Math.cos(rad2) * Math.pow(Math.sin(b / 2), 2)));
    that.setData({
      long: distance,
    })
  },
  // 点击打开
  checkStart: function () {
    // this.setData({
    //   choose: false
    // })
    // this.chooseMap()
    // var that = this;
    // app.getPermission(that);
    var that = this;
    var locations;
    qqmapsdk = new QQMapWX({
      key: '你的KEY'
    }); //新建实例
    wx.getLocation({ //小程序 的获取当前的位置经纬度 
      type: 'gcj02',
      isHighAccuracy: true,
      success(res) {
        that.setData({ //给经纬度赋个值吧
          curLat: res.latitude,
          curLon: res.longitude
        })
        qqmapsdk.reverseGeocoder({ //腾讯的地图的接口 经纬度查位置 //并没有很精确
          location: {
            latitude: res.latitude,
            longitude: res.longitude
          },
          success: function (addressRes) {
            // 可看文档取自己需要信息  这只取了address
            // that.weather()
            that.setData({
              curCityAddress: addressRes.result.address,
            })
          },
          fail: function (error) {
            console.error(error);
          },
        })
      },
      fail: function (err) {
        console.log(err);
        //失败的时候 可以查查 用户授权情况 
        wx.getSetting();
        //获取用户的当前设置, 返回值中只会出现小程序已经向用户请求过的权限
        wx.getSetting({
          success: function (res) {
            console.log(res);
            // console.log(res.authSetting.scope.userLocation); //可以判断用户是否 取消授权了 以便后续可以再次提醒他授权
            //授权在这不多做讨论
          }
        })
      }
    })
  }
})</code></pre> 
<p>这个demo做的是先获取当前所在位置，然后再用监听的方法去判断两点间动态距离，那个key需要自己去官网进行申请，并且在企业微信官网平台上进行白名单配置。</p> 
<p><a href="https://lbs.qq.com/" rel="nofollow" title="腾讯位置服务 - 立足生态，连接未来 (qq.com)">腾讯位置服务 - 立足生态，连接未来 (qq.com)</a></p> 
<p><a href="https://mp.weixin.qq.com/wxamp/home/guide?lang=zh_CN&amp;token=1862573525" rel="nofollow" title="小程序 (qq.com)">小程序 (qq.com)</a></p> 
<p>开发设置里的服务器域名设置</p> 
<p><img alt="" height="224" src="https://images2.imgbox.com/20/4c/R9NG6z0j_o.png" width="999"></p> 
<p> <img alt="" height="712" src="https://images2.imgbox.com/78/dd/mXrZuNPN_o.png" width="631"></p> 
<p>APPID申请自己的小程序ID，另外引入文件的地址 </p> 
<p><img alt="" height="460" src="https://images2.imgbox.com/a8/bb/criCzkW5_o.png" width="1132"></p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6ac20ff74fc3acfd5b32c6a7083f63a2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">使用python来实现接收手机验证码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/de59df62657b1f64101ed98ac5b4efe1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【mysql系列】windows安装mysql</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>