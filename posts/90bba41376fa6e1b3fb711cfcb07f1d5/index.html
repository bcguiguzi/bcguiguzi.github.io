<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android WebView 调起H5支付，提示商家参数格式有误 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android WebView 调起H5支付，提示商家参数格式有误" />
<meta property="og:description" content="转载：Android WebView 调起H5支付，提示商家参数格式有误 - 知乎题记 —— 执剑天涯，从你的点滴积累开始，所及之处，必精益求精，即是折腾每一天。 重要消息精通点的可以查看这里 精述Flutter 从入门实践到开发一个APP之UI基础篇 视频flutter从入门 到精通 系列文章1 引言场景…https://zhuanlan.zhihu.com/p/103539764 1 引言 场景描述：在APP 中使用webView 显示第三方H5, H5中涉及到微信支付流程，无法正常支付，提示 “商家参数格式有误，请联系商家解决”。
1.1 线索分析 参照微信H5 支付开发官方文档点击这里查看
描述一
一般提示出错，我们可以先去微信商户管理平台点击这里查看 配制，当然出错后，也不急着去商户后台去查看配制，因为在开发微信支付功能初期这些都是已经配制好的，当然是在其平台比如 浏览器、Ios UIWebview 等都可以正常的调起支付，那说明在商户后台的配制是没有问题的，不过我们也可以再次去查看一下商户后台配制的具体值。
描述二
参照微信H5 支付开发官方文档常见问题点击这里查看
在网络发生变动的情况会出现此提示之一
也有提到 “如果是APP里调起H5支付，需要在webview中手动设置referer”，具体内容如下
那么到这里，我们可以手动的在 Android WebView 中添加头 referer ,这个请求头
简言之，HTTP Referer是header的一部分，当浏览器向web服务器发送请求的时候，一般会带上Referer，告诉服务器我是从哪个页面链接过来的，服务器 籍此可以获得一些信息用于处理。比如从我主页上链接到一个朋友那里，他的服务器就能够从HTTP Referer中统计出每天有多少用户点击我主页上的链接访问他的网站。Referer其实应该是英文单词Referrer，不过拼错的人太多了，所以编写标准的人也就将错就错了 在安卓WebView中手动配制请求头 referer
然后再次使用 安卓 WebView 来加载 H5 项目，然后发起微信支付，然后发起成功
分析： 当没有在Android WebView 中添加头 referer 请求头， 同样的 H5 项目，分别在 在 Android WebView 、浏览器、ios UIWebVie 中访问打开，浏览器、ios UIWebVie 中，都可以正常调起支付，只有 Android WebView 中微信支付调起失败，提示商家参数格式有误" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/90bba41376fa6e1b3fb711cfcb07f1d5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-06T11:23:24+08:00" />
<meta property="article:modified_time" content="2022-04-06T11:23:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android WebView 调起H5支付，提示商家参数格式有误</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4>转载：<a class="has-card" href="https://zhuanlan.zhihu.com/p/103539764" rel="nofollow" title="Android WebView 调起H5支付，提示商家参数格式有误 - 知乎"><span class="link-card-box"><span class="link-title">Android WebView 调起H5支付，提示商家参数格式有误 - 知乎</span><span class="link-desc">题记 —— 执剑天涯，从你的点滴积累开始，所及之处，必精益求精，即是折腾每一天。 重要消息精通点的可以查看这里 精述Flutter 从入门实践到开发一个APP之UI基础篇 视频flutter从入门 到精通 系列文章1 引言场景…</span><span class="link-link"><img alt="" class="link-link-icon" src="https://images2.imgbox.com/cd/2a/laOc3RMb_o.png">https://zhuanlan.zhihu.com/p/103539764</span></span></a></h4> 
<h4>1 引言</h4> 
<p>场景描述：在APP 中使用webView 显示第三方H5, H5中涉及到微信支付流程，无法正常支付，提示 “商家参数格式有误，请联系商家解决”。</p> 
<h4>1.1 线索分析</h4> 
<p>参照微信H5 支付开发官方文档<a href="https://link.zhihu.com/?target=https%3A//pay.weixin.qq.com/wiki/doc/api/H5.php%3Fchapter%3D15_1" rel="nofollow" title="点击这里查看">点击这里查看</a></p> 
<p>描述一</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/85/29/gBJNDHYL_o.png"></p> 
<p>一般提示出错，我们可以先去微信商户管理平台<a href="https://link.zhihu.com/?target=https%3A//pay.weixin.qq.com/index.php/core/home/login%3Freturn_url%3D%252F" rel="nofollow" title="点击这里查看">点击这里查看</a> 配制，当然出错后，也不急着去商户后台去查看配制，因为在开发微信支付功能初期这些都是已经配制好的，当然是在其平台比如 浏览器、Ios UIWebview 等都可以正常的调起支付，那说明在商户后台的配制是没有问题的，不过我们也可以再次去查看一下商户后台配制的具体值。</p> 
<p>描述二</p> 
<p>参照微信H5 支付开发官方文档常见问题<a href="https://link.zhihu.com/?target=https%3A//pay.weixin.qq.com/wiki/doc/api/H5.php%3Fchapter%3D15_4" rel="nofollow" title="点击这里查看">点击这里查看</a></p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/4b/f0/rGEjeH7H_o.png"></p> 
<p>在网络发生变动的情况会出现此提示之一</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/88/f9/JS7OTJ99_o.png"></p> 
<p></p> 
<p>也有提到 “如果是APP里调起H5支付，需要在webview中手动设置referer”，具体内容如下</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/83/26/uCQCt9C5_o.png"></p> 
<p>那么到这里，我们可以手动的在 Android WebView 中添加头 referer ,这个请求头</p> 
<ul><li>简言之，HTTP Referer是header的一部分，当浏览器向web服务器发送请求的时候，一般会带上Referer，告诉服务器我是从哪个页面链接过来的，服务器 籍此可以获得一些信息用于处理。比如从我主页上链接到一个朋友那里，他的服务器就能够从HTTP Referer中统计出每天有多少用户点击我主页上的链接访问他的网站。</li><li>Referer其实应该是英文单词Referrer，不过拼错的人太多了，所以编写标准的人也就将错就错了</li></ul> 
<p>在安卓WebView中手动配制请求头 referer</p> 
<p>然后再次使用 安卓 WebView 来加载 H5 项目，然后发起微信支付，然后发起成功</p> 
<p>分析： 当没有在Android WebView 中添加头 referer 请求头， 同样的 H5 项目，分别在 在 Android WebView 、浏览器、ios UIWebVie 中访问打开，浏览器、ios UIWebVie 中，都可以正常调起支付，只有 Android WebView 中微信支付调起失败，提示商家参数格式有误</p> 
<p>当 在Android WebView 中添加头 referer（这个值对应的微信商户平台后台配制的值） 请求头，再次访问同样的 H5 项目，再次调起微信支付，成功。</p> 
<p>然后使用抓包方式进一步分析： 在浏览器中对其加载网络分析</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/7d/e0/5WKta392_o.png"></p> 
<p></p> 
<p>然后在 Android WebView 、ios UIWebView 中加载H5 项目 然后对 Android ios 中的WebView 配制抓包代替，然后访问 H5 项目</p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/14/e8/OfmFc1FO_o.png"></p> 
<p></p> 
<p>得出结论 请求头 referer 并没有丢失， 然后进一步 抓包分析得出结论 在 Android ios 中加载 H5 项目，请求头 referer 配制的信息 与商户管理后台配制的一至，并没有丢失或者是配制错误（当然在ios UIWebView 能支付成功也可以说明）</p> 
<p>那么问题来了，在Android WebView 中 如果不配制 请求头 referer 调起失败，我们需要找出原因</p> 
<p>在 Android WebView 中 没有设置 referer 请求 header 前</p> 
<pre><code>mWebView.setWebViewClient(new WebViewClient() {
            @Override

            @Override
            public boolean shouldOverrideUrlLoading(WebView view, String url) {

                //使用WebView加载显示url
                view.loadUrl(url);
                //返回true
                return true;
            }


            // Handle API 21+
            @TargetApi(Build.VERSION_CODES.LOLLIPOP)
            @Override
            public WebResourceResponse shouldInterceptRequest(WebView view, WebResourceRequest request) {
                ///获取请求uir
                String url = request.getUrl().toString();
                ///获取RequestHeader中的所有 key value
                Map&lt;String, String&gt; lRequestHeaders = request.getRequestHeaders();
                for (Map.Entry&lt;String, String&gt; lStringStringEntry : lRequestHeaders.entrySet()) {
                    Log.d("测试header", lStringStringEntry.getKey() + "  " + lStringStringEntry.getValue());
                }
                return super.shouldInterceptRequest(view, request);
            }
        });</code></pre> 
<p>然后 在控制台中查看 调起支付那一下请求的信息</p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/79/56/nRhveiHK_o.png"></p> 
<p></p> 
<p>对应的抓包工具中数据</p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/1e/18/uYc8A51W_o.png"></p> 
<p></p> 
<p>分析数据 得出： 发起微信支付时 referer 丢失</p> 
<pre><code>https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id= 后面省略</code></pre> 
<p>然后在 Android 中手动配制 referer 后，H5 微信支付调起成功，抓包数据</p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/1a/d9/XmyMXVR0_o.png"></p> 
<p></p> 
<pre><code>mWebView.setWebViewClient(new WebViewClient() {

            @Override
            public boolean shouldOverrideUrlLoading(WebView view, String url) {

                try {
                    if (url.startsWith("http:") || url.startsWith("https:")) {
                        HashMap&lt;String, String&gt; lStringStringHashMap = new HashMap&lt;&gt;();
                        if (!TextUtils.isEmpty(mReffer)) {
                            lStringStringHashMap.put("referer", mReffer);
                            view.loadUrl(url, lStringStringHashMap);
                        } else {
                            view.loadUrl(url, lStringStringHashMap);
                        }
                    } else {
                        Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(url));
                        startActivity(intent);
                    }
                    return true;
                } catch (Exception e) {

                }
                //使用WebView加载显示url
                view.loadUrl(url);
                //返回true
                return true;
            }

            @Override
            public void onReceivedSslError(WebView view, SslErrorHandler handler, SslError error) {
                handler.proceed();
            }


            // Handle API 21+
            @TargetApi(Build.VERSION_CODES.LOLLIPOP)
            @Override
            public WebResourceResponse shouldInterceptRequest(WebView view, WebResourceRequest request) {
                ///获取请求uir
                String url = request.getUrl().toString();
                ///获取RequestHeader中的所有 key value
                Map&lt;String, String&gt; lRequestHeaders = request.getRequestHeaders();
                Log.e("测试URI",url);
                for (Map.Entry&lt;String, String&gt; lStringStringEntry : lRequestHeaders.entrySet()) {
                    Log.d("测试header", lStringStringEntry.getKey() + "  " + lStringStringEntry.getValue());
                }
                if (lRequestHeaders.containsKey("Referer")) {
                    mReffer = lRequestHeaders.get("Referer");
                }
                return super.shouldInterceptRequest(view, request);
            }
        });</code></pre> 
<p>结论来了： 在调微信 H5 支付</p> 
<pre><code>https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb</code></pre> 
<p>请求头 referer 丢失 。</p> 
<h4>2 关于 Referer 丢失的问题</h4> 
<p>关于 Referer 丢失的问题 首先 referer 是由客户端的浏览器发送到服务器上，且在客户端可以通过 document.referrer 来获取，也就是说referer的发送实际上是一个浏览器行为，发送与否的决定权是在浏览器手里。虽然这样说，但是HTTP协议对什么情况下，浏览器该发送，什么情况下不该发送有着严格的规定。</p> 
<h4>2.1 分析 Referer 丢失的几种情况</h4> 
<ul><li>1.当网站使用refresh字段进行跳转的时候，大多数浏览器不发送referer</li><li>2.从用户从一个HTTPS的网站点击链接到另一个HTTP的网站时，不发送referer</li><li>3.html5中，a标签的rel = “noreferrer”, 可以让浏览器不发送referer</li><li>4.使用Data URI scheme链接的，浏览器也不发送referer</li><li>5.使用Content Security Policy, 也可以让浏览器不发送referer</li><li>6.在html头部中使用meta标签来控制不让浏览器发送referer</li><li>7.在发起支付的时候 android WebView 过滤了 referer，解决方式就是 android WebView 中手动设置 refere 或者修改 H5项目中的微信支付发起的方式。</li></ul> 
<pre><code>///在H5项目中发起支付时 
https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb

///一般可使用 但会导致 在 android WebView 中丢失referer
&lt;script type="text/javascript"&gt;
window.location.href="https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?支付信息";
&lt;/script&gt;</code></pre> 
<p>下面两种方式 android WebView 中不会丢失referer</p> 
<pre><code>&lt;body&gt;
    &lt;form name="form"&gt; 
    &lt;/form&gt; 
 &lt;/body&gt;

&lt;scrip&gt;
    document.form.method= "post";     
    document.form.action= "https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?支付信息 ";
    document.form.submit(); 
&lt;/scrip&gt;</code></pre> 
<p>jQuery动态创建form表单提交</p> 
<pre><code>var action='https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?支付信息 ' 
    var form = $("&lt;form&gt;&lt;/form&gt;")
    form.attr('action', action)
    form.attr('method', 'post')
    //追加到body，不显示，然后提交
    form.appendTo("body")
    form.css('display', 'none')
    form.submit()
</code></pre> 
<h4>2.2 分析一 HTTPS变HTTP</h4> 
<p>有时候需要在API项目中生成一些URL链接返回 但是服务器端已经配置了支持HTTPS，通过HTTPS访问的时候生成的URL仍然是HTTP</p> 
<p>从 HTTPS 站点跳到 HTTP 站点 丢失了 Referer，反过来从HTTP到HTTPS是没问题的 不会丢失 Referer</p> 
<h4>2.3 分析二 微信的支付Referer丢失</h4> 
<p>从前端请求到 API 整个都没有问题 全部项目已经全线部署了 HTTPS , Referer 信息也有携带 然后只有到最后一步微信的支付请求URL的时候 Referer 就丢失了</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bffc3c8c978193371bda42e78a6933d3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python实现BF算法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cf16abe0a2a6002ea7bf53729f0c8225/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">组合设计模式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>