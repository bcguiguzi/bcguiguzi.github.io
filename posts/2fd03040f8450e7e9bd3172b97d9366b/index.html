<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>minio上传和下载文件 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="minio上传和下载文件" />
<meta property="og:description" content="import brave.Tracer; import com.alibaba.fastjson.JSONObject; import com.alibaba.xiaomi.commonbase.*; import io.minio.*; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.beans.factory.annotation.Value; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RequestParam; import org.springframework.web.bind.annotation.RestController; import org.springframework.web.multipart.MultipartFile; import java.io.InputStream; import java.text.SimpleDateFormat; import java.util.ArrayList; import java.util.Date; import java.util.List; /** * @Author 楚璃轩 * @Date 2021/12/8 16:42 * @Description 上传和下载 */ @RestController @RequestMapping(&#34;/common-manager&#34;) public class MinioFileUploadController { private static Logger logger = LoggerFactory.getLogger(MinioFileUploadController.class); private RedisUtil redisUtil = SpringConfig.getBean(RedisUtil.class); public static SimpleDateFormat sdf = new SimpleDateFormat(DateUtil." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/2fd03040f8450e7e9bd3172b97d9366b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-29T17:09:32+08:00" />
<meta property="article:modified_time" content="2022-01-29T17:09:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">minio上传和下载文件</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <pre><code>import brave.Tracer;
import com.alibaba.fastjson.JSONObject;
import com.alibaba.xiaomi.commonbase.*;
import io.minio.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.InputStream;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

/**
 * @Author 楚璃轩
 * @Date 2021/12/8  16:42
 * @Description 上传和下载
 */

@RestController
@RequestMapping("/common-manager")
public class MinioFileUploadController {

    private static Logger logger = LoggerFactory.getLogger(MinioFileUploadController.class);

    private RedisUtil redisUtil = SpringConfig.getBean(RedisUtil.class);

    public static SimpleDateFormat sdf = new SimpleDateFormat(DateUtil.yyyy_MM_dd_HH_mm_ss);


    @Value("${minio.bucket_name}")
    private String bucketName;


    @Value("${minio.end_point}")
    private  String endPoint;

    @Autowired
    private MinioClient minioClient;

    @Autowired
    Tracer tracer;


    /**
     * 上传文件
     * @param media
     * @return
     * @throws Exception
     */

    @RequestMapping("/upload")
    public RspBean upload(@RequestParam(value="media") MultipartFile[] media) throws  Exception{

//        判断文件是否为空
        if (media==null || media.length==0){
            return new RspBean(RspCodeEnum.FAIL,"上传文件不能为空",tracer.currentSpan().context().traceIdString(),"fail");
        }

//        判断桶是否存在,不存在则创建
        if (!minioClient.bucketExists(BucketExistsArgs.builder().bucket(bucketName).build())){
            minioClient.makeBucket(MakeBucketArgs.builder().bucket(bucketName).build());
        }



        List&lt;Object&gt; objects = new ArrayList&lt;&gt;(media.length);

        for (MultipartFile file:media){
            String originalFilename = file.getOriginalFilename();
            // 新的文件名 = 存储桶名称_时间戳.后缀名
            String fileName = IdUtil.getId() + originalFilename.substring(originalFilename.lastIndexOf("."));

            objects.add(fileName);
            try{
                InputStream inputStream = file.getInputStream();

                minioClient.putObject(PutObjectArgs.builder().bucket(bucketName).object(fileName).stream(
                        inputStream, file.getSize(), -1
                ).contentType(file.getContentType()).build());

                inputStream.close();


                JSONObject resultJson = new JSONObject();
                resultJson.put("originalName",file.getOriginalFilename());
                resultJson.put("bucketName", bucketName);
                resultJson.put("fileName", fileName);
                resultJson.put("url",endPoint+"/"+bucketName+"/"+fileName);


                //将上传图片名称存入Redis，基于Redis的Set集合存储
                String format = sdf.format(new Date());
                Long aLong = Long.getLong(format);
                redisUtil.set("setmealPicResources",fileName,aLong);

                return new RspBean(RspCodeEnum.SUCCESS,"",tracer.currentSpan().context().traceIdString(),resultJson);

            }catch (Exception e){
                logger.info("上传接口异常：{}",e.getMessage());
                return new RspBean(RspCodeEnum.ERROR,"上传接口异常",tracer.currentSpan().context().traceIdString(),"fail");

            }
        }

        return new RspBean(RspCodeEnum.FAIL,"",tracer.currentSpan().context().traceIdString(),"fail");

    }

    /**
     * @Description 下载文件
     * @Author gett
     */
    @RequestMapping("/download")
    public RspBean download(@RequestParam(value="fileName")String fileName) throws  Exception{
        try {

            boolean flag = minioClient.bucketExists(BucketExistsArgs.builder().bucket(bucketName).build());

            if (flag){
                //              获取对象信息
                StatObjectResponse response = minioClient.statObject(
                        StatObjectArgs.builder().bucket(bucketName).object(fileName).build()
                );
                if (response != null) {
                    minioClient.downloadObject(DownloadObjectArgs.builder()
                            .bucket(bucketName)
                            .object(fileName)
                            .filename(fileName)
                            .build());
                    return new RspBean(RspCodeEnum.SUCCESS, "下载接口成功", tracer.currentSpan().context().traceIdString(),
                            "success");

                }
            }else {
                return new RspBean(RspCodeEnum.ERROR,"桶不存在",tracer.currentSpan().context().traceIdString(),"fail");
            }

        }catch (Exception e){
            logger.info("下载接口异常：{}",e.getMessage());
            return new RspBean(RspCodeEnum.ERROR,"下载接口异常",tracer.currentSpan().context().traceIdString(),"fail");
        }
        return new RspBean(RspCodeEnum.ERROR,"下载接口异常",tracer.currentSpan().context().traceIdString(),"FAIL");


    }



}

</code></pre> 
<pre><code>import io.minio.MinioClient;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * @Author 楚璃轩
 * @Date 2021/12/8  17:33
 * @Description
 */

@Configuration
public class MinioConfigs {

    @Value("${minio.end_point}")
    private String endPoint;
    @Value("${minio.access_key}")
    private String accessKey;
    @Value("${minio.secret_key}")
    private String secretKey;

    @Bean
    public MinioClient minioClient(){
        MinioClient build = MinioClient.builder().endpoint(endPoint).credentials(accessKey,secretKey).build();
        return build;
    }
}

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9491f0bada94321d62861ce277dab6d9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">操作系统实验3—实现请求页式存储管理模拟程序</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/216740fd712140436bbb30ec27085eac/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">NoProviderFoundException: Unable to create a Configuration, because no Bean Validation provider coul</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>