<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>4 OpenCV实现多目三维重建（多张图片增量式生成稀疏点云）【附源码】 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="4 OpenCV实现多目三维重建（多张图片增量式生成稀疏点云）【附源码】" />
<meta property="og:description" content="本文是基于 OpenCV4.80 进行的，关于环境的配置可能之后会单独说，先提一嘴 vcpkg 真好用
1 大致流程 从多张图片逐步生成稀疏点云，这个过程通常包括以下步骤：
初始重建：
初始两张图片的选择十分重要，这是整个流程的基础，后续的增图都是在这两张图片的基础上进行的
对于输入图像，首先需要提取特征点（例如，SIFT、SURF或ORB特征点）。然后，通过匹配不同图像中的特征点，建立它们之间的对应关系通过两张图像之间的本质矩阵 E 估计相机的外参矩阵（旋转矩阵 R 和平移向量 T ），然后使用三角测量法计算出一些初始的三维点 具体操作可以查看我前面的博客
增量式重建：
从这开始，逐步增加图像，逐渐扩展三维点云
添加新的图像：将新的图像加载到重建流程中特征提取和匹配：对新的图像提取特征点并与先前图像匹配以获得新的匹配关系位姿估计：估计新图像相对于先前图像的相机位姿，通常使用 PnP（Perspective-n-Point）—— 在已知相机内参数 K 的前提下，用该角度下的三维点（object_points）与它们对应的图像点（image_points）坐标，估算出此时拍摄位置的信息三维点三角测量：使用新的匹配对和估计的位姿（R，T）来三角测量，生成新的三维点。点云合并：将新生成的三维点与先前的点云进行合并，构建一个更大的稀疏点云 全局点云优化：在稀疏点云已经生成后，可以使用全局点云优化技术，例如Bundle Adjustment，来提高点云的准确性
2 准备代码 之前文章中，我们讲所有代码都挤到了main函数中，十分不美观，现在我们进行一下代码的优化
由于才学C&#43;&#43;，比较菜请见谅
2.1 Include.h 这里包含了所有用到的头文件和宏，方便之后使用
由于之后要用 Bundle Adjustment，所以引入了 ceres，具体环境配置之后可能会说（真的比较麻烦，强烈推荐 vcpkg ），其中大量的 #define 和 #pragma warning(disable: 4996) 都是关于 ceres 的报错的
#ifndef INCLUDES_H #define INCLUDES_H #define GLOG_NO_ABBREVIATED_SEVERITIES #define _CRT_NONSTDC_NO_DEPRECATE #define NOMINMAX #define _CRT_NONSTDC_NO_WARNINGS #pragma warning(disable: 4996) #include &lt;opencv2/opencv.hpp&gt; #include &lt;iostream&gt; #include &lt;vector&gt; #include &lt;fstream&gt; #include &lt;ceres/ceres." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/88c1b53f768bef99a9c7824c4c736f15/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-21T08:35:10+08:00" />
<meta property="article:modified_time" content="2023-10-21T08:35:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">4 OpenCV实现多目三维重建（多张图片增量式生成稀疏点云）【附源码】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>本文是基于 <strong>OpenCV4.80</strong> 进行的，关于环境的配置可能之后会单独说，先提一嘴 <strong>vcpkg</strong> 真好用</p> 
</blockquote> 
<h3><a id="1__2"></a>1 大致流程</h3> 
<p>从多张图片逐步生成稀疏点云，这个过程通常包括以下步骤：</p> 
<ol><li> <p>初始重建：</p> <p>初始两张图片的选择<u>十分重要</u>，这是整个流程的基础，后续的增图都是在这两张图片的基础上进行的</p> 
  <ul><li>对于输入图像，首先需要提取特征点（例如，SIFT、SURF或ORB特征点）。然后，通过匹配不同图像中的特征点，建立它们之间的对应关系</li><li>通过两张图像之间的本质矩阵 <code>E</code> 估计相机的外参矩阵（旋转矩阵 <code>R</code> 和平移向量 <code>T</code> ），然后使用<strong>三角测量法</strong>计算出一些初始的三维点</li></ul> <p>具体操作可以查看<a href="https://blog.csdn.net/WJwwwwwww/article/details/133266228">我前面的博客</a></p> </li><li> <p>增量式重建：</p> <p>从这开始，逐步增加图像，逐渐扩展三维点云</p> 
  <ul><li>添加新的图像：将新的图像加载到重建流程中</li><li>特征提取和匹配：对新的图像提取特征点并与先前图像匹配以获得新的匹配关系</li><li>位姿估计：估计新图像相对于先前图像的相机位姿，通常使用 <code>PnP</code>（<em>Perspective-n-Point</em>）—— 在已知相机内参数 <code>K</code> 的前提下，用该角度下的<u>三维点</u>（object_points）与它们对应的<u>图像点</u>（image_points）坐标，估算出此时拍摄位置的信息</li><li>三维点三角测量：使用新的匹配对和估计的位姿（<code>R</code>，<code>T</code>）来<u>三角测量</u>，生成新的三维点。</li><li>点云合并：将新生成的三维点与先前的点云进行合并，构建一个更大的稀疏点云</li></ul> </li><li> <p>全局点云优化：在稀疏点云已经生成后，可以使用全局点云优化技术，例如<strong>Bundle Adjustment</strong>，来提高点云的准确性</p> </li></ol> 
<h3><a id="2__26"></a>2 准备代码</h3> 
<p>之前文章中，我们讲所有代码都挤到了main函数中，十分不美观，现在我们进行一下代码的优化</p> 
<blockquote> 
 <p>由于才学C++，比较菜请见谅</p> 
</blockquote> 
<h4><a id="21_Includeh_32"></a>2.1 Include.h</h4> 
<p>这里包含了所有用到的<u>头文件和宏</u>，方便之后使用</p> 
<p>由于之后要用 <strong>Bundle Adjustment</strong>，所以引入了 <strong>ceres</strong>，具体环境配置之后可能会说（真的比较麻烦，强烈推荐 <mark><strong>vcpkg</strong></mark> ），其中大量的 <code>#define</code> 和 <code>#pragma warning(disable: 4996)</code> 都是关于 <strong>ceres</strong> 的报错的</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">INCLUDES_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCLUDES_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GLOG_NO_ABBREVIATED_SEVERITIES</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_CRT_NONSTDC_NO_DEPRECATE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NOMINMAX</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_CRT_NONSTDC_NO_WARNINGS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">warning</span><span class="token punctuation">(</span>disable<span class="token operator">:</span> <span class="token number">4996</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ceres/ceres.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ceres/rotation.h&gt;</span></span>



<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// !INCLUDES_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
</code></pre> 
<h4><a id="22_Constructor_64"></a>2.2 Constructor</h4> 
<p>Constructor 类，其中包含了三维重建的几个关键步骤的函数：</p> 
<ul><li><code>findCamera</code>：初始构建使用的求取 E 矩阵和R，T（其中包括了<strong>RANSAC</strong>）</li><li><code>maskoutPoints</code>：通过内点标记mask，来对点进行筛选</li><li><code>pointsReconstruct</code>：通过 R，T 匹配点来进行三角化生成三维点云</li></ul> 
<p><strong>Constructor.h</strong>：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CONSTRUCTOR_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONSTRUCTOR_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Includes.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Images.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">Constructor</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token comment">// 输入K，图1的匹配点，图2的匹配点；输出R，T；点经过筛选</span>
	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">findCamera</span><span class="token punctuation">(</span>Mat K<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span><span class="token operator">&amp;</span> point1<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span><span class="token operator">&amp;</span> point2<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> output_R<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> output_T<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span><span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 输入图匹配点，内点标记mask；返回mask后的vector&lt;Point2f&gt;匹配点</span>
	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">maskoutPoints</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span><span class="token operator">&amp;</span> input_points<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span><span class="token operator">&amp;</span> input_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 输入图一的R，T，匹配点，图二的R，T，匹配点；返回vector&lt;Point3f&gt;三维点</span>
	<span class="token keyword">static</span> vector<span class="token operator">&lt;</span>Point3d<span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token function">pointsReconstruct</span><span class="token punctuation">(</span><span class="token keyword">const</span> Mat<span class="token operator">&amp;</span> K<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> R1<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> T1<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> R2<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> T2<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span><span class="token operator">&amp;</span> points1<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span><span class="token operator">&amp;</span> points2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// !CONSTRUCTOR_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
</code></pre> 
<p><strong>Constructor.cpp</strong>：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Constructor.h"</span></span>

<span class="token keyword">void</span> <span class="token class-name">Constructor</span><span class="token double-colon punctuation">::</span><span class="token function">findCamera</span><span class="token punctuation">(</span>Mat K<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span><span class="token operator">&amp;</span> point1<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span><span class="token operator">&amp;</span> point2<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> output_R<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> output_T<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span><span class="token operator">&amp;</span> mask<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	vector<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span> inliers<span class="token punctuation">;</span>

	Mat F<span class="token punctuation">;</span>
	F <span class="token operator">=</span> <span class="token function">findFundamentalMat</span><span class="token punctuation">(</span>point1<span class="token punctuation">,</span> point2<span class="token punctuation">,</span> inliers<span class="token punctuation">,</span> FM_RANSAC<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Mat E <span class="token operator">=</span> K<span class="token punctuation">.</span><span class="token function">t</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> F <span class="token operator">*</span> K<span class="token punctuation">;</span>

	<span class="token comment">//Mat E = findEssentialMat(point1, point2, K, RANSAC, 0.6, 1.0, inliners);</span>
	
	mask <span class="token operator">=</span> inliers<span class="token punctuation">;</span>

	<span class="token comment">// 根据内点筛选出新的匹配点</span>
	<span class="token class-name">Constructor</span><span class="token double-colon punctuation">::</span><span class="token function">maskoutPoints</span><span class="token punctuation">(</span>point1<span class="token punctuation">,</span> inliers<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Constructor</span><span class="token double-colon punctuation">::</span><span class="token function">maskoutPoints</span><span class="token punctuation">(</span>point2<span class="token punctuation">,</span> inliers<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 分解E矩阵，获取R，T矩阵</span>
	<span class="token keyword">int</span> pass_count <span class="token operator">=</span> <span class="token function">recoverPose</span><span class="token punctuation">(</span>E<span class="token punctuation">,</span> point1<span class="token punctuation">,</span> point2<span class="token punctuation">,</span> K<span class="token punctuation">,</span> output_R<span class="token punctuation">,</span> output_T<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token class-name">Constructor</span><span class="token double-colon punctuation">::</span><span class="token function">maskoutPoints</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span><span class="token operator">&amp;</span> input_points<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span><span class="token operator">&amp;</span> input_mask<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span> <span class="token function">temp_points</span><span class="token punctuation">(</span>input_points<span class="token punctuation">)</span><span class="token punctuation">;</span>
	input_points<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> temp_points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>input_mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			input_points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>temp_points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


vector<span class="token operator">&lt;</span>Point3d<span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token class-name">Constructor</span><span class="token double-colon punctuation">::</span><span class="token function">pointsReconstruct</span><span class="token punctuation">(</span><span class="token keyword">const</span> Mat<span class="token operator">&amp;</span> K<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> R1<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> T1<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> R2<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> T2<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span><span class="token operator">&amp;</span> points1<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span><span class="token operator">&amp;</span> points2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 构造投影矩阵</span>
	Mat <span class="token function">proj1</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> CV_32FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	Mat <span class="token function">proj2</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> CV_32FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 将旋转矩阵和平移向量合并为投影矩阵</span>
	R1<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span><span class="token function">proj1</span><span class="token punctuation">(</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CV_32FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	T1<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>proj1<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CV_32FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>

	R2<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span><span class="token function">proj2</span><span class="token punctuation">(</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CV_32FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	T2<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>proj2<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CV_32FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 将内参矩阵与投影矩阵相乘，得到最终的投影矩阵</span>
	Mat fK<span class="token punctuation">;</span>
	K<span class="token punctuation">.</span><span class="token function">convertTo</span><span class="token punctuation">(</span>fK<span class="token punctuation">,</span> CV_32FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	proj1 <span class="token operator">=</span> fK <span class="token operator">*</span> proj1<span class="token punctuation">;</span>
	proj2 <span class="token operator">=</span> fK <span class="token operator">*</span> proj2<span class="token punctuation">;</span>

	<span class="token comment">// 三角化，得到齐次坐标</span>
	Mat <span class="token function">point4D_homogeneous</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> points1<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CV_64F<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">triangulatePoints</span><span class="token punctuation">(</span>proj1<span class="token punctuation">,</span> proj2<span class="token punctuation">,</span> points1<span class="token punctuation">,</span> points2<span class="token punctuation">,</span> point4D_homogeneous<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 将齐次坐标转换为三维坐标</span>
	vector<span class="token operator">&lt;</span>Point3d<span class="token operator">&gt;</span> point3D<span class="token punctuation">;</span>
	point3D<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	point3D<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>point4D_homogeneous<span class="token punctuation">.</span>cols<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> point4D_homogeneous<span class="token punctuation">.</span>cols<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		Mat<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> col <span class="token operator">=</span> point4D_homogeneous<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		col <span class="token operator">/=</span> <span class="token function">col</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		point3D<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">Point3d</span><span class="token punctuation">(</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">col</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">col</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 将三维坐标存储在Point3d向量中并返回</span>
	<span class="token keyword">return</span> point3D<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="23_Image_180"></a>2.3 Image</h4> 
<p>为了增图，我们需要存储图像中每个特征点在空间中的对应点—— <strong>correspond_struct_idx</strong></p> 
<p>Image 类，其中有成员变量：</p> 
<ul><li><code>Mat image</code>—— 存储图像</li><li><code>vector&lt;KeyPoint&gt; keyPoints</code>—— 存储特征点</li><li><code>Mat descriptor</code>—— 存储特征描述符</li><li><code>vector&lt;int&gt; correspond_struct_idx</code>—— 匹配点所对应的空间点在点云中的索引</li><li><code>vector&lt;Point2f&gt; matchedPoints</code>—— 存储匹配点</li><li><code>vector&lt;Vec3b&gt; colors</code>—— 存储匹配点的颜色信息</li><li><code>Mat R, T</code>—— 存储相机的旋转矩阵和平移向量</li></ul> 
<p>同时还有几个关于图像处理的重要函数：</p> 
<ul><li><code>Images</code>：构造函数，读取图像时就进行了特征点的提取</li><li><code>matchFeatures</code>：匹配特征点</li><li><code>findColor</code>：提取颜色信息</li><li><code>getObjPointsAndImgPoints</code>：找出当前匹配中已经在点云中的点，获取 <strong>object_points</strong>，以及 <strong>image_points</strong> —— 为 <strong>PnP</strong> 做准备</li></ul> 
<p><strong>Image.h</strong>：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">IMAGES_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGES_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Includes.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">Images</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	Mat image<span class="token punctuation">;</span> <span class="token comment">// 存储图像</span>
	vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> keyPoints<span class="token punctuation">;</span> <span class="token comment">// 存储特征点</span>
	Mat descriptor<span class="token punctuation">;</span> <span class="token comment">// 存储特征描述符</span>
	vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> correspond_struct_idx<span class="token punctuation">;</span> <span class="token comment">// 匹配点所对应的空间点在点云中的索引</span>
	vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span> matchedPoints<span class="token punctuation">;</span> <span class="token comment">// 存储匹配点</span>
	vector<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span> colors<span class="token punctuation">;</span> <span class="token comment">// 存储匹配点的颜色信息</span>
	Mat R<span class="token punctuation">,</span> T<span class="token punctuation">;</span> <span class="token comment">// 存储相机的旋转矩阵和平移向量</span>

	vector<span class="token operator">&lt;</span>Point3f<span class="token operator">&gt;</span> object_points<span class="token punctuation">;</span> <span class="token comment">// 前一张图中匹配点对应的三维点</span>
	vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span> image_points<span class="token punctuation">;</span> <span class="token comment">// 在现图像中对应的像素点</span>

	<span class="token comment">// 构造函数，从指定路径读取图像，并提取SIFT特征点和描述符</span>
	<span class="token function">Images</span><span class="token punctuation">(</span>string <span class="token keyword">const</span> image_paths<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 特征匹配函数，将当前图像与另一个图像进行特征匹配</span>
	<span class="token keyword">void</span> <span class="token function">matchFeatures</span><span class="token punctuation">(</span>Images<span class="token operator">&amp;</span> otherImage<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span><span class="token operator">&amp;</span> outputMatches<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 从匹配点中提取颜色信息</span>
	<span class="token keyword">void</span> <span class="token function">findColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 遍历当前匹配，找出当前匹配中已经在点云中的点，获取object_points，以及image_points</span>
	<span class="token keyword">void</span> <span class="token function">getObjPointsAndImgPoints</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span><span class="token operator">&amp;</span> matches<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point3d<span class="token operator">&gt;</span><span class="token operator">&amp;</span> all_reconstructed_points<span class="token punctuation">,</span> Images<span class="token operator">&amp;</span> preImage<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// !IMAGES_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
</code></pre> 
<p><strong>Image.cpp</strong>：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Images.h"</span></span>


<span class="token class-name">Images</span><span class="token double-colon punctuation">::</span><span class="token function">Images</span><span class="token punctuation">(</span>string <span class="token keyword">const</span> image_path<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 读取图像</span>
	<span class="token keyword">this</span><span class="token operator">-&gt;</span>image <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>image<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not read image: "</span> <span class="token operator">&lt;&lt;</span> image_path <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 提取SIFT特征点和描述符</span>
	Ptr<span class="token operator">&lt;</span>SIFT<span class="token operator">&gt;</span> sift <span class="token operator">=</span> <span class="token class-name">SIFT</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">0.0000000001</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sift<span class="token operator">-&gt;</span><span class="token function">detectAndCompute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>image<span class="token punctuation">,</span> <span class="token function">noArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>keyPoints<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keyPoints<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		correspond_struct_idx<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token class-name">Images</span><span class="token double-colon punctuation">::</span><span class="token function">findColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 遍历所有匹配点</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>Point2f<span class="token operator">&amp;</span> Points <span class="token operator">:</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>matchedPoints<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>	
		<span class="token comment">// 获取像素点的颜色</span>
		Vec3b color <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>image<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>Points<span class="token punctuation">.</span>y<span class="token punctuation">,</span> Points<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 将颜色存储在颜色向量中</span>
		<span class="token keyword">this</span><span class="token operator">-&gt;</span>colors<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token class-name">Images</span><span class="token double-colon punctuation">::</span><span class="token function">matchFeatures</span><span class="token punctuation">(</span>Images<span class="token operator">&amp;</span> otherImage<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span><span class="token operator">&amp;</span> outputMatches<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 清空匹配点</span>
	otherImage<span class="token punctuation">.</span>matchedPoints<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token operator">-&gt;</span>matchedPoints<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;&gt;</span> matches<span class="token punctuation">;</span>
	FlannBasedMatcher matcher<span class="token punctuation">;</span>

	<span class="token comment">// 使用FlannBasedMatcher进行特征匹配</span>
	matcher<span class="token punctuation">.</span><span class="token function">knnMatch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>descriptor<span class="token punctuation">,</span> otherImage<span class="token punctuation">.</span>descriptor<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 计算最小距离</span>
	<span class="token keyword">float</span> min_dist <span class="token operator">=</span> FLT_MAX<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>r<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 如果最近邻距离大于次近邻距离的2.5倍，则跳过该匹配点</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>matches<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> <span class="token number">2.5</span> <span class="token operator">*</span> matches<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>distance<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 计算最小距离</span>
			<span class="token keyword">float</span> dist <span class="token operator">=</span> matches<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>distance<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> min_dist<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				min_dist <span class="token operator">=</span> dist<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>


	<span class="token comment">// 筛选出好的匹配点</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> <span class="token number">0.76</span> <span class="token operator">*</span> matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>distance <span class="token operator">&amp;&amp;</span> matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token function">max</span><span class="token punctuation">(</span>min_dist<span class="token punctuation">,</span> <span class="token number">10.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			outputMatches<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 将匹配点存储在matchedPoints向量中</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> outputMatches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token operator">-&gt;</span>matchedPoints<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>keyPoints<span class="token punctuation">[</span>outputMatches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>queryIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
		otherImage<span class="token punctuation">.</span>matchedPoints<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>otherImage<span class="token punctuation">.</span>keyPoints<span class="token punctuation">[</span>outputMatches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>trainIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 从匹配点中获取三维空间点和图像点</span>
<span class="token keyword">void</span> <span class="token class-name">Images</span><span class="token double-colon punctuation">::</span><span class="token function">getObjPointsAndImgPoints</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span><span class="token operator">&amp;</span> matches<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point3d<span class="token operator">&gt;</span><span class="token operator">&amp;</span> all_reconstructed_points<span class="token punctuation">,</span> Images<span class="token operator">&amp;</span> preImage<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 清空object_points和image_points</span>
	<span class="token keyword">this</span><span class="token operator">-&gt;</span>object_points<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token operator">-&gt;</span>image_points<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 遍历所有匹配点</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 获取匹配点在前一张图像中对应的三维空间点的索引</span>
		<span class="token keyword">int</span> matched_world_point_indices <span class="token operator">=</span> preImage<span class="token punctuation">.</span>correspond_struct_idx<span class="token punctuation">[</span>matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>queryIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">// 如果匹配点在前一张图像中对应的三维空间点存在</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>matched_world_point_indices <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 将其（前一张图像中的三维点）添加到object_points中</span>
			<span class="token keyword">this</span><span class="token operator">-&gt;</span>object_points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>all_reconstructed_points<span class="token punctuation">[</span>matched_world_point_indices<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 将匹配点（该新图像的二维点）添加到image_points中</span>
			<span class="token keyword">this</span><span class="token operator">-&gt;</span>image_points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>keyPoints<span class="token punctuation">[</span>matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>trainIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="3__356"></a>3 具体实现</h3> 
<p>在先前的两张图片的初始三维点云的构建的基础上，我们来实现多张图的增量构建</p> 
<h4><a id="31__360"></a>3.1 初始构建</h4> 
<p>在前面几篇博客中已经详细讲述过了：匹配，用计算 E 矩阵的方式求得相机外参 R，T，进行三角化构建点云</p> 
<p>特别：为了后面的增图重建，我们需要<u>记录初始两张图各个点和点云的关系</u></p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">initConstruction</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>Images<span class="token operator">&gt;</span><span class="token operator">&amp;</span> initImages<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point3d<span class="token operator">&gt;</span><span class="token operator">&amp;</span> all_reconstructed_points<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token operator">&amp;</span> all_points_colors<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    
    initImages<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Images</span><span class="token punctuation">(</span>INIT_IMG_PATH1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    initImages<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Images</span><span class="token punctuation">(</span>INIT_IMG_PATH2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span> matches<span class="token punctuation">;</span>
    initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">matchFeatures</span><span class="token punctuation">(</span>initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> matches<span class="token punctuation">)</span><span class="token punctuation">;</span>

    vector<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span> mask<span class="token punctuation">;</span>
    <span class="token class-name">Constructor</span><span class="token double-colon punctuation">::</span><span class="token function">findCamera</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R <span class="token operator">=</span> <span class="token class-name">Mat</span><span class="token double-colon punctuation">::</span><span class="token function">eye</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> CV_64FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>T <span class="token operator">=</span> <span class="token class-name">Mat</span><span class="token double-colon punctuation">::</span><span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> CV_64FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    all_reconstructed_points <span class="token operator">=</span> <span class="token class-name">Constructor</span><span class="token double-colon punctuation">::</span><span class="token function">pointsReconstruct</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">findColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        all_points_colors<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>colors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// 根据mask来记录初始两张图各个点和点云的关系</span>
    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>correspond_struct_idx<span class="token punctuation">[</span>matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>queryIdx<span class="token punctuation">]</span> <span class="token operator">=</span> idx<span class="token punctuation">;</span>
            initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>correspond_struct_idx<span class="token punctuation">[</span>matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>trainIdx<span class="token punctuation">]</span> <span class="token operator">=</span> idx<span class="token punctuation">;</span>
            idx<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="32__403"></a>3.2 增量构建</h4> 
<ol><li> <p>创建<code>subImageBag</code>，然后将<code>initImages[1]</code>添加到容器中，即表示<code>initImages</code>中的第二张图像（数组索引为1）将与后续进行比较（否则下一张图添加进来跟谁进行匹配呢）</p> </li><li> <p>循环，遍历<code>sub_image_paths</code>容器中的图像文件路径</p> </li><li> <p>在循环中，为每个图像文件路径创建一个新的<code>Images</code>，并将其添加到<code>subImageBag</code>容器中。这样，容器<code>subImageBag</code>中就包含了多张图像，其中第一张图像是初始图像对的第二张，其余图像是逐步添加的</p> </li><li> <p>调用<code>addImageConstruction</code>函数，将<code>subImageBag</code>作为参数传递，以及用于存储稀疏点云的<code>all_reconstructed_points</code>和点云颜色的<code>all_points_colors</code></p> 
  <ul><li> <p>循环遍历<code>subImageBag</code>容器中的每个图像，从索引1开始（因为第一个图像是初始图像用于了初始构建，跳过）</p> </li><li> <p>对于每对相邻的图像，执行以下操作：</p> 
    <ul><li> <p>使用<code>matchFeatures</code>方法，找到两个相邻图像之间的特征点匹配关系，并将匹配结果存储在<code>matches</code>容器中</p> </li><li> <p>使用<code>getObjPointsAndImgPoints</code>方法，获取匹配的特征点对应的三维点和图像点 —— 为 <strong>PnP</strong> 做准备</p> </li><li> <p>通过<strong>RANSAC</strong>筛选，使用<code>findCamera</code>方法筛选匹配点并生成一个mask，用于标记有效的匹配点（只是为了筛选罢了）</p> </li><li> <p>使用<code>solvePnPRansac</code>方法，估计新图像的相机位姿，获得R，T</p> </li><li> <p>转换旋转向量为旋转矩阵（<code>solvePnPRansac</code>得到的是 r 向量）</p> </li><li> <p>使用<code>pointsReconstruct</code>方法，重建新图像与前图像之间的三维点，并将结果存储在<code>new_restructure_points</code>中</p> </li><li> <p>使用<code>findColor</code>方法，获取新图像中点的颜色信息</p> </li><li> <p>记录初始两张图各个点和点云的关系：</p> <p>遍历<code>matches</code>，根据<code>mask</code>中的标记，将新生成的点与初始两张图像的各个点和点云的关系进行记录，维护点与点云之间的对应关系</p> </li><li> <p>最后，将新生成的三维点<code>new_restructure_points</code>以及它们的颜色信息添加到<code>all_reconstructed_points</code>和<code>all_points_colors</code>中，不断扩展点云</p> </li></ul> </li></ul> </li></ol> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">addImageConstruction</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>Images<span class="token operator">&gt;</span><span class="token operator">&amp;</span> subImageBag<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point3d<span class="token operator">&gt;</span><span class="token operator">&amp;</span> all_reconstructed_points<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token operator">&amp;</span> all_points_colors<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> subImageBag<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span> matches<span class="token punctuation">;</span>
        subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">matchFeatures</span><span class="token punctuation">(</span>subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> matches<span class="token punctuation">)</span><span class="token punctuation">;</span>

        subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getObjPointsAndImgPoints</span><span class="token punctuation">(</span>matches<span class="token punctuation">,</span> all_reconstructed_points<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 只是为了进行RANSAC筛选匹配点和获取mask</span>
        vector<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span> mask<span class="token punctuation">;</span>
        Mat discardR<span class="token punctuation">,</span> discardT<span class="token punctuation">;</span>
        <span class="token class-name">Constructor</span><span class="token double-colon punctuation">::</span><span class="token function">findCamera</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">,</span> discardR<span class="token punctuation">,</span> discardT<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token function">solvePnPRansac</span><span class="token punctuation">(</span>subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>object_points<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>image_points<span class="token punctuation">,</span> K<span class="token punctuation">,</span> <span class="token function">noArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Rodrigues</span><span class="token punctuation">(</span>subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">)</span><span class="token punctuation">;</span>

        vector<span class="token operator">&lt;</span>Point3d<span class="token operator">&gt;</span> new_restructure_points<span class="token punctuation">;</span>
        new_restructure_points <span class="token operator">=</span> <span class="token class-name">Constructor</span><span class="token double-colon punctuation">::</span><span class="token function">pointsReconstruct</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>

        subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">findColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 记录初始两张图各个点和点云的关系</span>
        <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mask<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>correspond_struct_idx<span class="token punctuation">[</span>matches<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>queryIdx<span class="token punctuation">]</span> <span class="token operator">=</span> all_reconstructed_points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> idx<span class="token punctuation">;</span>
                subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>correspond_struct_idx<span class="token punctuation">[</span>matches<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>trainIdx<span class="token punctuation">]</span> <span class="token operator">=</span> all_reconstructed_points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> idx<span class="token punctuation">;</span>
                idx<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
   
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> new_restructure_points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            all_reconstructed_points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>new_restructure_points<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            all_points_colors<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>colors<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="33_maincpp_484"></a>3.3 完整main.cpp</h4> 
<pre><code class="prism language-cpp"><span class="token comment">// 定义图像文件路径和保存结果的路径</span>
<span class="token comment">//#define INIT_IMG_PATH1 "test_img\\images\\100_7103.jpg"</span>
<span class="token comment">//#define INIT_IMG_PATH2 "test_img\\images\\100_7104.jpg"</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INIT_IMG_PATH1</span> <span class="token string">"test_img\\First stage\\B25.jpg"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INIT_IMG_PATH2</span> <span class="token string">"test_img\\First stage\\B24.jpg"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PLY_SAVE_PATH</span> <span class="token string">"test_img\\results\\output.ply"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Includes.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Images.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Constructor.h"</span></span>

<span class="token comment">//const Mat K = (Mat_&lt;double&gt;(3, 3) &lt;&lt; 2905.88, 0, 1416, 0, 2905.88, 1064, 0, 0, 1);</span>
<span class="token keyword">const</span> Mat K <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">Mat_</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">719.5459</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">719.5459</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//const vector&lt;string&gt; sub_image_paths = { /*"test_img\\images\\100_7100.jpg", "test_img\\images\\100_7101.jpg", "test_img\\images\\100_7102.jpg",*/ /*"test_img\\images\\100_7103.jpg", "test_img\\images\\100_7104.jpg",*/ "test_img\\images\\100_7105.jpg", "test_img\\images\\100_7106.jpg", "test_img\\images\\100_7107.jpg", "test_img\\images\\100_7108.jpg", "test_img\\images\\100_7109.jpg"/*, "test_img\\images\\100_7110.jpg"*/ };</span>


<span class="token keyword">const</span> vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> sub_image_paths <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"test_img\\First stage\\B23.jpg"</span><span class="token punctuation">,</span> <span class="token string">"test_img\\First stage\\B22.jpg"</span><span class="token punctuation">,</span> <span class="token string">"test_img\\First stage\\B21.jpg"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">initConstruction</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>Images<span class="token operator">&gt;</span><span class="token operator">&amp;</span> initImages<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point3d<span class="token operator">&gt;</span><span class="token operator">&amp;</span> all_reconstructed_points<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token operator">&amp;</span> all_points_colors<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    
    initImages<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Images</span><span class="token punctuation">(</span>INIT_IMG_PATH1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    initImages<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Images</span><span class="token punctuation">(</span>INIT_IMG_PATH2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span> matches<span class="token punctuation">;</span>
    initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">matchFeatures</span><span class="token punctuation">(</span>initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> matches<span class="token punctuation">)</span><span class="token punctuation">;</span>

    vector<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span> mask<span class="token punctuation">;</span>
    <span class="token class-name">Constructor</span><span class="token double-colon punctuation">::</span><span class="token function">findCamera</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R <span class="token operator">=</span> <span class="token class-name">Mat</span><span class="token double-colon punctuation">::</span><span class="token function">eye</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> CV_64FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>T <span class="token operator">=</span> <span class="token class-name">Mat</span><span class="token double-colon punctuation">::</span><span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> CV_64FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    all_reconstructed_points <span class="token operator">=</span> <span class="token class-name">Constructor</span><span class="token double-colon punctuation">::</span><span class="token function">pointsReconstruct</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">,</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">findColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        all_points_colors<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>colors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// 根据mask来记录初始两张图各个点和点云的关系</span>
    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            initImages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>correspond_struct_idx<span class="token punctuation">[</span>matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>queryIdx<span class="token punctuation">]</span> <span class="token operator">=</span> idx<span class="token punctuation">;</span>
            initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>correspond_struct_idx<span class="token punctuation">[</span>matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>trainIdx<span class="token punctuation">]</span> <span class="token operator">=</span> idx<span class="token punctuation">;</span>
            idx<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">addImageConstruction</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>Images<span class="token operator">&gt;</span><span class="token operator">&amp;</span> subImageBag<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Point3d<span class="token operator">&gt;</span><span class="token operator">&amp;</span> all_reconstructed_points<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span><span class="token operator">&amp;</span> all_points_colors<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> subImageBag<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        vector<span class="token operator">&lt;</span>DMatch<span class="token operator">&gt;</span> matches<span class="token punctuation">;</span>
        subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">matchFeatures</span><span class="token punctuation">(</span>subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> matches<span class="token punctuation">)</span><span class="token punctuation">;</span>

        subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getObjPointsAndImgPoints</span><span class="token punctuation">(</span>matches<span class="token punctuation">,</span> all_reconstructed_points<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 只是为了进行RANSAC筛选匹配点和获取mask</span>
        vector<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span> mask<span class="token punctuation">;</span>
        Mat discardR<span class="token punctuation">,</span> discardT<span class="token punctuation">;</span>
        <span class="token class-name">Constructor</span><span class="token double-colon punctuation">::</span><span class="token function">findCamera</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">,</span> discardR<span class="token punctuation">,</span> discardT<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token function">solvePnPRansac</span><span class="token punctuation">(</span>subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>object_points<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>image_points<span class="token punctuation">,</span> K<span class="token punctuation">,</span> <span class="token function">noArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Rodrigues</span><span class="token punctuation">(</span>subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">)</span><span class="token punctuation">;</span>

        vector<span class="token operator">&lt;</span>Point3d<span class="token operator">&gt;</span> new_restructure_points<span class="token punctuation">;</span>
        new_restructure_points <span class="token operator">=</span> <span class="token class-name">Constructor</span><span class="token double-colon punctuation">::</span><span class="token function">pointsReconstruct</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>R<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>T<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">,</span> subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>matchedPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>

        subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">findColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 记录初始两张图各个点和点云的关系</span>
        <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mask<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                subImageBag<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>correspond_struct_idx<span class="token punctuation">[</span>matches<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>queryIdx<span class="token punctuation">]</span> <span class="token operator">=</span> all_reconstructed_points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> idx<span class="token punctuation">;</span>
                subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>correspond_struct_idx<span class="token punctuation">[</span>matches<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>trainIdx<span class="token punctuation">]</span> <span class="token operator">=</span> all_reconstructed_points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> idx<span class="token punctuation">;</span>
                idx<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>


       

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> new_restructure_points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            all_reconstructed_points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>new_restructure_points<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            all_points_colors<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>subImageBag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>colors<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{<!-- --></span>
        vector<span class="token operator">&lt;</span>Images<span class="token operator">&gt;</span> initImages<span class="token punctuation">;</span>
        vector<span class="token operator">&lt;</span>Point3d<span class="token operator">&gt;</span> all_reconstructed_points<span class="token punctuation">;</span>
        vector<span class="token operator">&lt;</span>Vec3b<span class="token operator">&gt;</span> all_points_colors<span class="token punctuation">;</span>

        <span class="token function">initConstruction</span><span class="token punctuation">(</span>initImages<span class="token punctuation">,</span> all_reconstructed_points<span class="token punctuation">,</span> all_points_colors<span class="token punctuation">)</span><span class="token punctuation">;</span>

        vector<span class="token operator">&lt;</span>Images<span class="token operator">&gt;</span> subImageBag<span class="token punctuation">;</span>
        subImageBag<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>initImages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> image_path <span class="token operator">:</span> sub_image_paths<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            subImageBag<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">Images</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">addImageConstruction</span><span class="token punctuation">(</span>subImageBag<span class="token punctuation">,</span> all_reconstructed_points<span class="token punctuation">,</span> all_points_colors<span class="token punctuation">)</span><span class="token punctuation">;</span>        
        
        <span class="token comment">// 手动输出点云ply文件</span>
        std<span class="token double-colon punctuation">::</span>ofstream <span class="token function">plyFile</span><span class="token punctuation">(</span>PLY_SAVE_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ply的头部信息</span>
        plyFile <span class="token operator">&lt;&lt;</span> <span class="token string">"ply\n"</span><span class="token punctuation">;</span>
        plyFile <span class="token operator">&lt;&lt;</span> <span class="token string">"format ascii 1.0\n"</span><span class="token punctuation">;</span>
        plyFile <span class="token operator">&lt;&lt;</span> <span class="token string">"element vertex "</span> <span class="token operator">&lt;&lt;</span> all_reconstructed_points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
        plyFile <span class="token operator">&lt;&lt;</span> <span class="token string">"property float x\n"</span><span class="token punctuation">;</span>
        plyFile <span class="token operator">&lt;&lt;</span> <span class="token string">"property float y\n"</span><span class="token punctuation">;</span>
        plyFile <span class="token operator">&lt;&lt;</span> <span class="token string">"property float z\n"</span><span class="token punctuation">;</span>
        plyFile <span class="token operator">&lt;&lt;</span> <span class="token string">"property uchar blue\n"</span><span class="token punctuation">;</span>
        plyFile <span class="token operator">&lt;&lt;</span> <span class="token string">"property uchar green\n"</span><span class="token punctuation">;</span>
        plyFile <span class="token operator">&lt;&lt;</span> <span class="token string">"property uchar red\n"</span><span class="token punctuation">;</span>
        plyFile <span class="token operator">&lt;&lt;</span> <span class="token string">"end_header\n"</span><span class="token punctuation">;</span>

        <span class="token comment">// 写入点云数据</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> all_reconstructed_points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            cv<span class="token double-colon punctuation">::</span>Vec3b color <span class="token operator">=</span> all_points_colors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            cv<span class="token double-colon punctuation">::</span>Point3f point <span class="token operator">=</span> all_reconstructed_points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            plyFile <span class="token operator">&lt;&lt;</span> point<span class="token punctuation">.</span>x <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> point<span class="token punctuation">.</span>y <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> point<span class="token punctuation">.</span>z <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span>
                <span class="token operator">&lt;&lt;</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span>
                <span class="token operator">&lt;&lt;</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span>
                <span class="token operator">&lt;&lt;</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>color<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        plyFile<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span>msg <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="4__645"></a>4 总结注意</h3> 
<blockquote> 
 <p><mark>源码</mark> 即上面给出的 Include.h，Constructor.h，Constructor.cpp，Image.h，Image.cpp，main.cpp</p> 
</blockquote> 
<p>增量加图前（两张初始图的构建）：</p> 
<p><img src="https://images2.imgbox.com/02/a0/PO4xHN8Z_o.png" alt="image-20231020200930233"></p> 
<p>增量加图构造后：</p> 
<p><img src="https://images2.imgbox.com/c9/27/YUMmeoVR_o.png" alt="image-20231020200946321"></p> 
<p><mark><strong>注意</strong></mark>：</p> 
<p>目前只是完成了基本流程，有很多地方都需要优化，比如</p> 
<ul><li><strong>SIFT</strong> 的参数设置</li><li><strong>RANSAC</strong> 的参数设置</li><li><strong>初始图片</strong>的选择（很重要）</li><li><code>matchFeatures</code> 中的 <strong>ratio test</strong> 的设置</li><li>还可以增加其他优化措施来剔除离谱点</li><li>最重要的 <strong>BA</strong> 还没有加入！</li><li>·······</li></ul> 
<blockquote> 
 <p>目前，出来的效果不好，革命尚未成功，同志还需努力！😭😭😭</p> 
</blockquote> 
<p>参考资料：<br> <a href="https://zhuanlan.zhihu.com/p/339543713" rel="nofollow">基于OpenCV和C++的多视图三维重建</a><br> <a href="https://blog.csdn.net/gaotihong/article/details/79075256">OpenCV实现SfM（三）：多目三维重建</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c8402177a695fcbbecf16f21d49b7783/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【C#】抽象类和接口的区别</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/09254788d2c08681c3b98c0835021197/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">HTML 表格 表单的制作</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>