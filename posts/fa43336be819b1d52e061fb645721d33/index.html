<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Go语言操作MySql相关学习 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Go语言操作MySql相关学习" />
<meta property="og:description" content="假期关于mysql相关的操作学习，总结记录，以飨读者
Mysql是业届常用的关系型数据库，本文以go语言学习如何操作mysql数据库。
主要包括以下几个部分：
Ping测试mysqlmysql连接池相关参数配置CURD相关操作mysql超时操作mysql事务操作 完整代码参考我的github工程go语言操作mysql
零、环境准备及go工程创建 环境：centos、mysql8.0
首先保证mysql服务正常，可以使用sql相关命令进行连接测试，创建几条测试数据方便后续操作。
mysql -u你的名字 -p你的密码 CREATE DATABASE sql_test; use sql_test; CREATE TABLE `user` ( `id` BIGINT(20) NOT NULL AUTO_INCREMENT, `name` VARCHAR(20) DEFAULT &#39;&#39;, `age` INT(11) DEFAULT &#39;0&#39;, PRIMARY KEY(`id`) )ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4; INSERT INTO user (name , age) VALUES (&#39;张三&#39;, &#39;18&#39;), (&#39;李四&#39;, &#39;28&#39;), (&#39;翠花&#39;, &#39;38&#39;); select * from user; 在工作目录建立go工程，同时使用go mod进行初始化
mkdir go-sql-database-example # you can name the module according to your directory go mod init github." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/fa43336be819b1d52e061fb645721d33/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-05T21:56:54+08:00" />
<meta property="article:modified_time" content="2022-04-05T21:56:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Go语言操作MySql相关学习</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>假期关于mysql相关的操作学习，总结记录，以飨读者</p> 
</blockquote> 
<p>Mysql是业届常用的关系型数据库，本文以go语言学习如何操作mysql数据库。<br> <img src="https://images2.imgbox.com/ae/68/i7XfROSp_o.png" alt="在这里插入图片描述"></p> 
<p>主要包括以下几个部分：</p> 
<ul><li>Ping测试mysql</li><li>mysql连接池相关参数配置</li><li>CURD相关操作</li><li>mysql超时操作</li><li>mysql事务操作</li></ul> 
<p>完整代码参考我的github工程<a href="https://github.com/wsqyouth/tech_note/tree/master/go-sql-database-example">go语言操作mysql</a></p> 
<h5><a id="go_14"></a>零、环境准备及go工程创建</h5> 
<p>环境：centos、mysql8.0<br> 首先保证mysql服务正常，可以使用sql相关命令进行连接测试，创建几条测试数据方便后续操作。</p> 
<pre><code class="prism language-bash">mysql -u你的名字 -p你的密码
 
 CREATE DATABASE sql_test<span class="token punctuation">;</span>
 use sql_test<span class="token punctuation">;</span>
 
 CREATE TABLE <span class="token variable"><span class="token variable">`</span>user<span class="token variable">`</span></span> <span class="token punctuation">(</span>
    <span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span> BIGINT<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> NOT NULL AUTO_INCREMENT,
    <span class="token variable"><span class="token variable">`</span>name<span class="token variable">`</span></span> VARCHAR<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> DEFAULT <span class="token string">''</span>,
    <span class="token variable"><span class="token variable">`</span>age<span class="token variable">`</span></span> INT<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> DEFAULT <span class="token string">'0'</span>,
    PRIMARY KEY<span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>ENGINE<span class="token operator">=</span>InnoDB <span class="token assign-left variable">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> DEFAULT <span class="token assign-left variable">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>

 INSERT INTO user <span class="token punctuation">(</span>name , age<span class="token punctuation">)</span> VALUES 
<span class="token punctuation">(</span><span class="token string">'张三'</span>, <span class="token string">'18'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token string">'李四'</span>, <span class="token string">'28'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token string">'翠花'</span>, <span class="token string">'38'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> * from user<span class="token punctuation">;</span>
</code></pre> 
<p>在工作目录建立go工程，同时使用<code>go mod</code>进行初始化</p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> go-sql-database-example
<span class="token comment"># you can name the module according to your directory</span>
go mod init github.com/wsqyouth/tech_note/go-sql-database-example
</code></pre> 
<p>Go语言sql包提供了操作SQL的接口，但并不提供具体数据库驱动，因此我们须引入第三方的驱动包。</p> 
<pre><code class="prism language-go"> <span class="token keyword">go</span> get <span class="token operator">-</span>u github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>sql<span class="token operator">-</span>driver<span class="token operator">/</span>mysql
 touch main<span class="token punctuation">.</span><span class="token keyword">go</span>
</code></pre> 
<p>至此，我们拥有了测试数据、安装了第三方驱动包、同时创建了go工程，让我们开始吧！</p> 
<h5><a id="Pingmysql_54"></a>一、Ping测试mysql</h5> 
<pre><code class="prism language-go">
<span class="token comment">// file: main.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"database/sql"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"log"</span>
	<span class="token string">"time"</span>

	<span class="token comment">// we have to import the driver, but don't use it in our code</span>
	<span class="token comment">// so we use the `_` symbol</span>
	<span class="token boolean">_</span> <span class="token string">"github.com/go-sql-driver/mysql"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">pingDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">pingDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// The `sql.Open` function opens a new `*sql.DB` instance. We specify the driver name</span>
	<span class="token comment">// and the URI for our database.</span>
	dsn <span class="token operator">:=</span> <span class="token string">"你的名字:你的密码@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&amp;parseTime=True"</span>
	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> dsn<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"could not connect to database: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// To verify the connection to our database instance, we can call the `Ping`</span>
	<span class="token comment">// method. If no error is returned, we can assume a successful connection</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"unable to reach database: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"database is reachable"</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们运行该文件，可以发现测试ok:</p> 
<p><img src="https://images2.imgbox.com/7b/6d/VVaQ0APs_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="mysql_98"></a>二、mysql连接池相关参数配置</h5> 
<p>为了方便测试后续CURD各功能函数，本着<code>高内聚、低耦合</code>的原则，我们定义一个全局变量<code>db</code>，用来保存连接数据库的句柄。将上面的示例代码拆分为独立的函数<code>initDB</code>，在程序启动时完成初始化，其他功能函数就可以直接使用全局变量了。<br> 初始化连接函数</p> 
<pre><code class="prism language-go"><span class="token comment">// 2.0 定义初始化数据库函数</span>
<span class="token keyword">func</span> <span class="token function">initDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	dsn <span class="token operator">:=</span> <span class="token string">"你的账号:你的密码@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&amp;parseTime=True"</span>
	db<span class="token punctuation">,</span> err <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> dsn<span class="token punctuation">)</span> <span class="token comment">//注意使用全局对象进行赋值</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"could not connect to database: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"unable to reach database: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Maximum Idle Connections</span>
	db<span class="token punctuation">.</span><span class="token function">SetMaxIdleConns</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token comment">// Maximum Open Connections</span>
	db<span class="token punctuation">.</span><span class="token function">SetMaxOpenConns</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token comment">// Idle Connection Timeout</span>
	db<span class="token punctuation">.</span><span class="token function">SetConnMaxIdleTime</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token comment">// Connection Lifetime</span>
	db<span class="token punctuation">.</span><span class="token function">SetConnMaxLifetime</span><span class="token punctuation">(</span><span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"init succ"</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>关于数据库的连接配置参考，这里我直接借鉴国外的一篇博客<a href="https://www.sohamkamani.com/golang/sql-database/" rel="nofollow">Using an SQL Database in Go</a>进行摘录:</p> 
<ul><li><strong>Maximum Open Connections</strong> are the maximum number of parallel connections that can be made to the database at any time.</li><li><strong>Maximum Idle Connections</strong> are the maximum number of connections that can be inactive at any time. A connection is idle, if no queries are being executed on it. This can happen if the number of queries being executed are less than the current pool of connections can handle.</li><li><strong>Idle Connection Timeout</strong> is the maximum time for which any given connection can be idle. After this time had elapsed, the connection to the database will be closed.<br> *** Connection Lifetime** is the maximum amount of time that a connection can be open (regardless of whether it’s idle or not).<br> <img src="https://images2.imgbox.com/d7/54/IgDQJzT6_o.png" alt="在这里插入图片描述"><br> 这几个参数是可以灵活设置的，但是总体上我们要考虑：</li><li>最好让一小部分连接处于空闲状态，以应对查询吞吐量的突然峰值</li><li>应该根据我们的数据库服务器和应用程序服务器的网络容量来设置打开连接的最大数量，其中较小的将是限制因素。</li></ul> 
<h5><a id="mysqlCURD_135"></a>三、mysql相关CURD操作</h5> 
<p>其实就是CURD的封装，记得我们使用了上文提及的全局变量句柄<code>db</code>，代码如下：</p> 
<pre><code class="prism language-go"><span class="token comment">// 2.1 查询单条数据</span>
<span class="token keyword">func</span> <span class="token function">queryRowDemo</span><span class="token punctuation">(</span>id <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	sqlStr <span class="token operator">:=</span> <span class="token string">"select id,name,age from user where id = ? limit 1"</span>
	<span class="token comment">// `QueryRow` always returns a single row from the database</span>
	row <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">QueryRow</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> id<span class="token punctuation">)</span>

	<span class="token keyword">var</span> u user
	<span class="token keyword">if</span> err <span class="token operator">:=</span> row<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"could not scan row: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"user:%+v\n"</span><span class="token punctuation">,</span> u<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2.2 查询多条数据</span>
<span class="token keyword">func</span> <span class="token function">queryMultiRowDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	sqlStr <span class="token operator">:=</span> <span class="token string">"select id,name,age from user where id &gt; ?"</span>
	<span class="token comment">// `QueryRow` always returns a single row from the database</span>
	rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"could not execute query: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//循环读取结果集数据</span>
	users <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>user<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">var</span> u user
		<span class="token comment">// create an instance of `user` and write the result of the current row into it</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"could not scan row: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		users <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// print the length, and all the birds</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"len:%v,users:%+v\n"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">,</span> users<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 插入数据</span>
<span class="token keyword">func</span> <span class="token function">insertRowDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	newUser <span class="token operator">:=</span> user<span class="token punctuation">{<!-- --></span>
		name<span class="token punctuation">:</span> <span class="token string">"王五"</span><span class="token punctuation">,</span>
		age<span class="token punctuation">:</span>  <span class="token number">23</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	sqlStr <span class="token operator">:=</span> <span class="token string">"insert into user(name,age) values (?,?)"</span>
	<span class="token comment">// the `Exec` method returns a `Result` type instead of a `Row`</span>
	<span class="token comment">// we follow the same argument pattern to add query params</span>
	result<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> newUser<span class="token punctuation">.</span>name<span class="token punctuation">,</span> newUser<span class="token punctuation">.</span>age<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"could not execute query: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	theID<span class="token punctuation">,</span> err <span class="token operator">:=</span> result<span class="token punctuation">.</span><span class="token function">LastInsertId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//新插入的id</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"get LastInsertId falid. err:%v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"insert succ. the id is %d\n"</span><span class="token punctuation">,</span> theID<span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token comment">// 更新数据</span>
<span class="token keyword">func</span> <span class="token function">updateRowDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	newUser <span class="token operator">:=</span> user<span class="token punctuation">{<!-- --></span>
		name<span class="token punctuation">:</span> <span class="token string">"王五"</span><span class="token punctuation">,</span>
		age<span class="token punctuation">:</span>  <span class="token number">28</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	sqlStr <span class="token operator">:=</span> <span class="token string">"update user set age=? where name = ?"</span>
	result<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> newUser<span class="token punctuation">.</span>age<span class="token punctuation">,</span> newUser<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"update falid. err:%v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// the `Result` type has special methods like `RowsAffected` which returns the</span>
	<span class="token comment">// total number of affected rows reported by the database</span>
	<span class="token comment">// In this case, it will tell us the number of rows that were inserted using</span>
	<span class="token comment">// the above query</span>
	rowsAffected<span class="token punctuation">,</span> err <span class="token operator">:=</span> result<span class="token punctuation">.</span><span class="token function">RowsAffected</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"could not get affected rows: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// we can log how many rows were update</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"update succ, affected rows:%v"</span><span class="token punctuation">,</span> rowsAffected<span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token comment">// 删除数据</span>
<span class="token keyword">func</span> <span class="token function">deleteRowDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	newUser <span class="token operator">:=</span> user<span class="token punctuation">{<!-- --></span>
		name<span class="token punctuation">:</span> <span class="token string">"张三"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	sqlStr <span class="token operator">:=</span> <span class="token string">"delete from user where name = ?"</span>
	result<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> newUser<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"update falid. err:%v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// the `Result` type has special methods like `RowsAffected` which returns the</span>
	<span class="token comment">// total number of affected rows reported by the database</span>
	<span class="token comment">// In this case, it will tell us the number of rows that were inserted using</span>
	<span class="token comment">// the above query</span>
	rowsAffected<span class="token punctuation">,</span> err <span class="token operator">:=</span> result<span class="token punctuation">.</span><span class="token function">RowsAffected</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"could not get affected rows: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// we can log how many rows were delete</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"delete succ, affected rows:%v"</span><span class="token punctuation">,</span> rowsAffected<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_246"></a>四、超时相关功能</h5> 
<p>sql的慢查询也是一个需要考虑的问题，如果某个请求的查询比较耗时，就会阻塞其他请求拿到连接，因此我们需要在连接sql时考虑到如果超时则取消功能。这里我们使用context进行测试：</p> 
<pre><code class="prism language-go"><span class="token comment">//3.0 测试超时</span>
<span class="token keyword">func</span> <span class="token function">timeOutDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// create a parent context</span>
	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// create a context from the parent context with a 300ms timeout</span>
	ctx<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token number">300</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
	<span class="token comment">// The context variable is passed to the `QueryContext` method as</span>
	<span class="token comment">// the first argument</span>
	<span class="token comment">// the provided number of seconds. We can use this to simulate a</span>
	<span class="token comment">// slow query</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"select sleep(1)"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"could not execute query: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们设置超时时间为300ms，但是这条sql语句需要1s才能执行完成，运行该demo预期输出：<br> <img src="https://images2.imgbox.com/b7/17/uxZWsprq_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="mysql_268"></a>五、mysql事务操作</h5> 
<p><img src="https://images2.imgbox.com/a4/65/iQJIQesJ_o.png" alt="在这里插入图片描述"></p> 
<p>事务的操作也是需要考虑的，要么一起成功、要么一起失败，因此这里的demo示例如下：</p> 
<pre><code class="prism language-go"><span class="token comment">//4.0 事务操作示例</span>
<span class="token keyword">func</span> <span class="token function">transactionDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	tx<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//开启事务</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> tx <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//回滚</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"begin trans failed. err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	sqlStr <span class="token operator">:=</span> <span class="token string">"Update user set age = 34 where id = ?"</span>
	result<span class="token punctuation">,</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>sqlStr<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> tx <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//回滚</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"update trans failed. err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	rowsAffected<span class="token punctuation">,</span> err <span class="token operator">:=</span> result<span class="token punctuation">.</span><span class="token function">RowsAffected</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> tx <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//回滚</span>
		<span class="token punctuation">}</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"could not get affected rows: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rowsAffected<span class="token punctuation">)</span>

	<span class="token keyword">if</span> rowsAffected <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"only one user affect. trans commit"</span><span class="token punctuation">)</span>
		tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//提交事务</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"affect num err. trans rollback"</span><span class="token punctuation">)</span>
		tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exec trans end"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_316"></a>六、展望</h5> 
<p>至此，Go语言操作mysql常见的操作就算测试完了，但是这只是入门，站在这里，你可能会考虑一下问题：</p> 
<ul><li>sql预处理和sql注入问题</li><li>sql连接池监控问题</li><li>本文使用的是原生sql处理，是否有orm框架来解决新增字段扩展性问题</li><li>事务、分布式事务又将如何开展</li></ul> 
<h5><a id="_324"></a>文章参考</h5> 
<p>本文工程重点参考文章，特此感谢<br> 国外谷歌工程师的文章：该文章是go语言操作pgsql，但是工程风格及讲解一流，引人入胜<br> <a href="https://www.sohamkamani.com/golang/sql-database/" rel="nofollow">Using an SQL Database in Go</a><br> <a href="https://www.sohamkamani.com/golang/sql-transactions/" rel="nofollow">A Guide On SQL Database Transactions In Go</a><br> <a href="https://www.liwenzhou.com/posts/Go/go_mysql/" rel="nofollow">李文周博客-go操作mysql</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a5f57a00bb297c1dae8f3969315907ab/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">HTTPS加密以及认证手段以及优化</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a3e725e098bdb9c72f0da2008f5be2e7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【结构体内存对齐】热门考点——计算结构体大小</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>