<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mmsegmentation自定义数据集的准备，配置文件编写以及训练，测试 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mmsegmentation自定义数据集的准备，配置文件编写以及训练，测试" />
<meta property="og:description" content="一、前提 确认已经安装好了mmsegmentation的环境。具体安装方法，请看官方的get_started.md。
二、数据准备 首先是结合官方的customize_datasets.md，如图：
其中img_dir中存放的就是原图，ann_dir中就是放的对应图像的&#34;mask&#34;。
我的数据是用labelme标注的，出来就是一张图对应一个json文件，它是只标注了每个目标物的外轮廓，大概这个样子：
然后接下来就是按照官方的说法，制作每张图对应的ann:
import os import json import glob import shutil import tqdm import cv2 import numpy as np from PIL import Image from sklearn.model_selection import train_test_split np.random.seed(0) w, h = (1280, 1024) # 这是我的图的大小，你看你来改 def labelme2seg(json_files: list, output_path: str): for json_file in tqdm.tqdm(json_files, desc=&#34;transforming：&#34;): img_data = np.ones((h, w), dtype=np.uint8) * 27 # 我一共27类，你目标物多少类这里就写多少类， with open(json_file, encoding=&#34;utf-8&#34;) as f: json_data = json.load(f) labels_data = json_data[&#34;shapes&#34;] # 将目标物区域像素填充为对应ID号 for label_data in labels_data: # 下面这行，你的label不是数字的话，是汉字或者其它，自己记得稍微改一下，映射成数字，从0开始 goods_id = int(label_data[&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/de91ee51bc1761e7ebe7e9370b689ed4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-23T17:41:40+08:00" />
<meta property="article:modified_time" content="2021-12-23T17:41:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mmsegmentation自定义数据集的准备，配置文件编写以及训练，测试</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_2"></a>一、前提</h3> 
<p>确认已经安装好了mmsegmentation的环境。具体安装方法，请看官方的<a href="https://github.com/open-mmlab/mmsegmentation/blob/master/docs/en/get_started.md#installation">get_started.md</a>。</p> 
<h3><a id="_6"></a>二、数据准备</h3> 
<p>首先是结合官方的<a href="https://github.com/open-mmlab/mmsegmentation/blob/master/docs/en/tutorials/customize_datasets.md">customize_datasets.md</a>，如图：<br> <img src="https://images2.imgbox.com/ad/c5/1gBnjnBw_o.png" alt="在这里插入图片描述"></p> 
<p>其中img_dir中存放的就是原图，ann_dir中就是放的对应图像的"mask"。</p> 
<p>我的数据是用labelme标注的，出来就是一张图对应一个json文件，它是只标注了每个目标物的外轮廓，大概这个样子：<br> <img src="https://images2.imgbox.com/a1/65/CPbOk2hi_o.png" alt="在这里插入图片描述"></p> 
<p>然后接下来就是按照官方的说法，制作每张图对应的ann:</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> json
<span class="token keyword">import</span> glob
<span class="token keyword">import</span> shutil
<span class="token keyword">import</span> tqdm
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split

np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
w<span class="token punctuation">,</span> h <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1280</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>   <span class="token comment"># 这是我的图的大小，你看你来改</span>


<span class="token keyword">def</span> <span class="token function">labelme2seg</span><span class="token punctuation">(</span>json_files<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span> output_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> json_file <span class="token keyword">in</span> tqdm<span class="token punctuation">.</span>tqdm<span class="token punctuation">(</span>json_files<span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"transforming："</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        img_data <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">27</span>   <span class="token comment"># 我一共27类，你目标物多少类这里就写多少类，</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_file<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            json_data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        labels_data <span class="token operator">=</span> json_data<span class="token punctuation">[</span><span class="token string">"shapes"</span><span class="token punctuation">]</span>
        <span class="token comment"># 将目标物区域像素填充为对应ID号</span>
        <span class="token keyword">for</span> label_data <span class="token keyword">in</span> labels_data<span class="token punctuation">:</span>
            <span class="token comment"># 下面这行，你的label不是数字的话，是汉字或者其它，自己记得稍微改一下，映射成数字，从0开始</span>
            goods_id <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>label_data<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            location <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>label_data<span class="token punctuation">[</span><span class="token string">"points"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>fillPoly<span class="token punctuation">(</span>img_data<span class="token punctuation">,</span> <span class="token punctuation">[</span>location<span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span>goods_id<span class="token punctuation">,</span> goods_id<span class="token punctuation">,</span> goods_id<span class="token punctuation">)</span><span class="token punctuation">)</span>

        res_img <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>img_data<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"P"</span><span class="token punctuation">)</span>
        res_img_name <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>json_file<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".json"</span><span class="token punctuation">,</span> <span class="token string">".png"</span><span class="token punctuation">)</span>
        res_img<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_path<span class="token punctuation">,</span> res_img_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    labelme_path <span class="token operator">=</span> <span class="token string">r"上面方.jpg和json文件的路径"</span>
    save_path <span class="token operator">=</span> <span class="token string">r"最终保存的路径/my_dataset"</span>

    img_dir_train <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> <span class="token string">"img_dir"</span><span class="token punctuation">,</span> <span class="token string">"train"</span><span class="token punctuation">)</span>
    img_dir_val <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> <span class="token string">"img_dir"</span><span class="token punctuation">,</span> <span class="token string">"val"</span><span class="token punctuation">)</span>
    img_dir_test <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> <span class="token string">"img_dir"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span>

    ann_dit_train <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> <span class="token string">"ann_dir"</span><span class="token punctuation">,</span> <span class="token string">"train"</span><span class="token punctuation">)</span>
    ann_dir_val <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> <span class="token string">"ann_dir"</span><span class="token punctuation">,</span> <span class="token string">"val"</span><span class="token punctuation">)</span>
    ann_dir_test <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> <span class="token string">"ann_dir"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>img_dir_train<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>img_dir_train<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>img_dir_val<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>img_dir_val<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>img_dir_test<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>img_dir_test<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>ann_dit_train<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>ann_dit_train<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>ann_dir_val<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>ann_dir_val<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>ann_dir_test<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>ann_dir_test<span class="token punctuation">)</span>

    json_list_path <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span>labelme_path <span class="token operator">+</span> <span class="token string">"/*.json"</span><span class="token punctuation">)</span>
    train_path<span class="token punctuation">,</span> test_val_path <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>json_list_path<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.15</span><span class="token punctuation">)</span>
    test_path<span class="token punctuation">,</span> val_path <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>test_val_path<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.15</span><span class="token punctuation">)</span>

    <span class="token comment"># 制作mask：</span>
    labelme2seg<span class="token punctuation">(</span>train_path<span class="token punctuation">,</span> ann_dit_train<span class="token punctuation">)</span>
    labelme2seg<span class="token punctuation">(</span>val_path<span class="token punctuation">,</span> ann_dir_val<span class="token punctuation">)</span>
    labelme2seg<span class="token punctuation">(</span>test_path<span class="token punctuation">,</span> ann_dir_test<span class="token punctuation">)</span>

    <span class="token comment"># 图复制进对应位置</span>
    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> tqdm<span class="token punctuation">.</span>tqdm<span class="token punctuation">(</span>train_path<span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"copy train_img"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".json"</span><span class="token punctuation">,</span> <span class="token string">".jpg"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> img_dir_train<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> tqdm<span class="token punctuation">.</span>tqdm<span class="token punctuation">(</span>val_path<span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"copy val_img"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".json"</span><span class="token punctuation">,</span> <span class="token string">".jpg"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> img_dir_val<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> tqdm<span class="token punctuation">.</span>tqdm<span class="token punctuation">(</span>test_path<span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"copy test_img"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".json"</span><span class="token punctuation">,</span> <span class="token string">".jpg"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> img_dir_test<span class="token punctuation">)</span>

</code></pre> 
<p>然后等你制作好了数据集，就把这个<mark>my_dataset</mark>文件夹放在mmsegmentation的data目录下。<br> 特别注意：一定要看以上代码，我写的3处注释，根据你的实际情况来改，特别是类别名映射成[0, class_num-1]。除非极度巧合，不然代码肯定的是会报错的。</p> 
<h3><a id="_102"></a>三、配置文件</h3> 
<h4><a id="_104"></a>自定义数据类</h4> 
<p>在mmseg/datasets新建一个文件my_dataset.py仿造其它的数据集写下如下内容：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>builder <span class="token keyword">import</span> DATASETS
<span class="token keyword">from</span> <span class="token punctuation">.</span>custom <span class="token keyword">import</span> CustomDataset


<span class="token decorator annotation punctuation">@DATASETS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">MyDataset</span><span class="token punctuation">(</span>CustomDataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 写你实际的类别名就好了，最后再加上一个background</span>
    CLASSES <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token string">'T01'</span><span class="token punctuation">,</span> <span class="token string">'T02'</span><span class="token punctuation">,</span> <span class="token string">'T03'</span><span class="token punctuation">,</span> <span class="token string">'T04'</span><span class="token punctuation">,</span> <span class="token string">'T05'</span><span class="token punctuation">,</span> <span class="token string">'T06'</span><span class="token punctuation">,</span> <span class="token string">'T07'</span><span class="token punctuation">,</span> <span class="token string">'T08'</span><span class="token punctuation">,</span> <span class="token string">'T09'</span><span class="token punctuation">,</span> <span class="token string">'T10'</span><span class="token punctuation">,</span> <span class="token string">'T11'</span><span class="token punctuation">,</span> <span class="token string">'T12'</span><span class="token punctuation">,</span> <span class="token string">'T13'</span><span class="token punctuation">,</span>
        <span class="token string">'T14'</span><span class="token punctuation">,</span> <span class="token string">'T15'</span><span class="token punctuation">,</span> <span class="token string">'T16'</span><span class="token punctuation">,</span> <span class="token string">'T17'</span><span class="token punctuation">,</span> <span class="token string">'T18'</span><span class="token punctuation">,</span> <span class="token string">'T19'</span><span class="token punctuation">,</span> <span class="token string">'T20'</span><span class="token punctuation">,</span> <span class="token string">'T21'</span><span class="token punctuation">,</span> <span class="token string">'T22'</span><span class="token punctuation">,</span> <span class="token string">'T23'</span><span class="token punctuation">,</span> <span class="token string">'T24'</span><span class="token punctuation">,</span> <span class="token string">'T25'</span><span class="token punctuation">,</span><span class="token string">'T26'</span><span class="token punctuation">,</span> <span class="token string">'background'</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># 这个数量与上面个数对应就好了</span>
    PALETTE <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
               <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">204</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
               <span class="token punctuation">[</span><span class="token number">230</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">235</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
               <span class="token punctuation">[</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
               <span class="token punctuation">[</span><span class="token number">143</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">204</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">204</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
               <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
               <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">220</span><span class="token punctuation">,</span> <span class="token number">220</span><span class="token punctuation">,</span> <span class="token number">220</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MyDataset<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>
            <span class="token operator">**</span>kwargs
        <span class="token punctuation">)</span>
</code></pre> 
<p>然后在mmseg/datasets/__init__.py中把自己的数据集添加进去(主要是添加以下两行)：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>my_dataset <span class="token keyword">import</span> MyDataset
<span class="token comment"># 在 __all__中添加自己的类名</span>
__all__ <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'......'</span><span class="token punctuation">,</span> <span class="token string">'LoveDADataset'</span><span class="token punctuation">,</span> <span class="token string">'MyDataset'</span>       <span class="token comment"># 最后添加这个</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="_145"></a>自定义配置文件</h4> 
<p>首先说明，这是仿照configs/pspnet/pspnet_r50-d8_512x512_160k_ade20k.py这一配置文件来写的，其它的大同小异，把pspnet_r50-d8_512x512_160k_ade20k.py配置文件中的是用到的几个配置文件都写进了一个文件里my_psp.py，放在configs/pspnet下，内容如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># 参考 pspnet_r50-d8_512x512_160k_ade20k 来做的</span>

<span class="token comment"># 1.model：根据'../_base_/models/pspnet_r50-d8.py'</span>
<span class="token comment"># model settings</span>
norm_cfg <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'SyncBN'</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
model <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'EncoderDecoder'</span><span class="token punctuation">,</span>
    pretrained<span class="token operator">=</span><span class="token string">'open-mmlab://resnet50_v1c'</span><span class="token punctuation">,</span>
    backbone<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'ResNetV1c'</span><span class="token punctuation">,</span>
        depth<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
        num_stages<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
        out_indices<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        dilations<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        strides<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        norm_cfg<span class="token operator">=</span>norm_cfg<span class="token punctuation">,</span>
        norm_eval<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        style<span class="token operator">=</span><span class="token string">'pytorch'</span><span class="token punctuation">,</span>
        contract_dilation<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    decode_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'PSPHead'</span><span class="token punctuation">,</span>
        in_channels<span class="token operator">=</span><span class="token number">2048</span><span class="token punctuation">,</span>
        in_index<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
        channels<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>
        pool_scales<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        dropout_ratio<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
        num_classes<span class="token operator">=</span><span class="token number">28</span><span class="token punctuation">,</span>   <span class="token comment"># 注意改这个类别数,我的是27类+最后一个background</span>
        norm_cfg<span class="token operator">=</span>norm_cfg<span class="token punctuation">,</span>
        align_corners<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        loss_decode<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span> use_sigmoid<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    auxiliary_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'FCNHead'</span><span class="token punctuation">,</span>
        in_channels<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>
        in_index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
        channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
        num_convs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
        concat_input<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        dropout_ratio<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
        num_classes<span class="token operator">=</span><span class="token number">28</span><span class="token punctuation">,</span>       <span class="token comment"># 注意改这个值，</span>
        norm_cfg<span class="token operator">=</span>norm_cfg<span class="token punctuation">,</span>
        align_corners<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        loss_decode<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span> use_sigmoid<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># model training and testing settings</span>
    train_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    test_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">'whole'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment"># 2. data：根据'../_base_/datasets/ade20k.py'</span>
<span class="token comment"># dataset settings</span>
dataset_type <span class="token operator">=</span> <span class="token string">'MyDataset'</span>   <span class="token comment"># 自己mmseg/datasets/my_dataset.py中的类名</span>
data_root <span class="token operator">=</span> <span class="token string">'data/my_dataset'</span>
img_norm_cfg <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">123.675</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">103.53</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">58.395</span><span class="token punctuation">,</span> <span class="token number">57.12</span><span class="token punctuation">,</span> <span class="token number">57.375</span><span class="token punctuation">]</span><span class="token punctuation">,</span> to_rgb<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
crop_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
train_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LoadAnnotations'</span><span class="token punctuation">,</span> reduce_zero_label<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span> img_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1280</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ratio_range<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment"># img_scale我还是就用的我原图的大小，你可以改成你的大小，其他地方同步改</span>
    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RandomCrop'</span><span class="token punctuation">,</span> crop_size<span class="token operator">=</span>crop_size<span class="token punctuation">,</span> cat_max_ratio<span class="token operator">=</span><span class="token number">0.75</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">,</span> prob<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'PhotoMetricDistortion'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span> <span class="token operator">**</span>img_norm_cfg<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Pad'</span><span class="token punctuation">,</span> size<span class="token operator">=</span>crop_size<span class="token punctuation">,</span> pad_val<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> seg_pad_val<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'DefaultFormatBundle'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">,</span> <span class="token string">'gt_semantic_seg'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
test_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'MultiScaleFlipAug'</span><span class="token punctuation">,</span>
        img_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1280</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment"># img_ratios=[0.5, 0.75, 1.0, 1.25, 1.5, 1.75],</span>
        flip<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        transforms<span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span> keep_ratio<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span> <span class="token operator">**</span>img_norm_cfg<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'ImageToTensor'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
data <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    samples_per_gpu<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>   <span class="token comment"># 显存不够，来把这改小</span>
    workers_per_gpu<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>    
    train<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span>dataset_type<span class="token punctuation">,</span>
        data_root<span class="token operator">=</span>data_root<span class="token punctuation">,</span>
        img_dir<span class="token operator">=</span><span class="token string">'img_dir/train'</span><span class="token punctuation">,</span>
        ann_dir<span class="token operator">=</span><span class="token string">'ann_dir/train'</span><span class="token punctuation">,</span>
        pipeline<span class="token operator">=</span>train_pipeline<span class="token punctuation">)</span><span class="token punctuation">,</span>
    val<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span>dataset_type<span class="token punctuation">,</span>
        data_root<span class="token operator">=</span>data_root<span class="token punctuation">,</span>
        img_dir<span class="token operator">=</span><span class="token string">'img_dir/val'</span><span class="token punctuation">,</span>
        ann_dir<span class="token operator">=</span><span class="token string">'ann_dir/val'</span><span class="token punctuation">,</span>
        pipeline<span class="token operator">=</span>test_pipeline<span class="token punctuation">)</span><span class="token punctuation">,</span>
    test<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span>dataset_type<span class="token punctuation">,</span>
        data_root<span class="token operator">=</span>data_root<span class="token punctuation">,</span>
        img_dir<span class="token operator">=</span><span class="token string">'img_dir/test'</span><span class="token punctuation">,</span>
        ann_dir<span class="token operator">=</span><span class="token string">'ann_dir/test'</span><span class="token punctuation">,</span>
        pipeline<span class="token operator">=</span>test_pipeline<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment"># 3. 根据：'../_base_/default_runtime.py'</span>
<span class="token comment"># yapf:disable</span>
log_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    interval<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
    hooks<span class="token operator">=</span><span class="token punctuation">[</span>
        <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'TextLoggerHook'</span><span class="token punctuation">,</span> by_epoch<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment"># dict(type='TensorboardLoggerHook')</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># yapf:enable</span>
dist_params <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>backend<span class="token operator">=</span><span class="token string">'nccl'</span><span class="token punctuation">)</span>
log_level <span class="token operator">=</span> <span class="token string">'INFO'</span>
load_from <span class="token operator">=</span> <span class="token boolean">None</span>
resume_from <span class="token operator">=</span> <span class="token boolean">None</span>
workflow <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
cudnn_benchmark <span class="token operator">=</span> <span class="token boolean">True</span>


<span class="token comment"># 4. schedules：根据'../_base_/schedules/schedule_160k.py'</span>
<span class="token comment"># optimizer</span>
optimizer <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'SGD'</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">0.0005</span><span class="token punctuation">)</span>   <span class="token comment"># 根据自己情况改学习率吧</span>
optimizer_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># learning policy</span>
lr_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>policy<span class="token operator">=</span><span class="token string">'poly'</span><span class="token punctuation">,</span> power<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> min_lr<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> by_epoch<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token comment"># runtime settings</span>
runner <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'IterBasedRunner'</span><span class="token punctuation">,</span> max_iters<span class="token operator">=</span><span class="token number">160000</span><span class="token punctuation">)</span>
checkpoint_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>by_epoch<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> interval<span class="token operator">=</span><span class="token number">16000</span><span class="token punctuation">)</span>
evaluation <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">16000</span><span class="token punctuation">,</span> metric<span class="token operator">=</span><span class="token string">'mIoU'</span><span class="token punctuation">,</span> pre_eval<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_285"></a>训练</h4> 
<p>在mmsegmentation目录下，激活你的虚拟环境，然后执行：</p> 
<blockquote> 
 <p>单张GPU：python tools/train.py configs/pspnet/my_psp.py</p> 
 <p>两张GPU：./tools/dist_train.sh configs/pspnet/my_psp.py 2</p> 
</blockquote> 
<p>然后你应该就能看到这个效果：<br> <img src="https://images2.imgbox.com/11/7f/Cj3JP76f_o.png" alt="在这里插入图片描述"><br> 然后就大功告成。</p> 
<h3><a id="_299"></a>四、结果测试</h3> 
<p>把测试集的结果保存起来：</p> 
<blockquote> 
 <p>python tools/test.py configs/pspnet/my_psp.py work_dirs/my_psp/latest.pth --show-dir ./mypsp_output</p> 
</blockquote> 
<p>如果想像官方demo展示一样的话，就还需要修改文件<mark>mmseg/core/evaluation/class_names.py</mark>:</p> 
<p>仿照里面已有的数据写，添加（与上面保持一致）</p> 
<pre><code class="prism language-python"><span class="token comment"># for myself dataset</span>
<span class="token keyword">def</span> <span class="token function">mydata_classes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token string">'T01'</span><span class="token punctuation">,</span> <span class="token string">'T02_1'</span><span class="token punctuation">,</span> <span class="token string">'T02_2'</span><span class="token punctuation">,</span> <span class="token string">'T02_3'</span><span class="token punctuation">,</span> <span class="token string">'T03_1'</span><span class="token punctuation">,</span> <span class="token string">'T03_2'</span><span class="token punctuation">,</span> <span class="token string">'T03_3'</span><span class="token punctuation">,</span> <span class="token string">'T04'</span><span class="token punctuation">,</span> <span class="token string">'T05'</span><span class="token punctuation">,</span> <span class="token string">'T06'</span><span class="token punctuation">,</span> <span class="token string">'T07'</span><span class="token punctuation">,</span> <span class="token string">'T08'</span><span class="token punctuation">,</span> <span class="token string">'T09'</span><span class="token punctuation">,</span> <span class="token string">'T10'</span><span class="token punctuation">,</span>
        <span class="token string">'T11'</span><span class="token punctuation">,</span> <span class="token string">'T12'</span><span class="token punctuation">,</span> <span class="token string">'T13'</span><span class="token punctuation">,</span> <span class="token string">'T14'</span><span class="token punctuation">,</span> <span class="token string">'T15'</span><span class="token punctuation">,</span> <span class="token string">'T16'</span><span class="token punctuation">,</span> <span class="token string">'T17'</span><span class="token punctuation">,</span> <span class="token string">'T18'</span><span class="token punctuation">,</span> <span class="token string">'T19'</span><span class="token punctuation">,</span> <span class="token string">'T20'</span><span class="token punctuation">,</span> <span class="token string">'T21'</span><span class="token punctuation">,</span> <span class="token string">'T22'</span><span class="token punctuation">,</span> <span class="token string">'T26'</span><span class="token punctuation">,</span> <span class="token string">'background'</span>
    <span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">mydata_palette</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">204</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token number">230</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">235</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token number">143</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">204</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">204</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">220</span><span class="token punctuation">,</span> <span class="token number">220</span><span class="token punctuation">,</span> <span class="token number">220</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<p>这里面还有一处需要修改：</p> 
<pre><code class="prism language-python">dataset_aliases <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'cityscapes'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'cityscapes'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'ade'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'ade'</span><span class="token punctuation">,</span> <span class="token string">'ade20k'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'voc'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'voc'</span><span class="token punctuation">,</span> <span class="token string">'pascal_voc'</span><span class="token punctuation">,</span> <span class="token string">'voc12'</span><span class="token punctuation">,</span> <span class="token string">'voc12aug'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'mydata'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'mydata'</span><span class="token punctuation">]</span>     <span class="token comment"># 这处是自己添加的</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Tips：函数名这些别写错了，想要改成别的也一定要全部一起改。</p> 
<p>然后可以用官方展示demo的方式来展示你的结果了：</p> 
<blockquote> 
 <p>python demo/image_demo.py data/my_dataset/img_dir/test/10740.jpg work_dirs/my_psp/my_psp.py work_dirs/my_psp/latest.pth --device cuda:0 --palette mydata</p> 
</blockquote> 
<p>再次说明，一定要看我代码里写的注释说明，根据你的实际情况来改，除非极度巧合，不然直接拿来就跑，肯定是会出错的。</p> 
<p>我这里都是自己成功跑通了的，也是学习摸索中，如果哪里有什么问题，还请交流、雅正。</p> 
<p>希望能帮到你~</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/da3dd2350956d7139ee730ee2af826c1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">（前端）浏览器从输入URL到渲染完页面的整个过程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/07e6143c78c4a13348f4c7b303665a24/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ViT (Vision Transformer) ---- Text Generation（文本生成器）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>