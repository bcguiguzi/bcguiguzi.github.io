<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>《lwip学习6》-- ARP协议 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="《lwip学习6》-- ARP协议" />
<meta property="og:description" content="初始ARP 地址解析协议（Address Resolution Protocol， ARP）是通过解析 IP 地址得到数据链路层地址的，是一个在网络协议包中极其重要的网络传输协议，它与网卡有着极其密切的关系，在 TCP/IP 分层结构中，把 ARP 划分为网络层， 为什么呢，因为在网络层看来，源主机与目标主机是通过 IP 地址进行识别的，而所有的数据传输又依赖网卡底层硬件，即链路层，那么就需要将这些 IP 地址转换为链路层可以识别的东西，在所有的链路中都有着自己的一套寻址机制，如在以太网中使用 MAC 地址进行寻址，标识不同的主机，那么就需要有一个协议将 IP 地址转换为 MAC 地址，由此就出现了 ARP 协议， ARP 协议在网络层被应用，它是网络层与链路层连接的重要枢纽。
在局域网中，网络中实际传输的是“帧”，帧里面是有目标主机的 MAC 地址的。在以太网中，一个主机要和另一个主机进行直接通信，必须要知道目标主机的 MAC 地址，那就需要 ARP 进行地址解析， 所谓“地址解析”就是主机在发送帧前将目标 IP 地址转换成目标 MAC 地址的过程。 ARP 协议的基本功能就是通过目标设备的 IP 地址，查询目标设备的 MAC 地址，以保证通信的顺利进行。
以太网帧结构 既然谈到 MAC 地址， 那就不得不说一下以太网帧结构了， 每个网卡都有唯一一个物理地址， 在硬件中进行数据帧传输的时候就必须有正确的目的物理地址， 例如以太网的 48位 MAC 地址就是存储在网卡内部存储器中。
以太网帧以一个 7 字节的前同步码（Preamble）字段开始。该前同步码的值都是10101010（0x55，大端模式） ； 而后紧接着一个字节的帧开始符， 其值是 10101011（0xD5，大端模式） 。前同步码字段的作用是实现物理层帧输入输出的同步， 而帧开始符表示着以太网帧的开始， 剩下的 5 个字段才是真正的以太网数据帧结构。
目标 MAC 地址（6 字节） ： 这个字段包含目标网卡的 MAC 地址， 当一个网卡收到一个以太网数据帧，如果该数据帧的目标地址是网卡自身的 MAC 地址或者是 MAC 广播地址，它都将该帧的数据字段的内容传递给网络层；如果它收到了具有任何其他 MAC 地址的帧，则将该数据帧丢弃。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/46fe2230e3de07abf1c06045292fa05d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-29T15:54:26+08:00" />
<meta property="article:modified_time" content="2022-09-29T15:54:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">《lwip学习6》-- ARP协议</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="ARP_0"></a>初始ARP</h3> 
<p>地址解析协议（Address Resolution Protocol， ARP）是通过解析 IP 地址得到数据链路层地址的，是一个在网络协议包中极其重要的网络传输协议，它与网卡有着极其密切的关系，在 TCP/IP 分层结构中，把 ARP 划分为网络层， 为什么呢，因为在网络层看来，源主机与目标主机是通过 IP 地址进行识别的，而所有的数据传输又依赖网卡底层硬件，即链路层，那么就需要将这些 IP 地址转换为链路层可以识别的东西，在所有的链路中都有着自己的一套寻址机制，如在以太网中使用 MAC 地址进行寻址，标识不同的主机，那么就需要有一个协议将 IP 地址转换为 MAC 地址，由此就出现了 ARP 协议， ARP 协议在网络层被应用，它是网络层与链路层连接的重要枢纽。<br> 在局域网中，网络中实际传输的是“帧”，帧里面是有目标主机的 MAC 地址的。在以太网中，一个主机要和另一个主机进行直接通信，必须要知道目标主机的 MAC 地址，那就需要 ARP 进行地址解析， 所谓“地址解析”就是主机在发送帧前将目标 IP 地址转换成目标 MAC 地址的过程。 ARP 协议的基本功能就是通过目标设备的 IP 地址，查询目标设备的 MAC 地址，以保证通信的顺利进行。</p> 
<h3><a id="_3"></a>以太网帧结构</h3> 
<p>既然谈到 MAC 地址， 那就不得不说一下以太网帧结构了， 每个网卡都有唯一一个物理地址， 在硬件中进行数据帧传输的时候就必须有正确的目的物理地址， 例如以太网的 48位 MAC 地址就是存储在网卡内部存储器中。<br> <img src="https://images2.imgbox.com/1f/63/YAPzJOVX_o.png" alt="在这里插入图片描述"><br> 以太网帧以一个 7 字节的前同步码（Preamble）字段开始。该前同步码的值都是10101010（0x55，大端模式） ； 而后紧接着一个字节的帧开始符， 其值是 10101011（0xD5，大端模式） 。前同步码字段的作用是实现物理层帧输入输出的同步， 而帧开始符表示着以太网帧的开始， 剩下的 5 个字段才是真正的以太网数据帧结构。<br> <strong>目标 MAC 地址（6 字节）</strong> ： 这个字段包含目标网卡的 MAC 地址， 当一个网卡收到一个以太网数据帧，如果该数据帧的目标地址是网卡自身的 MAC 地址或者是 MAC 广播地址，它都将该帧的数据字段的内容传递给网络层；如果它收到了具有任何其他 MAC 地址的帧，则将该数据帧丢弃。<br> <strong>源 MAC 地址（6 字节）</strong> ： 这个字段包含了传输该帧到局域网上的适配器的 MAC 地址。<br> <strong>类型字段（2 字节）</strong> ： 类型字段允许以太网复用多种网络层协议。为了理解这点，我们需要记住主机能够使用除了 IP 以外的其他网络层协议。事实上，一台给定的主机可以支持多种网络层协议，以对不同的应用采用不同的协议。因此，当以太网帧到达网卡中， 网卡需要知道它应该将数据字段的内容传递给哪个网络层协议。 如 IP 协议、 ARP 协议等。<br> 注意了： 当这个字段的值小于 1518 时，它表示后面数据字段的数据长度，当大于1518 的时候才表示递交给哪个协议。<br> <strong>数据字段（46~1500 字节）</strong> ： 这个字段承载了 IP 数据报。以太网的最大传输单元（MTU）是 1500 字节。这意味着如果 IP 数据报超过了 1500 字节，则主机必须将该数据报分片（关于分片会在后续讲解） 。数据字段的最小长度是 46 字节， 这意味着如果 IP 数据报小于 46 字节，数据报必须被填充到 46 字节。当采用填充时，传递到网络层的数据包括IP 数据报和填充部分， 网络层使用 IP 数据报首部中的长度字段来去除填充部分。<br> <strong>CRC（4 字节）</strong> ： CRC 字段包含了以太网的差错校验信息。</p> 
<h3><a id="IP__13"></a>IP 地址映射为物理地址</h3> 
<p>TCP/IP 协议有自己的 IP 地址， IP 地址（IPv4） 是一个 32 位的 IP 地址，网络层发送数据包只需要知道目标主机 IP 地址即可，而以太网发送数据则必须知道对方的硬件 MAC 地址，同时 IP 地址的分配与硬件 MAC 地址是没有关系的，为了让网络层只需要知道 IP 地址就可以完成通信工作，那就需要有一个协议将 IP 地址映射成为对应的 MAC 地址。</p> 
<h3><a id="ARP__15"></a>ARP 缓存表</h3> 
<p>为了实现 IP 地址与网卡 MAC 地址的查询与转换， ARP 协议引入了 ARP 缓存表的概念， 每台主机或路由器在其内存中具有一个 ARP 缓存表（ARP table），这张表包含 IP 地址到 MAC 地址的映射关系，<br> 表中记录了&lt;IP 地址， MAC 地址&gt;对，它们是主机最近运行时获得关于其他主机的 IP 地址到物理地址的映射，当需要发送 IP 数据的时候，主机就会根据目标 IP 地址到 ARP 缓存表中进行查找对应的 MAC 地址，然后通过网卡将数据发送出去。<br> ARP 表也包含一个寿命（TTL）值，它指示了从表中删除每个映射的时间。从一个表项放置到某 ARP 表中开始，一个表项通常的过期时间是 10 分钟。<br> 我们电脑也是有自己的 ARP 缓存表的， 可以在控制台中通过“arp -a” 命令进行查看<br> 其运作过程大致可以理解为：</p> 
<ol><li>如果主机 A 想发送数据给主机 B，主机 A 首先会检查自己的 ARP 缓存表，查看是否有主机 B 的 IP 地址和 MAC 地址的对应关系，如果有，则会将主机 B 的MAC 地址作为源 MAC 地址封装到数据帧中。 如果本地 ARP 缓存中没有对应关系， 主机 A 就会向局域网中广播 ARP 请求（包括发送方的 IP 地址、 MAC 地址、接收方的 IP 地址），每台主机接收到 ARP 请求后都检查自己的 IP 地址是否与ARP 请求中的接收方 IP 地址相同，若不相同则丢弃 ARP 请求包。</li><li>当交换机接受到此数据帧之后，发现此数据帧是广播帧，因此，会将此数据帧从非接收的所有接口发送出去。</li><li>当主机 B 接受到此数据帧后，会校对 IP 地址是否是自己的，并将主机 A 的 IP 地址和 MAC 地址的对应关系记录到自己的 ARP 缓存表中，同时会发送一个 ARP 响应，其中包括自己的 MAC 地址。</li><li>主机 A 在收到这个回应的数据帧之后，在自己的 ARP 缓存表中记录主机 B 的 IP地址和 MAC 地址的对应关系。而此时交换机已经学习到了主机 A 和主机 B 的MAC 地址了</li></ol> 
<p>ARP 协议的核心是 ARP 缓存表， ARP 的实质就是对缓存表的建立、更新、查询等操作， ARP 缓存表的核心是表项（entry）。 LwIP 使用一个 arp_table 数组描述 ARP 缓存表，数组的内容是表项的内容，具体见代码清单。每个表项都必须记录一对 IP 地址与MAC 地址的映射关系，此外还有一些基本的信息，如表项的状态、生命周期（生存时间）以及对应网卡的基本信息， LwIP 使用一个 etharp_entry 结构体对表项进行描述</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">etharp_entry</span> arp_table<span class="token punctuation">[</span>ARP_TABLE_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//arp表项</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">etharp_entry</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ARP_QUEUEING</span></span>
  <span class="token comment">/** Pointer to queue of pending outgoing packets on this ARP entry. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">etharp_q_entry</span> <span class="token operator">*</span>q<span class="token punctuation">;</span><span class="token comment">//指向要发送的数据包，多个数据包</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* ARP_QUEUEING */</span></span>
  <span class="token comment">/** Pointer to a single pending outgoing packet on this ARP entry. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>q<span class="token punctuation">;</span><span class="token comment">//指向要发送的数据包，单个数据包，默认</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ARP_QUEUEING */</span></span>
  <span class="token class-name">ip4_addr_t</span> ipaddr<span class="token punctuation">;</span> <span class="token comment">//记录目标 IP 地址。</span>
  <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">;</span> <span class="token comment">//对应网卡信息</span>
  <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> ethaddr<span class="token punctuation">;</span> <span class="token comment">//记录与目标 IP 地址对应的 MAC 地址</span>
  <span class="token class-name">u16_t</span> ctime<span class="token punctuation">;</span> <span class="token comment">//生存实际</span>
  <span class="token class-name">u8_t</span> state<span class="token punctuation">;</span> <span class="token comment">//表项的状态</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>关于表项的状态，有如下几种状态</p> 
<pre><code class="prism language-c"><span class="token comment">/** ARP states */</span>
<span class="token keyword">enum</span> <span class="token class-name">etharp_state</span> <span class="token punctuation">{<!-- --></span>
  ETHARP_STATE_EMPTY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//空状态，表示此表项能被使用</span>
  ETHARP_STATE_PENDING<span class="token punctuation">,</span> <span class="token comment">//表示 ARP 已经发出了一个 ARP 请求包， 但是还未收到目标 IP 地址主机的应答</span>
  ETHARP_STATE_STABLE<span class="token punctuation">,</span> <span class="token comment">//稳定状态</span>
  ETHARP_STATE_STABLE_REREQUESTING_1<span class="token punctuation">,</span> <span class="token comment">//当稳定状态发送一个ARP请求报，首先暂时设置未 _1</span>
  ETHARP_STATE_STABLE_REREQUESTING_2  <span class="token comment">//当稳定状态发送一个ARP请求报，之后设置未 _2，最后恢复稳定状态</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ETHARP_SUPPORT_STATIC_ENTRIES</span></span>
  <span class="token punctuation">,</span> ETHARP_STATE_STATIC
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ETHARP_SUPPORT_STATIC_ENTRIES */</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>ARP 缓存表在初始化的时候， 所有的表项都会被<strong>初始化为</strong> ETHARP_STATE_EMPTY，也就是空状态， 表示这些表项<strong>能被使用</strong>，</p> 
<p>在需要<strong>添加表项</strong>的时候， LwIP 内核就会遍历ARP 缓存表， 找到合适的表项， 进行添加。如果 ARP 表项处于ETHARP_STATE_PENDING 状态， 表示 <strong>ARP 已经发出了一个 ARP 请求包</strong>， 但是还未收到目标 IP 地址主机的应答， 处于这个状态的缓存表项是有等待时间的， 它通过宏定义<strong>ARP_MAXPENDING</strong> 指定， 默认为 5 秒钟，如果从发出 ARP 请求包后的 5 秒内还没收到应答，那么该表项又会被删除；</p> 
<p>而<strong>如果收到应答后</strong>， ARP 就会更新缓存表的信息，记录目标 IP 地址与目标 MAC 地址的映射关系并且开始记录表项的生存时间，同时该表项的状态会变成 ETHARP_STATE_STABLE 状态。当要发送数据包的时候，而此时表项为ETHARP_STATE_PENDING 状态， 那么这些数据包就会暂时被挂载到表项的数据包缓冲队列上， 直到表项的状态为 ETHARP_STATE_STABLE， 才进行发送数据包。</p> 
<p>对于状态为ETHARP_STATE_STABLE 的表项， 这些表项代表着 ARP 记录了 IP 地址与 MAC 地址的映射关系， 能随意通过 IP 地址进行数据的发送， 但是这些表项是具有生存时间的， 通过宏定义 ARP_MAXAGE 指定， 默认为 5 分钟，在这些时间， LwIP 会不断维护这些缓存表以保持缓存表的有效。当表项是 ETHARP_STATE_STABLE 的时候又发送一个 ARP 请求包，那么表项状态会暂时被设置为 ETHARP_STATE_STABLE_REREQUESTING_1， 然后被设置为 ETHARP_STATE_STABLE_REREQUESTING_2 状态， 这些是一个过渡状态， 当收到ARP 应答后， 表项又会被设置为 ETHARP_STATE_STABLE， 这样子能保持表项的有效。</p> 
<h3><a id="ARP_70"></a>ARP缓存表的超时处理</h3> 
<p>ARP 是动态处理的， 现在总结一下： ARP 表项的生存时间是 5分钟，而 ARP 请求的等待时间是 5 秒钟，当这些时间到达后，就会更新 ARP 表项，如果在物理链路层无法连通则会删除表项。这就需要 ARP 层有一个超时处理函数对 ARP 进行管理，这些操作都是根据 ARP 表项的 ctime 字段进行的，它记录着对应表项的生存时间，而超时处理函数是 etharp_tmr()，它是一个周期性的超时处理函数，每隔 1 秒就调用一次，当 ctime 的值大于指定的时间， 就会删除对应的表项，<br> etharp_tmr() 通过在超时检查函数中被调用：sys_check_timeouts(void) -&gt; lwip_cyclic_timer(void *arg)</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span>
<span class="token function">etharp_tmr</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>

  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_timer\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* remove expired entries from the ARP table */</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ARP_TABLE_SIZE<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">u8_t</span> state <span class="token operator">=</span> arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> ETHARP_STATE_EMPTY
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ETHARP_SUPPORT_STATIC_ENTRIES</span></span>
        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> ETHARP_STATE_STATIC<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ETHARP_SUPPORT_STATIC_ENTRIES */</span></span>
       <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ctime<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">//如果 ARP 表项不是空的，那么就记录表项的时间。</span>
      <span class="token comment">//当表项的时间大于表项的生存时间（5 分钟），或者表项状态</span>
      <span class="token comment">//是 ETHARP_STATE_PENDING 处于等待目标主机回应 ARP 请求包，并且等待的时间超过</span>
      <span class="token comment">//ARP_MAXPENDING（5 秒），那么 LwIP 就认为这些表项是无效了，就调用etharp_free_entry()函数删除表项</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ctime <span class="token operator">&gt;=</span> ARP_MAXAGE<span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_PENDING<span class="token punctuation">)</span>  <span class="token operator">&amp;&amp;</span>
           <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ctime <span class="token operator">&gt;=</span> ARP_MAXPENDING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* pending or stable entry has become old! */</span>
        <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_timer: expired %s entry %d.\n"</span><span class="token punctuation">,</span>
                                   arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">&gt;=</span> ETHARP_STATE_STABLE <span class="token operator">?</span> <span class="token string">"stable"</span> <span class="token operator">:</span> <span class="token string">"pending"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* clean up entries that have just been expired */</span>
        <span class="token function">etharp_free_entry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//删除表项</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_STABLE_REREQUESTING_1<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Don't send more than one request every 2 seconds. */</span>
        arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> ETHARP_STATE_STABLE_REREQUESTING_2<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_STABLE_REREQUESTING_2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Reset state to stable, so that the next transmitted packet will
           re-send an ARP request. */</span>
        arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> ETHARP_STATE_STABLE<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_PENDING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* still pending, resend an ARP query */</span>
        <span class="token function">etharp_request</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>netif<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//处于挂起状态，则再次发送ARP请求</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="ARP_116"></a>ARP报文</h3> 
<p>ARP 的请求与应答都是依赖 ARP 报文结构进行的， ARP 报文是放在以太网数据帧中进行发送的，所以下图会将以太网首部一同画出来<br> <img src="https://images2.imgbox.com/6e/a7/P2JGiF8W_o.png" alt="在这里插入图片描述"><br> 在 ARP 表建立前， 主机并不知道目标 MAC 地址， 所以在一开始的时候只能通过广播的方式将 ARP 请求包发送出去， 处于同一局域网的主机都能接收到广播的数据包。所以一开始目标 MAC 地址是 FF-FF-FF-FF-FF-FF，而以太网首部的帧类型是有多种，对于 ARP数据包来说，其值为 0x0806，对于 IP 数据报来说，其值为 0x0800，此处我们只需简单了解一下即可，无需记住。</p> 
<p>接下来就是 ARP 报文部分， ARP 也是一种协议， 也有 ARP 首部，在 ARP 首部一开始的 2 个字节存储的是硬件类型，表示要知道目标网卡的硬件类型， 其中，值为 1 表示以太网地址，其他还可能表示令牌环地址； 接下来还有 2 字节的协议类型， 表示硬件地址要映射的协议地址类型， 其中， 0x0800 表示 IP 地址，其他还可能是 ICMP/IGMP 等；接下来有1 个字节表示硬件地址长度，指出该报文中硬件地址的长度，对于以太网，它的值为 6；还有 1 字节的协议地址长度， 对于 ARP 请求或应答来说，该值为 4； ARP 首部最后的 op 字段用于记录 ARP 操作的类型，分别是：<br>  ARP 请求，其值为 1。<br>  ARP 应答，其值为 2。<br>  RARP 请求，其值为 3。 //不关心<br>  RARP 应答，其值为 4 //不关心</p> 
<p>对于 ARP 首部后面的四个字段分别是源 MAC 地址、 源 IP 地址、目标 MAC 地址、目标 IP 地址，这些就是比较简单的了<br> 在 ARP 请求包中，除了目标 MAC 地址是未知以外，其他地址 3 个字段都应该填写正确，然后通过广播的形式将该 ARP 请求包发送出去，目标主机接收到该请求包后判断目标IP 地址与自身 IP 地址是否一致，如果一致则返回 ARP 应答；对应 ARP 应答包，只需要把自己的 MAC 地址填充进去，并且请求包的源主机信息与目标主机信息进行交换位置，然后把 op 字段设置为 2，就返回 ARP 应答包即可。<br> 注意，在发送 ARP 请求包的时候，以太网首部的目标 MAC 地址是 FF-FF-FF-FF-FFFF，而 ARP 首目标 MAC 地址为 00-00-00-00-00-00-00（表示要填充），这里千万不要混淆。</p> 
<p>在 LwIP 中， 使用了大量的数据结构对 ARP 进行描述， 比较麻烦， 我们暂时不用去学它， 只要知道原理是这样子的即可， 关于这些数据结构的定义位于 etharp.h 、 ethernet.h 等头文件中</p> 
<pre><code class="prism language-c"><span class="token comment">/** An Ethernet MAC address */</span>
<span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">PACK_STRUCT_FLD_8</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span> addr<span class="token punctuation">[</span>ETH_HWADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> PACK_STRUCT_STRUCT<span class="token punctuation">;</span>

<span class="token comment">/** Ethernet header */</span>
<span class="token keyword">struct</span> <span class="token class-name">eth_hdr</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ETH_PAD_SIZE</span></span>
  <span class="token function">PACK_STRUCT_FLD_8</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span> padding<span class="token punctuation">[</span>ETH_PAD_SIZE<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token function">PACK_STRUCT_FLD_S</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">PACK_STRUCT_FLD_S</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">PACK_STRUCT_FIELD</span><span class="token punctuation">(</span><span class="token class-name">u16_t</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> PACK_STRUCT_STRUCT<span class="token punctuation">;</span>

<span class="token comment">/** the ARP message, see RFC 826 ("Packet format") */</span>
<span class="token keyword">struct</span> <span class="token class-name">etharp_hdr</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//ARP报文</span>
  <span class="token function">PACK_STRUCT_FIELD</span><span class="token punctuation">(</span><span class="token class-name">u16_t</span> hwtype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//硬件类型</span>
  <span class="token function">PACK_STRUCT_FIELD</span><span class="token punctuation">(</span><span class="token class-name">u16_t</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//协议类型</span>
  <span class="token function">PACK_STRUCT_FLD_8</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span>  hwlen<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//硬件地址长度</span>
  <span class="token function">PACK_STRUCT_FLD_8</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span>  protolen<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//协议地址长度</span>
  <span class="token function">PACK_STRUCT_FIELD</span><span class="token punctuation">(</span><span class="token class-name">u16_t</span> opcode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//op 字段</span>
  <span class="token comment">/* 以上是 ARP 报文首部 */</span>
  <span class="token function">PACK_STRUCT_FLD_S</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> shwaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//源 MAC 地址</span>
  <span class="token function">PACK_STRUCT_FLD_S</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip4_addr_wordaligned</span> sipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//源 ip 地址</span>
  <span class="token function">PACK_STRUCT_FLD_S</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> dhwaddr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//目标 MAC 地址</span>
  <span class="token function">PACK_STRUCT_FLD_S</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip4_addr_wordaligned</span> dipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//目标 ip 地址</span>
<span class="token punctuation">}</span> PACK_STRUCT_STRUCT<span class="token punctuation">;</span>

<span class="token comment">/* ARP message types (opcodes) */</span>
<span class="token keyword">enum</span> <span class="token class-name">etharp_opcode</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//op 字段操作</span>
  ARP_REQUEST <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token comment">//请求包</span>
  ARP_REPLY   <span class="token operator">=</span> <span class="token number">2</span>     <span class="token comment">//应答包</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<h3><a id="ARP_170"></a>发送ARP请求包</h3> 
<p>发送 ARP 请求包的时候，需要填充已知的目标 IP 地址、源 MAC 地址、源 IP 地址等，并且需要该 ARP 包进行广播出去，所以以太网首部的目标 MAC 地址为 FF-FF-FF-FF-FF-FF</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * Send a raw ARP packet (opcode and all addresses can be modified)
 *发送原始 ARP 数据包（操作码和所有地址都可以修改）
 * @param netif the lwip network interface on which to send the ARP packet 用于发送 ARP 数据包的 lwip 网络接口
 * @param ethsrc_addr the source MAC address for the ethernet header 以太网头的源 MAC 地址
 * @param ethdst_addr the destination MAC address for the ethernet header 以太网头的目标 MAC 地址
 * @param hwsrc_addr the source MAC address for the ARP protocol header ARP 协议头的源 MAC 地址
 * @param ipsrc_addr the source IP address for the ARP protocol header ARP 协议头的源 IP 地址
 * @param hwdst_addr the destination MAC address for the ARP protocol header ARP 协议头的目标 MAC 地址
 * @param ipdst_addr the destination IP address for the ARP protocol header ARP 协议头的目标 IP 地址
 * @param opcode the type of the ARP packet 操作编码 ARP 数据包的类型
 * @return ERR_OK if the ARP packet has been sent
 *         ERR_MEM if the ARP packet couldn't be allocated
 *         any other err_t on failure
 */</span>
<span class="token keyword">static</span> <span class="token class-name">err_t</span>
<span class="token function">etharp_raw</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span>ethsrc_addr<span class="token punctuation">,</span>
           <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span>ethdst_addr<span class="token punctuation">,</span>
           <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span>hwsrc_addr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">ip4_addr_t</span> <span class="token operator">*</span>ipsrc_addr<span class="token punctuation">,</span>
           <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span>hwdst_addr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">ip4_addr_t</span> <span class="token operator">*</span>ipdst_addr<span class="token punctuation">,</span>
           <span class="token keyword">const</span> <span class="token class-name">u16_t</span> opcode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
  <span class="token class-name">err_t</span> result <span class="token operator">=</span> ERR_OK<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">etharp_hdr</span> <span class="token operator">*</span>hdr<span class="token punctuation">;</span>

  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"netif != NULL"</span><span class="token punctuation">,</span> netif <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* allocate a pbuf for the outgoing ARP request packet */</span>
  p <span class="token operator">=</span> <span class="token function">pbuf_alloc</span><span class="token punctuation">(</span>PBUF_LINK<span class="token punctuation">,</span> SIZEOF_ETHARP_HDR<span class="token punctuation">,</span> PBUF_RAM<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//申请 ARP 报文的内存空间</span>
  <span class="token comment">/* could allocate a pbuf for an ARP request? */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE <span class="token operator">|</span> LWIP_DBG_LEVEL_SERIOUS<span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token string">"etharp_raw: could not allocate pbuf for ARP request.\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>memerr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ERR_MEM<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"check that first pbuf can hold struct etharp_hdr"</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>len <span class="token operator">&gt;=</span> SIZEOF_ETHARP_HDR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">etharp_hdr</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>payload<span class="token punctuation">;</span> <span class="token comment">//ARP 报文的数据区域，并且强制将起始地址转化成 ARP 报文首部</span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_raw: sending raw ARP packet.\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hdr<span class="token operator">-&gt;</span>opcode <span class="token operator">=</span> <span class="token function">lwip_htons</span><span class="token punctuation">(</span>opcode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//填写 ARP 数据包的 op 字段</span>

  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"netif-&gt;hwaddr_len must be the same as ETH_HWADDR_LEN for etharp!"</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>hwaddr_len <span class="token operator">==</span> ETH_HWADDR_LEN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Write the ARP MAC-Addresses */</span>
  <span class="token function">SMEMCPY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdr<span class="token operator">-&gt;</span>shwaddr<span class="token punctuation">,</span> hwsrc_addr<span class="token punctuation">,</span> ETH_HWADDR_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//填写源 MAC 地址</span>
  <span class="token function">SMEMCPY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdr<span class="token operator">-&gt;</span>dhwaddr<span class="token punctuation">,</span> hwdst_addr<span class="token punctuation">,</span> ETH_HWADDR_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//填写目标 MAC 地址</span>
  <span class="token comment">/* Copy struct ip4_addr_wordaligned to aligned ip4_addr, to support compilers without
   * structure packing. */</span>
  <span class="token function">IPADDR_WORDALIGNED_COPY_FROM_IP4_ADDR_T</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdr<span class="token operator">-&gt;</span>sipaddr<span class="token punctuation">,</span> ipsrc_addr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//以太网首部源 MAC 地址</span>
  <span class="token function">IPADDR_WORDALIGNED_COPY_FROM_IP4_ADDR_T</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hdr<span class="token operator">-&gt;</span>dipaddr<span class="token punctuation">,</span> ipdst_addr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//以太网首部目标 MAC 地址</span>

  hdr<span class="token operator">-&gt;</span>hwtype <span class="token operator">=</span> <span class="token function">PP_HTONS</span><span class="token punctuation">(</span>LWIP_IANA_HWTYPE_ETHERNET<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//填写 ARP 首部硬件类型</span>
  hdr<span class="token operator">-&gt;</span>proto <span class="token operator">=</span> <span class="token function">PP_HTONS</span><span class="token punctuation">(</span>ETHTYPE_IP<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//填写 ARP 首部协议类型</span>
  <span class="token comment">/* set hwlen and protolen */</span>
  hdr<span class="token operator">-&gt;</span>hwlen <span class="token operator">=</span> ETH_HWADDR_LEN<span class="token punctuation">;</span> <span class="token comment">//填写 ARP 数据包硬件地址长度</span>
  hdr<span class="token operator">-&gt;</span>protolen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">ip4_addr_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//填写 ARP 数据包协议地址长度</span>

  <span class="token comment">/* send ARP query */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_AUTOIP</span></span>
  <span class="token comment">/* If we are using Link-Local, all ARP packets that contain a Link-Local
   * 'sender IP address' MUST be sent using link-layer broadcast instead of
   * link-layer unicast. (See RFC3927 Section 2.5, last paragraph) */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ip4_addr_islinklocal</span><span class="token punctuation">(</span>ipsrc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">ethernet_output</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> p<span class="token punctuation">,</span> ethsrc_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ethbroadcast<span class="token punctuation">,</span> ETHTYPE_ARP<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_AUTOIP */</span></span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">ethernet_output</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> p<span class="token punctuation">,</span> ethsrc_addr<span class="token punctuation">,</span> ethdst_addr<span class="token punctuation">,</span> ETHTYPE_ARP<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用底层发送函数将以太网数据帧发送出去</span>
  <span class="token punctuation">}</span>

  <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>xmit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* free ARP query packet */</span>
  <span class="token function">pbuf_free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token comment">/* could not allocate pbuf for ARP request */</span>

  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c">
<span class="token comment">/**
 * Send an ARP request packet asking for ipaddr to a specific eth address.
 * Used to send unicast request to refresh the ARP table just before an entry
 * times out
 *
 * @param netif the lwip network interface on which to send the request 网卡接口
 * @param ipaddr the IP address for which to ask 目的IP地址
 * @param hw_dst_addr the ethernet address to send this packet to 要发送的以太网协议MAC地址FF
 * @return ERR_OK if the request has been sent
 *         ERR_MEM if the ARP packet couldn't be allocated
 *         any other err_t on failure
 */</span>
<span class="token keyword">static</span> <span class="token class-name">err_t</span>
<span class="token function">etharp_request_dst</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">ip4_addr_t</span> <span class="token operator">*</span>ipaddr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span>hw_dst_addr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">etharp_raw</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span><span class="token punctuation">)</span>netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">,</span> hw_dst_addr<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span><span class="token punctuation">)</span>netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">,</span> <span class="token function">netif_ip4_addr</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ethzero<span class="token punctuation">,</span>
                    ipaddr<span class="token punctuation">,</span> ARP_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Send an ARP request packet asking for ipaddr.
 *
 * @param netif the lwip network interface on which to send the request 网卡接口
 * @param ipaddr the IP address for which to ask 发送的目的IP地址
 * @return ERR_OK if the request has been sent
 *         ERR_MEM if the ARP packet couldn't be allocated
 *         any other err_t on failure
 */</span>
<span class="token class-name">err_t</span>
<span class="token function">etharp_request</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">ip4_addr_t</span> <span class="token operator">*</span>ipaddr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_request: sending ARP request.\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">etharp_request_dst</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> ipaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ethbroadcast<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>总的来说就是先调用 etharp_request()函数进行发送 ARP 请求包，在 etharp_request()函数中会调用 etharp_request_dst()函数进行发送，此时指定的目标 MAC 地址是 ethbroadcast，而在 etharp_request_dst()函数中会调用 etharp_raw()进行发送 ARP 请求包，层层调用，并且每层的参数都是越来越多的，这样子封装对于上层程序来说更加好处理，在 etharp_raw()函数中，会对 ARP 数据包进行封装，然后再封装到以太网数据帧中，最终调用以太网底层发送函数进行将以太网数据帧发送出去。</p> 
<h3><a id="_297"></a>数据包接收流程</h3> 
<p>当数据通过网卡中接收回来的时候， LwIP 内核就需要将数据进行分解，如果是 IP 数据报则递交给 IP 协议去处理，如果是 ARP 数据包则交由 ARP 协议去处理。 LwIP 中数据包从网卡接收的函数是 ethernetif_input()，真正让 LwIP 内核去处理接收到的数据包是 ethernet_input()函数。</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * @ingroup lwip_nosys
 * Process received ethernet frames. Using this function instead of directly
 * calling ip_input and passing ARP frames through etharp in ethernetif_input,
 * the ARP cache is protected from concurrent access.\n
 * Don't call directly, pass to netif_add() and call netif-&gt;input().
 *
 * @param p the received packet, p-&gt;payload pointing to the ethernet header  p-&gt;payload指向以太网帧的头部
 * @param netif the network interface on which the packet was received
 *
 * @see LWIP_HOOK_UNKNOWN_ETH_PROTOCOL
 * @see ETHARP_SUPPORT_VLAN
 * @see LWIP_HOOK_VLAN_CHECK
 */</span>
<span class="token class-name">err_t</span>
<span class="token function">ethernet_input</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">struct</span> <span class="token class-name">eth_hdr</span> <span class="token operator">*</span>ethhdr<span class="token punctuation">;</span>
  <span class="token class-name">u16_t</span> type<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_ARP <span class="token operator">||</span> ETHARP_SUPPORT_VLAN <span class="token operator">||</span> LWIP_IPV6</span></span>
  <span class="token class-name">u16_t</span> next_hdr_offset <span class="token operator">=</span> SIZEOF_ETH_HDR<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_ARP || ETHARP_SUPPORT_VLAN */</span></span>

  <span class="token function">LWIP_ASSERT_CORE_LOCKED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>len <span class="token operator">&lt;=</span> SIZEOF_ETH_HDR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* a packet with only an ethernet header (or less) is not valid for us */</span>
    <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>proterr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>drop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MIB2_STATS_NETIF_INC</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> ifinerrors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> free_and_return<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>if_idx <span class="token operator">==</span> NETIF_NO_INDEX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    p<span class="token operator">-&gt;</span>if_idx <span class="token operator">=</span> <span class="token function">netif_get_index</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* points to packet payload, which starts with an Ethernet header */</span>
  ethhdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth_hdr</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>payload<span class="token punctuation">;</span>
  type <span class="token operator">=</span> ethhdr<span class="token operator">-&gt;</span>type<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ethhdr<span class="token operator">-&gt;</span>dest<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* this might be a multicast or broadcast packet */</span>
    <span class="token comment">//这可能是多播或者广播数据包</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ethhdr<span class="token operator">-&gt;</span>dest<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> LL_IP4_MULTICAST_ADDR_0<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4</span></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ethhdr<span class="token operator">-&gt;</span>dest<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> LL_IP4_MULTICAST_ADDR_1<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span>ethhdr<span class="token operator">-&gt;</span>dest<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> LL_IP4_MULTICAST_ADDR_2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* mark the pbuf as link-layer multicast */</span>
        <span class="token comment">/* 将 pbuf 标记为链路层多播 */</span>
        p<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> PBUF_FLAG_LLMCAST<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 */</span></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">eth_addr_cmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ethhdr<span class="token operator">-&gt;</span>dest<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ethbroadcast<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* mark the pbuf as link-layer broadcast */</span>
      <span class="token comment">/* 将 pbuf 标记为链路层广播 */</span>
      p<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> PBUF_FLAG_LLBCAST<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_IPV4 <span class="token operator">&amp;&amp;</span> LWIP_ARP</span></span>
    <span class="token comment">/* IP packet? */</span>
    <span class="token keyword">case</span> <span class="token function">PP_HTONS</span><span class="token punctuation">(</span>ETHTYPE_IP<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token comment">/* 如果是 IP 数据报 */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> NETIF_FLAG_ETHARP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">goto</span> free_and_return<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">/* skip Ethernet header (min. size checked above) */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pbuf_remove_header</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> next_hdr_offset<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* 跳过以太网首部 */</span>
        <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE <span class="token operator">|</span> LWIP_DBG_LEVEL_WARNING<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token string">"ethernet_input: IPv4 packet dropped, too short (%"</span>U16_F<span class="token string">"/%"</span>U16_F<span class="token string">")\n"</span><span class="token punctuation">,</span>
                     p<span class="token operator">-&gt;</span>tot_len<span class="token punctuation">,</span> next_hdr_offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Can't move over header in packet"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> free_and_return<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* pass to IP layer */</span>
        <span class="token function">ip4_input</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> netif<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* 传递到 IP 协议去处理 */</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> <span class="token function">PP_HTONS</span><span class="token punctuation">(</span>ETHTYPE_ARP<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token comment">//对于是 ARP 包</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> NETIF_FLAG_ETHARP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">goto</span> free_and_return<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">/* skip Ethernet header (min. size checked above) */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pbuf_remove_header</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> next_hdr_offset<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* 跳过以太网首部 */</span>
        <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE <span class="token operator">|</span> LWIP_DBG_LEVEL_WARNING<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token string">"ethernet_input: ARP response packet dropped, too short (%"</span>U16_F<span class="token string">"/%"</span>U16_F<span class="token string">")\n"</span><span class="token punctuation">,</span>
                     p<span class="token operator">-&gt;</span>tot_len<span class="token punctuation">,</span> next_hdr_offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Can't move over header in packet"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>lenerr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>drop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> free_and_return<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* pass p to ARP module */</span>
        <span class="token function">etharp_input</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> netif<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/*传递到 ARP 协议处理 */</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_IPV4 &amp;&amp; LWIP_ARP */</span></span>
    <span class="token keyword">default</span><span class="token operator">:</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">LWIP_HOOK_UNKNOWN_ETH_PROTOCOL</span></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">LWIP_HOOK_UNKNOWN_ETH_PROTOCOL</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> netif<span class="token punctuation">)</span> <span class="token operator">==</span> ERR_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
      <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>proterr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>drop<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">MIB2_STATS_NETIF_INC</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> ifinunknownprotos<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> free_and_return<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* This means the pbuf is freed or consumed,
     so the caller doesn't have to free it again */</span>
  <span class="token keyword">return</span> ERR_OK<span class="token punctuation">;</span>

free_and_return<span class="token operator">:</span>
  <span class="token function">pbuf_free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> ERR_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面函数中，对于IP协议，除去以太网帧首部成功，调用 ip4_input()函数将数据包递交到 IP协议去处理；<br> 对于ARP协议，调用 etharp_input ()函数将数据包递交到ARP 协议去处理。</p> 
<p>ARP 数据包的处理函数为 etharp _input()， 在这里它完成两个任务：</p> 
<ol><li>如果收到的是 ARP 应答包，说明本机之前发出的 ARP 请求包有了回应， 就根据应答包更新自身的 ARP 缓存表；</li><li>如果收到的是 ARP 请求包，如果包中的目标 IP 地址与主机 IP 地址匹配， 除了记录原主机的 IP 与 MAC 地址，更新自身的 ARP 表外，还要向源主机发送一个ARP 应答包。但是如果包中目标 IP 地址与主机 IP 地址不匹配，则尽可能记录源主机的 IP 与 MAC 地址，更新自身的 ARP 表，并丢弃该请求包，为什么说是尽可能呢，因为主机的 ARP 缓存表是有限的，不可能记录太多的 ARP 表项，所以在有空闲的表项时才记录，如果没有空闲的表项， ARP 觉得它自己已经尽力了，也记不住那么多表项。</li></ol> 
<pre><code class="prism language-c"><span class="token comment">/**
 * Responds to ARP requests to us. Upon ARP replies to us, add entry to cache
 * send out queued IP packets. Updates cache with snooped address pairs.
 *
 * Should be called for incoming ARP packets. The pbuf in the argument
 * is freed by this function.
 *
 * @param p The ARP packet that arrived on netif. Is freed by this function.
 * @param netif The lwIP network interface on which the ARP packet pbuf arrived.
 *
 * @see pbuf_free()
 */</span>
<span class="token keyword">void</span>
<span class="token function">etharp_input</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">struct</span> <span class="token class-name">etharp_hdr</span> <span class="token operator">*</span>hdr<span class="token punctuation">;</span>
  <span class="token comment">/* these are aligned properly, whereas the ARP header fields might not be */</span>
  <span class="token class-name">ip4_addr_t</span> sipaddr<span class="token punctuation">,</span> dipaddr<span class="token punctuation">;</span>
  <span class="token class-name">u8_t</span> for_us<span class="token punctuation">;</span>

  <span class="token function">LWIP_ASSERT_CORE_LOCKED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">LWIP_ERROR</span><span class="token punctuation">(</span><span class="token string">"netif != NULL"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>netif <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">etharp_hdr</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-&gt;</span>payload<span class="token punctuation">;</span>

  <span class="token comment">/* RFC 826 "Packet Reception": */</span>
  <span class="token comment">/* 判断 ARP 包的合法性 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hdr<span class="token operator">-&gt;</span>hwtype <span class="token operator">!=</span> <span class="token function">PP_HTONS</span><span class="token punctuation">(</span>LWIP_IANA_HWTYPE_ETHERNET<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>hdr<span class="token operator">-&gt;</span>hwlen <span class="token operator">!=</span> ETH_HWADDR_LEN<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>hdr<span class="token operator">-&gt;</span>protolen <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">ip4_addr_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>hdr<span class="token operator">-&gt;</span>proto <span class="token operator">!=</span> <span class="token function">PP_HTONS</span><span class="token punctuation">(</span>ETHTYPE_IP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">{<!-- --></span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE <span class="token operator">|</span> LWIP_DBG_LEVEL_WARNING<span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token string">"etharp_input: packet dropped, wrong hw type, hwlen, proto, protolen or ethernet type (%"</span>U16_F<span class="token string">"/%"</span>U16_F<span class="token string">"/%"</span>U16_F<span class="token string">"/%"</span>U16_F<span class="token string">")\n"</span><span class="token punctuation">,</span>
                 hdr<span class="token operator">-&gt;</span>hwtype<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">u16_t</span><span class="token punctuation">)</span>hdr<span class="token operator">-&gt;</span>hwlen<span class="token punctuation">,</span> hdr<span class="token operator">-&gt;</span>proto<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">u16_t</span><span class="token punctuation">)</span>hdr<span class="token operator">-&gt;</span>protolen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>proterr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>drop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pbuf_free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>recv<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_AUTOIP</span></span>
  <span class="token comment">/* We have to check if a host already has configured our random
   * created link local address and continuously check if there is
   * a host with this IP-address so we can detect collisions */</span>
  <span class="token function">autoip_arp_reply</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> hdr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_AUTOIP */</span></span>

  <span class="token comment">/* Copy struct ip4_addr_wordaligned to aligned ip4_addr, to support compilers without
   * structure packing (not using structure copy which breaks strict-aliasing rules). */</span>
  <span class="token comment">//拷贝源 IP 地址与目标 IP 地址</span>
  <span class="token function">IPADDR_WORDALIGNED_COPY_TO_IP4_ADDR_T</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sipaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hdr<span class="token operator">-&gt;</span>sipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">IPADDR_WORDALIGNED_COPY_TO_IP4_ADDR_T</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dipaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hdr<span class="token operator">-&gt;</span>dipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* this interface is not configured? */</span>
  <span class="token comment">/* 看看主机网卡是否配置了 IP 地址 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ip4_addr_isany_val</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token function">netif_ip4_addr</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    for_us <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* ARP packet directed to us? */</span>
    <span class="token comment">/* 判断目标 IP 地址与主机 IP 地址是否一样 */</span>
    for_us <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">u8_t</span><span class="token punctuation">)</span><span class="token function">ip4_addr_cmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dipaddr<span class="token punctuation">,</span> <span class="token function">netif_ip4_addr</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* ARP message directed to us?
      -&gt; add IP address in ARP cache; assume requester wants to talk to us,
         can result in directly sending the queued packets for this host.
     ARP message not directed to us?
      -&gt;  update the source IP address in the cache, if present */</span>
      <span class="token comment">/* 更新 ARP 缓存表 */</span>
  <span class="token function">etharp_update_arp_entry</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sipaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>hdr<span class="token operator">-&gt;</span>shwaddr<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          for_us <span class="token operator">?</span> ETHARP_FLAG_TRY_HARD <span class="token operator">:</span> ETHARP_FLAG_FIND_ONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* now act on the message itself */</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>hdr<span class="token operator">-&gt;</span>opcode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* ARP request? */</span>
    <span class="token keyword">case</span> <span class="token function">PP_HTONS</span><span class="token punctuation">(</span>ARP_REQUEST<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token comment">/* ARP 请求包 */</span>
      <span class="token comment">/* ARP request. If it asked for our address, we send out a
       * reply. In any case, we time-stamp any existing ARP entry,
       * and possibly send out an IP packet that was queued on it. */</span>

      <span class="token function">LWIP_DEBUGF</span> <span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_input: incoming ARP request\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/* ARP request for our address? */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>for_us<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* 是请求自己的 */</span>
        <span class="token comment">/* send ARP response */</span> <span class="token comment">/* 做出回应 */</span>
        <span class="token function">etharp_raw</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> 
                   <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span><span class="token punctuation">)</span>netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hdr<span class="token operator">-&gt;</span>shwaddr<span class="token punctuation">,</span>
                   <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span><span class="token punctuation">)</span>netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">,</span> <span class="token function">netif_ip4_addr</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token operator">&amp;</span>hdr<span class="token operator">-&gt;</span>shwaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sipaddr<span class="token punctuation">,</span>
                   ARP_REPLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* we are not configured? */</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ip4_addr_isany_val</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token function">netif_ip4_addr</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* { for_us == 0 and netif-&gt;ip_addr.addr == 0 } */</span>
        <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_input: we are unconfigured, ARP request ignored.\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* request was not directed to us */</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* { for_us == 0 and netif-&gt;ip_addr.addr != 0 } */</span>
        <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_input: ARP request was not for us.\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token function">PP_HTONS</span><span class="token punctuation">(</span>ARP_REPLY<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token comment">/* 对于 ARP 应答包*/</span>
      <span class="token comment">/* ARP reply. We already updated the ARP cache earlier. */</span>
      <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_input: incoming ARP reply\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>LWIP_DHCP <span class="token operator">&amp;&amp;</span> DHCP_DOES_ARP_CHECK<span class="token punctuation">)</span></span></span>
      <span class="token comment">/* DHCP wants to know about ARP replies from any host with an
       * IP address also offered to us by the DHCP server. We do not
       * want to take a duplicate IP address on a single network.
       * @todo How should we handle redundant (fail-over) interfaces? */</span>
      <span class="token function">dhcp_arp_reply</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* (LWIP_DHCP &amp;&amp; DHCP_DOES_ARP_CHECK) */</span></span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_input: ARP unknown opcode type %"</span>S16_F<span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token function">lwip_htons</span><span class="token punctuation">(</span>hdr<span class="token operator">-&gt;</span>opcode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* free ARP packet */</span>
  <span class="token function">pbuf_free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="ARP_551"></a>更新ARP缓存表</h3> 
<p>etharp_update_arp_entry()函数是用于更新 ARP 缓存表的，它会在收到一个 ARP 数据包的时候被调用，它会先查找一个 ARP 表项，如果没有找到这个 ARP 表项的记录，就会去新建一个 ARP 表项，然后重置 ARP 表项的参数（状态、网卡。 IP 地址与对应的 MAC 地址以及生存时间等），然后检测 ARP 表项中是否挂载数据包，如果有就将这些数据包发送出去，其源码具体见代码</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * Update (or insert) a IP/MAC address pair in the ARP cache.
 *
 * If a pending entry is resolved, any queued packets will be sent
 * at this point.
 *
 * @param netif netif related to this entry (used for NETIF_ADDRHINT)
 * @param ipaddr IP address of the inserted ARP entry.  源IP地址
 * @param ethaddr Ethernet address of the inserted ARP entry.  源以太网MAC地址
 * @param flags See @ref etharp_state
 *
 * @return
 * - ERR_OK Successfully updated ARP cache.
 * - ERR_MEM If we could not add a new ARP entry when ETHARP_FLAG_TRY_HARD was set.
 * - ERR_ARG Non-unicast address given, those will not appear in ARP cache.
 *
 * @see pbuf_free()
 */</span>
<span class="token keyword">static</span> <span class="token class-name">err_t</span>
<span class="token function">etharp_update_arp_entry</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">ip4_addr_t</span> <span class="token operator">*</span>ipaddr<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span>ethaddr<span class="token punctuation">,</span> <span class="token class-name">u8_t</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">s16_t</span> i<span class="token punctuation">;</span>
  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"netif-&gt;hwaddr_len == ETH_HWADDR_LEN"</span><span class="token punctuation">,</span> netif<span class="token operator">-&gt;</span>hwaddr_len <span class="token operator">==</span> ETH_HWADDR_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_update_arp_entry: %"</span>U16_F<span class="token string">".%"</span>U16_F<span class="token string">".%"</span>U16_F<span class="token string">".%"</span>U16_F<span class="token string">" - %02"</span>X16_F<span class="token string">":%02"</span>X16_F<span class="token string">":%02"</span>X16_F<span class="token string">":%02"</span>X16_F<span class="token string">":%02"</span>X16_F<span class="token string">":%02"</span>X16_F<span class="token string">"\n"</span><span class="token punctuation">,</span>
              <span class="token function">ip4_addr1_16</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ip4_addr2_16</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ip4_addr3_16</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ip4_addr4_16</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token class-name">u16_t</span><span class="token punctuation">)</span>ethaddr<span class="token operator">-&gt;</span>addr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">u16_t</span><span class="token punctuation">)</span>ethaddr<span class="token operator">-&gt;</span>addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">u16_t</span><span class="token punctuation">)</span>ethaddr<span class="token operator">-&gt;</span>addr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token class-name">u16_t</span><span class="token punctuation">)</span>ethaddr<span class="token operator">-&gt;</span>addr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">u16_t</span><span class="token punctuation">)</span>ethaddr<span class="token operator">-&gt;</span>addr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">u16_t</span><span class="token punctuation">)</span>ethaddr<span class="token operator">-&gt;</span>addr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* non-unicast address? */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ip4_addr_isany</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token function">ip4_addr_isbroadcast</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">,</span> netif<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token function">ip4_addr_ismulticast</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_update_arp_entry: will not add non-unicast IP address to ARP cache\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ERR_ARG<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* find or create ARP entry */</span>
  <span class="token comment">/* 查找或者创建 ARP 表项，并且返回索引值 */</span>
  i <span class="token operator">=</span> <span class="token function">etharp_find_entry</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* bail out if no entry could be found */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">err_t</span><span class="token punctuation">)</span>i<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* mark it stable */</span>
    arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> ETHARP_STATE_STABLE<span class="token punctuation">;</span> <span class="token comment">/* 设置表项状态为 ETHARP_STATE_STABLE */</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* record network interface */</span>
  arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>netif <span class="token operator">=</span> netif<span class="token punctuation">;</span> <span class="token comment">/* 记录网卡 */</span>
  <span class="token comment">/* insert in SNMP ARP index tree */</span>
  <span class="token function">mib2_add_arp_entry</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 插入 ARP 索引树 */</span>

  <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_update_arp_entry: updating stable entry %"</span>S16_F<span class="token string">"\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* update address */</span>
  <span class="token function">SMEMCPY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ethaddr<span class="token punctuation">,</span> ethaddr<span class="token punctuation">,</span> ETH_HWADDR_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 更新缓存表中的 MAC 地址 */</span>
  <span class="token comment">/* reset time stamp */</span>
  arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ctime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* 重置生存时间 */</span>
  <span class="token comment">/* this is where we will send out queued packets! */</span>
  <span class="token comment">/* 如果表项上与未发送的数据包，那就将这些数据包发送出去 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ARP_QUEUEING</span></span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token comment">/* remember remainder of queue */</span>
    <span class="token keyword">struct</span> <span class="token class-name">etharp_q_entry</span> <span class="token operator">*</span>q <span class="token operator">=</span> arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q<span class="token punctuation">;</span> <span class="token comment">/* 定义 q 指向 ARP 表项中的数据包缓存队列 */</span>
    <span class="token comment">/* pop first item off the queue */</span>
    arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q <span class="token operator">=</span> q<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span> <span class="token comment">/* 指向下一个数据包节点 */</span>
    <span class="token comment">/* get the packet pointer */</span>
    p <span class="token operator">=</span> q<span class="token operator">-&gt;</span>p<span class="token punctuation">;</span> <span class="token comment">/* 获取 pbuf 数据包 */</span>
    <span class="token comment">/* now queue entry can be freed */</span>
    <span class="token function">memp_free</span><span class="token punctuation">(</span>MEMP_ARP_QUEUE<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 释放 MEMP_ARP_QUEUE 类型的内存块 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* ARP_QUEUEING */</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p <span class="token operator">=</span> arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q<span class="token punctuation">;</span>
    arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ARP_QUEUEING */</span></span>
    <span class="token comment">/* send the queued IP packet */</span> <span class="token comment">/* 发送缓存队列的数据包 */</span>
    <span class="token function">ethernet_output</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">)</span><span class="token punctuation">,</span> ethaddr<span class="token punctuation">,</span> ETHTYPE_IP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* free the queued IP packet */</span>
    <span class="token function">pbuf_free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ERR_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>表项的更新方式，动态表项有两种方式，分别为ETHARP_FLAG_TRY_HARD 和 ETHARP_FLAG_FIND_ONLY。 前者表示无论如何都要创建一个表项， 如果 ARP 缓存表中没有空间了， 那就需要回收较老的表项， 将他们删除， 然后建立新的表项。 而如果是后者， 就让内核尽量更新表项， 如果 ARP 缓存表中没有空间了，那么也无能为力，实在是添加不了新的表项。<br> <img src="https://images2.imgbox.com/a5/5f/zwdehA6j_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_639"></a>数据包发送流程</h3> 
<p>经过学习，我们知道一个数据包从底层传递进来的流程是怎么样的，如果是 ARP 数据包就会给 ARP 去处理，如果是 IP 数据报就使用 ip4_input()函数传递到上层。<br> 那么如果上层协议想要发送数据，也肯定需要经过 ARP 协议将 IP 地址映射为 MAC 地址才能完成发送操作， IP 数据报通过 ip4_output()函数将上层数据包传递到ARP 协议处理，关于 IP 协议是怎么样传递的我们暂且不说，那么 ARP 通过 etharp_output()函数接收到 IP 数据报后，就会进行发送， ARP 会先从数据包中进行分析，看看这个 IP 数据报是单播数据包还是多播或者是广播数据包，然后进行不同的处理：<br>  <strong>对于多播或者是广播数据包</strong>，这种处理就很简单，直接将数据包丢给网卡就行了（调用 ethernet_output()函数）。<br>  <strong>对于单播包</strong>的处理稍微麻烦一点， ARP 协议需要根据 IP 地址找到对应的 MAC 地址，然后才能正确发送，如果找不到 MAC 地址的话，还要延迟发送数据包，ARP 协议首先会创建一个 ARP 表项，然后将数据包挂到 ARP 表项对应的缓存队列上，与此同时会发出一个 ARP 请求包，等待目标主机的回应后再发送 IP 数据报。<br> 此处需要注意的是，对于 PBUFF_ERF、 PBUF_POOL、 PBUF_RAM 类型的数据包是不允许直接挂到 ARP 表项对应的缓存队列上的，因为此时内核需要等待目标主机的 ARP应答，而这段时间里，这些数据有可能会被上层改动，这是不允许的，所以 LwIP 需要将这些 pbuf 数据包拷贝到新的空间，等待发送。</p> 
<p><strong>etharp_output()函数</strong>被 IP 层的 ip4_output()函数调用， IP 层传递一个数据包到 ARP 中，etharp_output()会根据数据包的目标 IP 地址选择不同的处理，其源码具体见代码</p> 
<pre><code class="prism language-c"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> ethbroadcast <span class="token operator">=</span>
 <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

 <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> ethzero <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

 <span class="token comment">/** 24 位 IANA IPv4 多播 OUI 为 01-00-5e： */</span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LL_IP4_MULTICAST_ADDR_0</span> <span class="token expression"><span class="token number">0x01</span></span></span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LL_IP4_MULTICAST_ADDR_1</span> <span class="token expression"><span class="token number">0x00</span></span></span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LL_IP4_MULTICAST_ADDR_2</span> <span class="token expression"><span class="token number">0x5e</span></span></span>
<span class="token comment">/**
 * Resolve and fill-in Ethernet address header for outgoing IP packet.
 *
 * For IP multicast and broadcast, corresponding Ethernet addresses
 * are selected and the packet is transmitted on the link.
 *
 * For unicast addresses, the packet is submitted to etharp_query(). In
 * case the IP address is outside the local network, the IP address of
 * the gateway is used.
 *
 * @param netif The lwIP network interface which the IP packet will be sent on.
 * @param q The pbuf(s) containing the IP packet to be sent.  将要发送的数据包
 * @param ipaddr The IP address of the packet destination. 要发送的目的IP地址
 *
 * @return
 * - ERR_RTE No route to destination (no gateway to external networks),
 * or the return type of either etharp_query() or ethernet_output().
 */</span>
<span class="token class-name">err_t</span>
<span class="token function">etharp_output</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>q<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">ip4_addr_t</span> <span class="token operator">*</span>ipaddr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span>dest<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> mcastaddr<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token class-name">ip4_addr_t</span> <span class="token operator">*</span>dst_addr <span class="token operator">=</span> ipaddr<span class="token punctuation">;</span>

  <span class="token function">LWIP_ASSERT_CORE_LOCKED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"netif != NULL"</span><span class="token punctuation">,</span> netif <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"q != NULL"</span><span class="token punctuation">,</span> q <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"ipaddr != NULL"</span><span class="token punctuation">,</span> ipaddr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Determine on destination hardware address. Broadcasts and multicasts
   * are special, other IP addresses are looked up in the ARP table. */</span>

  <span class="token comment">/* broadcast destination IP address? */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ip4_addr_isbroadcast</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">,</span> netif<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* broadcast on Ethernet also */</span>
    dest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ethbroadcast<span class="token punctuation">;</span> <span class="token comment">/* 如果是广播数据包，目标 MAC 地址设置为 FF-FF-FF-FF-FF-FF-FF */</span>
    <span class="token comment">/* multicast destination IP address? */</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ip4_addr_ismulticast</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Hash IP multicast address to MAC address.*/</span>
    <span class="token comment">/* 如果是多播数据包，目标 MAC 地址设置为多播地址： 01-00-5E-XX-XX-XX*/</span>
    mcastaddr<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> LL_IP4_MULTICAST_ADDR_0<span class="token punctuation">;</span>
    mcastaddr<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> LL_IP4_MULTICAST_ADDR_1<span class="token punctuation">;</span>
    mcastaddr<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> LL_IP4_MULTICAST_ADDR_2<span class="token punctuation">;</span>
    mcastaddr<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ip4_addr2</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x7f</span><span class="token punctuation">;</span>
    mcastaddr<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ip4_addr3</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mcastaddr<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ip4_addr4</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* destination Ethernet address is multicast */</span>
    dest <span class="token operator">=</span> <span class="token operator">&amp;</span>mcastaddr<span class="token punctuation">;</span>
    <span class="token comment">/* unicast destination IP address? */</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">netif_addr_idx_t</span> i<span class="token punctuation">;</span> <span class="token comment">/* 如果是单播目标地 IP 地址 */</span>
    <span class="token comment">/* outside local network? if so, this can neither be a global broadcast nor
       a subnet broadcast. */</span>
       <span class="token comment">/* 判断目标 IP 地址是否与主机处于同一子网上，如果不是，则修改 IP 地址 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ip4_addr_netcmp</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">,</span> <span class="token function">netif_ip4_addr</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">netif_ip4_netmask</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token function">ip4_addr_islinklocal</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token comment">/* interface has default gateway? */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ip4_addr_isany_val</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token function">netif_ip4_gw</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* 判断一下网关地址是否有效 */</span>
            <span class="token comment">/* send to hardware address of default gateway IP address */</span>
            dst_addr <span class="token operator">=</span> <span class="token function">netif_ip4_gw</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 发送到默认网关，让网关进行转发 */</span>
            <span class="token comment">/* no default gateway available */</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* no route to destination error (default gateway missing) */</span>
            <span class="token keyword">return</span> ERR_RTE<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_HWADDRHINT</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>hints <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* per-pcb cached entry was given */</span>
      <span class="token class-name">netif_addr_idx_t</span> etharp_cached_entry <span class="token operator">=</span> netif<span class="token operator">-&gt;</span>hints<span class="token operator">-&gt;</span>addr_hint<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>etharp_cached_entry <span class="token operator">&lt;</span> ARP_TABLE_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_HWADDRHINT */</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>etharp_cached_entry<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">&gt;=</span> ETHARP_STATE_STABLE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ETHARP_TABLE_MATCH_NETIF</span></span>
            <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>etharp_cached_entry<span class="token punctuation">]</span><span class="token punctuation">.</span>netif <span class="token operator">==</span> netif<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            <span class="token punctuation">(</span><span class="token function">ip4_addr_cmp</span><span class="token punctuation">(</span>dst_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arp_table<span class="token punctuation">[</span>etharp_cached_entry<span class="token punctuation">]</span><span class="token punctuation">.</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">/* the per-pcb-cached entry is stable and the right one! */</span>
          <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>cachehit<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token function">etharp_output_to_arp_index</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> q<span class="token punctuation">,</span> etharp_cached_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_HWADDRHINT</span></span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_NETIF_HWADDRHINT */</span></span>

    <span class="token comment">/* find stable entry: do this here since this is a critical path for
       throughput and etharp_find_entry() is kind of slow */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ARP_TABLE_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* 遍历 ARP 缓存表 */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">&gt;=</span> ETHARP_STATE_STABLE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ETHARP_TABLE_MATCH_NETIF</span></span>
          <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>netif <span class="token operator">==</span> netif<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
          <span class="token punctuation">(</span><span class="token function">ip4_addr_cmp</span><span class="token punctuation">(</span>dst_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* found an existing, stable entry */</span>
        <span class="token function">ETHARP_SET_ADDRHINT</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">etharp_output_to_arp_index</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> q<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 如果找到目标 IP 地址对应的表项，直接发送 */</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* no stable entry found, use the (slower) query function:
       queue on destination Ethernet address belonging to ipaddr */</span>
    <span class="token keyword">return</span> <span class="token function">etharp_query</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> dst_addr<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 如果没有找到与目标 IP 地址对应的 ARP 表项 */</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* continuation for multicast/broadcast destinations */</span>
  <span class="token comment">/* obtain source Ethernet address of the given interface */</span>
  <span class="token comment">/* send packet directly on the link */</span>
  <span class="token comment">/* 对于多播、广播数据包，直接能得到对应的 MAC 地址，可以进行发送*/</span>
  <span class="token keyword">return</span> <span class="token function">ethernet_output</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> q<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">)</span><span class="token punctuation">,</span> dest<span class="token punctuation">,</span> ETHTYPE_IP<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个函数是 ARP 找到了 IP 地址与 MAC 地址对应的表项，从而能直接进行发送，除此之外， ARP 还需要更新 ARP 表项，我们知道， LwIP 中的 ARP 表项生存时间是 5 分钟（300 秒），那么在 APP 表项的生存时间即将到来的时候， ARP 需要更新表项，为什么要在发送数据的时候更新呢？因为如果不发送数据，那就没必要更新 ARP 表项，这样子表项在生存时间到来的时候就会被系统删除，回收 ARP 表项空间，而一直使用的 ARP 表项需要是谁更新，更新的方式也有两种：<br> 如果 ARP 表项还差 15 秒就过期了， LwIP 会通过广播的方式发送一个 ARP 请求包，试图得到主机的回应。<br> 而如果 ARP 表项还差 30 秒就过期了，那么 LwIP 会通过单播的方式向目标主机发送一个请求包并试图得到回应。<br> 在这种情况下发送 ARP 请求包的时候，表项的状态会由 ETHARP_STATE_STABLE变成 ETHARP_STATE_STABLE_REREQUESTING_1， 如果目标主机回应了，那就更新ARP 缓存表中的表项。<br> 当然，如果还没那么快到期的话，那就直接调用 ethernet_output()函数将数据包传递给网卡进行发送。 函数源码具体见代码</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ARP_MAXAGE</span> <span class="token expression"><span class="token number">300</span></span></span>

 <span class="token comment">/* 即将到期的时间 */</span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ARP_AGE_REREQUEST_USED_UNICAST</span> <span class="token expression"><span class="token punctuation">(</span>ARP_MAXAGE <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">)</span></span></span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ARP_AGE_REREQUEST_USED_BROADCAST</span> <span class="token expression"><span class="token punctuation">(</span>ARP_MAXAGE <span class="token operator">-</span> <span class="token number">15</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/** Just a small helper function that sends a pbuf to an ethernet address
 * in the arp_table specified by the index 'arp_idx'.
 */</span>
<span class="token keyword">static</span> <span class="token class-name">err_t</span>
<span class="token function">etharp_output_to_arp_index</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>q<span class="token punctuation">,</span> <span class="token class-name">netif_addr_idx_t</span> arp_idx<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"arp_table[arp_idx].state &gt;= ETHARP_STATE_STABLE"</span><span class="token punctuation">,</span>
              arp_table<span class="token punctuation">[</span>arp_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">&gt;=</span> ETHARP_STATE_STABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* if arp table entry is about to expire: re-request it,
     but only if its state is ETHARP_STATE_STABLE to prevent flooding the
     network with ARP requests if this address is used frequently. */</span>
     <span class="token comment">/* 如果 arp 表项即将过期： LwIP 会重新请求它，但只有当它的状态是 ETHARP_STATE_STABLE 才能请求*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>arp_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_STABLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>arp_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>ctime <span class="token operator">&gt;=</span> ARP_AGE_REREQUEST_USED_BROADCAST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">/* 还差 15 秒到期 */</span>
      <span class="token comment">/* issue a standard request using broadcast */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">etharp_request</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arp_table<span class="token punctuation">[</span>arp_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>ipaddr<span class="token punctuation">)</span> <span class="token operator">==</span> ERR_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* 使用广播方式发出请求包 */</span>
        arp_table<span class="token punctuation">[</span>arp_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> ETHARP_STATE_STABLE_REREQUESTING_1<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>arp_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>ctime <span class="token operator">&gt;=</span> ARP_AGE_REREQUEST_USED_UNICAST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* 还差 30 秒到期 */</span>
      <span class="token comment">/* issue a unicast request (for 15 seconds) to prevent unnecessary broadcast */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">etharp_request_dst</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arp_table<span class="token punctuation">[</span>arp_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>ipaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arp_table<span class="token punctuation">[</span>arp_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>ethaddr<span class="token punctuation">)</span> <span class="token operator">==</span> ERR_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* 发出单播请求（持续 15 秒），以防止不必要的广播 */</span>
        arp_table<span class="token punctuation">[</span>arp_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> ETHARP_STATE_STABLE_REREQUESTING_1<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">ethernet_output</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> q<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>arp_table<span class="token punctuation">[</span>arp_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>ethaddr<span class="token punctuation">,</span> ETHTYPE_IP<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="etharp_query_815"></a>etharp_query()函数</h3> 
<p>如果在 ARP 缓存表中没有找到目标 IP 地址对应的表项， 那么 ARP 协议就会创建一个表项， 这也是 ARP 协议的核心处理， 对于刚创建的表项， 它在初始化网卡信息后会被设置为 ETHARP_STATE_PENDING 状态，与此同时一个 ARP 请求包将被广播出去， 这个时候的表项是无法发送数据的，只有等待到目标主机回应了一个 ARP 应答包才能发送数据，那么这些数据在这段时间中将被挂到表项的等待队列上，在 ARP 表项处于ETHARP_STATE_STABLE 状态完成数据的发送，函数源码具体见代码</p> 
<pre><code class="prism language-c"><span class="token class-name">err_t</span>
<span class="token function">etharp_query</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">ip4_addr_t</span> <span class="token operator">*</span>ipaddr<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>q<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span>srcaddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> <span class="token operator">*</span><span class="token punctuation">)</span>netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">;</span>
  <span class="token class-name">err_t</span> result <span class="token operator">=</span> ERR_MEM<span class="token punctuation">;</span>
  <span class="token keyword">int</span> is_new_entry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token class-name">s16_t</span> i_err<span class="token punctuation">;</span>
  <span class="token class-name">netif_addr_idx_t</span> i<span class="token punctuation">;</span>

  <span class="token comment">/* non-unicast address? */</span> <span class="token comment">/* 检是否为单播地址 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ip4_addr_isbroadcast</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">,</span> netif<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token function">ip4_addr_ismulticast</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token function">ip4_addr_isany</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_query: will not add non-unicast IP address to ARP cache\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ERR_ARG<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* find entry in ARP cache, ask to create entry if queueing packet */</span>
  <span class="token comment">/* 在 ARP 缓存中查找表项，如果没有则尝试创建表项 */</span>
  i_err <span class="token operator">=</span> <span class="token function">etharp_find_entry</span><span class="token punctuation">(</span>ipaddr<span class="token punctuation">,</span> ETHARP_FLAG_TRY_HARD<span class="token punctuation">,</span> netif<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* could not find or create entry? */</span>
  <span class="token comment">/* 没有发现表项或者没有创建表项成功 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>i_err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_query: could not create ARP entry\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_query: packet dropped\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>memerr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">err_t</span><span class="token punctuation">)</span>i_err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"type overflow"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>i_err <span class="token operator">&lt;</span> NETIF_ADDR_IDX_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//找到对应的表项或者创建表项成功</span>
  i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">netif_addr_idx_t</span><span class="token punctuation">)</span>i_err<span class="token punctuation">;</span>

  <span class="token comment">/* mark a fresh entry as pending (we just sent a request) */</span>
  <span class="token comment">/* 将新表项标记为待处理 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_EMPTY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    is_new_entry <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> ETHARP_STATE_PENDING<span class="token punctuation">;</span> 
    <span class="token comment">/* record network interface for re-sending arp request in etharp_tmr */</span>
    arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>netif <span class="token operator">=</span> netif<span class="token punctuation">;</span> <span class="token comment">/* 记录网络接口 */</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* { i is either a STABLE or (new or existing) PENDING entry } */</span>
  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"arp_table[i].state == PENDING or STABLE"</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_PENDING<span class="token punctuation">)</span> <span class="token operator">||</span>
               <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">&gt;=</span> ETHARP_STATE_STABLE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* do we have a new entry? or an implicit query request? */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>is_new_entry <span class="token operator">||</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">/* 是否有新的表项 */</span>
    <span class="token comment">/* try to resolve it; send out ARP request */</span>
    result <span class="token operator">=</span> <span class="token function">etharp_request</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> ipaddr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 发送 ARP 请求包*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> ERR_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">/* 无法发送 ARP 请求 */</span>
      <span class="token comment">/* ARP request couldn't be sent */</span>
      <span class="token comment">/* We don't re-send arp request in etharp_tmr, but we still queue packets,
         since this failure could be temporary, and the next packet calling
         etharp_query again could lead to sending the queued packets. */</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* packet given? */</span>
  <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"q != NULL"</span><span class="token punctuation">,</span> q <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* stable entry? */</span> <span class="token comment">/* 表项状态是否稳定 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">&gt;=</span> ETHARP_STATE_STABLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* we have a valid IP-&gt;Ethernet address mapping */</span>
    <span class="token function">ETHARP_SET_ADDRHINT</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* send the packet */</span><span class="token comment">/* 发送数据包 */</span>
    result <span class="token operator">=</span> <span class="token function">ethernet_output</span><span class="token punctuation">(</span>netif<span class="token punctuation">,</span> q<span class="token punctuation">,</span> srcaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ethaddr<span class="token punctuation">)</span><span class="token punctuation">,</span> ETHTYPE_IP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* pending entry? (either just created or already pending */</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ETHARP_STATE_PENDING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* 如果表项是 ETHARP_STATE_PENDING 状态 */</span>
    <span class="token comment">/* entry is still pending, queue the given packet 'q' */</span>
    <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">;</span> <span class="token comment">/* 将给数据包'q'排队 */</span>
    <span class="token keyword">int</span> copy_needed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/* IF q includes a pbuf that must be copied, copy the whole chain into a
     * new PBUF_RAM. See the definition of PBUF_NEEDS_COPY for details. */</span>
    p <span class="token operator">=</span> q<span class="token punctuation">;</span> <span class="token comment">/* 如果 q 包含必须拷贝的 pbuf，请将整个链复制到一个新的 PBUF_RAM */</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"no packet queues allowed!"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>len <span class="token operator">!=</span> p<span class="token operator">-&gt;</span>tot_len<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>next <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PBUF_NEEDS_COPY</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        copy_needed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//需要拷贝</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>copy_needed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* copy the whole packet into new pbufs */</span>
      p <span class="token operator">=</span> <span class="token function">pbuf_clone</span><span class="token punctuation">(</span>PBUF_LINK<span class="token punctuation">,</span> PBUF_RAM<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 将整个数据包复制到新的 pbuf 中 */</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* referencing the old pbuf is enough */</span>
      p <span class="token operator">=</span> q<span class="token punctuation">;</span>
      <span class="token function">pbuf_ref</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 引用旧的 pbuf 就足够了 */</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* packet could be taken over? */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* queue packet ... */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ARP_QUEUEING</span></span>
      <span class="token keyword">struct</span> <span class="token class-name">etharp_q_entry</span> <span class="token operator">*</span>new_entry<span class="token punctuation">;</span>
      <span class="token comment">/* allocate a new arp queue entry */</span><span class="token comment">/* 如果使用队列 */</span>
      new_entry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">etharp_q_entry</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">memp_malloc</span><span class="token punctuation">(</span>MEMP_ARP_QUEUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 分配一个新的 arp 队列表项 */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>new_entry <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> qlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        new_entry<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        new_entry<span class="token operator">-&gt;</span>p <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* 队列已经存在，将新数据包插入队列后面 */</span>
          <span class="token comment">/* queue was already existent, append the new entry to the end */</span>
          <span class="token keyword">struct</span> <span class="token class-name">etharp_q_entry</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>
          r <span class="token operator">=</span> arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q<span class="token punctuation">;</span>
          qlen<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>next <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r <span class="token operator">=</span> r<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
            qlen<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          r<span class="token operator">-&gt;</span>next <span class="token operator">=</span> new_entry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">/* queue did not exist, first item in queue */</span>
          arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q <span class="token operator">=</span> new_entry<span class="token punctuation">;</span> <span class="token comment">/* 队列不存在，数据包就是队列的第一个节点 */</span>
        <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ARP_QUEUE_LEN</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>qlen <span class="token operator">&gt;=</span> ARP_QUEUE_LEN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">struct</span> <span class="token class-name">etharp_q_entry</span> <span class="token operator">*</span>old<span class="token punctuation">;</span>
          old <span class="token operator">=</span> arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q<span class="token punctuation">;</span>
          arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q <span class="token operator">=</span> arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
          <span class="token function">pbuf_free</span><span class="token punctuation">(</span>old<span class="token operator">-&gt;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">memp_free</span><span class="token punctuation">(</span>MEMP_ARP_QUEUE<span class="token punctuation">,</span> old<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_query: queued packet %p on ARP entry %"</span>U16_F<span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>q<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> ERR_OK<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* the pool MEMP_ARP_QUEUE is empty */</span>
        <span class="token function">pbuf_free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_query: could not queue a copy of PBUF_REF packet %p (out of memory)\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> ERR_MEM<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* ARP_QUEUEING */</span></span>
      <span class="token comment">/* always queue one packet per ARP request only, freeing a previously queued packet */</span>
      <span class="token comment">/* 如果只是挂载单个数据包，那么始终只为每个 ARP 请求排队一个数据包，就需要释放先前排队的数据包 */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_query: dropped previously queued packet %p for ARP entry %"</span>U16_F<span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>q<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">u16_t</span><span class="token punctuation">)</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pbuf_free</span><span class="token punctuation">(</span>arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      arp_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>q <span class="token operator">=</span> p<span class="token punctuation">;</span>
      result <span class="token operator">=</span> ERR_OK<span class="token punctuation">;</span>
      <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_query: queued packet %p on ARP entry %"</span>U16_F<span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>q<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">u16_t</span><span class="token punctuation">)</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ARP_QUEUEING */</span></span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">ETHARP_STATS_INC</span><span class="token punctuation">(</span>etharp<span class="token punctuation">.</span>memerr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>ETHARP_DEBUG <span class="token operator">|</span> LWIP_DBG_TRACE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"etharp_query: could not queue a copy of PBUF_REF packet %p (out of memory)\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> ERR_MEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/eb/28/CnT2J5fN_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c0/45/RzpjwgVx_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/990f6ca8d57c28c446f635f2caa0bbbf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mysql慢查询</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1eee9c1b73bc9a77e14320521df77777/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">百余行VUE代码实现贪吃蛇小游戏简易版</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>