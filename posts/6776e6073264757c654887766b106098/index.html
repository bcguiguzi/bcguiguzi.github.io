<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用rollup打包ts&#43;react缓存组件发布npm - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用rollup打包ts&#43;react缓存组件发布npm" />
<meta property="og:description" content="新建一个项目目录比如叫root,下面新建一个rollup的配置文件: rollup.config.ts 因为rollup良好支持ts和esmodule 所以用ts配置文件
Setup 生成一个package.json文件,这里用pnpm生成:
pnpm init 安装rollup和Typescript:
pnpm add rollup pnpm add typescript 配置package.json的pnpm build命令:
{ &#34;scripts&#34;: { &#34;build&#34;: &#34;rollup --c --configPlugin typescript2 --bundleConfigAsCjs&#34;, &#34;build:dev&#34;: &#34;cross-env NODE_ENV=development pnpm build&#34;, &#34;build:prod&#34;: &#34;cross-env NODE_ENV=production pnpm build&#34; }, &#34;type&#34;: &#34;module&#34; } rollup是跑在node环境的,node的模块化是commonjs不支持esmodule的 所以要在package.json的运行脚本里配置一个rollup命令–bundleConfigAsCjs将esmodule代码解析成commonjs让nodejs能够认识 然后package.json还要加上type:module支持esmodule
build命令解释:
–c是指定rollup读取项目根目录下的rollup.config配置文件进行构建–configPlugin是指定rollup构建时要使用的插件 包括对rollup配置文件的处理 这里指定用typescript2这个插件来处理ts的配置文件 防止rollup配置文件读取报错–bundleConfigAsCjs是rollup的一个命令用来将esmodule转换成commonjs便于node环境中使用cross-env是一个插件用来抹平不同操作系统中设置环境变量的方式,不同操作系统环境变量设置方式是不一样的 我们不能一个个去弄 所以用来实现跨平台的设置环境变量build:dev和build:prod用来根据获取环境变量注入的值process.env.NODE_ENV来做不同的操作type:module也是配置支持esmodule的一步 要加上 rollup.config.ts配置文件 文件要求导出一个RollupOptions对象/RollupOptions[]对象数组 一个对象就是一个文件的打包配置 要打包多少就多少个配置对象 这里我就指定一个入口文件对外暴露三个接口就行 rollup会根据入口文件的导入引用去查找文件进行构建
rollup配置文件配置:
import nodeResolve from &#39;@rollup/plugin-node-resolve&#39; import typescript2 from &#39;rollup-plugin-typescript2&#39; // @ts-ignore import babel from &#39;rollup-plugin-babel&#39; import commonjs from &#39;@rollup/plugin-commonjs&#39; import { join, resolve } from &#39;path&#39; import { readdir } from &#39;fs/promises&#39; import { RollupOptions, defineConfig } from &#39;rollup&#39; import { IOptions } from &#39;rollup-plugin-typescript2/dist/ioptions&#39; import { existsSync } from &#39;fs&#39; import { unlink, rmdir, lstat } from &#39;fs/promises&#39; const commonPlugins = [ nodeResolve({ extensions: [&#39;." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/6776e6073264757c654887766b106098/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-05T19:31:50+08:00" />
<meta property="article:modified_time" content="2023-05-05T19:31:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用rollup打包ts&#43;react缓存组件发布npm</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>新建一个项目目录比如叫root,下面新建一个rollup的配置文件: rollup.config.ts 因为rollup良好支持ts和esmodule 所以用ts配置文件</p> 
<h2><a id="Setup_2"></a>Setup</h2> 
<p>生成一个package.json文件,这里用pnpm生成:</p> 
<pre><code class="prism language-bash"><span class="token function">pnpm</span> init
</code></pre> 
<p>安装rollup和Typescript:</p> 
<pre><code class="prism language-bash"><span class="token function">pnpm</span> <span class="token function">add</span> rollup
<span class="token function">pnpm</span> <span class="token function">add</span> typescript
</code></pre> 
<p>配置package.json的pnpm build命令:</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"build"</span><span class="token operator">:</span> <span class="token string">"rollup --c --configPlugin typescript2 --bundleConfigAsCjs"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"build:dev"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=development pnpm build"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"build:prod"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=production pnpm build"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"module"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>rollup是跑在node环境的,node的模块化是commonjs不支持esmodule的 所以要在package.json的运行脚本里配置一个rollup命令–bundleConfigAsCjs将esmodule代码解析成commonjs让nodejs能够认识 然后package.json还要加上type:module支持esmodule</p> 
<p>build命令解释:</p> 
<ol><li>–c是指定rollup读取项目根目录下的rollup.config配置文件进行构建</li><li>–configPlugin是指定rollup构建时要使用的插件 包括对rollup配置文件的处理 这里指定用typescript2这个插件来处理ts的配置文件 防止rollup配置文件读取报错</li><li>–bundleConfigAsCjs是rollup的一个命令用来将esmodule转换成commonjs便于node环境中使用</li><li>cross-env是一个插件用来抹平不同操作系统中设置环境变量的方式,不同操作系统环境变量设置方式是不一样的 我们不能一个个去弄 所以用来实现跨平台的设置环境变量</li><li>build:dev和build:prod用来根据获取环境变量注入的值process.env.NODE_ENV来做不同的操作</li><li>type:module也是配置支持esmodule的一步 要加上</li></ol> 
<h2><a id="rollupconfigts_35"></a>rollup.config.ts配置文件</h2> 
<p>文件要求导出一个RollupOptions对象/RollupOptions[]对象数组 一个对象就是一个文件的打包配置 要打包多少就多少个配置对象 这里我就指定一个入口文件对外暴露三个接口就行 rollup会根据入口文件的导入引用去查找文件进行构建<br> rollup配置文件配置:</p> 
<pre><code class="prism language-typescript"><span class="token keyword">import</span> nodeResolve <span class="token keyword">from</span> <span class="token string">'@rollup/plugin-node-resolve'</span>
<span class="token keyword">import</span> typescript2 <span class="token keyword">from</span> <span class="token string">'rollup-plugin-typescript2'</span>
<span class="token comment">// @ts-ignore</span>
<span class="token keyword">import</span> babel <span class="token keyword">from</span> <span class="token string">'rollup-plugin-babel'</span>
<span class="token keyword">import</span> commonjs <span class="token keyword">from</span> <span class="token string">'@rollup/plugin-commonjs'</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> join<span class="token punctuation">,</span> resolve <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> readdir <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'fs/promises'</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> RollupOptions<span class="token punctuation">,</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rollup'</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> IOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rollup-plugin-typescript2/dist/ioptions'</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> existsSync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'fs'</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> unlink<span class="token punctuation">,</span> rmdir<span class="token punctuation">,</span> lstat <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'fs/promises'</span>
<span class="token keyword">const</span> commonPlugins <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token function">nodeResolve</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.ts'</span><span class="token punctuation">,</span> <span class="token string">'.tsx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 告诉node要解析的文件扩展名</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">typescript2</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    tsConfig<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'tsconfig.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 指定ts配置文件位置</span>
    <span class="token comment">// useTsconfigDeclarationDir: true, // 使用配置文件里的DeclarationDir 不开启默认强制生成在和文件同级目录同名文件</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> Partial<span class="token operator">&lt;</span>IOptions<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    babelrc<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 使用.babelrc配置文件</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">commonjs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 这个插件比如加 用来转换成commonjs 然后注入react17新的jsx组件转换函数_JSX react17+不再用createElement 不用这个插件只用babel处理会报错</span>
<span class="token punctuation">]</span>
<span class="token comment">/**
 * @description 根据路径删除目录
 * @param dirs 删除的目录路径
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">removeDir</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token operator">...</span>dirs<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dir <span class="token keyword">of</span> dirs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> absolutePath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> dir<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">existsSync</span><span class="token punctuation">(</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> dirStack <span class="token operator">=</span> <span class="token punctuation">[</span>absolutePath<span class="token punctuation">]</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>dirStack<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> initPath <span class="token operator">=</span> dirStack<span class="token punctuation">[</span>dirStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">const</span> fileStat <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">lstat</span><span class="token punctuation">(</span>initPath<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fileStat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readdir</span><span class="token punctuation">(</span>initPath<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>files<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            dirStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">join</span><span class="token punctuation">(</span>initPath<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">await</span> <span class="token function">rmdir</span><span class="token punctuation">(</span>initPath<span class="token punctuation">)</span>
            dirStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fileStat<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">await</span> <span class="token function">unlink</span><span class="token punctuation">(</span>initPath<span class="token punctuation">)</span>
          dirStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">resolveRollupOptions</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> results<span class="token operator">:</span> RollupOptions<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> dirStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>dirStack<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> initPath <span class="token operator">=</span> dirStack<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span>
    <span class="token keyword">const</span> fileStat <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">lstat</span><span class="token punctuation">(</span>initPath<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fileStat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readdir</span><span class="token punctuation">(</span>initPath<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>files<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        dirStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">join</span><span class="token punctuation">(</span>initPath<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fileStat<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> rollupOption<span class="token operator">:</span> RollupOptions <span class="token operator">=</span>
        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span>
          <span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
              input<span class="token operator">:</span> initPath<span class="token punctuation">,</span>
              treeshake<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              external<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token string">'react-dom'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              output<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                file<span class="token operator">:</span> initPath
                  <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">src</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'lib'</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(tsx|ts)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                format<span class="token operator">:</span> <span class="token string">'esm'</span><span class="token punctuation">,</span>
                sourcemap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              plugins<span class="token operator">:</span> commonPlugins<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
          <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              input<span class="token operator">:</span> initPath<span class="token punctuation">,</span>
              treeshake<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              external<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token string">'react-dom'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              output<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                file<span class="token operator">:</span> initPath
                  <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">src</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'lib'</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(tsx|ts)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                format<span class="token operator">:</span> <span class="token string">'esm'</span><span class="token punctuation">,</span>
                sourcemap<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>commonPlugins<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
      results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>rollupOption<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> results
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token comment">/* commandLineArgs */</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 每次构建前先删除上一次的产物</span>
  <span class="token keyword">await</span> <span class="token function">removeDir</span><span class="token punctuation">(</span><span class="token string">'es'</span><span class="token punctuation">,</span> <span class="token string">'lib'</span><span class="token punctuation">)</span>
  <span class="token comment">// 生成两个产物 一个esmodule模块 一个umd通用模块</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      input<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'src/index.ts'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 指定入口文件</span>
      treeshake<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启treeshaking</span>
      external<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token string">'react-dom'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 第三方库使用外部依赖</span>
      output<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        name<span class="token operator">:</span> <span class="token string">'ReactAlive'</span><span class="token punctuation">,</span> <span class="token comment">// 这个name用于打包成umd/iife模块时模块挂到全局对象上的key</span>
        file<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'es/index.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 构建的产物输出位置和文件名</span>
        format<span class="token operator">:</span> <span class="token string">'esm'</span><span class="token punctuation">,</span> <span class="token comment">// 构建产物的模块化类型</span>
        sourcemap<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 关闭sourcemap</span>
        <span class="token comment">// 指定被排除掉的外部依赖在全局对象上的key</span>
        globals<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          react<span class="token operator">:</span> <span class="token string">'React'</span><span class="token punctuation">,</span>
          <span class="token string-property property">'react-dom'</span><span class="token operator">:</span> <span class="token string">'ReactDOM'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      plugins<span class="token operator">:</span> commonPlugins<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      input<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'src/index.ts'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      treeshake<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      external<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token string">'react-dom'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      output<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        name<span class="token operator">:</span> <span class="token string">'ReactAlive'</span><span class="token punctuation">,</span>
        file<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'lib/index.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
        sourcemap<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        globals<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          react<span class="token operator">:</span> <span class="token string">'React'</span><span class="token punctuation">,</span>
          <span class="token string-property property">'react-dom'</span><span class="token operator">:</span> <span class="token string">'ReactDOM'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      plugins<span class="token operator">:</span> commonPlugins<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span> <span class="token keyword">as</span> RollupOptions<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>root/src/index.ts:入口文件声明好这个库要对外暴露的接口:</p> 
<pre><code class="prism language-typescript"><span class="token keyword">import</span> KeepAliveScope <span class="token keyword">from</span> <span class="token string">'./components/keepalive-scope'</span>
<span class="token keyword">import</span> KeepAliveItem<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> useCacheDestroy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./components/keepalive-item'</span>
<span class="token keyword">export</span> <span class="token punctuation">{<!-- --></span> KeepAliveItem<span class="token punctuation">,</span> KeepAliveScope<span class="token punctuation">,</span> useCacheDestroy <span class="token punctuation">}</span>
</code></pre> 
<p>root/global.d.ts:为process.env.NODE_ENV提供类型声明 这样就有代码提示了:</p> 
<pre><code class="prism language-typescript"><span class="token keyword">declare</span> <span class="token keyword">namespace</span> NodeJS <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">interface</span> <span class="token class-name">ProcessEnv</span> <span class="token punctuation">{<!-- --></span>
    <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">'development'</span> <span class="token operator">|</span> <span class="token string">'production'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>root/tsconfig.json:</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"target"</span><span class="token operator">:</span> <span class="token string">"ESNext"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"lib"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"DOM"</span><span class="token punctuation">,</span> <span class="token string">"DOM.Iterable"</span><span class="token punctuation">,</span> <span class="token string">"ESNext"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"allowJs"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string-property property">"skipLibCheck"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 跳过第三方库类型声明文件的检查</span>
    <span class="token string-property property">"esModuleInterop"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启将esm代码编译成cjs</span>
    <span class="token string-property property">"allowSyntheticDefaultImports"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 启用默认导出 .default访问默认导出的module.exports内容</span>
    <span class="token string-property property">"strict"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string-property property">"forceConsistentCasingInFileNames"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string-property property">"module"</span><span class="token operator">:</span> <span class="token string">"ESNext"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sourceMap"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string-property property">"moduleResolution"</span><span class="token operator">:</span> <span class="token string">"node"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"resolveJsonModule"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string-property property">"isolatedModules"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string-property property">"noEmit"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string-property property">"types"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"node"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"experimentalDecorators"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启装饰器语法</span>
    <span class="token string-property property">"jsx"</span><span class="token operator">:</span> <span class="token string">"react-jsx"</span><span class="token punctuation">,</span> <span class="token comment">// react17+这里可以改成react-jsx 17+后会自动引入一个编译jsx函数 配置babel的automatic</span>
    <span class="token string-property property">"baseUrl"</span><span class="token operator">:</span> <span class="token string">"."</span><span class="token punctuation">,</span>
    <span class="token comment">// "paths": {<!-- --></span>
    <span class="token comment">//   "@/*": ["src/*"]</span>
    <span class="token comment">// },</span>
    <span class="token string-property property">"declaration"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 是否生成类型声明文件</span>
    <span class="token comment">// "declarationDir": "lib/types" // 类型声明文件默认生成在对应ts文件同级目录 指定一个目录统一生成</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"exclude"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"node_modules"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"include"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>root/.babelrc:给babel插件提供配置:</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"presets"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"@babel/preset-env"</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      <span class="token string">"@babel/preset-react"</span><span class="token punctuation">,</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"runtime"</span><span class="token operator">:</span> <span class="token string">"automatic"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"extensions"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">".ts"</span><span class="token punctuation">,</span> <span class="token string">".tsx"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"include"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"exclude"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"node_modules"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>.babelrc文件解释:</p> 
<ol><li>@babel/preset-env:babel根据我们环境的不同来调整babel的自身配置的预设</li><li>@babel/preset-react:babel用于在react项目环境中调整自己的配置的预设 用来转换jsx propstype检查之类的 预设里的配置项runtime:automatic是指运行时自动在react组件里注入jsx的转换函数 react17之前我们需要在组件开头导入React才能用React对象上的createElement创建组件 v17之后的新特性允许我们不用导入React就能自动注入jsx的转换函数 这件事最终是由@babel/plugin-transform-react-jsx来做的</li><li>extensions:告诉babel要处理的文件的文件后缀 我的组件就只有tsx和ts文件<br> .npmignore文件: 告诉npm publish时哪些文件忽略不用发布到npm包里<br> 这是我的项目要忽略的checklist:</li></ol> 
<pre><code class="prism language-bash">node_modules
src
.babelrc
.gitignore
.npmignore
.prettierrc
rollup.config.ts
<span class="token builtin class-name">test</span>
pnpm-lock.yaml
global.d.ts
tsconfig.json
.DS_Store
test-project
</code></pre> 
<p>除了.npmignore里的文件都会被上传到npm</p> 
<h2><a id="npm_266"></a>发布npm包</h2> 
<p>首先注册一个npm账号 然后去首页搜索包的头部会有个提示让你绑定2FA安全校验策略 根据提示走完流程就行 大概就是要绑定一个otp(one-time-password)一次性密码 这个下载一个google authentication的app就能生成 扫网页上的码绑定账号然后跟着提示走就行 这个一次性密码在第一次npm login和npm publish的时候会让你输入otp 后面就直接让你去浏览器验证就行</p> 
<p>每次发布前要先修改一下package.json的version版本号 不能发布相同的版本 会报错</p> 
<p>发布前最好去搜搜包名(package.json的name就是npm包的包名)是否已经存在了 不然取存在的名字会报没有权限更新别人的包 最好就是用@自己的名字/包名这个格式 加个用户名称前缀相当于一个namespace 重复的几率就会小很多</p> 
<p>root/package.json完整代码示例:</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"@williamyi74/react-keepalive"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"version"</span><span class="token operator">:</span> <span class="token string">"1.1.2"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"description"</span><span class="token operator">:</span> <span class="token string">"基于react18+的缓存组件,拥有类似vue的KeepAlive组件功能效果"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"main"</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"build"</span><span class="token operator">:</span> <span class="token string">"rollup --c --configPlugin typescript2 --bundleConfigAsCjs"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"build:dev"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=development pnpm build"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"build:prod"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=production pnpm build"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"keywords"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"alive"</span><span class="token punctuation">,</span>
    <span class="token string">"keep alive"</span><span class="token punctuation">,</span>
    <span class="token string">"react"</span><span class="token punctuation">,</span>
    <span class="token string">"react keep alive"</span><span class="token punctuation">,</span>
    <span class="token string">"react keep alive item"</span><span class="token punctuation">,</span>
    <span class="token string">"react keep alive scope"</span><span class="token punctuation">,</span>
    <span class="token string">"react keep scope"</span><span class="token punctuation">,</span>
    <span class="token string">"react hooks keep alive"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"author"</span><span class="token operator">:</span> <span class="token string">"williamyi"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"license"</span><span class="token operator">:</span> <span class="token string">"ISC"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"peerDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"react"</span><span class="token operator">:</span> <span class="token string">"&gt;=18.2.0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"react-dom"</span><span class="token operator">:</span> <span class="token string">"&gt;=18.2.0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"typescript"</span><span class="token operator">:</span> <span class="token string">"&gt;=5.0.4"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"@babel/core"</span><span class="token operator">:</span> <span class="token string">"^7.21.4"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"@babel/preset-env"</span><span class="token operator">:</span> <span class="token string">"^7.21.4"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"@babel/preset-react"</span><span class="token operator">:</span> <span class="token string">"^7.18.6"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"@rollup/plugin-commonjs"</span><span class="token operator">:</span> <span class="token string">"^24.1.0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"@rollup/plugin-node-resolve"</span><span class="token operator">:</span> <span class="token string">"^15.0.2"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"@types/react"</span><span class="token operator">:</span> <span class="token string">"^18.2.0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"@types/react-dom"</span><span class="token operator">:</span> <span class="token string">"^18.2.1"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"cross-env"</span><span class="token operator">:</span> <span class="token string">"^7.0.3"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"react"</span><span class="token operator">:</span> <span class="token string">"^18.2.0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"react-dom"</span><span class="token operator">:</span> <span class="token string">"^18.2.0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"rollup"</span><span class="token operator">:</span> <span class="token string">"^3.21.0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"rollup-plugin-babel"</span><span class="token operator">:</span> <span class="token string">"^4.4.0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"rollup-plugin-typescript2"</span><span class="token operator">:</span> <span class="token string">"^0.34.1"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"typescript"</span><span class="token operator">:</span> <span class="token string">"^5.0.4"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"module"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>root/package.json解释:</p> 
<ol><li>keywords: 搜索你的包时的关键词</li><li>description: 搜索包时略缩图下的简述</li><li>license: 项目的协议,ISC是MIT的一个简化版本 这个说明就是别人能自由的修改和用你的项目</li><li>peerDependencies: 项目里用到的外部依赖要求 告诉使用这个包的项目这些依赖版本要符合这个要求 否则会报错 用这个包的项目下载依赖时会下载peerDep 而不是我们项目里去下载 external里的包都写到这</li></ol> 
<p>首先执行npm login前先切换到npm源不要在淘宝源 否则会报错 输入信息跟着走完</p> 
<p>登录成功后执行npm publish --access public发布</p> 
<p>–access public是告诉npm发布公开的包 因为默认是不能发布私有包的 忘了私有包是要收费还是啥 指定了这个命令参数就不会报权限错误了</p> 
<p>一路没报错后去看npm的package就能看到自己发布上去的包了:<br> <img src="https://images2.imgbox.com/97/75/BzLrGjCw_o.png" alt="发布成功的npm包"></p> 
<h2><a id="_336"></a>文档</h2> 
<p>使用文档就是根目录下的README.md文件 完善这个文件就可以了</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f9034233d9506d34a4a17b4a87a8df9f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python如何把excel文件转化为json文件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/512d9c687b0044e8fa7f0d97f2749573/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">云原生技术概述</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>