<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>QEMU启动ARM64 Linux内核 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="QEMU启动ARM64 Linux内核" />
<meta property="og:description" content="目录 前言前置知识virt开发板ARM处理器家族简介 安装qemu-system-aarch64安装交叉编译工具交叉编译ARM64 Linux内核交叉编译ARM64 Busybox使用busybox制作initramfs使用QEMU启动ARM64 Linux内核 前言 本文介绍采用 qemu 模拟ARM-64bit开发板（针对ARM-32bit的有另一篇文章介绍），并启动ARM64 Linux内核。大致思路是：
安装qemu-system-aarch64（ARM-64bit）模拟器；安装aarch64-linux-gnu（ARM-64bit）交叉编译器；交叉编译linux源码，得到ARM64 Linux内核镜像；交叉编译busybox源码，使用busybox制作initramfs；最后使用qemu-system-aarch64启用ARM64 Linux内核； 我的环境：
宿主机硬件平台：x86_64宿主机操作系统：Ubuntu 20.04 （Linux 5.4.0-139-generic）QEMU版本：qemu-4.2.1实验内核：linux-5.19busybox版本：busybox-1.35.0 前置知识 virt开发板 截至书稿本文时，QEMU模拟了多大70几种的硬件开发板，可参考Arm System emulator。但ARM-64bit的QEMU模拟器非常少，以至于virt成了唯一的选择。virt支持PCI，virtio，较新的ARM CPU，大容量内存，比较遗憾的是它不支持图形界面，如果你不知道选择什么硬件开发板就选virt。
更详尽的内容可参考：
Why the “virt”board?
Installing Debian on QEMU’s 32-bit ARM “virt”board
Installing Debian on QEMU’s 64-bit ARM “virt”board
ARM处理器家族简介 ARM处理器家族众多，哪些是32bit，哪些是64bit，可参考：
List_of_ARM_processors
很多厂家使用ARM核设计SOC芯片，这里罗列了很多，可参考：
List_of_products_using_ARM_processors
安装qemu-system-aarch64 安装：
$ sudo apt install qemu-system-arm 会同时安装ARM-32bit的qemu-system-arm版本和ARM-64bit的 qemu-system-aarch64版本，查看版本号：
$ qemu-system-aarch64 --version QEMU emulator version 4.2.1 (Debian 1:4.2-3ubuntu6.24) Copyright (c) 2003-2019 Fabrice Bellard and the QEMU Project developers 查看 qemu 支持的 ARM 内核开发板，本文选择virt开发板：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/af2ce7c575d799499661b0b69672f947/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-19T13:00:41+08:00" />
<meta property="article:modified_time" content="2023-03-19T13:00:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">QEMU启动ARM64 Linux内核</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">前言</a></li><li><a href="#_18" rel="nofollow">前置知识</a></li><li><ul><li><a href="#virt_19" rel="nofollow">virt开发板</a></li><li><a href="#ARM_28" rel="nofollow">ARM处理器家族简介</a></li></ul> 
  </li><li><a href="#qemusystemaarch64_36" rel="nofollow">安装qemu-system-aarch64</a></li><li><a href="#_174" rel="nofollow">安装交叉编译工具</a></li><li><a href="#ARM64_Linux_198" rel="nofollow">交叉编译ARM64 Linux内核</a></li><li><a href="#ARM64_Busybox_234" rel="nofollow">交叉编译ARM64 Busybox</a></li><li><a href="#busyboxinitramfs_283" rel="nofollow">使用busybox制作initramfs</a></li><li><a href="#QEMUARM64_Linux_324" rel="nofollow">使用QEMU启动ARM64 Linux内核</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>前言</h2> 
<p>本文介绍采用 qemu 模拟ARM-64bit开发板（<a href="https://blog.csdn.net/benkaoya/article/details/129469529">针对ARM-32bit的有另一篇文章介绍</a>），并启动ARM64 Linux内核。大致思路是：</p> 
<ul><li>安装qemu-system-aarch64（ARM-64bit）模拟器；</li><li>安装aarch64-linux-gnu（ARM-64bit）交叉编译器；</li><li>交叉编译linux源码，得到ARM64 Linux内核镜像；</li><li>交叉编译busybox源码，使用busybox制作initramfs；</li><li>最后使用qemu-system-aarch64启用ARM64 Linux内核；</li></ul> 
<p>我的环境：</p> 
<ul><li>宿主机硬件平台：x86_64</li><li>宿主机操作系统：Ubuntu 20.04 （Linux 5.4.0-139-generic）</li><li>QEMU版本：qemu-4.2.1</li><li>实验内核：linux-5.19</li><li>busybox版本：busybox-1.35.0</li></ul> 
<h2><a id="_18"></a>前置知识</h2> 
<h3><a id="virt_19"></a>virt开发板</h3> 
<p>截至书稿本文时，QEMU模拟了多大70几种的硬件开发板，可参考<a href="https://qemu.readthedocs.io/en/latest/system/target-arm.html" rel="nofollow">Arm System emulator</a>。但ARM-64bit的QEMU模拟器非常少，以至于virt成了唯一的选择。virt支持PCI，virtio，较新的ARM CPU，大容量内存，比较遗憾的是它不支持图形界面，如果你不知道选择什么硬件开发板就选virt。</p> 
<p>更详尽的内容可参考：</p> 
<p>Why the “virt”board?<br> <a href="https://translatedcode.wordpress.com/2016/11/03/installing-debian-on-qemus-32-bit-arm-virt-board/" rel="nofollow">Installing Debian on QEMU’s 32-bit ARM “virt”board</a><br> <a href="https://translatedcode.wordpress.com/2017/07/24/installing-debian-on-qemus-64-bit-arm-virt-board/" rel="nofollow">Installing Debian on QEMU’s 64-bit ARM “virt”board</a></p> 
<h3><a id="ARM_28"></a>ARM处理器家族简介</h3> 
<p><img src="https://images2.imgbox.com/23/07/mPF0jhXB_o.png" alt="ARM处理器与架构对应表"><br> ARM处理器家族众多，哪些是32bit，哪些是64bit，可参考：<br> <a href="https://www.detailedpedia.com/wiki-List_of_ARM_processors" rel="nofollow">List_of_ARM_processors</a></p> 
<p>很多厂家使用ARM核设计SOC芯片，这里罗列了很多，可参考：<br> <a href="https://www.detailedpedia.com/wiki-List_of_products_using_ARM_processors" rel="nofollow">List_of_products_using_ARM_processors</a></p> 
<h2><a id="qemusystemaarch64_36"></a>安装qemu-system-aarch64</h2> 
<p>安装：</p> 
<pre><code class="prism language-bash">$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> qemu-system-arm
</code></pre> 
<p>会同时安装ARM-32bit的qemu-system-arm版本和ARM-64bit的 qemu-system-aarch64版本，查看版本号：</p> 
<pre><code class="prism language-bash">$ qemu-system-aarch64 --version
QEMU emulator version <span class="token number">4.2</span>.1 <span class="token punctuation">(</span>Debian <span class="token number">1</span>:4.2-3ubuntu6.24<span class="token punctuation">)</span>
Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2003</span>-2019 Fabrice Bellard and the QEMU Project developers
</code></pre> 
<p>查看 qemu 支持的 ARM 内核开发板，本文选择virt开发板：</p> 
<pre><code class="prism language-bash">$ qemu-system-aarch64 -M <span class="token builtin class-name">help</span>
Supported machines are:
akita                Sharp SL-C1000 <span class="token punctuation">(</span>Akita<span class="token punctuation">)</span> PDA <span class="token punctuation">(</span>PXA270<span class="token punctuation">)</span>
ast2500-evb          Aspeed AST2500 EVB <span class="token punctuation">(</span>ARM1176<span class="token punctuation">)</span>
ast2600-evb          Aspeed AST2600 EVB <span class="token punctuation">(</span>Cortex A7<span class="token punctuation">)</span>
borzoi               Sharp SL-C3100 <span class="token punctuation">(</span>Borzoi<span class="token punctuation">)</span> PDA <span class="token punctuation">(</span>PXA270<span class="token punctuation">)</span>
canon-a1100          Canon PowerShot A1100 IS
cheetah              Palm Tungsten<span class="token operator">|</span>E aka. Cheetah PDA <span class="token punctuation">(</span>OMAP310<span class="token punctuation">)</span>
collie               Sharp SL-5500 <span class="token punctuation">(</span>Collie<span class="token punctuation">)</span> PDA <span class="token punctuation">(</span>SA-1110<span class="token punctuation">)</span>
connex               Gumstix Connex <span class="token punctuation">(</span>PXA255<span class="token punctuation">)</span>
cubieboard           cubietech cubieboard <span class="token punctuation">(</span>Cortex-A8<span class="token punctuation">)</span>
emcraft-sf2          SmartFusion2 SOM kit from Emcraft <span class="token punctuation">(</span>M2S010<span class="token punctuation">)</span>
highbank             Calxeda Highbank <span class="token punctuation">(</span>ECX-1000<span class="token punctuation">)</span>
imx25-pdk            ARM i.MX25 PDK board <span class="token punctuation">(</span>ARM926<span class="token punctuation">)</span>
integratorcp         ARM Integrator/CP <span class="token punctuation">(</span>ARM926EJ-S<span class="token punctuation">)</span>
kzm                  ARM KZM Emulation Baseboard <span class="token punctuation">(</span>ARM1136<span class="token punctuation">)</span>
lm3s6965evb          Stellaris LM3S6965EVB
lm3s811evb           Stellaris LM3S811EVB
mainstone            Mainstone II <span class="token punctuation">(</span>PXA27x<span class="token punctuation">)</span>
mcimx6ul-evk         Freescale i.MX6UL Evaluation Kit <span class="token punctuation">(</span>Cortex A7<span class="token punctuation">)</span>
mcimx7d-sabre        Freescale i.MX7 DUAL SABRE <span class="token punctuation">(</span>Cortex A7<span class="token punctuation">)</span>
microbit             BBC micro:bit
midway               Calxeda Midway <span class="token punctuation">(</span>ECX-2000<span class="token punctuation">)</span>
mps2-an385           ARM MPS2 with AN385 FPGA image <span class="token keyword">for</span> Cortex-M3
mps2-an505           ARM MPS2 with AN505 FPGA image <span class="token keyword">for</span> Cortex-M33
mps2-an511           ARM MPS2 with AN511 DesignStart FPGA image <span class="token keyword">for</span> Cortex-M3
mps2-an521           ARM MPS2 with AN521 FPGA image <span class="token keyword">for</span> dual Cortex-M33
musca-a              ARM Musca-A board <span class="token punctuation">(</span>dual Cortex-M33<span class="token punctuation">)</span>
musca-b1             ARM Musca-B1 board <span class="token punctuation">(</span>dual Cortex-M33<span class="token punctuation">)</span>
musicpal             Marvell 88w8618 / MusicPal <span class="token punctuation">(</span>ARM926EJ-S<span class="token punctuation">)</span>
n800                 Nokia N800 tablet aka. RX-34 <span class="token punctuation">(</span>OMAP2420<span class="token punctuation">)</span>
n810                 Nokia N810 tablet aka. RX-44 <span class="token punctuation">(</span>OMAP2420<span class="token punctuation">)</span>
netduino2            Netduino <span class="token number">2</span> Machine
none                 empty machine
nuri                 Samsung NURI board <span class="token punctuation">(</span>Exynos4210<span class="token punctuation">)</span>
palmetto-bmc         OpenPOWER Palmetto BMC <span class="token punctuation">(</span>ARM926EJ-S<span class="token punctuation">)</span>
raspi2               Raspberry Pi <span class="token number">2</span>
raspi3               Raspberry Pi <span class="token number">3</span>
realview-eb          ARM RealView Emulation Baseboard <span class="token punctuation">(</span>ARM926EJ-S<span class="token punctuation">)</span>
realview-eb-mpcore   ARM RealView Emulation Baseboard <span class="token punctuation">(</span>ARM11MPCore<span class="token punctuation">)</span>
realview-pb-a8       ARM RealView Platform Baseboard <span class="token keyword">for</span> Cortex-A8
realview-pbx-a9      ARM RealView Platform Baseboard Explore <span class="token keyword">for</span> Cortex-A9
romulus-bmc          OpenPOWER Romulus BMC <span class="token punctuation">(</span>ARM1176<span class="token punctuation">)</span>
sabrelite            Freescale i.MX6 Quad SABRE Lite Board <span class="token punctuation">(</span>Cortex A9<span class="token punctuation">)</span>
sbsa-ref             QEMU <span class="token string">'SBSA Reference'</span> ARM Virtual Machine
smdkc210             Samsung SMDKC210 board <span class="token punctuation">(</span>Exynos4210<span class="token punctuation">)</span>
spitz                Sharp SL-C3000 <span class="token punctuation">(</span>Spitz<span class="token punctuation">)</span> PDA <span class="token punctuation">(</span>PXA270<span class="token punctuation">)</span>
swift-bmc            OpenPOWER Swift BMC <span class="token punctuation">(</span>ARM1176<span class="token punctuation">)</span>
sx1                  Siemens SX1 <span class="token punctuation">(</span>OMAP310<span class="token punctuation">)</span> V2
sx1-v1               Siemens SX1 <span class="token punctuation">(</span>OMAP310<span class="token punctuation">)</span> V1
terrier              Sharp SL-C3200 <span class="token punctuation">(</span>Terrier<span class="token punctuation">)</span> PDA <span class="token punctuation">(</span>PXA270<span class="token punctuation">)</span>
tosa                 Sharp SL-6000 <span class="token punctuation">(</span>Tosa<span class="token punctuation">)</span> PDA <span class="token punctuation">(</span>PXA255<span class="token punctuation">)</span>
verdex               Gumstix Verdex <span class="token punctuation">(</span>PXA270<span class="token punctuation">)</span>
versatileab          ARM Versatile/AB <span class="token punctuation">(</span>ARM926EJ-S<span class="token punctuation">)</span>
versatilepb          ARM Versatile/PB <span class="token punctuation">(</span>ARM926EJ-S<span class="token punctuation">)</span>
vexpress-a15         ARM Versatile Express <span class="token keyword">for</span> Cortex-A15
vexpress-a9          ARM Versatile Express <span class="token keyword">for</span> Cortex-A9
virt-2.10            QEMU <span class="token number">2.10</span> ARM Virtual Machine
virt-2.11            QEMU <span class="token number">2.11</span> ARM Virtual Machine
virt-2.12            QEMU <span class="token number">2.12</span> ARM Virtual Machine
virt-2.6             QEMU <span class="token number">2.6</span> ARM Virtual Machine
virt-2.7             QEMU <span class="token number">2.7</span> ARM Virtual Machine
virt-2.8             QEMU <span class="token number">2.8</span> ARM Virtual Machine
virt-2.9             QEMU <span class="token number">2.9</span> ARM Virtual Machine
virt-3.0             QEMU <span class="token number">3.0</span> ARM Virtual Machine
virt-3.1             QEMU <span class="token number">3.1</span> ARM Virtual Machine
virt-4.0             QEMU <span class="token number">4.0</span> ARM Virtual Machine
virt-4.1             QEMU <span class="token number">4.1</span> ARM Virtual Machine
virt                 QEMU <span class="token number">4.2</span> ARM Virtual Machine <span class="token punctuation">(</span>alias of virt-4.2<span class="token punctuation">)</span>
virt-4.2             QEMU <span class="token number">4.2</span> ARM Virtual Machine
witherspoon-bmc      OpenPOWER Witherspoon BMC <span class="token punctuation">(</span>ARM1176<span class="token punctuation">)</span>
xilinx-zynq-a9       Xilinx Zynq Platform Baseboard <span class="token keyword">for</span> Cortex-A9
xlnx-versal-virt     Xilinx Versal Virtual development board
xlnx-zcu102          Xilinx ZynqMP ZCU102 board with 4xA53s and 2xR5Fs based on the value of smp
z2                   Zipit Z2 <span class="token punctuation">(</span>PXA27x<span class="token punctuation">)</span>
</code></pre> 
<p>看下virt开发板支持的cpu列表，本文以64-bit的cortex-a57为例说明：</p> 
<pre><code class="prism language-bash">$ qemu-system-aarch64 -M virt --cpu <span class="token builtin class-name">help</span>
Available CPUs:
  arm1026
  arm1136
  arm1136-r2
  arm1176
  arm11mpcore
  arm926
  arm946
  cortex-a15
  cortex-a53
  cortex-a57
  cortex-a7
  cortex-a72
  cortex-a8
  cortex-a9
  cortex-m0
  cortex-m3
  cortex-m33
  cortex-m4
  cortex-r5
  cortex-r5f
  max
  pxa250
  pxa255
  pxa260
  pxa261
  pxa262
  pxa270-a0
  pxa270-a1
  pxa270
  pxa270-b0
  pxa270-b1
  pxa270-c0
  pxa270-c5
  sa1100
  sa1110
  ti925t
</code></pre> 
<h2><a id="_174"></a>安装交叉编译工具</h2> 
<p>我们是在X86平台下进行的开发，目标平台是arm架构，需要安装交叉编译工具链。有关arm-linux的交叉编译器主要有：</p> 
<ul><li>针对ARM-32bit的arm-linux-gnueabi和arm-linux-gnueabihf。</li><li>针对ARM-64bit的aarch64-linux-gnu。</li></ul> 
<p>交叉编译器各版本的区别可参考《<a href="https://blog.csdn.net/benkaoya/article/details/129542585">arm系列交叉编译器各版本区别</a>》。</p> 
<p>安装ARM-64bit的aarch64-linux-gnu版本：</p> 
<pre><code class="prism language-bash">$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> gcc-aarch64-linux-gnu
</code></pre> 
<p>查看版本：</p> 
<pre><code class="prism language-bash">$ aarch64-linux-gnu-gcc --version
aarch64-linux-gnu-gcc <span class="token punctuation">(</span>Ubuntu <span class="token number">9.4</span>.0-1ubuntu1~20.04.1<span class="token punctuation">)</span> <span class="token number">9.4</span>.0
Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2019</span> Free Software Foundation, Inc.
This is <span class="token function">free</span> software<span class="token punctuation">;</span> see the <span class="token builtin class-name">source</span> <span class="token keyword">for</span> copying conditions.  There is NO
warranty<span class="token punctuation">;</span> not even <span class="token keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
</code></pre> 
<h2><a id="ARM64_Linux_198"></a>交叉编译ARM64 Linux内核</h2> 
<p>下载源码：</p> 
<pre><code class="prism language-bash">$ <span class="token function">mkdir</span> ~/kvm-arm
$ <span class="token builtin class-name">cd</span> ~/kvm-arm/
$ <span class="token function">wget</span> https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5.19.tar.gz
$ <span class="token function">tar</span> -xf linux-5.19.tar.gz
$ <span class="token builtin class-name">cd</span> linux-5.19/
$ <span class="token function">make</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>arm64 <span class="token assign-left variable">CROSS_COMPILE</span><span class="token operator">=</span>aarch64-linux-gnu- <span class="token assign-left variable">O</span><span class="token operator">=</span>build defconfig
$ <span class="token function">make</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>arm64 <span class="token assign-left variable">CROSS_COMPILE</span><span class="token operator">=</span>aarch64-linux-gnu- <span class="token assign-left variable">O</span><span class="token operator">=</span>build -j8
</code></pre> 
<p>说明：</p> 
<ul><li>ARCH：指定目标CPU架构；</li><li>CROSS_COMPILE：指定交叉编译器；</li><li>O=build：O是Out的缩写，表示编译输出文件放在build目录，不跟源码混在一起，保持源码的整洁性。</li><li>make时只有defconfig配置可选，因为 linux-5.19/arch/arm64/configs/ 目录下有且只有defconfig一个。</li></ul> 
<p>查看下内核编译出来的原始内核文件vmlinux，是ARM 64-bit版本。</p> 
<pre><code class="prism language-bash">$ <span class="token function">file</span> build/vmlinux
build/vmlinux: ELF <span class="token number">64</span>-bit LSB shared object, ARM aarch64, version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, statically linked, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>f2a5fd51bd2d59f90b7b26b8926f5afdeab60f36, not stripped
</code></pre> 
<p>vmlinux不能直接引导Linux系统启动，能引导Linux系统启动的是Image文件（非压缩版）或Image.gz（压缩版），下文用到的内核镜像就是Image：</p> 
<pre><code class="prism language-bash">$ <span class="token function">file</span> build/arch/arm64/boot/Image
build/arch/arm64/boot/Image: MS-DOS executable PE32+ executable <span class="token punctuation">(</span>EFI application<span class="token punctuation">)</span> Aarch64 <span class="token punctuation">(</span>stripped to external PDB<span class="token punctuation">)</span>, <span class="token keyword">for</span> MS Windows

$ <span class="token function">file</span> build/arch/arm64/boot/Image.gz 
build/arch/arm64/boot/Image.gz: <span class="token function">gzip</span> compressed data, max compression, from Unix, original size modulo <span class="token number">2</span>^32 <span class="token number">36112896</span>
</code></pre> 
<h2><a id="ARM64_Busybox_234"></a>交叉编译ARM64 Busybox</h2> 
<pre><code class="prism language-bash">$ <span class="token function">mkdir</span> ~/kvm-arm
$ <span class="token builtin class-name">cd</span> ~/kvm-arm/
$ <span class="token function">wget</span> https://busybox.net/downloads/busybox-1.35.0.tar.bz2
$ <span class="token function">tar</span> -xf busybox-1.35.0.tar.bz2
$ <span class="token builtin class-name">cd</span> busybox-1.35.0/

$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>arm64
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">CROSS_COMPILE</span><span class="token operator">=</span>aarch64-linux-gnu-
$ <span class="token function">make</span> menuconfig

<span class="token comment"># 修改配置，选中如下项目，静态编译</span>
<span class="token comment"># Settings –&gt; Build Options –&gt; [*] Build static binary（no share libs）</span>

<span class="token comment"># 反选如下项目，否则后续qemu执行会提示 /bin/sh:can't access tty;job control turned off</span>
<span class="token comment"># Shells  ---&gt;  [ ]   Job control</span>

$ <span class="token function">make</span> -j <span class="token variable"><span class="token variable">`</span>nproc<span class="token variable">`</span></span>
$ <span class="token function">make</span> <span class="token function">install</span>
</code></pre> 
<p>装完后会 默认安装到源码目录的 _install/ 目录下：</p> 
<pre><code class="prism language-bash">$ <span class="token function">ls</span> _install/
bin  linuxrc  sbin  usr
</code></pre> 
<p>最关键的就是_install/bin/busybox，其他都是链接文件。</p> 
<pre><code class="prism language-bash">$ <span class="token function">file</span> _install/bin/busybox 
_install/bin/busybox: ELF <span class="token number">64</span>-bit LSB executable, ARM aarch64, version <span class="token number">1</span> <span class="token punctuation">(</span>GNU/Linux<span class="token punctuation">)</span>, statically linked, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>3768162c347859f16ab4f0b01a48fb8c0502774d, <span class="token keyword">for</span> GNU/Linux <span class="token number">3.7</span>.0, stripped
</code></pre> 
<p>编译的过程中如果出现如下提示，可忽略：</p> 
<pre><code class="prism language-bash">Trying libraries: m resolv rt
 Library m is needed, can<span class="token string">'t exclude it (yet)
 Library resolv is needed, can'</span>t exclude it <span class="token punctuation">(</span>yet<span class="token punctuation">)</span>
 Library rt is not needed, excluding it
 Library m is needed, can<span class="token string">'t exclude it (yet)
 Library resolv is needed, can'</span>t exclude it <span class="token punctuation">(</span>yet<span class="token punctuation">)</span>
Final <span class="token function">link</span> with: m resolv
</code></pre> 
<h2><a id="busyboxinitramfs_283"></a>使用busybox制作initramfs</h2> 
<p>使用busybox快速制作initramfs。</p> 
<p>创建虚拟rootfs中的inti启动脚本，并赋予可执行权限：</p> 
<pre><code class="prism language-bash">$ <span class="token builtin class-name">cd</span> ~/kvm-arm/busybox-1.35.0/_install/
$ <span class="token function">mkdir</span> proc sys dev tmp
$ <span class="token function">touch</span> init
$ <span class="token function">chmod</span> +x init
</code></pre> 
<p>脚本内容：</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/sh</span>

<span class="token comment"># 挂载一些必要的文件系统</span>
<span class="token function">mount</span> -t proc none /proc
<span class="token function">mount</span> -t sysfs none /sys
<span class="token function">mount</span> -t tmpfs none /tmp
<span class="token function">mount</span> -t devtmpfs none /dev

<span class="token builtin class-name">echo</span>
<span class="token builtin class-name">echo</span> <span class="token string">"Hello 64-bit ARM Linux"</span>

<span class="token comment"># 显示开机消耗时间</span>
<span class="token builtin class-name">echo</span> <span class="token string">"This boot took <span class="token variable"><span class="token variable">$(</span><span class="token function">cut</span> -d<span class="token string">' '</span> -f1 /proc/uptime<span class="token variable">)</span></span> seconds"</span>
<span class="token builtin class-name">echo</span>

<span class="token comment"># 停留在控制台</span>
<span class="token builtin class-name">exec</span> /bin/sh
</code></pre> 
<p>制作initramfs文件，它是多个文件通过cpio打包和gzip压缩的文件，是一个cpio格式的内存文件系统。</p> 
<pre><code class="prism language-bash">$ <span class="token function">find</span> <span class="token builtin class-name">.</span> -print0 <span class="token operator">|</span> cpio --null -ov --format<span class="token operator">=</span>newc <span class="token operator">|</span> <span class="token function">gzip</span> -9 <span class="token operator">&gt;</span> <span class="token punctuation">..</span>/initramfs.cpio.gz
</code></pre> 
<h2><a id="QEMUARM64_Linux_324"></a>使用QEMU启动ARM64 Linux内核</h2> 
<p>ARM Linux内核镜像和initramfs都准备好，就可以使用QEMU启动linux内核了。</p> 
<p>以字符界面方式启动QEMU，同时日志输出到控制台：</p> 
<pre><code class="prism language-bash">$  qemu-system-aarch64 <span class="token punctuation">\</span>
		-M virt <span class="token punctuation">\</span>
		-cpu cortex-a57 <span class="token punctuation">\</span>
		-smp <span class="token number">8</span> <span class="token punctuation">\</span>
		-m 8G <span class="token punctuation">\</span>
		-kernel ./linux-5.19/build/arch/arm64/boot/Image <span class="token punctuation">\</span>
		-initrd ./busybox-1.35.0/initramfs.cpio.gz <span class="token punctuation">\</span>
		-nographic <span class="token punctuation">\</span>
		-append <span class="token string">"init=/init console=ttyAMA0"</span>
</code></pre> 
<p>QEMU参数说明（更多可参考：<a href="https://www.qemu.org/docs/master/system/invocation.html" rel="nofollow">Standard options</a>）：</p> 
<ul><li>-M：指定模拟的开发板，可通过qemu-system-aarch64 M help查看，截至书稿时，只有virt支持64-bit ARM。</li><li>-cpu：指定模拟的cpu，可通过qemu-system-aarch64 -M virt --cpu help查看，这里选择cortex-a57。</li><li>-smp：指定cpu核数量，启动后可以使用nproc命令核对。</li><li>-m：指定内存大小，virt 可支持超大内存，启动后可以使用free -h命令核对。</li><li>-kernel：指定启动的内核镜像；</li><li>-initrd：指定启动的内存文件系统；</li><li>-append：传递给内核的启动参数；启动后可使用cat /proc/cmdline命令核对。</li><li>-nographic：启动字符界面（不启动图形界面），输出重定向到宿主机命令行，与参数 console=ttyAMA0 组合使用；</li></ul> 
<p>9 参考</p> 
<ul><li><a href="https://qemu.readthedocs.io/en/latest/system/target-arm.html" rel="nofollow">Arm System emulator</a></li><li><a href="https://www.qemu.org/docs/master/system/arm/vexpress.html" rel="nofollow">Arm Versatile Express boards (vexpress-a9, vexpress-a15)</a></li><li><a href="https://www.detailedpedia.com/wiki-List_of_products_using_ARM_processors" rel="nofollow">List_of_products_using_ARM_processors</a></li><li><a href="https://www.detailedpedia.com/wiki-List_of_ARM_processors" rel="nofollow">List_of_ARM_processors</a></li><li><a href="https://blog.csdn.net/weixin_45090728/article/details/124355432">Qemu使用及常见开发板的模拟</a></li><li><a href="https://blog.csdn.net/u014100559/article/details/127260026">qemu-system-aarch64使用和相关参数介绍</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/75a7415fbdf9b5cfa59eee3976ed6c55/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python--socket（套接字/插口）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0851f479665df8f68cf86e0e9cec3e72/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Ubuntu 20.04 下 部署 SoftEther</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>