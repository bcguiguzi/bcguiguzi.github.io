<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【AI的未来 - AI Agent系列】【MetaGPT】4. ActionNode从理论到实战 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【AI的未来 - AI Agent系列】【MetaGPT】4. ActionNode从理论到实战" />
<meta property="og:description" content="文章目录 0. ActionNode基础0.1 官方解释0.2 我的理解0.3 ActionNode的数据结构0.4 如何使用ActionNode 1. ActionNode简单实战1.1 思考并返回特定格式的数字1.1.1 定义两个ActionNode1.1.2 为这两个动作节点设置一个父节点1.1.3 定义一个Action来承载上面的ActionNode 1.2 逐个打印数字1.3 实现Role，执行Action 2. 完整代码和运行效果2.1 完整代码2.2 运行效果 0. ActionNode基础 0.1 官方解释 在MG框架0.5版本中，新增加了ActionNode类，为Agent的动作执行提供更强的能力
ActionNode可以被视为一组动作树，根据类内定义，一个动作树的父节点可以访问所有的子动作节点；也就是说，定义了一个完整的动作树之后，可以从父节点按树的结构顺序执行每一个子动作节点。因此，动作的执行也可以突破0.4版本框架中，需要在Role的_react内循环执行的限制，达到更好的CoT效果。
0.2 我的理解 如下图，ActionNode需要内置在Action中使用，之前可能是Action就是一个动作，执行完一个就执行完下一个。有了ActionNode后，Action就不只是一个动作，而可能是一系列动作。这一系列动作可以组织成链式结构，或者树状结构或者更复杂的结构。
0.3 ActionNode的数据结构 schema: str # raw/json/markdown, default: &#34;&#34; # Action Context context: str # all the context, including all necessary info llm: BaseLLM # LLM with aask interface children: dict[str, &#34;ActionNode&#34;] # Action Input key: str # Product Requirement / File list / Code expected_type: Type # such as str / int / float etc." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/7918591b0e0d1a25de8642df01e196ef/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-18T09:58:13+08:00" />
<meta property="article:modified_time" content="2024-01-18T09:58:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【AI的未来 - AI Agent系列】【MetaGPT】4. ActionNode从理论到实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#0_ActionNode_3" rel="nofollow">0. ActionNode基础</a></li><li><ul><li><a href="#01__5" rel="nofollow">0.1 官方解释</a></li><li><a href="#02__9" rel="nofollow">0.2 我的理解</a></li><li><a href="#03_ActionNode_14" rel="nofollow">0.3 ActionNode的数据结构</a></li><li><a href="#04_ActionNode_43" rel="nofollow">0.4 如何使用ActionNode</a></li></ul> 
   </li><li><a href="#1_ActionNode_83" rel="nofollow">1. ActionNode简单实战</a></li><li><ul><li><a href="#11__90" rel="nofollow">1.1 思考并返回特定格式的数字</a></li><li><ul><li><a href="#111_ActionNode_97" rel="nofollow">1.1.1 定义两个ActionNode</a></li><li><a href="#112__126" rel="nofollow">1.1.2 为这两个动作节点设置一个父节点</a></li><li><a href="#113_ActionActionNode_157" rel="nofollow">1.1.3 定义一个Action来承载上面的ActionNode</a></li></ul> 
    </li><li><a href="#12__197" rel="nofollow">1.2 逐个打印数字</a></li><li><a href="#13_RoleAction_213" rel="nofollow">1.3 实现Role，执行Action</a></li></ul> 
   </li><li><a href="#2__265" rel="nofollow">2. 完整代码和运行效果</a></li><li><ul><li><a href="#21__267" rel="nofollow">2.1 完整代码</a></li><li><a href="#22__456" rel="nofollow">2.2 运行效果</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="0_ActionNode_3"></a>0. ActionNode基础</h3> 
<h4><a id="01__5"></a>0.1 官方解释</h4> 
<blockquote> 
 <p>在MG框架0.5版本中，新增加了ActionNode类，为Agent的动作执行提供更强的能力<br> ActionNode可以被视为一组动作树，根据类内定义，一个动作树的父节点可以访问所有的子动作节点；也就是说，定义了一个完整的动作树之后，可以从父节点按树的结构顺序执行每一个子动作节点。因此，动作的执行也可以突破0.4版本框架中，需要在Role的_react内循环执行的限制，达到更好的CoT效果。</p> 
</blockquote> 
<h4><a id="02__9"></a>0.2 我的理解</h4> 
<p>如下图，ActionNode需要内置在Action中使用，之前可能是Action就是一个动作，执行完一个就执行完下一个。有了ActionNode后，Action就不只是一个动作，而可能是一系列动作。这一系列动作可以组织成链式结构，或者树状结构或者更复杂的结构。</p> 
<p><img src="https://images2.imgbox.com/58/5a/aFgfRHct_o.png" alt="在这里插入图片描述" width="500"></p> 
<h4><a id="03_ActionNode_14"></a>0.3 ActionNode的数据结构</h4> 
<pre><code class="prism language-python">schema<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># raw/json/markdown, default: ""</span>

<span class="token comment"># Action Context</span>
context<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># all the context, including all necessary info</span>
llm<span class="token punctuation">:</span> BaseLLM  <span class="token comment"># LLM with aask interface</span>
children<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token string">"ActionNode"</span><span class="token punctuation">]</span>

<span class="token comment"># Action Input</span>
key<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># Product Requirement / File list / Code</span>
expected_type<span class="token punctuation">:</span> Type  <span class="token comment"># such as str / int / float etc.</span>
<span class="token comment"># context: str  # everything in the history.</span>
instruction<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># the instructions should be followed.</span>
example<span class="token punctuation">:</span> Any  <span class="token comment"># example for In Context-Learning.</span>

<span class="token comment"># Action Output</span>
content<span class="token punctuation">:</span> <span class="token builtin">str</span>
instruct_content<span class="token punctuation">:</span> BaseModel
</code></pre> 
<p>其中几个重要的成员变量（以我目前浅显使用过的例子来看）：</p> 
<ul><li>instruction：一般是prompt的部分内容</li><li>key：一般是ActionNode的名字</li><li>schema：指定该ActionNode的输出格式，指定为json或markdown之后会有严格的校验</li><li>expected_type：期望返回格式，例如str</li><li>example：类似prompt中的few-shot，给几个期望输出的例子</li></ul> 
<h4><a id="04_ActionNode_43"></a>0.4 如何使用ActionNode</h4> 
<p>下面是官方教程给的例子：</p> 
<pre><code class="prism language-python"><span class="token comment"># 定义单个子节点ActionNode</span>
UI_DESIGN_DESC <span class="token operator">=</span> ActionNode<span class="token punctuation">(</span>
    key<span class="token operator">=</span><span class="token string">"UI Design Desc"</span><span class="token punctuation">,</span>
    expected_type<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
    instruction<span class="token operator">=</span><span class="token string">"place the design objective here"</span><span class="token punctuation">,</span>
    example<span class="token operator">=</span><span class="token string">"Snake games are classic and addictive games with simple yet engaging elements. Here are the main elements"</span>
    <span class="token string">" commonly found in snake games"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment"># 定义完所有ActionNode之后，将其存放在一个List里面</span>
NODES <span class="token operator">=</span> <span class="token punctuation">[</span>
    UI_DESIGN_DESC<span class="token punctuation">,</span>
    SELECTED_ELEMENTS<span class="token punctuation">,</span>
    HTML_LAYOUT<span class="token punctuation">,</span>
    CSS_STYLES<span class="token punctuation">,</span>
    ANYTHING_UNCLEAR<span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment"># 将上述List的所有子节点传入父节点UI_DESIGN_NODE中</span>
UI_DESIGN_NODE <span class="token operator">=</span> ActionNode<span class="token punctuation">.</span>from_children<span class="token punctuation">(</span><span class="token string">"UI_DESIGN"</span><span class="token punctuation">,</span> NODES<span class="token punctuation">)</span>
</code></pre> 
<p>从上面代码看到，使用ActionNode的步骤很简单，如下<br> （1）定义一系列ActionNode<br> （2）根据一系列ActionNode构造父ActionNode</p> 
<p>之后，<strong><mark>在Action.run方法中</mark></strong>，调用父节点的执行方法fill，获取所有子节点按顺序执行之后的结果</p> 
<pre><code class="prism language-python">ui_describe <span class="token operator">=</span> <span class="token keyword">await</span> UI_DESIGN_NODE<span class="token punctuation">.</span>fill<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p>上面我重点标出了"在Action.run方法中"，说明ActionNode一定是依附在Action中运行的，<strong>在Action外不能独立运行？</strong></p> 
</blockquote> 
<h3><a id="1_ActionNode_83"></a>1. ActionNode简单实战</h3> 
<p>上面了解了ActionNode的定义方法，以及运行fill函数，下面以一个简单的例子，实战一下。实战内容为 《<a href="https://deepwisdom.feishu.cn/docx/RJmTdvZuPozAxFxEpFxcbiPwnQf" rel="nofollow">MetaGPT智能体开发入门</a>》课程中的例子：打印前10个斐波那契数列的数字，实现内容如下：</p> 
<ul><li>（1）LLM要能以特定的可解析的格式来返回斐波那契数列</li><li>（2）通过格式解析实现逐个打印数字的效果。</li></ul> 
<blockquote> 
 <p>不重要：斐波那契数列是一个数列，每个数都是前两个数的和，通常以0和1开始</p> 
</blockquote> 
<h4><a id="11__90"></a>1.1 思考并返回特定格式的数字</h4> 
<p>将第一个实现内容（LLM要能以特定的可解析的格式来返回斐波那契数列）拆解：</p> 
<ul><li>（1）思考前10个斐波那契数列的数字是什么</li><li>（2）思考到的数字按特定格式输出</li></ul> 
<p>这就可以用两个ActionNode来实现。下面我们具体来实现。</p> 
<h5><a id="111_ActionNode_97"></a>1.1.1 定义两个ActionNode</h5> 
<pre><code class="prism language-python"><span class="token comment"># 将思考斐波那契数列的10个数字作为prompt输入，在这里我们将“思考需要生成的数字列表”作为命令（instruction）写入</span>
<span class="token comment"># 将期望返回格式（expected_type）设置为str，无需设置例子（example）</span>
SIMPLE_THINK_NODE <span class="token operator">=</span> ActionNode<span class="token punctuation">(</span>
    key<span class="token operator">=</span><span class="token string">"Simple Think Node"</span><span class="token punctuation">,</span>
    expected_type<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
    instruction<span class="token operator">=</span><span class="token triple-quoted-string string">"""
            Think about what list of numbers you need to generate
            """</span><span class="token punctuation">,</span>
    example<span class="token operator">=</span><span class="token string">""</span>
<span class="token punctuation">)</span>

<span class="token comment"># 在这里通过命令（instruction）来规定需要生成的数字列表格式，提供例子（example）来帮助LLM理解</span>
SIMPLE_CHECK_NODE <span class="token operator">=</span> ActionNode<span class="token punctuation">(</span>
    key<span class="token operator">=</span><span class="token string">"Simple CHECK Node"</span><span class="token punctuation">,</span>
    expected_type<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
    instruction<span class="token operator">=</span><span class="token triple-quoted-string string">"""
            Please provide the number list for me, strictly following the following requirements:
            1. Answer strictly in the list format like [1,2,3,4]
            2. Do not have extra spaces or line breaks.
            Return the list here:
            """</span><span class="token punctuation">,</span>
    example<span class="token operator">=</span><span class="token string">"[1,2,3,4]"</span>
            <span class="token string">"[4,5,6]"</span><span class="token punctuation">,</span>
 <span class="token punctuation">)</span>
</code></pre> 
<h5><a id="112__126"></a>1.1.2 为这两个动作节点设置一个父节点</h5> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">THINK_NODES</span><span class="token punctuation">(</span>ActionNode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"Think Nodes"</span><span class="token punctuation">,</span> expected_type<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> instruction<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> example<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>key<span class="token operator">=</span>name<span class="token punctuation">,</span> expected_type<span class="token operator">=</span>expected_type<span class="token punctuation">,</span> instruction<span class="token operator">=</span>instruction<span class="token punctuation">,</span> example<span class="token operator">=</span>example<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>add_children<span class="token punctuation">(</span><span class="token punctuation">[</span>SIMPLE_THINK_NODE<span class="token punctuation">,</span> SIMPLE_CHECK_NODE<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 初始化过程，将上面实现的两个子节点加入作为THINK_NODES类的子节点</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fill</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> llm<span class="token punctuation">,</span> schema<span class="token operator">=</span><span class="token string">"raw"</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">,</span> strgy<span class="token operator">=</span><span class="token string">"complex"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>set_llm<span class="token punctuation">(</span>llm<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>set_context<span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>schema<span class="token punctuation">:</span>
            schema <span class="token operator">=</span> self<span class="token punctuation">.</span>schema

        <span class="token keyword">if</span> strgy <span class="token operator">==</span> <span class="token string">"simple"</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>simple_fill<span class="token punctuation">(</span>schema<span class="token operator">=</span>schema<span class="token punctuation">,</span> mode<span class="token operator">=</span>mode<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> strgy <span class="token operator">==</span> <span class="token string">"complex"</span><span class="token punctuation">:</span>
            <span class="token comment"># 这里隐式假设了拥有children</span>
            child_context <span class="token operator">=</span> context    <span class="token comment"># 输入context作为第一个子节点的context</span>
            <span class="token keyword">for</span> _<span class="token punctuation">,</span> i <span class="token keyword">in</span> self<span class="token punctuation">.</span>children<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                i<span class="token punctuation">.</span>set_context<span class="token punctuation">(</span>child_context<span class="token punctuation">)</span>    <span class="token comment"># 为子节点设置context</span>
                child <span class="token operator">=</span> <span class="token keyword">await</span> i<span class="token punctuation">.</span>simple_fill<span class="token punctuation">(</span>schema<span class="token operator">=</span>schema<span class="token punctuation">,</span> mode<span class="token operator">=</span>mode<span class="token punctuation">)</span>
                child_context <span class="token operator">=</span> child<span class="token punctuation">.</span>content    <span class="token comment"># 将返回内容（child.content）作为下一个子节点的context</span>

            self<span class="token punctuation">.</span>content <span class="token operator">=</span> child_context    <span class="token comment"># 最后一个子节点返回的内容设置为父节点返回内容（self.content）</span>
            <span class="token keyword">return</span> self
</code></pre> 
<p>为什么需要设置父节点？</p> 
<ul><li>ActionNode的 fill 方法，有一个参数叫“strgy”，当我们将这个参数设置为“complex”时，这个方法会按顺序执行每一个子节点，并将上一个子节点返回的内容作为下一个子节点的prompt。为了将两个动作节点串联起来，形成一个简单的CoT效果，我们需要设置一个父节点。</li></ul> 
<h5><a id="113_ActionActionNode_157"></a>1.1.3 定义一个Action来承载上面的ActionNode</h5> 
<p>前文已经说了，ActionNode的运行需要依赖Action的动作，所以这里需要定义一个Action：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">ThinkAction</span><span class="token punctuation">(</span>Action<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"ThinkAction"</span><span class="token punctuation">,</span> context<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> llm<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>node <span class="token operator">=</span> THINK_NODES<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 初始化Action时，初始化一个THINK_NODE实例并赋值给self.node</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instruction<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">:</span>
        PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
            You are now a number list generator, follow the instruction {instruction} and 
            generate a number list to be printed please.
            """</span>

        prompt <span class="token operator">=</span> PROMPT<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>instruction<span class="token operator">=</span>instruction<span class="token punctuation">)</span>
        rsp_node <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>node<span class="token punctuation">.</span>fill<span class="token punctuation">(</span>context<span class="token operator">=</span>prompt<span class="token punctuation">,</span> llm<span class="token operator">=</span>self<span class="token punctuation">.</span>llm<span class="token punctuation">,</span> schema<span class="token operator">=</span><span class="token string">"raw"</span><span class="token punctuation">,</span>
                                        strgy<span class="token operator">=</span><span class="token string">"complex"</span><span class="token punctuation">)</span>  <span class="token comment"># 1. 运行子节点，获取返回（返回格式为ActionNode）（注意设置 schema="raw"） 2. 注意strgy为complex，表示执行所有子节点，如果是"simple", 则只会执行父节点本身</span>
        rsp <span class="token operator">=</span> rsp_node<span class="token punctuation">.</span>content  <span class="token comment"># 获取返回的文本内容，返回的是ActionNode，通过.content来获取实际内容</span>
        rsp_match <span class="token operator">=</span> self<span class="token punctuation">.</span>find_in_brackets<span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>  <span class="token comment"># 按列表格式解析返回的文本内容，定位“[”与“]”之间的内容</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            rsp_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> rsp_match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 按列表格式解析返回的文本内容，按“,”对内容进行分割，并形成一个python语法中的列表</span>
            <span class="token keyword">return</span> rsp_list
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">find_in_brackets</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pattern <span class="token operator">=</span> <span class="token string">r'\[(.*?)\]'</span>
        <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> s<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">match</span>
</code></pre> 
<p>这个Action的几个重点关注点：</p> 
<ul><li>（1）初始化中<code>self.node = THINK_NODES()</code>，将ActionNode依附在Action中。</li><li>（2）Action的run方法中执行ActionNode的动作：<code>await self.node.fill(context=prompt, llm=self.llm, schema="raw", strgy="complex")</code> 
  <ul><li>其中注意schema为"raw"</li><li>strgy为“complex”，表示会执行完 <code>THINK_NODES()</code>中的所有子节点才会返回</li></ul> </li></ul> 
<h4><a id="12__197"></a>1.2 逐个打印数字</h4> 
<p>上面的程序将前10个数字解析出来并形成了Python中的list数组。下面实现逐个打印的Action</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">SimplePrint</span><span class="token punctuation">(</span>Action<span class="token punctuation">)</span><span class="token punctuation">:</span>
    input_num<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"SimplePrint"</span><span class="token punctuation">,</span> input_num<span class="token punctuation">:</span><span class="token builtin">int</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>input_num <span class="token operator">=</span> input_num

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>input_num<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>input_num<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="13_RoleAction_213"></a>1.3 实现Role，执行Action</h4> 
<p>有了Action，需要有个Role执行它。Role的代码和细节注释如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Printer</span><span class="token punctuation">(</span>Role<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"TXXZ"</span><span class="token punctuation">,</span> profile<span class="token operator">=</span><span class="token string">"Printer"</span><span class="token punctuation">,</span> goal<span class="token operator">=</span><span class="token string">"Print the number"</span><span class="token punctuation">,</span> constraints<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_init_actions<span class="token punctuation">(</span><span class="token punctuation">[</span>ThinkAction<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">## 1. 将Action加入Role的执行列表</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_think</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Determine the action"""</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>todo <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>state <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>states<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>todo <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_prepare_print</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_list<span class="token punctuation">:</span><span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Message<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Add actions"""</span>
        actions <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> num <span class="token keyword">in</span> num_list<span class="token punctuation">:</span> <span class="token comment">## 2. 对于Action返回的数组，逐个添加SimplePrint动作</span>
            actions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>SimplePrint<span class="token punctuation">(</span>input_num<span class="token operator">=</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_init_actions<span class="token punctuation">(</span>actions<span class="token punctuation">)</span> <span class="token comment">## 4. 这里第一个action变成了SimplePrint动作</span>
        self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>todo <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token comment">## 3. 为None时，_think函数会回到第一个action执行</span>
        <span class="token keyword">return</span> Message<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>num_list<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_act</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Message<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Action"""</span>
        todo <span class="token operator">=</span> self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>todo
        <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>todo<span class="token punctuation">)</span> <span class="token keyword">is</span> ThinkAction <span class="token punctuation">:</span>
            msg <span class="token operator">=</span> self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>goal <span class="token operator">=</span> msg<span class="token punctuation">.</span>content
            resp <span class="token operator">=</span> <span class="token keyword">await</span> todo<span class="token punctuation">.</span>run<span class="token punctuation">(</span>instruction<span class="token operator">=</span>self<span class="token punctuation">.</span>goal<span class="token punctuation">)</span> <span class="token comment"># 7. 个人感觉这里的goal有和没有都没关系，虽然作为prompt传入ThinkAction，但是这里并不是打印Action，与任务无关</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>_prepare_print<span class="token punctuation">(</span>resp<span class="token punctuation">)</span> <span class="token comment">## 5. ActionNode都执行完了，返回的是个数组，逐个去添加打印Action</span>

        resp <span class="token operator">=</span> <span class="token keyword">await</span> todo<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">## 6. 执行打印Action</span>
        <span class="token keyword">return</span> Message<span class="token punctuation">(</span>content<span class="token operator">=</span>resp<span class="token punctuation">,</span> role<span class="token operator">=</span>self<span class="token punctuation">.</span>profile<span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_react</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Message<span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>_think<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>todo <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            msg <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>_act<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> msg
</code></pre> 
<h3><a id="2__265"></a>2. 完整代码和运行效果</h3> 
<h4><a id="21__267"></a>2.1 完整代码</h4> 
<pre><code class="prism language-python"><span class="token comment"># 加载 .env 到环境变量</span>
<span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv<span class="token punctuation">,</span> find_dotenv
_ <span class="token operator">=</span> load_dotenv<span class="token punctuation">(</span>find_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> re

<span class="token keyword">from</span> metagpt<span class="token punctuation">.</span>actions<span class="token punctuation">.</span>action <span class="token keyword">import</span> Action<span class="token punctuation">,</span> ActionNode
<span class="token keyword">from</span> metagpt<span class="token punctuation">.</span>logs <span class="token keyword">import</span> logger
<span class="token keyword">from</span> metagpt<span class="token punctuation">.</span>roles <span class="token keyword">import</span> Role
<span class="token keyword">from</span> metagpt<span class="token punctuation">.</span>schema <span class="token keyword">import</span> Message

<span class="token comment"># 将思考斐波那契数列的10个数字作为prompt输入，在这里我们将“思考需要生成的数字列表”作为命令（instruction）写入</span>
<span class="token comment"># 将期望返回格式（expected_type）设置为str，无需设置例子（example）</span>
SIMPLE_THINK_NODE <span class="token operator">=</span> ActionNode<span class="token punctuation">(</span>
    key<span class="token operator">=</span><span class="token string">"Simple Think Node"</span><span class="token punctuation">,</span>
    expected_type<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
    instruction<span class="token operator">=</span><span class="token triple-quoted-string string">"""
            Think about what list of numbers you need to generate
            """</span><span class="token punctuation">,</span>
    example<span class="token operator">=</span><span class="token string">""</span>
<span class="token punctuation">)</span>

<span class="token comment"># 在这里通过命令（instruction）来规定需要生成的数字列表格式，提供例子（example）来帮助LLM理解</span>
SIMPLE_CHECK_NODE <span class="token operator">=</span> ActionNode<span class="token punctuation">(</span>
    key<span class="token operator">=</span><span class="token string">"Simple CHECK Node"</span><span class="token punctuation">,</span>
    expected_type<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
    instruction<span class="token operator">=</span><span class="token triple-quoted-string string">"""
            Please provide the number list for me, strictly following the following requirements:
            1. Answer strictly in the list format like [1,2,3,4]
            2. Do not have extra spaces or line breaks.
            Return the list here:
            """</span><span class="token punctuation">,</span>
    example<span class="token operator">=</span><span class="token string">"[1,2,3,4]"</span>
            <span class="token string">"[4,5,6]"</span><span class="token punctuation">,</span>
 <span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">THINK_NODES</span><span class="token punctuation">(</span>ActionNode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"Think Nodes"</span><span class="token punctuation">,</span> expected_type<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> instruction<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> example<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>key<span class="token operator">=</span>name<span class="token punctuation">,</span> expected_type<span class="token operator">=</span>expected_type<span class="token punctuation">,</span> instruction<span class="token operator">=</span>instruction<span class="token punctuation">,</span> example<span class="token operator">=</span>example<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>add_children<span class="token punctuation">(</span><span class="token punctuation">[</span>SIMPLE_THINK_NODE<span class="token punctuation">,</span> SIMPLE_CHECK_NODE<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 初始化过程，将上面实现的两个子节点加入作为THINK_NODES类的子节点</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fill</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> llm<span class="token punctuation">,</span> schema<span class="token operator">=</span><span class="token string">"raw"</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">,</span> strgy<span class="token operator">=</span><span class="token string">"complex"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>set_llm<span class="token punctuation">(</span>llm<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>set_context<span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>schema<span class="token punctuation">:</span>
            schema <span class="token operator">=</span> self<span class="token punctuation">.</span>schema

        <span class="token keyword">if</span> strgy <span class="token operator">==</span> <span class="token string">"simple"</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>simple_fill<span class="token punctuation">(</span>schema<span class="token operator">=</span>schema<span class="token punctuation">,</span> mode<span class="token operator">=</span>mode<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> strgy <span class="token operator">==</span> <span class="token string">"complex"</span><span class="token punctuation">:</span>
            <span class="token comment"># 这里隐式假设了拥有children</span>
            child_context <span class="token operator">=</span> context    <span class="token comment"># 输入context作为第一个子节点的context</span>
            <span class="token keyword">for</span> _<span class="token punctuation">,</span> i <span class="token keyword">in</span> self<span class="token punctuation">.</span>children<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                i<span class="token punctuation">.</span>set_context<span class="token punctuation">(</span>child_context<span class="token punctuation">)</span>    <span class="token comment"># 为子节点设置context</span>
                child <span class="token operator">=</span> <span class="token keyword">await</span> i<span class="token punctuation">.</span>simple_fill<span class="token punctuation">(</span>schema<span class="token operator">=</span>schema<span class="token punctuation">,</span> mode<span class="token operator">=</span>mode<span class="token punctuation">)</span>
                child_context <span class="token operator">=</span> child<span class="token punctuation">.</span>content    <span class="token comment"># 将返回内容（child.content）作为下一个子节点的context</span>

            self<span class="token punctuation">.</span>content <span class="token operator">=</span> child_context    <span class="token comment"># 最后一个子节点返回的内容设置为父节点返回内容（self.content）</span>
            <span class="token keyword">return</span> self


<span class="token keyword">class</span> <span class="token class-name">SimplePrint</span><span class="token punctuation">(</span>Action<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Action that print the num inputted
    """</span>
    input_num<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"SimplePrint"</span><span class="token punctuation">,</span> input_num<span class="token punctuation">:</span><span class="token builtin">int</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>input_num <span class="token operator">=</span> input_num

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>input_num<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>input_num<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">ThinkAction</span><span class="token punctuation">(</span>Action<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Action that think
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"ThinkAction"</span><span class="token punctuation">,</span> context<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> llm<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>node <span class="token operator">=</span> THINK_NODES<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 初始化Action时，初始化一个THINK_NODE实例并赋值给self.node</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instruction<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">:</span>
        PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
            You are now a number list generator, follow the instruction {instruction} and 
            generate a number list to be printed please.
            """</span>

        prompt <span class="token operator">=</span> PROMPT<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>instruction<span class="token operator">=</span>instruction<span class="token punctuation">)</span>
        rsp_node <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>node<span class="token punctuation">.</span>fill<span class="token punctuation">(</span>context<span class="token operator">=</span>prompt<span class="token punctuation">,</span> llm<span class="token operator">=</span>self<span class="token punctuation">.</span>llm<span class="token punctuation">,</span> schema<span class="token operator">=</span><span class="token string">"raw"</span><span class="token punctuation">,</span>
                                        strgy<span class="token operator">=</span><span class="token string">"complex"</span><span class="token punctuation">)</span>  <span class="token comment"># 运行子节点，获取返回（返回格式为ActionNode）（注意设置 schema="raw" ）</span>
        rsp <span class="token operator">=</span> rsp_node<span class="token punctuation">.</span>content  <span class="token comment"># 获取返回的文本内容</span>

        rsp_match <span class="token operator">=</span> self<span class="token punctuation">.</span>find_in_brackets<span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>  <span class="token comment"># 按列表格式解析返回的文本内容，定位“[”与“]”之间的内容</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            rsp_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> rsp_match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 按列表格式解析返回的文本内容，按“,”对内容进行分割，并形成一个python语法中的列表</span>

            <span class="token keyword">return</span> rsp_list
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">find_in_brackets</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pattern <span class="token operator">=</span> <span class="token string">r'\[(.*?)\]'</span>
        <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> s<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">match</span>

<span class="token keyword">class</span> <span class="token class-name">Printer</span><span class="token punctuation">(</span>Role<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"Jerry"</span><span class="token punctuation">,</span> profile<span class="token operator">=</span><span class="token string">"Printer"</span><span class="token punctuation">,</span> goal<span class="token operator">=</span><span class="token string">"Print the number"</span><span class="token punctuation">,</span> constraints<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_init_actions<span class="token punctuation">(</span><span class="token punctuation">[</span>ThinkAction<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># self.num_list = list()</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_think</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Determine the action"""</span>
        <span class="token comment"># logger.info(self.rc.state)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>todo <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>state <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>states<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>todo <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_prepare_print</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_list<span class="token punctuation">:</span><span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Message<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Add actions"""</span>
        actions <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> num <span class="token keyword">in</span> num_list<span class="token punctuation">:</span>
            actions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>SimplePrint<span class="token punctuation">(</span>input_num<span class="token operator">=</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_init_actions<span class="token punctuation">(</span>actions<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>todo <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">return</span> Message<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>num_list<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_act</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Message<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Action"""</span>
        todo <span class="token operator">=</span> self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>todo

        <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>todo<span class="token punctuation">)</span> <span class="token keyword">is</span> ThinkAction <span class="token punctuation">:</span>
            msg <span class="token operator">=</span> self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>goal <span class="token operator">=</span> msg<span class="token punctuation">.</span>content
            resp <span class="token operator">=</span> <span class="token keyword">await</span> todo<span class="token punctuation">.</span>run<span class="token punctuation">(</span>instruction<span class="token operator">=</span>self<span class="token punctuation">.</span>goal<span class="token punctuation">)</span>
            <span class="token comment"># logger.info(resp)</span>

            <span class="token keyword">return</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>_prepare_print<span class="token punctuation">(</span>resp<span class="token punctuation">)</span>

        resp <span class="token operator">=</span> <span class="token keyword">await</span> todo<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># logger.info(resp)</span>

        <span class="token keyword">return</span> Message<span class="token punctuation">(</span>content<span class="token operator">=</span>resp<span class="token punctuation">,</span> role<span class="token operator">=</span>self<span class="token punctuation">.</span>profile<span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_react</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Message<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""""""</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>_think<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> self<span class="token punctuation">.</span>rc<span class="token punctuation">.</span>todo <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            msg <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>_act<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> msg


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    msg <span class="token operator">=</span> <span class="token string">"Provide the first 10 numbers of the Fibonacci series"</span>
    role <span class="token operator">=</span> Printer<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> role<span class="token punctuation">.</span>run<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>result<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="22__456"></a>2.2 运行效果</h4> 
<p><img src="https://images2.imgbox.com/ed/1c/HgPk952X_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p><strong>本文代码是经过修改的，可以直接运行。</strong></p> 
 <ul><li>前提：使用 MetaGPT 0.6+ 的版本，我这里用的是github最新代码（2024-01-16），源码编译的。</li></ul> 
</blockquote> 
<p>未完待续… 请移步下篇文章 <a href="https://blog.csdn.net/Attitude93/article/details/135654693">【AI的未来 - AI Agent系列】【MetaGPT】4.1 细说我在ActionNode实战中踩的那些坑</a><br> <strong>带你绕过很多坑！</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c54e2a4df04c62af5d0a113f706a60fb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring boot中日志文件配置(已废)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8d080486c9091d4b151aa619f3a72c3a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android12 授予APK默认权限</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>