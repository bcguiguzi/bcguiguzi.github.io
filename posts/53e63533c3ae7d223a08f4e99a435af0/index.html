<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>spring4.2.5&#43;websocket&#43;sockjs&#43;stomp关于@MessageMapping注解的Controller类的方法不起作用的问题 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="spring4.2.5&#43;websocket&#43;sockjs&#43;stomp关于@MessageMapping注解的Controller类的方法不起作用的问题" />
<meta property="og:description" content="想要在站点里弄个站点内部通讯的小功能，遇到一个很神奇的问题：
加了注解的@MessageMapping的Controller类的方法如：
@MessageMapping(&#34;/send/{id}&#34;) @SendTo(&#34;/topic/{id}&#34;) public MessageEntity sendMesage(@Payload MessageEntity message){ return message; } 但是前端使用 ：
stompClient.send(&#39;/app/send/you&#39;,{},JSON.stringify({sender:&#39;me&#39;,type:&#39;E&#39;})); 前端页面发送没异常，后台也没异常，就是请求不到 上述的Controller加了注解的方法上面。
上网搜索一圈是结果，发现有个国外站点的问题和我这个类似
链接：
Spring 4 WebSocket &#43; sockJS:. Getting &#34;No matching method found&#34; in trace and @MessageMapping handler not invoked - Stack Overflow
其中有一个回答有点接近答案：
WebSocketConfig configuration class should be loaded as part of Servlet configuration, not Root configuration.
Make sure WebSocketConfig.class returned from your implementation of AbstractAnnotationConfigDispatcherServletInitializer.getRootConfigClasses()
If you put it in root context, everything will work fine, you can use SimpMessagingTemplate, broker relay, but not @MessageMapping in controllers." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/53e63533c3ae7d223a08f4e99a435af0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-17T18:49:40+08:00" />
<meta property="article:modified_time" content="2021-10-17T18:49:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">spring4.2.5&#43;websocket&#43;sockjs&#43;stomp关于@MessageMapping注解的Controller类的方法不起作用的问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p></p> 
<p>想要在站点里弄个站点内部通讯的小功能，遇到一个很神奇的问题：</p> 
<p>加了注解的@MessageMapping的Controller类的方法如：</p> 
<pre><code class="language-java">@MessageMapping("/send/{id}")
@SendTo("/topic/{id}")
public MessageEntity sendMesage(@Payload MessageEntity message){

     return message;

}</code></pre> 
<p>但是前端使用 ：</p> 
<pre><code class="language-java">stompClient.send('/app/send/you',{},JSON.stringify({sender:'me',type:'E'}));</code></pre> 
<p>前端页面发送没异常，后台也没异常，就是请求不到 上述的Controller加了注解的方法上面。</p> 
<p>上网搜索一圈是结果，发现有个国外站点的问题和我这个类似</p> 
<p>链接：</p> 
<p><a href="https://stackoverflow.com/questions/25129993/spring-4-websocket-sockjs-getting-no-matching-method-found-in-trace-and-m" rel="nofollow" title='Spring 4 WebSocket + sockJS:. Getting "No matching method found" in trace and @MessageMapping handler not invoked - Stack Overflow'>Spring 4 WebSocket + sockJS:. Getting "No matching method found" in trace and @MessageMapping handler not invoked - Stack Overflow</a></p> 
<p>其中有一个回答有点接近答案：</p> 
<p>WebSocketConfig configuration class should be loaded as part of Servlet configuration, not Root configuration.</p> 
<p>Make sure <code>WebSocketConfig.class</code> returned from your implementation of <code>AbstractAnnotationConfigDispatcherServletInitializer.getRootConfigClasses()</code></p> 
<p>If you put it in root context, everything will work fine, you can use SimpMessagingTemplate, broker relay, but not @MessageMapping in controllers.</p> 
<p>You can set breakpoint in <code>WebSocketAnnotationMethodMessageHandler.initControllerAdviceCache()</code> and check what beanss are loaded in context. If no <code>@Controller</code> marked bean in that method, <code>@MessageMapping</code> will not work.</p> 
<p>这段话的意思是：</p> 
<p>WebSocketConfig 配置类应该被当做Servlet配置加载，而不是 Root配置。请确保WebSocketConfig.class 从你的<code>AbstractAnnotationConfigDispatcherServletInitializer.getRootConfigClasses()实现中返回。</code></p> 
<p><code>你可以在WebSocketAnnotationMethodMessageHandler.initControllerAdviceCache()方法</code>中设置断点查看上下文有哪些beans被加载，如果没有 @Controler标记的 bean 在方法里。@MessageMapping 将不会发挥作用。</p> 
<hr> 
<p>但据我观察，我的这个类Controller是加载了的，而且其中的 一些action方法还可以执行。那问你可能就不是出在这个Controller没加载的问题。</p> 
<p>难道是WebSocketConfig加载顺序有问题？我就按网上其他人的答案，重写 集成 <code>AbstractAnnotationConfigDispatcherServletInitializer 这个类的方法。将WebSocketConfig.class 在 getServletConfigClasses 方法里返回。</code></p> 
<p style="text-align:center;"><code><img alt="" src="https://images2.imgbox.com/26/eb/MiQrRHmC_o.png"></code></p> 
<p>然后测试后并没啥卵用。依旧是访问不到。</p> 
<hr> 
<p>正在我要崩溃的时候，突然我想到了，加了注解@Controller类均被SpringMVC实例化加载的。他肯定不知道 @MessageMapping 注解是什么意思。而且这些消息通讯的动态接口要预先在WebSocket装配好才对呀。没装配的话，是不是WebSocketConfig在装配的时候，没有加载到这个Controller类，所以里面的加了注解 @MessageMapping的接口路径没有被注册上呢。</p> 
<p>鬼使神差的在 WebSocketConfig配置类上加了 @CompanentScan(basePackageClasses="ChatController.class") 在上面： <img alt="" src="https://images2.imgbox.com/3c/22/VlZXggTK_o.png"></p> 
<p>启动后，发现问你居然解决了。啊哈哈哈...这太扯淡了。</p> 
<p></p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2eb1da8396b7b8033fff2780ffbd3bd1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">常见的中间件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/efbedf94f79e775b364302ee0445118d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于FAT32文件系统的引导扇区</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>