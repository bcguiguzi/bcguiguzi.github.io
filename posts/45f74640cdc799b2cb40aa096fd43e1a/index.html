<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL之视图、存储过程 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL之视图、存储过程" />
<meta property="og:description" content="文章目录 视图基本概念使用语法示例 注意事项使用场景 存储过程介绍使用基本语法示例 参数INOUTINOUT 变量作用类型局部变量用户变量系统变量 存储函数定义示例 定义条件定义示例 处理程序定义示例 游标声明打开使用关闭 流程控制ifcaseloopleaveiteraterepeatwhile 触发器作用类型INSERTUPDATEDELETE 创建语法示例 查看删除 视图 基本概念 视图是一个虚拟表
内容由查询定义，和真实的表一样 视图根据基表创建
可以是多个基表 包含字段，数据源于对应的真实表（基表）
视图本身不存储数据 使用 语法 CREATE VIEW &lt;视图名&gt; AS &lt;SELECT语句&gt;;	-- 创建视图语法，使用 select 语句中获取的数据显示在视图中 create view view_name as select 语句;	-- 创建视图 alter view view_name as select 语句;	-- 修改视图 show create view view_name;	-- 显示视图创建指令 drop view view_name1,view_name2;	-- 删除（多个）视图 示例 -- 创建视图user_view， 只能查看 user 表中的 name、id、age 字段 create view user_view as select name, id, age from user select name, id, age from user_view;	-- 从视图表 user_view 中查询数据 show create view user_view;	-- 查看创建视图 user_view 的指令 alter view user_view as select id,name from user;	-- 修改视图 user_view: 在视图中只显示 id 和 name 字段数据	drop view user_view;	-- 删除视图 注意事项 视图创建后在磁盘中只有结构文件，没有数据文件" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/45f74640cdc799b2cb40aa096fd43e1a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-15T23:40:05+08:00" />
<meta property="article:modified_time" content="2022-09-15T23:40:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL之视图、存储过程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">视图</a></li><li><ul><li><a href="#_3" rel="nofollow">基本概念</a></li><li><a href="#_14" rel="nofollow">使用</a></li><li><ul><li><a href="#_16" rel="nofollow">语法</a></li><li><a href="#_30" rel="nofollow">示例</a></li></ul> 
    </li><li><a href="#_47" rel="nofollow">注意事项</a></li><li><a href="#_64" rel="nofollow">使用场景</a></li></ul> 
   </li><li><a href="#_80" rel="nofollow">存储过程</a></li><li><ul><li><a href="#_82" rel="nofollow">介绍</a></li><li><a href="#_111" rel="nofollow">使用</a></li><li><ul><li><a href="#_113" rel="nofollow">基本语法</a></li><li><a href="#_157" rel="nofollow">示例</a></li></ul> 
    </li><li><a href="#_188" rel="nofollow">参数</a></li><li><ul><li><a href="#IN_197" rel="nofollow">IN</a></li><li><a href="#OUT_223" rel="nofollow">OUT</a></li><li><a href="#INOUT_244" rel="nofollow">INOUT</a></li></ul> 
    </li><li><a href="#_258" rel="nofollow">变量</a></li><li><ul><li><a href="#_260" rel="nofollow">作用</a></li><li><a href="#_284" rel="nofollow">类型</a></li><li><ul><li><a href="#_286" rel="nofollow">局部变量</a></li><li><a href="#_317" rel="nofollow">用户变量</a></li><li><a href="#_365" rel="nofollow">系统变量</a></li></ul> 
    </li></ul> 
    </li><li><a href="#_394" rel="nofollow">存储函数</a></li><li><ul><li><a href="#_396" rel="nofollow">定义</a></li><li><a href="#_452" rel="nofollow">示例</a></li></ul> 
    </li><li><a href="#_469" rel="nofollow">定义条件</a></li><li><ul><li><a href="#_471" rel="nofollow">定义</a></li><li><a href="#_490" rel="nofollow">示例</a></li></ul> 
    </li><li><a href="#_500" rel="nofollow">处理程序</a></li><li><ul><li><a href="#_502" rel="nofollow">定义</a></li><li><a href="#_535" rel="nofollow">示例</a></li></ul> 
    </li><li><a href="#_558" rel="nofollow">游标</a></li><li><ul><li><a href="#_571" rel="nofollow">声明</a></li><li><a href="#_584" rel="nofollow">打开</a></li><li><a href="#_594" rel="nofollow">使用</a></li><li><a href="#_613" rel="nofollow">关闭</a></li></ul> 
    </li><li><a href="#_630" rel="nofollow">流程控制</a></li><li><ul><li><a href="#if_632" rel="nofollow">if</a></li><li><a href="#case_651" rel="nofollow">case</a></li><li><a href="#loop_690" rel="nofollow">loop</a></li><li><a href="#leave_721" rel="nofollow">leave</a></li><li><a href="#iterate_740" rel="nofollow">iterate</a></li><li><a href="#repeat_763" rel="nofollow">repeat</a></li><li><a href="#while_795" rel="nofollow">while</a></li></ul> 
    </li><li><a href="#_820" rel="nofollow">触发器</a></li><li><ul><li><a href="#_822" rel="nofollow">作用</a></li><li><a href="#_847" rel="nofollow">类型</a></li><li><ul><li><a href="#INSERT_860" rel="nofollow">INSERT</a></li><li><a href="#UPDATE_870" rel="nofollow">UPDATE</a></li><li><a href="#DELETE_882" rel="nofollow">DELETE</a></li></ul> 
     </li><li><a href="#_889" rel="nofollow">创建</a></li><li><ul><li><a href="#_891" rel="nofollow">语法</a></li><li><a href="#_929" rel="nofollow">示例</a></li></ul> 
     </li><li><a href="#_947" rel="nofollow">查看</a></li><li><a href="#_977" rel="nofollow">删除</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>视图</h3> 
<h4><a id="_3"></a>基本概念</h4> 
<ul><li> <p>视图是一个虚拟表</p> 
  <ul><li>内容由查询定义，和真实的表一样</li></ul> </li><li> <p>视图根据基表创建</p> 
  <ul><li>可以是多个基表</li></ul> </li><li> <p>包含字段，数据源于对应的真实表（基表）</p> 
  <ul><li>视图本身不存储数据</li></ul> </li></ul> 
<h4><a id="_14"></a>使用</h4> 
<h5><a id="_16"></a>语法</h5> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> <span class="token operator">&lt;</span>视图名<span class="token operator">&gt;</span> <span class="token keyword">AS</span> <span class="token operator">&lt;</span><span class="token keyword">SELECT</span>语句<span class="token operator">&gt;</span><span class="token punctuation">;</span>			<span class="token comment">-- 创建视图语法，使用 select 语句中获取的数据显示在视图中</span>

<span class="token keyword">create</span> <span class="token keyword">view</span> view_name <span class="token keyword">as</span> <span class="token keyword">select</span> 语句<span class="token punctuation">;</span>				<span class="token comment">-- 创建视图</span>

<span class="token keyword">alter</span> <span class="token keyword">view</span> view_name <span class="token keyword">as</span> <span class="token keyword">select</span> 语句<span class="token punctuation">;</span>				<span class="token comment">-- 修改视图</span>

<span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">view</span> view_name<span class="token punctuation">;</span>						<span class="token comment">-- 显示视图创建指令</span>

<span class="token keyword">drop</span> <span class="token keyword">view</span> view_name1<span class="token punctuation">,</span>view_name2<span class="token punctuation">;</span>				<span class="token comment">-- 删除（多个）视图</span>
</code></pre> 
<h5><a id="_30"></a>示例</h5> 
<pre><code class="prism language-sql"><span class="token comment">-- 创建视图user_view， 只能查看 user 表中的 name、id、age 字段</span>
<span class="token keyword">create</span> <span class="token keyword">view</span> user_view 
<span class="token keyword">as</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span> id<span class="token punctuation">,</span> age <span class="token keyword">from</span> <span class="token keyword">user</span>

<span class="token keyword">select</span> name<span class="token punctuation">,</span> id<span class="token punctuation">,</span> age <span class="token keyword">from</span> user_view<span class="token punctuation">;</span>			<span class="token comment">-- 从视图表 user_view 中查询数据</span>
	
<span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">view</span> user_view<span class="token punctuation">;</span>						<span class="token comment">-- 查看创建视图 user_view 的指令</span>
	
<span class="token keyword">alter</span> <span class="token keyword">view</span> user_view 
<span class="token keyword">as</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>name <span class="token keyword">from</span> <span class="token keyword">user</span><span class="token punctuation">;</span>					<span class="token comment">-- 修改视图 user_view: 在视图中只显示 id 和 name 字段数据		</span>
		
<span class="token keyword">drop</span> <span class="token keyword">view</span> user_view<span class="token punctuation">;</span>							<span class="token comment">-- 删除视图</span>
</code></pre> 
<h4><a id="_47"></a>注意事项</h4> 
<ul><li> <p>视图创建后在磁盘中只有结构文件，没有数据文件</p> 
  <ul><li>数据存储在基表中，select 语句定义视图的内容</li><li>每次使用视图都必须执行查询中所需的任何一个检索操作 
    <ul><li>如果用多个连接和过滤条件创建复杂的视图或嵌套视图，性能消耗会非常大</li></ul> </li></ul> </li><li> <p>视图的建立和删除只影响视图本身，不影响对应的基本表</p> 
  <ul><li>通过视图可以修改基表数据，基表的数据改变也会影响视图 
    <ul><li>因为视图中不存储数据，数据来自基表</li></ul> </li></ul> </li><li> <p>视图可以嵌套，即从其他视图中检索数据的查询来创建视图</p> 
  <ul><li>视图就是特殊的表</li></ul> </li><li> <p>创建视图需要足够的访问权限</p> </li><li> <p>创建视图的数目没有限制</p> </li><li> <p>视图不能索引，也不能有关联的触发器、默认值或规则</p> </li><li> <p>视图可以和表一起使用</p> </li></ul> 
<h4><a id="_64"></a>使用场景</h4> 
<ul><li>视图可隐藏基表的细节，应用于保密性比较高的系统</li><li>数据库只对外开放相关视图 
  <ul><li>Java 程序员对视图对象 CRUD</li></ul> </li><li>安全 
  <ul><li>表中有些字段存储重要信息，需要保密不能让用户直接看到 
    <ul><li>可以创建视图只保留一部分字段对外公开</li></ul> </li></ul> </li><li>性能 
  <ul><li>关系数据库的数据通常会分表存储，使用外键建立表的联系 
    <ul><li>此时查询操作通常用到 join，麻烦而且效率低</li></ul> </li><li>创建视图将相关表和字段结合在一起可避免使用 join 查询数据</li></ul> </li><li>灵活 
  <ul><li>原表因为设计问题即将废弃，但很多应用基于此表，不易修改</li><li>可创建视图，视图中的数据映射到原表，可以减少很多改动达到升级数据表的目的</li></ul> </li></ul> 
<h3><a id="_80"></a>存储过程</h3> 
<h4><a id="_82"></a>介绍</h4> 
<ul><li>存储过程(Stored Procedure)：一组用于完成特定数据库功能的SQL语句集，经过编译后存储在数据库系统中 
  <ul><li>使用时用户通过指定已经定义的存储过程名字并给出相应的存储过程参数来调用并执行它，从而完成一个或一系列的数据库操作</li></ul> </li><li>即<strong>数据库 SQL 语言层面的代码封装与重用</strong> 
  <ul><li>MySQL 5.0 版本开始支持存储过程</li></ul> </li><li>优点 
  <ol><li>存储过程可封装，隐藏复杂的逻辑</li><li>有助于提高性能 
    <ul><li>创建存储过程被编译后存储在数据库中 
      <ul><li><code>MySQL</code>实现的存储过程略有不同：按需编译</li><li>编译存储过程后 <code>MySQL</code> 将其放入缓存，为每个连接维护自己的存储过程高速缓存</li><li>应用程序在单个连接中多次使用存储过程，则使用编译版本，否则存储过程的工作方式类似于查询</li></ul> </li></ul> </li><li>有助于减少应用程序和数据库服务器之间的流量 
    <ul><li>应用程序不必发送多个冗长的SQL语句，只能发送存储过程的名称和参数</li></ul> </li><li>存储的程序对任何应用程序都是可重用的和透明的 
    <ul><li>存储过程将数据库接口暴露给所有应用程序，以便开发人员不必开发存储过程中已支持的功能</li></ul> </li><li>存储的程序是安全的 
    <ul><li>数据库管理员可以向访问数据库中存储过程的应用程序授予适当的权限，而不向基础数据库表提供任何权限</li></ul> </li></ol> </li><li>缺点 
  <ol><li>如果使用大量存储过程，那么使用的每个连接的内存使用量将会大大增加 
    <ul><li>如果您存储过程中过度使用大量逻辑操作，则CPU使用率也会增加 
      <ul><li>数据库服务器的设计不当于逻辑运算</li></ul> </li></ul> </li><li>开发具有复杂业务逻辑的存储过程变得更加困难 
    <ul><li>很难调试存储过程。只有少数数据库管理系统允许调试 
      <ul><li>MySQL不提供调试存储过程的功能</li></ul> </li></ul> </li><li>开发和维护存储过程并不容易 
    <ul><li>开发和维护存储过程通常需要专业技能</li></ul> </li></ol> </li></ul> 
<h4><a id="_111"></a>使用</h4> 
<h5><a id="_113"></a>基本语法</h5> 
<ul><li> <pre><code class="prism language-sql"><span class="token comment"># 创建简单存储过程</span>
<span class="token keyword">delimiter</span> $$ 			<span class="token comment">-- 修改语句结束符</span>
	<span class="token keyword">create</span> <span class="token keyword">procedure</span> 存储过程名<span class="token punctuation">(</span>参数类型 参数名 参数数据类型<span class="token punctuation">)</span>
		<span class="token keyword">begin</span>			<span class="token comment">-- 开始语句</span>
		<span class="token comment">-- 过程主体部分，若只有一条 SQL 语句，可省略 BEGIN-END 标志</span>
		<span class="token keyword">end</span> <span class="token operator">&amp;&amp;</span> 			<span class="token comment">-- 结束语句</span>
<span class="token keyword">delimiter</span> <span class="token punctuation">;</span> 			<span class="token comment">-- 恢复语句结束符</span>

<span class="token comment"># 调用存储过程</span>
<span class="token keyword">call</span> 存储过程名<span class="token punctuation">(</span>参数<span class="token punctuation">)</span>

<span class="token comment"># 删除存储过程</span>
<span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token punctuation">[</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">]</span> 存储过程名称<span class="token punctuation">;</span>

<span class="token comment"># 查看存储过程</span>
<span class="token keyword">SHOW</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'存储过程名'</span><span class="token punctuation">;</span>  
<span class="token comment"># 查看指定数据库中的存储过程</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> mysql<span class="token punctuation">.</span><span class="token keyword">proc</span> <span class="token keyword">where</span> db<span class="token operator">=</span><span class="token string">'数据库名'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> routine_name <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>routines <span class="token keyword">where</span> routine_schema<span class="token operator">=</span><span class="token string">'数据库名'</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">procedure</span> <span class="token keyword">status</span> <span class="token keyword">where</span> db<span class="token operator">=</span><span class="token string">'数据库名'</span><span class="token punctuation">;</span>

<span class="token comment"># 查看指定存储过程定义</span>
<span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">[</span>数据库<span class="token punctuation">.</span><span class="token punctuation">]</span>存储过程名<span class="token punctuation">;</span>

<span class="token comment"># 修改存储过程</span>
<span class="token keyword">ALTER</span> <span class="token keyword">PROCEDURE</span> 存储过程名 <span class="token punctuation">[</span> 特征 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
  <ul><li><code>特征</code>：指定存储过程的特性，可能取值有： 
    <ul><li><code>CONTAINS SQL</code>：表示子程序包含 SQL 语句，但不包含读或写数据的语句</li><li><code>NO SQL</code>：表示子程序中不包含 SQL 语句</li><li><code>READS SQL DATA</code>：表示子程序中包含读数据的语句</li><li><code>MODIFIES SQL DATA</code>：表示子程序中包含写数据的语句</li><li><code>SQL SECURITY { DEFINER |INVOKER }</code>：指明谁有权限来执行 
      <ul><li><code>DEFINER</code>：表示只有定义者自己才能够执行</li><li><code>INVOKER</code>：表示调用者可以执行</li></ul> </li><li><code>COMMENT 'string'</code>：表示注释信息</li></ul> </li><li><code>ALTER PROCEDURE</code> 语句修改存储过程的某些特征 
    <ul><li>修改存储过程的内容：先删除原存储过程，以相同的命名创建新的存储过程</li><li>修改存储过程的名称：先删除原存储过程，以不同的命名创建新的存储过程</li></ul> </li></ul> </li></ul> 
<h5><a id="_157"></a>示例</h5> 
<ul><li> <pre><code class="prism language-sql"><span class="token comment"># 创建简单存储过程</span>
<span class="token keyword">delimiter</span> $$						<span class="token comment">-- 修改标准语句分隔符为 &amp;&amp;</span>
 <span class="token keyword">create</span> <span class="token keyword">procedure</span> Demo<span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">-- 没有参数也必须有 ()</span>
   <span class="token keyword">begin</span>							<span class="token comment">-- 开始单个语句，直到 &amp;&amp; 结束</span>
   <span class="token comment">-- 主体部分，SQL 语句处理业务逻辑</span>
   <span class="token keyword">end</span> $$							<span class="token comment">-- 结束语句，可以有多个语句</span>
<span class="token keyword">delimiter</span><span class="token punctuation">;</span>							<span class="token comment">-- 恢复分隔符</span>

<span class="token comment"># 调用存储过程</span>
<span class="token keyword">call</span> Demo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 删除存储过程</span>
<span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> Demo<span class="token punctuation">;</span>

<span class="token comment"># 查看存储过程</span>
<span class="token keyword">show</span> <span class="token keyword">procedure</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'Demo'</span><span class="token punctuation">;</span>
<span class="token comment"># 查看指定数据库中的存储过程</span>
<span class="token keyword">select</span> name <span class="token keyword">from</span> mysql<span class="token punctuation">.</span><span class="token keyword">proc</span> <span class="token keyword">where</span> db<span class="token operator">=</span><span class="token string">'demo'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> routine_name <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>routines <span class="token keyword">where</span> routine_schema<span class="token operator">=</span><span class="token string">'demo'</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">procedure</span> <span class="token keyword">status</span> <span class="token keyword">where</span> db<span class="token operator">=</span><span class="token string">'demo'</span><span class="token punctuation">;</span>

<span class="token comment"># 查看指定存储过程定义</span>
<span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> demo<span class="token punctuation">.</span>Demo<span class="token punctuation">;</span>  

<span class="token comment"># 修改存储过程特征：将读写权限改为 MODIFIES SQL DATA，并指明调用者可以执行</span>
<span class="token keyword">ALTER</span> <span class="token keyword">PROCEDURE</span> Demo <span class="token keyword">MODIFIES</span> <span class="token keyword">SQL</span> <span class="token keyword">DATA</span> <span class="token keyword">SQL</span> SECURITY <span class="token keyword">INVOKER</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="_188"></a>参数</h4> 
<ul><li> <p>参数类型：<code>IN</code>、<code>OUT</code>、<code>INOUT</code></p> 
  <ul><li> <pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> 名称<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">IN</span><span class="token operator">|</span><span class="token keyword">OUT</span><span class="token operator">|</span><span class="token keyword">INOUT</span><span class="token punctuation">]</span> 参数名 参数数据类型 <span class="token punctuation">)</span>
<span class="token keyword">begin</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">end</span>
</code></pre> </li></ul> </li></ul> 
<h5><a id="IN_197"></a>IN</h5> 
<ul><li> <p>输入参数；一般只用于传入，在调用过程中一般<strong>不作为修改</strong>和返回</p> </li><li> <p>表示调用者向过程传入值，可以是字面量或变量</p> 
  <ul><li>参数的值必须在调用存储过程时指定</li></ul> </li><li> <p>不显示指定参数类型默认是 <code>in</code> 类型</p> </li><li> <pre><code class="prism language-sql"><span class="token keyword">delimiter</span> $$
 <span class="token keyword">create</span> <span class="token keyword">procedure</span> Demo<span class="token punctuation">(</span><span class="token operator">in</span> num2 <span class="token keyword">int</span><span class="token punctuation">)</span>			<span class="token comment">-- 没有参数也必须有 ()</span>
   <span class="token keyword">begin</span>	
		<span class="token keyword">select</span> num2<span class="token punctuation">;</span>						<span class="token comment">-- 显示 null</span>
		<span class="token keyword">set</span> num2 <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>						<span class="token comment">-- 参数赋值</span>
		<span class="token keyword">select</span> num2<span class="token punctuation">;</span>						<span class="token comment">-- 显示 7</span>
   <span class="token keyword">end</span> $$
<span class="token keyword">delimiter</span><span class="token punctuation">;</span>

<span class="token comment"># 调用存储过程</span>
<span class="token keyword">call</span> Demo<span class="token punctuation">(</span><span class="token variable">@num2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>							<span class="token comment">-- 显示 null，第一个查询</span>
<span class="token keyword">call</span> Demo<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>								<span class="token comment">-- 显示 5，第一个查询</span>
<span class="token keyword">select</span> <span class="token variable">@num2</span><span class="token punctuation">;</span>								<span class="token comment">-- null，未赋值</span>
</code></pre> </li></ul> 
<h5><a id="OUT_223"></a>OUT</h5> 
<ul><li> <p>输出参数；调用存储过程中，<strong>可改变</strong>其值并返回</p> 
  <ul><li>表示过程向调用者传出值，可返回多个值</li><li>调用存储过程时 <code>out</code> 参数也需要指定，但必须是变量，不能是常量</li></ul> <pre><code class="prism language-sql"><span class="token keyword">delimiter</span> $$
 <span class="token keyword">create</span> <span class="token keyword">procedure</span> Demo2<span class="token punctuation">(</span><span class="token keyword">out</span> num <span class="token keyword">int</span><span class="token punctuation">)</span>			<span class="token comment">-- 没有参数也必须有 ()</span>
   <span class="token keyword">begin</span>	
		<span class="token keyword">set</span> num <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>							<span class="token comment">-- 设置变量 num，修改变量值为 6</span>
		<span class="token keyword">select</span> num<span class="token punctuation">;</span>								<span class="token comment">-- 返回变量</span>
   <span class="token keyword">end</span> $$
<span class="token keyword">delimiter</span><span class="token punctuation">;</span>

<span class="token comment"># 调用存储过程</span>
<span class="token keyword">call</span> Demo2<span class="token punctuation">(</span><span class="token variable">@num</span><span class="token punctuation">)</span><span class="token punctuation">;</span>								<span class="token comment">-- 结果为 null</span>
<span class="token keyword">select</span> <span class="token variable">@num</span>										<span class="token comment">-- 变量值 @num = 6</span>
</code></pre> </li></ul> 
<h5><a id="INOUT_244"></a>INOUT</h5> 
<ul><li> <p>输入输出参数</p> 
  <ul><li>既表示调用者向过程传入值，又表示过程向调用者传出值</li><li>调用时可传入值，调用过程中可修改其值，也可返回值</li><li>调用时传入的是变量，而不是常量</li></ul> </li><li> <p>建议</p> 
  <ul><li>输入值使用<code>in</code>参数，返回值使用<code>out</code>参数 
    <ul><li><code>inout</code>参数就尽量的少用</li></ul> </li><li>参数的取名不要与数据表的列名相同 
    <ul><li>尽管不会返回出错信息，但存储过程的 SQL 语句会将参数名看作列名，从而引发不可预知的结果</li></ul> </li><li>没有参数也必须在过程名后面写上小括号</li></ul> </li></ul> 
<h4><a id="_258"></a>变量</h4> 
<h5><a id="_260"></a>作用</h5> 
<ul><li> <p>变量具有数据类型和长度</p> 
  <ul><li>与<code>mysql</code>的SQL数据类型保持一致</li><li>能制定默认值、字符集和排序规则等</li></ul> </li><li> <p>通过 <code>set</code> 赋值变量</p> 
  <ul><li> <p><code>SET</code> 语句可同时为多个变量赋值，各变量的赋值语句之间用逗号隔开</p> </li><li> <p>或通过 <code>select ... into ...</code> 方式赋值</p> 
    <ul><li> <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> col_name <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token keyword">INTO</span> var_name<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token keyword">FROM</span> table_name WEHRE condition
</code></pre> </li><li> <p>将查询结果赋值给变量时，该查询语句的返回结果只能是单行</p> </li></ul> </li></ul> </li><li> <p>使用 <code>select</code> 语句返回变量</p> 
  <ul><li>如：<code>select 变量名;</code></li></ul> </li></ul> 
<h5><a id="_284"></a>类型</h5> 
<h6><a id="_286"></a>局部变量</h6> 
<ul><li> <p><code>declare</code> 声明变量</p> 
  <ul><li>一个 <code>declare</code> 只声明一个变量</li></ul> </li><li> <p>局部变量必须先声明后使用</p> 
  <ul><li>仅用在 <code>BEGIN ... END</code> 复合语句中，且必须在开头任何其它语句之前</li></ul> </li><li> <p>可用在嵌套的块中，相同名字声明变量的块除外</p> </li><li> <p><code>DEFAULT</code> 子句设值默认值</p> 
  <ul><li>值可以是常数，或指定为表达式)</li><li>默认初始值为 NULL</li></ul> </li><li> <p>MySQL不支持数组作为局部变量</p> </li><li> <pre><code class="prism language-sql"><span class="token keyword">delimiter</span> $$
<span class="token keyword">create</span> <span class="token keyword">procedure</span> demo<span class="token punctuation">(</span><span class="token keyword">out</span> num1 <span class="token keyword">int</span><span class="token punctuation">)</span>						<span class="token comment">-- 输出参数</span>
<span class="token keyword">begin</span>
<span class="token keyword">declare</span> num2 <span class="token keyword">int</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> PLAYERS<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">-- 定义局部变量，默认值为 sql 语句结果</span>
<span class="token keyword">set</span> num1 <span class="token operator">=</span> num2<span class="token punctuation">;</span>										<span class="token comment">-- 赋值</span>
<span class="token keyword">end</span> $$		
<span class="token keyword">delimiter</span> <span class="token punctuation">;</span>
<span class="token keyword">call</span> demo<span class="token punctuation">(</span><span class="token variable">@num</span><span class="token punctuation">)</span><span class="token punctuation">;</span>										<span class="token comment">-- 调用存储过程，虽然是输出参数但必须指定</span>
<span class="token keyword">select</span> <span class="token variable">@num</span><span class="token punctuation">;</span>											<span class="token comment">-- 查询结果</span>
</code></pre> </li></ul> 
<h6><a id="_317"></a>用户变量</h6> 
<ul><li> <p>与数据库连接有关</p> </li><li> <p>当前连接中声明的变量，连接断开的时消失</p> 
  <ul><li>此连接中声明的变量无法在另一连接中使用</li></ul> </li><li> <p>用户变量名一般以 <code>@</code> 开头</p> 
  <ul><li>用户变量随处可以定义，随处可以使用 
    <ul><li>不定义也可以直接使用，值默认为 null</li></ul> </li><li>用户变量的变量名形式：<code>@var_name</code>，有 <code>@</code> 符号</li></ul> </li><li> <p>赋值</p> 
  <ul><li> <p><code>set</code> 语句</p> 
    <ul><li> <p>可使用 <code>=</code> 或 <code>:=</code> 作为分配符</p> </li><li> <p>变量可为整数、实数、字符串或者NULL值</p> </li></ul> </li><li> <p><code>select</code> 语句</p> 
    <ul><li>分配符必须为 <code>:=</code>，不能用 <code>=</code> 
      <ul><li>非 SET 语句中 <code>=</code> 被视比较操作符</li></ul> </li></ul> <pre><code class="prism language-sql"><span class="token keyword">set</span> <span class="token variable">@a</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>				<span class="token comment">-- 定义用户变量 @a，值为 1</span>
<span class="token keyword">select</span> <span class="token variable">@a</span><span class="token punctuation">;</span>				<span class="token comment">-- 查询变量 @a</span>
<span class="token keyword">select</span> <span class="token variable">@b</span> :<span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>   		<span class="token comment">-- 定义用户变量 @b，值为 2，并查询</span>
<span class="token keyword">select</span> <span class="token variable">@b</span><span class="token punctuation">;</span>				<span class="token comment">-- 查询变量 @</span>
</code></pre> </li></ul> </li><li> <p>区别局部变量</p> 
  <ul><li> <p>局部变量只有变量名字，没有 <code>@</code> 符号</p> 
    <ul><li>用户变量名前有 <code>@</code> 符号</li></ul> </li><li> <p>都是先定义，再使用</p> 
    <ul><li>未定义的变量，<code>select</code> 值为 <code>null</code></li></ul> </li><li> <p>局部变量只在存储过程内部使用，在过程体外没有意义</p> 
    <ul><li> <p><code>begin-end</code>块处理完后，局部变量消失</p> </li><li> <p>用户变量可以用在存储过程的内部和外部</p> </li><li> <p>在存储过程内部，使用局部变量，不要使用用户变量</p> </li></ul> </li></ul> </li></ul> 
<h6><a id="_365"></a>系统变量</h6> 
<ul><li> <p>根据系统变量的作用域分为：<strong>全局变量</strong> 、<strong>会话变量</strong></p> 
  <ul><li> <p>通过 <code>@@</code> 或 <code>global</code> 操作系统变量</p> <pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> sort_buffer_size<span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">SET</span> @<span class="token variable">@global.sort_buffer_size</span><span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><code>MySQL</code> 变量类似于动态语言，变量值随所要赋的值的类型而改变</p> </li></ul> </li><li> <p>全局变量：<code>@@global</code></p> 
  <ul><li> <p><code>MySQL</code> 启动时由服务器自动将全局变量初始化为默认值</p> </li><li> <p>默认值可通过更改配置文件 <code>my.ini</code>、<code>my.cnf</code> 修改</p> </li></ul> </li><li> <p>会话变量：<code>@@session</code></p> 
  <ul><li>每次建立新的连接时由 <code>MySQL</code> 初始化</li><li>建立会话后没有手动更改过会话变量与全局变量。那么这些变量的值都一样的</li><li>全局变量的修改影响到整个服务器，会话变量的修改，只影响当前的会话</li></ul> </li><li> <p><code>set</code> 系统变量时，不带作用域修饰默认指会话作用域</p> 
  <ul><li>部分系统变量不带作用域修饰无法设置，因此最好都带上作用域设置系统变量</li></ul> </li></ul> 
<h4><a id="_394"></a>存储函数</h4> 
<h5><a id="_396"></a>定义</h5> 
<ul><li> <p>和存储过程一样，都是在数据库中定义一些 SQL 语句的集合</p> 
  <ul><li>存储函数和存储过程的查看、修改、删除等操作几乎相同</li></ul> </li><li> <p>存储函数可以通过 return 语句返回函数值，主要用于<strong>计算并返回一个值</strong></p> 
  <ul><li>存储过程没有直接返回值，主要用于<strong>执行操作</strong></li></ul> </li><li> <p><code>CREATE FUNCTION</code> 语句创建存储函数</p> 
  <ul><li> <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> 函数名称 <span class="token punctuation">(</span><span class="token punctuation">[</span>func_parameter <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">type</span>
<span class="token punctuation">[</span>characteristic <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
routine_body
</code></pre> 
    <ul><li> <p><code>func_parameter</code>：函数的参数列表</p> 
      <ul><li>参数列表可由多个参数组成</li><li>每个参数由参数名称和参数类型组成：<code>[IN | OUT | INOUT] param_name type;</code></li></ul> </li><li> <p><code>RETURNS type</code>：指定返回值的类型</p> 
      <ul><li>如果 <code>RETURN</code> 语句返回类型不同于函数指定类型的值，返回值将被强制为恰当的类型</li><li>例：函数返回 <code>ENUM</code> 或 <code>SET</code> 值，但 <code>RETURN</code> 语句返回整数 
        <ul><li>对 <code>SET</code> 成员集的相应 <code>ENUM</code> 成员，从函数返回的值是字符串</li></ul> </li></ul> </li><li> <p><code>characteristic</code> 参数：指定存储函数的特性</p> 
      <ul><li>取值与存储过程一样</li></ul> </li><li> <p><code>routine_body</code> 参数：表示 SQL 代码的内容</p> 
      <ul><li>可用 <code>BEGIN...END</code> 来标示 SQL 代码的开始和结束</li></ul> </li></ul> </li><li> <p>创建函数时函数名不允许重复</p> 
    <ul><li>推荐函数名命名（标识符）：<code>function_xxx</code> 或 <code>func_xxx</code></li></ul> </li></ul> </li><li> <p>查询</p> 
  <ul><li> <pre><code class="prism language-sql"><span class="token comment"># 查询函数</span>
<span class="token keyword">SHOW</span> <span class="token keyword">FUNCTION</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> 存储函数名<span class="token punctuation">;</span>
<span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> 存储函数名<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>Routines <span class="token keyword">WHERE</span> ROUTINE_NAME <span class="token operator">=</span> 存储函数名<span class="token punctuation">;</span>

<span class="token comment"># 修改函数</span>
<span class="token keyword">ALTER</span> <span class="token keyword">FUNCTION</span> 存储函数名 <span class="token punctuation">[</span> 特征 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span>；  <span class="token comment">-- 存储函数的特征与存储过程的基本一样</span>

<span class="token comment"># 删除存储过程</span>
<span class="token keyword">DROP</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">[</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">]</span> <span class="token operator">&lt;</span>函数名<span class="token operator">&gt;</span>；
</code></pre> </li></ul> </li><li> <p>调用</p> 
  <ul><li>存储函数的使用方法与 MySQL 内部函数的使用方法是一样的 
    <ul><li>用户自己定义的存储函数与 MySQL 内部函数性质一样</li></ul> </li></ul> </li></ul> 
<h5><a id="_452"></a>示例</h5> 
<ul><li> <pre><code class="prism language-sql"><span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> func_student<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment">-- 创建存储函数</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>								<span class="token comment">-- 指定返回值类型</span>
<span class="token keyword">COMMENT</span> <span class="token string">'查询某个学生的姓名'</span>						 <span class="token comment">-- 指定注释特征</span>
<span class="token keyword">BEGIN</span>											<span class="token comment">-- 开始</span>
<span class="token keyword">RETURN</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> tb_student <span class="token keyword">WHERE</span> tb_student<span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">-- 函数体，执行sql</span>
<span class="token keyword">END</span> $$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token comment">-- 该函数拥有一个类型为 INT(11) 的参数 id，返回值为 VARCHAR(20) 类型</span>
<span class="token comment">-- SELECT 语句从 tb_student 表中查询 id 字段值等于所传入参数 id 值的记录，同时返回该条记录的 name 字段值</span>

<span class="token keyword">SELECT</span> func_student<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">-- 调用自定义函数</span>
</code></pre> </li></ul> 
<h4><a id="_469"></a>定义条件</h4> 
<h5><a id="_471"></a>定义</h5> 
<ul><li> <p>事先定义程序执行过程中遇到的问题，定义遇到这些问题时应当采取的处理方式和解决办法</p> 
  <ul><li>保证存储过程和函数在遇到警告或错误时能继续执行</li><li>增强程序处理问题的能力，避免程序出现异常被停止执行</li></ul> </li><li> <p><code>DECLARE</code> 关键字定义条件</p> 
  <ul><li> <pre><code class="prism language-sql"><span class="token keyword">DECLARE</span> 条件名称 CONDITION <span class="token keyword">FOR</span> condition_value<span class="token punctuation">;</span>
</code></pre> 
    <ul><li>condition_name 参数表示条件的名称</li><li>condition_value 参数表示条件的类型 
      <ul><li><code>sqlstate_value</code> ：表示长度为 5 的字符串类型错误代码</li><li><code>mysql_error_code</code>：表示数值类型错误代码 
        <ul><li>例：<code>ERROR 1146(42S02)</code> 中，<code>sqlstate_value</code> 值是 42S02，<code>mysql_error_code</code> 值是 1146</li></ul> </li></ul> </li></ul> </li></ul> </li></ul> 
<h5><a id="_490"></a>示例</h5> 
<ul><li> <pre><code class="prism language-sql"><span class="token comment"># sqlstate_value</span>
<span class="token keyword">DECLARE</span> can_not_find CONDITION <span class="token keyword">FOR</span> SQLSTATE <span class="token string">'42S02'</span><span class="token punctuation">;</span>

<span class="token comment"># mysql_error_code</span>
<span class="token keyword">DECLARE</span> can_not_find CONDITION <span class="token keyword">FOR</span> <span class="token number">1146</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="_500"></a>处理程序</h4> 
<h5><a id="_502"></a>定义</h5> 
<ul><li> <p><code>DECLARE</code> 关键字定义处理程序。其基本语法如下：</p> 
  <ul><li> <pre><code class="prism language-sql"><span class="token keyword">DECLARE</span> handler_type <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> condition_value<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> sp_statement
</code></pre> 
    <ul><li> <p><code>handler_type</code> 参数：指明错误的处理方式</p> 
      <ul><li> <p>该参数有 3 个取值：<code>CONTINUE</code>、<code>EXIT</code> 和 <code>UNDO</code></p> 
        <ul><li> <p><code>CONTINUE</code>：遇到错误不进行处理，继续向下执行</p> </li><li> <p><code>EXIT</code>：遇到错误后马上退出</p> </li><li> <p><code>UNDO</code>：遇到错误后撤回之前的操作，MySQL 暂不支持</p> </li></ul> </li><li> <p>通常执行过程中遇到错误应该立刻停止执行并撤回操作</p> </li></ul> </li><li> <p><code>condition_value</code>：指明错误类型，有 6 个取值</p> 
      <ul><li><code>sqlstate_value</code>：包含 5 个字符的字符串错误值</li><li><code>condition_name</code>：表示 DECLARE 定义的错误条件名称</li><li><code>SQLWARNING</code>：匹配所有以 01 开头的 <code>sqlstate_value</code> 值</li><li><code>NOT FOUND</code>：匹配所有以 02 开头的 <code>sqlstate_value</code> 值</li><li><code>SQLEXCEPTION</code>：匹配所有没有被 <code>SQLWARNING</code> 或 <code>NOT FOUND</code> 捕获的 <code>sqlstate_value</code> 值</li><li><code>mysql_error_code</code>：匹配数值类型错误代码</li></ul> </li><li> <p><code>sp_statement</code> 参数：程序语句段</p> 
      <ul><li>表示遇到定义的错误时，需要执行的一些存储过程或函数</li></ul> </li></ul> </li></ul> </li></ul> 
<h5><a id="_535"></a>示例</h5> 
<ul><li> <pre><code class="prism language-sql"><span class="token comment"># 捕获 sqlstate_value：遇到 sqlstate_value 值为 42S02，执行 CONTINUE 操作并输出 CAN NOT FIND 信息</span>
<span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> SQLSTATE <span class="token string">'42S02'</span> <span class="token keyword">SET</span> <span class="token variable">@info</span><span class="token operator">=</span><span class="token string">'CAN NOT FIND'</span><span class="token punctuation">;</span>

<span class="token comment"># 捕获 mysql_error_code：遇到 mysql_error_code 值为 1146， 执行 CONTINUE 操作并输出 CAN NOT FIND 信息</span>
<span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token number">1146</span> <span class="token keyword">SET</span> <span class="token variable">@info</span><span class="token operator">=</span><span class="token string">'CAN NOT FIND'</span><span class="token punctuation">;</span>

<span class="token comment"># 先定义条件，然后调用：先定义 can_not_find 条件，遇到 1146 错误就执行 CONTINUE 操作</span>
<span class="token keyword">DECLARE</span> can_not_find CONDITION <span class="token keyword">FOR</span> <span class="token number">1146</span><span class="token punctuation">;</span>
<span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> can_not_find <span class="token keyword">SET</span> <span class="token variable">@info</span><span class="token operator">=</span><span class="token string">'CAN NOT FIND'</span><span class="token punctuation">;</span>

<span class="token comment"># 使用 SQLWARNING：捕获所有 01 开头的 sqlstate_value 值，然后执行 EXIT 操作并输出 ERROR 信息</span>
<span class="token keyword">DECLARE</span> <span class="token keyword">EXIT</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> SQLWARNING <span class="token keyword">SET</span> <span class="token variable">@info</span><span class="token operator">=</span><span class="token string">'ERROR'</span><span class="token punctuation">;</span>

<span class="token comment"># 使用 NOT FOUND：捕获所有 02 开头的 sqlstate_value 值，然后执行 EXIT 操作并输出 CAN NOT FIND 信息</span>
<span class="token keyword">DECLARE</span> <span class="token keyword">EXIT</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND <span class="token keyword">SET</span> <span class="token variable">@info</span><span class="token operator">=</span><span class="token string">'CAN NOT FIND'</span><span class="token punctuation">;</span>

<span class="token comment"># 使用 SQLEXCEPTION：捕获所有没有被 SQLWARNING 或 NOT FOUND 捕获的 sqlstate_value 值，然后执行 EXIT 操作并输出 ERROR 信息</span>
<span class="token keyword">DECLARE</span> <span class="token keyword">EXIT</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> SQLEXCEPTION <span class="token keyword">SET</span> <span class="token variable">@info</span><span class="token operator">=</span><span class="token string">'ERROR'</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="_558"></a>游标</h4> 
<ul><li> <p>MySQL 中存储过程或函数的查询有时返回多条记录</p> 
  <ul><li>简单的 SELECT 语句无法得到指定数据，使用游标逐条读取查询结果集中的记录</li><li>游标在部分资料中也被称为光标</li></ul> </li><li> <p>一般通过游标定位到结果集的某一行进行数据修改</p> 
  <ul><li> <p>结果集是符合 SQL 语句的所有记录的集合</p> </li><li> <p>不像多数 DBMS，MySQL 游标只能用于存储过程和函数</p> </li></ul> </li></ul> 
<h5><a id="_571"></a>声明</h5> 
<ul><li> <p><code>DECLARE</code> 关键字声明游标，并定义相应的 SELECT 语句</p> 
  <ul><li> <p>根据需要添加 WHERE 和其它子句</p> </li><li> <pre><code class="prism language-sql"><span class="token keyword">DECLARE</span> cursor_name <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> select_statement<span class="token punctuation">;</span>
</code></pre> 
    <ul><li><code>cursor_name</code>：游标名称</li><li><code>select_statement</code> ：SELECT 语句，可以返回一行或多行数据</li></ul> </li></ul> </li></ul> 
<h5><a id="_584"></a>打开</h5> 
<ul><li>想从游标中提取数据，必须首先打开游标 
  <ul><li><code>MySQL</code> 通过 <code>OPEN</code> 关键字打开游标</li><li><code>OPEN cursor_name;</code> 
    <ul><li><code>cursor_name</code>：所要打开游标的名称</li><li>打开一个游标时，游标并不指向第一条记录，而是指向第一条记录的前边</li></ul> </li></ul> </li><li>程序中一个游标可以打开多次 
  <ul><li>用户打开游标后，其他用户或程序可能正在更新数据表，所以有时会导致用户每次打开游标后显示的结果都不同</li></ul> </li></ul> 
<h5><a id="_594"></a>使用</h5> 
<ul><li> <p>使用 <code>FETCH...INTO</code> 语句读取数据</p> 
  <ul><li> <pre><code class="prism language-sql"><span class="token keyword">FETCH</span> cursor_name <span class="token keyword">INTO</span> var_name <span class="token punctuation">[</span><span class="token punctuation">,</span>var_name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
    <ul><li>将游标 <code>cursor_name</code> 中 <code>SELECT</code> 语句的执行结果保存到变量参数 <code>var_name</code> 
      <ul><li>变量参数 <code>var_name</code> 必须在游标使用之前定义</li></ul> </li></ul> </li></ul> </li><li> <p>使用游标类似高级语言中的数组遍历</p> 
  <ul><li>当第一次使用游标时，此时游标指向结果集的第一条记录</li></ul> </li><li> <p><code>MySQL</code> 的游标是只读的</p> 
  <ul><li>只能顺序地从开始往后读取结果集，不能从后往前，也不能直接跳到中间的记录</li></ul> </li></ul> 
<h5><a id="_613"></a>关闭</h5> 
<ul><li> <p>游标使用完毕后，要及时关闭</p> 
  <ul><li> <p>MySQL 中使用 <code>CLOSE</code> 关键字关闭游标</p> </li><li> <p><code>CLOSE cursor_name;</code></p> </li></ul> </li><li> <p><code>CLOSE</code> 释放游标使用的所有内部内存和资源，因此每个游标不再需要时都应该关闭</p> </li><li> <p>一个游标关闭后，如果没有重新打开，则不能使用它</p> 
  <ul><li> <p>但使用声明过的游标不需要再次声明，用 <code>OPEN</code> 语句打开即可</p> </li><li> <p>如果不明确关闭游标，MySQL 将会在到达 <code>END</code> 语句时自动关闭</p> </li><li> <p>游标关闭后不能使用 <code>FETCH</code> 使用该游标</p> </li></ul> </li></ul> 
<h4><a id="_630"></a>流程控制</h4> 
<h5><a id="if_632"></a>if</h5> 
<ul><li> <p>进行条件判断</p> 
  <ul><li> <pre><code class="prism language-sql"><span class="token keyword">if</span> search_condition <span class="token keyword">then</span> statement_list
    <span class="token punctuation">[</span><span class="token keyword">elseif</span> search_condition <span class="token keyword">then</span> statement_list<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token keyword">else</span> statement_list<span class="token punctuation">]</span>
<span class="token keyword">end</span> <span class="token keyword">if</span>
</code></pre> 
    <ul><li><code>search_condition</code>：条件判断语句 
      <ul><li>返回值 TRUE 执行 then 后语句列表 statement_list</li><li>返回值 FALSE，则 ELSE 子句的语句列表被执行 
        <ul><li>statement_list 可以包括一个或多个语句</li></ul> </li></ul> </li><li>使用 <code>end if</code> 结束 <code>if</code> 语句</li></ul> </li></ul> </li><li> <p>MySQL 中的 IF( ) 函数不同于 IF 语句</p> </li></ul> 
<h5><a id="case_651"></a>case</h5> 
<ul><li> <p>进行条件判断</p> 
  <ul><li> <p>提供了多个条件进行选择，可实现比 IF 语句更复杂的条件判断</p> </li><li> <pre><code class="prism language-sql"><span class="token keyword">CASE</span> case_value
    <span class="token keyword">WHEN</span> when_value <span class="token keyword">THEN</span> statement_list
    <span class="token punctuation">[</span><span class="token keyword">WHEN</span> when_value <span class="token keyword">THEN</span> statement_list<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">[</span><span class="token keyword">ELSE</span> statement_list<span class="token punctuation">]</span>
<span class="token keyword">END</span> <span class="token keyword">CASE</span>
</code></pre> 
    <ul><li> <p><code>case_value</code>：条件判断的变量，决定哪一个 WHEN 子句会被执行</p> </li><li> <p><code>when_value</code>：变量的取值</p> 
      <ul><li><code>when_value</code> 表达式与 <code>case_value</code> 变量值相同，执行对应 THEN 关键字后的 statement_list 中的语句</li><li>没有条件匹配，ELSE 子句里的语句被执行</li></ul> </li><li> <p><code>CASE</code> 语句都要使用 <code>END CASE</code> 结束</p> </li></ul> </li></ul> </li><li> <p>另一种形式</p> 
  <ul><li> <pre><code class="prism language-sql"><span class="token keyword">CASE</span>
    <span class="token keyword">WHEN</span> search_condition <span class="token keyword">THEN</span> statement_list
    <span class="token punctuation">[</span><span class="token keyword">WHEN</span> search_condition <span class="token keyword">THEN</span> statement_list<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">[</span><span class="token keyword">ELSE</span> statement_list<span class="token punctuation">]</span>
<span class="token keyword">END</span> <span class="token keyword">CASE</span>
</code></pre> 
    <ul><li>该语句中 <code>WHEN</code> 语句将被逐个执行 
      <ul><li>直到 <code>search_condition</code> 表达式为真，执行对应 <code>THEN</code> 关键字后的 <code>statement_list</code> 语句</li><li>没有条件匹配 ELSE 子句里的语句被执行</li></ul> </li></ul> </li></ul> </li><li> <p><code>CASE</code> 语句与 <code>SQL CASE</code> 表达式的 <code>CASE</code> 语句有轻微不同</p> 
  <ul><li><code>CASE</code> 语句不能有 <code>ELSE NULL</code> 语句，且用 <code>END CASE</code> 替代 <code>END</code> 终止</li></ul> </li></ul> 
<h5><a id="loop_690"></a>loop</h5> 
<ul><li> <p>可以使某些特定的语句重复执行</p> 
  <ul><li> <p>只实现了一个简单的循环，并不进行条件判断</p> </li><li> <p><code>LOOP</code> 语句本身没有停止循环的语句，必须使用 <code>LEAVE</code> 语句等才能停止循环，跳出循环过程</p> </li></ul> </li><li> <pre><code class="prism language-sql"><span class="token punctuation">[</span>begin_label:<span class="token punctuation">]</span> <span class="token keyword">LOOP</span>
    statement_list
<span class="token keyword">END</span> <span class="token keyword">LOOP</span> <span class="token punctuation">[</span>end_label<span class="token punctuation">]</span>
</code></pre> 
  <ul><li> <p><code>begin_label</code> 和 <code>end_label</code> ：循环开始和结束的标志</p> 
    <ul><li>两个标志必须相同，且都可以省略</li></ul> </li><li> <p><code>statement_list</code>：需要循环执行的语句</p> </li><li> <p><code>LOOP</code> 循环都以 <code>END LOOP</code> 结束</p> </li><li> <p>例</p> 
    <ul><li> <pre><code class="prism language-sql">add_num:<span class="token keyword">LOOP</span>
    <span class="token keyword">SET</span> <span class="token variable">@count</span><span class="token operator">=</span><span class="token variable">@count</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">LOOP</span> add_num<span class="token punctuation">;</span>
<span class="token comment">-- 循环执行 count 加 1 操作，没有跳出循环的语句，循环成为死循环</span>
</code></pre> </li></ul> </li></ul> </li></ul> 
<h5><a id="leave_721"></a>leave</h5> 
<ul><li> <p>用于跳出循环控制，类似 <code>Java</code> 的 <code>return</code></p> 
  <ul><li> <p><code>LEAVE label</code></p> </li><li> <p><code>label</code> ：循环的标志，<code>LEAVE</code> 语句必须跟在循环标志前面</p> </li></ul> </li><li> <p>例</p> 
  <ul><li> <pre><code class="prism language-sql">add_num:<span class="token keyword">LOOP</span>
    <span class="token keyword">SET</span> <span class="token variable">@count</span><span class="token operator">=</span><span class="token variable">@count</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">IF</span> <span class="token variable">@count</span><span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">THEN</span>
        <span class="token keyword">LEAVE</span> add_num<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">LOOP</span> <span class="token keyword">add</span> num<span class="token punctuation">;</span>
<span class="token comment">-- 循环执行 count 加 1 的操作，当 count 的值等于 100 时，跳出循环</span>
</code></pre> </li></ul> </li></ul> 
<h5><a id="iterate_740"></a>iterate</h5> 
<ul><li> <p>再次循环；用来跳出本次循环，直接进入下一次循环；类似 <code>Java</code> 的 <code>continue</code></p> 
  <ul><li> <p><code>ITERATE label</code></p> </li><li> <p><code>label</code>：循环的标志，<code>ITERATE</code> 语句必须跟在循环标志前面</p> </li></ul> </li><li> <p>例</p> 
  <ul><li> <pre><code class="prism language-sql">add_num:<span class="token keyword">LOOP</span>
    <span class="token keyword">SET</span> <span class="token variable">@count</span><span class="token operator">=</span><span class="token variable">@count</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">IF</span> <span class="token variable">@count</span><span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">THEN</span>
        <span class="token keyword">LEAVE</span> add_num<span class="token punctuation">;</span>
    <span class="token keyword">ELSE</span> <span class="token keyword">IF</span> <span class="token function">MOD</span><span class="token punctuation">(</span><span class="token variable">@count</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">THEN</span>
        <span class="token keyword">ITERATE</span> add_num<span class="token punctuation">;</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employee<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">LOOP</span> add_num<span class="token punctuation">;</span>
<span class="token comment">-- 循环执行 count 加 1 操作，count 值为 100 时结束循环</span>
<span class="token comment">-- 如果 count 的值能够整除 3，则跳出本次循环，不再执行下面的 SELECT 语句</span>
</code></pre> </li></ul> </li></ul> 
<h5><a id="repeat_763"></a>repeat</h5> 
<ul><li> <p>条件控制的循环语句；类似 <code>Java</code> 中 <code>do … while()</code></p> 
  <ul><li> <p>每次语句执行完毕后对条件表达式进行判断</p> 
    <ul><li>表达式返回值为 TRUE，则循环结束</li><li>否则重复执行循环中的语句</li></ul> </li><li> <pre><code class="prism language-sql"><span class="token punctuation">[</span>begin_label:<span class="token punctuation">]</span> <span class="token keyword">repeat</span>
  statement_list
  until search_condition
<span class="token keyword">end</span> <span class="token keyword">repeat</span> <span class="token punctuation">[</span>end_label<span class="token punctuation">]</span>
</code></pre> 
    <ul><li> <p><code>begin_label</code>：为 REPEAT 语句的标注名称，可省略</p> </li><li> <p><code>REPEAT</code> 内语句重复执行，直至 <code>search_condition</code> 返回值为 TRUE</p> </li><li> <p><code>REPEAT</code> 循环都用 <code>END REPEAT</code> 结束</p> </li></ul> </li></ul> </li><li> <p>例</p> 
  <ul><li> <pre><code class="prism language-sql"><span class="token keyword">REPEAT</span>
    <span class="token keyword">SET</span> <span class="token variable">@count</span><span class="token operator">=</span><span class="token variable">@count</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    UNTIL <span class="token variable">@count</span><span class="token operator">=</span><span class="token number">100</span>
<span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
<span class="token comment">-- 循环执行 count 加 1 的操作，count 值为 100 时结束循环</span>
</code></pre> </li></ul> </li></ul> 
<h5><a id="while_795"></a>while</h5> 
<ul><li> <p>条件控制的循环语句</p> 
  <ul><li> <p>当满足条件时，执行循环内的语句，否则退出循环</p> </li><li> <pre><code class="prism language-sql"><span class="token punctuation">[</span>begin_label:<span class="token punctuation">]</span> 
<span class="token keyword">WHILE</span> search_condition 
	<span class="token keyword">DO</span> statement list
<span class="token keyword">END</span> <span class="token keyword">WHILE</span> <span class="token punctuation">[</span><span class="token keyword">end</span> label<span class="token punctuation">]</span>
</code></pre> 
    <ul><li><code>search_condition</code>：循环执行的条件，满足该条件时循环执行</li><li><code>WHILE</code> 循环需要使用 <code>END WHILE</code> 结束</li></ul> </li></ul> </li><li> <p>例</p> 
  <ul><li> <pre><code class="prism language-sql"><span class="token keyword">WHILE</span> <span class="token variable">@count</span> <span class="token operator">&lt;</span> <span class="token number">100</span> 
	<span class="token keyword">DO</span> <span class="token keyword">SET</span> <span class="token variable">@count</span><span class="token operator">=</span><span class="token variable">@count</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
<span class="token comment">-- 循环执行 count 加 1 的操作，count 值小于 100 时执行循环。如果 count 值等于 100 了，则跳出循环</span>
</code></pre> </li></ul> </li></ul> 
<h4><a id="_820"></a>触发器</h4> 
<h5><a id="_822"></a>作用</h5> 
<ul><li>嵌入到 MySQL 中的一段程序，MySQL 中管理数据的有力工具 
  <ul><li>执行存储过程使用 <code>CALL</code> 语句调用</li><li>触发器的执行不需要使用 <code>CALL</code> 语句调用，也不需要手工启动 
    <ul><li>通过对数据表的相关操作来触发、激活从而实现执行</li><li>例：对指定表进行操作（INSERT，DELETE 或 UPDATE）时激活执行</li></ul> </li></ul> </li><li>触发器与数据表关系密切，主要用于保护表中的数据 
  <ul><li>当多个表具有一定的相互联系时，触发器能够让不同的表保持数据的一致性</li></ul> </li><li>MySQL 中，只有执行 <code>INSERT</code>、<code>UPDATE</code> 和 <code>DELETE</code> 操作才能激活触发器 
  <ul><li>其它 SQL 语句不会激活触发器</li></ul> </li><li>数据表发生更改时需要自动进行一些处理，可以使用触发器 
  <ul><li>对于一张表中记录进行操作后需要同步操作其他表中相关记录，使用触发器完成</li></ul> </li><li>优点 
  <ol><li>自动执行 
    <ul><li>当对触发器相关表的数据做出相应的修改后立即执行</li></ul> </li><li>可实施比 <code>FOREIGN KEY</code> 约束、<code>CHECK</code> 约束更为复杂的检查和操作</li><li>可实现表数据的级联更改 
    <ul><li>一定程度上保证了数据的完整性。</li></ul> </li></ol> </li><li>缺点 
  <ol><li>使用触发器实现的业务逻辑在出现问题时很难进行定位 
    <ul><li>特别是涉及到多个触发器的情况下，会使后期维护变得困难</li></ul> </li><li>大量使用触发器容易导致代码结构被打乱，增加了程序的复杂性</li><li>如果需要变动的数据量较大时，触发器的执行效率会非常低</li></ol> </li></ul> 
<h5><a id="_847"></a>类型</h5> 
<ul><li> <p>触发器使用的过程中，MySQL 按照以下方式处理错误</p> 
  <ul><li> <p>对于事务性表：如果触发程序失败，以及由此导致的整个语句失败，那么该语句所执行的所有更改将回滚</p> </li><li> <p>对于非事务性表：不能执行此类回滚，即使语句失败，失败之前所做的任何更改依然有效</p> </li><li> <p>若 <code>BEFORE</code> 触发程序失败，则 MySQL 将不执行相应行上的操作</p> </li><li> <p>若在 <code>BEFORE</code> 或 <code>AFTER</code> 触发程序的执行过程中出现错误，将导致调用触发程序的整个语句失败</p> </li><li> <p>仅当 <code>BEFORE</code> 触发程序和行操作均已被成功执行，MySQL 才会执行 <code>AFTER</code> 触发程序</p> </li></ul> </li></ul> 
<h6><a id="INSERT_860"></a>INSERT</h6> 
<ul><li> <p><code>INSERT</code> 语句执行之前或之后响应的触发器</p> </li><li> <p>注意</p> 
  <ol><li>触发器代码内可引用名为 <code>NEW</code>（不区分大小写）的虚拟表来访问被插入的行</li><li>在 <code>BEFORE INSERT</code> 触发器中，<code>NEW</code> 中的值也可以被更新 
    <ul><li>允许更改被插入的值，需要具有对应的操作权限</li></ul> </li><li>对于 <code>AUTO_INCREMENT</code> 列，<code>NEW</code> 在 <code>INSERT</code> 执行之前包含的值是 0，在 INSERT 执行之后将包含新的自动生成值</li></ol> </li></ul> 
<h6><a id="UPDATE_870"></a>UPDATE</h6> 
<ul><li> <p><code>UPDATE</code> 语句执行之前或之后响应的触发器</p> </li><li> <p>注意</p> 
  <ol><li><code>UPDATE</code> 触发器代码内可引用名为 <code>NEW</code>（不区分大小写）的虚拟表访问更新的值</li><li><code>UPDATE</code> 触发器代码内可引用名为 <code>OLD</code>（不区分大小写）的虚拟表访问 <code>UPDATE</code> 语句执行前的值 
    <ul><li><code>OLD</code> 中的值全部是只读的，不能被更新</li></ul> </li><li><code>BEFORE UPDATE</code> 触发器中，<code>NEW</code> 中的值可能也被更新 
    <ul><li>允许更改将要用于 <code>UPDATE</code> 语句中的值，需要具有对应的操作权限</li></ul> </li><li>触发器涉及对触发表自身的更新操作时，只能使用 <code>BEFORE</code> 类型的触发器，<code>AFTER</code> 类型的触发器将不被允许</li></ol> </li></ul> 
<h6><a id="DELETE_882"></a>DELETE</h6> 
<ul><li> <p><code>DELETE</code> 语句执行之前或之后响应的触发器</p> </li><li> <p>注意：<code>DELETE</code> 触发器代码内可引用名为 <code>OLD</code>（不区分大小写）的虚拟表来访问被删除的行</p> 
  <ul><li><code>OLD</code> 中的值全部是只读的，不能被更新</li></ul> </li></ul> 
<h5><a id="_889"></a>创建</h5> 
<h6><a id="_891"></a>语法</h6> 
<ul><li> <p><code>CREATE TRIGGER</code> 语句创建触发器</p> <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> <span class="token operator">&lt;</span>触发器名<span class="token operator">&gt;</span> 
<span class="token operator">&lt;</span> BEFORE <span class="token operator">|</span> <span class="token keyword">AFTER</span> <span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token keyword">INSERT</span> <span class="token operator">|</span> <span class="token keyword">UPDATE</span> <span class="token operator">|</span> <span class="token keyword">DELETE</span> <span class="token operator">&gt;</span>
<span class="token keyword">ON</span> <span class="token operator">&lt;</span>表名<span class="token operator">&gt;</span> 
<span class="token keyword">FOR EACH Row</span>
<span class="token operator">&lt;</span>触发器主体<span class="token operator">&gt;</span>
</code></pre> 
  <ul><li>触发器名：触发器在当前数据库中必须具有唯一的名称 
    <ul><li>如果要在某个特定数据库中创建，名称前面应该加上数据库的名称</li></ul> </li><li><code>INSERT | UPDATE | DELETE</code>：触发事件，指定激活触发器的语句的种类 
    <ul><li><code>INSERT</code>：将新行插入表时激活触发器 
      <ul><li>例：INSERT 的 BEFORE 触发器能被 MySQL 的 <code>INSERT</code> 语句和 <code>LOAD DATA</code> 语句激活</li></ul> </li><li><code>DELETE</code>： 从表中删除某一行数据时激活触发器、 
      <ul><li>例：<code>DELETE</code> 和 <code>REPLACE</code> 语句</li></ul> </li><li><code>UPDATE</code>：更改表中某一行数据时激活触发器 
      <ul><li>例：<code>UPDATE</code> 语句</li></ul> </li></ul> </li><li><code>BEFORE | AFTER</code>：触发器被触发的时刻，表示触发器是在激活语句之前或之后触发 
    <ul><li>若希望验证新数据是否满足条件使用 <code>BEFORE</code> 选项</li><li>若希望在激活触发器的语句执行之后完成几个或更多的改变通常使用 <code>AFTER</code> 选项</li></ul> </li><li>表名 
    <ul><li>与触发器相关联的表名，必须是永久性表 
      <ul><li>不能将触发器与临时表或视图关联</li></ul> </li><li>在该表上触发事件发生时才会激活触发器 
      <ul><li>同一个表不能拥有两个具有相同触发时刻和事件的触发器 
        <ul><li>每个表最多支持 6 个触发器</li></ul> </li><li>每个表的每个事件每次只允许有一个触发器 
        <ul><li>单一触发器不能与多个事件或多个表关联</li></ul> </li></ul> </li></ul> </li><li>触发器主体 
    <ul><li>包含触发器激活时将要执行的 SQL 语句</li><li>若要执行多个语句可使用 <code>BEGIN…END</code> 复合语句结构</li></ul> </li><li><code>FOR EACH ROW</code>：一般是指行级触发 
    <ul><li>对于受触发事件影响的每一行都要激活触发器的动作</li></ul> </li></ul> </li></ul> 
<h6><a id="_929"></a>示例</h6> 
<ul><li> <pre><code class="prism language-sql"><span class="token comment"># 创建 before 类型触发器 Demo</span>
<span class="token comment">-- 触发条件：向表 tab_name 中插入数据前对新插入的 salary 字段值进行求和计算</span>
<span class="token keyword">create</span> <span class="token keyword">trigger</span> Demo
before <span class="token keyword">insert</span> <span class="token keyword">on</span> tab_name
<span class="token keyword">for each row</span>
<span class="token keyword">set</span> <span class="token variable">@sum</span> <span class="token operator">=</span> <span class="token variable">@sum</span> <span class="token operator">+</span> NEW<span class="token punctuation">.</span>salary<span class="token punctuation">;</span>

<span class="token comment"># 创建 after 类型触发器 Demo2</span>
<span class="token comment">-- 触发条件：向表 tab_name 中插入数据后，再向表 tab_name2 插入相同数据，且 salary 为 tab_name 中插入 salary 值的 2 倍</span>
<span class="token keyword">create</span> <span class="token keyword">trigger</span> Demo2
<span class="token keyword">after</span> <span class="token keyword">insert</span> <span class="token keyword">on</span> tab_name
<span class="token keyword">for each row</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tab_name2 <span class="token keyword">values</span> <span class="token punctuation">(</span>NEW<span class="token punctuation">.</span>id<span class="token punctuation">,</span> NEW<span class="token punctuation">.</span>name<span class="token punctuation">,</span> deptId<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>NEW<span class="token punctuation">.</span>salary<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h5><a id="_947"></a>查看</h5> 
<ul><li> <p><code>SHOW TRIGGERS</code> 语句查看数据库中的触发器及基本信息</p> 
  <ul><li><code>SHOW TRIGGERS</code> 命令后添加 <code>\G</code>，显示信息比较有条理</li><li>无法查询指定的触发器</li></ul> <pre><code class="prism language-sql"><span class="token keyword">SHOW</span> TRIGGERS <span class="token punctuation">[</span>\G<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">-- 查看当前数据库的触发器信息</span>
</code></pre> 
  <ul><li>触发器字段解释 
    <ul><li><code>Trigger</code>：触发器的名称</li><li><code>Event</code>：激活触发器的事件</li><li><code>Table</code>：激活触发器的操作对象表</li><li><code>Statement</code>：触发器执行的操作</li><li><code>Timing</code>：触发器触发的时间</li><li>还有其他信息，比如触发器的创建时间、SQL 的模式、触发器的定义账户和字符集等</li></ul> </li></ul> </li><li> <p><code>triggers</code> 表</p> 
  <ul><li> <p>MySQL 中所有触发器的信息都存在 <code>information_schema</code> 数据库的 <code>triggers</code> 表中</p> </li><li> <p>可以通过查询命令 <code>SELECT</code> 查看</p> </li></ul> <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>triggers <span class="token keyword">WHERE</span> trigger_name<span class="token operator">=</span> <span class="token string">'触发器名'</span><span class="token punctuation">;</span>  <span class="token comment">-- 指定要查看的触发器的名称</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>triggers \G<span class="token punctuation">;</span>   <span class="token comment">-- 不指定名称，查看所有触发器</span>
</code></pre> </li></ul> 
<h5><a id="_977"></a>删除</h5> 
<ul><li> <p>修改触发器可以通过删除原触发器，再以相同的名称创建新的触发器。</p> 
  <ul><li> <p>使用 <code>DROP</code> 语句将触发器从数据库中删除</p> 
    <ul><li>需要 <code>SUPER</code> 权限</li></ul> <pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TRIGGER</span> <span class="token punctuation">[</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span>数据库名<span class="token punctuation">]</span> <span class="token operator">&lt;</span>触发器名<span class="token operator">&gt;</span>
</code></pre> 
    <ul><li>数据库名：指定触发器所在的数据库的名称 
      <ul><li>若没有指定默认为当前数据库</li></ul> </li></ul> </li></ul> </li><li> <p>删除表的同时会自动删除该表上的触发器</p> 
  <ul><li>触发器不能更新或覆盖，修改一个触发器，必须先删除它再重新创建</li></ul> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5704e7cd1231d2c956c18d4bb1dc1ab6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">剑指 Offer 53 - I. 在排序数组中查找数字 I（LeetCode 34. 在排序数组中查找元素的第一个和最后一个位置）——二分</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/70225ed35cfbfe12c1654ad477fa0d2b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Python &amp; Other】一网打尽 Python复制文本&amp;文件到剪切板</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>