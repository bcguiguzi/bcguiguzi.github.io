<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ingress实现同一域名加不同上下文实现两个服务的代理 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ingress实现同一域名加不同上下文实现两个服务的代理" />
<meta property="og:description" content="fes.test.com访问fes-pc服务
fes.test.com/mobile访问fes-web服务
准备工作：先准备两个前端，用nginx镜像发布
fes-pc.yaml
apiVersion: v1 kind: ConfigMap metadata: name: nginx-cm namespace: dev data: app.conf: | server { listen 80; server_name fes.test.com; location / { root /opt/application/fes-pc/; index index.html index.htm; } } --- apiVersion: apps/v1 kind: Deployment metadata: name: fes-pc namespace: dev spec: replicas: 1 selector: matchLabels: app: fes-pc template: metadata: labels: app: fes-pc spec: containers: - name: nginx image: mynginx:1.17.1 imagePullPolicy: IfNotPresent ports: - containerPort: 80 volumeMounts: - mountPath: /opt/application/fes-pc/ name: fes-pc-app - mountPath: /etc/nginx/conf." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/09b7db31aea64be204585a6aa8696b13/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-21T13:54:26+08:00" />
<meta property="article:modified_time" content="2023-03-21T13:54:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ingress实现同一域名加不同上下文实现两个服务的代理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="kdocs-document"> 
 <p style="text-align:left;"><a class="kdocs-link" style="color:#0A6CFF;" href="https://fes.test.com" rel="nofollow noopener noreferrer" target="_blank">fes.test.com</a>访问fes-pc服务</p> 
 <p style="text-align:left;"><a class="kdocs-link" style="color:#0A6CFF;" href="https://fes.test.com/mobile" rel="nofollow noopener noreferrer" target="_blank">fes.test.com/mobile</a>访问fes-web服务</p> 
 <ol start="1"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;"><p>准备工作：先准备两个前端，用nginx镜像发布</p></li></ol> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>fes-pc.yaml</p></li></ul> 
 <pre class="kdocs-yaml"><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-cm
  namespace: dev
data:
  app.conf: |
    server {
        listen       80;
        server_name  fes.test.com;
        location / {
            root   /opt/application/fes-pc/;
            index  index.html index.htm;
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fes-pc
  namespace: dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fes-pc
  template:
    metadata:
      labels:
        app: fes-pc
    spec:
      containers:
        - name: nginx
          image: mynginx:1.17.1
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80
          volumeMounts:
            - mountPath: /opt/application/fes-pc/
              name: fes-pc-app
            - mountPath: /etc/nginx/conf.d/
              name: appconf
      volumes:
        - name: fes-pc-app
          hostPath:
            path: /opt/application/fes-pc/
        - name: appconf
          configMap:
            name: nginx-cm
---
apiVersion: v1
kind: Service
metadata:
  name: fes-pc-svc
  namespace: dev
spec:
  selector:
    app: fes-pc
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 80</code></pre> 
 <p style="">fes-web.yaml</p> 
 <pre class="kdocs-yaml"><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-cm
  namespace: dev
data:
  app.conf: |
    server {
        listen       80;
        server_name  localhost;
        location /mobile {
            alias   /opt/application/fes-web/;
            index  index.html index.htm;
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fes-web
  namespace: dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fes-web
  template:
    metadata:
      labels:
        app: fes-web
    spec:
      containers:
        - name: nginx
          image: mynginx:1.17.1
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80
          volumeMounts:
            - mountPath: /opt/application/fes-web/
              name: fes-web-app
            - mountPath: /etc/nginx/conf.d/
              name: appconf
      volumes:
        - name: fes-web-app
          hostPath:
            path: /opt/application/fes-web/
        - name: appconf
          configMap:
            name: nginx-cm
---
apiVersion: v1
kind: Service
metadata:
  name: fes-web-svc
  namespace: dev
spec:
  selector:
    app: fes-web
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 80</code></pre> 
 <p style="">本机curl测试</p> 
 <pre class="kdocs-yaml"><code class="language-yaml">[root@master fesapp]# kubectl get pod -n dev -o wide
NAME                      READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES
fes-pc-679bf5c875-bl7gt   1/1     Running   0          98m   10.244.0.61   master   &lt;none&gt;           &lt;none&gt;
fes-web-987bfb95b-k559k   1/1     Running   0          8s    10.244.0.65   master   &lt;none&gt;           &lt;none&gt;

[root@master fesapp]# kubectl get svc -n dev -o wide
NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR
fes-pc-svc    ClusterIP   10.102.47.17    &lt;none&gt;        80/TCP    99m   app=fes-pc
fes-web-svc   ClusterIP   10.99.243.248   &lt;none&gt;        80/TCP    53s   app=fes-web

[root@master fesapp]# curl 10.102.47.17
[root@master fesapp]# curl 10.99.243.248/mobile</code></pre> 
 <ol start="2"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;"><p>ingress部署（上网随便找的yaml文件）</p></li></ol> 
 <pre class="kdocs-yaml"><code class="language-yaml">[root@master fesapp]# kubectl apply -f mandatory.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx

---

kind: ConfigMap
apiVersion: v1
metadata:
  name: nginx-configuration
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx

---
kind: ConfigMap
apiVersion: v1
metadata:
  name: tcp-services
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx

---
kind: ConfigMap
apiVersion: v1
metadata:
  name: udp-services
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nginx-ingress-serviceaccount
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx

---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: nginx-ingress-clusterrole
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
rules:
  - apiGroups:
      - ""
    resources:
      - configmaps
      - endpoints
      - nodes
      - pods
      - secrets
    verbs:
      - list
      - watch
  - apiGroups:
      - ""
    resources:
      - nodes
    verbs:
      - get
  - apiGroups:
      - ""
    resources:
      - services
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - ""
    resources:
      - events
    verbs:
      - create
      - patch
  - apiGroups:
      - "extensions"
      - "networking.k8s.io"
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - "extensions"
      - "networking.k8s.io"
    resources:
      - ingresses/status
    verbs:
      - update

---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  name: nginx-ingress-role
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
rules:
  - apiGroups:
      - ""
    resources:
      - configmaps
      - pods
      - secrets
      - namespaces
    verbs:
      - get
  - apiGroups:
      - ""
    resources:
      - configmaps
    resourceNames:
      # Defaults to "&lt;election-id&gt;-&lt;ingress-class&gt;"
      # Here: "&lt;ingress-controller-leader&gt;-&lt;nginx&gt;"
      # This has to be adapted if you change either parameter
      # when launching the nginx-ingress-controller.
      - "ingress-controller-leader-nginx"
    verbs:
      - get
      - update
  - apiGroups:
      - ""
    resources:
      - configmaps
    verbs:
      - create
  - apiGroups:
      - ""
    resources:
      - endpoints
    verbs:
      - get

---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  name: nginx-ingress-role-nisa-binding
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: nginx-ingress-role
subjects:
  - kind: ServiceAccount
    name: nginx-ingress-serviceaccount
    namespace: ingress-nginx

---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: nginx-ingress-clusterrole-nisa-binding
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: nginx-ingress-clusterrole
subjects:
  - kind: ServiceAccount
    name: nginx-ingress-serviceaccount
    namespace: ingress-nginx

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-ingress-controller
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/part-of: ingress-nginx
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ingress-nginx
        app.kubernetes.io/part-of: ingress-nginx
      annotations:
        prometheus.io/port: "10254"
        prometheus.io/scrape: "true"
    spec:
      # wait up to five minutes for the drain of connections
      terminationGracePeriodSeconds: 300
      serviceAccountName: nginx-ingress-serviceaccount
      nodeSelector:
        kubernetes.io/os: linux
      containers:
        - name: nginx-ingress-controller
          image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0
          args:
            - /nginx-ingress-controller
            - --configmap=$(POD_NAMESPACE)/nginx-configuration
            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services
            - --udp-services-configmap=$(POD_NAMESPACE)/udp-services
            - --publish-service=$(POD_NAMESPACE)/ingress-nginx
            - --annotations-prefix=nginx.ingress.kubernetes.io
          securityContext:
            allowPrivilegeEscalation: true
            capabilities:
              drop:
                - ALL
              add:
                - NET_BIND_SERVICE
            # www-data -&gt; 101
            runAsUser: 101
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
            - name: https
              containerPort: 443
              protocol: TCP
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /healthz
              port: 10254
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 10
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /healthz
              port: 10254
              scheme: HTTP
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 10
          lifecycle:
            preStop:
              exec:
                command:
                  - /wait-shutdown

---

apiVersion: v1
kind: LimitRange
metadata:
  name: ingress-nginx
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
spec:
  limits:
  - min:
      memory: 90Mi
      cpu: 100m
    type: Container

[root@master fesapp]# kubectl apply -f service-nodeport.yaml
apiVersion: v1
kind: Service
metadata:
  name: ingress-nginx
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
spec:
  type: NodePort
  ports:
    - name: http
      port: 80
      targetPort: 80
      nodePort: 30080 
      protocol: TCP
    - name: https
      port: 443
      targetPort: 443
      nodePort: 30443
      protocol: TCP
  selector:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
</code></pre> 
 <ol start="3"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;"><p>定义ingress策略</p></li></ol> 
 <pre class="kdocs-yaml"><code class="language-yaml">[root@master fesapp]# kubectl apply -f ingress-http.yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-http
  namespace: dev
spec:
  rules:
    - host: fes.test.com
      http:
        paths:
          - path: /
            backend:
              serviceName: fes-pc-svc
              servicePort: 80
          - path: /mobile
            backend:
              serviceName: fes-web-svc
              servicePort: 80</code></pre> 
 <p style="">本地修改hosts，浏览器访问测试</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1179px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:32.485157%;height:0;"> 
    <img src="https://images2.imgbox.com/5f/1e/YimSCOT9_o.png" style="margin-left:;display:block;width:1179px;margin-top:-32.485157%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1190px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:52.35294%;height:0;"> 
    <img src="https://images2.imgbox.com/11/4c/In6Q5H7a_o.png" style="margin-left:;display:block;width:1190px;margin-top:-52.35294%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">注意事项：</span></p> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>在ingress生效之前，需要先将应用部署完成</p></li></ul> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>ingress中<span class="kdocs-bold" style="font-weight:bold;">path的定义，需要与后端真实service提供的path一致</span>，否则将被转发到一个不存在的path上引发错误</p></li></ul> 
 <p style=""></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/985642e4fc423871092286702b84e579/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">小凯的疑惑</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ece43530466968836f73d760f3f4ca35/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java读取html文件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>