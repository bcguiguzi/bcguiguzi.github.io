<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>python学习之【with语句】 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="python学习之【with语句】" />
<meta property="og:description" content="前言 上一篇文章 ​ ​python学习之【文件读写】​​​ 中我们学习了python当中的文件读写，这篇文章接着学习python中文件读写的with语句。
了解with语句 在很多场景中，通过使用with语句可以让我们可以更好地来管理资源和简化代码，它可以看做是对
try…finally模式的简化。
with语句的语法格式
with open(文件名，打开方式，编码格式) as 别名:
with语句体
with语句可以自动管理上下文资源，不论是什么原因跳出with块都能确保文件可以正确的关闭 ，以此来达到释放资源的目的。
举几个例子：
如果是利用以前的知识来进行文件读取的操作，流程就是打开文件——》读取文件——》关闭文件。
例如：
# 比如我们要读取一个文件，如果不用with语句实现的话： #打开文件 file_a=open(&#39;a.txt&#39;,&#39;r&#39;) #读取文件 print(file_a.read()) #关闭文件，释放资源 file_a.close() 但是假如在读取文件的过程中出现异常的话，会对我们后续的关闭文件操作产生影响，从而导致资源无法释放。那应该怎样实现在读取文件时无论有没有产生异常都让打开了的文件及时关闭呢？我们可能会想到用try…except去完成
try: # 打开文件 reader=open(&#39;a.txt&#39;,&#39;r&#39;) # 操作文件 content=reader.read() print(content) except Exception: #有异常打印出异常，避免程序性报错 print(Exception) finally: #关闭文件 reader.close() try…except 的确会当对文件操作时发生异常不让程序发生报错，但是try…except是一种固定的格式，如果我们需要读取的文件有十几二十个呢，是不是需要按照try…except 的语法格式写很多条关闭操作的固定代码呀，这时候就出现了with语句来简化我们繁琐的代码：
#用with语句写 执行完毕with语句体之后会自动调用open中的__exit__方法对文件关闭， #我们就不需要再写close()操作了 with open(&#39;a.txt&#39;,&#39;r&#39;) as file: print(file.read()) 我们看只需要两行代码就能实现文件的读写；下面这个例子会更直观的看出with语句的妙处:
# 不使用with语句复制图片 file_src=open(&#39;befor.png&#39;,&#39;rb&#39;) file_tgt=open(&#39;after.png&#39;,&#39;wb&#39;) file_tgt.write(file_src.read()) file_src.close() file_tgt.close() # 使用with语句复制图片 with open(&#39;befor.png&#39;,&#39;rb&#39;) as src_file: with open(&#39;copy." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/53a9aed27b9f1a14fb00b1bac9dad6fd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-21T23:34:21+08:00" />
<meta property="article:modified_time" content="2023-09-21T23:34:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">python学习之【with语句】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<p>上一篇文章 <a href="https://blog.csdn.net/weixin_64122448/article/details/133106231?spm=1001.2014.3001.5501">​ ​python学习之【文件读写】​​​</a> 中我们学习了python当中的文件读写，这篇文章接着学习<mark>python中文件读写的with语句</mark>。</p> 
<h2><a id="with_4"></a>了解with语句</h2> 
<p>在很多场景中，通过使用with语句可以让我们可以更好地来管理资源和简化代码，它可以看做是对</p> 
<p><mark>try…finally模式的简化。</mark></p> 
<blockquote> 
 <p>with语句的语法格式<br> <strong>with open(文件名，打开方式，编码格式) as 别名:<br> with语句体</strong></p> 
</blockquote> 
<p>with语句可以自动管理上下文资源，不论是什么原因跳出with块都能确保文件可以正确的关闭 ，以此来达到释放资源的目的。</p> 
<p>举几个例子：</p> 
<p>如果是利用以前的知识来进行文件读取的操作，流程就是打开文件——》读取文件——》关闭文件。<br> 例如：</p> 
<pre><code class="prism language-python"><span class="token comment"># 比如我们要读取一个文件，如果不用with语句实现的话：</span>
<span class="token comment">#打开文件</span>
file_a<span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'a.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span>
<span class="token comment">#读取文件</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>file_a<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#关闭文件，释放资源</span>
file_a<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>但是假如在读取文件的过程中出现异常的话，会对我们后续的关闭文件操作产生影响，从而导致资源无法释放。那应该怎样实现在读取文件时无论有没有产生异常都让打开了的文件及时关闭呢？我们可能会想到用try…except去完成</p> 
<pre><code class="prism language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token comment"># 打开文件</span>
    reader<span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'a.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span>
    <span class="token comment"># 操作文件</span>
    content<span class="token operator">=</span>reader<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception<span class="token punctuation">:</span> <span class="token comment">#有异常打印出异常，避免程序性报错</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token comment">#关闭文件</span>
    reader<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>try…except 的确会当对文件操作时发生异常不让程序发生报错，但是try…except是一种固定的格式，如果我们需要读取的文件有十几二十个呢，是不是需要按照try…except 的语法格式写很多条关闭操作的固定代码呀，这时候就出现了with语句来简化我们繁琐的代码：</p> 
<pre><code class="prism language-python"><span class="token comment">#用with语句写 执行完毕with语句体之后会自动调用open中的__exit__方法对文件关闭，</span>
<span class="token comment">#我们就不需要再写close()操作了</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'a.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>我们看只需要两行代码就能实现文件的读写；下面这个例子会更直观的看出with语句的妙处:</p> 
<pre><code class="prism language-python"><span class="token comment"># 不使用with语句复制图片</span>
file_src<span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'befor.png'</span><span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span>
file_tgt<span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'after.png'</span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span>
file_tgt<span class="token punctuation">.</span>write<span class="token punctuation">(</span>file_src<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
file_src<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
file_tgt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 使用with语句复制图片</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'befor.png'</span><span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> src_file<span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'copy.png'</span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tgt_file<span class="token punctuation">:</span>
        tgt_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>src_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>我们能够看出使用with语句不仅简化了我们的代码书写，更避免了我们在读取文件完毕后忘记写入关闭文件的操作，增强了文件的安全性。</p> 
<h2><a id="_70"></a>实现原理</h2> 
<p>上文我们提到了上下文管理器，其实with语句就是通过上下文管理器来实现对文件的打开关闭操作。</p> 
<blockquote> 
 <p>当一个类中包含__enter__ 方法 和 __exit__方法时，我们就可以称这个类为上下文管理器的类。</p> 
 <p>使用with执行这个类时，会自动调用类的__enter__方法；然后执行with 语句体的内容；</p> 
 <p>当with语句体的内容执行完毕后，最后再调用执行类中的__exit__方法 实现关闭文件的操作。</p> 
</blockquote> 
<p>我们先用代码实现with语句的工作原理，以便让我们更熟练的使用with语句：</p> 
<pre><code class="prism language-python"><span class="token comment">#定义一个类叫做MyContent</span>
<span class="token keyword">class</span>  <span class="token class-name">MyContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 特殊方法</span>
    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'enter方法被调用了'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self
    <span class="token comment"># 特殊方法</span>
    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>exc_type<span class="token punctuation">,</span>exc_val<span class="token punctuation">,</span>exc_tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'exit方法被调用了'</span><span class="token punctuation">)</span>
    <span class="token comment"># 实例方法</span>
    <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'实例方法show()被调用了'</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> MyContent<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token comment">#离开运行时上下文（with语句体执行完毕），自动调用上下文管理器的特殊方法__exit__()</span>
</code></pre> 
<p>运行结果如下：<br> <img src="https://images2.imgbox.com/7f/0a/ldpPOU6C_o.jpg" alt="在这里插入图片描述"><br> 这个例子中，MyContent类就是一个上下文管理器的类，这个类中包含__enter__ 方法 和 exit__方法，当执行到with语句时，会自动调用该类中的__enter__方法；然后就开始执行with语句体，with语句体中我们通过类的对象调用了show()方法，因此show()方法被执行；最后当with语句体全部执行完毕后，就开始调用类中的__exit__方法让文件得以关闭。</p> 
<p>由此，前文用with语句实现对文件读取的操作的工作原理也就显而易见了：</p> 
<pre><code class="prism language-python"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'a.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>with语句后紧跟的open其实就是一个含有__enter__ 方法 和 exit__方法的类，因此这个类就叫做上下文管理器的类。</p> 
<p>​我们可以调用python中定义好的open类，也可以自定义一个类，让它也具有open类的功能：</p> 
<h3><a id="with_114"></a>自定义一个类实现with语句</h3> 
<pre><code class="prism language-python"><span class="token keyword">class</span>  <span class="token class-name">File_Manager</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#定义一个初始化方法</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>name<span class="token punctuation">,</span>mode<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'调用了__init__方法'</span><span class="token punctuation">)</span>
        <span class="token comment"># 实例化对象</span>
        self<span class="token punctuation">.</span>name<span class="token operator">=</span>name
        self<span class="token punctuation">.</span>mode<span class="token operator">=</span>mode
        self<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token operator">=</span><span class="token boolean">None</span>
    <span class="token comment"># 定义两个特殊方法  __enter__和__exit__方法</span>

    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'调用了__enter__方法'</span><span class="token punctuation">)</span>
        <span class="token comment"># 将打开的文件名和打开文件的方式赋给self.file</span>
        self<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">,</span>self<span class="token punctuation">.</span>mode<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token builtin">file</span>

    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>exc_type<span class="token punctuation">,</span>exc_val<span class="token punctuation">,</span>exc_tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'调用了exit方法'</span><span class="token punctuation">)</span>
        <span class="token comment"># 如果指定文件被打开，就执行close()操作</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 定义一个实例方法</span>
    <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'show()被调用'</span><span class="token punctuation">,</span>self<span class="token punctuation">)</span>

<span class="token comment">#使用with语句，这里的上下文管理器对象是我们创建的 File_Manager    我们在创建该类时对变量name和mode进行实例化了，因此这里需要给该类传递两个实例化对象 </span>
<span class="token comment">#文件名和 打开方式</span>

<span class="token keyword">with</span> File_Manager<span class="token punctuation">(</span><span class="token string">'a.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> read_file<span class="token punctuation">:</span>
    content<span class="token operator">=</span>read_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'读取a.txt'</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span>
<span class="token comment">#调用实例方法show()</span>
    read_file<span class="token operator">=</span>File_Manager<span class="token punctuation">(</span><span class="token string">'a.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span>
    read_file<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>运行结果：</strong></p> 
<p><img src="https://images2.imgbox.com/42/7c/MuBgwoWl_o.jpg" alt="在这里插入图片描述"></p> 
<p>我们定义了一个File_Manager()类，在这个类中定义了两个特殊方法__enter__() 方法和__exit__()方法，这两个方法分别负责对文件的开始和对文件的关闭；在执行with语句时，我们用自定义的File_Manager()类来替换原本的with语句中调用的open类，当执行with语句时，File_Manager()类就被调用，从而开始执行类中的__enter__() 方法和__exit__()方法以达到文件开启关闭的作用。</p> 
<p>with语句读取文件运行流程:</p> 
<blockquote> 
 <p>1 当我们在进行实例化对象的时候，__init__初始化方法会自动被调用 ——》调用了__init__方法<br> 2 当执行with语句的时候，会自动调用类中的__enter__方法 ——》调用了__enter__方法<br> 3 当执行到__enter__方法的return sele.file 时，会返回一个文件对象，此时开始读取文件——》读取a.txt ——》hello world<br> 4 当文件读取完毕时最后执行__exit__方法 ——》调用了exit方法</p> 
 <p>我们可以看到，当我们在with语句体中使用类的对象来调用类中的实例方法时，依然是先执行调用的</p> 
 <p>show()方法，然后再执行__exit__方法；</p> 
 <p><code> 也就是说只有当with语句体的内容全部执行完毕后，才会执行__exit__方法关闭文件，释放资源</code></p> 
</blockquote> 
<h3><a id="_172"></a>有关异常处理</h3> 
<p>上文我们说到with语句可以看作是对try…expect模式的简化，那么如果我们使用with语句来对文件进行操作时，with语句体中发生异常，会不会导致程序报错影响文件的关闭操作呢？</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span>  <span class="token class-name">MyContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 特殊方法</span>
    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'enter方法被调用了'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self
    <span class="token comment"># 特殊方法</span>
    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>exc_type<span class="token punctuation">,</span>exc_val<span class="token punctuation">,</span>exc_tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'exit方法被调用了'</span><span class="token punctuation">)</span>
    <span class="token comment"># 实例方法</span>
    <span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'实例方法show()被调用了'</span><span class="token punctuation">)</span>
        <span class="token comment"># return 1/0  # 即使是实例方法中出现了异常，特殊方法__exit__都会被调用，使得文件关闭</span>
<span class="token keyword">with</span> MyContent<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    a<span class="token operator">=</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">#离开运行时上下文，自动调用上下文管理器的特殊方法__exit__()</span>
</code></pre> 
<p>我们在with语句体中写入了报错代码：a=1/0，这就相当于with语句体发生异常了，那么运行结果时怎样的呢：</p> 
<p><img src="https://images2.imgbox.com/26/35/47XklXfu_o.jpg" alt="在这里插入图片描述"></p> 
<p>从运行结果可以看出，即使在with语句体中出现异常，但是不会影响对__exit__()方法的调用，依然会对文件实行关闭操作。</p> 
<p>但是虽然在发生异常时并没有影响文件的关闭，但是无论怎样程序还是报错了，那么with语句可不可以像try…expect模板那样将错误打印出来，避免程序的报错呢？我们不妨尝试一下：</p> 
<p><img src="https://images2.imgbox.com/51/8d/uzbMKjFc_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7b/8a/XtjBFKW0_o.jpg" alt="在这里插入图片描述"><br> 我们看到python中根本就没有with…expect和with…else的语法，确实写不下去。</p> 
<p>那我们是不是可以将try…expect和with联用呢，也就是将with语句作为一个块，然后嵌套在try…expect模块的try中：</p> 
<pre><code class="prism language-python"><span class="token comment"># 尝试将with语句嵌套在try...expect</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'a.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> read_file<span class="token punctuation">:</span>
        a<span class="token operator">=</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>read_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception<span class="token punctuation">:</span> <span class="token comment">#有异常打印出异常</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token comment">#关闭文件</span>
    read_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ac/7a/XkUoVMJb_o.jpg" alt="在这里插入图片描述"><br> ok问题解决！</p> 
<p><strong>优化代码，将错误原因打印出来：</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            a<span class="token operator">=</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> error<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8b/22/MUenoPax_o.jpg" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token comment">#用错误的方法读取二进制文件  </span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'pic1.png'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> p<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> error<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'文件已关闭'</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1e/de/fukc7Ivo_o.jpg" alt="在这里插入图片描述"><br> 由此可知：with语句只能确保对文件操作时是否发生异常都可以及时关闭打开的文件；如果出现异常，程序依然会发生报错。</p> 
<p>为什么会出现这种情况？</p> 
<p>我们注意到在定义__exit__()这个特殊方法时，传入了三个参数：</p> 
<pre><code>__exit__(exc_type, exc_val, exc_tb)： 

这三个参数分别代表：异常类型 (exc_type)、值 (exc_value) 及回溯信息 (traceback)
</code></pre> 
<blockquote> 
 <p>退出与上下文管理器相关的运行时上下文，返回一个bool 值表示是否对发生的异常进行处理。</p> 
 <p>参数为引起退出操作的异常信息，如果退出时未发生异常，则3个参数均为None。</p> 
 <p>若发生异常，返回 True 表示无需处理异常，返回 False 则会在退出该方法后重新抛出异常以由 with 语句之外的代码逻辑进行处理。</p> 
 <p>若该方法内部产生异常，则会取代由 statement-body 中语句产生的异常。要处理异常时，不应显示重新抛出异常<br> (即不能重新抛出通过参数传递进来的异常)，只需将返回值设为 False 即可。之后，上下文管理代码会检测是否 <strong>exit</strong>()<br> 失败来处理异常。</p> 
 <p>简单来说：</p> 
 <p>一个上下文管理器的__exit__方法，如果它返回False将在错误结束时重报错误。如果它返回True，它将抑制它。但是open内置的__exit__不返回True，因此当with语句体中执行出异常时，执行了__exit__方法关闭文件，错误还是会被重报，并不会避免。</p> 
</blockquote> 
<p>由此可得当with语句体出现异常时，with语句采取的措施是：</p> 
<blockquote> 
 <p>1：将发生异常的类型 (exc_type)、值 (exc_value) 及回溯信息 (traceback) 作为实参传递给 <strong>exit</strong><br> 方法；</p> 
 <p>2：使得 <strong>exit</strong> 方法处理异常；</p> 
 <p>3：如果__exit__ 方法返回 True，则说明该异常已被“处理”，无需再处理；</p> 
 <p>4：如果__exit__ 方法返回 True 之外的任何内容，则该异常将被 with 语句抛出；</p> 
</blockquote> 
<p>说到这里，我们是不是可以通过对__exit__()功能的完善来处理异常发生呢？</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span><span class="token builtin">file</span>
    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> traceback<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"异常已捕获"</span><span class="token punctuation">)</span>  
        self<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 关闭文件对象</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"文件已关闭"</span><span class="token punctuation">)</span>  
        <span class="token keyword">return</span> <span class="token boolean">True</span>  <span class="token comment"># 返回 True 说明异常已被处理</span>

<span class="token keyword">with</span> File<span class="token punctuation">(</span><span class="token string">'a.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    <span class="token comment">#触发异常</span>
    a<span class="token operator">=</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9c/7a/dimWPiVW_o.jpg" alt="在这里插入图片描述"></p> 
<h2><a id="_309"></a>每篇一语</h2> 
<p><mark>一辈子，别错把放纵当潇洒，别把颓废当自由。</mark></p> 
<p><mark>如有不足，感谢指正！</mark></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c9de7667299cf64206898d5e430bc778/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">统信UOS如何设置IP地址</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/38a801c58db4ac2515654ead21eea07d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何批量为文件夹命名</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>