<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL - json_search 小结 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL - json_search 小结" />
<meta property="og:description" content="在开发过程中遇到某个表中采用text格式存储了压缩后的JSON字符串，在代码中通过 json_search方法对 JSON 中的内容进行搜索，特此整理有关json_search的内容。MySQL在5.7的官方文档中就有关于JSON的相关说明，更详细的可直接参考官方文档。
JSON_SEARCH 用法 JSON_SEARCH(json_doc，one_or_all，search_str [，escape_char [，path] ...]) 说明 通过JSON_SEARCH函数，返回符合查询条件的key对应的的JSON路径所组成的数组，若不存在，则返回NULL
以下情况返回NULL
若 json_doc ，search_str，或path参数中任何一个为NULL，则返回NULL文档中不存在pathsearch_str未找到 以下情况报错
json_doc为不合法的JSON文档path为不合法的路径表达式one_or_all 参数非 one 或 all 字段解释 json_doc：要查询的Json 文档one_or_all：查询的终止条件 one：搜索在第一个匹配项后终止，并返回一个路径字符串。未定义首先考虑哪个匹配。all：搜索返回所有匹配的路径字符串，因此不包括重复的路径。如果有多个字符串，它们将自动包装为一个数组。数组元素的顺序是不确定的。 search_str：搜索参数 escape_char：指定转义符。escape_char 参数指定时要求必须是常量（为空或者一个字符），当escape_char参数为NULL或者不存在的情况下，系统默认使用 \ 作为转义字符。path指定的范围始终是要搜索或对其进行操作的文档，并以前导$字符表示。路径分支由句点字符 .分隔。数组中的单元格由[N]表示，和正常访问数组元素格式相同，例如 $.x 代表JSON文档中x对应的值，$[1].y代表JSON文档中第二位数据元素中y所对应的值 注：在search_str中，通配符 %和 _ 可以如同在 LIKE 上一样运行，其中 % 用于匹配多个字符（包括0）， _ 则仅可匹配一个字符 官方示例 mysql&gt; SET @j = &#39;[&#34;abc&#34;, [{&#34;k&#34;: &#34;10&#34;}, &#34;def&#34;], {&#34;x&#34;:&#34;abc&#34;}, {&#34;y&#34;:&#34;bcd&#34;}]&#39;; 对比one和all的区别
很直观的能看除one获取到一个符合条件的路径后就终止了，而all则返回全部
mysql&gt; SELECT JSON_SEARCH(@j, &#39;one&#39;, &#39;abc&#39;); &#43;-------------------------------&#43; | JSON_SEARCH(@j, &#39;one&#39;, &#39;abc&#39;) | &#43;-------------------------------&#43; | &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/9282dfbc375c643d54b3d3a6753f70cb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-22T20:39:28+08:00" />
<meta property="article:modified_time" content="2020-09-22T20:39:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL - json_search 小结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>在开发过程中遇到某个表中采用<code>text</code>格式存储了压缩后的<code>JSON</code>字符串，在代码中通过 <code>json_search</code>方法对 <code>JSON</code> 中的内容进行搜索，特此整理有关<code>json_search</code>的内容。<code>MySQL</code>在5.7的官方文档中就有关于<code>JSON</code>的相关说明，更详细的可直接参考官方文档。</p> 
<br> 
<h2><a id="JSON_SEARCH_4"></a>JSON_SEARCH</h2> 
<h3><a id="_6"></a>用法</h3> 
<pre><code>JSON_SEARCH(json_doc，one_or_all，search_str [，escape_char [，path] ...])
</code></pre> 
<br> 
<h3><a id="_14"></a>说明</h3> 
<p>通过<code>JSON_SEARCH</code>函数，返回符合查询条件的<code>key</code>对应的的<code>JSON</code>路径所组成的数组，若不存在，则返回<code>NULL</code></p> 
<p>以下情况返回<code>NULL</code></p> 
<ul><li>若 <code>json_doc</code> ，<code>search_str</code>，或<code>path</code>参数中任何一个为<code>NULL</code>，则返回<code>NULL</code></li><li>文档中不存在<code>path</code></li><li><code>search_str</code>未找到</li></ul> 
<p>以下情况报错</p> 
<ul><li><code>json_doc</code>为不合法的<code>JSON</code>文档</li><li><code>path</code>为不合法的路径表达式</li><li><code>one_or_all</code> 参数非 <code>one</code> 或 <code>all</code></li></ul> 
<br> 
<h3><a id="_32"></a>字段解释</h3> 
<ul><li><code>json_doc</code>：要查询的<code>Json</code> 文档</li><li><code>one_or_all</code>：查询的终止条件 
  <ul><li><code>one</code>：搜索在第一个匹配项后终止，并返回一个路径字符串。未定义首先考虑哪个匹配。</li><li><code>all</code>：搜索返回所有匹配的路径字符串，因此不包括重复的路径。如果有多个字符串，它们将自动包装为一个数组。数组元素的顺序是不确定的。</li></ul> </li><li><code>search_str</code>：搜索参数 
  <ul><li><code>escape_char</code>：指定转义符。<code>escape_char</code> 参数指定时要求必须是常量（为空或者一个字符），当<code>escape_char</code>参数为<code>NULL</code>或者不存在的情况下，系统默认使用 <code>\</code> 作为转义字符。</li><li><code>path</code>指定的范围始终是要搜索或对其进行操作的文档，并以前导<code>$</code>字符表示。路径分支由句点字符 <code>.</code>分隔。数组中的单元格由<code>[N]</code>表示，和正常访问数组元素格式相同，例如 <code>$.x</code> 代表<code>JSON</code>文档中<code>x</code>对应的值，<code>$[1].y</code>代表<code>JSON</code>文档中第二位数据元素中<code>y</code>所对应的值</li></ul> </li><li>注：在<code>search_str</code>中，通配符 <code>%</code>和 <code>_</code> 可以如同在 <code>LIKE</code> 上一样运行，其中 <code>%</code> 用于匹配多个字符（包括0）， <code>_</code> 则仅可匹配一个字符</li></ul> 
<br> 
<h3><a id="_45"></a>官方示例</h3> 
<pre><code>mysql&gt; SET @j = '["abc", [{"k": "10"}, "def"], {"x":"abc"}, {"y":"bcd"}]';
</code></pre> 
<ol><li> <p>对比<code>one</code>和<code>all</code>的区别</p> <p>很直观的能看除<code>one</code>获取到一个符合条件的路径后就终止了，而<code>all</code>则返回全部</p> </li></ol> 
<pre><code class="prism language-mysql">mysql&gt; SELECT JSON_SEARCH(@j, 'one', 'abc');
+-------------------------------+
| JSON_SEARCH(@j, 'one', 'abc') |
+-------------------------------+
| "$[0]"                        |
+-------------------------------+

mysql&gt; SELECT JSON_SEARCH(@j, 'all', 'abc');
+-------------------------------+
| JSON_SEARCH(@j, 'all', 'abc') |
+-------------------------------+
| ["$[0]", "$[2].x"]            |
+-------------------------------+
</code></pre> 
<br> 
<ol start="2"><li>若搜索内容不存在，则返回<code>NULL</code></li></ol> 
<pre><code class="prism language-mysql">mysql&gt; SELECT JSON_SEARCH(@j, 'all', 'ghi');
+-------------------------------+
| JSON_SEARCH(@j, 'all', 'ghi') |
+-------------------------------+
| NULL                          |
+-------------------------------+
</code></pre> 
<br> 
<ol start="3"><li>查询值为10所在的路径</li></ol> 
<pre><code class="prism language-mysql">mysql&gt; SELECT JSON_SEARCH(@j, 'all', '10');
+------------------------------+
| JSON_SEARCH(@j, 'all', '10') |
+------------------------------+
| "$[1][0].k"                  |
+------------------------------+
</code></pre> 
<br> 
<ol start="4"><li>指定<code>JSON</code>搜索路径</li></ol> 
<p><code>@j = '["abc", [{"k": "10"}, "def"], {"x":"abc"}, {"y":"bcd"}]';</code></p> 
<pre><code class="prism language-mysql">mysql&gt; SELECT JSON_SEARCH(@j, 'all', '10', NULL, '$');
+-----------------------------------------+
| JSON_SEARCH(@j, 'all', '10', NULL, '$') |
+-----------------------------------------+
| "$[1][0].k"                             |
+-----------------------------------------+

mysql&gt; SELECT JSON_SEARCH(@j, 'all', '10', NULL, '$[*]');
+--------------------------------------------+
| JSON_SEARCH(@j, 'all', '10', NULL, '$[*]') |
+--------------------------------------------+
| "$[1][0].k"                                |
+--------------------------------------------+

mysql&gt; SELECT JSON_SEARCH(@j, 'all', '10', NULL, '$**.k');
+---------------------------------------------+
| JSON_SEARCH(@j, 'all', '10', NULL, '$**.k') |
+---------------------------------------------+
| "$[1][0].k"                                 |
+---------------------------------------------+

mysql&gt; SELECT JSON_SEARCH(@j, 'all', '10', NULL, '$[*][0].k');
+-------------------------------------------------+
| JSON_SEARCH(@j, 'all', '10', NULL, '$[*][0].k') |
+-------------------------------------------------+
| "$[1][0].k"                                     |
+-------------------------------------------------+

mysql&gt; SELECT JSON_SEARCH(@j, 'all', '10', NULL, '$[1]');
+--------------------------------------------+
| JSON_SEARCH(@j, 'all', '10', NULL, '$[1]') |
+--------------------------------------------+
| "$[1][0].k"                                |
+--------------------------------------------+

#指定搜索路径为数组中第二个元素内的第一个元素
mysql&gt; SELECT JSON_SEARCH(@j, 'all', '10', NULL, '$[1][0]');
+-----------------------------------------------+
| JSON_SEARCH(@j, 'all', '10', NULL, '$[1][0]') |
+-----------------------------------------------+
| "$[1][0].k"                                   |
+-----------------------------------------------+

mysql&gt; SELECT JSON_SEARCH(@j, 'all', 'abc', NULL, '$[2]');
+---------------------------------------------+
| JSON_SEARCH(@j, 'all', 'abc', NULL, '$[2]') |
+---------------------------------------------+
| "$[2].x"                                    |
+---------------------------------------------+

</code></pre> 
<br> 
<ol start="5"><li>模糊匹配</li></ol> 
<p><code>@j = '["abc", [{"k": "10"}, "def"], {"x":"abc"}, {"y":"bcd"}]';</code></p> 
<pre><code class="prism language-mysql">mysql&gt; SELECT JSON_SEARCH(@j, 'all', '%a%');
+-------------------------------+
| JSON_SEARCH(@j, 'all', '%a%') |
+-------------------------------+
| ["$[0]", "$[2].x"]            |
+-------------------------------+

mysql&gt; SELECT JSON_SEARCH(@j, 'all', '%b%');
+-------------------------------+
| JSON_SEARCH(@j, 'all', '%b%') |
+-------------------------------+
| ["$[0]", "$[2].x", "$[3].y"]  |
+-------------------------------+

# 指定搜索路径，$[0] = "abc"
mysql&gt; SELECT JSON_SEARCH(@j, 'all', '%b%', NULL, '$[0]');
+---------------------------------------------+
| JSON_SEARCH(@j, 'all', '%b%', NULL, '$[0]') |
+---------------------------------------------+
| "$[0]"                                      |
+---------------------------------------------+

# $[2] = {"x":"abc"}
mysql&gt; SELECT JSON_SEARCH(@j, 'all', '%b%', NULL, '$[2]');
+---------------------------------------------+
| JSON_SEARCH(@j, 'all', '%b%', NULL, '$[2]') |
+---------------------------------------------+
| "$[2].x"                                    |
+---------------------------------------------+

# $[1] = [{"k": "10"}, "def"] 模糊匹配无结果
mysql&gt; SELECT JSON_SEARCH(@j, 'all', '%b%', NULL, '$[1]');
+---------------------------------------------+
| JSON_SEARCH(@j, 'all', '%b%', NULL, '$[1]') |
+---------------------------------------------+
| NULL                                        |
+---------------------------------------------+

mysql&gt; SELECT JSON_SEARCH(@j, 'all', '%b%', '', '$[1]');
+-------------------------------------------+
| JSON_SEARCH(@j, 'all', '%b%', '', '$[1]') |
+-------------------------------------------+
| NULL                                      |
+-------------------------------------------+

mysql&gt; SELECT JSON_SEARCH(@j, 'all', '%b%', '', '$[3]');
+-------------------------------------------+
| JSON_SEARCH(@j, 'all', '%b%', '', '$[3]') |
+-------------------------------------------+
| "$[3].y"                                  |
+-------------------------------------------+
</code></pre> 
<hr> 
<h2><a id="_220"></a>日常示例</h2> 
<p>在日常开发过程中如果需要使用<code>JSON_SEARCH</code>查询的话，需要搭配<code>IS NOT NULL</code>来获取符合条件的数据</p> 
<h3><a id="_224"></a>创建用户表</h3> 
<pre><code class="prism language-mysql">Create Table: CREATE TABLE `user` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(64) NOT NULL COMMENT '名字',
  `age` int(4) unsigned NOT NULL COMMENT '年龄',
  `info` text COMMENT '补充信息',
  PRIMARY KEY (`id`),
  UNIQUE KEY `name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='用户表'
</code></pre> 
<br> 
<h3><a id="_239"></a>插入用户数据</h3> 
<pre><code class="prism language-mysql">INSERT INTO `suhw`.`user` (`name`, `age`, `info`) VALUES ('suhw', '23', '{"phone":"12312123434","language":["c++","java","go"]}');
INSERT INTO `suhw`.`user` (`name`, `age`, `info`) VALUES ('bob', '20', '{"phone":"18912123434","language":["c++","c","go","php"]}');
</code></pre> 
<br> 
<h3><a id="go_248"></a>查询会go语言的用户</h3> 
<pre><code class="prism language-mysql">mysql&gt; select * from user where JSON_SEARCH(info, 'all', 'go', NULL, '$.language') IS NOT NULL\G
*************************** 1. row ***************************
  id: 1
name: suhw
 age: 23
info: {"phone":"12312123434","language":["c++","java","go"]}
*************************** 2. row ***************************
  id: 2
name: bob
 age: 20
info: {"phone":"18912123434","language":["c++","c","go","php"]}
2 rows in set (0.00 sec)
</code></pre> 
<br> 
<hr> 
<h2><a id="_269"></a>参考</h2> 
<ul><li>https://www.docs4dev.com/docs/zh/mysql/5.7/reference/json-search-functions.html#function_json-search</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6daab421b16b3aff3374f28d5d6cb444/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">OpenVAS下载与安装</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7e52a90fa9241d3f5bc3fcae6447d8c0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">VS配置RTKLIB（卫星定位开源代码）环境</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>