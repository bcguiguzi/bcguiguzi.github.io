<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>docker swarm和docker service - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="docker swarm和docker service" />
<meta property="og:description" content="简介 Docker Swarm 是一套管理 Docker 集群的工具，它将一群 Docker 宿主机变成一个单一的、虚拟的主机。Swarm 使用标准的 Docker API 作为其前端访问入口，换言之，各种形式的 Docker 工具 （如 Compose Krane Deis docker-py Docker 本身等）都可以很容易地与 Swarm 进行集成。
使用 Swarm 管理 Docker 集群时，会有一个 swarm manager 及若干的 swarm node, swarm manager 上运行 swarm daemon ，用户只需要与 swarm manager 通信即可，然后 swarm manager 根据 discovery service 的信息选择一个 swarm node 来运行container。
在这里插入图片描述注意：swarm daemon 只是 个任务调度器它本身不运行容器，它只接收 Docker client 发送过来的请求，调度合适的 swarm node运行 container ，这意昧着，即使 swarm daemon 由于某些原因挂掉了，已经运行起来的容器也不会有任何影响
Raft一致性算法 保证节点存活的一个协议，后面会讲到！
Docker Swarm 特点 Swarm 对外以 Docker API 接口呈现，这样带来的好处是，如果现有系统使用Docker Engine ，则可以平滑地将 Docker Engine 切到 Swarm 上，无须改动现有系统Swarm 对用户来说，之前使用 Docker 的经验可以继承过来，非常容易上手，学习成本和二次开发成本都比较低 ，同时， Swarm 本身专注于 Docker 集群管理，非常轻量，占用资源也非常少 ，Batteries included but swappable ，简单来说，就是插件化机制，Swarm中的各个模块都抽象出了 API ，可以根据自己的特点进行定制实现Swarm 身对 Docker 命令参数支持得比较完善， Swarm 目前与 Docker 是同步发" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/708b2db773420212580184c3bafee2cd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-04T00:01:07+08:00" />
<meta property="article:modified_time" content="2022-05-04T00:01:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">docker swarm和docker service</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>简介</h2> 
<p>Docker Swarm 是一套管理 Docker <strong>集群的工具</strong>，它将一群 Docker 宿主机变成一个<strong>单一的、虚拟的主机</strong>。Swarm 使用标准的 <strong>Docker API</strong> 作为其前端访问入口，换言之，各种形式的 Docker 工具 （如 Compose Krane Deis docker-py Docker 本身等）都可以很容易地与 Swarm 进行集成。<br> 使用 Swarm 管理 Docker 集群时，会有一个 <strong>swarm manager</strong> 及若干的 swarm node, swarm manager 上运行 <strong>swarm daemon</strong> ，用户只需要与 <strong>swarm manager</strong> 通信即可，然后 swarm manager 根据 <strong>discovery service</strong> 的信息选择一个 swarm node 来运行container。<br> <a href="https://img-blog.csdnimg.cn/b967c0521c064780a6d0cfdc2a354621.png" rel="nofollow">在这里插入图片描述</a><strong>注意：swarm daemon 只是 个任务调度器它本身不运行容器，它只接收 Docker client 发送过来的请求，调度合适的 swarm node运行 container ，这意昧着，即使 swarm daemon 由于某些原因挂掉了，已经运行起来的容器也不会有任何影响</strong></p> 
<h3><a id="Raft_4"></a>Raft一致性算法</h3> 
<p>保证节点存活的一个协议，后面会讲到！</p> 
<h2><a id="Docker_Swarm__6"></a>Docker Swarm 特点</h2> 
<ul><li>Swarm 对外以 <strong>Docker API</strong> 接口呈现，这样带来的好处是，如果现有系统使用Docker Engine ，则可以<strong>平滑地将 Docker Engine 切到 Swarm 上</strong>，<strong>无须改动现有系统</strong></li><li>Swarm 对用户来说，之前使用 Docker 的经验可以继承过来，非常容易上手，学习成本和二次开发成本都比较低 ，同时， <strong>Swarm 本身专注于 Docker 集群管理，非常轻量，占用资源也非常少</strong> ，Batteries included but swappable ，简单来说，就是插件化机制，Swarm中的各个模块都抽象出了 API ，可以根据自己的特点进行定制实现</li><li>Swarm 身对 Docker <strong>命令参数支持得比较完善</strong>， Swarm 目前与 Docker 是同步发<br> 布的 Docker 的新功能都会第一时间在 Swarm 中体现</li></ul> 
<h2><a id="_11"></a>搭建集群</h2> 
<p>环境准备：<br> docker1：192.168.0.10<br> docker2：192.168.0.11<br> docker3：192.168.0.12<br> docker4：192.168.0.13</p> 
<ul><li><strong>这里是双主双从，一般是多主多从！！！</strong><br> <img src="https://images2.imgbox.com/31/d6/1WQSHsop_o.png" alt="在这里插入图片描述">帮助命令</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker swarm --help</span>

Usage:  <span class="token function">docker</span> swarm COMMAND

Manage Swarm

Commands:
  ca          Display and rotate the root CA
  init        Initialize a swarm
  <span class="token function">join</span>        Join a swarm as a <span class="token function">node</span> and/or manager
  join-token  Manage <span class="token function">join</span> tokens
  leave       Leave the swarm
  unlock      Unlock swarm
  unlock-key  Manage the unlock key
  update      Update the swarm

Run <span class="token string">'docker swarm COMMAND --help'</span> <span class="token keyword">for</span> <span class="token function">more</span> information on a command.

</code></pre> 
<p><img src="https://images2.imgbox.com/a5/eb/XfqXP0qu_o.png" alt="在这里插入图片描述"><br> 地址分为公网和私网</p> 
<h3><a id="docker1Manager_41"></a>让docker1成为Manager</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker swarm init --advertise-addr 192.168.0.10</span>
Swarm initialized: current <span class="token function">node</span> <span class="token punctuation">(</span>upjqlajieaitex5wcpc4836zk<span class="token punctuation">)</span> is now a manager.

To <span class="token function">add</span> a worker to this swarm, run the following command:

    <span class="token function">docker</span> swarm <span class="token function">join</span> --token SWMTKN-1-3l5et5kr5nu6pp9u40p68agxrbxsiura81z9zhvcc607owa7q9-0eapf51kpl9kyhsc6pygndx7i <span class="token number">192.168</span>.0.10:2377

To <span class="token function">add</span> a manager to this swarm, run <span class="token string">'docker swarm join-token manager'</span> and follow the instructions.

</code></pre> 
<p><img src="https://images2.imgbox.com/4c/c4/MRYKKxoG_o.png" alt="在这里插入图片描述"></p> 
<ul><li>初始化节点 <code>docker swarm init</code></li><li>加入一个节点 docker join</li></ul> 
<h3><a id="docker3_58"></a>把docker3加入到集群</h3> 
<p>docker swarm join --token SWMTKN-1-3l5et5kr5nu6pp9u40p68agxrbxsiura81z9zhvcc607owa7q9-0eapf51kpl9kyhsc6pygndx7i 192.168.0.10:2377<br> <img src="https://images2.imgbox.com/6f/af/L4HzeZAp_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker node ls</span>
ID                            <span class="token environment constant">HOSTNAME</span>                STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
ptq9lo57omx4njggpx6802963     localhost.localdomain   Ready     Active                          <span class="token number">20.10</span>.14
upjqlajieaitex5wcpc4836zk *   localhost.localdomain   Ready     Active         Leader           <span class="token number">20.10</span>.14

</code></pre> 
<p><img src="https://images2.imgbox.com/25/37/G0jZohr0_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="docekr4_70"></a>生成一个令牌，把docekr4也加入到群集中</h3> 
<p>docker swarm join-token worker</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker swarm join-token  worker</span>
To <span class="token function">add</span> a worker to this swarm, run the following command:

    <span class="token function">docker</span> swarm <span class="token function">join</span> --token SWMTKN-1-3l5et5kr5nu6pp9u40p68agxrbxsiura81z9zhvcc607owa7q9-0eapf51kpl9kyhsc6pygndx7i <span class="token number">192.168</span>.0.10:2377

</code></pre> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost docker<span class="token punctuation">]</span><span class="token comment"># date</span>
Tue May  <span class="token number">3</span> 09:16:37 EDT <span class="token number">2022</span>
<span class="token punctuation">[</span>root@localhost docker<span class="token punctuation">]</span><span class="token comment">#  docker swarm join --token SWMTKN-1-3l5et5kr5nu6pp9u40p68agxrbxsiura81z9zhvcc607owa7q9-0eapf51kpl9kyhsc6pygndx7i 192.168.0.10:2377</span>
This <span class="token function">node</span> joined a swarm as a worker.

</code></pre> 
<h3><a id="_88"></a>查看节点信息</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker node ls</span>
ID                            <span class="token environment constant">HOSTNAME</span>                STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
ptq9lo57omx4njggpx6802963     localhost.localdomain   Ready     Active                          <span class="token number">20.10</span>.14
ravewembyrqlkzzhvtiv5bu4p     localhost.localdomain   Ready     Active                          <span class="token number">20.10</span>.14
upjqlajieaitex5wcpc4836zk *   localhost.localdomain   Ready     Active         Leader           <span class="token number">20.10</span>.14

</code></pre> 
<h3><a id="badock2_manager_99"></a>badock2 加入到集群并且成为主节点（manager）</h3> 
<ul><li>生成令牌</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker swarm join-token manager</span>
To <span class="token function">add</span> a manager to this swarm, run the following command:

    <span class="token function">docker</span> swarm <span class="token function">join</span> --token SWMTKN-1-3l5et5kr5nu6pp9u40p68agxrbxsiura81z9zhvcc607owa7q9-4yq8p8z0995nr5t13w4hp45lw <span class="token number">192.168</span>.0.10:2377

</code></pre> 
<ul><li>加入</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost docker<span class="token punctuation">]</span><span class="token comment"># docker swarm join --token SWMTKN-1-3l5et5kr5nu6pp9u40p68agxrbxsiura81z9zhvcc607owa7q9-4yq8p8z0995nr5t13w4hp45lw 192.168.0.10:2377</span>
This <span class="token function">node</span> joined a swarm as a manager.
</code></pre> 
<ul><li>查看</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker node ls</span>
ID                            <span class="token environment constant">HOSTNAME</span>                STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
5c9polhcz9xq672qk05cwqy6p     localhost.localdomain   Ready     Active         Reachable        <span class="token number">20.10</span>.14
ptq9lo57omx4njggpx6802963     localhost.localdomain   Ready     Active                          <span class="token number">20.10</span>.14
ravewembyrqlkzzhvtiv5bu4p     localhost.localdomain   Ready     Active                          <span class="token number">20.10</span>.14
upjqlajieaitex5wcpc4836zk *   localhost.localdomain   Ready     Active         Leader           <span class="token number">20.10</span>.14

</code></pre> 
<h2><a id="Raft_128"></a>Raft协议</h2> 
<p>双主双从： 假设一个主节点挂了，另外一个主节点也会挂掉<br> Raft协议：保证大多数节点存活才可以用，只要大于1，<strong>集群至少大于2****来达到高可用（HA）</strong></p> 
<h3><a id="docker1_131"></a>假设docker1挂掉，宕机，另外一个主节点不可以使用</h3> 
<pre><code class="prism language-bash"><span class="token comment">## 停用docker1</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop docker</span>
Warning: Stopping docker.service, but it can still be activated by:
  docker.socket
<span class="token comment">## 查看在docker2上的群集是否可用（发现会报错！）</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># docker node ls</span>
Error response from daemon: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> The swarm does not have a leader. It's possible that too few managers are online. Make sure <span class="token function">more</span> than half of the managers are online.
</code></pre> 
<p><img src="https://images2.imgbox.com/15/93/CCl4WLuK_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="docker1docker1Leader_144"></a>docker1重新启动，发现docker1不在是Leader</h3> 
<p><img src="https://images2.imgbox.com/a7/9d/uezt4FdM_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="docker3_146"></a>docker3离开集群</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@docker3 ~<span class="token punctuation">]</span><span class="token comment"># docker swarm leave</span>
Node left the swarm.

</code></pre> 
<p><img src="https://images2.imgbox.com/97/e5/JGLP2J8F_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="docker3manager_154"></a>三主节点（docker3为manager）</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@docker2 ~<span class="token punctuation">]</span><span class="token comment"># docker swarm join-token manager</span>
To <span class="token function">add</span> a manager to this swarm, run the following command:

    <span class="token function">docker</span> swarm <span class="token function">join</span> --token SWMTKN-1-3l5et5kr5nu6pp9u40p68agxrbxsiura81z9zhvcc607owa7q9-4yq8p8z0995nr5t13w4hp45lw <span class="token number">192.168</span>.0.11:2377
<span class="token punctuation">[</span>root@docker3 ~<span class="token punctuation">]</span><span class="token comment"># docker swarm join --token SWMTKN-1-3l5et5kr5nu6pp9u40p68agxrbxsiura81z9zhvcc607owa7q9-4yq8p8z0995nr5t13w4hp45lw 192.168.0.11:2377</span>
This <span class="token function">node</span> joined a swarm as a manager.

</code></pre> 
<p><img src="https://images2.imgbox.com/f3/01/Fb5i6e9G_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="docker2manager_166"></a>停止docker2（manager）</h3> 
<p><strong>目前有三个主节点，停掉一个，集群不会挂掉！！</strong></p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@docker2 ~<span class="token punctuation">]</span><span class="token comment"># systemctl  stop docker</span>
Warning: Stopping docker.service, but it can still be activated by:
  docker.socket

</code></pre> 
<p><img src="https://images2.imgbox.com/c9/71/mNQWatQA_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="docker3manager_176"></a>docker3（manager）离开集群</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@docker3 ~<span class="token punctuation">]</span><span class="token comment"># docker swarm leave --force</span>
Node left the swarm.
<span class="token punctuation">[</span>root@docker1 ~<span class="token punctuation">]</span><span class="token comment"># docker node ls</span>
ID                            <span class="token environment constant">HOSTNAME</span>   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
upjqlajieaitex5wcpc4836zk *   docker1    Ready     Active         Leader           <span class="token number">20.10</span>.14
5c9polhcz9xq672qk05cwqy6p     docker2    Ready     Active         Reachable        <span class="token number">20.10</span>.14
ptq9lo57omx4njggpx6802963     docker3    Down      Active                          <span class="token number">20.10</span>.14
vgov54uahhjfgti7ks1h1r22y     docker3    Down      Active         Unreachable      <span class="token number">20.10</span>.14
ravewembyrqlkzzhvtiv5bu4p     docker4    Ready     Active                          <span class="token number">20.10</span>.14

</code></pre> 
<h3><a id="_190"></a>解散集群</h3> 
<ul><li>排空集群上的所有的节点容器（docker node update --availability drain g36lvv23ypjd8v7ovlst2n3yt）</li><li>把所有的集群节点先退出（docker swarm leave）</li><li>删除指定节点（docker node rm g36lvv23ypjd8v7ovlst2n3yt）</li><li>所有的manager退出（dockerswarm leave --force）</li></ul> 
<h2><a id="docker__196"></a>docker 服务（弹性创建）</h2> 
<p>集群： swarm docker sevice<br> 加入有一个web服务。当客户访问可以通过redis服务随机分配的到其他的redis的主机上<br> <img src="https://images2.imgbox.com/58/9b/gXNF53lM_o.png" alt="在这里插入图片描述"><br> 动态扩缩容<br> 如下图：如果增加了一个新的web服务，又要配置nginx，如果把全部的web放到一个集装箱中，service服务，nginx直接访问service就好了，这样节省了重复配置！<br> <img src="https://images2.imgbox.com/70/de/AXbZEWY4_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="dockerserver_203"></a>docker-server帮助信息</h3> 
<p>帮助命令<br> <img src="https://images2.imgbox.com/a8/ee/ke6HO4Xa_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_206"></a>创建服务</h3> 
<p><strong>docker service 与docker run差不多！！</strong></p> 
<ul><li>docker run ## 容器启动，不具有扩缩容功能</li><li>docker service 服务 ##具有扩缩容，灰度发布，金雀式发布</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@docker1 ~<span class="token punctuation">]</span><span class="token comment"># docker service create -p 8888:80 --name nginx nginx</span>
fbuiguhm0cy1gykdc7ujkt6kc
overall progress: <span class="token number">1</span> out of <span class="token number">1</span> tasks 
<span class="token number">1</span>/1: running   <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> 
verify: Service converged 
<span class="token punctuation">[</span>root@docker1 ~<span class="token punctuation">]</span><span class="token comment"># docker service ps nginx</span>
ID             NAME      IMAGE          NODE      DESIRED STATE   CURRENT STATE           ERROR     PORTS
rm2gqp5ive35   nginx.1   nginx:latest   docker4   Running         Running <span class="token number">2</span> minutes ago      
</code></pre> 
<h3><a id="_replicated_221"></a>查看服务 （副本replicated）</h3> 
<p>这里只有一个副本</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@docker1 ~<span class="token punctuation">]</span><span class="token comment"># docker service ls</span>
ID             NAME      MODE         REPLICAS   IMAGE          PORTS
fbuiguhm0cy1   nginx     replicated   <span class="token number">1</span>/1        nginx:latest   *:8888-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp

</code></pre> 
<h3><a id="docker4_229"></a>可以看到副本在docker4上运行起来</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@docker4 ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS     NAMES
9b869571d1ed   nginx:latest   <span class="token string">"/docker-entrypoint.…"</span>   <span class="token number">5</span> minutes ago   Up <span class="token number">4</span> minutes   <span class="token number">80</span>/tcp    nginx.1.rm2gqp5ive35g86fya36pg32y

</code></pre> 
<h3><a id="service_237"></a>更新service帮助信息</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@docker1 ~<span class="token punctuation">]</span><span class="token comment"># docker service update --help</span>

Usage:  <span class="token function">docker</span> <span class="token function">service</span> update <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> SERVICE

Update a <span class="token function">service</span>

Options:
      --args <span class="token builtin class-name">command</span>                       Service <span class="token builtin class-name">command</span> args
      --cap-add list                       Add Linux capabilities
      --cap-drop list                      Drop Linux capabilities
      --config-add config                  Add or update a config <span class="token function">file</span> on a <span class="token function">service</span>
      --config-rm list                     Remove a configuration <span class="token function">file</span>
      --constraint-add list                Add or update a placement constraint
      --constraint-rm list                 Remove a constraint
      --container-label-add list           Add or update a container label
      --container-label-rm list            Remove a container label by its key
      --credential-spec credential-spec    Credential spec <span class="token keyword">for</span> managed <span class="token function">service</span> account <span class="token punctuation">(</span>Windows only<span class="token punctuation">)</span>
  -d, --detach                             Exit immediately instead of waiting <span class="token keyword">for</span> the <span class="token function">service</span> to converge
      --dns-add list                       Add or update a custom DNS server
      --dns-option-add list                Add or update a DNS option
      --dns-option-rm list                 Remove a DNS option
      --dns-rm list                        Remove a custom DNS server
      --dns-search-add list                Add or update a custom DNS search domain
      --dns-search-rm list                 Remove a DNS search domain
      --endpoint-mode string               Endpoint mode <span class="token punctuation">(</span>vip or dnsrr<span class="token punctuation">)</span>
      --entrypoint <span class="token builtin class-name">command</span>                 Overwrite the default ENTRYPOINT of the image
      --env-add list                       Add or update an environment variable
      --env-rm list                        Remove an environment variable
      --force                              Force update even <span class="token keyword">if</span> no changes require it
      --generic-resource-add list          Add a Generic resource
      --generic-resource-rm list           Remove a Generic resource
      --group-add list                     Add an additional supplementary user group to the container
      --group-rm list                      Remove a previously added supplementary user group from the container
      --health-cmd string                  Command to run to check health
      --health-interval duration           Time between running the check <span class="token punctuation">(</span>ms<span class="token operator">|</span>s<span class="token operator">|</span>m<span class="token operator">|</span>h<span class="token punctuation">)</span>
      --health-retries int                 Consecutive failures needed to report unhealthy
      --health-start-period duration       Start period <span class="token keyword">for</span> the container to initialize before counting retries towards unstable <span class="token punctuation">(</span>ms<span class="token operator">|</span>s<span class="token operator">|</span>m<span class="token operator">|</span>h<span class="token punctuation">)</span>
      --health-timeout duration            Maximum <span class="token function">time</span> to allow one check to run <span class="token punctuation">(</span>ms<span class="token operator">|</span>s<span class="token operator">|</span>m<span class="token operator">|</span>h<span class="token punctuation">)</span>
      --host-add list                      Add a custom host-to-IP mapping <span class="token punctuation">(</span>host:ip<span class="token punctuation">)</span>
      --host-rm list                       Remove a custom host-to-IP mapping <span class="token punctuation">(</span>host:ip<span class="token punctuation">)</span>
      --hostname string                    Container <span class="token function">hostname</span>
      --image string                       Service image tag
      --init                               Use an init inside each <span class="token function">service</span> container to forward signals and reap processes
      --isolation string                   Service container isolation mode
      --label-add list                     Add or update a <span class="token function">service</span> label
      --label-rm list                      Remove a label by its key
      --limit-cpu decimal                  Limit CPUs
      --limit-memory bytes                 Limit Memory
      --limit-pids int                     Limit maximum number of processes <span class="token punctuation">(</span>default <span class="token number">0</span> <span class="token operator">=</span> unlimited<span class="token punctuation">)</span>
      --log-driver string                  Logging driver <span class="token keyword">for</span> <span class="token function">service</span>
      --log-opt list                       Logging driver options
      --max-concurrent uint                Number of job tasks to run concurrently <span class="token punctuation">(</span>default equal to --replicas<span class="token punctuation">)</span>
      --mount-add <span class="token function">mount</span>                    Add or update a <span class="token function">mount</span> on a <span class="token function">service</span>
      --mount-rm list                      Remove a <span class="token function">mount</span> by its target path
      --network-add network                Add a network
      --network-rm list                    Remove a network
      --no-healthcheck                     Disable any container-specified HEALTHCHECK
      --no-resolve-image                   Do not query the registry to resolve image digest and supported platforms
      --placement-pref-add pref            Add a placement preference
      --placement-pref-rm pref             Remove a placement preference
      --publish-add port                   Add or update a published port
      --publish-rm port                    Remove a published port by its target port
  -q, --quiet                              Suppress progress output
      --read-only                          Mount the container's root filesystem as <span class="token builtin class-name">read</span> only
      --replicas uint                      Number of tasks
      --replicas-max-per-node uint         Maximum number of tasks per <span class="token function">node</span> <span class="token punctuation">(</span>default <span class="token number">0</span> <span class="token operator">=</span> unlimited<span class="token punctuation">)</span>
      --reserve-cpu decimal                Reserve CPUs
      --reserve-memory bytes               Reserve Memory
      --restart-condition string           Restart when condition is met <span class="token punctuation">(</span><span class="token string">"none"</span><span class="token operator">|</span><span class="token string">"on-failure"</span><span class="token operator">|</span><span class="token string">"any"</span><span class="token punctuation">)</span>
      --restart-delay duration             Delay between restart attempts <span class="token punctuation">(</span>ns<span class="token operator">|</span>us<span class="token operator">|</span>ms<span class="token operator">|</span>s<span class="token operator">|</span>m<span class="token operator">|</span>h<span class="token punctuation">)</span>
      --restart-max-attempts uint          Maximum number of restarts before giving up
      --restart-window duration            Window used to evaluate the restart policy <span class="token punctuation">(</span>ns<span class="token operator">|</span>us<span class="token operator">|</span>ms<span class="token operator">|</span>s<span class="token operator">|</span>m<span class="token operator">|</span>h<span class="token punctuation">)</span>
      --rollback                           Rollback to previous specification
      --rollback-delay duration            Delay between task rollbacks <span class="token punctuation">(</span>ns<span class="token operator">|</span>us<span class="token operator">|</span>ms<span class="token operator">|</span>s<span class="token operator">|</span>m<span class="token operator">|</span>h<span class="token punctuation">)</span>
      --rollback-failure-action string     Action on rollback failure <span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token operator">|</span><span class="token string">"continue"</span><span class="token punctuation">)</span>
      --rollback-max-failure-ratio float   Failure rate to tolerate during a rollback
      --rollback-monitor duration          Duration after each task rollback to monitor <span class="token keyword">for</span> failure <span class="token punctuation">(</span>ns<span class="token operator">|</span>us<span class="token operator">|</span>ms<span class="token operator">|</span>s<span class="token operator">|</span>m<span class="token operator">|</span>h<span class="token punctuation">)</span>
      --rollback-order string              Rollback order <span class="token punctuation">(</span><span class="token string">"start-first"</span><span class="token operator">|</span><span class="token string">"stop-first"</span><span class="token punctuation">)</span>
      --rollback-parallelism uint          Maximum number of tasks rolled back simultaneously <span class="token punctuation">(</span><span class="token number">0</span> to roll back all at once<span class="token punctuation">)</span>
      --secret-add secret                  Add or update a secret on a <span class="token function">service</span>
      --secret-rm list                     Remove a secret
      --stop-grace-period duration         Time to <span class="token function">wait</span> before force killing a container <span class="token punctuation">(</span>ns<span class="token operator">|</span>us<span class="token operator">|</span>ms<span class="token operator">|</span>s<span class="token operator">|</span>m<span class="token operator">|</span>h<span class="token punctuation">)</span>
      --stop-signal string                 Signal to stop the container
      --sysctl-add list                    Add or update a Sysctl option
      --sysctl-rm list                     Remove a Sysctl option
  -t, --tty                                Allocate a pseudo-TTY
      --ulimit-add <span class="token builtin class-name">ulimit</span>                  Add or update a <span class="token builtin class-name">ulimit</span> option <span class="token punctuation">(</span>default <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      --ulimit-rm list                     Remove a <span class="token builtin class-name">ulimit</span> option
      --update-delay duration              Delay between updates <span class="token punctuation">(</span>ns<span class="token operator">|</span>us<span class="token operator">|</span>ms<span class="token operator">|</span>s<span class="token operator">|</span>m<span class="token operator">|</span>h<span class="token punctuation">)</span>
      --update-failure-action string       Action on update failure <span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token operator">|</span><span class="token string">"continue"</span><span class="token operator">|</span><span class="token string">"rollback"</span><span class="token punctuation">)</span>
      --update-max-failure-ratio float     Failure rate to tolerate during an update
      --update-monitor duration            Duration after each task update to monitor <span class="token keyword">for</span> failure <span class="token punctuation">(</span>ns<span class="token operator">|</span>us<span class="token operator">|</span>ms<span class="token operator">|</span>s<span class="token operator">|</span>m<span class="token operator">|</span>h<span class="token punctuation">)</span>
      --update-order string                Update order <span class="token punctuation">(</span><span class="token string">"start-first"</span><span class="token operator">|</span><span class="token string">"stop-first"</span><span class="token punctuation">)</span>
      --update-parallelism uint            Maximum number of tasks updated simultaneously <span class="token punctuation">(</span><span class="token number">0</span> to update all at once<span class="token punctuation">)</span>
  -u, --user string                        Username or <span class="token environment constant">UID</span> <span class="token punctuation">(</span>format: <span class="token operator">&lt;</span>name<span class="token operator">|</span>uid<span class="token operator">&gt;</span><span class="token punctuation">[</span>:<span class="token operator">&lt;</span>group<span class="token operator">|</span>gid<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      --with-registry-auth                 Send registry authentication details to swarm agents
  -w, --workdir string                     Working directory inside the container

</code></pre> 
<h3><a id="_340"></a>增加副本（动态扩缩容）</h3> 
<p><strong>加入访问流量过大的时候，我们就需要缓解服务器的压力，提高性能，我们就需要增加更多的副本！！</strong><br> 这里可以看到增加的副本后，nginx分别运行在docker1，docker2，docker4上面</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@docker1 ~<span class="token punctuation">]</span><span class="token comment"># docker service update --replicas 3 nginx</span>
nginx
overall progress: <span class="token number">3</span> out of <span class="token number">3</span> tasks 
<span class="token number">1</span>/3: running   <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> 
<span class="token number">2</span>/3: running   <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> 
<span class="token number">3</span>/3: running   <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> 
verify: Service converged 
<span class="token punctuation">[</span>root@docker1 ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS     NAMES
d6d208ed0654   nginx:latest   <span class="token string">"/docker-entrypoint.…"</span>   <span class="token number">36</span> seconds ago   Up <span class="token number">33</span> seconds   <span class="token number">80</span>/tcp    nginx.3.tv86k9fw82vtvdknvw5smgimc
<span class="token punctuation">[</span>root@docker2 ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS     NAMES
b6b94f4dc0d9   nginx:latest   <span class="token string">"/docker-entrypoint.…"</span>   <span class="token number">22</span> seconds ago   Up <span class="token number">20</span> seconds   <span class="token number">80</span>/tcp    nginx.2.ugkff9zoq5k1icg40wq2eklpf
<span class="token punctuation">[</span>root@docker4 ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS     NAMES
9b869571d1ed   nginx:latest   <span class="token string">"/docker-entrypoint.…"</span>   <span class="token number">12</span> minutes ago   Up <span class="token number">12</span> minutes   <span class="token number">80</span>/tcp    nginx.1.rm2gqp5ive35g86fya36pg32y

</code></pre> 
<p><strong>这个服务：集群中任何节点都可以访问，服务可以由多个副本动态扩缩实现！</strong></p> 
<h3><a id="_363"></a>回滚到一个副本</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@docker1 ~<span class="token punctuation">]</span><span class="token comment"># docker service update --replicas 1 nginx</span>
nginx
overall progress: <span class="token number">1</span> out of <span class="token number">1</span> tasks 
<span class="token number">1</span>/1: running   <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> 
verify: Service converged 
<span class="token punctuation">[</span>root@docker4 ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS     NAMES
9b869571d1ed   nginx:latest   <span class="token string">"/docker-entrypoint.…"</span>   <span class="token number">20</span> minutes ago   Up <span class="token number">20</span> minutes   <span class="token number">80</span>/tcp    nginx.1.rm2gqp5ive35g86fya36pg32y

</code></pre> 
<h3><a id="docker_service_scale_376"></a>另外一种动态扩缩容（docker service scale）</h3> 
<p>与上面的docker service update --replicas 差不多，没多大区别！</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@docker1 ~<span class="token punctuation">]</span><span class="token comment"># docker service ps nginx</span>
ID             NAME      IMAGE          NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS
rm2gqp5ive35   nginx.1   nginx:latest   docker4   Running         Running <span class="token number">23</span> minutes ago             
<span class="token punctuation">[</span>root@docker1 ~<span class="token punctuation">]</span><span class="token comment"># docker service scale --help</span>

Usage:  <span class="token function">docker</span> <span class="token function">service</span> scale <span class="token assign-left variable">SERVICE</span><span class="token operator">=</span>REPLICAS <span class="token punctuation">[</span>SERVICE<span class="token operator">=</span>REPLICAS<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

Scale one or multiple replicated services

Options:
  -d, --detach   Exit immediately instead of waiting <span class="token keyword">for</span> the <span class="token function">service</span> to converge
<span class="token punctuation">[</span>root@docker1 ~<span class="token punctuation">]</span><span class="token comment"># docker service scale nginx=5</span>
nginx scaled to <span class="token number">5</span>
overall progress: <span class="token number">5</span> out of <span class="token number">5</span> tasks 
<span class="token number">1</span>/5: running   <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> 
<span class="token number">2</span>/5: running   <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> 
<span class="token number">3</span>/5: running   <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> 
<span class="token number">4</span>/5: running   <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> 
<span class="token number">5</span>/5: running   <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> 
verify: Service converged 
</code></pre> 
<h3><a id="docker_service_rm_401"></a>服务的删除（docker service rm）</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@docker1 ~<span class="token punctuation">]</span><span class="token comment"># docker service rm nginx</span>
nginx
<span class="token punctuation">[</span>root@docker1 ~<span class="token punctuation">]</span><span class="token comment"># docker service ls</span>
ID        NAME      MODE      REPLICAS   IMAGE     PORTS

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d84aa762be9ff8ee935b2448789c4b43/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何实现一个random shuffle？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6eb1b646d88dd52b1cbb4480cc0218b4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">04741自考计算机网络原理知识点总结、考点串讲、考前复习</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>