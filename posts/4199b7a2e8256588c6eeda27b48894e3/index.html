<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>rsyslog使用:omrelp:方式配置远程转发 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="rsyslog使用:omrelp:方式配置远程转发" />
<meta property="og:description" content="目录
基本介绍 UDP和TCP转发方式
RELP转发方式
配置日志服务器
配置client端
FAQ
服务器端问题
客户端问题 基本介绍 rsyslog有三种转发消息的方式：
UDP传输：它的损耗很大，但很标准;
TCP传输：它只在某些情况下丢失消息，但大多数情况下是正常的;
RELP传输：而RELP传输不会丢失消息，但目前仅作为rsyslogd 3.15.0及以上版本的一部分可用。
要通过UDP将消息转发到另一个主机，请在主机名前面加上at符号(“@”)。要通过普通tcp转发，请在前面加上两个@号(“@@”)。要通过RELP转发，请在主机名前面加上字符串“:omrelp:”。
UDP和TCP转发方式 # 发送到udp端口
*.info @loghost.example.com
*.* @192.168.0.1
在上面的例子中，消息通过UDP转发到机器192.168.0.1，目标端口默认为514。由于UDP的特性，您可能会在传输过程中丢失一些消息。如果您预期流量很大，那么您可能会损失相当可观的消息数量(流量越大，消息丢失的可能性越大，情况也就越严重)。
可以使用omfwd模块的&#34;device&#34;选项将转发消息的套接字绑定到特定的设备。
Example:
action(type=&#34;omfwd&#34; Target=&#34;192.168.0.1&#34; Device=&#34;eth0&#34; Port=514 Protocol=&#34;udp&#34;)
在上面的例子中，消息通过UDP通过设备eth0在端口514上转发到机器192.168.0.1。在上面的例子中，如果要使用TCP可以将Protocol设置为“TCP”。对于支持VRF的Linux, device选项用于指定发送消息的VRF。
# 发送到ipv6
auth,authpriv.* @[2409:8080:5a0a:102f:0:4::11]:514
# 发送到tcp端口
*.* @@loghost.example.com
RELP转发方式 场景：日志服务器接收user.notice输出级别的日志，当然可以配置成任何其他级别。在日志服务器我们做了配置：user.notice /var/log/remote-operation.log。在client端，我们通过logger命令发送日志，其默认输出级别就是user.notice，如果要输出其他级别可以使用-p参数指定。
-p, --priority &lt; facility.level&gt; 将指定消息标记为此优先级。For example, -p local3.info logs the message as informational in the local3 facility. The default is user.notice.
配置完成后的验证就不赘述了。
配置日志服务器 # selinux添加端口信任 semanage port -a -t syslogd_port_t -p tcp 40888 semanage port -a -t syslogd_port_t -p udp 40888 # 安装relp支持库 yum -y install rsyslog-relp # 编辑rsyslog配置文件 vi /etc/rsyslog." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/4199b7a2e8256588c6eeda27b48894e3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-23T15:36:26+08:00" />
<meta property="article:modified_time" content="2023-02-23T15:36:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">rsyslog使用:omrelp:方式配置远程转发</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%C2%A0-toc" style="margin-left:0px;"><a href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%C2%A0" rel="nofollow">基本介绍 </a></p> 
<p id="udp%E5%92%8Ctcp%E8%BD%AC%E5%8F%91%E6%96%B9%E5%BC%8F-toc" style="margin-left:0px;"><a href="#udp%E5%92%8Ctcp%E8%BD%AC%E5%8F%91%E6%96%B9%E5%BC%8F" rel="nofollow">UDP和TCP转发方式</a></p> 
<p id="RELP%E8%BD%AC%E5%8F%91%E6%96%B9%E5%BC%8F-toc" style="margin-left:0px;"><a href="#RELP%E8%BD%AC%E5%8F%91%E6%96%B9%E5%BC%8F" rel="nofollow">RELP转发方式</a></p> 
<p id="%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E5%99%A8-toc" style="margin-left:40px;"><a href="#%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E5%99%A8" rel="nofollow">配置日志服务器</a></p> 
<p id="%E9%85%8D%E7%BD%AEclient%E7%AB%AF-toc" style="margin-left:40px;"><a href="#%E9%85%8D%E7%BD%AEclient%E7%AB%AF" rel="nofollow">配置client端</a></p> 
<p id="FAQ-toc" style="margin-left:0px;"><a href="#FAQ" rel="nofollow">FAQ</a></p> 
<p id="%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E9%97%AE%E9%A2%98-toc" style="margin-left:40px;"><a href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E9%97%AE%E9%A2%98" rel="nofollow">服务器端问题</a></p> 
<p id="%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%97%AE%E9%A2%98%C2%A0-toc" style="margin-left:40px;"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%97%AE%E9%A2%98%C2%A0" rel="nofollow">客户端问题 </a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%C2%A0">基本介绍 </h2> 
<blockquote> 
 <p>rsyslog有<span style="color:#be191c;">三种转发消息的方式</span>：<br><span style="color:#be191c;">UDP传输：</span>它的损耗很大，但很标准;<br><span style="color:#be191c;">TCP传输：</span>它只在某些情况下丢失消息，但大多数情况下是正常的;<br><span style="color:#be191c;">RELP传输：</span>而RELP传输不会丢失消息，但目前仅作为rsyslogd 3.15.0及以上版本的一部分可用。<br> 要通过UDP将消息转发到另一个主机，请在主机名前面加上at符号(“@”)。要通过普通tcp转发，请在前面加上两个@号(“@@”)。要通过RELP转发，请在主机名前面加上字符串“:omrelp:”。</p> 
</blockquote> 
<h2 id="udp%E5%92%8Ctcp%E8%BD%AC%E5%8F%91%E6%96%B9%E5%BC%8F">UDP和TCP转发方式</h2> 
<blockquote> 
 <p><strong># 发送到udp端口</strong><br><span style="color:#be191c;">*.info  @loghost.example.com<br> *.*     @192.168.0.1</span><br><br> 在上面的例子中，消息通过UDP转发到机器192.168.0.1，目标端口默认为514。由于UDP的特性，您可能会在传输过程中丢失一些消息。如果您预期流量很大，那么您可能会损失相当可观的消息数量(流量越大，消息丢失的可能性越大，情况也就越严重)。<br> 可以使用omfwd模块的"device"选项将转发消息的套接字绑定到特定的设备。<br> Example:<br>     <span style="color:#be191c;">action(type="omfwd" Target="192.168.0.1" Device="eth0" Port=514 Protocol="udp")</span><br> 在上面的例子中，消息通过UDP通过设备eth0在端口514上转发到机器192.168.0.1。在上面的例子中，如果要使用TCP可以将Protocol设置为“TCP”。对于支持VRF的Linux, device选项用于指定发送消息的VRF。</p> 
 <p><strong># 发送到ipv6</strong><br><span style="color:#be191c;">auth,authpriv.*         @[2409:8080:5a0a:102f:0:4::11]:514</span></p> 
 <p><strong># 发送到tcp端口</strong><br><span style="color:#be191c;">*.*     @@loghost.example.com</span></p> 
</blockquote> 
<h2 id="RELP%E8%BD%AC%E5%8F%91%E6%96%B9%E5%BC%8F">RELP转发方式</h2> 
<blockquote> 
 <p><strong>场景：</strong>日志服务器接收user.notice输出级别的日志，当然可以配置成任何其他级别。在日志服务器我们做了配置：user.notice  /var/log/remote-operation.log。在client端，我们通过logger命令发送日志，其默认输出级别就是user.notice，如果要输出其他级别可以使用-p参数指定。</p> 
 <p><span style="color:#be191c;"> -p, --priority &lt; facility.level&gt;   </span> 将指定消息标记为此优先级。For example, -p local3.info logs the message as informational in the local3 facility. The default is user.notice.</p> 
 <p></p> 
 <p>配置完成后的验证就不赘述了。</p> 
</blockquote> 
<h3 id="%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E5%99%A8">配置日志服务器</h3> 
<pre><code class="language-bash"># selinux添加端口信任
semanage port -a -t syslogd_port_t -p tcp 40888
semanage port -a -t syslogd_port_t -p udp 40888

# 安装relp支持库
yum -y install rsyslog-relp

# 编辑rsyslog配置文件
vi /etc/rsyslog.conf 
module(load="imrelp")
input(type="imrelp" port="40888")
# 不配置，日志会写入到/var/log/message中
user.notice                                             /var/log/remote-operation.log
&amp; stop

# 重启rsyslog
systemctl restart rsyslog  

# 注意查看rsyslog守护进程的日志，确保无报错
systemctl status rsyslog
或
journalctl -f -u rsyslog</code></pre> 
<h3 id="%E9%85%8D%E7%BD%AEclient%E7%AB%AF">配置client端</h3> 
<pre><code class="language-bash"># selinux添加端口信任
semanage port -a -t syslogd_port_t -p tcp 40888

# 编辑rsyslog配置文件
vi /etc/rsyslog.conf 
$ModLoad omrelp
user.notice                                             :omrelp:192.168.11.41:40888

# 重启rsyslog
systemctl restart rsyslog  


export PROMPT_COMMAND='user=$(whoami);user_id=$(id -ur $user);login=$(who -m | awk "{print $ 2\" \"$ NF}");msg=$(history 1 | { read x y; echo "$y"; });result_str="return code=[$?]";logger -t "[${SHELL}]" "[${msg}]" "${result_str}" "by [${user}(uid=$user_id)] from [$login]"' </code></pre> 
<h2 id="FAQ">FAQ</h2> 
<h3 id="%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E9%97%AE%E9%A2%98">服务器端问题</h3> 
<blockquote> 
 <p> # 问题：journalctl -f -u rsyslog输出如下错误日志：<br> imjournal: fopen() failed for path: '/imjournal.state.tmp': Permission denied [v8.2102.0-5.el8 try https://www.rsyslog.com/e/2013 ]<br> # 原因：selinux启动，40888/tcp端口没有权限<br> # 解决：执行semanage port -a -t syslogd_port_t -p tcp 40888</p> 
 <p></p> 
 <p># 问题：journalctl -f -u rsyslog输出如下错误日志：<br> imrelp: no RELP listener defined, module can not run. [v8.2102.0-5.el8 try https://www.rsyslog.com/e/2172 ]<br>  activation of module imrelp failed [v8.2102.0-5.el8 try https://www.rsyslog.com/e/-3 ]<br> # 原因：只配置了module(load="imrelp")，没有配置input(type="imrelp" port="40888") </p> 
 <p></p> 
 <p># 问题：journalctl -f -u rsyslog输出如下错误日志：<br> could not load module 'imrelp', errors: trying to load module /usr/lib64/rsyslog/imrelp.so: /usr/lib64/rsyslog/imrelp.so: cannot open shared object file: No such file or directory [v8.2102.0-5.el8 try https://www.rsyslog.com/e/2066 ]</p> 
 <p># 原因：缺少/usr/lib64/rsyslog/imrelp.so文件<br> # 解决<br> yum -y install rsyslog-relp</p> 
 <p></p> 
 <p># 问题：journalctl -f -u rsyslog输出如下错误日志：<br> error during parsing file /etc/rsyslog.conf, on or before line 17: invalid character '0' in object definition - is there an invalid escape sequence somewhere? [v8.2102.0-5.el8 try https://www.rsyslog.com/e/2207 ]</p> 
 <p># 原因，配置参数错误</p> 
 <p></p> 
 <p># 问题：journalctl -f -u rsyslog输出如下错误日志：<br> 服务器端日志：<br> rsyslogd[5133]: No UDP socket could successfully be initialized, some functionality may be disabled.  [v8.2102.0-5.el8]<br> 客户端日志：<br> rsyslogd[13946]: librelp error 10008 forwarding to server 192.168.11.41:40888 - suspending  [v8.2102.0-101.el9 try https://www.rsyslog.com/e/2291 ]<br> # 原因：selinux启动，40888/udp端口没有权限<br> # 解决：执行semanage port -a -t syslogd_port_t -p udp 40888</p> 
</blockquote> 
<h3 id="%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%97%AE%E9%A2%98%C2%A0">客户端问题 </h3> 
<blockquote> 
 <p># 问题：journalctl -f -u rsyslog输出如下错误日志：<br> omrelp[192.168.11.41:40888]: error 'error connecting: 'Permission denied'', object  'conn to srvr 192.168.11.41:40888' - action may not work as intended [v8.2102.0-101.el9 try https://www.rsyslog.com/e/2353 ]<br> omrelp[192.168.11.41:40888]: error 'error opening connection to remote peer', object  'conn to srvr 192.168.11.41:40888' - action may not work as intended [v8.2102.0-101.el9 try https://www.rsyslog.com/e/2353 ]</p> 
 <p>解决：客户端也要放开色Linux访问端口。。。<br> semanage port -a -t syslogd_port_t -p tcp 40888</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c77bb89dead0c1ff0ccad9b3f8670ad9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python-selenium-规避检测,无头浏览器</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/14025eac937d796ed59a91ef7be4e5b6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于Cannot resolve symbol ‘servlet‘报错</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>