<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android13 有线网开关研究 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android13 有线网开关研究" />
<meta property="og:description" content="Android13 有线网开关研究 文章目录 Android13 有线网开关研究前言1、api2、问题3、目的 二、代码分析1、Android13 上的 EthernetTracker2、Android13 上的 EthernetTracker3、对比开关过程1、Android13 关闭有线网，未移除节点: 2、Android9 关闭有线网，移除节点:3、NetdUtils 三、总结1、Android13 新增了有线网开关的api2、有线网开关区别（1）Android9 中要参考 Android13 不移除节点（2）Android13 中要参考 Android9 移除节点 3、有线网出现没ip 问题 本文对比 Android9 自己开发的有线网开关代码。
前言 1、api Android13 的api 提供了有线网开关 EthernetManager.setEthernetEnabled(boolean)，
Android9 如果要设置有线网开关，需要自己实现。
2、问题 Android13 上有出现打开有线网并且接入有线网无ip的情况，
并且调用开关有线网开关无作用（未移除节点eth0），ifconfig etho down/up 操作一次就有ip了。
3、目的 Android9 上有线网开关接口是会关闭节点的；Android13 上开关有线网节点一直是存在的。
所有决定研究一下有线网开关,希望能过解决问题。
主要研究代码是： EthernetTracker.java 的相关处理
之前Android 9 增加的有线网开关文章：
https://blog.csdn.net/wenzhi20102321/article/details/122243396
二、代码分析 1、Android13 上的 EthernetTracker E:\982\code\android_source\packages\modules\Connectivity\service-t\src\com\android\server\ethernet\EthernetTracker.java
private final INetd mNetd; @VisibleForTesting(visibility = PACKAGE) protected void setEthernetEnabled(boolean enabled) { mHandler." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/06322495b2c7e137e6ca3946ec51d536/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-10T15:16:13+08:00" />
<meta property="article:modified_time" content="2023-08-10T15:16:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android13 有线网开关研究</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Android13__0"></a>Android13 有线网开关研究</h2> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Android13__0" rel="nofollow">Android13 有线网开关研究</a></li><li><ul><li><a href="#_6" rel="nofollow">前言</a></li><li><ul><li><a href="#1api_8" rel="nofollow">1、api</a></li><li><a href="#2_12" rel="nofollow">2、问题</a></li><li><a href="#3_16" rel="nofollow">3、目的</a></li></ul> 
   </li><li><a href="#_28" rel="nofollow">二、代码分析</a></li><li><ul><li><a href="#1Android13__EthernetTracker_30" rel="nofollow">1、Android13 上的 EthernetTracker</a></li><li><a href="#2Android13__EthernetTracker_135" rel="nofollow">2、Android13 上的 EthernetTracker</a></li><li><a href="#3_169" rel="nofollow">3、对比开关过程</a></li><li><ul><li><a href="#1Android13__171" rel="nofollow">1、Android13 关闭有线网，未移除节点:</a></li></ul> 
    </li><li><a href="#2Android9__184" rel="nofollow">2、Android9 关闭有线网，移除节点:</a></li><li><a href="#3NetdUtils_195" rel="nofollow">3、NetdUtils</a></li></ul> 
   </li><li><a href="#_226" rel="nofollow">三、总结</a></li><li><ul><li><a href="#1Android13_api_228" rel="nofollow">1、Android13 新增了有线网开关的api</a></li><li><a href="#2_237" rel="nofollow">2、有线网开关区别</a></li><li><ul><li><a href="#1Android9__Android13__245" rel="nofollow">（1）Android9 中要参考 Android13 不移除节点</a></li><li><a href="#2Android13__Android9__259" rel="nofollow">（2）Android13 中要参考 Android9 移除节点</a></li></ul> 
    </li><li><a href="#3ip__278" rel="nofollow">3、有线网出现没ip 问题</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>本文对比 Android9 自己开发的有线网开关代码。</p> 
<h3><a id="_6"></a>前言</h3> 
<h4><a id="1api_8"></a>1、api</h4> 
<p>Android13 的api 提供了有线网开关 EthernetManager.setEthernetEnabled(boolean)，<br> Android9 如果要设置有线网开关，需要自己实现。</p> 
<h4><a id="2_12"></a>2、问题</h4> 
<p>Android13 上有出现打开有线网并且接入有线网无ip的情况，<br> 并且调用开关有线网开关无作用（未移除节点eth0），ifconfig etho down/up 操作一次就有ip了。</p> 
<h4><a id="3_16"></a>3、目的</h4> 
<p>Android9 上有线网开关接口是会关闭节点的；Android13 上开关有线网节点一直是存在的。<br> 所有决定研究一下有线网开关,希望能过解决问题。</p> 
<p>主要研究代码是： EthernetTracker.java 的相关处理</p> 
<p>之前Android 9 增加的有线网开关文章：<br> <a href="https://blog.csdn.net/wenzhi20102321/article/details/122243396">https://blog.csdn.net/wenzhi20102321/article/details/122243396</a></p> 
<h3><a id="_28"></a>二、代码分析</h3> 
<h4><a id="1Android13__EthernetTracker_30"></a>1、Android13 上的 EthernetTracker</h4> 
<p>E:\982\code\android_source\packages\modules\Connectivity\service-t\src\com\android\server\ethernet\EthernetTracker.java</p> 
<pre><code>
    private final INetd mNetd;

    @VisibleForTesting(visibility = PACKAGE)
    protected void setEthernetEnabled(boolean enabled) {
        mHandler.post(() -&gt; {
            int newState = enabled ? ETHERNET_STATE_ENABLED : ETHERNET_STATE_DISABLED;

            //set state,by liwenzhi ,Start
            Log.i(TAG, "setEthernetEnabled newState = " +newState + ", old state = " + mEthernetState);
            setPersistedState(newState); //自己加的值，用于保存系统属性，不用关注
            //set state,by liwenzhi ,End
            
            if (mEthernetState == newState) return;

            mEthernetState = newState;

            //关键
            if (enabled) {
                trackAvailableInterfaces();//设置有线网可用
            } else {
                // TODO: maybe also disable server mode interface as well.
                untrackFactoryInterfaces();//设置有线网不可用
            }
            broadcastEthernetStateChange(mEthernetState);
        });
    }


    //开启网络
    private void trackAvailableInterfaces() {
        try {
            final String[] ifaces = mNetd.interfaceGetList();
            for (String iface : ifaces) {
                maybeTrackInterface(iface);
            }
        } catch (RemoteException | ServiceSpecificException e) {
            Log.e(TAG, "Could not get list of interfaces " + e);
        }
    }


    //添加有线网节点，一般是 eth0
    private void maybeTrackInterface(String iface) {
。。。

        addInterface(iface);
        broadcastInterfaceStateChange(iface);
    }


    //添加配置有线网节点
    private void addInterface(String iface) {
        InterfaceConfigurationParcel config = null;
        // Bring up the interface so we get link status indications.
        try {
            PermissionUtils.enforceNetworkStackPermission(mContext);
            NetdUtils.setInterfaceUp(mNetd, iface); // NetdUtils 是Android13 新增的工具类
            config = NetdUtils.getInterfaceConfigParcel(mNetd, iface);
        } catch (IllegalStateException e) {
            // Either the system is crashing or the interface has disappeared. Just ignore the
            // error; we haven't modified any state because we only do that if our calls succeed.
            Log.e(TAG, "Error upping interface " + iface, e);
        }

    }



    //关闭有线网网络
    private void untrackFactoryInterfaces() {
        for (String iface : mFactory.getAvailableInterfaces(true /* includeRestricted */)) {
            stopTrackingInterface(iface);
        }
    }

    //停止有线网节点，一般是eth0
    private void stopTrackingInterface(String iface) {
        removeInterface(iface);
        if (iface.equals(mDefaultInterface)) {
            mDefaultInterface = null;
        }
        broadcastInterfaceStateChange(iface); //发送广播通知该节点网络断开
    }

    //删除有线网节点的数据，应该是断开某个netId
    private void removeInterface(String iface) {
        mFactory.removeInterface(iface);
        maybeUpdateServerModeInterfaceState(iface, false);
    }

</code></pre> 
<p>关注一下上面的 removeInterface 方法，这里是没移除节点的；</p> 
<p>从串口看，ifconfig，不管关开有线网，都是会有eth0 节点的，只是调用关闭的情况是没有ip 的。</p> 
<h4><a id="2Android13__EthernetTracker_135"></a>2、Android13 上的 EthernetTracker</h4> 
<p>E:\project_android11\code\android\frameworks\opt\net\ethernet\java\com\android\server\ethernet\EthernetTracker.java</p> 
<pre><code>
private final INetworkManagementService mNMService;

//对比Android11 上开关有线网的最后实现，是通过mNMService 进行开关节点
+    public synchronized void setIntefaceState(boolean state) {
+        try {
+            String[] interfaces = getInterfaces(true);
+            for (String iface : interfaces) {
+                if (isTrackingInterface(iface)) {
+                    if (state) {
+                        mNMService.setInterfaceUp(iface);
+                    } else {
+                        mNMService.setInterfaceDown(iface);
+                    }
+                }
+            }
+            if (state) mHandler.post(this::trackAvailableInterfaces);
+        } catch (Exception e) {
+            Log.e(TAG, "Error change eth state : " + state); 
+        }
+    }

</code></pre> 
<p>Android 原生没有上面的"+"的代码的，是自己加上去的；<br> 这里的 mNMService.setInterfaceDown(iface) 关闭节点是会移除节点的。</p> 
<h4><a id="3_169"></a>3、对比开关过程</h4> 
<h5><a id="1Android13__171"></a>1、Android13 关闭有线网，未移除节点:</h5> 
<pre><code>EthernetNetworkFactory mFactory;
mFactory.removeInterface(iface);

</code></pre> 
<p>其实 Android9 的 EthernetTracker也是有 EthernetNetworkFactory 对象，只是没有调到 removeInterface；<br> Android11 原生代码上，有线网默认是开启的，没有关闭有线网的接口。</p> 
<p>其实Android9 也可以参考Android13 只移除某个网络，不移除有线网节点。</p> 
<h4><a id="2Android9__184"></a>2、Android9 关闭有线网，移除节点:</h4> 
<pre><code>INetworkManagementService mNMService;
mNMService.setInterfaceDown(iface);

</code></pre> 
<p>虽然Android13 EthernetNetworkFactory.java 没有 INetworkManagementService 对象，但是有类似意义的 INetd 对象。<br> Android13 上的 NetdUtils 包含了同样意义的 setInterfaceDown 方法。</p> 
<h4><a id="3NetdUtils_195"></a>3、NetdUtils</h4> 
<p>这个类是Android13 新增的工具类</p> 
<p>framework\libs\net\client-libs\netd\com\android\net\module\util\NetdUtils.java</p> 
<pre><code>    /**
     * Set the given interface down.
     */
    public static void setInterfaceDown(INetd netd, String iface) {
        final InterfaceConfigurationParcel configParcel = getInterfaceConfigParcel(netd, iface);
        configParcel.flags = removeAndAddFlags(configParcel.flags, IF_STATE_UP /* remove */,
                IF_STATE_DOWN /* add */);
        setInterfaceConfig(netd, configParcel);
    }

    /**
     * Set interface configuration to netd by passing InterfaceConfigurationParcel.
     */
    public static void setInterfaceConfig(INetd netd, InterfaceConfigurationParcel configParcel) {
        try {
            netd.interfaceSetCfg(configParcel);
        } catch (RemoteException | ServiceSpecificException e) {
            throw new IllegalStateException(e);
        }
    }

</code></pre> 
<h3><a id="_226"></a>三、总结</h3> 
<h4><a id="1Android13_api_228"></a>1、Android13 新增了有线网开关的api</h4> 
<pre><code> mEthernetManager.setEthernetEnabled(boolean);

</code></pre> 
<p>但是没有提供查询开关状态的api ！需要自己在开关后记录有线网状态。</p> 
<h4><a id="2_237"></a>2、有线网开关区别</h4> 
<p>Android9 自动的开关是会关闭有线网节点的，<br> Android13 自带的有线网开关是不会关闭有线网节点的。</p> 
<p>移除有线网节点的做法，会耗时两三秒；<br> 不移除有线网的做法，基本不耗时。</p> 
<h5><a id="1Android9__Android13__245"></a>（1）Android9 中要参考 Android13 不移除节点</h5> 
<p>关闭有线网的时候，执行下面相关代码即可：</p> 
<pre><code>    //关闭有线网网络(Android13 复制过来的代码)
    private void untrackFactoryInterfaces() {
        for (String iface : mFactory.getAvailableInterfaces(true /* includeRestricted */)) {
            stopTrackingInterface(iface);
        }
    }

</code></pre> 
<h5><a id="2Android13__Android9__259"></a>（2）Android13 中要参考 Android9 移除节点</h5> 
<p>在 removeInterface 方法中调用 NetdUtils.setInterfaceDown 即可。</p> 
<pre><code>
    private void removeInterface(String iface) {
        mFactory.removeInterface(iface);
        //remove jiedian!by liwenzhi，Start
        NetdUtils.setInterfaceDown(mNetd, iface);
        //remove jiedian!by liwenzhi，End
        maybeUpdateServerModeInterfaceState(iface, false);
    }

</code></pre> 
<p>在测试中发现，切换信源返回界面后， removeInterface 会移除到其他节点，这个多加个判断，只移除有线网相关节点就可以，比如是否eth0/eth1.</p> 
<h4><a id="3ip__278"></a>3、有线网出现没ip 问题</h4> 
<p>这里的移除有线网节点的解决方法，只能算是一种规避手段，要正在解决该文件估计要一整套系统流程分析。<br> 因为是小概率问题，所以先规避解决。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4a7f8a9f1b305c198b2884246e3cd419/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">探索虹科工业树莓派更多可能性—兼顾CODESYS数据采集和Python数据优化处理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a81c3d5395ee763a7b40fe1e724b4537/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">华为OD算法题-分苹果问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>