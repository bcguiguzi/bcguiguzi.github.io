<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>从零开始激光slam定位【1】- 激光里程计 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="从零开始激光slam定位【1】- 激光里程计" />
<meta property="og:description" content="写在前面：本文是参考知乎任乾大佬的帖子完成，增加了自己的注释以及一些其他功能，如果有理解不到位的地方，请大家指正~
目录 里程计流程front_end_node.cpp的注释可视化debug参考 里程计流程 1、如果当前帧是第一帧，那么将其看做关键帧，进行关键帧更新
2、关键帧更新都做了什么？更新local_map队列，更新local_map，更新ndt的target_cloud。
3、如果不是第一帧，那么将其与local_map进行ndt配准，配准的所需要的guess_pose是根据匀速运动模型进行计算的。
4、配准得到当前帧的pose，利用当前帧和上一阵的pose，结合匀速运动模型得到下一次配准的guess_pose；如果当前帧的pose相对于上一关键帧的pose距离较大，则更新关键帧。
front_end_node.cpp的注释 /* * @Descripttion: 对任乾大佬的tag4.0增加map---&gt;lidar的tf变换，并可视化最原始的变换后的点云 * @vision: * @Author: suyunzzz * @Date: 2020-08-20 23:40:44 * @LastEditors: Please set LastEditors * @LastEditTime: 2020-08-26 23:20:21 */ /* * @Description: * @Author: Ren Qian * @Date: 2020-02-05 02:56:27 */ #include &lt;ros/ros.h&gt; #include &lt;pcl/common/transforms.h&gt; #include &#34;glog/logging.h&#34; #include &#34;lidar_localization/global_defination/global_defination.h&#34; #include &#34;lidar_localization/subscriber/cloud_subscriber.hpp&#34; #include &#34;lidar_localization/subscriber/imu_subscriber.hpp&#34; #include &#34;lidar_localization/subscriber/gnss_subscriber.hpp&#34; #include &#34;lidar_localization/tf_listener/tf_listener.hpp&#34; #include &#34;lidar_localization/publisher/cloud_publisher.hpp&#34; #include &#34;lidar_localization/publisher/odometry_publisher.hpp&#34; #include &#34;lidar_localization/front_end/front_end.hpp&#34; // 前端相关的头文件 #include &lt;tf/transform_broadcaster." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/2f8af27722a3b25eeba92ccabad1d1f7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-26T23:42:53+08:00" />
<meta property="article:modified_time" content="2020-08-26T23:42:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">从零开始激光slam定位【1】- 激光里程计</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>写在前面：本文是参考知乎<a href="https://zhuanlan.zhihu.com/p/104791974" rel="nofollow">任乾大佬</a>的帖子完成，增加了自己的注释以及一些其他功能，如果有理解不到位的地方，请大家指正~</p> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_5" rel="nofollow">里程计流程</a></li><li><a href="#front_end_nodecpp_12" rel="nofollow">front_end_node.cpp的注释</a></li><li><a href="#_210" rel="nofollow">可视化</a></li><li><a href="#debug_213" rel="nofollow">debug</a></li><li><a href="#_221" rel="nofollow">参考</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_5"></a>里程计流程</h2> 
<p>1、如果当前帧是第一帧，那么将其看做关键帧，进行关键帧更新<br> 2、关键帧更新都做了什么？更新local_map队列，更新local_map，更新ndt的target_cloud。<br> 3、如果不是第一帧，那么将其与local_map进行ndt配准，配准的所需要的guess_pose是根据匀速运动模型进行计算的。<br> 4、配准得到当前帧的pose，利用当前帧和上一阵的pose，结合匀速运动模型得到下一次配准的guess_pose；如果当前帧的pose相对于上一关键帧的pose距离较大，则更新关键帧。</p> 
<h2><a id="front_end_nodecpp_12"></a>front_end_node.cpp的注释</h2> 
<pre><code class="prism language-cpp"><span class="token comment">/*
 * @Descripttion: 对任乾大佬的tag4.0增加map---&gt;lidar的tf变换，并可视化最原始的变换后的点云
 * @vision: 
 * @Author: suyunzzz
 * @Date: 2020-08-20 23:40:44
 * @LastEditors: Please set LastEditors
 * @LastEditTime: 2020-08-26 23:20:21
 */</span>
<span class="token comment">/*
 * @Description: 
 * @Author: Ren Qian
 * @Date: 2020-02-05 02:56:27
 */</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;ros/ros.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pcl/common/transforms.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"glog/logging.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"lidar_localization/global_defination/global_defination.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"lidar_localization/subscriber/cloud_subscriber.hpp"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"lidar_localization/subscriber/imu_subscriber.hpp"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"lidar_localization/subscriber/gnss_subscriber.hpp"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"lidar_localization/tf_listener/tf_listener.hpp"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"lidar_localization/publisher/cloud_publisher.hpp"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"lidar_localization/publisher/odometry_publisher.hpp"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"lidar_localization/front_end/front_end.hpp"</span>           </span><span class="token comment">// 前端相关的头文件</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;tf/transform_broadcaster.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;tf/transform_datatypes.h&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> lidar_localization<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    google<span class="token operator">::</span><span class="token function">InitGoogleLogging</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FLAGS_log_dir <span class="token operator">=</span> WORK_SPACE_PATH <span class="token operator">+</span> <span class="token string">"/Log"</span><span class="token punctuation">;</span>
    FLAGS_alsologtostderr <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化节点</span>
    ros<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"front_end_node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ros<span class="token operator">::</span>NodeHandle nh<span class="token punctuation">;</span>

    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>CloudSubscriber<span class="token operator">&gt;</span> cloud_sub_ptr <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>CloudSubscriber<span class="token operator">&gt;</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span> <span class="token string">"/kitti/velo/pointcloud"</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>IMUSubscriber<span class="token operator">&gt;</span> imu_sub_ptr <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>IMUSubscriber<span class="token operator">&gt;</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span> <span class="token string">"/kitti/oxts/imu"</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>GNSSSubscriber<span class="token operator">&gt;</span> gnss_sub_ptr <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>GNSSSubscriber<span class="token operator">&gt;</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span> <span class="token string">"/kitti/oxts/gps/fix"</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// TF监听。lidar--&gt;imu</span>
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>TFListener<span class="token operator">&gt;</span> lidar_to_imu_ptr <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>TFListener<span class="token operator">&gt;</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span> <span class="token string">"velo_link"</span><span class="token punctuation">,</span> <span class="token string">"imu_link"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   

    <span class="token comment">// 发布者，发布到frame_id="/map"</span>
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>CloudPublisher<span class="token operator">&gt;</span> cloud_pub_ptr <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>CloudPublisher<span class="token operator">&gt;</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span> <span class="token string">"current_scan"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">"/map"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>CloudPublisher<span class="token operator">&gt;</span> raw_cloud_pub_ptr <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>CloudPublisher<span class="token operator">&gt;</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span><span class="token string">"raw_current_scan"</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token string">"/map"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>CloudPublisher<span class="token operator">&gt;</span> local_map_pub_ptr <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>CloudPublisher<span class="token operator">&gt;</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span> <span class="token string">"local_map"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">"/map"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>CloudPublisher<span class="token operator">&gt;</span> global_map_pub_ptr <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>CloudPublisher<span class="token operator">&gt;</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span> <span class="token string">"global_map"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">"/map"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发布odom信息，topic_name,base_frame_id,child_frame_id</span>
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>OdometryPublisher<span class="token operator">&gt;</span> laser_odom_pub_ptr <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>OdometryPublisher<span class="token operator">&gt;</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span> <span class="token string">"laser_odom"</span><span class="token punctuation">,</span> <span class="token string">"map"</span><span class="token punctuation">,</span> <span class="token string">"lidar"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>OdometryPublisher<span class="token operator">&gt;</span> gnss_pub_ptr <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>OdometryPublisher<span class="token operator">&gt;</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span> <span class="token string">"gnss"</span><span class="token punctuation">,</span> <span class="token string">"map"</span><span class="token punctuation">,</span> <span class="token string">"lidar"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建一个前端对象</span>
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>FrontEnd<span class="token operator">&gt;</span> front_end_ptr <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>FrontEnd<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 数据队列</span>
    std<span class="token operator">::</span>deque<span class="token operator">&lt;</span>CloudData<span class="token operator">&gt;</span> cloud_data_buff<span class="token punctuation">;</span>
    std<span class="token operator">::</span>deque<span class="token operator">&lt;</span>IMUData<span class="token operator">&gt;</span> imu_data_buff<span class="token punctuation">;</span>
    std<span class="token operator">::</span>deque<span class="token operator">&lt;</span>GNSSData<span class="token operator">&gt;</span> gnss_data_buff<span class="token punctuation">;</span>
    Eigen<span class="token operator">::</span>Matrix4f lidar_to_imu <span class="token operator">=</span> Eigen<span class="token operator">::</span>Matrix4f<span class="token operator">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> transform_received <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> gnss_origin_position_inited <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> front_end_pose_inited <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>             <span class="token comment">// true 前端pose未初始化</span>

    <span class="token comment">// 局部地图，全局地图，当前帧点云</span>
    CloudData<span class="token operator">::</span>CLOUD_PTR <span class="token function">local_map_ptr</span><span class="token punctuation">(</span><span class="token keyword">new</span> CloudData<span class="token operator">::</span><span class="token function">CLOUD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
    CloudData<span class="token operator">::</span>CLOUD_PTR <span class="token function">global_map_ptr</span><span class="token punctuation">(</span><span class="token keyword">new</span> CloudData<span class="token operator">::</span><span class="token function">CLOUD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CloudData<span class="token operator">::</span>CLOUD_PTR <span class="token function">current_scan_ptr</span><span class="token punctuation">(</span><span class="token keyword">new</span> CloudData<span class="token operator">::</span><span class="token function">CLOUD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CloudData<span class="token operator">::</span>CLOUD_PTR <span class="token function">current_scan_ptr_raw</span><span class="token punctuation">(</span><span class="token keyword">new</span> CloudData<span class="token operator">::</span><span class="token function">CLOUD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 当前帧变换后的结果，</span>

    <span class="token comment">/****************************************************/</span>
    <span class="token comment">// 以下为我新增的tf变换，map---&gt;lidar</span>
    <span class="token comment">// 发布tf变换 map---&gt;lidar</span>
    <span class="token comment">//static tf::TransformBroadcaster br;</span>
    tf<span class="token operator">::</span>TransformBroadcaster br_<span class="token punctuation">;</span>          
    tf<span class="token operator">::</span>Transform transform<span class="token punctuation">;</span>
    tf<span class="token operator">::</span>Quaternion q<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> pose<span class="token punctuation">{<!-- --></span><span class="token keyword">double</span> x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z<span class="token punctuation">;</span>
                <span class="token keyword">double</span> roll<span class="token punctuation">,</span>pitch<span class="token punctuation">,</span>yaw<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> pose current_pose_<span class="token punctuation">;</span>
    <span class="token comment">/***************************************************/</span>
    
    <span class="token keyword">double</span> run_time <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> init_time <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> time_inited <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> has_global_map_published <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 

    ros<span class="token operator">::</span>Rate <span class="token function">rate</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>ros<span class="token operator">::</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ros<span class="token operator">::</span><span class="token function">spinOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 数据读入</span>
        cloud_sub_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ParseData</span><span class="token punctuation">(</span>cloud_data_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        imu_sub_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ParseData</span><span class="token punctuation">(</span>imu_data_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gnss_sub_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ParseData</span><span class="token punctuation">(</span>gnss_data_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果没有得到变换</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transform_received<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lidar_to_imu_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">LookupData</span><span class="token punctuation">(</span>lidar_to_imu<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                transform_received <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>cloud_data_buff<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> imu_data_buff<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> gnss_data_buff<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                CloudData cloud_data <span class="token operator">=</span> cloud_data_buff<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                IMUData imu_data <span class="token operator">=</span> imu_data_buff<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                GNSSData gnss_data <span class="token operator">=</span> gnss_data_buff<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>time_inited<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    time_inited <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    init_time <span class="token operator">=</span> cloud_data<span class="token punctuation">.</span>time<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    run_time <span class="token operator">=</span> cloud_data<span class="token punctuation">.</span>time <span class="token operator">-</span> init_time<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">double</span> d_time <span class="token operator">=</span> cloud_data<span class="token punctuation">.</span>time <span class="token operator">-</span> imu_data<span class="token punctuation">.</span>time<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>d_time <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">0.05</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>       <span class="token comment">// cloud慢</span>
                    cloud_data_buff<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>d_time <span class="token operator">&gt;</span> <span class="token number">0.05</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>     <span class="token comment">// cloud快</span>
                    imu_data_buff<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    gnss_data_buff<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>                                    <span class="token comment">// 开始</span>
                    cloud_data_buff<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 将使用的数据在队列中删除</span>
                    imu_data_buff<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    gnss_data_buff<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    Eigen<span class="token operator">::</span>Matrix4f odometry_matrix <span class="token operator">=</span> Eigen<span class="token operator">::</span>Matrix4f<span class="token operator">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gnss_origin_position_inited<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        gnss_data<span class="token punctuation">.</span><span class="token function">InitOriginPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        gnss_origin_position_inited <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    gnss_data<span class="token punctuation">.</span><span class="token function">UpdateXYZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">odometry_matrix</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> gnss_data<span class="token punctuation">.</span>local_E<span class="token punctuation">;</span>
                    <span class="token function">odometry_matrix</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> gnss_data<span class="token punctuation">.</span>local_N<span class="token punctuation">;</span>
                    <span class="token function">odometry_matrix</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> gnss_data<span class="token punctuation">.</span>local_U<span class="token punctuation">;</span>
                    odometry_matrix<span class="token punctuation">.</span>block<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> imu_data<span class="token punctuation">.</span><span class="token function">GetOrientationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    odometry_matrix <span class="token operator">*</span><span class="token operator">=</span> lidar_to_imu<span class="token punctuation">;</span>
                    gnss_pub_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Publish</span><span class="token punctuation">(</span>odometry_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// gnss发布里程计信息</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>front_end_pose_inited<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>       <span class="token comment">// 如果未初始化前端，将gnss的pose作为初始pose</span>
                        front_end_pose_inited <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        front_end_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetInitPose</span><span class="token punctuation">(</span>odometry_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>        
                    <span class="token punctuation">}</span>
                    front_end_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetPredictPose</span><span class="token punctuation">(</span>odometry_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// gnss的里程计作为预测（没有用到）</span>
                    Eigen<span class="token operator">::</span>Matrix4f laser_matrix <span class="token operator">=</span> front_end_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Update</span><span class="token punctuation">(</span>cloud_data<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// 更新当前帧，返回当前帧的pose</span>
                    laser_odom_pub_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Publish</span><span class="token punctuation">(</span>laser_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// lidar发布里程计信息（当前帧的pose）</span>

                    <span class="token comment">/****************************************************/</span>
                    <span class="token comment">// 以下为我新增的tf变换，map---&gt;lidar</span>
                    <span class="token comment">// 发布tf变换map---&gt;lidar</span>
                    <span class="token comment">// current_pose_写入transform</span>
                    transform<span class="token punctuation">.</span><span class="token function">setOrigin</span><span class="token punctuation">(</span>tf<span class="token operator">::</span><span class="token function">Vector3</span><span class="token punctuation">(</span><span class="token function">laser_matrix</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">laser_matrix</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">laser_matrix</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// transform 设置平移</span>
                    tf<span class="token operator">::</span>Matrix3x3 mat_b<span class="token punctuation">;</span>
                    mat_b<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">laser_matrix</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">laser_matrix</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">laser_matrix</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">laser_matrix</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">laser_matrix</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">laser_matrix</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">laser_matrix</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">laser_matrix</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">laser_matrix</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    
                    mat_b<span class="token punctuation">.</span><span class="token function">getRPY</span><span class="token punctuation">(</span>current_pose_<span class="token punctuation">.</span>roll<span class="token punctuation">,</span> current_pose_<span class="token punctuation">.</span>pitch<span class="token punctuation">,</span> current_pose_<span class="token punctuation">.</span>yaw<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//mat2rpy  旋转</span>
                    q<span class="token punctuation">.</span><span class="token function">setRPY</span><span class="token punctuation">(</span>current_pose_<span class="token punctuation">.</span>roll<span class="token punctuation">,</span> current_pose_<span class="token punctuation">.</span>pitch<span class="token punctuation">,</span> current_pose_<span class="token punctuation">.</span>yaw<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//q from rpy</span>
                    transform<span class="token punctuation">.</span><span class="token function">setRotation</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//trans from q</span>
                    br_<span class="token punctuation">.</span><span class="token function">sendTransform</span><span class="token punctuation">(</span>tf<span class="token operator">::</span><span class="token function">StampedTransform</span><span class="token punctuation">(</span>transform<span class="token punctuation">,</span> ros<span class="token operator">::</span>Time<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"map"</span><span class="token punctuation">,</span> <span class="token string">"lidar"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// map---&gt;scan的transform</span>
                    <span class="token comment">/****************************************************/</span>
                    
                    <span class="token comment">// 当前帧的点云</span>
                    front_end_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetCurrentScan</span><span class="token punctuation">(</span>current_scan_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 变换到global下的当前帧点云</span>
                    cloud_pub_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Publish</span><span class="token punctuation">(</span>current_scan_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// 发布当前帧点云</span>
                    front_end_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetCurrentScanRaw</span><span class="token punctuation">(</span>current_scan_ptr_raw<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 发布变换后的原始点云,未下采样</span>
                    raw_cloud_pub_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Publish</span><span class="token punctuation">(</span>current_scan_ptr_raw<span class="token punctuation">)</span><span class="token punctuation">;</span>


                    <span class="token keyword">if</span> <span class="token punctuation">(</span>front_end_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetNewLocalMap</span><span class="token punctuation">(</span>local_map_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>           <span class="token comment">// 发布局部地图,只有遇到关键帧才能更新局部地图</span>
                        local_map_pub_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Publish</span><span class="token punctuation">(</span>local_map_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>run_time <span class="token operator">&gt;</span> <span class="token number">460.0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>has_global_map_published<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>            <span class="token comment">// 全局地图，只能发布一次，并且有时间限制</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>front_end_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetNewGlobalMap</span><span class="token punctuation">(</span>global_map_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    <span class="token comment">//  每100个关键帧，才更新一次全局地图</span>
                        global_map_pub_ptr<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Publish</span><span class="token punctuation">(</span>global_map_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        has_global_map_published <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        rate<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_210"></a>可视化</h2> 
<p><img src="https://images2.imgbox.com/60/46/lKgNm0mY_o.png" alt="在这里插入图片描述">黄色的代表gnss的里程计，红色的代表激光里程计，大的Axis的坐标系是lidar，小的坐标系是map。</p> 
<h2><a id="debug_213"></a>debug</h2> 
<ol><li></ol> 
<p><code>typename boost::detail::sp_dereference&lt;T&gt;::type boost::shared_ptr&lt;T&gt;::operator*() const [with T = pcl::PointCloud&lt;pcl::PointXYZ&gt;; typename boost::detail::sp_dereference&lt;T&gt;::type = pcl::PointCloud&lt;pcl::PointXYZ&gt;&amp;]: Assertion `px != 0' failed</code></p> 
<p><img src="https://images2.imgbox.com/bc/4f/yuHO1UzR_o.png" alt="在这里插入图片描述"><br> <strong>解决：</strong><br> 这个问题的原因是创建pcl点云指针的时候没有初始化，应该在构造函数中进行初始化。</p> 
<h2><a id="_221"></a>参考</h2> 
<p><a href="https://zhuanlan.zhihu.com/p/104791974" rel="nofollow">从零开始做自动驾驶定位(四): 前端里程计之初试</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/73c985a97c3416eed59c6e6a79b34a63/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">使用注解、切面、反射，对前端传递的参数，做统一的空格（trim）处理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4e6e31a2e3ab2f5ddbf5b3fcc64096e9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">css动画效果之奔跑的小熊</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>