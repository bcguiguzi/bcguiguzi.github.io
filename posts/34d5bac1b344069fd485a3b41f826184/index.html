<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python量化交易学习笔记（25）——Data Feeds扩展 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Python量化交易学习笔记（25）——Data Feeds扩展" />
<meta property="og:description" content="背景：需要扩展data feeds的场景 在backtrader中，data feeds中包含了被普遍认为是业界标准的几个字段：
datetimeopenhighlowclosevolumeopeninterest 可以使用GenericCSVData读取CSV文件，来方便地加载这些数据。但是在很多情况下，还需要在回测框架中使用其他的数据，例如：
利用分类算法，预测出股票是否已经达到买点及卖点（转化为分类问题），在backtrader中按照预测的买点及卖点进行交易，就需要将预测结果读入到框架中进行回测。利用序列预测算法，预测出模型每日的收盘价，将预测值与其他技术指标综合分析，制定交易策略，然后进行回测，这也需要将预测得到的序列值读入到框架中。 因此，我们要想办法从CSV中读入自定义的数据，来使得这些数据可以在策略中得以应用。本文就针对上面提到的第2个场景，来扩展data feeds，实现自定义数据在backtrader回测框架中的使用。
应用场景设定 我们假定这样的应用场景：
已知某只股票的历史日线数据，包含datetime，open，high，low，close字段；已经通过序列预测算法，利用历史数据计算出每日收盘价（或开盘价）的预测值；利用历史日线数据及预测数据对该股票进行策略回测；策略为：当收盘价小于前1日的预测值时，进行买入；当收盘价大于前1日的预测值时，进行卖出。 实现步骤 生成待读入CSV文件，文件中包含datetime，open，high，low，close及自定义数据字段（这里使用predict进行标识）。由于这里只是做示意，因此简单的使用predict = (high &#43; low) / 2来计算predict的值。合并后CSV文件截图如下：
创建GenericCSVData的子类，扩展新的lines对象，添加新的参数，这样在使用这个子类时，调用者就可以通过这个参数，来指定自定义的数据在CSV文件中的哪一列，代码如下： # 扩展DataFeed class GenericCSVDataEx(GenericCSVData): # 添加自定义line lines = (&#39;predict&#39;, ) # openinterest在GenericCSVData中的默认索引是7，这里对自定义的line的索引加1，用户可指定 params = ((&#39;predict&#39;, 8),) 这里创建了一个GenericCSVData的子类GenericCSVDataEx，定义了一个新的lines对象predict，并且添加了一个新的参数predict，默认值设置为8，在后续调用时，根据自定义数据具体在文件中的哪一列，再对这个参数进行重新赋值。
使用创建的子类导入数据，代码如下： # 创建数据 data = GenericCSVDataEx( dataname = datapath, fromdate = datetime.datetime(2019, 1, 1), todate = datetime.datetime(2019, 12, 31), nullvalue = 0.0, dtformat = (&#39;%Y/%m/%d&#39;), datetime = 0, open = 1, high = 2, low = 3, close = 4, volume = -1, openinterest = -1, predict = 5 ) 这里使用了新创建的类GenericCSVDataEx来导入数据。在参数中，从datetime开始，等号后面的值均表示对应字段在CSV文件中的列号，-1表示文件没有该字段数据，可以回看前面的CSV文件的截图，确认一下数据的对应关系。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/34d5bac1b344069fd485a3b41f826184/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-04T16:17:47+08:00" />
<meta property="article:modified_time" content="2023-10-04T16:17:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python量化交易学习笔记（25）——Data Feeds扩展</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5><a id="data_feeds_0"></a>背景：需要扩展data feeds的场景</h5> 
<p>在backtrader中，data feeds中包含了被普遍认为是业界标准的几个字段：</p> 
<ul><li>datetime</li><li>open</li><li>high</li><li>low</li><li>close</li><li>volume</li><li>openinterest</li></ul> 
<p>可以使用GenericCSVData读取CSV文件，来方便地加载这些数据。但是在很多情况下，还需要在回测框架中使用其他的数据，例如：</p> 
<ol><li>利用分类算法，预测出股票是否已经达到买点及卖点（转化为分类问题），在backtrader中按照预测的买点及卖点进行交易，就需要将预测结果读入到框架中进行回测。</li><li>利用序列预测算法，预测出模型每日的收盘价，将预测值与其他技术指标综合分析，制定交易策略，然后进行回测，这也需要将预测得到的序列值读入到框架中。</li></ol> 
<p>因此，我们要想办法从CSV中读入自定义的数据，来使得这些数据可以在策略中得以应用。本文就针对上面提到的第2个场景，来扩展data feeds，实现自定义数据在backtrader回测框架中的使用。</p> 
<h5><a id="_17"></a>应用场景设定</h5> 
<p>我们假定这样的应用场景：</p> 
<ol><li>已知某只股票的历史日线数据，包含datetime，open，high，low，close字段；</li><li>已经通过序列预测算法，利用历史数据计算出每日收盘价（或开盘价）的预测值；</li><li>利用历史日线数据及预测数据对该股票进行策略回测；</li><li>策略为：当收盘价小于前1日的预测值时，进行买入；当收盘价大于前1日的预测值时，进行卖出。</li></ol> 
<h5><a id="_24"></a>实现步骤</h5> 
<ol><li>生成待读入CSV文件，文件中包含datetime，open，high，low，close及自定义数据字段（这里使用predict进行标识）。由于这里只是做示意，因此简单的使用predict = (high + low) / 2来计算predict的值。合并后CSV文件截图如下：<br> <img src="https://images2.imgbox.com/65/62/HsEZJV0Q_o.png" alt="在这里插入图片描述"></li><li>创建GenericCSVData的子类，扩展新的lines对象，添加新的参数，这样在使用这个子类时，调用者就可以通过这个参数，来指定自定义的数据在CSV文件中的哪一列，代码如下：</li></ol> 
<pre><code class="prism language-python"><span class="token comment"># 扩展DataFeed</span>
<span class="token keyword">class</span> <span class="token class-name">GenericCSVDataEx</span><span class="token punctuation">(</span>GenericCSVData<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 添加自定义line</span>
    lines <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'predict'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
    <span class="token comment"># openinterest在GenericCSVData中的默认索引是7，这里对自定义的line的索引加1，用户可指定</span>
    params <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'predict'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里创建了一个GenericCSVData的子类GenericCSVDataEx，定义了一个新的lines对象predict，并且添加了一个新的参数predict，默认值设置为8，在后续调用时，根据自定义数据具体在文件中的哪一列，再对这个参数进行重新赋值。</p> 
<ol start="3"><li>使用创建的子类导入数据，代码如下：</li></ol> 
<pre><code class="prism language-python"><span class="token comment"># 创建数据</span>
data <span class="token operator">=</span> GenericCSVDataEx<span class="token punctuation">(</span>
        dataname <span class="token operator">=</span> datapath<span class="token punctuation">,</span>
        fromdate <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        todate <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        nullvalue <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
        dtformat <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'%Y/%m/%d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        datetime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token builtin">open</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        high <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
        low <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
        close <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
        volume <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        openinterest <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        predict <span class="token operator">=</span> <span class="token number">5</span> 
        <span class="token punctuation">)</span>
</code></pre> 
<p>这里使用了新创建的类GenericCSVDataEx来导入数据。在参数中，从datetime开始，等号后面的值均表示对应字段在CSV文件中的列号，-1表示文件没有该字段数据，可以回看前面的CSV文件的截图，确认一下数据的对应关系。</p> 
<ol start="4"><li>在Strategy中使用自定义字段数据，主要代码如下：</li></ol> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">TestStrategy</span><span class="token punctuation">(</span>bt<span class="token punctuation">.</span>Strategy<span class="token punctuation">)</span><span class="token punctuation">:</span>
    params <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token comment"># 要跳过的K线根数</span>
        <span class="token punctuation">(</span><span class="token string">'skip_len'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 引用data[0]数据的收盘价数据</span>
        self<span class="token punctuation">.</span>dataclose <span class="token operator">=</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>close
        self<span class="token punctuation">.</span>datapredict <span class="token operator">=</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>predict
        <span class="token comment"># 用于绘制predict曲线</span>
        btind<span class="token punctuation">.</span>SMA<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>predict<span class="token punctuation">,</span> period <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> subplot <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token comment"># 用于记录订单状态</span>
        self<span class="token punctuation">.</span>order <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>buyprice <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>buycomm <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">def</span> <span class="token function">next</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 因为需要在策略中需要和前一日的预测值比较，所以要跳过第1根K线</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>skip_len<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token comment"># 检查是否有订单等待处理，如果是就不再进行其他下单</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>order<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token comment"># 检查是否已经进场</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>position<span class="token punctuation">:</span>
            <span class="token comment"># 还未进场，则只能进行买入</span>
            <span class="token comment"># 当日收盘价小于前一日预测价</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>dataclose<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>datapredict<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token comment"># 买买买</span>
                <span class="token comment"># 记录订单避免二次下单</span>
                self<span class="token punctuation">.</span>order <span class="token operator">=</span> self<span class="token punctuation">.</span>buy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 如果已经在场内，则可以进行卖出操作</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 当日收盘价大于前一日预测价</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>dataclose<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>datapredict<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token comment"># 卖卖卖</span>
                <span class="token comment"># 记录订单避免二次下单</span>
                self<span class="token punctuation">.</span>order <span class="token operator">=</span> self<span class="token punctuation">.</span>sell<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>在init函数中，直接使用self.datas[0].predict就可以访问到我们自定义的predict字段的值，然后将它保存在实例变量self.datapredict中，这样就可以在next函数中进行使用了。</p> 
<pre><code class="prism language-python">		self<span class="token punctuation">.</span>datapredict <span class="token operator">=</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>predict
</code></pre> 
<p>在next函数中实现策略：当收盘价小于前1日的预测值时，进行买入；当收盘价大于前1日的预测值时，进行卖出。</p> 
<pre><code class="prism language-python">        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>position<span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>dataclose<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>datapredict<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>order <span class="token operator">=</span> self<span class="token punctuation">.</span>buy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>dataclose<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>datapredict<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>order <span class="token operator">=</span> self<span class="token punctuation">.</span>sell<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>需要说明以下几点：</p> 
<ul><li>这里的self.datapredict（self.datas[0].predict）是lines对象，在next函数中使用时，索引[0]表示当日的数据，索引[-1]表示前1日的数据</li><li>由于要和前1日predict的值做比较，而对于第1个交易日而言，是没有前1日predict值的，因此在next函数中，使用下面的代码跳过1根K线</li></ul> 
<pre><code class="prism language-python">        <span class="token comment"># 因为需要在策略中需要和前一日的预测值比较，所以要跳过第1根K线</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>skip_len<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
</code></pre> 
<ul><li>backtrader没有提供自定义的数据绘制功能，可以在init函数中，通过借用单日的简单移动平均线来绘制自定义数据的曲线</li></ul> 
<pre><code class="prism language-python">        <span class="token comment"># 用于绘制predict曲线</span>
        btind<span class="token punctuation">.</span>SMA<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>predict<span class="token punctuation">,</span> period <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> subplot <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p>回测结果如下图所示：<br> <img src="https://images2.imgbox.com/16/d6/VI2CTSu0_o.png" alt="在这里插入图片描述"></p> 
<p>Data Feeds扩展代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> <span class="token punctuation">(</span>absolute_import<span class="token punctuation">,</span> division<span class="token punctuation">,</span> print_function<span class="token punctuation">,</span>
                        unicode_literals<span class="token punctuation">)</span>
<span class="token keyword">import</span> datetime  <span class="token comment"># 用于datetime对象操作</span>
<span class="token keyword">import</span> os<span class="token punctuation">.</span>path  <span class="token comment"># 用于管理路径</span>
<span class="token keyword">import</span> sys  <span class="token comment"># 用于在argvTo[0]中找到脚本名称</span>
<span class="token keyword">import</span> backtrader <span class="token keyword">as</span> bt <span class="token comment"># 引入backtrader框架</span>
<span class="token keyword">from</span> backtrader<span class="token punctuation">.</span>feeds <span class="token keyword">import</span> GenericCSVData <span class="token comment"># 用于扩展DataFeed</span>
<span class="token keyword">import</span> backtrader<span class="token punctuation">.</span>indicators <span class="token keyword">as</span> btind

<span class="token comment"># 扩展DataFeed</span>
<span class="token keyword">class</span> <span class="token class-name">GenericCSVDataEx</span><span class="token punctuation">(</span>GenericCSVData<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 添加自定义line</span>
    lines <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'predict'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
    <span class="token comment"># openinterest在GenericCSVData中的默认索引是7，这里对自定义的line的索引加1，用户可指定</span>
    params <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'predict'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span>


<span class="token comment"># 创建策略</span>
<span class="token keyword">class</span> <span class="token class-name">TestStrategy</span><span class="token punctuation">(</span>bt<span class="token punctuation">.</span>Strategy<span class="token punctuation">)</span><span class="token punctuation">:</span>
    params <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token comment"># 要跳过的K线根数</span>
        <span class="token punctuation">(</span><span class="token string">'skip_len'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> txt<span class="token punctuation">,</span> dt<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 策略的日志函数'''</span>
        dt <span class="token operator">=</span> dt <span class="token keyword">or</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>date<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s, %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>dt<span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> txt<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 引用data[0]数据的收盘价数据</span>
        self<span class="token punctuation">.</span>dataclose <span class="token operator">=</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>close
        self<span class="token punctuation">.</span>datapredict <span class="token operator">=</span> self<span class="token punctuation">.</span>datas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>predict
        <span class="token comment"># 用于绘制predict曲线</span>
        btind<span class="token punctuation">.</span>SMA<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>predict<span class="token punctuation">,</span> period <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> subplot <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token comment"># 用于记录订单状态</span>
        self<span class="token punctuation">.</span>order <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>buyprice <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>buycomm <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">def</span> <span class="token function">notify_order</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> order<span class="token punctuation">.</span>status <span class="token keyword">in</span> <span class="token punctuation">[</span>order<span class="token punctuation">.</span>Submitted<span class="token punctuation">,</span> order<span class="token punctuation">.</span>Accepted<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token comment"># 提交给代理或者由代理接收的买/卖订单 - 不做操作</span>
            <span class="token keyword">return</span>
        <span class="token comment"># 检查订单是否执行完毕</span>
        <span class="token comment"># 注意：如果没有足够资金，代理会拒绝订单</span>
        <span class="token keyword">if</span> order<span class="token punctuation">.</span>status <span class="token keyword">in</span> <span class="token punctuation">[</span>order<span class="token punctuation">.</span>Completed<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> order<span class="token punctuation">.</span>isbuy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">(</span>
                    <span class="token string">'BUY EXECUTED, Price: %.2f, Cost: %.2f, Comm %.2f'</span> <span class="token operator">%</span>
                    <span class="token punctuation">(</span>order<span class="token punctuation">.</span>executed<span class="token punctuation">.</span>price<span class="token punctuation">,</span>
                     order<span class="token punctuation">.</span>executed<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                     order<span class="token punctuation">.</span>executed<span class="token punctuation">.</span>comm<span class="token punctuation">)</span><span class="token punctuation">)</span>

                self<span class="token punctuation">.</span>buyprice <span class="token operator">=</span> order<span class="token punctuation">.</span>executed<span class="token punctuation">.</span>price
                self<span class="token punctuation">.</span>buycomm <span class="token operator">=</span> order<span class="token punctuation">.</span>executed<span class="token punctuation">.</span>comm
            <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token comment"># 卖</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">'SELL EXECUTED, Price: %.2f, Cost: %.2f, Comm %.2f'</span> <span class="token operator">%</span>
                         <span class="token punctuation">(</span>order<span class="token punctuation">.</span>executed<span class="token punctuation">.</span>price<span class="token punctuation">,</span>
                          order<span class="token punctuation">.</span>executed<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                          order<span class="token punctuation">.</span>executed<span class="token punctuation">.</span>comm<span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>bar_executed <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> order<span class="token punctuation">.</span>status <span class="token keyword">in</span> <span class="token punctuation">[</span>order<span class="token punctuation">.</span>Canceled<span class="token punctuation">,</span> order<span class="token punctuation">.</span>Margin<span class="token punctuation">,</span> order<span class="token punctuation">.</span>Rejected<span class="token punctuation">]</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">'Order Canceled/Margin/Rejected'</span><span class="token punctuation">)</span>
        <span class="token comment"># 无等待处理订单</span>
        self<span class="token punctuation">.</span>order <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">def</span> <span class="token function">notify_trade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trade<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> trade<span class="token punctuation">.</span>isclosed<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">'OPERATION PROFIT, GROSS %.2f, NET %.2f'</span> <span class="token operator">%</span>
                 <span class="token punctuation">(</span>trade<span class="token punctuation">.</span>pnl<span class="token punctuation">,</span> trade<span class="token punctuation">.</span>pnlcomm<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">next</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 因为需要在策略中需要和前一日的预测值比较，所以要跳过第1根K线</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>skip_len<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token comment"># 日志输出收盘价数据</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">'Close, %.2f'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>dataclose<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 检查是否有订单等待处理，如果是就不再进行其他下单</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>order<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token comment"># 检查是否已经进场</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>position<span class="token punctuation">:</span>
            <span class="token comment"># 还未进场，则只能进行买入</span>
            <span class="token comment"># 当日收盘价小于前一日预测价</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>dataclose<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>datapredict<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token comment"># 买买买</span>
                <span class="token comment"># 记录订单避免二次下单</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">'BUY CREATE, %.2f'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>dataclose<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>order <span class="token operator">=</span> self<span class="token punctuation">.</span>buy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 如果已经在场内，则可以进行卖出操作</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 当日收盘价大于前一日预测价</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>dataclose<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>datapredict<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token comment"># 卖卖卖</span>
                <span class="token comment"># 记录订单避免二次下单</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token string">'SELL CREATE, %.2f'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>dataclose<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>order <span class="token operator">=</span> self<span class="token punctuation">.</span>sell<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 创建cerebro实体</span>
cerebro <span class="token operator">=</span> bt<span class="token punctuation">.</span>Cerebro<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 添加策略</span>
cerebro<span class="token punctuation">.</span>addstrategy<span class="token punctuation">(</span>TestStrategy<span class="token punctuation">)</span>
<span class="token comment"># 先找到脚本的位置，然后根据脚本与数据的相对路径关系找到数据位置</span>
<span class="token comment"># 这样脚本从任意地方被调用，都可以正确地访问到数据</span>
modpath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
datapath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>modpath<span class="token punctuation">,</span> <span class="token string">'./custom.csv'</span><span class="token punctuation">)</span>
<span class="token comment"># 创建数据</span>
data <span class="token operator">=</span> GenericCSVDataEx<span class="token punctuation">(</span>
        dataname <span class="token operator">=</span> datapath<span class="token punctuation">,</span>
        fromdate <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        todate <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        nullvalue <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
        dtformat <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'%Y/%m/%d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        datetime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token builtin">open</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        high <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
        low <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
        close <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
        volume <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        openinterest <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        predict <span class="token operator">=</span> <span class="token number">5</span> 
        <span class="token punctuation">)</span>
<span class="token comment"># 在Cerebro中添加价格数据</span>
cerebro<span class="token punctuation">.</span>adddata<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token comment"># 设置启动资金</span>
cerebro<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>setcash<span class="token punctuation">(</span><span class="token number">100000.0</span><span class="token punctuation">)</span>
<span class="token comment"># 设置交易单位大小</span>
cerebro<span class="token punctuation">.</span>addsizer<span class="token punctuation">(</span>bt<span class="token punctuation">.</span>sizers<span class="token punctuation">.</span>FixedSize<span class="token punctuation">,</span> stake <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token comment"># 设置佣金为千分之一</span>
cerebro<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>setcommission<span class="token punctuation">(</span>commission<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>
<span class="token comment"># 打印开始信息</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Starting Portfolio Value: %.2f'</span> <span class="token operator">%</span> cerebro<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 遍历所有数据</span>
cerebro<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 打印最后结果</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Final Portfolio Value: %.2f'</span> <span class="token operator">%</span> cerebro<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
cerebro<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<p><strong>博客内容只用于交流学习，不构成投资建议，盈亏自负！</strong></p> 
<p>个人博客：http://coderx.com.cn/（优先更新）<br> 项目最新代码：https://gitee.com/sl/quant_from_scratch<br> 欢迎大家转发、留言。有微信群用于学习交流，感兴趣的读者请扫码加微信！<br> 如果认为博客对您有帮助，可以扫码进行捐赠，感谢！</p> 
<table><thead><tr><th align="center">微信二维码</th><th align="center">微信捐赠二维码</th></tr></thead><tbody><tr><td align="center"></td><td align="center"></td></tr><tr><td align="center"><img src="https://images2.imgbox.com/1e/dc/IuKRAiMw_o.png" alt="在这里插入图片描述"></td><td align="center"><img src="https://images2.imgbox.com/13/9a/3Slu5vJt_o.png" alt="在这里插入图片描述"></td></tr></tbody></table>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6bff6162139ebb89e7146e15d2b4d0fc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python量化交易学习笔记（40）——backtrader的resample浅析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/00fa89a59e930b2079712f37dbce4bac/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">为什么选择Python？探索这门多才多艺的编程语言</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>