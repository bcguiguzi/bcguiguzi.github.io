<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>绘制圆形surfaceview，解决预览框的畸变问题 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="绘制圆形surfaceview，解决预览框的畸变问题" />
<meta property="og:description" content="文章目录 绘制圆形的SurfaceView2.自己定义MySurfaceView类，继承自SurfaceView类3.接下来是MySurfaceView的实例化4.布局文件部分 本Demo的GitHub地址： 绘制圆形的SurfaceView 首先介绍一下什么是SurfaceView Surface意为表层、表面，顾名思义SurfaceView就是指一个在表层的View对象。为什么说是在表层呢，这是因为它有点特殊跟其他View不一样，其他View是绘制在“表层”的上面，而它就是充当“表层”本身。创建SurfaceView的时候需要实现SurfaceHolder.Callback接口，它可以用来监听SurfaceView的状态，比如：SurfaceView的改变 、SurfaceView的创建 、SurfaceView 销毁等，我们可以在相应的方法中做一些比如初始化的操作或者清空的操作等等。
Android系统提供了View进行绘图处理，我们通过自定义的View可以满足大部分的绘图需求，但是这有个问题就是我们通常自定义的View是用于主动更新情况的，用户无法控制其绘制的速度，由于View是通过invalidate方法通知系统去调用view.onDraw方法进行重绘，而Android系统是通过发出VSYNC信号来进行屏幕的重绘，刷新的时间是16ms,如果在16ms内View完成不了执行的操作，用户就会看着卡顿，比如当draw方法里执行的逻辑过多，需要频繁刷新的界面上，例如游戏界面，那么就会不断的阻塞主线程，从而导致画面卡顿。而SurfaceView相当于是另一个绘图线程，它是不会阻碍主线程，并且它在底层实现机制中实现了双缓冲机制。
SurfaceView最常见的应用场景就是在摄像头的预览，手机录像和拍照的时候屏幕上的显示，就是在surfaceView进行显示的
下面的代码是他最常见的生命周期， 当SurfaceView的界面不可见时，就会调用surfaceDestroyed（）函数来杀死本进程，当重新进入本界面时，需要重新加载。 @Override public void surfaceCreated(SurfaceHolder holder) { } @Override public void surfaceChanged(SurfaceHolder holder, int format, int width, int height) { } @Override public void surfaceDestroyed(SurfaceHolder holder) { } 2.自己定义MySurfaceView类，继承自SurfaceView类 先看一下效果图
我的理解是,可以把它看成是一个红色的图层覆盖了原来的SurfaceView，即我们只能看到圆框中的内容 package com.example.heartratedect; import android.content.Context; import android.graphics.Canvas; import android.graphics.Paint; import android.graphics.Path; import android.graphics.Region; import android.hardware.Camera; import android.util.AttributeSet; import android.util.Log; import android.view.SurfaceView; /** * 圆形SurfaceView * 这个SurfaceView 使用时 必须设置其background，可以设置全透明背景 */ public class MySurfaceView extends SurfaceView { private Paint paint; private int widthSize; private Camera camera; private int height; public MySurfaceView(Context context, AttributeSet attrs, int defStyle) { super(context, attrs, defStyle); initView(); } public MySurfaceView(Context context, AttributeSet attrs) { super(context, attrs); initView(); } public MySurfaceView(Context context) { super(context); initView(); } private void initView() { this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/435315489e9ceea04b1aaed3810d4531/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-06-30T11:13:44+08:00" />
<meta property="article:modified_time" content="2018-06-30T11:13:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">绘制圆形surfaceview，解决预览框的畸变问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#SurfaceView_6" rel="nofollow">绘制圆形的SurfaceView</a></li><li><ul><li><a href="#2MySurfaceViewSurfaceView_39" rel="nofollow">2.自己定义MySurfaceView类，继承自SurfaceView类</a></li><li><a href="#3MySurfaceView_178" rel="nofollow">3.接下来是MySurfaceView的实例化</a></li><li><a href="#4_242" rel="nofollow">4.布局文件部分</a></li></ul> 
  </li><li><a href="#DemoGitHub_284" rel="nofollow">本Demo的GitHub地址：</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="SurfaceView_6"></a>绘制圆形的SurfaceView</h2> 
<ol><li>首先介绍一下什么是SurfaceView</li></ol> 
<hr> 
<p>Surface意为表层、表面，顾名思义SurfaceView就是指一个在表层的View对象。为什么说是在表层呢，这是因为它有点特殊跟其他View不一样，其他View是绘制在“表层”的上面，而它就是充当“表层”本身。创建SurfaceView的时候需要实现SurfaceHolder.Callback接口，它可以用来监听SurfaceView的状态，比如：SurfaceView的改变 、SurfaceView的创建 、SurfaceView 销毁等，我们可以在相应的方法中做一些比如初始化的操作或者清空的操作等等。</p> 
<p>Android系统提供了View进行绘图处理，我们通过自定义的View可以满足大部分的绘图需求，但是这有个问题就是我们通常自定义的View是用于主动更新情况的，用户无法控制其绘制的速度，由于View是通过invalidate方法通知系统去调用view.onDraw方法进行重绘，而Android系统是通过发出VSYNC信号来进行屏幕的重绘，刷新的时间是16ms,如果在16ms内View完成不了执行的操作，用户就会看着卡顿，比如当draw方法里执行的逻辑过多，需要频繁刷新的界面上，例如游戏界面，那么就会不断的阻塞主线程，从而导致画面卡顿。而SurfaceView相当于是另一个绘图线程，它是不会阻碍主线程，并且它在底层实现机制中实现了双缓冲机制。</p> 
<p>SurfaceView最常见的应用场景就是在摄像头的预览，手机录像和拍照的时候屏幕上的显示，就是在surfaceView进行显示的<br> </p> 
<center> 
 <br> 
 <img src="https://images2.imgbox.com/6c/f3/vK3vVk83_o.jpg" alt="这里写图片描述"> 
 <br> 下面的代码是他最常见的生命周期， 
 <code>当SurfaceView的界面不可见时，就会调用surfaceDestroyed（）函数来杀死本进程</code>，当重新进入本界面时，需要重新加载。 
</center> 
<p></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceCreated</span><span class="token punctuation">(</span>SurfaceHolder holder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      
    <span class="token punctuation">}</span>
   <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceChanged</span><span class="token punctuation">(</span>SurfaceHolder holder<span class="token punctuation">,</span> <span class="token keyword">int</span> format<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token punctuation">}</span>
 
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceDestroyed</span><span class="token punctuation">(</span>SurfaceHolder holder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2MySurfaceViewSurfaceView_39"></a>2.自己定义MySurfaceView类，继承自SurfaceView类</h3> 
<p>先看一下效果图<br> </p> 
<center> 
 <br> 
 <img src="https://images2.imgbox.com/8e/62/S5K5SUjm_o.jpg" alt="这里写图片描述"> 
 <br> 
 <code>我的理解是,可以把它看成是一个红色的图层覆盖了原来的SurfaceView，即我们只能看到圆框中的内容</code> 
</center> 
<p></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>heartratedect<span class="token punctuation">;</span>

<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>Canvas<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>Paint<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>Path<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>Region<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span>Camera<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>AttributeSet<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>SurfaceView<span class="token punctuation">;</span>

<span class="token comment">/**
 * 圆形SurfaceView
 * 这个SurfaceView 使用时 必须设置其background，可以设置全透明背景
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySurfaceView</span> <span class="token keyword">extends</span> <span class="token class-name">SurfaceView</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> Paint paint<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> widthSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> Camera camera<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> height<span class="token punctuation">;</span> 



    <span class="token keyword">public</span> <span class="token function">MySurfaceView</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> AttributeSet attrs<span class="token punctuation">,</span> <span class="token keyword">int</span> defStyle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> defStyle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">MySurfaceView</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> AttributeSet attrs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">MySurfaceView</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setFocusable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setFocusableInTouchMode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onMeasure</span><span class="token punctuation">(</span><span class="token keyword">int</span> widthMeasureSpec<span class="token punctuation">,</span> <span class="token keyword">int</span> heightMeasureSpec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onMeasure</span><span class="token punctuation">(</span>widthMeasureSpec<span class="token punctuation">,</span> heightMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        widthSize <span class="token operator">=</span> MeasureSpec<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span>widthMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取屏幕长宽比例，这样设置不会发生畸变，千万不要根据一个手机设定一个数</span>
        <span class="token comment">//那样换一个手机就可能会出现显示的比例问题</span>
        <span class="token keyword">int</span> screenWidth <span class="token operator">=</span> CommonUtils<span class="token punctuation">.</span><span class="token function">getScreenWidth</span><span class="token punctuation">(</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> screenHeight <span class="token operator">=</span> CommonUtils<span class="token punctuation">.</span><span class="token function">getScreenHeight</span><span class="token punctuation">(</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        height<span class="token operator">=</span><span class="token number">600</span><span class="token punctuation">;</span>
        <span class="token comment">//可以理解为红色的背景盖住了大部分的区域，我们只能看到圆框里面的，如果还是按照原来的比例绘制surfaceview</span>
        <span class="token comment">//需要把手机拿的很远才可以显示出整张脸，故而我用了一个比较取巧的办法就是，按比例缩小，试验了很多数后，感觉0.55</span>
        <span class="token comment">//是最合适的比例</span>
        <span class="token keyword">double</span> screenWidth1<span class="token operator">=</span> <span class="token number">0.55</span><span class="token operator">*</span>screenWidth<span class="token punctuation">;</span>
        <span class="token keyword">double</span> screenHeight1<span class="token operator">=</span> <span class="token number">0.55</span><span class="token operator">*</span>screenHeight<span class="token punctuation">;</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"onMeasure"</span><span class="token punctuation">,</span> <span class="token string">"widthSize="</span><span class="token operator">+</span>widthSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"onMeasure"</span><span class="token punctuation">,</span> <span class="token string">"draw: widthMeasureSpec = "</span> <span class="token operator">+</span>screenWidth <span class="token operator">+</span> <span class="token string">"  heightMeasureSpec = "</span> <span class="token operator">+</span> screenHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//绘制的输入参数必须是整数型，做浮点型运算后为float型数据，故需要做取整操作</span>
        <span class="token function">setMeasuredDimension</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> screenWidth1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> screenHeight1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//setMeasuredDimension(widthSize, heightSize);</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token comment">//绘制一个圆形的框，并设置圆框的坐标和半径大小</span>
    <span class="token comment">//这个绘制在16:9的手机上显示很好，但是在更长的手机上（大于16/9）会偏上，</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">draw</span><span class="token punctuation">(</span>Canvas canvas<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"onDraw"</span><span class="token punctuation">,</span> <span class="token string">"draw: test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Path path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//path.addCircle(widthSize / 2, height / 2, height / 2, Path.Direction.CCW);</span>
        path<span class="token punctuation">.</span><span class="token function">addCircle</span><span class="token punctuation">(</span>widthSize <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> widthSize <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> widthSize <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> Path<span class="token punctuation">.</span>Direction<span class="token punctuation">.</span>CCW<span class="token punctuation">)</span><span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span><span class="token function">clipPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> Region<span class="token punctuation">.</span>Op<span class="token punctuation">.</span>REPLACE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onDraw</span><span class="token punctuation">(</span>Canvas canvas<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"onDraw"</span><span class="token punctuation">,</span> <span class="token string">"onDraw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onSizeChanged</span><span class="token punctuation">(</span><span class="token keyword">int</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> h<span class="token punctuation">,</span> <span class="token keyword">int</span> oldw<span class="token punctuation">,</span> <span class="token keyword">int</span> oldh<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">int</span> screenWidth <span class="token operator">=</span> CommonUtils<span class="token punctuation">.</span><span class="token function">getScreenWidth</span><span class="token punctuation">(</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> screenHeight <span class="token operator">=</span> CommonUtils<span class="token punctuation">.</span><span class="token function">getScreenHeight</span><span class="token punctuation">(</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"screenWidth"</span><span class="token punctuation">,</span>Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>screenWidth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"screenHeight"</span><span class="token punctuation">,</span>Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>screenHeight<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        w <span class="token operator">=</span> screenWidth<span class="token punctuation">;</span>
        h <span class="token operator">=</span> screenHeight<span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onSizeChanged</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> oldw<span class="token punctuation">,</span> oldh<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>heartratedect<span class="token punctuation">;</span>

<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>DisplayMetrics<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>ViewGroup<span class="token punctuation">;</span>
<span class="token keyword">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>WindowManager<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonUtils</span> <span class="token punctuation">{<!-- --></span>


  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getScreenWidth</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        WindowManager windowManager <span class="token operator">=</span> <span class="token punctuation">(</span>WindowManager<span class="token punctuation">)</span>        context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>WINDOW_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        DisplayMetrics outMetrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建了一张白纸</span>
        windowManager<span class="token punctuation">.</span><span class="token function">getDefaultDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span>outMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 给白纸设置宽高</span>
        <span class="token keyword">return</span> outMetrics<span class="token punctuation">.</span>widthPixels<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getScreenHeight</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        WindowManager windowManager <span class="token operator">=</span> <span class="token punctuation">(</span>WindowManager<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>WINDOW_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        DisplayMetrics outMetrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建了一张白纸</span>
        windowManager<span class="token punctuation">.</span><span class="token function">getDefaultDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span>outMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 给白纸设置宽高</span>
        <span class="token keyword">return</span> outMetrics<span class="token punctuation">.</span>heightPixels<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

 
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="3MySurfaceView_178"></a>3.接下来是MySurfaceView的实例化</h3> 
<p>实例化的方法和SurfaceView一样</p> 
<pre><code class="prism language-java"> <span class="token keyword">private</span> Camera camera<span class="token punctuation">;</span>
 <span class="token keyword">private</span> MySurfaceView surfaceView<span class="token punctuation">;</span>
 surfaceView <span class="token operator">=</span> <span class="token punctuation">(</span>MySurfaceView<span class="token punctuation">)</span>CameraLayout<span class="token punctuation">.</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>camera_mysurfaceview<span class="token punctuation">)</span><span class="token punctuation">;</span>
 cameraSurfaceHolder <span class="token operator">=</span> surfaceView<span class="token punctuation">.</span><span class="token function">getHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 cameraSurfaceHolder<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SurfaceHolder<span class="token punctuation">.</span>Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceCreated</span><span class="token punctuation">(</span>SurfaceHolder holder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    camera<span class="token punctuation">.</span><span class="token function">setPreviewDisplay</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    isPreview <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    camera<span class="token punctuation">.</span><span class="token function">startPreview</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                cameraSurfaceHolder <span class="token operator">=</span> holder<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceChanged</span><span class="token punctuation">(</span>SurfaceHolder holder<span class="token punctuation">,</span> <span class="token keyword">int</span> format<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                cameraSurfaceHolder <span class="token operator">=</span> holder<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceDestroyed</span><span class="token punctuation">(</span>SurfaceHolder holder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">releaseCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// This method was deprecated in API level 11. this is ignored, this value is set automatically when needed.   </span>
        cameraSurfaceHolder<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>SurfaceHolder<span class="token punctuation">.</span>SURFACE_TYPE_PUSH_BUFFERS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 初始化摄像头  ，设置为前置相机</span>
        camera <span class="token operator">=</span> Camera<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>Camera<span class="token punctuation">.</span>CameraInfo<span class="token punctuation">.</span>CAMERA_FACING_FRONT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Camera<span class="token punctuation">.</span>Parameters parameters <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 每秒30帧  </span>
        parameters<span class="token punctuation">.</span><span class="token function">setPreviewFrameRate</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        camera<span class="token punctuation">.</span><span class="token function">setParameters</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        camera<span class="token punctuation">.</span><span class="token function">setDisplayOrientation</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token comment">/**
     * 释放摄像头资源
     */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">releaseCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>camera <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                camera<span class="token punctuation">.</span><span class="token function">setPreviewCallback</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                camera<span class="token punctuation">.</span><span class="token function">stopPreview</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                camera<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                camera<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                camera <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>上述代码并没有涉及到进度条的定义及绘制，所以不会存在显示不协调的问题。我的程序在调试的过程中对曲面屏非常不友好，归结原因应该是两侧的延展和屏幕获取的比例不一致，这个地方没有深入研究，等实验室买台曲面屏的手机，做好调试再来更新。</p> 
<h3><a id="4_242"></a>4.布局文件部分</h3> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RelativeLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/activity_camera<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@drawable/background_camera_activity<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

     //注意包名应该导入自己的
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>com.example.MySurfaceView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_marginTop</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>40dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_marginLeft</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>-30dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_centerHorizontal</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@+id/camera_mysurfaceview<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>200dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>200dp<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@drawable/circle<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RelativeLayout</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>同时需要给他加一个背景的圆框才行，即上面代码中background的设置，新建一个xml文件命名为circle，写下下面代码并放置在drawable文件夹下</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shape</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>shape</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rectangle<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>solid</span> <span class="token attr-name"><span class="token namespace">android:</span>color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#00000000<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>corners</span> <span class="token attr-name"><span class="token namespace">android:</span>radius</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>90dp<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stroke</span>
        <span class="token attr-name"><span class="token namespace">android:</span>width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>4dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#fff<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shape</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>这样就大工告成了，本人也是刚入门的小菜，如有啥问题，欢迎沟通，后面有啥进展我会再继续更新。其中有些取巧的的行为：比如缩小surfaceview的比例使之正好和圆形框的直径差不多大小，但是使用体验上还是有些不舒服，后面还是要继续改进</p> 
<h2><a id="DemoGitHub_284"></a>本Demo的GitHub地址：</h2> 
<p><a href="https://github.com/qunqunstyle/multithreading">https://github.com/qunqunstyle/multithreading</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ae29f5b25595590d4bbec81a3fee437a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">LM2596S-ADJ DC-DC降压芯片使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d8ea86992b221b2de31ffc6d0f110693/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">2018-07-01-系统分析与设计作业Lesson16</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>