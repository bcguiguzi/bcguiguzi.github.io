<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>蛇形卷积【浅读 / 即插即用】 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="蛇形卷积【浅读 / 即插即用】" />
<meta property="og:description" content="Dynamic Snake Convolution based on Topological Geometric Constraints for
Tubular Structure Segmentation(基于拓扑几何约束的动态蛇形卷积管状结构分割)
https://github.com/YaoleiQi/DSCNet
目录 摘要结论代码 摘要 拓扑管状结构(如血管和道路)的准确分割在各个领域都至关重要，可以确保下游任务的准确性和效率。然而，许多因素使任务复杂化，包括薄的局部结构和可变的全局形态。在这项工作中，我们注意到管状结构的特殊性，并利用这一知识指导我们的DSCNet在三个阶段同时增强感知:特征提取、特征融合和损失约束。首先，我们提出了一种动态蛇形卷积，通过自适应聚焦细长和弯曲的局部结构来准确捕捉管状结构的特征。随后，我们提出了一种多视角特征融合策略，以补充特征融合过程中对多个视角特征的关注，确保保留来自不同全局形态的重要信息。最后，提出了一种基于持久同调的连续性约束损失函数，以更好地约束分割的拓扑连续性。在二维和三维数据集上的实验表明，与几种方法相比，我们的DSCNet在管状结构分割任务上具有更好的准确性和连续性。
具体贡献有三个方面：
(1)提出了一种动态蛇形卷积算法，自适应聚焦于细长和弯曲的局部特征，在二维和三维数据集上实现管状结构的精确分割。我们的模型使用内部和外部测试数据进行了彻底验证。(2)提出多视角特征融合策略，补充对多视角重要特征的关注。(3)提出一种基于持久同调的拓扑连续性约束损失函数，较好地约束了分割的连续性。 结论 在本研究中，我们关注管状结构的特殊特征，并利用这些知识指导模型在特征提取、特征融合和损失约束三个阶段同时增强感知。首先，我们提出了一种动态蛇形卷积，自适应聚焦于细长和扭曲的结构，从而准确捕捉管状结构的特征。其次，引入多视角特征融合策略，弥补了特征融合过程中多角度关注特征的不足，保证了不同全局形态的重要信息被保留;最后，我们提出了拓扑连续性约束损失来约束分割的拓扑连续性。在二维和三维数据集上对该方法进行了验证，结果表明，与几种方法相比，该方法在管状结构分割任务上具有更好的准确性和连续性。
代码 # -*- coding: utf-8 -*- import os import torch from torch import nn import einops from typing import Union &#34;&#34;&#34;Dynamic Snake Convolution Module&#34;&#34;&#34; class DSConv_pro(nn.Module): def __init__( self, in_channels: int = 1, out_channels: int = 1, kernel_size: int = 9, extend_scope: float = 1.0, morph: int = 0, if_offset: bool = True, device: Union[str, torch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/3ed938e7eccf44ec748a96bde0489f95/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-15T00:12:13+08:00" />
<meta property="article:modified_time" content="2024-03-15T00:12:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">蛇形卷积【浅读 / 即插即用】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>Dynamic Snake Convolution based on Topological Geometric Constraints for<br> Tubular Structure Segmentation</strong>(基于拓扑几何约束的动态蛇形卷积管状结构分割)</p> 
<blockquote> 
 <p>https://github.com/YaoleiQi/DSCNet</p> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_6" rel="nofollow">摘要</a></li><li><a href="#_13" rel="nofollow">结论</a></li><li><a href="#_16" rel="nofollow">代码</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_6"></a>摘要</h2> 
<p>拓扑管状结构(如血管和道路)的准确分割在各个领域都至关重要，可以确保下游任务的准确性和效率。然而，许多因素使任务复杂化，包括薄的局部结构和可变的全局形态。在这项工作中，我们注意到管状结构的特殊性，并利用这一知识指导我们的DSCNet在三个阶段同时增强感知:特征提取、特征融合和损失约束。首先，我们提出了一种动态蛇形卷积，通过自适应聚焦细长和弯曲的局部结构来准确捕捉管状结构的特征。随后，我们提出了一种多视角特征融合策略，以补充特征融合过程中对多个视角特征的关注，确保保留来自不同全局形态的重要信息。最后，提出了一种基于持久同调的连续性约束损失函数，以更好地约束分割的拓扑连续性。在二维和三维数据集上的实验表明，与几种方法相比，我们的DSCNet在管状结构分割任务上具有更好的准确性和连续性。<br> <strong>具体贡献有三个方面：</strong></p> 
<ul><li>(1)提出了一种动态蛇形卷积算法，自适应聚焦于细长和弯曲的局部特征，在二维和三维数据集上实现管状结构的精确分割。我们的模型使用内部和外部测试数据进行了彻底验证。</li><li>(2)提出多视角特征融合策略，补充对多视角重要特征的关注。</li><li>(3)提出一种基于持久同调的拓扑连续性约束损失函数，较好地约束了分割的连续性。</li></ul> 
<h2><a id="_13"></a>结论</h2> 
<p>在本研究中，我们关注管状结构的特殊特征，并利用这些知识指导模型在特征提取、特征融合和损失约束三个阶段同时增强感知。首先，我们提出了一种动态蛇形卷积，自适应聚焦于细长和扭曲的结构，从而准确捕捉管状结构的特征。其次，引入多视角特征融合策略，弥补了特征融合过程中多角度关注特征的不足，保证了不同全局形态的重要信息被保留;最后，我们提出了拓扑连续性约束损失来约束分割的拓扑连续性。在二维和三维数据集上对该方法进行了验证，结果表明，与几种方法相比，该方法在管状结构分割任务上具有更好的准确性和连续性。</p> 
<h2><a id="_16"></a>代码</h2> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">import</span> einops
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Union

<span class="token triple-quoted-string string">"""Dynamic Snake Convolution Module"""</span>


<span class="token keyword">class</span> <span class="token class-name">DSConv_pro</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        in_channels<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        out_channels<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        kernel_size<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">,</span>
        extend_scope<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        morph<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        if_offset<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        device<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"cuda"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        A Dynamic Snake Convolution Implementation

        Based on:

            TODO

        Args:
            in_ch: number of input channels. Defaults to 1.
            out_ch: number of output channels. Defaults to 1.
            kernel_size: the size of kernel. Defaults to 9.
            extend_scope: the range to expand. Defaults to 1 for this method.
            extend_scope: 要扩展的范围。此方法默认为1。
            morph: the morphology of the convolution kernel is mainly divided into two types along the x-axis (0) and the y-axis (1) (see the paper for details).
            if_offset: whether deformation is required,  if it is False, it is the standard convolution kernel. Defaults to True.
            morph:,卷积核的形态主要分为沿x轴(0)和y轴(1)两种
            if_offset:是否需要变形，如果为False，则为标准卷积核。默认为True。
        """</span>

        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> morph <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"morph should be 0 or 1."</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>kernel_size <span class="token operator">=</span> kernel_size
        self<span class="token punctuation">.</span>extend_scope <span class="token operator">=</span> extend_scope
        self<span class="token punctuation">.</span>morph <span class="token operator">=</span> morph
        self<span class="token punctuation">.</span>if_offset <span class="token operator">=</span> if_offset
        self<span class="token punctuation">.</span>device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

        <span class="token comment"># self.bn = nn.BatchNorm2d(2 * kernel_size)</span>
        self<span class="token punctuation">.</span>gn_offset <span class="token operator">=</span> nn<span class="token punctuation">.</span>GroupNorm<span class="token punctuation">(</span>kernel_size<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> kernel_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>gn <span class="token operator">=</span> nn<span class="token punctuation">.</span>GroupNorm<span class="token punctuation">(</span>out_channels <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>tanh <span class="token operator">=</span> nn<span class="token punctuation">.</span>Tanh<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>offset_conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> kernel_size<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>dsc_conv_x <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
            in_channels<span class="token punctuation">,</span>
            out_channels<span class="token punctuation">,</span>
            kernel_size<span class="token operator">=</span><span class="token punctuation">(</span>kernel_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            stride<span class="token operator">=</span><span class="token punctuation">(</span>kernel_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dsc_conv_y <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
            in_channels<span class="token punctuation">,</span>
            out_channels<span class="token punctuation">,</span>
            kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> kernel_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
            stride<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> kernel_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
            padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Predict offset map between [-1, 1]</span>
        offset <span class="token operator">=</span> self<span class="token punctuation">.</span>offset_conv<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>
        <span class="token comment"># offset = self.bn(offset)</span>
        offset <span class="token operator">=</span> self<span class="token punctuation">.</span>gn_offset<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>
        offset <span class="token operator">=</span> self<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>

        <span class="token comment"># Run deformative conv</span>
        y_coordinate_map<span class="token punctuation">,</span> x_coordinate_map <span class="token operator">=</span> get_coordinate_map_2D<span class="token punctuation">(</span>
            offset<span class="token operator">=</span>offset<span class="token punctuation">,</span>
            morph<span class="token operator">=</span>self<span class="token punctuation">.</span>morph<span class="token punctuation">,</span>
            extend_scope<span class="token operator">=</span>self<span class="token punctuation">.</span>extend_scope<span class="token punctuation">,</span>
            device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        deformed_feature <span class="token operator">=</span> get_interpolated_feature<span class="token punctuation">(</span>
            <span class="token builtin">input</span><span class="token punctuation">,</span>
            y_coordinate_map<span class="token punctuation">,</span>
            x_coordinate_map<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>morph <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            output <span class="token operator">=</span> self<span class="token punctuation">.</span>dsc_conv_x<span class="token punctuation">(</span>deformed_feature<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>morph <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            output <span class="token operator">=</span> self<span class="token punctuation">.</span>dsc_conv_y<span class="token punctuation">(</span>deformed_feature<span class="token punctuation">)</span>

        <span class="token comment"># Groupnorm &amp; ReLU</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>gn<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>output<span class="token punctuation">)</span>

        <span class="token keyword">return</span> output


<span class="token keyword">def</span> <span class="token function">get_coordinate_map_2D</span><span class="token punctuation">(</span>
    offset<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span>
    morph<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    extend_scope<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    device<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"cuda"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Computing 2D coordinate map of DSCNet based on: TODO

    Args:
        offset: offset predict by network with shape [B, 2*K, W, H]. Here K refers to kernel size.
        morph: the morphology of the convolution kernel is mainly divided into two types along the x-axis (0) and the y-axis (1) (see the paper for details).
        extend_scope: the range to expand. Defaults to 1 for this method.
        device: location of data. Defaults to 'cuda'.

    Return:
        y_coordinate_map: coordinate map along y-axis with shape [B, K_H * H, K_W * W]
        x_coordinate_map: coordinate map along x-axis with shape [B, K_H * H, K_W * W]
    """</span>

    <span class="token keyword">if</span> morph <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"morph should be 0 or 1."</span><span class="token punctuation">)</span>

    batch_size<span class="token punctuation">,</span> _<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token operator">=</span> offset<span class="token punctuation">.</span>shape
    kernel_size <span class="token operator">=</span> offset<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">2</span>
    center <span class="token operator">=</span> kernel_size <span class="token operator">//</span> <span class="token number">2</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    y_offset_<span class="token punctuation">,</span> x_offset_ <span class="token operator">=</span> torch<span class="token punctuation">.</span>split<span class="token punctuation">(</span>offset<span class="token punctuation">,</span> kernel_size<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    y_center_ <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
    y_center_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>y_center_<span class="token punctuation">,</span> <span class="token string">"w -&gt; k w h"</span><span class="token punctuation">,</span> k<span class="token operator">=</span>kernel_size<span class="token punctuation">,</span> h<span class="token operator">=</span>height<span class="token punctuation">)</span>

    x_center_ <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> height<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
    x_center_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>x_center_<span class="token punctuation">,</span> <span class="token string">"h -&gt; k w h"</span><span class="token punctuation">,</span> k<span class="token operator">=</span>kernel_size<span class="token punctuation">,</span> w<span class="token operator">=</span>width<span class="token punctuation">)</span>

    <span class="token keyword">if</span> morph <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Initialize the kernel and flatten the kernel
            y: only need 0
            x: -num_points//2 ~ num_points//2 (Determined by the kernel size)
        """</span>
        y_spread_ <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>kernel_size<span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
        x_spread_ <span class="token operator">=</span> torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token operator">-</span>center<span class="token punctuation">,</span> center<span class="token punctuation">,</span> kernel_size<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>

        y_grid_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>y_spread_<span class="token punctuation">,</span> <span class="token string">"k -&gt; k w h"</span><span class="token punctuation">,</span> w<span class="token operator">=</span>width<span class="token punctuation">,</span> h<span class="token operator">=</span>height<span class="token punctuation">)</span>
        x_grid_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>x_spread_<span class="token punctuation">,</span> <span class="token string">"k -&gt; k w h"</span><span class="token punctuation">,</span> w<span class="token operator">=</span>width<span class="token punctuation">,</span> h<span class="token operator">=</span>height<span class="token punctuation">)</span>

        y_new_ <span class="token operator">=</span> y_center_ <span class="token operator">+</span> y_grid_
        x_new_ <span class="token operator">=</span> x_center_ <span class="token operator">+</span> x_grid_

        y_new_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>y_new_<span class="token punctuation">,</span> <span class="token string">"k w h -&gt; b k w h"</span><span class="token punctuation">,</span> b<span class="token operator">=</span>batch_size<span class="token punctuation">)</span>
        x_new_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>x_new_<span class="token punctuation">,</span> <span class="token string">"k w h -&gt; b k w h"</span><span class="token punctuation">,</span> b<span class="token operator">=</span>batch_size<span class="token punctuation">)</span>

        y_offset_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>rearrange<span class="token punctuation">(</span>y_offset_<span class="token punctuation">,</span> <span class="token string">"b k w h -&gt; k b w h"</span><span class="token punctuation">)</span>
        y_offset_new_ <span class="token operator">=</span> y_offset_<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># The center position remains unchanged and the rest of the positions begin to swing</span>
        <span class="token comment"># This part is quite simple. The main idea is that "offset is an iterative process"</span>

        y_offset_new_<span class="token punctuation">[</span>center<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> center <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            y_offset_new_<span class="token punctuation">[</span>center <span class="token operator">+</span> index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
                y_offset_new_<span class="token punctuation">[</span>center <span class="token operator">+</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> y_offset_<span class="token punctuation">[</span>center <span class="token operator">+</span> index<span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
            y_offset_new_<span class="token punctuation">[</span>center <span class="token operator">-</span> index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
                y_offset_new_<span class="token punctuation">[</span>center <span class="token operator">-</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> y_offset_<span class="token punctuation">[</span>center <span class="token operator">-</span> index<span class="token punctuation">]</span>
            <span class="token punctuation">)</span>

        y_offset_new_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>rearrange<span class="token punctuation">(</span>y_offset_new_<span class="token punctuation">,</span> <span class="token string">"k b w h -&gt; b k w h"</span><span class="token punctuation">)</span>

        y_new_ <span class="token operator">=</span> y_new_<span class="token punctuation">.</span>add<span class="token punctuation">(</span>y_offset_new_<span class="token punctuation">.</span>mul<span class="token punctuation">(</span>extend_scope<span class="token punctuation">)</span><span class="token punctuation">)</span>

        y_coordinate_map <span class="token operator">=</span> einops<span class="token punctuation">.</span>rearrange<span class="token punctuation">(</span>y_new_<span class="token punctuation">,</span> <span class="token string">"b k w h -&gt; b (w k) h"</span><span class="token punctuation">)</span>
        x_coordinate_map <span class="token operator">=</span> einops<span class="token punctuation">.</span>rearrange<span class="token punctuation">(</span>x_new_<span class="token punctuation">,</span> <span class="token string">"b k w h -&gt; b (w k) h"</span><span class="token punctuation">)</span>

    <span class="token keyword">elif</span> morph <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Initialize the kernel and flatten the kernel
            y: -num_points//2 ~ num_points//2 (Determined by the kernel size)
            x: only need 0
        """</span>
        y_spread_ <span class="token operator">=</span> torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token operator">-</span>center<span class="token punctuation">,</span> center<span class="token punctuation">,</span> kernel_size<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
        x_spread_ <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>kernel_size<span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>

        y_grid_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>y_spread_<span class="token punctuation">,</span> <span class="token string">"k -&gt; k w h"</span><span class="token punctuation">,</span> w<span class="token operator">=</span>width<span class="token punctuation">,</span> h<span class="token operator">=</span>height<span class="token punctuation">)</span>
        x_grid_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>x_spread_<span class="token punctuation">,</span> <span class="token string">"k -&gt; k w h"</span><span class="token punctuation">,</span> w<span class="token operator">=</span>width<span class="token punctuation">,</span> h<span class="token operator">=</span>height<span class="token punctuation">)</span>

        y_new_ <span class="token operator">=</span> y_center_ <span class="token operator">+</span> y_grid_
        x_new_ <span class="token operator">=</span> x_center_ <span class="token operator">+</span> x_grid_

        y_new_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>y_new_<span class="token punctuation">,</span> <span class="token string">"k w h -&gt; b k w h"</span><span class="token punctuation">,</span> b<span class="token operator">=</span>batch_size<span class="token punctuation">)</span>
        x_new_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>x_new_<span class="token punctuation">,</span> <span class="token string">"k w h -&gt; b k w h"</span><span class="token punctuation">,</span> b<span class="token operator">=</span>batch_size<span class="token punctuation">)</span>

        x_offset_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>rearrange<span class="token punctuation">(</span>x_offset_<span class="token punctuation">,</span> <span class="token string">"b k w h -&gt; k b w h"</span><span class="token punctuation">)</span>
        x_offset_new_ <span class="token operator">=</span> x_offset_<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># The center position remains unchanged and the rest of the positions begin to swing</span>
        <span class="token comment"># This part is quite simple. The main idea is that "offset is an iterative process"</span>

        x_offset_new_<span class="token punctuation">[</span>center<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> center <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            x_offset_new_<span class="token punctuation">[</span>center <span class="token operator">+</span> index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
                x_offset_new_<span class="token punctuation">[</span>center <span class="token operator">+</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> x_offset_<span class="token punctuation">[</span>center <span class="token operator">+</span> index<span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
            x_offset_new_<span class="token punctuation">[</span>center <span class="token operator">-</span> index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
                x_offset_new_<span class="token punctuation">[</span>center <span class="token operator">-</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> x_offset_<span class="token punctuation">[</span>center <span class="token operator">-</span> index<span class="token punctuation">]</span>
            <span class="token punctuation">)</span>

        x_offset_new_ <span class="token operator">=</span> einops<span class="token punctuation">.</span>rearrange<span class="token punctuation">(</span>x_offset_new_<span class="token punctuation">,</span> <span class="token string">"k b w h -&gt; b k w h"</span><span class="token punctuation">)</span>

        x_new_ <span class="token operator">=</span> x_new_<span class="token punctuation">.</span>add<span class="token punctuation">(</span>x_offset_new_<span class="token punctuation">.</span>mul<span class="token punctuation">(</span>extend_scope<span class="token punctuation">)</span><span class="token punctuation">)</span>

        y_coordinate_map <span class="token operator">=</span> einops<span class="token punctuation">.</span>rearrange<span class="token punctuation">(</span>y_new_<span class="token punctuation">,</span> <span class="token string">"b k w h -&gt; b w (h k)"</span><span class="token punctuation">)</span>
        x_coordinate_map <span class="token operator">=</span> einops<span class="token punctuation">.</span>rearrange<span class="token punctuation">(</span>x_new_<span class="token punctuation">,</span> <span class="token string">"b k w h -&gt; b w (h k)"</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> y_coordinate_map<span class="token punctuation">,</span> x_coordinate_map


<span class="token keyword">def</span> <span class="token function">get_interpolated_feature</span><span class="token punctuation">(</span>
    input_feature<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span>
    y_coordinate_map<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span>
    x_coordinate_map<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span>
    interpolate_mode<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"bilinear"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""From coordinate map interpolate feature of DSCNet based on: TODO

    Args:
        input_feature: feature that to be interpolated with shape [B, C, H, W]
        y_coordinate_map: coordinate map along y-axis with shape [B, K_H * H, K_W * W]
        x_coordinate_map: coordinate map along x-axis with shape [B, K_H * H, K_W * W]
        interpolate_mode: the arg 'mode' of nn.functional.grid_sample, can be 'bilinear' or 'bicubic' . Defaults to 'bilinear'.

    Return:
        interpolated_feature: interpolated feature with shape [B, C, K_H * H, K_W * W]
    """</span>

    <span class="token keyword">if</span> interpolate_mode <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">"bilinear"</span><span class="token punctuation">,</span> <span class="token string">"bicubic"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"interpolate_mode should be 'bilinear' or 'bicubic'."</span><span class="token punctuation">)</span>

    y_max <span class="token operator">=</span> input_feature<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span>
    x_max <span class="token operator">=</span> input_feature<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span>

    y_coordinate_map_ <span class="token operator">=</span> _coordinate_map_scaling<span class="token punctuation">(</span>y_coordinate_map<span class="token punctuation">,</span> origin<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> y_max<span class="token punctuation">]</span><span class="token punctuation">)</span>
    x_coordinate_map_ <span class="token operator">=</span> _coordinate_map_scaling<span class="token punctuation">(</span>x_coordinate_map<span class="token punctuation">,</span> origin<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> x_max<span class="token punctuation">]</span><span class="token punctuation">)</span>

    y_coordinate_map_ <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>y_coordinate_map_<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    x_coordinate_map_ <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>x_coordinate_map_<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># Note here grid with shape [B, H, W, 2]</span>
    <span class="token comment"># Where [:, :, :, 2] refers to [x ,y]</span>
    grid <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x_coordinate_map_<span class="token punctuation">,</span> y_coordinate_map_<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    interpolated_feature <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>grid_sample<span class="token punctuation">(</span>
        <span class="token builtin">input</span><span class="token operator">=</span>input_feature<span class="token punctuation">,</span>
        grid<span class="token operator">=</span>grid<span class="token punctuation">,</span>
        mode<span class="token operator">=</span>interpolate_mode<span class="token punctuation">,</span>
        padding_mode<span class="token operator">=</span><span class="token string">"zeros"</span><span class="token punctuation">,</span>
        align_corners<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">return</span> interpolated_feature


<span class="token keyword">def</span> <span class="token function">_coordinate_map_scaling</span><span class="token punctuation">(</span>
    coordinate_map<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span>
    origin<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token builtin">list</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Map the value of coordinate_map from origin=[min, max] to target=[a,b] for DSCNet based on: TODO

    Args:
        coordinate_map: the coordinate map to be scaled
        origin: original value range of coordinate map, e.g. [coordinate_map.min(), coordinate_map.max()]
        target: target value range of coordinate map,Defaults to [-1, 1]

    Return:
        coordinate_map_scaled: the coordinate map after scaling
    """</span>
    <span class="token builtin">min</span><span class="token punctuation">,</span> <span class="token builtin">max</span> <span class="token operator">=</span> origin
    a<span class="token punctuation">,</span> b <span class="token operator">=</span> target

    coordinate_map_scaled <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>coordinate_map<span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">)</span>

    scale_factor <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> a<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token builtin">max</span> <span class="token operator">-</span> <span class="token builtin">min</span><span class="token punctuation">)</span>
    coordinate_map_scaled <span class="token operator">=</span> a <span class="token operator">+</span> scale_factor <span class="token operator">*</span> <span class="token punctuation">(</span>coordinate_map_scaled <span class="token operator">-</span> <span class="token builtin">min</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> coordinate_map_scaled
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    model1<span class="token operator">=</span>DSConv_pro<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token builtin">input</span><span class="token operator">=</span>torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
    output<span class="token operator">=</span>model1<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    model2 <span class="token operator">=</span> DSConv_pro<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> model2<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    model3 <span class="token operator">=</span> DSConv_pro<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> model3<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/62719b830b57f6ff9ed486c8fe24d763/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring Boot 获取maven打包时间</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/469fd936d69c94b8e1134c12b7e173a1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">物联网毕设 -- 指纹密码锁（指纹&#43;STM32&#43;云平台&#43;APP）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>