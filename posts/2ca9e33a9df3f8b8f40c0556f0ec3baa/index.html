<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Qemu模拟ARM64使用GDB调试linux kernel - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Qemu模拟ARM64使用GDB调试linux kernel" />
<meta property="og:description" content="Qemu模拟ARM64使用GDB调试linux kernel 1、linux文件编译 大家在学习linux kernel时，需要购买硬件开发板，这是一笔不少的投入，今天就介绍大家如何使用模拟器来模拟ARM硬件，并且使用GDB来调试linux kernel。
linux 编译框架我使用的是buildroot，buildroot使用可以参考：buildroot使用介绍。
在buildroot编译框架下，我们使用qemu_aarch64_virt_defconfig配置进行编译，编译过程中，buildroot会根据配置文件自动下载相关的文件，包含编译工具链、linux、文件系统等。要使用GDB对linux kernel进行调试，需要开启内核参数CONFIG_DEBUG_INFO和CONFIG_GDB_SCRIPTS两个配置项目。
在buildroot编译框架下输入命令进入linux kernel配置目录：make linux-menuconfig
配置目录下进入kernel hacking条目，首先开启Kernel debugging选项，最后进入Compile-time checks and compiler options 条目，开启Compile the kernel with debug info和Provide GDB scripts for kernel debugging内核参数配置项。
配置完成后使用make命令编译，编译结果会输出到：buildroot-2021.08.1/output/images目录下。
2、qemu模拟器 qemu是一个广泛使用的开源计算机模拟器和虚拟机。当作为模拟器时，可以在一种架构（如x86 PC）下运行另一种架构（如ARM）下的操作系统和程序。通过使用动态翻译，它可以获得非常好的性能。作为虚拟机时，qemu可以使用其他虚拟机管理程序（ KVM）来使用CPU扩展进行虚拟化，通过在主机CPU上直接执行客户机代码来获得接近于宿主机的性能。
ubuntu下安装qemu：sudo apt-get install qemu qemu-system
安装好qemu后我们进入buildroot-2021.08.1/output/images目录下，用qemu_aarch64_virt_defconfig配置编译时自动会生成qemu启动脚本文件：start-qemu.sh，直接运行此文件则可以启动qemu模拟器，模拟ARM芯片启动编译好的linux kernel内核：
qemu启动参数说明：
参数说明-M vexpress-a9指定要仿真的开发板：vexpress-a9-m 512M指定DRAM内存大小为512MB-cpu cortex-a9指定CPU架构-smp nCPU的个数，不设置的话，默认是1-kernel ./zImage要运行的镜像-dtb ./vexpress-vap-ca9.dtb要加载的设备树文件-append cmdline设置Linux内核命令行、启动参数-initrd file使用file文件作为初始化ram disk-nographic非图形化启动，使用串口作为控制台-sd rootfs.ext3使用rootfs.ext3作为SD卡镜像文件-net nic创建一个网卡-net nic -net tap将开发板网卡和主机网卡建立桥接(Bridge) qemu启动运行linux后，退出指令：ctrl&#43;a，然后在按x键。
3、GDB调试 ubuntu 默认安装的gdb 是x86的版本，需要调试aarch64架构的内核必须要安装gdb-multiarch命令：apt-get install gdb-multiarch
3.1、修改qemu启动文件 使用gdb调试，qemu启动命令需要添加一项参数“-s -S”：-s的意思是等待外面gdb的链接，默认开启1234端口进行监听；-S是在内核的入口打断点。添加-s -S参数到 start_qemu." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/2ca9e33a9df3f8b8f40c0556f0ec3baa/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-12T22:35:38+08:00" />
<meta property="article:modified_time" content="2023-02-12T22:35:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Qemu模拟ARM64使用GDB调试linux kernel</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="QemuARM64GDBlinux_kernel_0"></a>Qemu模拟ARM64使用GDB调试linux kernel</h2> 
<h3><a id="1linux_1"></a>1、linux文件编译</h3> 
<p>大家在学习linux kernel时，需要购买硬件开发板，这是一笔不少的投入，今天就介绍大家如何使用模拟器来模拟ARM硬件，并且使用GDB来调试linux kernel。</p> 
<p>linux 编译框架我使用的是buildroot，buildroot使用可以参考：<a href="https://blog.csdn.net/tanxjian/article/details/121880179?spm=1001.2014.3001.5501">buildroot使用介绍</a>。</p> 
<p>在buildroot编译框架下，我们使用<strong>qemu_aarch64_virt_defconfig</strong>配置进行编译，编译过程中，buildroot会根据配置文件自动下载相关的文件，包含编译工具链、linux、文件系统等。要使用GDB对linux kernel进行调试，需要开启内核参数<code>CONFIG_DEBUG_INFO</code>和<code>CONFIG_GDB_SCRIPTS</code>两个配置项目。</p> 
<p>在buildroot编译框架下输入命令进入linux kernel配置目录：<strong>make linux-menuconfig</strong><br> <img src="https://images2.imgbox.com/63/b8/8T7uZE7h_o.png" alt="在这里插入图片描述"><br> 配置目录下进入<strong>kernel hacking</strong>条目，首先开启<strong>Kernel debugging</strong>选项，最后进入<strong>Compile-time checks and compiler options</strong> 条目，开启<strong>Compile the kernel with debug info</strong>和<strong>Provide GDB scripts for kernel debugging</strong>内核参数配置项。<br> <img src="https://images2.imgbox.com/d1/58/hBw7Jrpx_o.png" alt="在这里插入图片描述"><br> 配置完成后使用make命令编译，编译结果会输出到：buildroot-2021.08.1/output/images目录下。</p> 
<h3><a id="2qemu_14"></a>2、qemu模拟器</h3> 
<p>qemu是一个广泛使用的开源计算机模拟器和虚拟机。当作为模拟器时，可以在一种架构（如x86 PC）下运行另一种架构（如ARM）下的操作系统和程序。通过使用动态翻译，它可以获得非常好的性能。作为虚拟机时，qemu可以使用其他虚拟机管理程序（ KVM）来使用CPU扩展进行虚拟化，通过在主机CPU上直接执行客户机代码来获得接近于宿主机的性能。</p> 
<p>ubuntu下安装qemu：<strong>sudo apt-get install qemu qemu-system</strong></p> 
<p>安装好qemu后我们进入buildroot-2021.08.1/output/images目录下，用<strong>qemu_aarch64_virt_defconfig</strong>配置编译时自动会生成qemu启动脚本文件：<strong>start-qemu.sh</strong>，直接运行此文件则可以启动qemu模拟器，模拟ARM芯片启动编译好的linux kernel内核：<br> <img src="https://images2.imgbox.com/a1/7c/DzkgxPYG_o.png" alt="在这里插入图片描述"><br> qemu启动参数说明：</p> 
<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>-M vexpress-a9</td><td>指定要仿真的开发板：vexpress-a9</td></tr><tr><td>-m 512M</td><td>指定DRAM内存大小为512MB</td></tr><tr><td>-cpu cortex-a9</td><td>指定CPU架构</td></tr><tr><td>-smp n</td><td>CPU的个数，不设置的话，默认是1</td></tr><tr><td>-kernel ./zImage</td><td>要运行的镜像</td></tr><tr><td>-dtb ./vexpress-vap-ca9.dtb</td><td>要加载的设备树文件</td></tr><tr><td>-append cmdline</td><td>设置Linux内核命令行、启动参数</td></tr><tr><td>-initrd file</td><td>使用file文件作为初始化ram disk</td></tr><tr><td>-nographic</td><td>非图形化启动，使用串口作为控制台</td></tr><tr><td>-sd rootfs.ext3</td><td>使用rootfs.ext3作为SD卡镜像文件</td></tr><tr><td>-net nic</td><td>创建一个网卡</td></tr><tr><td>-net nic -net tap</td><td>将开发板网卡和主机网卡建立桥接(Bridge)</td></tr></tbody></table> 
<p>qemu启动运行linux后，退出指令：<strong>ctrl+a</strong>，然后在按<strong>x</strong>键。</p> 
<h3><a id="3GDB_40"></a>3、GDB调试</h3> 
<p>ubuntu 默认安装的gdb 是x86的版本，需要调试aarch64架构的内核必须要安装gdb-multiarch命令：<strong>apt-get install gdb-multiarch</strong></p> 
<h4><a id="31qemu_42"></a>3.1、修改qemu启动文件</h4> 
<p>使用gdb调试，qemu启动命令需要添加一项参数“<strong>-s -S</strong>”：-s的意思是等待外面gdb的链接，默认开启1234端口进行监听；-S是在内核的入口打断点。添加-s -S参数到 start_qemu.sh文件"EXTRA_ARGS"变量处，运行start_qemu.sh文件后不会直接启动kernel，会保持在暂停状态，等待外部gdb的连接。</p> 
<pre><code class="prism language-shell"><span class="token shebang important">#!/bin/sh</span>
<span class="token punctuation">(</span>
 <span class="token assign-left variable">BINARIES_DIR</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${0<span class="token operator">%</span><span class="token operator">/</span>*}</span>/"</span>
 <span class="token builtin class-name">cd</span> <span class="token variable">${BINARIES_DIR}</span>

 <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">${1}</span>"</span> <span class="token operator">=</span> <span class="token string">"serial-only"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
     <span class="token assign-left variable">EXTRA_ARGS</span><span class="token operator">=</span><span class="token string">'-nographic'</span>
 <span class="token keyword">else</span>
     <span class="token assign-left variable">EXTRA_ARGS</span><span class="token operator">=</span><span class="token string">'-s -S'</span>
 <span class="token keyword">fi</span>
 
 <span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">"/home/ubuntu/work/buildroot-2021.08.1/output/host/bin:<span class="token variable">${<!-- --><span class="token environment constant">PATH</span>}</span>"</span>
 <span class="token builtin class-name">exec</span> qemu-system-aarch64 <span class="token parameter variable">-M</span> virt <span class="token parameter variable">-cpu</span> cortex-a53 <span class="token parameter variable">-nographic</span> <span class="token parameter variable">-smp</span> <span class="token number">1</span> <span class="token parameter variable">-kernel</span> Image <span class="token parameter variable">-append</span> <span class="token string">"rootwait root=/dev/vda console=ttyAMA0"</span> <span class="token parameter variable">-netdev</span> user,id<span class="token operator">=</span>eth0 <span class="token parameter variable">-device</span> virtio-net-device,netdev<span class="token operator">=</span>eth0 <span class="token parameter variable">-drive</span> <span class="token assign-left variable">file</span><span class="token operator">=</span>rootfs.ext4,if<span class="token operator">=</span>none,format<span class="token operator">=</span>raw,id<span class="token operator">=</span>hd0 <span class="token parameter variable">-device</span> virtio-blk-device,drive<span class="token operator">=</span>hd0 <span class="token variable">${EXTRA_ARGS}</span>
<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="32GDB_62"></a>3.2、GDB连接调试</h4> 
<p>启动qemu后，在另外一个端口下使用gdb连接qemu启动的模拟器：<strong>gdb-multiarch vmlinux</strong>（vmlinux是linux编译目录下的非压缩文件）<br> <img src="https://images2.imgbox.com/62/d0/3GNDW0T6_o.png" alt="在这里插入图片描述"><br> 启动日志有警告信息提醒，需要添加两行指令到/home/xxxx/.gdbinit文件下（如不存在文件则直接新建）。<br> <img src="https://images2.imgbox.com/de/66/LCQcWShB_o.png" alt="在这里插入图片描述"><br> gdb启动后会停留在输入指令状态，输入：<strong>target remote localhost：1234</strong>，连接qemu模拟器<br> <img src="https://images2.imgbox.com/27/f8/hjHmq7QE_o.png" alt="在这里插入图片描述"><br> 如上图所示，则已正常的连接到qemu模拟器上了，可以使用b xx进行设置断点：<strong>b start_kernel</strong>，在start_kernel函数设置断点，设置完成后输入字符<strong>c</strong>运行：<br> <img src="https://images2.imgbox.com/49/9e/RIJH1vaF_o.png" alt="在这里插入图片描述"><br> 这样模拟器运行到 start_kernel函数时会自动暂停执行，后续可以使用next、step等gdb指令进行调试了。</p> 
<h3><a id="4_72"></a>4、后记</h3> 
<p>上文介绍了使用qemu模拟器调试Linux kernel代码，但是调试过程使用gdb 命令来进行调试，调试过程不方便，接下来了向大家介绍使用VScode 实现可视化调试linux kernel：<a href="https://blog.csdn.net/tanxjian/article/details/128893301">VS code 可视化调试Linux kernel内核</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/52569c060610b4bacd64b36ffef8e70f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">软件测试面试十大必考题目（通用）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7e7aae8475b534a6863d3b2c10da0396/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">buildroot使用介绍</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>