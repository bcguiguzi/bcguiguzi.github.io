<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>搭建Flutter Web开发调试环境 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="搭建Flutter Web开发调试环境" />
<meta property="og:description" content="Setting up the Framework/Engine development environment 背景搭建 framework 开发环境修改调试 framework 源码运行 framework 测试用例同步更新 framework 源码 搭建 engine 开发环境准备 depot_tools部署 engine 源码编译 engine 源码修改调试 engine 源码指定 --local-engine修改源码调试示例 运行 engine 测试用例同步更新 engine 源码 协同联调 Framework 和 Engine 背景 关于参与 Flutter 项目的共建，从 framework 到 engine，本文提供了环境搭建到调试的主要流程说明，可以快速帮助你搭建起来。
由于侧重讲述 Flutter web 平台的建设，可以通过本文提供的官方文档链接获得其它平台更多指引。
搭建 framework 开发环境 参考官方文档：Setting up the Framework development environment。
需要具备这些条件搭建 framework 开发环境:
Linux，macOS 或 Windows。
git（代码版本管理）。
IDE：Android Studio、vscode 等主流IDE可安装插件支持 flutter/Dart 代码高亮。
Python（ 一些工具需要使用）。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/61c09582900de32cbbd0684cef33fc34/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-13T11:57:44+08:00" />
<meta property="article:modified_time" content="2022-12-13T11:57:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">搭建Flutter Web开发调试环境</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Setting up the Framework/Engine development environment</h4> 
 <ul><li><ul><li><a href="#_2" rel="nofollow">背景</a></li><li><a href="#_framework__8" rel="nofollow">搭建 framework 开发环境</a></li><li><ul><li><a href="#_framework__73" rel="nofollow">修改调试 framework 源码</a></li><li><a href="#_framework__132" rel="nofollow">运行 framework 测试用例</a></li><li><a href="#_framework__151" rel="nofollow">同步更新 framework 源码</a></li></ul> 
   </li><li><a href="#_engine__159" rel="nofollow">搭建 engine 开发环境</a></li><li><ul><li><a href="#_depot_tools_196" rel="nofollow">准备 depot_tools</a></li><li><a href="#_engine__233" rel="nofollow">部署 engine 源码</a></li><li><a href="#_engine__274" rel="nofollow">编译 engine 源码</a></li><li><a href="#_engine__343" rel="nofollow">修改调试 engine 源码</a></li><li><ul><li><a href="#_localengine_350" rel="nofollow">指定 --local-engine</a></li><li><a href="#_385" rel="nofollow">修改源码调试示例</a></li></ul> 
    </li><li><a href="#_engine__443" rel="nofollow">运行 engine 测试用例</a></li><li><a href="#_engine__464" rel="nofollow">同步更新 engine 源码</a></li></ul> 
   </li><li><a href="#_Framework__Engine_468" rel="nofollow">协同联调 Framework 和 Engine</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_2"></a>背景</h3> 
<p>关于参与 Flutter 项目的共建，从 framework 到 engine，本文提供了环境搭建到调试的主要流程说明，可以快速帮助你搭建起来。</p> 
<p>由于侧重讲述 Flutter web 平台的建设，可以通过本文提供的官方文档链接获得其它平台更多指引。</p> 
<h3><a id="_framework__8"></a>搭建 framework 开发环境</h3> 
<p>参考官方文档：<a href="https://github.com/flutter/flutter/wiki/Setting-up-the-Framework-development-environment">Setting up the Framework development environment</a>。</p> 
<p>需要具备这些条件搭建 framework 开发环境:</p> 
<ul><li> <p>Linux，macOS 或 Windows。</p> </li><li> <p>git（代码版本管理）。</p> </li><li> <p>IDE：<a href="https://flutter.io/using-ide/" rel="nofollow">Android Studio</a>、<a href="https://code.visualstudio.com/" rel="nofollow">vscode</a> 等主流IDE可安装插件支持 flutter/Dart 代码高亮。</p> </li><li> <p>Python（ 一些工具需要使用）。</p> </li><li> <p>ssh 客户端（GitHub 身份验证）。</p> </li></ul> 
<hr> 
<p>请先 参考 <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/" rel="nofollow">Connecting to GitHub with SSH</a>，<span id="Github-SSH-Key">配置 Github 认证需要的 SSH Key</span>。</p> 
<ol><li>检查是否已经有 SSH 密钥：<a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/reviewing-your-ssh-keys" rel="nofollow">Reviewing your SSH keys</a></li><li>生成新的 SSH 密钥对（id_rsa，id_rsa.pub）：<a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent" rel="nofollow">Generating a new SSH key and adding it to the ssh-agent</a></li><li>将 SSH 公钥（id_rsa.pub）上传到 github：<a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account" rel="nofollow">Adding a new SSH key to your GitHub account</a> - <a href="https://github.com/settings/profile">Settings</a> - <a href="https://github.com/settings/keys">SSH and GPG keys</a></li><li>git clone 使用 SSH 地址替代 HTTPS 链接：<a href="https://docs.github.com/en/github/getting-started-with-github/managing-remote-repositories/#switching-remote-urls-from-https-to-ssh" rel="nofollow">Switching remote URLs from HTTPS to SSH</a></li></ol> 
<hr> 
<p>按照以下步骤搭建 Framework 开发环境：</p> 
<ol><li> <p>Fork https://github.com/flutter/flutter 到自己的 GitHub 账号。如果已经 frok 过了，可先更新 Sync Fork。</p> </li><li> <p><code>git clone git@github.com:&lt;github_username&gt;/flutter.git</code> （替换 &lt;github_username&gt; 为你的 GitHub 账户名）。如果是参与外部开源项目，可考虑执行 git config 命令配置个人开发者用户名和邮箱：</p> 
  <ul><li>git config user.name &lt;github_username&gt;</li><li>git config user.email &lt;github_useremail&gt;</li></ul> </li><li> <p><code>cd flutter</code></p> </li><li> <p><code>git remote add upstream git@github.com:flutter/flutter.git</code>：添加跟踪官方上游源仓（fetch-merge同步）。</p> </li><li> <p>配置仓库的 flutter/bin 目录到环境变量，这样后续将使用本地编译出来的 SDK/Framework 工具链。</p> </li></ol> 
<pre><code class="prism language-Shell">$ export PATH=/path/to/flutter/bin:$PATH
</code></pre> 
<ul><li>执行 <code>vim ~/.zhsrc</code> 编辑 zsh 配置文件，将flutter仓库编译产物目录bin前插到环境变量 PATH（override fvm）： 
  <ul><li>为了后续脚本引用方便，可以将一些常用目录定义成环境变量。</li></ul> </li></ul> 
<pre><code class="prism language-Shell"># ~/.zhsrc

# fvm home
export FVM_HOME="$HOME/.fvm"
export PATH=$HOME/.fvm/default/bin:$PATH

# flutter project
export FLUTTER_PROJECT_DIR=$HOME/Projects/github/flutter
# framework(sdk)
export FLUTTER_SDK_PROJECT_DIR=$FLUTTER_PROJECT_DIR/flutter
# override fvm
export PATH=$FLUTTER_SDK_PROJECT_DIR/bin:$PATH
## packages/flutter
export FLUTTER_SDK_PACKAGES=$FLUTTER_SDK_PROJECT_DIR/packages
export FLUTTER_SDK_SRCROOT=$FLUTTER_SDK_PACKAGES/flutter
</code></pre> 
<ol start="7"><li><code>flutter update-packages</code> （拉取 Flutter 依赖的 Dart 包）。</li><li>执行 <code>which flutter</code> 和 <code>flutter --version</code> 验证，flutter 工具链版本是否符合预期。</li></ol> 
<h4><a id="_framework__73"></a>修改调试 framework 源码</h4> 
<p>用 IDE 打开 <code>packages/flutter</code> 目录（FLUTTER_SDK_SRCROOT）可以修改 framework 源码。</p> 
<hr> 
<p>用 IDE 打开示例项目，确保已经安装了 Flutter/Dart 相关语言支持插件。<br> <span id="IDE-flutterSdkPath">指定 Flutter SDK 目录</span>（即上面第 3 步 clone 到本地的 SDK/Framework 目录），具体步骤如下：</p> 
<ol><li>vscode 打开偏好设置（JSON），配置 “dart.flutterSdkPath”，指定 Flutter SDK 目录：</li></ol> 
<blockquote> 
 <p>The location of the Flutter SDK to use. If blank, Dart Code will attempt to find it from the project directory, <code>FLUTTER_ROOT</code> environment variable and the PATH environment variable.</p> 
</blockquote> 
<pre><code class="prism language-JSON">    "dart.flutterSdkPath": "/Users/fantasy/Projects/github/flutter/flutter", // FLUTTER_SDK_PROJECT_DIR
    // "dart.flutterSdkPaths": [
    //     "/Users/fantasy/.fvm/versions"
    // ],
</code></pre> 
<ol start="2"><li>Android Studio 打开偏好设置，Languages &amp; Frameworks | Flutter | Flutter SDK path: 指定 Flutter SDK 目录为 /Users/fantasy/Projects/github/flutter/flutter（FLUTTER_SDK_PROJECT_DIR）。</li></ol> 
<hr> 
<p>接下来，看看如何 <strong><code>修改和调试 SDK/Framework 源码</code></strong>。</p> 
<p>在 flutter web app 项目工程目录执行 <code>flutter pub get</code>，IDE 点击符号 MaterialApp 可跳转打开源码所在文件 flutter/packages/flutter/lib/src/material/app.dart。</p> 
<blockquote> 
 <p>也可使用 vscode 或 Android Studio 等 IDE，打开 FLUTTER_SDK_SRCROOT（flutter/packages/flutter）文件夹进行编辑修改。</p> 
</blockquote> 
<p>修改打开的 packages/flutter/lib/src/material/app.dart 文件，添加调试日志：</p> 
<pre><code class="prism language-Dart">class _MaterialAppState extends State&lt;MaterialApp&gt; {
  late HeroController _heroController;

  bool get _usesRouter =&gt; widget.routerDelegate != null;

  @override
  void initState() {
    super.initState();
    if (kDebugMode) {
      print('_MaterialAppState initState');
    }
    _heroController = MaterialApp.createMaterialHeroController();
  }
</code></pre> 
<p>flutter web app 调试运行起来，查看 console 日志以验证 framework 代码修改效果，正常会有以下输出：<br> <img src="https://images2.imgbox.com/e2/9f/6Gefw4Z6_o.png" alt="在这里插入图片描述"><br> 修改 SDK/Framework 源码，web app 项目支持热加载，可实时调试查看修改后的效果。</p> 
<p>web app 打开 chrome 运行起来后，可使用浏览器调试工具（例如 <a href="https://developer.chrome.com/docs/devtools/" rel="nofollow">Chrome DevTools</a> ）打开查看和调试 Framework 源码。</p> 
<p>在 Chrome DevTools 的 Sources 标签面板下，可查找定位到对应文件 <code>packages/flutter/src/material/app.dart</code>，可以确认修改效果和断点调试。</p> 
<blockquote> 
 <p>http://localhost:8080/packages/flutter/src/material/app.dart</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/50/a8/wHjwvHPT_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_framework__132"></a>运行 framework 测试用例</h4> 
<p><code>flutter test</code> 可以运行 framework 测试用例。</p> 
<pre><code># 在 Chrome 上运行所有测试用例
flutter test -v --platform=chrome
</code></pre> 
<pre><code># 在 Chrome 上运行测试用例，并指定渲染方式为移动端的 html 方式
flutter test -v --platform=chrome --web-renderer=html
</code></pre> 
<pre><code># 在 Chrome 上运行指定测试用例，并指定渲染方式为移动端的 html 方式
flutter test -v --platform=chrome --web-renderer=html test/material/text_field_focus_test.dart
</code></pre> 
<h4><a id="_framework__151"></a>同步更新 framework 源码</h4> 
<p>在 Flutter SDK 目录下 master 分支，<code>git pull</code> 即可更新最新仓库代码。</p> 
<p>如果需要同步上游官方源头仓库，可以参考 <a href="https://help.github.com/articles/configuring-a-remote-for-a-fork/" rel="nofollow">Configuring a remote for a fork</a> &amp; <a href="https://help.github.com/articles/syncing-a-fork/" rel="nofollow">Syncing a fork</a>。</p> 
<ul><li>也可 cd $FLUTTER_SDK_PROJECT_DIR，执行 <code>git checkout</code> 命令切换源码到指定版本进行开发调试或验证。</li></ul> 
<h3><a id="_engine__159"></a>搭建 engine 开发环境</h3> 
<p>参考官方文档：</p> 
<ol><li><a href="https://github.com/flutter/flutter/wiki/Setting-up-the-Engine-development-environment">Setting up the Engine development environment</a></li><li><a href="https://github.com/flutter/flutter/wiki/Compiling-the-engine">Compiling the engine</a> - <a href="https://github.com/flutter/flutter/wiki/Compiling-the-engine#compiling-for-the-web">Compiling for the Web</a></li><li><a href="https://chromium.googlesource.com/external/github.com/flutter/engine/+/b7358b33dbd61e124720165dd939fa49cbd0ecb6/CONTRIBUTING.md" rel="nofollow">Contributing to the Flutter engine</a></li></ol> 
<p>需要具备这些条件搭建 engine 开发环境:</p> 
<ul><li> <p>git（代码版本管理）。</p> </li><li> <p>IDE：<a href="https://flutter.io/using-ide/" rel="nofollow">Android Studio</a>、<a href="https://code.visualstudio.com/" rel="nofollow">vscode</a> 等主流IDE可安装插件支持 flutter/Dart 代码高亮。</p> </li><li> <p>Python（ gclient 等工具依赖）。</p> </li><li> <p>ssh 客户端（GitHub 身份验证），请先 <a href="#Github-SSH-Key" rel="nofollow">配置 Github 认证需要的 SSH Key</a>。</p> </li><li> <p>chromium <a href="http://commondatastorage.googleapis.com/chrome-infra-docs/flat/depot_tools/docs/html/depot_tools_tutorial.html#_setting_up" rel="nofollow">depot_tools</a> 是基于 Python（封装 git 等工具）实现的用于代码迁出管理的工具，包含 <code>gclient</code>，<code>gn</code> 和 <code>ninja</code> 等工具。</p> 
  <ul><li><a href="https://ninja-build.org/" rel="nofollow">ninja</a> 是 Google 推出的注重速度的构建工具，将编译任务并行组织，大大提高构建速度。</li><li>在 macOS 和 Linux 中，gclient sync 命令依赖 curl 和 unzip (macOS 已自带)。</li></ul> </li><li> <p><a href="https://github.com/flutter/engine/tree/main/lib/web_ui">felt</a>：flutter engine 内置的编译 web engine 的工具，支持 Linux、macOS 和 Windows。对于其它平台，下表展示了 Linux，macOS 或 Windows 跨平台产物编译支持情况。</p> 
  <table><thead><tr><th></th><th align="center">Android</th><th align="center">iOS</th><th align="center">Fuchsia</th></tr></thead><tbody><tr><td>Linux</td><td align="center">o</td><td align="center">x</td><td align="center">o</td></tr><tr><td>Windows</td><td align="center">x</td><td align="center">x</td><td align="center">x</td></tr><tr><td><strong>macOS</strong></td><td align="center"><strong>o</strong></td><td align="center"><strong>o</strong></td><td align="center"><strong>o</strong></td></tr></tbody></table></li><li> <p>Windows 平台需要:</p> 
  <ul><li>Visual Studio 2017 或更高版本。</li><li>Windows 10 SDK。 
    <ul><li>确保安装了 Debugging Tools for Windows。</li></ul> </li></ul> </li><li> <p>macOS 平台需要最新版本的 Xcode。</p> </li></ul> 
<h4><a id="_depot_tools_196"></a>准备 depot_tools</h4> 
<p><strong>Linux / Mac</strong></p> 
<p>Clone <em>depot_tools</em> 仓库到本地 /path/to/depot_tools（例如 $HOME/Library/Developer/chromium/tools/depot_tools）:</p> 
<pre><code>$ git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
</code></pre> 
<p>将 git clone 下来的 depot_tools 本地仓库目录添加到环境变量 PATH，以使命令行可以找到相关工具链。</p> 
<pre><code class="prism language-Shell"># ~/.bashrc 或 ~/.zshrc
$ export PATH=/path/to/depot_tools:$PATH
</code></pre> 
<p><strong>Windows</strong></p> 
<p>参考 <a href="http://commondatastorage.googleapis.com/chrome-infra-docs/flat/depot_tools/docs/html/depot_tools_tutorial.html" rel="nofollow">depot_tools_tutorial</a> 介绍。</p> 
<hr> 
<p>确认 depot_tools 是否安装成功：</p> 
<ul><li>执行 <code>gclient --version</code> 和 <code>gclient help</code> 可以查看 gclient 版本及帮助。</li><li>执行 <code>ninja --version</code> 查看 ninja 版本；执行 <code>ninja -h</code> 查看 ninja 帮助。</li></ul> 
<pre><code class="prism language-Shell">$ gclient --version
Updating depot_tools...
gclient.py 0.7

$ ninja --version
1.8.2
</code></pre> 
<h4><a id="_engine__233"></a>部署 engine 源码</h4> 
<p>不需要提前安装 Dart，也不需要手动 clone engine 到本地，gclient 会将 engine 相关工具链和依赖库拉取到本地。</p> 
<p>按照下面的步骤部署：</p> 
<ol><li>Fork https://github.com/flutter/engine 到自己的 GitHub 账号。如果已经 frok 过了，可先更新 Sync Fork。</li><li>本地创建一个约定俗成的空目录 <code>engine</code> ，用来保存 engine 项目相关工具链和依赖库。</li><li><code>cd engine</code>，创建 <code>.gclient</code> 配置文件，填入以下内容，替换 &lt;your_name_here&gt; 为你的 GitHub 账户名。</li></ol> 
<pre><code class="prism language-JSON">solutions = [
  {
    "managed": False,
    "name": "src/flutter",
    "url": "git@github.com:&lt;your_name_here&gt;/engine.git",
    "custom_deps": {},
    "deps_file": "DEPS",
    "safesync_url": "",
  },
]
</code></pre> 
<ol start="4"><li> <p>在 engine 目录下执行 <code>gclient sync</code>，将自动创建 engine/src 目录。</p> 
  <ul><li>其中 <code>src/flutter</code> 才是真正的 flutter engine 代码所在地。</li><li>此外，src 目录下包括第三方依赖库 third_party、工具链（build、tools）以及 fuchsia sdk 等。</li></ul> </li><li> <p>添加跟踪官方 flutter engine 上游源仓：</p> </li></ol> 
<pre><code class="prism language-Shell">$ cd src/flutter
$ git remote add upstream git@github.com:flutter/engine.git
$ cd -
</code></pre> 
<ol start="6"><li> <p>如果是参与外部开源项目，可考虑执行 git config 命令配置个人开发者用户名和邮箱：</p> 
  <ul><li>git config user.name &lt;github_username&gt;</li><li>git config user.email &lt;github_useremail&gt;</li></ul> </li></ol> 
<h4><a id="_engine__274"></a>编译 engine 源码</h4> 
<p><code>src/flutter</code> 才是真正的 flutter engine 代码所在地，其中包括 sky、runtime、flutter_frontend_server、common(/graphics)、vulkan、shell(platform,vmservice) 等。lib 目录下包括 SDK/Framework 端 ui 和 web_ui 的实现代码：</p> 
<blockquote> 
 <p>src/flutter/lib/web_ui 为 <a href="https://github.com/flutter/engine/tree/main/lib/web_ui">Flutter Web Engine</a> 代码目录。</p> 
</blockquote> 
<pre><code class="prism language-Shell">$ tree -L 1 lib
lib
├── io
├── snapshot
├── spirv
├── ui
└── web_ui
</code></pre> 
<p>编译 web engine 源码需要使用 <a href="https://github.com/flutter/engine/tree/main/lib/web_ui">felt</a>(Flutter Engine Local Tester) 这个命令行工具，目标是让开发 Flutter web engine 更高效。</p> 
<p>felt 内置于 flutter engine 仓库中的 lib/web_ui/dev 中，将 FLUTTER_ENGINE_SRCWEBUI/dev 配置到环境变量，以使命令行可以找到相关工具链：</p> 
<blockquote> 
 <p>可执行 <code>felt help</code>（或 felt help build）验证 felt 命令是否安装成功。</p> 
</blockquote> 
<pre><code class="prism language-Shell"># flutter project
export FLUTTER_PROJECT_DIR=$HOME/Projects/github/flutter
# engine
export FLUTTER_ENGINE_PROJECT_DIR=$FLUTTER_PROJECT_DIR/engine
export FLUTTER_ENGINE_PROJECT_SRCROOT=$FLUTTER_ENGINE_PROJECT_DIR/src
export FLUTTER_ENGINE_SRCROOT=$FLUTTER_ENGINE_PROJECT_SRCROOT/flutter
## lib/web_ui
export FLUTTER_ENGINE_SRCWEBUI=$FLUTTER_ENGINE_SRCROOT/lib/web_ui
export PATH=$FLUTTER_ENGINE_SRCWEBUI/dev:$PATH
</code></pre> 
<p>在存放 .gclient 配置的 engine 目录（FLUTTER_ENGINE_PROJECT_DIR），执行 <code>felt build</code> 命令编译 flutter web 引擎，把 dart 转换成 js。</p> 
<blockquote> 
 <p>如果在其他目录执行 felt build，可能会报错 <code>Error: client not configured; see 'gclient config'</code>。<br> 默认的产物输出目录为 src/out/host_debug_unopt。</p> 
</blockquote> 
<pre><code class="prism language-Shell"># 编译引擎
$ felt build
……
Done. Made 905 targets from 280 files in 1152ms
Running autoninja...
ninja: Entering directory `/Users/fantasy/Projects/github/flutter/engine/src/out/host_debug_unopt'
ninja: no work to do.
</code></pre> 
<p>每次修改 web engine 后，在 FLUTTER_ENGINE_PROJECT_DIR 目录执行 <code>felt build</code> 即可重编引擎。</p> 
<hr> 
<p><code>felt build</code> 可能会遇到以下报错：</p> 
<pre><code class="prism language-Shell">$ felt build
Running on MacOS. Will check the file and user limits.
File limits too low increasing the file limits
Can't load Kernel binary: Invalid kernel binary format version.
</code></pre> 
<p>一般是因为flutter内核修改后无法识别，参考 <a href="https://github.com/flutter/flutter/issues/70372">Unable to build web flutter engine locally #70372</a>，执行以下命令清除 felt.snapshot 可解决。</p> 
<pre><code class="prism language-Shell"># rm $FLUTTER_SDK_ROOT/bin/cache/flutter_tools.stamp
rm $FLUTTER_ENGINE_SRCWEBUI/.dart_tool/felt.snapshot*
</code></pre> 
<h4><a id="_engine__343"></a>修改调试 engine 源码</h4> 
<blockquote> 
 <p>请确保指定了 Engine 对应的 Flutter SDK/Framework 目录，具体参见 <a href="#IDE-flutterSdkPath" rel="nofollow">指定 Flutter SDK 目录</a>。</p> 
</blockquote> 
<p>用 IDE 打开 <code>engine/src/flutter/lib/web_ui</code> 目录（FLUTTER_ENGINE_SRCWEBUI），修改 web engine 源码后，执行 flet build 编译 engine。<br> 那么，本地 flutter web app 运行时，<strong>如何指定使用本地修改编译的 flutter web engine 进行联调呢</strong>？</p> 
<h5><a id="_localengine_350"></a>指定 --local-engine</h5> 
<p><a href="https://github.com/flutter/flutter/wiki/Compiling-the-engine">Compiling the engine</a> - <a href="https://github.com/flutter/flutter/wiki/Compiling-the-engine#compiling-for-the-web">Compiling for the Web</a>:</p> 
<blockquote> 
 <p>To test Flutter with a local build of the Web engine, add <code>--local-engine=host_debug_unopt</code> to your <em>flutter</em> command.</p> 
</blockquote> 
<p><a href="https://chromium.googlesource.com/external/github.com/flutter/engine/+/b7358b33dbd61e124720165dd939fa49cbd0ecb6/CONTRIBUTING.md" rel="nofollow">Contributing to the Flutter engine</a>:</p> 
<blockquote> 
 <p>Most developers will use the flutter tool in the main Flutter repository for interacting with their built flutter/engine. To do so, the <code>flutter</code> tool accepts two global parameters <code>local-engine-src-path</code> and <code>local-engine</code>, a typical invocation would be: <code>--local-engine-src-path /path/to/engine/src --local-engine=android_debug_unopt</code>.</p> 
</blockquote> 
<p>根据以上文档，flutter 全局命令选项 <code>--local-engine=host_debug_unopt</code>，支持指定本地引擎（如果已经指定本地引擎目录到环境变量）。</p> 
<blockquote> 
 <p>针对 web 指定为 host_debug_unopt，具体参考 felt build 日志中的 <code>ninja: Entering directory</code> 。<br> <code>--local-engine</code> 针对终端开发时，其值可能为 ios_debug_unopt、android_debug_unopt。</p> 
</blockquote> 
<p>通过以下方法运行 flutter web app 项目，就可以看到 flutter web engine 源码修改的效果。</p> 
<pre><code class="prism language-Shell">$ cd /path/to/web/app
# 指定本地引擎，编译（链接）运行调试 Flutter Web 应用
$ flutter --local-engine=host_debug_unopt run -d chrome
</code></pre> 
<p>如果未指定本地引擎目录到环境变量，则需要通过 <code>--local-engine-src-path</code> 选项指定（推荐）。</p> 
<pre><code class="prism language-Shell"># 指定本地引擎，编译（链接）运行调试 Flutter Web 应用
$ flutter --local-engine=host_debug_unopt --local-engine-src-path=$FLUTTER_ENGINE_PROJECT_SRCROOT run -d chrome
</code></pre> 
<p>可以在 flutter web app 的 vscode 启动配置 .vscode/launch.json 中的 toolArgs 添加 --local-engine 和 --local-engine-src-path 这两个选项参数：<br> <img src="https://images2.imgbox.com/a8/d4/cUD8uYJw_o.png" alt="在这里插入图片描述"><br> 也可在 Android Studio Run/Debug Configurations 的 Additional run args 开头指定 --local-engine 和 --local-engine-src-path 这两个选项参数：<br> <img src="https://images2.imgbox.com/25/55/RLtbAXEu_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_385"></a>修改源码调试示例</h5> 
<p>接下来以 <a href="https://github.com/flutter/engine/pull/31718">PR 31718</a> 修改的 engine/src/flutter/lib/web_ui/lib/src/engine/text_editing/text_editing.dart 为例，我们在 IOSTextEditingStrategy.addEventHandlers 监听的 onBlur 事件中加一句日志。</p> 
<pre><code class="prism language-Dart">// text_editing.dart
class IOSTextEditingStrategy extends GloballyPositionedTextEditingStrategy {
  IOSTextEditingStrategy(HybridTextEditing owner) : super(owner);

  @override
  void addEventHandlers() {

    subscriptions.add(activeDomElement.onBlur.listen((_) {
      if (windowHasFocus) {
        print('IOSTextEditingStrategy addEventHandlers onBlur event');
        activeDomElement.focus();
      } else {
        owner.sendTextConnectionClosedToFrameworkIfAny();
      }
    }));
  }

}
</code></pre> 
<ol><li>flutter web app（coding-app）项目下执行 <code>./scripts/proxy/launch_shelf.sh -P</code> 启动 shelf_proxy 代理，日志输出 ✅ proxy listening on http://10.20.89.64:8010。</li><li>执行以下命令，通过指定全局选项 --local-engine 和 --local-engine-src-path 指定本地 web engine 产物和源码目录，run -d web-server 启动 web 服务监听 8080 端口。</li></ol> 
<pre><code class="prism language-Shell"># 客户端模式，直接拉起 chrome 运行调试
# flutter --local-engine=host_debug_unopt --local-engine-src-path=$FLUTTER_ENGINE_PROJECT_SRCROOT run -d chrome --web-renderer=html --web-port=8080 --dart-define=API_BASE_URL=10.20.89.64:8010 --dart-define=AUTH_TOKEN=$DEBUG_AUTH_TOKEN

# server模式，可供局域网通过 LAN IP 访问
$ flutter --local-engine=host_debug_unopt --local-engine-src-path=$FLUTTER_ENGINE_PROJECT_SRCROOT run -d web-server --web-renderer=html --web-port=8080 --web-hostname=0.0.0.0 --dart-define=API_BASE_URL=10.20.89.64:8010 --dart-define=AUTH_TOKEN=$DEBUG_AUTH_TOKEN

lib/main.dart is being served at http://0.0.0.0:8080
</code></pre> 
<ol start="3"><li>执行 <code>open -a Simulator</code> 命令打开 iOS 模拟器，在safari浏览器地址栏输入 http://0.0.0.0:8080 访问 coding-app 页面。</li><li>打开 macOS Safari，Develop 菜单点击 Simulator - 0.0.0.0，将打开 Web Inspector。</li></ol> 
<p><img src="https://images2.imgbox.com/8d/71/AApF2NAE_o.png" alt="在这里插入图片描述"></p> 
<ol start="5"><li>在 Web Inspector 的 Sources 标签面板下，在 <code>dart_sdk.js/lib/_engine/engine</code> 下定位到 text_editing 目录，点击打开 text_editing.dart，查找到修改的地方，点击行号Gutter添加断点。点击搜索栏，调起键盘输入，聚焦或点击键盘 Done 按钮，应该会命中断点：</li></ol> 
<p><img src="https://images2.imgbox.com/70/5d/zWXPjaML_o.png" alt="在这里插入图片描述"></p> 
<ol start="5"><li>同时切换到 Web Inspector 的 Console 标签面板，应该可以看到 onBlur 日志输出。</li></ol> 
<p><img src="https://images2.imgbox.com/03/82/ItDGMyvz_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<p>macOS 桌面端 Chrome 访问 http://10.20.89.64:8080，可打开调试工具 DevTools 查看和调试 Engine 源码。在 DevTools 的 Sources 标签面板下，在 <code>lib/_engine/engine</code> 下定位到 text_editing 目录，点击打开 text_editing.dart，可以确认修改是否生效和进行断点调试。<br> 由于修改的示例代码 IOSTextEditingStrategy 仅针对 iOS 设备，可以给 DefaultTextEditingStrategy.setEditingState 加个断点调试验证。点击搜索栏，聚焦输入框，就会命中断点：</p> 
<p><img src="https://images2.imgbox.com/0f/a1/qYlYJ1iJ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_engine__443"></a>运行 engine 测试用例</h4> 
<p><code>felt test</code> 可以运行 web engine 测试用例，默认情况下使用 Chromium 作为平台。</p> 
<pre><code class="prism language-Shell"># 运行所有 Chromium 测试用例
felt test
</code></pre> 
<pre><code class="prism language-Shell"># 运行特定的测试用例
felt test test/engine/util_test.dart
</code></pre> 
<pre><code class="prism language-Shell"># 在 iOS Safari 上运行测试用例
felt test --browser=ios-safari
</code></pre> 
<p>更多命令运行 <code>felt help [SUBCOMMAND]</code> 查询。</p> 
<h4><a id="_engine__464"></a>同步更新 engine 源码</h4> 
<p>更新远程的官方 engine 仓库，只需要在本地 engine 目录（FLUTTER_ENGINE_PROJECT_DIR）执行 <code>gclient sync</code> 即可。</p> 
<h3><a id="_Framework__Engine_468"></a>协同联调 Framework 和 Engine</h3> 
<p>如果要同时调试 Engine 和 SDK/Framework（FLUTTER_SDK_ROOT），需要先导出工具链到环境变量，并在 IDE 指定好配套的 Flutter SDK 目录（flutterSdkPath）。</p> 
<p>最新 fvm global stable 为最新的 2.10.5，执行 <code>flutter --version</code> 可以查看 SDK/Framework 和 Engine 的搭配版本：</p> 
<pre><code class="prism language-Shell">$ flutter --version
Flutter 2.10.5 • channel stable • https://github.com/flutter/flutter.git
Framework • revision 5464c5bac7 (4 days ago) • 2022-04-18 09:55:37 -0700
Engine • revision 57d3bac3dd
Tools • Dart 2.16.2 • DevTools 2.9.2
</code></pre> 
<p>如果在 SDK/Framework 仓库执行 git checkout 切换到了 2.10.5，也可将 Flutter Engine 切换到对应版本 57d3bac3dd。<br> 这样搭配进行开发调试或验证，避免出现一些由于 SDK 和 Engine 版本不协同，造成的接口和工具链兼容性问题。</p> 
<pre><code class="prism language-Shell"># engine/src/flutter
$ cd $FLUTTER_ENGINE_SRCROOT
$ git checkout 57d3bac3dd
</code></pre> 
<p><strong>注意</strong>：</p> 
<p>切换 Flutter Engine 仓库版本后，需要在 FLUTTER_ENGINE_PROJECT_DIR 目录重新执行 <code>gclient sync</code> 命令同步工具链。<br> 否则，可能会报以下错误：</p> 
<pre><code class="prism language-Shell">Running gn...
GOMA usage was specified but can't be found, falling back to local builds. Set the GOMA_DIR environment variable to fix GOMA.
Using prebuilt Dart SDK binary. If you are editing Dart sources and wish to compile the Dart SDK, set `--no-prebuilt-dart-sdk`.
Generating GN files in: out/host_debug_unopt
ERROR at //BUILD.gn:28:7: Can't load input file.
      "//flutter/build/archives:artifacts"
      ^-----------------------------------
Unable to load:
  /Users/fantasy/Projects/github/flutter/engine/src/flutter/build/archives/BUILD.gn
I also checked in the secondary tree for:
  /Users/fantasy/Projects/github/flutter/engine/src/build/secondary/flutter/build/archives/BUILD.gn
description: Sub-process failed.executable: /Users/fantasy/Projects/github/flutter/engine/src/flutter/tools/gn arguments: [--unopt, --xcode-symlinks, --full-dart-sdk] exit code: 1
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/eb5bdc0dfa81c4abfb45d4044ec467a8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">softmax原理性质解析并python实现</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c2a318a18514c675ef039e0531d0f4d0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">QPSK调制解调仿真matlab</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>