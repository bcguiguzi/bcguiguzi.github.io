<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Autoware 1.12学习整理--03--NDT点云定位 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Autoware 1.12学习整理--03--NDT点云定位" />
<meta property="og:description" content="〇、前言 在得到点云地图后，接下来为点云定位，是汽车导航的前提，autoware中使用ndt_matching模块完成基于点云的定位，是一种scan-to-map的点云配准算法，本文将使用《Autoware 1.12学习整理–02–构建点云地图》中的点云地图和rosbag数据包完成ndt点云定位。
一、ndt点云定位 ndt点云定位时的tf树与建图时的稍有不同，从map到base_link的坐标系转换由autoware中的ndt_matching模块完成的，如下图所示：
1.1、加载bag文件
启动autoware，切换到Simulation页面，点击Ref按钮加载bag文件，Start Time设置为0，点击Play然后点击Pause暂停播放，如下图所示。为了保证autoware的正常运行，在启动autoware后首先要做的就是加载bag文件，否则会出现时间戳同步问题。
1.2、完成从base_link到velodyne的坐标系转换
切换到autoware的Setup页面下，确定Localizer选的是Velodyne，设置Baselink to Localizer的x、y、z、yaw、pitch、roll数值，其为雷达中心点与车身后轴中心点的相对位置关系，接着点击TF按钮，最后点击Vehicle Model按钮，如果其后为空，那么会加载一个默认模型。
1.3、完成从world到map的坐标系转换
切换到autoware的Map页面下，点击TF右侧的Ref按钮，加载如下路径的launch文件，其中是从/world坐标系转换到/map坐标系的tf变换，最后点击TF按钮。
autoware.ai/src/autoware/documentation/autoware_quickstart_examples/launch/tf_local.launch 1.4、加载点云地图
在Map页面下，点击Point Cloud右侧的Ref按钮，加载pcd点云地图，并点击Point Cloud按钮，进度条显示OK，则加载完毕，如下所示：
1.5、点云降采样
voxel_grid_filter，也就是体素滤波，PCL实现的体素滤波VoxelGrid类通过输入的点云数据创建三维体素栅格（可以将体素栅格想象为微小的空间三维立方体的集合），然后在每个体素内，用体素中的所有点的重心近似显示体素中的其他点，这样该体素内所有点就用一个重心点最终表示，然后将所有体素处理后得到过滤后的点云。（这种方法比用体素中心来逼近的方法更慢，但对于采样点对应曲面的表示更为准确。）
切换到autoware的Sensing页面下，点击Points Downsampler下voxel_grid_filter右侧的app按钮，设置点云话题名Points topic为/points_raw，下面两个参数默认即可，Voxel Leaf Size参数值为2，表示2米的立方体内的全部点近似用1个重心代替，Measurement Range的参数值为200，表示点云的有效的距离是200米。设置完参数后点击OK，最后勾选voxel_grid_filter。
1.6、完成map到base_link的坐标系转换
切换到autoware的Computing页面下，点击lidar_localizer下ndt_matching右侧的app按钮，在弹出的页面中topic:/config/ndt选择Initial Pos选项，x，y，z，roll，pitch，yaw的值表示激光数据的初始位姿，如果有GNSS设备可以选择GNSS进行初始定位。Method Type选择pcl_anh_gpu，即使用GPU进行点云匹配计算，然后点击OK，最后勾选ndt_matching。
1.7、播放bag数据
点击autoware界面的RViz按钮，打开rviz，依次点击file-&gt;open config加载配置文件：
autoware.ai/src/autoware/documentation/autoware_quickstart_examples/launch/rosbag_demo/default.rviz 切回到autoware的Simulation界面，点击Pause按钮开始播放数据，Rviz界面显示如下：
整个运行过程如下：
在开始时，没有定位成功，汽车前进了一段距离后突然回到起始位置，此时才定位成功，后面汽车就能一直将点云与地图匹配起来，完成汽车在点云地图中的定位。开始时如果长时间没有定位成功，可以使用rviz中的2D Pose Estimate工具指定汽车的初始位姿。利用ndt_matching进行点云定位时的节点图如下：
最后可以看一下voxel_grid_filter降采样前后的对比：
文章不妥之处还望指正
参考文章：
https://www.cnblogs.com/hgl0417/p/11143107.html
https://zhuanlan.zhihu.com/p/64226544" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/4bf32cd398fb3de1eab66a2354a071fd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-04T16:24:01+08:00" />
<meta property="article:modified_time" content="2022-03-04T16:24:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Autoware 1.12学习整理--03--NDT点云定位</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>〇、前言</h3> 
<p>在得到点云地图后，接下来为点云定位，是汽车导航的前提，autoware中使用ndt_matching模块完成基于点云的定位，是一种scan-to-map的点云配准算法，本文将使用《<a href="https://blog.csdn.net/weixin_45168199/article/details/123240579?spm=1001.2014.3001.5501">Autoware 1.12学习整理–02–构建点云地图</a>》中的点云地图和rosbag数据包完成ndt点云定位。</p> 
<h3><a id="ndt_2"></a>一、ndt点云定位</h3> 
<p>ndt点云定位时的tf树与建图时的稍有不同，从map到base_link的坐标系转换由autoware中的ndt_matching模块完成的，如下图所示：<br> <img src="https://images2.imgbox.com/61/e5/jxcEUlnP_o.png" alt="在这里插入图片描述"><br> 1.1、加载bag文件<br> 启动autoware，切换到<code>Simulation</code>页面，点击<code>Ref</code>按钮加载bag文件，<code>Start Time</code>设置为0，点击<code>Play</code>然后点击<code>Pause</code>暂停播放，如下图所示。为了保证autoware的正常运行，在启动autoware后首先要做的就是加载bag文件，否则会出现时间戳同步问题。<br> <img src="https://images2.imgbox.com/29/9e/szeicnK2_o.jpg" alt="在这里插入图片描述"><br> 1.2、完成从base_link到velodyne的坐标系转换<br> 切换到autoware的<code>Setup</code>页面下，确定<code>Localizer</code>选的是Velodyne，设置<code>Baselink to Localizer</code>的x、y、z、yaw、pitch、roll数值，其为雷达中心点与车身后轴中心点的相对位置关系，接着点击<code>TF</code>按钮，最后点击<code>Vehicle Model</code>按钮，如果其后为空，那么会加载一个默认模型。<br> <img src="https://images2.imgbox.com/44/b3/xXhlEPq2_o.jpg" alt="在这里插入图片描述"><br> 1.3、完成从world到map的坐标系转换<br> 切换到autoware的<code>Map</code>页面下，点击<code>TF</code>右侧的<code>Ref</code>按钮，加载如下路径的launch文件，其中是从/world坐标系转换到/map坐标系的tf变换，最后点击<code>TF</code>按钮。</p> 
<pre><code class="prism language-bash">autoware.ai/src/autoware/documentation/autoware_quickstart_examples/launch/tf_local.launch
</code></pre> 
<p><img src="https://images2.imgbox.com/ef/be/JakuVHHI_o.jpg" alt="在这里插入图片描述"><br> 1.4、加载点云地图<br> 在<code>Map</code>页面下，点击<code>Point Cloud</code>右侧的<code>Ref</code>按钮，加载pcd点云地图，并点击<code>Point Cloud</code>按钮，进度条显示OK，则加载完毕，如下所示：<br> <img src="https://images2.imgbox.com/0a/a3/g86VNjbY_o.jpg" alt="在这里插入图片描述"><br> 1.5、点云降采样<br> voxel_grid_filter，也就是体素滤波，PCL实现的体素滤波VoxelGrid类通过输入的点云数据创建三维体素栅格（可以将体素栅格想象为微小的空间三维立方体的集合），然后在每个体素内，用体素中的所有点的重心近似显示体素中的其他点，这样该体素内所有点就用一个重心点最终表示，然后将所有体素处理后得到过滤后的点云。（这种方法比用体素中心来逼近的方法更慢，但对于采样点对应曲面的表示更为准确。）<br> 切换到autoware的<code>Sensing</code>页面下，点击<code>Points Downsampler</code>下<code>voxel_grid_filter</code>右侧的<code>app</code>按钮，设置点云话题名<code>Points topic</code>为/points_raw，下面两个参数默认即可，<code>Voxel Leaf Size</code>参数值为2，表示2米的立方体内的全部点近似用1个重心代替，<code>Measurement Range</code>的参数值为200，表示点云的有效的距离是200米。设置完参数后点击<code>OK</code>，最后勾选<code>voxel_grid_filter</code>。<br> <img src="https://images2.imgbox.com/8b/3a/tvsgmXUi_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/03/8e/nzEm0deI_o.jpg" alt="在这里插入图片描述"><br> 1.6、完成map到base_link的坐标系转换<br> 切换到autoware的<code>Computing</code>页面下，点击<code>lidar_localizer</code>下<code>ndt_matching</code>右侧的<code>app</code>按钮，在弹出的页面中<code>topic:/config/ndt</code>选择<code>Initial Pos</code>选项，x，y，z，roll，pitch，yaw的值表示激光数据的初始位姿，如果有GNSS设备可以选择GNSS进行初始定位。<code>Method Type</code>选择pcl_anh_gpu，即使用GPU进行点云匹配计算，然后点击<code>OK</code>，最后勾选<code>ndt_matching</code>。<br> <img src="https://images2.imgbox.com/5d/c4/eOjrCONN_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/16/09/XCtfNpGX_o.jpg" alt="在这里插入图片描述"><br> 1.7、播放bag数据<br> 点击autoware界面的RViz按钮，打开rviz，依次点击<code>file</code>-&gt;<code>open config</code>加载配置文件：</p> 
<pre><code class="prism language-bash">autoware.ai/src/autoware/documentation/autoware_quickstart_examples/launch/rosbag_demo/default.rviz
</code></pre> 
<p>切回到autoware的<code>Simulation</code>界面，点击<code>Pause</code>按钮开始播放数据，Rviz界面显示如下：<br> <img src="https://images2.imgbox.com/23/46/1knZ567n_o.jpg" alt="在这里插入图片描述"><br> 整个运行过程如下：<br> <img src="https://images2.imgbox.com/30/05/yMYZ9vFg_o.gif" alt="在这里插入图片描述"><br> 在开始时，没有定位成功，汽车前进了一段距离后突然回到起始位置，此时才定位成功，后面汽车就能一直将点云与地图匹配起来，完成汽车在点云地图中的定位。开始时如果长时间没有定位成功，可以使用rviz中的<code>2D Pose Estimate</code>工具指定汽车的初始位姿。利用ndt_matching进行点云定位时的节点图如下：<br> <img src="https://images2.imgbox.com/24/37/DrUJUwkT_o.png" alt="在这里插入图片描述"><br> 最后可以看一下voxel_grid_filter降采样前后的对比：<br> <img src="https://images2.imgbox.com/a1/20/OKzwgXA3_o.jpg" alt="在这里插入图片描述"></p> 
<p>文章不妥之处还望指正</p> 
<p>参考文章：<br> <a href="https://www.cnblogs.com/hgl0417/p/11143107.html" rel="nofollow">https://www.cnblogs.com/hgl0417/p/11143107.html</a><br> <a href="https://zhuanlan.zhihu.com/p/64226544" rel="nofollow">https://zhuanlan.zhihu.com/p/64226544</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c31fc1806044c3fe390ac3515fb11bd1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">编译原理 CS-143(更新至week4)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3082cc0cf39b34e5bab0cf16d36e22d7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">力扣LeetCode-贪心算法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>