<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用Python基于metricbeat和heartbeat采集数据进行告警 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用Python基于metricbeat和heartbeat采集数据进行告警" />
<meta property="og:description" content="一、系统架构
IP主机名角色备注11.0.1.11kafka1kafka和MySQL11.0.1.12kafka2kafka11.0.1.13kafka3kafka11.0.1.14demo1metricbeat和heartbeat 二、部署Kafka
省略
二、部署Metricbeat和Heartbeat
metricbeat配置：
metricbeat.config.modules: path: ${path.config}/modules.d/*.yml reload.enabled: false fields: ip: 11.0.1.14 output.kafka: hosts: [&#34;11.0.1.11:9092&#34;,&#34;11.0.1.12:9092&#34;,&#34;11.0.1.13:9092&#34;] topic: &#34;ELK-metricbeat&#34; heartbeat配置：
heartbeat.config.monitors: path: ${path.config}/monitors.d/*.yml reload.enabled: false reload.period: 5s # ---------------------------- Kafka Output ---------------------------- output.kafka: hosts: [&#34;11.0.1.11:9092&#34;,&#34;11.0.1.12:9092&#34;,&#34;11.0.1.13:9092&#34;] topic: &#34;ELK-heartbeat&#34; heartbeat的tcp.yml配置：
- type: tcp id: my-tcp-monitor name: My TCP monitor enabled: true schedule: &#39;@every 20s&#39; hosts: [&#34;11.0.1.14:80&#34;,&#34;11.0.1.13:80&#34;,&#34;11.0.1.12:80&#34;] ipv4: true ipv6: true mode: all 三、MariaDB表结构
cmdb_app表（存储应用系统的信息）：
SET NAMES utf8mb4; SET FOREIGN_KEY_CHECKS = 0; -- ---------------------------- -- Table structure for cmdb_app -- ---------------------------- DROP TABLE IF EXISTS `cmdb_app`; CREATE TABLE `cmdb_app` ( `id` int(11) NOT NULL AUTO_INCREMENT, `app_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL, `ops_user` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL, `ops_tel` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL, `ops_dep` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL, PRIMARY KEY (`id`) USING BTREE ) ENGINE = InnoDB AUTO_INCREMENT = 2 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci ROW_FORMAT = Compact; SET FOREIGN_KEY_CHECKS = 1; 解释：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/6198a99bc72a69d154815a16d04c9485/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-20T22:51:04+08:00" />
<meta property="article:modified_time" content="2024-01-20T22:51:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用Python基于metricbeat和heartbeat采集数据进行告警</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>一、系统架构</p> 
<table><thead><tr><th>IP</th><th>主机名</th><th>角色</th><th>备注</th></tr></thead><tbody><tr><td>11.0.1.11</td><td>kafka1</td><td>kafka和MySQL</td><td></td></tr><tr><td>11.0.1.12</td><td>kafka2</td><td>kafka</td><td></td></tr><tr><td>11.0.1.13</td><td>kafka3</td><td>kafka</td><td></td></tr><tr><td>11.0.1.14</td><td>demo1</td><td>metricbeat和heartbeat</td><td></td></tr></tbody></table> 
<p>二、部署Kafka<br> 省略</p> 
<p>二、部署Metricbeat和Heartbeat<br> metricbeat配置：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">metricbeat.config.modules</span><span class="token punctuation">:</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>path.config<span class="token punctuation">}</span>/modules.d/<span class="token important">*.yml</span>
  <span class="token key atrule">reload.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token key atrule">fields</span><span class="token punctuation">:</span>
  <span class="token key atrule">ip</span><span class="token punctuation">:</span> 11.0.1.14

<span class="token key atrule">output.kafka</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"11.0.1.11:9092"</span><span class="token punctuation">,</span><span class="token string">"11.0.1.12:9092"</span><span class="token punctuation">,</span><span class="token string">"11.0.1.13:9092"</span><span class="token punctuation">]</span>
  <span class="token key atrule">topic</span><span class="token punctuation">:</span> <span class="token string">"ELK-metricbeat"</span>

</code></pre> 
<p>heartbeat配置：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">heartbeat.config.monitors</span><span class="token punctuation">:</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>path.config<span class="token punctuation">}</span>/monitors.d/<span class="token important">*.yml</span>
  <span class="token key atrule">reload.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">reload.period</span><span class="token punctuation">:</span> 5s

<span class="token comment"># ----------------------------  Kafka Output ----------------------------</span>
<span class="token key atrule">output.kafka</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"11.0.1.11:9092"</span><span class="token punctuation">,</span><span class="token string">"11.0.1.12:9092"</span><span class="token punctuation">,</span><span class="token string">"11.0.1.13:9092"</span><span class="token punctuation">]</span>
  <span class="token key atrule">topic</span><span class="token punctuation">:</span> <span class="token string">"ELK-heartbeat"</span>

</code></pre> 
<p>heartbeat的tcp.yml配置：</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> tcp 
  <span class="token key atrule">id</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>tcp<span class="token punctuation">-</span>monitor
  <span class="token key atrule">name</span><span class="token punctuation">:</span> My TCP monitor
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">'@every 20s'</span> 
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"11.0.1.14:80"</span><span class="token punctuation">,</span><span class="token string">"11.0.1.13:80"</span><span class="token punctuation">,</span><span class="token string">"11.0.1.12:80"</span><span class="token punctuation">]</span>
  <span class="token key atrule">ipv4</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">ipv6</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> all

</code></pre> 
<p>三、MariaDB表结构<br> cmdb_app表（存储应用系统的信息）：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SET</span> NAMES utf8mb4<span class="token punctuation">;</span>
<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for cmdb_app</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>cmdb_app<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>cmdb_app<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>app_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>ops_user<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>ops_tel<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>ops_dep<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Compact<span class="token punctuation">;</span>

<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

</code></pre> 
<p>解释：<br> app_name：系统名称<br> ops_user：运维人员姓名<br> ops_tel：运维人员手机号<br> ops_dep：运维责任部门</p> 
<p>cmdb_os表（存储服务器信息）：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SET</span> NAMES utf8mb4<span class="token punctuation">;</span>
<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for cmdb_os</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>cmdb_os<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>cmdb_os<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>app_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>eip<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>module<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">5</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Compact<span class="token punctuation">;</span>

<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> 
<p>解释：<br> app_name：系统信息<br> eip：服务器IP<br> module：服务器用途</p> 
<p>alert_list表（存储告警信息）：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SET</span> NAMES utf8mb4<span class="token punctuation">;</span>
<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for alert_list</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>alert_list<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>alert_list<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>timestamp<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>url<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>app_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>ops_user<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>ops_tel<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>ops_dep<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>module<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Compact<span class="token punctuation">;</span>

<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> 
<p>四、使用Python程序，从Kafka读取数据，并将cmdb_os和cmdb_app信息根据kafka数据中的ip信息匹配起来，并将新的数据写入到新的Kafka</p> 
<p>安装依赖：</p> 
<pre><code class="prism language-python">pip install kafka<span class="token operator">-</span>python pymysql apscheduler pyyaml
</code></pre> 
<p>先说metricbeat_replace.py：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> logging<span class="token punctuation">.</span>handlers <span class="token keyword">import</span> RotatingFileHandler
<span class="token keyword">import</span> pymysql
<span class="token keyword">from</span> kafka <span class="token keyword">import</span> KafkaConsumer<span class="token punctuation">,</span> KafkaProducer
<span class="token keyword">import</span> yaml
<span class="token keyword">from</span> apscheduler<span class="token punctuation">.</span>schedulers<span class="token punctuation">.</span>background <span class="token keyword">import</span> BackgroundScheduler
<span class="token keyword">from</span> apscheduler<span class="token punctuation">.</span>triggers<span class="token punctuation">.</span>cron <span class="token keyword">import</span> CronTrigger

<span class="token keyword">class</span> <span class="token class-name">DatabaseConnectionError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"数据库连接失败"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>message <span class="token operator">=</span> message
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">.</span>message<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">KafkaCMDBProcessor</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> kafka_config<span class="token punctuation">,</span> mysql_config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>kafka_config <span class="token operator">=</span> kafka_config
        self<span class="token punctuation">.</span>mysql_config <span class="token operator">=</span> mysql_config
        self<span class="token punctuation">.</span>logger <span class="token operator">=</span> self<span class="token punctuation">.</span>setup_logger<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cmdb_data <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token comment"># 初始化调度器</span>
        self<span class="token punctuation">.</span>scheduler <span class="token operator">=</span> BackgroundScheduler<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 添加定时任务，每个整点、10分、20分、30分、40分、50分的时候执行</span>
        self<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>add_job<span class="token punctuation">(</span>self<span class="token punctuation">.</span>load_cmdb_data<span class="token punctuation">,</span> CronTrigger<span class="token punctuation">(</span>minute<span class="token operator">=</span><span class="token string">'0,10,20,30,40,50'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">setup_logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>

        <span class="token comment"># 创建控制台处理程序并设置级别为调试</span>
        ch <span class="token operator">=</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ch<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>

        <span class="token comment"># 创建文件处理程序并设置级别为调试，最大文件大小为1 MB，保留备份文件3个</span>
        fh <span class="token operator">=</span> RotatingFileHandler<span class="token punctuation">(</span><span class="token string">'metricbeat_replace.log'</span><span class="token punctuation">,</span> maxBytes<span class="token operator">=</span><span class="token number">1e6</span><span class="token punctuation">,</span> backupCount<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
        fh<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>

        <span class="token comment"># 创建格式化器</span>
        formatter <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span><span class="token string">'%(asctime)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span>

        <span class="token comment"># 将格式化器添加到处理程序</span>
        ch<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>
        fh<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>

        <span class="token comment"># 将处理程序添加到记录器</span>
        logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>fh<span class="token punctuation">)</span>

        <span class="token keyword">return</span> logger

    <span class="token keyword">def</span> <span class="token function">start_processing</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>connect_to_database<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 初始化时第一次连接数据库</span>
        self<span class="token punctuation">.</span>load_cmdb_data<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 初始化时加载数据到内存</span>

        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"开始处理..."</span><span class="token punctuation">)</span>

        consumer <span class="token operator">=</span> KafkaConsumer<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>kafka_config<span class="token punctuation">[</span><span class="token string">'input_topic'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            group_id<span class="token operator">=</span>self<span class="token punctuation">.</span>kafka_config<span class="token punctuation">[</span><span class="token string">'consumer_group_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            bootstrap_servers<span class="token operator">=</span>self<span class="token punctuation">.</span>kafka_config<span class="token punctuation">[</span><span class="token string">'bootstrap_servers'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            auto_offset_reset<span class="token operator">=</span><span class="token string">'earliest'</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Kafka 消费者已创建."</span><span class="token punctuation">)</span>

        producer <span class="token operator">=</span> KafkaProducer<span class="token punctuation">(</span>bootstrap_servers<span class="token operator">=</span>self<span class="token punctuation">.</span>kafka_config<span class="token punctuation">[</span><span class="token string">'bootstrap_servers'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Kafka 生产者已创建."</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> msg <span class="token keyword">in</span> consumer<span class="token punctuation">:</span>
                metricbeat_data <span class="token operator">=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
                ip <span class="token operator">=</span> self<span class="token punctuation">.</span>extract_ip<span class="token punctuation">(</span>metricbeat_data<span class="token punctuation">)</span>
                cmdb_data <span class="token operator">=</span> self<span class="token punctuation">.</span>get_cmdb_data<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>process_and_send_message<span class="token punctuation">(</span>producer<span class="token punctuation">,</span> metricbeat_data<span class="token punctuation">,</span> cmdb_data<span class="token punctuation">)</span>

        <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"接收到 KeyboardInterrupt。正在优雅地关闭。"</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"发生错误：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token comment"># 如果在处理过程中发生异常，可以在这里添加适当的处理逻辑</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            consumer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            producer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">connect_to_database</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"正在连接数据库..."</span><span class="token punctuation">)</span>
            db <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>
                host<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                port<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                user<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                password<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                database<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'db'</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"数据库连接成功."</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>db_connection_error_logged <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 连接成功后重置连接错误标志</span>
        <span class="token keyword">except</span> pymysql<span class="token punctuation">.</span>Error <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            error_message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"连接数据库时发生错误：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>error_message<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> DatabaseConnectionError<span class="token punctuation">(</span>error_message<span class="token punctuation">)</span> <span class="token keyword">from</span> e
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> db<span class="token punctuation">:</span>
                db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">load_cmdb_data</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        db <span class="token operator">=</span> <span class="token boolean">None</span>
        cursor <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"开始加载数据."</span><span class="token punctuation">)</span>
            db <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>
                host<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                port<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                user<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                password<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                database<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'db'</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
            cursor <span class="token operator">=</span> db<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># 查询 cmdb_os 表中的数据</span>
            sql_cmdb_os <span class="token operator">=</span> <span class="token string">"SELECT app_name, eip, module FROM cmdb_os"</span>
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql_cmdb_os<span class="token punctuation">)</span>
            cmdb_os_result <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># 查询 cmdb_app 表中的数据</span>
            sql_cmdb_app <span class="token operator">=</span> <span class="token string">"SELECT app_name, ops_user, ops_tel, ops_dep FROM cmdb_app"</span>
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql_cmdb_app<span class="token punctuation">)</span>
            cmdb_app_result <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># 将数据保存到内存中</span>
            self<span class="token punctuation">.</span>cmdb_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"cmdb_os"</span><span class="token punctuation">:</span> cmdb_os_result<span class="token punctuation">,</span>
                <span class="token string">"cmdb_app"</span><span class="token punctuation">:</span> cmdb_app_result
            <span class="token punctuation">}</span>

            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"数据加载完成."</span><span class="token punctuation">)</span>

        <span class="token keyword">except</span> pymysql<span class="token punctuation">.</span>Error <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            error_message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"加载数据时发生数据库错误：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>error_message<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"数据库连接异常，继续沿用上次的 CMDB 数据."</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> cursor<span class="token punctuation">:</span>
                cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> db<span class="token punctuation">:</span>
                db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">extract_ip</span><span class="token punctuation">(</span>metricbeat_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>metricbeat_data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'fields'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'ip'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_cmdb_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>cmdb_data<span class="token punctuation">:</span>
            <span class="token comment"># 在内存中查找数据</span>
            cmdb_os_data <span class="token operator">=</span> <span class="token punctuation">[</span>row <span class="token keyword">for</span> row <span class="token keyword">in</span> self<span class="token punctuation">.</span>cmdb_data<span class="token punctuation">[</span><span class="token string">"cmdb_os"</span><span class="token punctuation">]</span> <span class="token keyword">if</span> row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> ip<span class="token punctuation">]</span>
            cmdb_app_data <span class="token operator">=</span> <span class="token punctuation">[</span>row <span class="token keyword">for</span> row <span class="token keyword">in</span> self<span class="token punctuation">.</span>cmdb_data<span class="token punctuation">[</span><span class="token string">"cmdb_app"</span><span class="token punctuation">]</span> <span class="token keyword">if</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> cmdb_os_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
            <span class="token keyword">return</span> cmdb_os_data<span class="token punctuation">,</span> cmdb_app_data
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">process_and_send_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> producer<span class="token punctuation">,</span> original_data<span class="token punctuation">,</span> cmdb_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        original_data_str <span class="token operator">=</span> original_data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>original_data<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token keyword">else</span> original_data

        new_message <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>original_data_str<span class="token punctuation">)</span>

        <span class="token keyword">if</span> cmdb_data<span class="token punctuation">:</span>
            cmdb_os_data<span class="token punctuation">,</span> cmdb_app_data <span class="token operator">=</span> cmdb_data
            new_message<span class="token punctuation">[</span><span class="token string">"cmdb_data"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"app_name"</span><span class="token punctuation">:</span> cmdb_os_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"eip"</span><span class="token punctuation">:</span> cmdb_os_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"module"</span><span class="token punctuation">:</span> cmdb_os_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"ops_user"</span><span class="token punctuation">:</span> cmdb_app_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"ops_tel"</span><span class="token punctuation">:</span> cmdb_app_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"ops_dep"</span><span class="token punctuation">:</span> cmdb_app_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            new_message<span class="token punctuation">[</span><span class="token string">"cmdb_data"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

        producer<span class="token punctuation">.</span>send<span class="token punctuation">(</span>self<span class="token punctuation">.</span>kafka_config<span class="token punctuation">[</span><span class="token string">'output_topic'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>new_message<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        producer<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'application.yml'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> config_file<span class="token punctuation">:</span>
            config_data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>config_file<span class="token punctuation">)</span>

        kafka_config_data <span class="token operator">=</span> config_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'kafka'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        mysql_config_data <span class="token operator">=</span> config_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        processor <span class="token operator">=</span> KafkaCMDBProcessor<span class="token punctuation">(</span>kafka_config_data<span class="token punctuation">,</span> mysql_config_data<span class="token punctuation">)</span>
        processor<span class="token punctuation">.</span>start_processing<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">except</span> FileNotFoundError<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"错误：找不到配置文件 'application.yml'。"</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"发生意外错误：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

</code></pre> 
<p>application.yml配置如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">kafka</span><span class="token punctuation">:</span>
  <span class="token key atrule">bootstrap_servers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'11.0.1.11:9092'</span>
    <span class="token punctuation">-</span> <span class="token string">'11.0.1.12:9092'</span>
    <span class="token punctuation">-</span> <span class="token string">'11.0.1.13:9092'</span>
  <span class="token key atrule">consumer_group_id</span><span class="token punctuation">:</span> <span class="token string">'metricbeat_replace'</span>
  <span class="token key atrule">input_topic</span><span class="token punctuation">:</span> <span class="token string">'ELK-metricbeat'</span>
  <span class="token key atrule">output_topic</span><span class="token punctuation">:</span> <span class="token string">'ELK-system_metricbeat'</span>

<span class="token key atrule">mysql</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">'11.0.1.11'</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">13306</span>
  <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">'root'</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">'123456'</span>
  <span class="token key atrule">db</span><span class="token punctuation">:</span> <span class="token string">'zll_python_test'</span>

</code></pre> 
<p>处理后的数据如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"@timestamp"</span><span class="token operator">:</span> <span class="token string">"2024-01-20T14:02:34.706Z"</span><span class="token punctuation">,</span> <span class="token string-property property">"@metadata"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"beat"</span><span class="token operator">:</span> <span class="token string">"metricbeat"</span><span class="token punctuation">,</span> <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span> <span class="token string-property property">"version"</span><span class="token operator">:</span> <span class="token string">"8.11.1"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"host"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"demo1"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"agent"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"metricbeat"</span><span class="token punctuation">,</span> <span class="token string-property property">"version"</span><span class="token operator">:</span> <span class="token string">"8.11.1"</span><span class="token punctuation">,</span> <span class="token string-property property">"ephemeral_id"</span><span class="token operator">:</span> <span class="token string">"979b3ab7-80af-4ab5-a552-3692165b7000"</span><span class="token punctuation">,</span> <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"982d0bd1-d0d9-45b5-bc78-0a5f25911c12"</span><span class="token punctuation">,</span> <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"demo1"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"metricset"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"memory"</span><span class="token punctuation">,</span> <span class="token string-property property">"period"</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"event"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"module"</span><span class="token operator">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string-property property">"duration"</span><span class="token operator">:</span> <span class="token number">120280</span><span class="token punctuation">,</span> <span class="token string-property property">"dataset"</span><span class="token operator">:</span> <span class="token string">"system.memory"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"service"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"system"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"system"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"memory"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"used"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"pct"</span><span class="token operator">:</span> <span class="token number">0.2325</span><span class="token punctuation">,</span> <span class="token string-property property">"bytes"</span><span class="token operator">:</span> <span class="token number">919130112</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"free"</span><span class="token operator">:</span> <span class="token number">3034763264</span><span class="token punctuation">,</span> <span class="token string-property property">"cached"</span><span class="token operator">:</span> <span class="token number">529936384</span><span class="token punctuation">,</span> <span class="token string-property property">"actual"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"used"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"pct"</span><span class="token operator">:</span> <span class="token number">0.1493</span><span class="token punctuation">,</span> <span class="token string-property property">"bytes"</span><span class="token operator">:</span> <span class="token number">590319616</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"free"</span><span class="token operator">:</span> <span class="token number">3363573760</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"swap"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"total"</span><span class="token operator">:</span> <span class="token number">2147479552</span><span class="token punctuation">,</span> <span class="token string-property property">"used"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"bytes"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string-property property">"pct"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"free"</span><span class="token operator">:</span> <span class="token number">2147479552</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"total"</span><span class="token operator">:</span> <span class="token number">3953893376</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"ip"</span><span class="token operator">:</span> <span class="token string">"11.0.1.14"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"ecs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"version"</span><span class="token operator">:</span> <span class="token string">"8.0.0"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"cmdb_data"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"app_name"</span><span class="token operator">:</span> <span class="token string">"应用系统"</span><span class="token punctuation">,</span> <span class="token string-property property">"eip"</span><span class="token operator">:</span> <span class="token string">"11.0.1.14"</span><span class="token punctuation">,</span> <span class="token string-property property">"module"</span><span class="token operator">:</span> <span class="token string">"demo1"</span><span class="token punctuation">,</span> <span class="token string-property property">"ops_user"</span><span class="token operator">:</span> <span class="token string">"运维仔"</span><span class="token punctuation">,</span> <span class="token string-property property">"ops_tel"</span><span class="token operator">:</span> <span class="token string">"12345678901"</span><span class="token punctuation">,</span> <span class="token string-property property">"ops_dep"</span><span class="token operator">:</span> <span class="token string">"运维部"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<p>heartbeat_replace.py如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> logging<span class="token punctuation">.</span>handlers <span class="token keyword">import</span> RotatingFileHandler
<span class="token keyword">import</span> pymysql
<span class="token keyword">from</span> kafka <span class="token keyword">import</span> KafkaConsumer<span class="token punctuation">,</span> KafkaProducer
<span class="token keyword">import</span> yaml
<span class="token keyword">from</span> apscheduler<span class="token punctuation">.</span>schedulers<span class="token punctuation">.</span>background <span class="token keyword">import</span> BackgroundScheduler
<span class="token keyword">from</span> apscheduler<span class="token punctuation">.</span>triggers<span class="token punctuation">.</span>cron <span class="token keyword">import</span> CronTrigger

<span class="token keyword">class</span> <span class="token class-name">DatabaseConnectionError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"数据库连接失败"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>message <span class="token operator">=</span> message
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">.</span>message<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">KafkaCMDBProcessor</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> kafka_config<span class="token punctuation">,</span> mysql_config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>kafka_config <span class="token operator">=</span> kafka_config
        self<span class="token punctuation">.</span>mysql_config <span class="token operator">=</span> mysql_config
        self<span class="token punctuation">.</span>logger <span class="token operator">=</span> self<span class="token punctuation">.</span>setup_logger<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cmdb_data <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token comment"># 初始化调度器</span>
        self<span class="token punctuation">.</span>scheduler <span class="token operator">=</span> BackgroundScheduler<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 添加定时任务，每个整点、10分、20分、30分、40分、50分的时候执行</span>
        self<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>add_job<span class="token punctuation">(</span>self<span class="token punctuation">.</span>load_cmdb_data<span class="token punctuation">,</span> CronTrigger<span class="token punctuation">(</span>minute<span class="token operator">=</span><span class="token string">'0,10,20,30,40,50'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">setup_logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>

        <span class="token comment"># 创建控制台处理程序并设置级别为调试</span>
        ch <span class="token operator">=</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ch<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>

        <span class="token comment"># 创建文件处理程序并设置级别为调试，最大文件大小为1 MB，保留备份文件3个</span>
        fh <span class="token operator">=</span> RotatingFileHandler<span class="token punctuation">(</span><span class="token string">'heartbeat_replace.log'</span><span class="token punctuation">,</span> maxBytes<span class="token operator">=</span><span class="token number">1e6</span><span class="token punctuation">,</span> backupCount<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
        fh<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>

        <span class="token comment"># 创建格式化器</span>
        formatter <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span><span class="token string">'%(asctime)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span>

        <span class="token comment"># 将格式化器添加到处理程序</span>
        ch<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>
        fh<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>

        <span class="token comment"># 将处理程序添加到记录器</span>
        logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>fh<span class="token punctuation">)</span>

        <span class="token keyword">return</span> logger

    <span class="token keyword">def</span> <span class="token function">start_processing</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>connect_to_database<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 初始化时第一次连接数据库</span>
        self<span class="token punctuation">.</span>load_cmdb_data<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 初始化时加载数据到内存</span>

        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"开始处理..."</span><span class="token punctuation">)</span>

        consumer <span class="token operator">=</span> KafkaConsumer<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>kafka_config<span class="token punctuation">[</span><span class="token string">'input_topic'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            group_id<span class="token operator">=</span>self<span class="token punctuation">.</span>kafka_config<span class="token punctuation">[</span><span class="token string">'consumer_group_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            bootstrap_servers<span class="token operator">=</span>self<span class="token punctuation">.</span>kafka_config<span class="token punctuation">[</span><span class="token string">'bootstrap_servers'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            auto_offset_reset<span class="token operator">=</span><span class="token string">'earliest'</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Kafka 消费者已创建."</span><span class="token punctuation">)</span>

        producer <span class="token operator">=</span> KafkaProducer<span class="token punctuation">(</span>bootstrap_servers<span class="token operator">=</span>self<span class="token punctuation">.</span>kafka_config<span class="token punctuation">[</span><span class="token string">'bootstrap_servers'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Kafka 生产者已创建."</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> msg <span class="token keyword">in</span> consumer<span class="token punctuation">:</span>
                heartbeat_data <span class="token operator">=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
                ip <span class="token operator">=</span> self<span class="token punctuation">.</span>extract_url_domain<span class="token punctuation">(</span>heartbeat_data<span class="token punctuation">)</span>
                cmdb_data <span class="token operator">=</span> self<span class="token punctuation">.</span>get_cmdb_data<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>process_and_send_message<span class="token punctuation">(</span>producer<span class="token punctuation">,</span> heartbeat_data<span class="token punctuation">,</span> cmdb_data<span class="token punctuation">)</span>

        <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"接收到 KeyboardInterrupt。正在优雅地关闭。"</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"发生错误：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token comment"># 如果在处理过程中发生异常，可以在这里添加适当的处理逻辑</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            consumer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            producer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">connect_to_database</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"正在连接数据库..."</span><span class="token punctuation">)</span>
            db <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>
                host<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                port<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                user<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                password<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                database<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'db'</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"数据库连接成功."</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>db_connection_error_logged <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 连接成功后重置连接错误标志</span>
        <span class="token keyword">except</span> pymysql<span class="token punctuation">.</span>Error <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            error_message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"连接数据库时发生错误：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>error_message<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> DatabaseConnectionError<span class="token punctuation">(</span>error_message<span class="token punctuation">)</span> <span class="token keyword">from</span> e
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> db<span class="token punctuation">:</span>
                db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">load_cmdb_data</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        db <span class="token operator">=</span> <span class="token boolean">None</span>
        cursor <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"开始加载数据."</span><span class="token punctuation">)</span>
            db <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>
                host<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                port<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                user<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                password<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                database<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_config<span class="token punctuation">[</span><span class="token string">'db'</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
            cursor <span class="token operator">=</span> db<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># 查询 cmdb_os 表中的数据</span>
            sql_cmdb_os <span class="token operator">=</span> <span class="token string">"SELECT app_name, eip, module FROM cmdb_os"</span>
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql_cmdb_os<span class="token punctuation">)</span>
            cmdb_os_result <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># 查询 cmdb_app 表中的数据</span>
            sql_cmdb_app <span class="token operator">=</span> <span class="token string">"SELECT app_name, ops_user, ops_tel, ops_dep FROM cmdb_app"</span>
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql_cmdb_app<span class="token punctuation">)</span>
            cmdb_app_result <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># 将数据保存到内存中</span>
            self<span class="token punctuation">.</span>cmdb_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"cmdb_os"</span><span class="token punctuation">:</span> cmdb_os_result<span class="token punctuation">,</span>
                <span class="token string">"cmdb_app"</span><span class="token punctuation">:</span> cmdb_app_result
            <span class="token punctuation">}</span>

            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"数据加载完成."</span><span class="token punctuation">)</span>

        <span class="token keyword">except</span> pymysql<span class="token punctuation">.</span>Error <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            error_message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"加载数据时发生数据库错误：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>error_message<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"数据库连接异常，继续沿用上次的 CMDB 数据."</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> cursor<span class="token punctuation">:</span>
                cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> db<span class="token punctuation">:</span>
                db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">extract_url_domain</span><span class="token punctuation">(</span>heartbeat_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>heartbeat_data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'domain'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_cmdb_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>cmdb_data<span class="token punctuation">:</span>
            <span class="token comment"># 在内存中查找数据</span>
            cmdb_os_data <span class="token operator">=</span> <span class="token punctuation">[</span>row <span class="token keyword">for</span> row <span class="token keyword">in</span> self<span class="token punctuation">.</span>cmdb_data<span class="token punctuation">[</span><span class="token string">"cmdb_os"</span><span class="token punctuation">]</span> <span class="token keyword">if</span> row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> ip<span class="token punctuation">]</span>
            cmdb_app_data <span class="token operator">=</span> <span class="token punctuation">[</span>row <span class="token keyword">for</span> row <span class="token keyword">in</span> self<span class="token punctuation">.</span>cmdb_data<span class="token punctuation">[</span><span class="token string">"cmdb_app"</span><span class="token punctuation">]</span> <span class="token keyword">if</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> cmdb_os_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
            <span class="token keyword">return</span> cmdb_os_data<span class="token punctuation">,</span> cmdb_app_data
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">process_and_send_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> producer<span class="token punctuation">,</span> original_data<span class="token punctuation">,</span> cmdb_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        original_data_str <span class="token operator">=</span> original_data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>original_data<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token keyword">else</span> original_data

        new_message <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>original_data_str<span class="token punctuation">)</span>

        <span class="token keyword">if</span> cmdb_data<span class="token punctuation">:</span>
            cmdb_os_data<span class="token punctuation">,</span> cmdb_app_data <span class="token operator">=</span> cmdb_data
            new_message<span class="token punctuation">[</span><span class="token string">"cmdb_data"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"app_name"</span><span class="token punctuation">:</span> cmdb_os_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"eip"</span><span class="token punctuation">:</span> cmdb_os_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"module"</span><span class="token punctuation">:</span> cmdb_os_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"ops_user"</span><span class="token punctuation">:</span> cmdb_app_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"ops_tel"</span><span class="token punctuation">:</span> cmdb_app_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"ops_dep"</span><span class="token punctuation">:</span> cmdb_app_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            new_message<span class="token punctuation">[</span><span class="token string">"cmdb_data"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

        producer<span class="token punctuation">.</span>send<span class="token punctuation">(</span>self<span class="token punctuation">.</span>kafka_config<span class="token punctuation">[</span><span class="token string">'output_topic'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>new_message<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        producer<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'application.yml'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> config_file<span class="token punctuation">:</span>
            config_data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>config_file<span class="token punctuation">)</span>

        kafka_config_data <span class="token operator">=</span> config_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'kafka'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        mysql_config_data <span class="token operator">=</span> config_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        processor <span class="token operator">=</span> KafkaCMDBProcessor<span class="token punctuation">(</span>kafka_config_data<span class="token punctuation">,</span> mysql_config_data<span class="token punctuation">)</span>
        processor<span class="token punctuation">.</span>start_processing<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">except</span> FileNotFoundError<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"错误：找不到配置文件 'application.yml'。"</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"发生意外错误：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

</code></pre> 
<p>application.yml配置如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">kafka</span><span class="token punctuation">:</span>
  <span class="token key atrule">bootstrap_servers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'11.0.1.11:9092'</span>
    <span class="token punctuation">-</span> <span class="token string">'11.0.1.12:9092'</span>
    <span class="token punctuation">-</span> <span class="token string">'11.0.1.13:9092'</span>
  <span class="token key atrule">consumer_group_id</span><span class="token punctuation">:</span> <span class="token string">'heartbeat_replace'</span>
  <span class="token key atrule">input_topic</span><span class="token punctuation">:</span> <span class="token string">'ELK-heartbeat'</span>
  <span class="token key atrule">output_topic</span><span class="token punctuation">:</span> <span class="token string">'ELK-system_heartbeat'</span>

<span class="token key atrule">mysql</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">'11.0.1.11'</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">13306</span>
  <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">'root'</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">'123456'</span>
  <span class="token key atrule">db</span><span class="token punctuation">:</span> <span class="token string">'zll_python_test'</span>

</code></pre> 
<p>处理后的数据如下：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span><span class="token string">"@timestamp"</span><span class="token builtin class-name">:</span> <span class="token string">"2024-01-20T14:03:37.102Z"</span>, <span class="token string">"@metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"beat"</span><span class="token builtin class-name">:</span> <span class="token string">"heartbeat"</span>, <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"_doc"</span>, <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"8.11.1"</span><span class="token punctuation">}</span>, <span class="token string">"monitor"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"My ICMP Monitor"</span>, <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"icmp"</span>, <span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token string">"my-icmp-monitor"</span>, <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"up"</span>, <span class="token string">"check_group"</span><span class="token builtin class-name">:</span> <span class="token string">"b4caac6d-b79c-11ee-bf86-000c29a1adec-1"</span>, <span class="token string">"duration"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"us"</span><span class="token builtin class-name">:</span> <span class="token number">131</span><span class="token punctuation">}</span>, <span class="token string">"ip"</span><span class="token builtin class-name">:</span> <span class="token string">"11.0.1.14"</span>, <span class="token string">"timespan"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"gte"</span><span class="token builtin class-name">:</span> <span class="token string">"2024-01-20T14:03:37.102Z"</span>, <span class="token string">"lt"</span><span class="token builtin class-name">:</span> <span class="token string">"2024-01-20T14:03:53.102Z"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>, <span class="token string">"url"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"domain"</span><span class="token builtin class-name">:</span> <span class="token string">"11.0.1.14"</span>, <span class="token string">"full"</span><span class="token builtin class-name">:</span> <span class="token string">"icmp://11.0.1.14"</span>, <span class="token string">"scheme"</span><span class="token builtin class-name">:</span> <span class="token string">"icmp"</span><span class="token punctuation">}</span>, <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"nodename"</span><span class="token builtin class-name">:</span> <span class="token string">"demo1"</span><span class="token punctuation">}</span>, <span class="token string">"summary"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"retry_group"</span><span class="token builtin class-name">:</span> <span class="token string">"b4caac6d-b79c-11ee-bf86-000c29a1adec"</span>, <span class="token string">"attempt"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">"max_attempts"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">"final_attempt"</span><span class="token builtin class-name">:</span> true, <span class="token string">"up"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">"down"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>, <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"up"</span><span class="token punctuation">}</span>, <span class="token string">"state"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token string">"default-18d1d73022a-0"</span>, <span class="token string">"up"</span><span class="token builtin class-name">:</span> <span class="token number">32661</span>, <span class="token string">"down"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>, <span class="token string">"ends"</span><span class="token builtin class-name">:</span> null, <span class="token string">"started_at"</span><span class="token builtin class-name">:</span> <span class="token string">"2024-01-19T00:41:32.970059265+08:00"</span>, <span class="token string">"duration_ms"</span><span class="token builtin class-name">:</span> <span class="token string">"163324132"</span>, <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"up"</span>, <span class="token string">"checks"</span><span class="token builtin class-name">:</span> <span class="token number">32661</span>, <span class="token string">"flap_history"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token string">"event"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"heartbeat/summary"</span>, <span class="token string">"dataset"</span><span class="token builtin class-name">:</span> <span class="token string">"icmp"</span><span class="token punctuation">}</span>, <span class="token string">"icmp"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"requests"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">"rtt"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"us"</span><span class="token builtin class-name">:</span> <span class="token number">83</span><span class="token punctuation">}</span><span class="token punctuation">}</span>, <span class="token string">"ecs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"8.0.0"</span><span class="token punctuation">}</span>, <span class="token string">"agent"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"demo1"</span>, <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"heartbeat"</span>, <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"8.11.1"</span>, <span class="token string">"ephemeral_id"</span><span class="token builtin class-name">:</span> <span class="token string">"46819a45-3552-4e57-91f3-e58ffb12c72a"</span>, <span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token string">"d56462aa-6f6b-4237-8bfc-a93c7bf933f4"</span><span class="token punctuation">}</span>, <span class="token string">"cmdb_data"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"app_name"</span><span class="token builtin class-name">:</span> <span class="token string">"应用系统"</span>, <span class="token string">"eip"</span><span class="token builtin class-name">:</span> <span class="token string">"11.0.1.14"</span>, <span class="token string">"module"</span><span class="token builtin class-name">:</span> <span class="token string">"demo1"</span>, <span class="token string">"ops_user"</span><span class="token builtin class-name">:</span> <span class="token string">"运维仔"</span>, <span class="token string">"ops_tel"</span><span class="token builtin class-name">:</span> <span class="token string">"12345678901"</span>, <span class="token string">"ops_dep"</span><span class="token builtin class-name">:</span> <span class="token string">"运维部"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre> 
<p>总的来说，metricbeat_heartbeat和heartbeat_replace代码基本一致，只是个别地方heartbeat换成metricbeat，return data.get(‘fields’, {}).get(‘ip’, ‘’)和return data.get(‘url’, {}).get(‘domain’, ‘’)的差别而已</p> 
<p>五、heartbeat告警<br> heartbeat_alarm.py如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># heartbeat_alarm.py</span>

<span class="token keyword">import</span> json
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> mysql<span class="token punctuation">.</span>connector
<span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> kafka <span class="token keyword">import</span> KafkaConsumer
<span class="token keyword">import</span> yaml

<span class="token comment"># 配置日志记录器</span>
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>
    level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span>
    filename<span class="token operator">=</span><span class="token string">'heartbeat_checker.log'</span><span class="token punctuation">,</span>
    <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s [%(levelname)s] - %(message)s'</span><span class="token punctuation">,</span>
    datefmt<span class="token operator">=</span><span class="token string">'%Y-%m-%d %H:%M:%S'</span>
<span class="token punctuation">)</span>
logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">HeartbeatChecker</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config_path<span class="token operator">=</span><span class="token string">'application.yml'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 初始化 HeartbeatChecker 对象</span>
        self<span class="token punctuation">.</span>config_path <span class="token operator">=</span> config_path
        self<span class="token punctuation">.</span>kafka_bootstrap_servers <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>kafka_group_id <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>kafka_topic <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>mysql_host <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>mysql_port <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>mysql_user <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>mysql_password <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>mysql_database <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>consecutive_down_threshold <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>consecutive_up_threshold <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token comment"># 从 YAML 文件加载配置</span>
        self<span class="token punctuation">.</span>load_config<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>kafka_consumer <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">load_config</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 从 YAML 文件加载配置</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>config_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
                config <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>

            <span class="token comment"># 提取 Kafka 配置</span>
            self<span class="token punctuation">.</span>kafka_bootstrap_servers <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'bootstrap_servers'</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>kafka_group_id <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'group_id'</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>kafka_topic <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'topic'</span><span class="token punctuation">]</span>

            <span class="token comment"># 提取 MySQL 配置</span>
            self<span class="token punctuation">.</span>mysql_host <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'mysql'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>mysql_port <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'mysql'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'port'</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>mysql_user <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'mysql'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>mysql_password <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'mysql'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>mysql_database <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'mysql'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'database'</span><span class="token punctuation">]</span>

            <span class="token comment"># 提取连续 down 和连续 up 的阈值</span>
            self<span class="token punctuation">.</span>consecutive_down_threshold <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'thresholds'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'consecutive_down'</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>consecutive_up_threshold <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'thresholds'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'consecutive_up'</span><span class="token punctuation">]</span>

        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token comment"># 处理配置加载错误</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"加载配置时发生错误: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span>

    <span class="token keyword">def</span> <span class="token function">create_kafka_consumer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 创建 Kafka Consumer 实例</span>
            self<span class="token punctuation">.</span>kafka_consumer <span class="token operator">=</span> KafkaConsumer<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>kafka_topic<span class="token punctuation">,</span>
                bootstrap_servers<span class="token operator">=</span>self<span class="token punctuation">.</span>kafka_bootstrap_servers<span class="token punctuation">,</span>
                group_id<span class="token operator">=</span>self<span class="token punctuation">.</span>kafka_group_id<span class="token punctuation">,</span>
                auto_offset_reset<span class="token operator">=</span><span class="token string">'latest'</span><span class="token punctuation">,</span>
                enable_auto_commit<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                value_deserializer<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>x<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token comment"># 处理创建 Kafka Consumer 错误</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"创建 Kafka Consumer 时发生错误: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span>

    <span class="token keyword">def</span> <span class="token function">check_heartbeat_alerts</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 初始化 defaultdict 以存储每个 URL 的监测状态列表</span>
        url_groups <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>
        mysql_connection <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 创建 Kafka Consumer 并连接到 MySQL 数据库</span>
            self<span class="token punctuation">.</span>create_kafka_consumer<span class="token punctuation">(</span><span class="token punctuation">)</span>
            mysql_connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>
                host<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_host<span class="token punctuation">,</span>
                port<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_port<span class="token punctuation">,</span>
                user<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_user<span class="token punctuation">,</span>
                password<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_password<span class="token punctuation">,</span>
                database<span class="token operator">=</span>self<span class="token punctuation">.</span>mysql_database
            <span class="token punctuation">)</span>
            mysql_cursor <span class="token operator">=</span> mysql_connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># 遍历 Kafka 消息</span>
            <span class="token keyword">for</span> message <span class="token keyword">in</span> self<span class="token punctuation">.</span>kafka_consumer<span class="token punctuation">:</span>
                json_data <span class="token operator">=</span> message<span class="token punctuation">.</span>value
                url <span class="token operator">=</span> json_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'full'</span><span class="token punctuation">)</span>
                monitor_status <span class="token operator">=</span> json_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'monitor'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">)</span>
                timestamp_str <span class="token operator">=</span> json_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'@timestamp'</span><span class="token punctuation">)</span>
                cmdb_data <span class="token operator">=</span> json_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'cmdb_data'</span><span class="token punctuation">)</span>

                <span class="token keyword">if</span> url <span class="token keyword">and</span> monitor_status <span class="token keyword">and</span> timestamp_str<span class="token punctuation">:</span>
                    timestamp <span class="token operator">=</span> self<span class="token punctuation">.</span>convert_to_local_time<span class="token punctuation">(</span>timestamp_str<span class="token punctuation">)</span>

                    <span class="token comment"># 处理连续 up 的情况</span>
                    <span class="token keyword">if</span> monitor_status <span class="token operator">==</span> <span class="token string">'up'</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>url_exists_down_in_mysql<span class="token punctuation">(</span>mysql_cursor<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        url_groups<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>monitor_status<span class="token punctuation">)</span>
                        mysql_cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>

                        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>url_groups<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>consecutive_up_threshold <span class="token keyword">and</span> <span class="token builtin">all</span><span class="token punctuation">(</span>
                                status <span class="token operator">==</span> <span class="token string">'up'</span> <span class="token keyword">for</span> status <span class="token keyword">in</span> url_groups<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span>self<span class="token punctuation">.</span>consecutive_up_threshold<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                            self<span class="token punctuation">.</span>delete_from_mysql<span class="token punctuation">(</span>mysql_cursor<span class="token punctuation">,</span> url<span class="token punctuation">,</span> mysql_connection<span class="token punctuation">)</span>
                            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"URL: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string"> - 由于连续 up 被从 MySQL 中移除"</span></span><span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        <span class="token comment"># 处理连续 down 的情况</span>
                        <span class="token keyword">if</span> monitor_status <span class="token operator">==</span> <span class="token string">'down'</span> <span class="token keyword">and</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>url_exists_down_in_mysql<span class="token punctuation">(</span>mysql_cursor<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
                            url_groups<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>monitor_status<span class="token punctuation">)</span>
                            mysql_cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>

                            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>url_groups<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>consecutive_down_threshold <span class="token keyword">and</span> <span class="token builtin">all</span><span class="token punctuation">(</span>
                                    status <span class="token operator">==</span> <span class="token string">'down'</span> <span class="token keyword">for</span> status <span class="token keyword">in</span> url_groups<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span>self<span class="token punctuation">.</span>consecutive_down_threshold<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                                self<span class="token punctuation">.</span>send_alert<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                                self<span class="token punctuation">.</span>write_to_mysql<span class="token punctuation">(</span>mysql_cursor<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> url<span class="token punctuation">,</span> monitor_status<span class="token punctuation">,</span> mysql_connection<span class="token punctuation">,</span> cmdb_data<span class="token punctuation">)</span>
                                url_groups<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"URL: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string"> - 被添加到 MySQL 中"</span></span><span class="token punctuation">)</span>
                        <span class="token keyword">elif</span> monitor_status <span class="token operator">==</span> <span class="token string">'up'</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>url_exists_down_in_mysql<span class="token punctuation">(</span>mysql_cursor<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
                            url_groups<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>monitor_status<span class="token punctuation">)</span>
                            mysql_cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>

                            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>url_groups<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>consecutive_up_threshold <span class="token keyword">and</span> <span class="token builtin">all</span><span class="token punctuation">(</span>
                                    status <span class="token operator">==</span> <span class="token string">'up'</span> <span class="token keyword">for</span> status <span class="token keyword">in</span> url_groups<span class="token punctuation">[</span>url<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span>self<span class="token punctuation">.</span>consecutive_up_threshold<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                                self<span class="token punctuation">.</span>delete_from_mysql<span class="token punctuation">(</span>mysql_cursor<span class="token punctuation">,</span> url<span class="token punctuation">,</span> mysql_connection<span class="token punctuation">)</span>
                                url_groups<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"URL: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string"> - 由于连续 up 被从 MySQL 中移除"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token comment"># 处理运行时错误</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"发生错误: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># 关闭 Kafka Consumer 和 MySQL 连接</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>kafka_consumer<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>kafka_consumer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> mysql_connection<span class="token punctuation">:</span>
                mysql_connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">send_alert</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 记录告警信息</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"告警: URL </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string"> 连续 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>consecutive_down_threshold<span class="token punctuation">}</span></span><span class="token string"> 次掉线"</span></span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">write_to_mysql</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> url<span class="token punctuation">,</span> status<span class="token punctuation">,</span> connection<span class="token punctuation">,</span> cmdb_data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 插入数据到 MySQL，包括 "cmdb_data" 字段</span>
            insert_query <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
                INSERT INTO alert_list (timestamp, url, status, app_name, module, ops_user, ops_tel, ops_dep)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
            """</span>
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>insert_query<span class="token punctuation">,</span> <span class="token punctuation">(</span>
                timestamp<span class="token punctuation">,</span>
                url<span class="token punctuation">,</span>
                status<span class="token punctuation">,</span>
                cmdb_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'app_name'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">if</span> cmdb_data <span class="token keyword">else</span> <span class="token string">''</span><span class="token punctuation">,</span>
                cmdb_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'module'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">if</span> cmdb_data <span class="token keyword">else</span> <span class="token string">''</span><span class="token punctuation">,</span>
                cmdb_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'ops_user'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">if</span> cmdb_data <span class="token keyword">else</span> <span class="token string">''</span><span class="token punctuation">,</span>
                cmdb_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'ops_tel'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">if</span> cmdb_data <span class="token keyword">else</span> <span class="token string">''</span><span class="token punctuation">,</span>
                cmdb_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'ops_dep'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">if</span> cmdb_data <span class="token keyword">else</span> <span class="token string">''</span>
            <span class="token punctuation">)</span> <span class="token keyword">if</span> cmdb_data <span class="token keyword">else</span> <span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> url<span class="token punctuation">,</span> status<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            connection<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Inserted into MySQL: URL </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string">, Status </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>status<span class="token punctuation">}</span></span><span class="token string">, cmdb_data </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>cmdb_data<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token comment"># 处理写入 MySQL 错误</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error writing to MySQL: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">delete_from_mysql</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> url<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 从 MySQL 删除数据</span>
            delete_query <span class="token operator">=</span> <span class="token string">"DELETE FROM alert_list WHERE url = %s AND status = 'down'"</span>
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>delete_query<span class="token punctuation">,</span> <span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            connection<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"从 MySQL 中删除: URL </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token comment"># 处理从 MySQL 删除错误</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"从 MySQL 中删除时发生错误: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">url_exists_down_in_mysql</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 检查 URL 是否存在于 MySQL 中</span>
            query <span class="token operator">=</span> <span class="token string">"SELECT * FROM alert_list WHERE url = %s AND status = 'down'"</span>
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>cursor<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token comment"># 处理检查 URL 存在性错误</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"检查 URL 是否存在于 MySQL 中时发生错误: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">convert_to_local_time</span><span class="token punctuation">(</span>timestamp_str<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 将 UTC 时间转换为本地时间</span>
        timestamp_utc <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>timestamp_str<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%dT%H:%M:%S.%fZ"</span><span class="token punctuation">)</span>
        timestamp_local <span class="token operator">=</span> timestamp_utc <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> timestamp_local<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 运行主程序</span>
        heartbeat_checker <span class="token operator">=</span> HeartbeatChecker<span class="token punctuation">(</span><span class="token punctuation">)</span>
        heartbeat_checker<span class="token punctuation">.</span>check_heartbeat_alerts<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"退出..."</span><span class="token punctuation">)</span>

</code></pre> 
<p>appllication.yml如下：</p> 
<pre><code class="prism language-yaml"><span class="token comment"># application.yml</span>

<span class="token key atrule">kafka</span><span class="token punctuation">:</span>
  <span class="token key atrule">bootstrap_servers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'11.0.1.11:9092'</span>
    <span class="token punctuation">-</span> <span class="token string">'11.0.1.12:9092'</span>
    <span class="token punctuation">-</span> <span class="token string">'11.0.1.13:9092'</span>
  <span class="token key atrule">group_id</span><span class="token punctuation">:</span> <span class="token string">'python_alert'</span>
  <span class="token key atrule">topic</span><span class="token punctuation">:</span> <span class="token string">'ELK-system_heartbeat'</span>

<span class="token key atrule">mysql</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">'11.0.1.11'</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">13306</span>
  <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">'root'</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">'123456'</span>
  <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token string">'zll_python_test'</span>

<span class="token key atrule">thresholds</span><span class="token punctuation">:</span>
  <span class="token key atrule">consecutive_down</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">consecutive_up</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre> 
<p>其中consecutive_down表示连续down几次触发告警，consecutive_up表示连续up几次告警恢复。</p> 
<p>六、metricbeat告警</p> 
<p>metricbeat可以配置的告警比较多，比如CPU、内存、文件系统等，Python代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> logging
<span class="token keyword">from</span> logging<span class="token punctuation">.</span>handlers <span class="token keyword">import</span> RotatingFileHandler
<span class="token keyword">from</span> kafka <span class="token keyword">import</span> KafkaConsumer<span class="token punctuation">,</span> KafkaProducer
<span class="token keyword">import</span> yaml
<span class="token keyword">import</span> json


<span class="token keyword">class</span> <span class="token class-name">KafkaAlertProcessor</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 配置记录日志到控制台和文件</span>
        self<span class="token punctuation">.</span>configure_logging<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>config_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> config_file<span class="token punctuation">:</span>
            config <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>config_file<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>kafka_brokers <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'brokers'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>input_topic <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'input_topic'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>output_topic <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'output_topic'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>group_id <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'group_id'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>cpu_alert_threshold <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'alert_thresholds'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'cpu'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>memory_alert_threshold <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'alert_thresholds'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'memory'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>filesystem_alert_threshold <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'alert_thresholds'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'filesystem'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>common_template <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'alert_templates'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'common'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>cpu_alert_template <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'alert_templates'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'cpu'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>memory_alert_template <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'alert_templates'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'memory'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>filesystem_alert_template <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'alert_templates'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'filesystem'</span><span class="token punctuation">]</span>

        self<span class="token punctuation">.</span>consumer <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>producer <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">configure_logging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 配置日志记录到控制台和文件</span>
        logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>

        <span class="token comment"># 配置控制台输出</span>
        console_handler <span class="token operator">=</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
        console_handler<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>

        <span class="token comment"># 配置文件输出，按文件大小进行轮转，最多保存10个日志文件，每个文件最大1M</span>
        file_handler <span class="token operator">=</span> RotatingFileHandler<span class="token punctuation">(</span><span class="token string">'metricbeat_alarm.log'</span><span class="token punctuation">,</span> maxBytes<span class="token operator">=</span><span class="token number">1000000</span><span class="token punctuation">,</span> backupCount<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
                                           delay<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        file_handler<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>

        <span class="token comment"># 设置日志格式</span>
        formatter <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span><span class="token string">'%(asctime)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span>
        console_handler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>
        file_handler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>

        <span class="token comment"># 将处理程序添加到日志记录器</span>
        logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>console_handler<span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>file_handler<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">initialize_consumer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>consumer <span class="token operator">=</span> KafkaConsumer<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>input_topic<span class="token punctuation">,</span>
            group_id<span class="token operator">=</span>self<span class="token punctuation">.</span>group_id<span class="token punctuation">,</span>
            bootstrap_servers<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>kafka_brokers<span class="token punctuation">)</span><span class="token punctuation">,</span>
            auto_offset_reset<span class="token operator">=</span><span class="token string">'latest'</span><span class="token punctuation">,</span>
            enable_auto_commit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">initialize_producer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>producer <span class="token operator">=</span> KafkaProducer<span class="token punctuation">(</span>
            bootstrap_servers<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>kafka_brokers<span class="token punctuation">)</span><span class="token punctuation">,</span>
            value_serializer<span class="token operator">=</span><span class="token keyword">lambda</span> v<span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>v<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_alert</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cmdb_data <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"cmdb_data"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        common_message <span class="token operator">=</span> self<span class="token punctuation">.</span>common_template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            cmdb_data_eip<span class="token operator">=</span>cmdb_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"eip"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            cmdb_data_app_name<span class="token operator">=</span>cmdb_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"app_name"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            cmdb_data_module<span class="token operator">=</span>cmdb_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"module"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            cmdb_data_ops_user<span class="token operator">=</span>cmdb_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"ops_user"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            cmdb_data_ops_tel<span class="token operator">=</span>cmdb_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"ops_tel"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            cmdb_data_ops_dep<span class="token operator">=</span>cmdb_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"ops_dep"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>

        <span class="token punctuation">)</span>
        <span class="token comment"># 检查 CPU 使用率</span>
        <span class="token keyword">if</span> <span class="token string">"system"</span> <span class="token keyword">in</span> data <span class="token keyword">and</span> <span class="token string">"cpu"</span> <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span> <span class="token keyword">and</span> <span class="token string">"total"</span> <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"cpu"</span><span class="token punctuation">]</span> <span class="token keyword">and</span> <span class="token string">"pct"</span> <span class="token keyword">in</span> \
                data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"cpu"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"total"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            cpu_usage <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"cpu"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"total"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"pct"</span><span class="token punctuation">]</span> <span class="token operator">/</span> data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"cpu"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"cores"</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> cpu_usage <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>cpu_alert_threshold<span class="token punctuation">:</span>
                cpu_alert_message <span class="token operator">=</span> self<span class="token punctuation">.</span>cpu_alert_template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                    cpu_usage<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"cpu"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"total"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"pct"</span><span class="token punctuation">]</span> <span class="token operator">/</span> data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"cpu"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"cores"</span><span class="token punctuation">]</span>
                <span class="token punctuation">)</span>
                alert_message <span class="token operator">=</span> cpu_alert_message <span class="token operator">+</span> common_message
                self<span class="token punctuation">.</span>send_alert<span class="token punctuation">(</span><span class="token string">"CPU 告警"</span><span class="token punctuation">,</span> alert_message<span class="token punctuation">)</span>

        <span class="token comment"># 检查内存使用率</span>
        <span class="token keyword">if</span> <span class="token string">"system"</span> <span class="token keyword">in</span> data <span class="token keyword">and</span> <span class="token string">"memory"</span> <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span> <span class="token keyword">and</span> <span class="token string">"actual"</span> <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"memory"</span><span class="token punctuation">]</span> <span class="token keyword">and</span> <span class="token string">"used"</span> <span class="token keyword">in</span> \
                data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"memory"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'actual'</span><span class="token punctuation">]</span> <span class="token keyword">and</span> <span class="token string">'pct'</span> <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"memory"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'actual'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'used'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            memory_usage <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"memory"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"actual"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"used"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"pct"</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> memory_usage <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>memory_alert_threshold<span class="token punctuation">:</span>
                memory_alert_message <span class="token operator">=</span> self<span class="token punctuation">.</span>memory_alert_template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                    memory_actual_used_pct<span class="token operator">=</span>memory_usage
                <span class="token punctuation">)</span>
                alert_message <span class="token operator">=</span> memory_alert_message <span class="token operator">+</span> common_message
                self<span class="token punctuation">.</span>send_alert<span class="token punctuation">(</span><span class="token string">"内存告警"</span><span class="token punctuation">,</span> alert_message<span class="token punctuation">)</span>

        <span class="token comment"># 检查文件系统使用率</span>
        <span class="token keyword">if</span> <span class="token string">"system"</span> <span class="token keyword">in</span> data <span class="token keyword">and</span> <span class="token string">"filesystem"</span> <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span> <span class="token keyword">and</span> <span class="token string">"used"</span> <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"filesystem"</span><span class="token punctuation">]</span> <span class="token keyword">and</span> <span class="token string">"pct"</span> <span class="token keyword">in</span> \
                data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"filesystem"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"used"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            filesystem_usage <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"filesystem"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"used"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"pct"</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> filesystem_usage <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>filesystem_alert_threshold<span class="token punctuation">:</span>
                fs_alert_message <span class="token operator">=</span> self<span class="token punctuation">.</span>filesystem_alert_template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                    filesystem_used_pct<span class="token operator">=</span>filesystem_usage<span class="token punctuation">,</span>
                    filesystem_mount_point<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"filesystem"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"mount_point"</span><span class="token punctuation">,</span> <span class="token string">"Unknown"</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                alert_message <span class="token operator">=</span> fs_alert_message <span class="token operator">+</span> common_message
                self<span class="token punctuation">.</span>send_alert<span class="token punctuation">(</span><span class="token string">"文件系统告警"</span><span class="token punctuation">,</span> alert_message<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">send_alert</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> alert_type<span class="token punctuation">,</span> alert_message<span class="token punctuation">)</span><span class="token punctuation">:</span>
        formatted_message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>alert_type<span class="token punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>alert_message<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>formatted_message<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>send<span class="token punctuation">(</span>self<span class="token punctuation">.</span>output_topic<span class="token punctuation">,</span>
                           value<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"alert_type"</span><span class="token punctuation">:</span> alert_type<span class="token punctuation">,</span> <span class="token string">"alert_message"</span><span class="token punctuation">:</span> formatted_message<span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>initialize_consumer<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>initialize_producer<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> msg <span class="token keyword">in</span> self<span class="token punctuation">.</span>consumer<span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>process_alert<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                <span class="token keyword">except</span> json<span class="token punctuation">.</span>JSONDecodeError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                    logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"解码 JSON 错误: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>consumer<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    kafka_alert_processor <span class="token operator">=</span> KafkaAlertProcessor<span class="token punctuation">(</span>config_path<span class="token operator">=</span><span class="token string">"application.yml"</span><span class="token punctuation">)</span>
    kafka_alert_processor<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>application.yml文件如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">kafka</span><span class="token punctuation">:</span>
  <span class="token key atrule">brokers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"11.0.1.11:9092"</span>
    <span class="token punctuation">-</span> <span class="token string">"11.0.1.12:9092"</span>
    <span class="token punctuation">-</span> <span class="token string">"11.0.1.13:9092"</span>
  <span class="token key atrule">input_topic</span><span class="token punctuation">:</span> <span class="token string">"ELK-system_metricbeat"</span>
  <span class="token key atrule">output_topic</span><span class="token punctuation">:</span> <span class="token string">"ELK-alarm"</span>
  <span class="token key atrule">group_id</span><span class="token punctuation">:</span> <span class="token string">"ELK-alarm"</span>

<span class="token key atrule">alert_thresholds</span><span class="token punctuation">:</span>
  <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">0.01</span>
  <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token number">0.1</span>
  <span class="token key atrule">filesystem</span><span class="token punctuation">:</span> <span class="token number">0.1</span>

<span class="token key atrule">alert_templates</span><span class="token punctuation">:</span>
  <span class="token key atrule">common</span><span class="token punctuation">:</span> <span class="token string">"IP：{cmdb_data_eip}\n系统名称：{cmdb_data_app_name}\n模块：{cmdb_data_module}\n运维责任人：{cmdb_data_ops_user}\n电话：{cmdb_data_ops_tel}\n责任部门：{cmdb_data_ops_dep}\n"</span>
  <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"【CPU使用率告警】\n告警信息：CPU 使用率 超过阈值。当前平均值：{cpu_usage}.\n"</span>
  <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"【内存使用率告警】\n告警信息：内存 使用率 超过阈值。当前值：{memory_actual_used_pct}.\n"</span>
  <span class="token key atrule">filesystem</span><span class="token punctuation">:</span> <span class="token string">"【文件系统使用率告警】\n告警信息：文件系统 使用率 超过阈值。当前值：{filesystem_used_pct}. 挂载点：{filesystem_mount_point}.\n"</span>
</code></pre> 
<p>产生的告警信息如下：</p> 
<pre><code class="prism language-bash">【内存使用率告警】
告警信息：内存 使用率 超过阈值。当前值：0.1502.
IP：11.0.1.14
系统名称：应用系统
模块：demo1
运维责任人：运维仔
电话：12345678901
责任部门：运维部

【文件系统使用率告警】
告警信息：文件系统 使用率 超过阈值。当前值：0.1178. 挂载点：/.
IP：11.0.1.14
系统名称：应用系统
模块：demo1
运维责任人：运维仔
电话：12345678901
责任部门：运维部

【CPU使用率告警】
告警信息：CPU 使用率 超过阈值。当前平均值：0.002.
IP：11.0.1.14
系统名称：应用系统
模块：demo1
运维责任人：运维仔
电话：12345678901
责任部门：运维部
</code></pre> 
<p>我目前是将告警信息输出到kafka、控制台和日志的，各位看官可以根据自己的需要，将信息写入到接口、redis或者数据库中。</p> 
<p>七、告警恢复<br> 正在研究中</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/515d3891a114ab192823a8bd0ba1515f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MATLAB聚类工具箱</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fb8e80f068b331b29f275c1a70760604/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python学习从0到1 day7 Python判断语句</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>