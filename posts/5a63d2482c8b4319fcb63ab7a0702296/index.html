<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用ndt配准实现简单的激光里程计 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用ndt配准实现简单的激光里程计" />
<meta property="og:description" content="激光里程计 1、原理2、几点需要注意的1. 关键帧的选取2. 更新当前帧pose3. 设置guess_pose 3、效果4、参考5、代码 1、原理 读入每一帧的点云，和地图做ndt配准，得到当前帧的pose，使用这个pose作为下一帧配准的guess_pose，如果当前帧是关键帧（关键帧如何选取？- 根据与上一关键帧的距离或者每隔几帧设置为关键帧），那么更新地图并且将当前帧更新为关键帧。
2、几点需要注意的 1. 关键帧的选取 当前帧距离上一个关键帧的位移超过阈值（1m），则认为当前帧为关键帧。
// 如果当前帧和上一帧的平移超过了min_add_scan_shift_,那么更新地图,并更新previous帧,发布地图 // .否则,previous帧不变 double shift = sqrt(pow(current_pose_.x - previous_pose_.x, 2.0) &#43; pow(current_pose_.y - previous_pose_.y, 2.0)); if (shift &gt;= min_add_scan_shift_) { map_ &#43;= *transformed_scan_ptr; previous_pose_.x = current_pose_.x;previous_pose_.y = current_pose_.y;previous_pose_.z = current_pose_.z; previous_pose_.roll = current_pose_.roll;previous_pose_.pitch = current_pose_.pitch;previous_pose_.yaw = current_pose_.yaw; ndt.setInputTarget(map_ptr); sensor_msgs::PointCloud2::Ptr map_msg_ptr(new sensor_msgs::PointCloud2); pcl::toROSMsg(*map_ptr, *map_msg_ptr); ndt_map_pub_.publish(*map_msg_ptr); } 2. 更新当前帧pose ndt结束后根据输出的矩阵来更新当前帧的pose
// 配准后的输出点云 pcl::PointCloud&lt;pcl::PointXYZI&gt;::Ptr output_cloud(new pcl::PointCloud&lt;pcl::PointXYZI&gt;); ndt.align(*output_cloud, init_guess); // 这个点云是经过下采样的,我们不使用 t_localizer = ndt." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/5a63d2482c8b4319fcb63ab7a0702296/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-06-01T10:23:23+08:00" />
<meta property="article:modified_time" content="2020-06-01T10:23:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用ndt配准实现简单的激光里程计</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>激光里程计</h4> 
 <ul><li><a href="#1_1" rel="nofollow">1、原理</a></li><li><a href="#2_3" rel="nofollow">2、几点需要注意的</a></li><li><ul><li><ul><li><a href="#1__4" rel="nofollow">1. 关键帧的选取</a></li><li><a href="#2_pose_25" rel="nofollow">2. 更新当前帧pose</a></li><li><a href="#3_guess_pose_59" rel="nofollow">3. 设置guess_pose</a></li></ul> 
  </li></ul> 
  </li><li><a href="#3_84" rel="nofollow">3、效果</a></li><li><a href="#4_92" rel="nofollow">4、参考</a></li><li><a href="#5_95" rel="nofollow">5、代码</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1_1"></a>1、原理</h2> 
<p>读入每一帧的点云，和地图做ndt配准，得到当前帧的pose，使用这个pose作为下一帧配准的guess_pose，如果<font color="red">当前帧</font>是<font color="blue">关键帧</font>（关键帧如何选取？- 根据与上一关键帧的距离或者每隔几帧设置为关键帧），那么更新地图并且将<font color="red">当前帧</font>更新为<font color="blue">关键帧</font>。</p> 
<h2><a id="2_3"></a>2、几点需要注意的</h2> 
<h4><a id="1__4"></a>1. 关键帧的选取</h4> 
<p>当前帧距离上一个关键帧的位移超过阈值（1m），则认为当前帧为关键帧。</p> 
<pre><code class="prism language-c++">  // 如果当前帧和上一帧的平移超过了min_add_scan_shift_,那么更新地图,并更新previous帧,发布地图
  // .否则,previous帧不变
  double shift = sqrt(pow(current_pose_.x - previous_pose_.x, 2.0) + pow(current_pose_.y - previous_pose_.y, 2.0));
  if (shift &gt;= min_add_scan_shift_)
  {
    map_ += *transformed_scan_ptr;
    previous_pose_.x = current_pose_.x;previous_pose_.y = current_pose_.y;previous_pose_.z = current_pose_.z;
    previous_pose_.roll = current_pose_.roll;previous_pose_.pitch = current_pose_.pitch;previous_pose_.yaw = current_pose_.yaw;
    ndt.setInputTarget(map_ptr);

    sensor_msgs::PointCloud2::Ptr map_msg_ptr(new sensor_msgs::PointCloud2);
    pcl::toROSMsg(*map_ptr, *map_msg_ptr);
    ndt_map_pub_.publish(*map_msg_ptr);
  }
</code></pre> 
<h4><a id="2_pose_25"></a>2. 更新当前帧pose</h4> 
<p>ndt结束后根据输出的矩阵来更新当前帧的pose</p> 
<pre><code class="prism language-c++">  // 配准后的输出点云
  pcl::PointCloud&lt;pcl::PointXYZI&gt;::Ptr output_cloud(new pcl::PointCloud&lt;pcl::PointXYZI&gt;);
 
  ndt.align(*output_cloud, init_guess);       // 这个点云是经过下采样的,我们不使用
  t_localizer = ndt.getFinalTransformation(); 

  t_base_link = t_localizer * tf_ltob_;       // 变换到第一帧的坐标系下

  pcl::transformPointCloud(*scan_ptr, *transformed_scan_ptr, t_localizer);

  tf::Matrix3x3 mat_b;
  mat_b.setValue(static_cast&lt;double&gt;(t_base_link(0, 0)), static_cast&lt;double&gt;(t_base_link(0, 1)),
                 static_cast&lt;double&gt;(t_base_link(0, 2)), static_cast&lt;double&gt;(t_base_link(1, 0)),
                 static_cast&lt;double&gt;(t_base_link(1, 1)), static_cast&lt;double&gt;(t_base_link(1, 2)),
                 static_cast&lt;double&gt;(t_base_link(2, 0)), static_cast&lt;double&gt;(t_base_link(2, 1)),
                 static_cast&lt;double&gt;(t_base_link(2, 2)));

  // Update current_pose_.
  // 更新当前pose
  current_pose_.x = t_base_link(0, 3);current_pose_.y = t_base_link(1, 3);current_pose_.z = t_base_link(2, 3);
  mat_b.getRPY(current_pose_.roll, current_pose_.pitch, current_pose_.yaw, 1);//mat2rpy

  transform.setOrigin(tf::Vector3(current_pose_.x, current_pose_.y, current_pose_.z));
  q.setRPY(current_pose_.roll, current_pose_.pitch, current_pose_.yaw); //q from rpy
  transform.setRotation(q);//trans from q

  br_.sendTransform(tf::StampedTransform(transform, input-&gt;header.stamp, "map", "base_link"));
</code></pre> 
<h4><a id="3_guess_pose_59"></a>3. 设置guess_pose</h4> 
<p>第二帧和第一帧（map）之间的guess_pose是0变换</p> 
<pre><code class="prism language-c++">  // 设置估计的pose 用来配准
  Eigen::Matrix4f init_guess =
      (init_translation * init_rotation_z * init_rotation_y * init_rotation_x).matrix() * tf_btol_; // 默认是0
</code></pre> 
<p>后续的帧到地图上的guess_pose是由上一帧配准后输出的current_pose决定的</p> 
<pre><code class="prism language-c++"> // 初始值为(0,0,0,0,0,0)
  Eigen::Translation3f init_translation(current_pose_.x, current_pose_.y, current_pose_.z);
  Eigen::AngleAxisf init_rotation_x(current_pose_.roll, Eigen::Vector3f::UnitX());
  Eigen::AngleAxisf init_rotation_y(current_pose_.pitch, Eigen::Vector3f::UnitY());
  Eigen::AngleAxisf init_rotation_z(current_pose_.yaw, Eigen::Vector3f::UnitZ());

  // 设置估计的pose 用来配准
  Eigen::Matrix4f init_guess =
      (init_translation * init_rotation_z * init_rotation_y * init_rotation_x).matrix() * tf_btol_; // 默认是0
</code></pre> 
<h2><a id="3_84"></a>3、效果</h2> 
<p><img src="https://images2.imgbox.com/4a/6a/n7wfQOd1_o.png" alt="mapping"><br> <img src="https://images2.imgbox.com/12/cf/2LwRfXjC_o.png" alt="建好的地图"><br> <strong>视频</strong></p> 
<p></p> 
<div class="csdn-video-box"> 
 <iframe id="XAJW3xEf-1590980173691" frameborder="0" src="https://player.bilibili.com/player.html?aid=328492153" allowfullscreen="true" data-mediaembed="bilibili"></iframe> 
 <p>使用ndt配准实现简单的激光里程计</p> 
</div> 
<p></p> 
<h2><a id="4_92"></a>4、参考</h2> 
<p>https://github.com/rsasaki0109/ndt_mapping</p> 
<h2><a id="5_95"></a>5、代码</h2> 
<p>https://github.com/suyunzzz/aiimooc_lesson/tree/master/aiimooc_syz5</p> 
<hr> 
<p><mark>ndt_mapping.cpp</mark></p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * Copyright 2015-2019 Autoware Foundation. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token comment">/*
 Localization and mapping program using Normal Distributions Transform

 Yuki KITSUKAWA
 */</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ndt_mapping.h"</span></span>
using namespace std<span class="token punctuation">;</span>

ndt_mapping<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ndt_mapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 初始化订阅者,发布者</span>
  points_sub_ <span class="token operator">=</span> nh_<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"/rslidar_points"</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ndt_mapping<span class="token punctuation">:</span><span class="token punctuation">:</span>points_callback<span class="token punctuation">,</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ndt_map_pub_ <span class="token operator">=</span> nh_<span class="token punctuation">.</span>advertise<span class="token operator">&lt;</span>sensor_msgs<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud2<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"/ndt_map"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  current_pose_pub_ <span class="token operator">=</span> nh_<span class="token punctuation">.</span>advertise<span class="token operator">&lt;</span>geometry_msgs<span class="token punctuation">:</span><span class="token punctuation">:</span>PoseStamped<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"/current_pose"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Default values</span>
  nh_<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"max_iter"</span><span class="token punctuation">,</span> max_iter_<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// ndt最大迭代次数</span>
  nh_<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"step_size"</span><span class="token punctuation">,</span> step_size_<span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// ndt步长</span>
  nh_<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"ndt_res"</span><span class="token punctuation">,</span> ndt_res_<span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// ndt分辨率</span>
  nh_<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"trans_eps"</span><span class="token punctuation">,</span> trans_eps_<span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// ndt容许的误差 越小越严苛</span>
  nh_<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"voxel_leaf_size"</span><span class="token punctuation">,</span> voxel_leaf_size_<span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// voxel的分辨率</span>
  nh_<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"scan_rate"</span><span class="token punctuation">,</span> scan_rate_<span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// scan rate</span>
  nh_<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"min_scan_range"</span><span class="token punctuation">,</span> min_scan_range_<span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// min_scan_range</span>
  nh_<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"max_scan_range"</span><span class="token punctuation">,</span> max_scan_range_<span class="token punctuation">,</span> <span class="token number">200.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// max scan range</span>
  nh_<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"use_imu"</span><span class="token punctuation">,</span> use_imu_<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 不使用imu</span>

  initial_scan_loaded <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token comment">// 未载入地图</span>
  min_add_scan_shift_ <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>            <span class="token comment">// 超过1m设置为关键帧</span>

  _tf_x<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> _tf_y<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> _tf_z<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> _tf_roll<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> _tf_pitch<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> _tf_yaw<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">;</span>

  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"incremental_voxel_update: "</span> <span class="token operator">&lt;&lt;</span> _incremental_voxel_update <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>    <span class="token comment">// voxel 增量</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"(tf_x,tf_y,tf_z,tf_roll,tf_pitch,tf_yaw): ("</span> <span class="token operator">&lt;&lt;</span> _tf_x <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> _tf_y <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> _tf_z <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span>
            <span class="token operator">&lt;&lt;</span> _tf_roll <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> _tf_pitch <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> _tf_yaw <span class="token operator">&lt;&lt;</span> <span class="token string">")"</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>

  Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Translation3f <span class="token function">tl_btol</span><span class="token punctuation">(</span>_tf_x<span class="token punctuation">,</span> _tf_y<span class="token punctuation">,</span> _tf_z<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// tl: translation  base---&gt;lidar</span>
  Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>AngleAxisf <span class="token function">rot_x_btol</span><span class="token punctuation">(</span>_tf_roll<span class="token punctuation">,</span> Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Vector3f<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">UnitX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// rot: rotation</span>
  Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>AngleAxisf <span class="token function">rot_y_btol</span><span class="token punctuation">(</span>_tf_pitch<span class="token punctuation">,</span> Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Vector3f<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">UnitY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>AngleAxisf <span class="token function">rot_z_btol</span><span class="token punctuation">(</span>_tf_yaw<span class="token punctuation">,</span> Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Vector3f<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">UnitZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tf_btol_ <span class="token operator">=</span> <span class="token punctuation">(</span>tl_btol <span class="token operator">*</span> rot_z_btol <span class="token operator">*</span> rot_y_btol <span class="token operator">*</span> rot_x_btol<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// base to lidar  初始是旋转=0,平移=0</span>
  tf_ltob_ <span class="token operator">=</span> tf_btol_<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                            <span class="token comment">// lidar ---&gt;base(地图)</span>

  map_<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">"/map"</span><span class="token punctuation">;</span>                                 <span class="token comment">// 设置map_点云的frame.id 为 map 所以要想显示map_点云,必须要在rviz中选择map,并且还要做map和rslidar之间的</span>

  <span class="token comment">// 当前pose和之前的pose</span>
  current_pose_<span class="token punctuation">.</span>x <span class="token operator">=</span> current_pose_<span class="token punctuation">.</span>y <span class="token operator">=</span> current_pose_<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>current_pose_<span class="token punctuation">.</span>roll <span class="token operator">=</span> current_pose_<span class="token punctuation">.</span>pitch <span class="token operator">=</span> current_pose_<span class="token punctuation">.</span>yaw <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
  previous_pose_<span class="token punctuation">.</span>x <span class="token operator">=</span> previous_pose_<span class="token punctuation">.</span>y <span class="token operator">=</span> previous_pose_<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>previous_pose_<span class="token punctuation">.</span>roll <span class="token operator">=</span> previous_pose_<span class="token punctuation">.</span>pitch <span class="token operator">=</span> previous_pose_<span class="token punctuation">.</span>yaw <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

  voxel_grid_filter_<span class="token punctuation">.</span><span class="token function">setLeafSize</span><span class="token punctuation">(</span>voxel_leaf_size_<span class="token punctuation">,</span> voxel_leaf_size_<span class="token punctuation">,</span> voxel_leaf_size_<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// voxel采样</span>

  ndt<span class="token punctuation">.</span><span class="token function">setTransformationEpsilon</span><span class="token punctuation">(</span>trans_eps_<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 容许误差</span>
  ndt<span class="token punctuation">.</span><span class="token function">setStepSize</span><span class="token punctuation">(</span>step_size_<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// 步长</span>
  ndt<span class="token punctuation">.</span><span class="token function">setResolution</span><span class="token punctuation">(</span>ndt_res_<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// ndt分辨率</span>
  ndt<span class="token punctuation">.</span><span class="token function">setMaximumIterations</span><span class="token punctuation">(</span>max_iter_<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 最大迭代次数</span>

  is_first_map_ <span class="token operator">=</span> true<span class="token punctuation">;</span>    <span class="token comment">// 是初始地图</span>

  <span class="token comment">// 打印初始参数</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"ndt_res: "</span> <span class="token operator">&lt;&lt;</span> ndt_res_ <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"step_size: "</span> <span class="token operator">&lt;&lt;</span> step_size_ <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"trans_epsilon: "</span> <span class="token operator">&lt;&lt;</span> trans_eps_ <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>     <span class="token comment">//为终止条件设置最小转换差异</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"max_iter: "</span> <span class="token operator">&lt;&lt;</span> max_iter_ <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"voxel_leaf_size: "</span> <span class="token operator">&lt;&lt;</span> voxel_leaf_size_ <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"min_scan_range: "</span> <span class="token operator">&lt;&lt;</span> min_scan_range_ <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"max_scan_range: "</span> <span class="token operator">&lt;&lt;</span> max_scan_range_ <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"min_add_scan_shift: "</span> <span class="token operator">&lt;&lt;</span> min_add_scan_shift_ <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 

ndt_mapping<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">~</span><span class="token function">ndt_mapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> 

<span class="token comment">// poincloud的回调函数,接收到消息就调用</span>
<span class="token keyword">void</span> ndt_mapping<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">points_callback</span><span class="token punctuation">(</span><span class="token keyword">const</span> sensor_msgs<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud2<span class="token punctuation">:</span><span class="token punctuation">:</span>ConstPtr<span class="token operator">&amp;</span> input<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud<span class="token operator">&lt;</span>pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointXYZI<span class="token operator">&gt;</span> tmp<span class="token punctuation">,</span> scan<span class="token punctuation">;</span>            <span class="token comment">// tmp  scan:裁剪后的点云</span>
  pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud<span class="token operator">&lt;</span>pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointXYZI<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">:</span>Ptr <span class="token function">filtered_scan_ptr</span><span class="token punctuation">(</span>new pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud<span class="token operator">&lt;</span>pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointXYZI<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 滤波之后的点云</span>
  pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud<span class="token operator">&lt;</span>pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointXYZI<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">:</span>Ptr <span class="token function">transformed_scan_ptr</span><span class="token punctuation">(</span>new pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud<span class="token operator">&lt;</span>pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointXYZI<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 变换之后的点云</span>
  tf<span class="token punctuation">:</span><span class="token punctuation">:</span>Quaternion q<span class="token punctuation">;</span>             <span class="token comment">// 表示旋转的四元数 (x y z w)</span>

  Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Matrix4f <span class="token function">t_localizer</span><span class="token punctuation">(</span>Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Matrix4f<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// scan相对于map的变换矩阵</span>
  Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Matrix4f <span class="token function">t_base_link</span><span class="token punctuation">(</span>Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Matrix4f<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// scan相对于map的变换矩阵</span>
  <span class="token comment">//static tf::TransformBroadcaster br;         // 已经加入到类成员中了</span>
  tf<span class="token punctuation">:</span><span class="token punctuation">:</span>Transform transform<span class="token punctuation">;</span>          <span class="token comment">// tf 传递的转换本身 ,为了发布pose用</span>

  <span class="token comment">// tmp 裁剪后 得到scan</span>
  pcl<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">fromROSMsg</span><span class="token punctuation">(</span><span class="token operator">*</span>input<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">double</span> r<span class="token punctuation">;</span>                         <span class="token comment">// 每一个点的水平深度  r=(x^2+y^2)^(1/2)</span>
  Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Vector3d point_pos<span class="token punctuation">;</span>        <span class="token comment">// 不使用imu就用不到</span>
  pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointXYZI p<span class="token punctuation">;</span>                 <span class="token comment">// 点 p</span>

  <span class="token comment">// 裁剪点云</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud<span class="token operator">&lt;</span>pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointXYZI<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">:</span>const_iterator item <span class="token operator">=</span> tmp<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> item <span class="token operator">!=</span> tmp<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> item<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>use_imu_<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">// 使用imu预测pose</span>
      <span class="token comment">// deskew(TODO:inplement of predicting pose by imu)</span>
      point_pos<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>item<span class="token operator">-&gt;</span>x<span class="token punctuation">;</span>
      point_pos<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>item<span class="token operator">-&gt;</span>y<span class="token punctuation">;</span>
      point_pos<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>item<span class="token operator">-&gt;</span>z<span class="token punctuation">;</span>
      <span class="token keyword">double</span> s <span class="token operator">=</span> scan_rate_ <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">(</span>item<span class="token operator">-&gt;</span>intensity<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">int</span><span class="token punctuation">(</span>item<span class="token operator">-&gt;</span>intensity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      point_pos<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">=</span> s <span class="token operator">*</span> current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x<span class="token punctuation">;</span><span class="token comment">//current_pose_imu_</span>
      point_pos<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">=</span> s <span class="token operator">*</span> current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
      point_pos<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">=</span> s <span class="token operator">*</span> current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z<span class="token punctuation">;</span>

      Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Quaterniond start_quat<span class="token punctuation">,</span> end_quat<span class="token punctuation">,</span> mid_quat<span class="token punctuation">;</span>
      mid_quat<span class="token punctuation">.</span><span class="token function">setIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      end_quat <span class="token operator">=</span> Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Quaterniond</span><span class="token punctuation">(</span>
        current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w<span class="token punctuation">,</span>
        current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
        current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
        current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
      start_quat <span class="token operator">=</span> mid_quat<span class="token punctuation">.</span><span class="token function">slerp</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> end_quat<span class="token punctuation">)</span><span class="token punctuation">;</span>

      point_pos <span class="token operator">=</span> start_quat<span class="token punctuation">.</span><span class="token function">conjugate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> start_quat <span class="token operator">*</span> point_pos<span class="token punctuation">;</span>

      point_pos<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token operator">=</span> current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
      point_pos<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token operator">=</span> current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
      point_pos<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token operator">=</span> current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z<span class="token punctuation">;</span>

      p<span class="token punctuation">.</span>x <span class="token operator">=</span> point_pos<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      p<span class="token punctuation">.</span>y <span class="token operator">=</span> point_pos<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      p<span class="token punctuation">.</span>z <span class="token operator">=</span> point_pos<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   <span class="token comment">// 不使用</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span> <span class="token comment">// 不适用imu</span>
      p<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>item<span class="token operator">-&gt;</span>x<span class="token punctuation">;</span>
      p<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>item<span class="token operator">-&gt;</span>y<span class="token punctuation">;</span>
      p<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>item<span class="token operator">-&gt;</span>z<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    p<span class="token punctuation">.</span>intensity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>item<span class="token operator">-&gt;</span>intensity<span class="token punctuation">;</span>
  
    <span class="token comment">// minmax根据距离裁剪,太近或者太远的删掉</span>
    r <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">pow</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">pow</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>min_scan_range_ <span class="token operator">&lt;</span> r <span class="token operator">&amp;&amp;</span> r <span class="token operator">&lt;</span> max_scan_range_<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      scan<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 最终得到scan</span>
  pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud<span class="token operator">&lt;</span>pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointXYZI<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">:</span>Ptr <span class="token function">scan_ptr</span><span class="token punctuation">(</span>new pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud<span class="token operator">&lt;</span>pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointXYZI<span class="token operator">&gt;</span><span class="token punctuation">(</span>scan<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// scan是在lidar坐标系下的</span>

  <span class="token comment">// Add initial point cloud to velodyne_map</span>
  <span class="token comment">// 如果是第一帧点云,那么将其设置位map_</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>initial_scan_loaded <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    pcl<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">transformPointCloud</span><span class="token punctuation">(</span><span class="token operator">*</span>scan_ptr<span class="token punctuation">,</span> <span class="token operator">*</span>transformed_scan_ptr<span class="token punctuation">,</span> tf_btol_<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 第一帧转换到base下  变换矩阵应该是base相对于lidar的变换</span>
    map_ <span class="token operator">+</span><span class="token operator">=</span> <span class="token operator">*</span>transformed_scan_ptr<span class="token punctuation">;</span>
    initial_scan_loaded <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 扫描到的点云下采样</span>
  voxel_grid_filter_<span class="token punctuation">.</span><span class="token function">setInputCloud</span><span class="token punctuation">(</span>scan_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  voxel_grid_filter_<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">*</span>filtered_scan_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ndt<span class="token punctuation">.</span><span class="token function">setInputSource</span><span class="token punctuation">(</span>filtered_scan_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// source:降采样后的点云</span>

  <span class="token comment">// 如果是最开始的第一帧点云的地图,直接设置配准的目标为这个地图</span>
  pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud<span class="token operator">&lt;</span>pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointXYZI<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">:</span>Ptr <span class="token function">map_ptr</span><span class="token punctuation">(</span>new pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud<span class="token operator">&lt;</span>pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointXYZI<span class="token operator">&gt;</span><span class="token punctuation">(</span>map_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>is_first_map_ <span class="token operator">==</span> true<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    ndt<span class="token punctuation">.</span><span class="token function">setInputTarget</span><span class="token punctuation">(</span>map_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// target:map_</span>
    is_first_map_ <span class="token operator">=</span> false<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 初始值为(0,0,0,0,0,0)</span>
  Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Translation3f <span class="token function">init_translation</span><span class="token punctuation">(</span>current_pose_<span class="token punctuation">.</span>x<span class="token punctuation">,</span> current_pose_<span class="token punctuation">.</span>y<span class="token punctuation">,</span> current_pose_<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>AngleAxisf <span class="token function">init_rotation_x</span><span class="token punctuation">(</span>current_pose_<span class="token punctuation">.</span>roll<span class="token punctuation">,</span> Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Vector3f<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">UnitX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>AngleAxisf <span class="token function">init_rotation_y</span><span class="token punctuation">(</span>current_pose_<span class="token punctuation">.</span>pitch<span class="token punctuation">,</span> Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Vector3f<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">UnitY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>AngleAxisf <span class="token function">init_rotation_z</span><span class="token punctuation">(</span>current_pose_<span class="token punctuation">.</span>yaw<span class="token punctuation">,</span> Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Vector3f<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">UnitZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置估计的guess_pose 用来配准</span>
  Eigen<span class="token punctuation">:</span><span class="token punctuation">:</span>Matrix4f init_guess <span class="token operator">=</span>
      <span class="token punctuation">(</span>init_translation <span class="token operator">*</span> init_rotation_z <span class="token operator">*</span> init_rotation_y <span class="token operator">*</span> init_rotation_x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> tf_btol_<span class="token punctuation">;</span> <span class="token comment">// 用于ndt配准的guess_pose,第一帧的默认是0</span>
  cout<span class="token operator">&lt;&lt;</span><span class="token string">"tf_btol_:\n"</span><span class="token operator">&lt;&lt;</span>tf_btol_<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
  cout<span class="token operator">&lt;&lt;</span><span class="token string">"init_guess:\n"</span><span class="token operator">&lt;&lt;</span>init_guess<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>   <span class="token comment">// 估计的初始值</span>

  <span class="token comment">// 配准后的输出点云</span>
  pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud<span class="token operator">&lt;</span>pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointXYZI<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">:</span>Ptr <span class="token function">output_cloud</span><span class="token punctuation">(</span>new pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud<span class="token operator">&lt;</span>pcl<span class="token punctuation">:</span><span class="token punctuation">:</span>PointXYZI<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ndt<span class="token punctuation">.</span><span class="token function">align</span><span class="token punctuation">(</span><span class="token operator">*</span>output_cloud<span class="token punctuation">,</span> init_guess<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 这个点云是经过下采样的,我们不使用</span>
  t_localizer <span class="token operator">=</span> ndt<span class="token punctuation">.</span><span class="token function">getFinalTransformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// source(scan) ---&gt; target(map_)的变换  source(scan 当前帧)相对于target(关键帧 map_)的位姿</span>
  cout<span class="token operator">&lt;&lt;</span><span class="token string">"t_localizer 当前帧相对于关键帧的位姿:\n"</span><span class="token operator">&lt;&lt;</span>t_localizer<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>

  t_base_link <span class="token operator">=</span> t_localizer <span class="token operator">*</span> tf_ltob_<span class="token punctuation">;</span>       <span class="token comment">// 当前帧(lidar)在base(map)下的pose</span>
  cout<span class="token operator">&lt;&lt;</span><span class="token string">"tf_ltob_: \n"</span><span class="token operator">&lt;&lt;</span>tf_ltob_<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
  cout<span class="token operator">&lt;&lt;</span><span class="token string">"t_base_link 是啥意思: \n"</span><span class="token operator">&lt;&lt;</span>t_base_link<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>

  <span class="token comment">// source(scan) 经过这个函数转换到target(map_) 坐标系下</span>
  pcl<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">transformPointCloud</span><span class="token punctuation">(</span><span class="token operator">*</span>scan_ptr<span class="token punctuation">,</span> <span class="token operator">*</span>transformed_scan_ptr<span class="token punctuation">,</span> t_localizer<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// t_localizer:当前帧相对于map的位姿,transformed_scan_ptr:当前帧变换到map中的点云</span>

  tf<span class="token punctuation">:</span><span class="token punctuation">:</span>Matrix3x3 mat_b<span class="token punctuation">;</span>      <span class="token comment">// t_base_link 的旋转矩阵</span>
  mat_b<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>static_cast<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">t_base_link</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> static_cast<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">t_base_link</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 static_cast<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">t_base_link</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> static_cast<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">t_base_link</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 static_cast<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">t_base_link</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> static_cast<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">t_base_link</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 static_cast<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">t_base_link</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> static_cast<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">t_base_link</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 static_cast<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">t_base_link</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 更新current_pose_.</span>
  <span class="token comment">// 更新当前pose</span>
  current_pose_<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">t_base_link</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>current_pose_<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token function">t_base_link</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>current_pose_<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token function">t_base_link</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 平移</span>
  mat_b<span class="token punctuation">.</span><span class="token function">getRPY</span><span class="token punctuation">(</span>current_pose_<span class="token punctuation">.</span>roll<span class="token punctuation">,</span> current_pose_<span class="token punctuation">.</span>pitch<span class="token punctuation">,</span> current_pose_<span class="token punctuation">.</span>yaw<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//mat2rpy  旋转</span>

  <span class="token comment">// current_pose_写入transform</span>
  transform<span class="token punctuation">.</span><span class="token function">setOrigin</span><span class="token punctuation">(</span>tf<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Vector3</span><span class="token punctuation">(</span>current_pose_<span class="token punctuation">.</span>x<span class="token punctuation">,</span> current_pose_<span class="token punctuation">.</span>y<span class="token punctuation">,</span> current_pose_<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// transform 设置平移</span>
  q<span class="token punctuation">.</span><span class="token function">setRPY</span><span class="token punctuation">(</span>current_pose_<span class="token punctuation">.</span>roll<span class="token punctuation">,</span> current_pose_<span class="token punctuation">.</span>pitch<span class="token punctuation">,</span> current_pose_<span class="token punctuation">.</span>yaw<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//q from rpy</span>
  transform<span class="token punctuation">.</span><span class="token function">setRotation</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//trans from q</span>

  <span class="token comment">// 发布map和rslidar之间的 transform</span>
  br_<span class="token punctuation">.</span><span class="token function">sendTransform</span><span class="token punctuation">(</span>tf<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">StampedTransform</span><span class="token punctuation">(</span>transform<span class="token punctuation">,</span> input<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>stamp<span class="token punctuation">,</span> <span class="token string">"/map"</span><span class="token punctuation">,</span> <span class="token string">"/rslidar"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// map---&gt;scan的transform</span>

  <span class="token comment">// 如果当前帧和上一帧的平移超过了min_add_scan_shift_,那么更新地图,并更新previous帧,更新target,发布地图</span>
  <span class="token comment">// .否则,previous帧不变</span>
  <span class="token keyword">double</span> shift <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">pow</span><span class="token punctuation">(</span>current_pose_<span class="token punctuation">.</span>x <span class="token operator">-</span> previous_pose_<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">pow</span><span class="token punctuation">(</span>current_pose_<span class="token punctuation">.</span>y <span class="token operator">-</span> previous_pose_<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shift <span class="token operator">&gt;=</span> min_add_scan_shift_<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    map_ <span class="token operator">+</span><span class="token operator">=</span> <span class="token operator">*</span>transformed_scan_ptr<span class="token punctuation">;</span>  <span class="token comment">// 更新地图</span>

    <span class="token comment">// 更新previous帧的位姿</span>
    previous_pose_<span class="token punctuation">.</span>x <span class="token operator">=</span> current_pose_<span class="token punctuation">.</span>x<span class="token punctuation">;</span>previous_pose_<span class="token punctuation">.</span>y <span class="token operator">=</span> current_pose_<span class="token punctuation">.</span>y<span class="token punctuation">;</span>previous_pose_<span class="token punctuation">.</span>z <span class="token operator">=</span> current_pose_<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
    previous_pose_<span class="token punctuation">.</span>roll <span class="token operator">=</span> current_pose_<span class="token punctuation">.</span>roll<span class="token punctuation">;</span>previous_pose_<span class="token punctuation">.</span>pitch <span class="token operator">=</span> current_pose_<span class="token punctuation">.</span>pitch<span class="token punctuation">;</span>previous_pose_<span class="token punctuation">.</span>yaw <span class="token operator">=</span> current_pose_<span class="token punctuation">.</span>yaw<span class="token punctuation">;</span>

    <span class="token comment">// 使用新的map_更新为target</span>
    ndt<span class="token punctuation">.</span><span class="token function">setInputTarget</span><span class="token punctuation">(</span>map_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发布地图</span>
    sensor_msgs<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud2<span class="token punctuation">:</span><span class="token punctuation">:</span>Ptr <span class="token function">map_msg_ptr</span><span class="token punctuation">(</span>new sensor_msgs<span class="token punctuation">:</span><span class="token punctuation">:</span>PointCloud2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pcl<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">toROSMsg</span><span class="token punctuation">(</span><span class="token operator">*</span>map_ptr<span class="token punctuation">,</span> <span class="token operator">*</span>map_msg_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ndt_map_pub_<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token operator">*</span>map_msg_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//sensor_msgs::PointCloud2::Ptr map_msg_ptr(new sensor_msgs::PointCloud2);</span>
  <span class="token comment">//pcl::toROSMsg(*map_ptr, *map_msg_ptr);</span>
  <span class="token comment">//ndt_map_pub_.publish(*map_msg_ptr);// it makes rviz very slow.</span>

  <span class="token comment">// 发布当前帧的pose</span>
  current_pose_msg_<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">"/map"</span><span class="token punctuation">;</span>   <span class="token comment">//  按理说只要发布了/map---&gt;rslidar的头tf_tree,这两个frame_id就能随便选择了 .但是</span>
  current_pose_msg_<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> input<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>stamp<span class="token punctuation">;</span>
  current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> current_pose_<span class="token punctuation">.</span>x<span class="token punctuation">;</span>current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> current_pose_<span class="token punctuation">.</span>y<span class="token punctuation">;</span>current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z <span class="token operator">=</span> current_pose_<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
  current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>x <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>y <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>z <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>current_pose_msg_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  current_pose_pub_<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>current_pose_msg_<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"-----------------------------------------------------------------"</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Sequence number: "</span> <span class="token operator">&lt;&lt;</span> input<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>seq <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Number of scan points: "</span> <span class="token operator">&lt;&lt;</span> scan_ptr<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" points."</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Number of filtered scan points: "</span> <span class="token operator">&lt;&lt;</span> filtered_scan_ptr<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" points."</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"transformed_scan_ptr: "</span> <span class="token operator">&lt;&lt;</span> transformed_scan_ptr<span class="token operator">-&gt;</span>points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" points."</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"map: "</span> <span class="token operator">&lt;&lt;</span> map_<span class="token punctuation">.</span>points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" points."</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span> <span class="token comment">// 一定是隔一段时间增加一下</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"NDT has converged: "</span> <span class="token operator">&lt;&lt;</span> ndt<span class="token punctuation">.</span><span class="token function">hasConverged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Fitness score: "</span> <span class="token operator">&lt;&lt;</span> ndt<span class="token punctuation">.</span><span class="token function">getFitnessScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Number of iteration: "</span> <span class="token operator">&lt;&lt;</span> ndt<span class="token punctuation">.</span><span class="token function">getFinalNumIteration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"(x,y,z,roll,pitch,yaw):"</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>          <span class="token comment">// 当前帧的pose</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"("</span> <span class="token operator">&lt;&lt;</span> current_pose_<span class="token punctuation">.</span>x <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> current_pose_<span class="token punctuation">.</span>y <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> current_pose_<span class="token punctuation">.</span>z <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> current_pose_<span class="token punctuation">.</span>roll
            <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> current_pose_<span class="token punctuation">.</span>pitch <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> current_pose_<span class="token punctuation">.</span>yaw <span class="token operator">&lt;&lt;</span> <span class="token string">")"</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Transformation Matrix:"</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> t_localizer <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>                        <span class="token comment">// 当前帧相对于map_的位姿</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"shift: "</span> <span class="token operator">&lt;&lt;</span> shift <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>               <span class="token comment">// 当前帧与之map_的距离</span>

  <span class="token comment">// 保存pcd文件</span>
  <span class="token comment">// pcl::io::savePCDFile (`/home/s/Dataset/pcd/ndt_map.pcd`, *map_ptr);</span>


  std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"-----------------------------------------------------------------"</span> <span class="token operator">&lt;&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/98e2c6694b70258726812fa462617315/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">c&#43;&#43;中double型的最大值和最小值</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/180f1ad0ae78003d3301ecadc7c2328d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux-hostname查看及修改</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>