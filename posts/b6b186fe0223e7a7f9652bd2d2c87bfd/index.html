<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ANR原理分析 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ANR原理分析" />
<meta property="og:description" content="ANR原理分析 造成ANR原因： InputDispatching Timeout：5秒内无法响应屏幕触摸事件或键盘输入事件
BroadcastQueue Timeout ：在执行前台广播（BroadcastReceiver）的onReceive()函数时10秒没有处理完成，后台为60秒。
Service Timeout ：前台服务20秒内，后台服务在200秒内没有执行完毕。
ContentProvider Timeout ：ContentProvider的publish在10s内没进行完。
避免 尽量不在主线程（UI线程）中做耗时操作
分析方法 log log中记录了ANR发生的时间以及具体提示。WaitingInMainSignalCatcherLoop代表了主线程等待异常。The application may be doing too much work on its main thread.同样表示处理时间过多。
traces 刚才的log有第二句Wrote stack traces to &#39;/data/anr/traces.txt&#39;，说明ANR异常已经输出到traces.txt文件，使用adb命令把这个文件从手机里导出来。
通过adb pull /data/anr/traces.txt将traces文件导出
----- pid 23346 at 2017-11-07 11:33:57 ----- ----&gt; 进程id和ANR产生时间 Cmd line: com.sky.myjavatest Build fingerprint: &#39;google/marlin/marlin:8.0.0/OPR3.170623.007/4286350:user/release-keys&#39; ABI: &#39;arm64&#39; Build type: optimized Zygote loaded classes=4681 post zygote classes=106 Intern table: 42675 strong; 137 weak JNI: CheckJNI is on; globals=526 (plus 22 weak) Libraries: /system/lib64/libandroid." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/b6b186fe0223e7a7f9652bd2d2c87bfd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-23T14:55:04+08:00" />
<meta property="article:modified_time" content="2021-11-23T14:55:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ANR原理分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="ANR_0"></a>ANR原理分析</h2> 
<p><img src="https://images2.imgbox.com/7e/3a/jRFPADDw_o.png" alt="img"></p> 
<h3><a id="ANR_6"></a>造成ANR原因：</h3> 
<p><strong>InputDispatching Timeout</strong>：5秒内无法响应屏幕触摸事件或键盘输入事件</p> 
<p><strong>BroadcastQueue Timeout</strong> ：在执行前台广播（BroadcastReceiver）的<code>onReceive()</code>函数时10秒没有处理完成，后台为60秒。</p> 
<p><strong>Service Timeout</strong> ：前台服务20秒内，后台服务在200秒内没有执行完毕。</p> 
<p><strong>ContentProvider Timeout</strong> ：ContentProvider的publish在10s内没进行完。</p> 
<h3><a id="_18"></a>避免</h3> 
<p>尽量不在主线程（UI线程）中做耗时操作</p> 
<h3><a id="_22"></a>分析方法</h3> 
<h4><a id="log_24"></a>log</h4> 
<p><img src="https://images2.imgbox.com/d8/79/q7CGv7km_o.png" alt="img"></p> 
<p>log中记录了ANR发生的时间以及具体提示。<code>WaitingInMainSignalCatcherLoop</code>代表了主线程等待异常。<code>The application may be doing too much work on its main thread.</code>同样表示处理时间过多。</p> 
<h4><a id="traces_30"></a>traces</h4> 
<p>刚才的log有第二句<code>Wrote stack traces to '/data/anr/traces.txt'</code>，说明ANR异常已经输出到<code>traces.txt</code>文件，使用adb命令把这个文件从手机里导出来。</p> 
<p>通过<code>adb pull /data/anr/traces.txt</code>将traces文件导出</p> 
<pre><code>----- pid 23346 at 2017-11-07 11:33:57 -----  ----&gt; 进程id和ANR产生时间
Cmd line: com.sky.myjavatest
Build fingerprint: 'google/marlin/marlin:8.0.0/OPR3.170623.007/4286350:user/release-keys'
ABI: 'arm64'
Build type: optimized
Zygote loaded classes=4681 post zygote classes=106
Intern table: 42675 strong; 137 weak
JNI: CheckJNI is on; globals=526 (plus 22 weak)
Libraries: /system/lib64/libandroid.so /system/lib64/libcompiler_rt.so 
/system/lib64/libjavacrypto.so
/system/lib64/libjnigraphics.so /system/lib64/libmedia_jni.so /system/lib64/libsoundpool.so
/system/lib64/libwebviewchromium_loader.so libjavacore.so libopenjdk.so (9)
Heap: 22% free, 1478KB/1896KB; 21881 objects    ----&gt; 内存使用情况

...

"main" prio=5 tid=1 Sleeping    ----&gt; 原因为Sleeping
  | group="main" sCount=1 dsCount=0 flags=1 obj=0x733d0670 self=0x74a4abea00
  | sysTid=23346 nice=-10 cgrp=default sched=0/0 handle=0x74a91ab9b0
  | state=S schedstat=( 391462128 82838177 354 ) utm=33 stm=4 core=3 HZ=100
  | stack=0x7fe6fac000-0x7fe6fae000 stackSize=8MB
  | held mutexes=
  at java.lang.Thread.sleep(Native method)
  - sleeping on &lt;0x053fd2c2&gt; (a java.lang.Object)
  at java.lang.Thread.sleep(Thread.java:373)
  - locked &lt;0x053fd2c2&gt; (a java.lang.Object)
  at java.lang.Thread.sleep(Thread.java:314)
  at android.os.SystemClock.sleep(SystemClock.java:122)
  at com.sky.myjavatest.ANRTestActivity.onCreate(ANRTestActivity.java:20) ----&gt; 产生ANR的包名以及具体行数
  at android.app.Activity.performCreate(Activity.java:6975)
  at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1213)
  at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2770)
  at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2892)
  at android.app.ActivityThread.-wrap11(ActivityThread.java:-1)
  at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1593)
  at android.os.Handler.dispatchMessage(Handler.java:105)
  at android.os.Looper.loop(Looper.java:164)
  at android.app.ActivityThread.main(ActivityThread.java:6541)
  at java.lang.reflect.Method.invoke(Native method)
  at com.android.internal.os.Zygote$MethodAndArgsCaller.run(Zygote.java:240)
  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:767)

</code></pre> 
<p>定位进程ID和包名：pid 23346<code></code>com.sky.myjavatest</p> 
<p>造成ANR原因：Sleeping</p> 
<p>具体行数：at com.sky.myjavatest.ANRTestActivity.onCreate(ANRTestActivity.java:20)</p> 
<p>如果<strong>产生新的ANR，原来的 traces.txt 文件会被覆盖。</strong></p> 
<h4><a id="Java_89"></a>Java线程调用分析</h4> 
<p>通过JDK提供的命令可以帮助分析和调试Java应用，命令为：<code>jstack {pid}</code></p> 
<p>其中pid可以通过jps命令获得，jps命令会列出当前系统中运行的所有Java虚拟机进程</p> 
<pre><code>103440 Jps
51400
</code></pre> 
<h4><a id="DDMSANR_100"></a>DDMS分析ANR问题</h4> 
<h4><a id="ANR_104"></a>造成ANR的原因</h4> 
<ul><li>主线程阻塞或主线程数据读取</li></ul> 
<blockquote> 
 <p>解决办法：避免死锁的出现，使用子线程来处理耗时操作或阻塞任务。尽量避免在主线程query provider、<a href="https://links.jianshu.com/go?to=http%3A%2F%2Fweishu.me%2F2016%2F10%2F13%2Fsharedpreference-advices%2F" rel="nofollow">不要滥用SharePreferenceS</a></p> 
</blockquote> 
<ul><li>CPU满负荷，I/O阻塞</li></ul> 
<blockquote> 
 <p>解决办法：文件读写或数据库操作放在子线程异步操作。</p> 
</blockquote> 
<ul><li>内存不足</li></ul> 
<blockquote> 
 <p>解决办法：<code>AndroidManifest.xml</code>文件中可以设置 <code>android:largeHeap="true"</code>，以此增大App使用内存。不过<strong>不建议使用此法</strong>，从根本上防止内存泄漏，优化内存使用才是正道。</p> 
</blockquote> 
<ul><li>各大组件ANR</li></ul> 
<blockquote> 
 <p>各大组件生命周期中也应避免耗时操作，注意BroadcastReciever的onRecieve()、后台Service和ContentProvider也不要执行太长时间的任务。</p> 
</blockquote> 
<h4><a id="ANR_124"></a>ANR源码分析</h4> 
<h5><a id="ServiceService_Timeout_126"></a><strong>Service</strong>造成的<strong>Service Timeout</strong></h5> 
<pre><code>Service Timeout是位于"ActivityManager"线程中的AMS.MainHandler收到SERVICE_TIMEOUT_MSG消息时触发。
</code></pre> 
<ol><li>发送延时消息</li></ol> 
<p><strong>Service</strong>进程attach到system_server进程的过程中会调用<code>realStartServiceLocked</code>，紧接着<code>mAm.mHandler.sendMessageAtTime()</code>来发送一个延时消息，延时的时常是定义好的，如前台<strong>Service</strong>的20秒。<strong>ActivityManager</strong>线程中的<strong>AMS.MainHandler</strong>收到<code>SERVICE_TIMEOUT_MSG</code>消息时会触发。</p> 
<p><strong>AS.realStartServiceLocked</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">realStartServiceLocked</span><span class="token punctuation">(</span><span class="token class-name">ServiceRecord</span> r<span class="token punctuation">,</span>
        <span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token keyword">boolean</span> execInFg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">//发送delay消息(SERVICE_TIMEOUT_MSG)</span>
    <span class="token function">bumpServiceExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> execInFg<span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//最终执行服务的onCreate()方法</span>
        app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleCreateService</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">,</span>
                mAm<span class="token punctuation">.</span><span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                app<span class="token punctuation">.</span>repProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DeadObjectException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mAm<span class="token punctuation">.</span><span class="token function">appDiedLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bumpServiceExecutingLocked</span><span class="token punctuation">(</span><span class="token class-name">ServiceRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fg<span class="token punctuation">,</span> <span class="token class-name">String</span> why<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
    <span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span><span class="token class-name">ProcessRecord</span> proc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> proc<span class="token punctuation">.</span>thread <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Message</span> msg <span class="token operator">=</span> mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>
            <span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span>SERVICE_TIMEOUT_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> proc<span class="token punctuation">;</span>

    <span class="token comment">//当超时后仍没有remove该SERVICE_TIMEOUT_MSG消息，则执行service Timeout流程</span>
    mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span>
        proc<span class="token punctuation">.</span>execServicesFg <span class="token operator">?</span> <span class="token punctuation">(</span>now<span class="token operator">+</span>SERVICE_TIMEOUT<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>now<span class="token operator">+</span> SERVICE_BACKGROUND_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<ol start="2"><li>进入目标进程的主线程创建Service</li></ol> 
<p><strong>经过Binder等层层调用进入目标进程的主线程 *<em>handleCreateService(CreateServiceData data)*</em>。</strong></p> 
<pre><code class="prism language-java">   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleCreateService</span><span class="token punctuation">(</span><span class="token class-name">CreateServiceData</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span> cl <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Service</span> service <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Service</span><span class="token punctuation">)</span> cl<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//创建ContextImpl对象</span>
            <span class="token class-name">ContextImpl</span> context <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> packageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//创建Application对象</span>
            <span class="token class-name">Application</span> app <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mInstrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">,</span> data<span class="token punctuation">.</span>token<span class="token punctuation">,</span> app<span class="token punctuation">,</span>
                    <span class="token class-name">ActivityManagerNative</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//调用服务onCreate()方法 </span>
            service<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//取消AMS.MainHandler的延时消息</span>
            <span class="token class-name">ActivityManagerNative</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serviceDoneExecuting</span><span class="token punctuation">(</span>
                    data<span class="token punctuation">.</span>token<span class="token punctuation">,</span> SERVICE_DONE_EXECUTING_ANON<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>这个方法中会创建目标服务对象，以及回调常用的<strong>Service</strong>的<code>onCreate()</code>方法，紧接着通过<code>serviceDoneExecuting()</code>回到system_server执行取消AMS.MainHandler的延时消息。</p> 
<ol start="3"><li>回到system_server执行取消AMS.MainHandler的延时消息</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span><span class="token class-name">ServiceRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> inDestroying<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> finishing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>executeNesting <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//当前服务所在进程中没有正在执行的service</span>
                mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span>SERVICE_TIMEOUT_MSG<span class="token punctuation">,</span> r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>此方法中Service逻辑处理完成则移除之前延时的消息<code>SERVICE_TIMEOUT_MSG</code>。如果没有执行完毕不调用这个方法，则超时后会发出<code>SERVICE_TIMEOUT_MSG</code>来告知ANR发生。</p> 
<h5><a id="BroadcastReceiverBroadcastQueue_Timeout_242"></a><strong>BroadcastReceiver</strong>造成的BroadcastQueue Timeout</h5> 
<blockquote> 
 <p><strong>BroadcastReceiver Timeout</strong>是位于**“ActivityManager”**线程中的BroadcastQueue.BroadcastHandler收到<code>BROADCAST_TIMEOUT_MSG</code>消息时触发。</p> 
</blockquote> 
<ol><li>处理广播函数 processNextBroadcast() 中 broadcastTimeoutLocked(false) 发送延时消息</li></ol> 
<pre><code class="prism language-java"><span class="token comment">//广播处理顺序为先处理并行广播，再处理当前有序广播。</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 处理当前有序广播</span>
        <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
            r <span class="token operator">=</span> mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取所有该广播所有的接收者</span>
            <span class="token keyword">int</span> numReceivers <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mProcessesReady <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numReceivers <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                        <span class="token punctuation">(</span>now <span class="token operator">&gt;</span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>mTimeoutPeriod<span class="token operator">*</span>numReceivers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//step 1\. 发送延时消息，这个函数处理了很多事情，比如广播处理超时结束广播</span>
                    <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> r<span class="token punctuation">.</span>nextReceiver <span class="token operator">&gt;=</span> numReceivers
                    <span class="token operator">||</span> r<span class="token punctuation">.</span>resultAbort <span class="token operator">||</span> forceReceive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>resultTo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//2\. 处理广播消息消息</span>
                    <span class="token function">performReceiveLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>callerApp<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultTo<span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>resultTo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//3\. 取消广播超时ANR消息</span>
                <span class="token function">cancelBroadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// 获取下条有序广播</span>
        r<span class="token punctuation">.</span>receiverTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingBroadcastTimeoutMessage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">long</span> timeoutTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime <span class="token operator">+</span> mTimeoutPeriod<span class="token punctuation">;</span>
            <span class="token comment">//设置广播超时</span>
            <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>上文的step 1. broadcastTimeoutLocked(false)函数：记录时间信息并调用函数设置发送延时消息</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mDidDexOpt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Delay timeouts until dexopt finishes.</span>
                mService<span class="token punctuation">.</span>mDidDexOpt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> timeoutTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> mTimeoutPeriod<span class="token punctuation">;</span>
                <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mService<span class="token punctuation">.</span>mProcessesReady<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">long</span> timeoutTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime <span class="token operator">+</span> mTimeoutPeriod<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutTime <span class="token operator">&gt;</span> now<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// step 2</span>
                <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

</code></pre> 
<p><strong>上文的step 2.setBroadcastTimeoutLocked函数： 设置广播超时具体操作，同样是发送延时消息</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> mPendingBroadcastTimeoutMessage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Message</span> msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>BROADCAST_TIMEOUT_MSG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHandler<span class="token punctuation">.</span><span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPendingBroadcastTimeoutMessage <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="ContentProviderContentProvider_Timeout_338"></a>ContentProvider的ContentProvider Timeout</h5> 
<blockquote> 
 <p>ContentProvider Timeout是位于”ActivityManager”线程中的AMS.MainHandler收到CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG消息时触发。</p> 
</blockquote> 
<p>mHandler.obtainMessage(BROADCAST_TIMEOUT_MSG, this);<br> mHandler.sendMessageAtTime(msg, timeoutTime);<br> mPendingBroadcastTimeoutMessage = true;<br> }<br> }</p> 
<pre><code>


####  ContentProvider的ContentProvider Timeout

&gt; ContentProvider Timeout是位于”ActivityManager”线程中的AMS.MainHandler收到CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG消息时触发。

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/56b7caa0281888c7ed1833105587a0d7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">2. 科研绘图之 matplotlib 图形窗口</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/36b09cc1c38c3f00c26ee71296f8e03d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">onlyoffice aarch64编译</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>