<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s集群部署Prometheus和Grafana - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s集群部署Prometheus和Grafana" />
<meta property="og:description" content="一、部署nfs-client-provisioner 参考https://zhaoll.blog.csdn.net/article/details/128155767
二、部署prometheus 创建pvc
apiVersion: v1 kind: PersistentVolumeClaim metadata: name: prometheus-data namespace: devops annotations: volume.beta.kubernetes.io/storage-provisioner: master-nfs-storage spec: accessModes: - ReadWriteOnce resources: requests: storage: 1Gi storageClassName: master-nfs-storage --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: prometheus-rules-data namespace: devops annotations: volume.beta.kubernetes.io/storage-provisioner: master-nfs-storage spec: accessModes: - ReadWriteOnce resources: requests: storage: 1Gi storageClassName: master-nfs-storage 创建RBAC
apiVersion: v1 kind: ServiceAccount metadata: name: prometheus namespace: devops labels: kubernetes.io/cluster-service: &#34;true&#34; addonmanager.kubernetes.io/mode: Reconcile --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: prometheus labels: kubernetes." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/06915c70f051f71167e5a77237443f38/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-06T23:34:42+08:00" />
<meta property="article:modified_time" content="2023-07-06T23:34:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s集群部署Prometheus和Grafana</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="nfsclientprovisioner_0"></a>一、部署nfs-client-provisioner</h3> 
<p>参考https://zhaoll.blog.csdn.net/article/details/128155767</p> 
<h3><a id="prometheus_4"></a>二、部署prometheus</h3> 
<p>创建pvc</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: prometheus-<span class="token keyword">data</span>
  namespace: devops
  annotations:
    volume<span class="token punctuation">.</span>beta<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/storage-provisioner: master-nfs-storage
spec:
  accessModes:
    <span class="token operator">-</span> ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: master-nfs-storage
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: prometheus-rules-<span class="token keyword">data</span>
  namespace: devops
  annotations:
    volume<span class="token punctuation">.</span>beta<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/storage-provisioner: master-nfs-storage
spec:
  accessModes:
    <span class="token operator">-</span> ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: master-nfs-storage

</code></pre> 
<p>创建RBAC</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: devops
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: ClusterRole
metadata:
  name: prometheus
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
rules:
  <span class="token operator">-</span> apiGroups:
      <span class="token operator">-</span> <span class="token string">""</span>
    resources:
      <span class="token operator">-</span> nodes
      <span class="token operator">-</span> nodes/metrics
      <span class="token operator">-</span> services
      <span class="token operator">-</span> endpoints
      <span class="token operator">-</span> pods
    verbs:
      <span class="token operator">-</span> get
      <span class="token operator">-</span> list
      <span class="token operator">-</span> watch
  <span class="token operator">-</span> apiGroups:
      <span class="token operator">-</span> <span class="token string">""</span>
    resources:
      <span class="token operator">-</span> configmaps
    verbs:
      <span class="token operator">-</span> get
  <span class="token operator">-</span> nonResourceURLs:
      <span class="token operator">-</span> <span class="token string">"/metrics"</span>
    verbs:
      <span class="token operator">-</span> get
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
roleRef:
  apiGroup: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io
  kind: ClusterRole
  name: cluster-admin
subjects:
<span class="token operator">-</span> kind: ServiceAccount
  name: prometheus
  namespace: devops

</code></pre> 
<p>创建Prometheus的configmap，也就是配置文件</p> 
<pre><code class="prism language-powershell"><span class="token comment"># Prometheus configuration format https://prometheus.io/docs/prometheus/latest/configuration/configuration/</span>
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: devops
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: EnsureExists
<span class="token keyword">data</span>:
  prometheus<span class="token punctuation">.</span>yml: <span class="token punctuation">|</span>
    global:
      scrape_interval:     15s <span class="token comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span>
      evaluation_interval: 15s <span class="token comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span>

    rule_files:          <span class="token comment">#prometheus配置告警规则</span>
    <span class="token operator">-</span> <span class="token string">"rules/*.yml"</span>

    scrape_configs:
    <span class="token operator">-</span> job_name: prometheus    <span class="token comment">#监控prometheus本身</span>
      static_configs:
      <span class="token operator">-</span> targets:
        <span class="token operator">-</span> localhost:9090

    <span class="token operator">-</span> job_name: k8s-master   <span class="token comment">#写要监控的node节点</span>
      static_configs:
      <span class="token operator">-</span> targets:
        <span class="token operator">-</span> 11<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>3:9100
        <span class="token operator">-</span> 11<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>4:9100
        <span class="token operator">-</span> 11<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>5:9100


    <span class="token operator">-</span> job_name: k8s-node   <span class="token comment">#写要监控的node节点</span>
      static_configs:
      <span class="token operator">-</span> targets:
        <span class="token operator">-</span> 11<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>6:9100
        <span class="token operator">-</span> 11<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>7:9100

    <span class="token comment"># kubernetes-apiservers自动发现，将apiserver的地址进行暴露并获取监控指标</span>
    <span class="token operator">-</span> job_name: kubernetes-apiservers
      kubernetes_sd_configs:
      <span class="token operator">-</span> role: endpoints
      relabel_configs:
      <span class="token operator">-</span> action: keep
        regex: default<span class="token punctuation">;</span>kubernetes<span class="token punctuation">;</span>https
        source_labels:
        <span class="token operator">-</span> __meta_kubernetes_namespace
        <span class="token operator">-</span> __meta_kubernetes_service_name
        <span class="token operator">-</span> __meta_kubernetes_endpoint_port_name
      scheme: https
      tls_config:
        ca_file: <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/secrets/kubernetes<span class="token punctuation">.</span>io/serviceaccount/ca<span class="token punctuation">.</span>crt
        insecure_skip_verify: true
      bearer_token_file: <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/secrets/kubernetes<span class="token punctuation">.</span>io/serviceaccount/token

    <span class="token operator">-</span> job_name: kubernetes-nodes-kubelet
      kubernetes_sd_configs:
      <span class="token operator">-</span> role: node
      relabel_configs:
      <span class="token operator">-</span> action: labelmap
        regex: __meta_kubernetes_node_label_<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">)</span>
      scheme: https
      tls_config:
        ca_file: <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/secrets/kubernetes<span class="token punctuation">.</span>io/serviceaccount/ca<span class="token punctuation">.</span>crt
        insecure_skip_verify: true
      bearer_token_file: <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/secrets/kubernetes<span class="token punctuation">.</span>io/serviceaccount/token

        <span class="token comment"># k8s的node节点自动发现，自动发现k8s中的所有node节点并进行监控</span>
    <span class="token operator">-</span> job_name: kubernetes-nodes-cadvisor
      kubernetes_sd_configs:
      <span class="token operator">-</span> role: node
      relabel_configs:
      <span class="token operator">-</span> action: labelmap
        regex: __meta_kubernetes_node_label_<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">)</span>
      <span class="token operator">-</span> target_label: __metrics_path__
        replacement: <span class="token operator">/</span>metrics/cadvisor
      scheme: https
      tls_config:
        ca_file: <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/secrets/kubernetes<span class="token punctuation">.</span>io/serviceaccount/ca<span class="token punctuation">.</span>crt
        insecure_skip_verify: true
      bearer_token_file: <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/secrets/kubernetes<span class="token punctuation">.</span>io/serviceaccount/token

        <span class="token comment"># 发现endpoint的资源，主要是发现endpoint资源类型的pod，可以通过kubectl get ep查看谁是endpoint资源</span>
    <span class="token operator">-</span> job_name: kubernetes-service-endpoints
      kubernetes_sd_configs:
      <span class="token operator">-</span> role: endpoints
      relabel_configs:
      <span class="token operator">-</span> action: keep
        regex: true
        source_labels:
        <span class="token operator">-</span> __meta_kubernetes_service_annotation_prometheus_io_scrape
      <span class="token operator">-</span> action: replace
        regex: <span class="token punctuation">(</span>https?<span class="token punctuation">)</span>
        source_labels:
        <span class="token operator">-</span> __meta_kubernetes_service_annotation_prometheus_io_scheme
        target_label: __scheme__
      <span class="token operator">-</span> action: replace
        regex: <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">)</span>
        source_labels:
        <span class="token operator">-</span> __meta_kubernetes_service_annotation_prometheus_io_path
        target_label: __metrics_path__
      <span class="token operator">-</span> action: replace
        regex: <span class="token punctuation">(</span><span class="token punctuation">[</span>^:<span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">)</span><span class="token punctuation">(</span>?::\d+<span class="token punctuation">)</span>?<span class="token punctuation">;</span><span class="token punctuation">(</span>\d+<span class="token punctuation">)</span>
        replacement: <span class="token variable">$1</span>:<span class="token variable">$2</span>
        source_labels:
        <span class="token operator">-</span> __address__
        <span class="token operator">-</span> __meta_kubernetes_service_annotation_prometheus_io_port
        target_label: __address__
      <span class="token operator">-</span> action: labelmap
        regex: __meta_kubernetes_service_label_<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">)</span>
      <span class="token operator">-</span> action: replace
        source_labels:
        <span class="token operator">-</span> __meta_kubernetes_namespace
        target_label: kubernetes_namespace
      <span class="token operator">-</span> action: replace
        source_labels:
        <span class="token operator">-</span> __meta_kubernetes_service_name
        target_label: kubernetes_name

        <span class="token comment"># 自动发现services资源</span>
    <span class="token operator">-</span> job_name: kubernetes-services
      kubernetes_sd_configs:
      <span class="token operator">-</span> role: service
      metrics_path: <span class="token operator">/</span>probe
      params:
        module:
        <span class="token operator">-</span> http_2xx
      relabel_configs:
      <span class="token operator">-</span> action: keep
        regex: true
        source_labels:
        <span class="token operator">-</span> __meta_kubernetes_service_annotation_prometheus_io_probe
      <span class="token operator">-</span> source_labels:
        <span class="token operator">-</span> __address__
        target_label: __param_target
      <span class="token operator">-</span> replacement: blackbox
        target_label: __address__
      <span class="token operator">-</span> source_labels:
        <span class="token operator">-</span> __param_target
        target_label: instance
      <span class="token operator">-</span> action: labelmap
        regex: __meta_kubernetes_service_label_<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">)</span>
      <span class="token operator">-</span> source_labels:
        <span class="token operator">-</span> __meta_kubernetes_namespace
        target_label: kubernetes_namespace
      <span class="token operator">-</span> source_labels:
        <span class="token operator">-</span> __meta_kubernetes_service_name
        target_label: kubernetes_name

        <span class="token comment">#自动发现pod资源</span>
    <span class="token operator">-</span> job_name: kubernetes-pods
      kubernetes_sd_configs:
      <span class="token operator">-</span> role: pod
      relabel_configs:
      <span class="token operator">-</span> action: keep
        regex: true
        source_labels:
        <span class="token operator">-</span> __meta_kubernetes_pod_annotation_prometheus_io_scrape
      <span class="token operator">-</span> action: replace
        regex: <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">)</span>
        source_labels:
        <span class="token operator">-</span> __meta_kubernetes_pod_annotation_prometheus_io_path
        target_label: __metrics_path__
      <span class="token operator">-</span> action: replace
        regex: <span class="token punctuation">(</span><span class="token punctuation">[</span>^:<span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">)</span><span class="token punctuation">(</span>?::\d+<span class="token punctuation">)</span>?<span class="token punctuation">;</span><span class="token punctuation">(</span>\d+<span class="token punctuation">)</span>
        replacement: <span class="token variable">$1</span>:<span class="token variable">$2</span>
        source_labels:
        <span class="token operator">-</span> __address__
        <span class="token operator">-</span> __meta_kubernetes_pod_annotation_prometheus_io_port
        target_label: __address__
      <span class="token operator">-</span> action: labelmap
        regex: __meta_kubernetes_pod_label_<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">)</span>
      <span class="token operator">-</span> action: replace
        source_labels:
        <span class="token operator">-</span> __meta_kubernetes_namespace
        target_label: kubernetes_namespace
      <span class="token operator">-</span> action: replace
        source_labels:
        <span class="token operator">-</span> __meta_kubernetes_pod_name
        target_label: kubernetes_pod_name

</code></pre> 
<p>创建Prometheus的sts和svc</p> 
<pre><code class="prism language-powershell">apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: prometheus
  namespace: devops
  labels:
    k8s-app: prometheus
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
    version: v2<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1
spec:
  serviceName: <span class="token string">"prometheus"</span>
  replicas: 1
  podManagementPolicy: <span class="token string">"Parallel"</span>
  updateStrategy:
   <span class="token function">type</span>: <span class="token string">"RollingUpdate"</span>
  selector:
    matchLabels:
      k8s-app: prometheus
  template:
    metadata:
      labels:
        k8s-app: prometheus
    spec:
      priorityClassName: system-cluster-critical
      serviceAccountName: prometheus
      initContainers:
      <span class="token operator">-</span> name: <span class="token string">"init-chown-data"</span>
        image: <span class="token string">"busybox:latest"</span>
        imagePullPolicy: <span class="token string">"IfNotPresent"</span>
        command: <span class="token punctuation">[</span><span class="token string">"chown"</span><span class="token punctuation">,</span> <span class="token string">"-R"</span><span class="token punctuation">,</span> <span class="token string">"65534:65534"</span><span class="token punctuation">,</span> <span class="token string">"/data"</span><span class="token punctuation">]</span>
        volumeMounts:
        <span class="token operator">-</span> name: prometheus-<span class="token keyword">data</span>
          mountPath: <span class="token operator">/</span><span class="token keyword">data</span>
          subPath: <span class="token string">""</span>
      containers:
        <span class="token operator">-</span> name: prometheus-server-configmap-reload
          image: <span class="token string">"jimmidyson/configmap-reload:v0.1"</span>
          imagePullPolicy: <span class="token string">"IfNotPresent"</span>
          args:
            <span class="token operator">-</span> <span class="token operator">--</span>volume-<span class="token function">dir</span>=<span class="token operator">/</span>etc/config
            <span class="token operator">-</span> <span class="token operator">--</span>webhook-url=http:<span class="token operator">/</span><span class="token operator">/</span>localhost:9090/<span class="token operator">-</span><span class="token operator">/</span>reload
          volumeMounts:
            <span class="token operator">-</span> name: config-volume
              mountPath: <span class="token operator">/</span>etc/config
              readOnly: true

        <span class="token operator">-</span> name: prometheus-server
          image: <span class="token string">"prom/prometheus:v2.23.0"</span>
          imagePullPolicy: <span class="token string">"IfNotPresent"</span>
          args:
            <span class="token operator">-</span> <span class="token operator">--</span>config<span class="token punctuation">.</span>file=<span class="token operator">/</span>etc/config/prometheus<span class="token punctuation">.</span>yml
            <span class="token operator">-</span> <span class="token operator">--</span>storage<span class="token punctuation">.</span>tsdb<span class="token punctuation">.</span>path=<span class="token operator">/</span><span class="token keyword">data</span>
            <span class="token operator">-</span> <span class="token operator">--</span>web<span class="token punctuation">.</span>console<span class="token punctuation">.</span>libraries=<span class="token operator">/</span>etc/prometheus/console_libraries
            <span class="token operator">-</span> <span class="token operator">--</span>web<span class="token punctuation">.</span>console<span class="token punctuation">.</span>templates=<span class="token operator">/</span>etc/prometheus/consoles
            <span class="token operator">-</span> <span class="token operator">--</span>web<span class="token punctuation">.</span><span class="token function">enable-lifecycle</span>
          ports:
            <span class="token operator">-</span> containerPort: 9090
          readinessProbe:
            httpGet:
              path: <span class="token operator">/</span><span class="token operator">-</span><span class="token operator">/</span>ready
              port: 9090
            initialDelaySeconds: 30
            timeoutSeconds: 30
          livenessProbe:
            httpGet:
              path: <span class="token operator">/</span><span class="token operator">-</span><span class="token operator">/</span>healthy
              port: 9090
            initialDelaySeconds: 30
            timeoutSeconds: 30
          <span class="token comment"># based on 10 running nodes with 30 pods each</span>

          volumeMounts:
            <span class="token operator">-</span> name: prometheus-rules
              mountPath: <span class="token operator">/</span>etc/config/rules
            <span class="token operator">-</span> name: config-volume
              mountPath: <span class="token operator">/</span>etc/config
            <span class="token operator">-</span> name: prometheus-<span class="token keyword">data</span>
              mountPath: <span class="token operator">/</span><span class="token keyword">data</span>
              subPath: <span class="token string">""</span>
      terminationGracePeriodSeconds: 300
      volumes:
        <span class="token operator">-</span> name: config-volume
          configMap:
            name: prometheus-config
        <span class="token operator">-</span> name: prometheus-<span class="token keyword">data</span>
          persistentVolumeClaim:
            claimName: prometheus-<span class="token keyword">data</span>
        <span class="token operator">-</span> name: prometheus-rules
          persistentVolumeClaim:
            claimName: prometheus-rules-<span class="token keyword">data</span>
<span class="token operator">--</span><span class="token operator">-</span>
kind: Service
apiVersion: v1
metadata:
  name: prometheus
  namespace: devops
  labels:
    kubernetes<span class="token punctuation">.</span>io/name: <span class="token string">"Prometheus"</span>
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
spec:
  <span class="token function">type</span>: NodePort
  ports:
    <span class="token operator">-</span> name: http
      port: 9090
      protocol: TCP
      targetPort: 9090
      nodePort: 30090
  selector:
    k8s-app: prometheus

</code></pre> 
<h3><a id="metrics_402"></a>三、部署metrics</h3> 
<p>metrics文件</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-state-metrics
  namespace: kube-system
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: ClusterRole
metadata:
  name: kube-state-metrics
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
rules:
<span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
  resources:
  <span class="token operator">-</span> configmaps
  <span class="token operator">-</span> secrets
  <span class="token operator">-</span> nodes
  <span class="token operator">-</span> pods
  <span class="token operator">-</span> services
  <span class="token operator">-</span> resourcequotas
  <span class="token operator">-</span> replicationcontrollers
  <span class="token operator">-</span> limitranges
  <span class="token operator">-</span> persistentvolumeclaims
  <span class="token operator">-</span> persistentvolumes
  <span class="token operator">-</span> namespaces
  <span class="token operator">-</span> endpoints
  verbs: <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
<span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">"extensions"</span><span class="token punctuation">,</span><span class="token string">"apps"</span><span class="token punctuation">]</span>
  resources:
  <span class="token operator">-</span> daemonsets
  <span class="token operator">-</span> deployments
  <span class="token operator">-</span> replicasets
  verbs: <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
<span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">"apps"</span><span class="token punctuation">]</span>
  resources:
  <span class="token operator">-</span> statefulsets
  verbs: <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
<span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">"batch"</span><span class="token punctuation">]</span>
  resources:
  <span class="token operator">-</span> cronjobs
  <span class="token operator">-</span> jobs
  verbs: <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
<span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">"autoscaling"</span><span class="token punctuation">]</span>
  resources:
  <span class="token operator">-</span> horizontalpodautoscalers
  verbs: <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: Role
metadata:
  name: kube-state-metrics-resizer
  namespace: kube-system
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
rules:
<span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
  resources:
  <span class="token operator">-</span> pods
  verbs: <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">]</span>
<span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">"extensions"</span><span class="token punctuation">,</span><span class="token string">"apps"</span><span class="token punctuation">]</span>
  resources:
  <span class="token operator">-</span> deployments
  resourceNames: <span class="token punctuation">[</span><span class="token string">"kube-state-metrics"</span><span class="token punctuation">]</span>
  verbs: <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: ClusterRoleBinding
metadata:
  name: kube-state-metrics
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
roleRef:
  apiGroup: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io
  kind: ClusterRole
  name: kube-state-metrics
subjects:
<span class="token operator">-</span> kind: ServiceAccount
  name: kube-state-metrics
  namespace: kube-system
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: RoleBinding
metadata:
  name: kube-state-metrics
  namespace: kube-system
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
roleRef:
  apiGroup: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io
  kind: Role
  name: kube-state-metrics-resizer
subjects:
<span class="token operator">-</span> kind: ServiceAccount
  name: kube-state-metrics
  namespace: kube-system
<span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment"># Config map for resource configuration.</span>
apiVersion: v1
kind: ConfigMap
metadata:
  name: kube-state-metrics-config
  namespace: kube-system
  labels:
    k8s-app: kube-state-metrics
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
<span class="token keyword">data</span>:
  NannyConfiguration: <span class="token punctuation">|</span><span class="token operator">-</span>
    apiVersion: nannyconfig/v1alpha1
    kind: NannyConfiguration
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kube-state-metrics
  namespace: kube-system
  labels:
    k8s-app: kube-state-metrics
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
spec:
  selector:
    matchLabels:
      k8s-app: kube-state-metrics
  replicas: 1
  template:
    metadata:
      labels:
        k8s-app: kube-state-metrics
    spec:
      priorityClassName: system-cluster-critical
      serviceAccountName: kube-state-metrics
      containers:
      <span class="token operator">-</span> name: kube-state-metrics
        image: quay<span class="token punctuation">.</span>io/coreos/kube-state-metrics:v1<span class="token punctuation">.</span>8<span class="token punctuation">.</span>0
        ports:
        <span class="token operator">-</span> name: http-metrics
          containerPort: 8080
        <span class="token operator">-</span> name: telemetry
          containerPort: 8081
        readinessProbe:
          httpGet:
            path: <span class="token operator">/</span>healthz
            port: 8080
          initialDelaySeconds: 5
          timeoutSeconds: 5
      <span class="token operator">-</span> name: addon-resizer
        image: registry<span class="token punctuation">.</span>cn-hangzhou<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com/rookieops/addon-resizer:1<span class="token punctuation">.</span>8<span class="token punctuation">.</span>6
        resources:
          limits:
            cpu: 100m
            memory: 30Mi
          requests:
            cpu: 100m
            memory: 30Mi
        env:
          <span class="token operator">-</span> name: MY_POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata<span class="token punctuation">.</span>name
          <span class="token operator">-</span> name: MY_POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata<span class="token punctuation">.</span>namespace
        volumeMounts:
          <span class="token operator">-</span> name: config-volume
            mountPath: <span class="token operator">/</span>etc/config
        command:
          <span class="token operator">-</span> <span class="token operator">/</span>pod_nanny
          <span class="token operator">-</span> <span class="token operator">--</span>config-<span class="token function">dir</span>=<span class="token operator">/</span>etc/config
          <span class="token operator">-</span> <span class="token operator">--</span>container=kube-state-metrics
          <span class="token operator">-</span> <span class="token operator">--</span>cpu=100m
          <span class="token operator">-</span> <span class="token operator">--</span>extra-cpu=1m
          <span class="token operator">-</span> <span class="token operator">--</span>memory=100Mi
          <span class="token operator">-</span> <span class="token operator">--</span>extra-memory=2Mi
          <span class="token operator">-</span> <span class="token operator">--</span>threshold=5
          <span class="token operator">-</span> <span class="token operator">--</span>deployment=kube-state-metrics
      volumes:
        <span class="token operator">-</span> name: config-volume
          configMap:
            name: kube-state-metrics-config
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: kube-state-metrics
  namespace: kube-system
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
    kubernetes<span class="token punctuation">.</span>io/name: <span class="token string">"kube-state-metrics"</span>
  annotations:
    prometheus<span class="token punctuation">.</span>io/scrape: <span class="token string">'true'</span>
spec:
  ports:
  <span class="token operator">-</span> name: http-metrics
    port: 8080
    targetPort: http-metrics
    protocol: TCP
  <span class="token operator">-</span> name: telemetry
    port: 8081
    targetPort: telemetry
    protocol: TCP
  selector:
    k8s-app: kube-state-metrics

</code></pre> 
<p>四、部署node_exporter</p> 
<pre><code class="prism language-powershell">apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-exporter
  namespace: devops
  labels:
    app: node-exporter
spec:
  selector:
    matchLabels:
     app: node-exporter
  template:
    metadata:
      labels:
        app: node-exporter
    spec:
      hostPID: true
      hostIPC: true
      hostNetwork: true
      containers:
      <span class="token operator">-</span> name: node-exporter
        image: quay<span class="token punctuation">.</span>io/prometheus/node-exporter
        ports:
        <span class="token operator">-</span> containerPort: 9100
          hostPort: 9100
        securityContext:
          privileged: true
        args:
        <span class="token operator">-</span> <span class="token operator">--</span>path<span class="token punctuation">.</span>procfs
        <span class="token operator">-</span> <span class="token operator">/</span>host/proc
        <span class="token operator">-</span> <span class="token operator">--</span>path<span class="token punctuation">.</span>sysfs
        <span class="token operator">-</span> <span class="token operator">/</span>host/sys
        <span class="token operator">-</span> <span class="token operator">--</span>path<span class="token punctuation">.</span>rootfs
        <span class="token operator">-</span> <span class="token operator">/</span>host/root
        <span class="token operator">-</span> <span class="token operator">--</span>collector<span class="token punctuation">.</span>filesystem<span class="token punctuation">.</span>ignored-<span class="token function">mount</span><span class="token operator">-</span>points
        <span class="token operator">-</span> <span class="token string">'"^/(sys|proc|dev|host|etc)($|/)"'</span>
        <span class="token operator">-</span> <span class="token string">"--collector.processes"</span>
        volumeMounts:
        <span class="token operator">-</span> name: dev
          mountPath: <span class="token operator">/</span>host/dev
        <span class="token operator">-</span> name: proc
          mountPath: <span class="token operator">/</span>host/proc
        <span class="token operator">-</span> name: sys
          mountPath: <span class="token operator">/</span>host/sys
        <span class="token operator">-</span> name: rootfs
          mountPath: <span class="token operator">/</span>host/root
      tolerations:
      <span class="token operator">-</span> key: <span class="token string">"node-role.kubernetes.io/master"</span>
        operator: <span class="token string">"Exists"</span>
        effect: <span class="token string">"NoSchedule"</span>
      volumes:
        <span class="token operator">-</span> name: proc
          hostPath:
            path: <span class="token operator">/</span>proc
        <span class="token operator">-</span> name: dev
          hostPath:
            path: <span class="token operator">/</span>dev
        <span class="token operator">-</span> name: sys
          hostPath:
            path: <span class="token operator">/</span>sys
        <span class="token operator">-</span> name: rootfs
          hostPath:
            path: <span class="token operator">/</span>

</code></pre> 
<h3><a id="grafana_690"></a>五、部署grafana</h3> 
<p>创建pvc</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-ui-<span class="token keyword">data</span>
  namespace: devops
  annotations:
    volume<span class="token punctuation">.</span>beta<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/storage-provisioner: master-nfs-storage
spec:
  accessModes:
    <span class="token operator">-</span> ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: master-nfs-storage

</code></pre> 
<p>创建RBAC</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: ServiceAccount
metadata:
  name: grafana
  namespace: devops
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: ClusterRole
metadata:
  name: grafana
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
rules:
  <span class="token operator">-</span> apiGroups:
      <span class="token operator">-</span> <span class="token string">""</span>
    resources:
      <span class="token operator">-</span> nodes
      <span class="token operator">-</span> nodes/metrics
      <span class="token operator">-</span> services
      <span class="token operator">-</span> endpoints
      <span class="token operator">-</span> pods
    verbs:
      <span class="token operator">-</span> get
      <span class="token operator">-</span> list
      <span class="token operator">-</span> watch
  <span class="token operator">-</span> apiGroups:
      <span class="token operator">-</span> <span class="token string">""</span>
    resources:
      <span class="token operator">-</span> configmaps
    verbs:
      <span class="token operator">-</span> get
  <span class="token operator">-</span> nonResourceURLs:
      <span class="token operator">-</span> <span class="token string">"/metrics"</span>
    verbs:
      <span class="token operator">-</span> get
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: ClusterRoleBinding
metadata:
  name: grafana
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
roleRef:
  apiGroup: rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io
  kind: ClusterRole
  name: cluster-admin
subjects:
<span class="token operator">-</span> kind: ServiceAccount
  name: grafana
  namespace: devops

</code></pre> 
<p>创建sts和svc：</p> 
<pre><code class="prism language-powershell">apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: grafana-ui
  namespace: devops
spec:
  serviceName: <span class="token string">"grafana"</span>
  replicas: 1
  selector:
    matchLabels:
      app: grafana-ui
  template:
    metadata:
      labels:
        app: grafana-ui
    spec:
      containers:
      <span class="token operator">-</span> name: grafana-ui
        image: grafana/grafana:latest
        imagePullPolicy: <span class="token string">"IfNotPresent"</span>
        ports:
          <span class="token operator">-</span> containerPort: 3000
            protocol: TCP
        resources:
          limits:
            cpu: 100m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 256Mi
        volumeMounts:
          <span class="token operator">-</span> name: grafana-ui-<span class="token keyword">data</span>
            mountPath: <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/grafana
            subPath: <span class="token string">""</span>
      securityContext:
        fsGroup: 472
        runAsUser: 472
      volumes:
        <span class="token operator">-</span> name: grafana-ui-<span class="token keyword">data</span>
          persistentVolumeClaim:
            claimName: grafana-ui-<span class="token keyword">data</span>   <span class="token comment">#前面创建的pvc</span>
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: grafana-ui
  namespace: devops
spec:
  <span class="token function">type</span>: NodePort
  ports:
    <span class="token operator">-</span> name: http
      port: 3000
      protocol: TCP
      targetPort: 3000
      nodePort: 31000
  selector:
    app: grafana-ui

</code></pre> 
<p>六、部署alarm<br> 创建PVC</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: alertmanager-<span class="token keyword">data</span>
  namespace: devops
  annotations:
    volume<span class="token punctuation">.</span>beta<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/storage-provisioner: master-nfs-storage
spec:
  accessModes:
    <span class="token operator">-</span> ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: master-nfs-storage

</code></pre> 
<p>创建ConfigMap<br> 注意替换里面的企业微信信息</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: devops
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: EnsureExists
<span class="token keyword">data</span>:
  alertmanager<span class="token punctuation">.</span>yml: <span class="token punctuation">|</span>       <span class="token comment">#通过cm来创建alertmanager配置文件内容</span>
    global:
      resolve_timeout: 1m
    receivers:
    <span class="token operator">-</span> name: <span class="token string">'wechat'</span>   <span class="token comment">#定义接收者名字</span>
      wechat_configs:
        <span class="token operator">-</span> corp_id: <span class="token string">'wwa7c************b'</span>  <span class="token comment"># 企业微信唯一ID，我的企业--企业信息</span>
          to_party: <span class="token string">'2'</span>        <span class="token comment"># 企业微信中创建的接收告警的部门【告警机器人】的部门ID</span>
          agent_id: <span class="token string">'1000002'</span>  <span class="token comment"># 企业微信中创建的应用的ID</span>
          api_secret: <span class="token string">'8sOqFAiyx22c-***********************-Cw'</span>  <span class="token comment"># 企业微信中，应用的Secret</span>
          send_resolved: true
          message: <span class="token string">'{<!-- -->{ template "wechat.default.message" . }}'</span>
    route:
      group_interval: 1m
      group_by: <span class="token punctuation">[</span><span class="token string">'env'</span><span class="token punctuation">,</span><span class="token string">'instance'</span><span class="token punctuation">,</span><span class="token string">'type'</span><span class="token punctuation">,</span><span class="token string">'group'</span><span class="token punctuation">,</span><span class="token string">'job'</span><span class="token punctuation">,</span><span class="token string">'alertname'</span><span class="token punctuation">]</span>
      group_wait: 10s
      receiver: wechat    <span class="token comment">#发送接收者名字为: "wechat"</span>
      repeat_interval: 1m
    templates:       <span class="token comment">#定义模板位置</span>
      <span class="token operator">-</span> <span class="token string">'*.tmpl'</span>
  <span class="token comment">#微信发送告警信息的模板文件</span>
  wechat<span class="token punctuation">.</span>tmpl: <span class="token punctuation">|</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token keyword">define</span> <span class="token string">"wechat.default.message"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">if</span> gt <span class="token punctuation">(</span>len <span class="token punctuation">.</span>Alerts<span class="token punctuation">.</span>Firing<span class="token punctuation">)</span> 0 <span class="token operator">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> range <span class="token variable">$index</span><span class="token punctuation">,</span> <span class="token variable">$alert</span> := <span class="token punctuation">.</span>Alerts <span class="token operator">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">if</span> eq <span class="token variable">$index</span> 0 <span class="token punctuation">}</span><span class="token punctuation">}</span>
    ========= 监控报警 =========
    告警状态：<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>   <span class="token punctuation">.</span>Status <span class="token punctuation">}</span><span class="token punctuation">}</span>
    告警级别：<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>severity <span class="token punctuation">}</span><span class="token punctuation">}</span>
    告警类型：<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token variable">$alert</span><span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>alertname <span class="token punctuation">}</span><span class="token punctuation">}</span>
    故障主机: <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token variable">$alert</span><span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>instance <span class="token punctuation">}</span><span class="token punctuation">}</span>
    告警主题: <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token variable">$alert</span><span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>summary <span class="token punctuation">}</span><span class="token punctuation">}</span>
    告警详情: <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token variable">$alert</span><span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token variable">$alert</span><span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>description<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    触发阀值：<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">}</span>
    故障时间: <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">(</span><span class="token variable">$alert</span><span class="token punctuation">.</span>StartsAt<span class="token punctuation">.</span>Add 28800e9<span class="token punctuation">)</span><span class="token punctuation">.</span>Format <span class="token string">"2006-01-02 15:04:05"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    ========= = <span class="token keyword">end</span> =  =========
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">end</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">end</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">end</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">if</span> gt <span class="token punctuation">(</span>len <span class="token punctuation">.</span>Alerts<span class="token punctuation">.</span>Resolved<span class="token punctuation">)</span> 0 <span class="token operator">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> range <span class="token variable">$index</span><span class="token punctuation">,</span> <span class="token variable">$alert</span> := <span class="token punctuation">.</span>Alerts <span class="token operator">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">if</span> eq <span class="token variable">$index</span> 0 <span class="token punctuation">}</span><span class="token punctuation">}</span>
    ========= 告警恢复 =========
    告警类型：<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>alertname <span class="token punctuation">}</span><span class="token punctuation">}</span>
    告警状态：<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>   <span class="token punctuation">.</span>Status <span class="token punctuation">}</span><span class="token punctuation">}</span>
    告警主题: <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token variable">$alert</span><span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>summary <span class="token punctuation">}</span><span class="token punctuation">}</span>
    告警详情: <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token variable">$alert</span><span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token variable">$alert</span><span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>description<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    故障时间: <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">(</span><span class="token variable">$alert</span><span class="token punctuation">.</span>StartsAt<span class="token punctuation">.</span>Add 28800e9<span class="token punctuation">)</span><span class="token punctuation">.</span>Format <span class="token string">"2006-01-02 15:04:05"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    恢复时间: <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">(</span><span class="token variable">$alert</span><span class="token punctuation">.</span>EndsAt<span class="token punctuation">.</span>Add 28800e9<span class="token punctuation">)</span><span class="token punctuation">.</span>Format <span class="token string">"2006-01-02 15:04:05"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">if</span> gt <span class="token punctuation">(</span>len <span class="token variable">$alert</span><span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>instance<span class="token punctuation">)</span> 0 <span class="token punctuation">}</span><span class="token punctuation">}</span>
    实例信息: <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token variable">$alert</span><span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>instance <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">end</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    ========= = <span class="token keyword">end</span> =  =========
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">end</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">end</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">end</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span> <span class="token keyword">end</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre> 
<p>创建Deploy和svc</p> 
<pre><code class="prism language-powershell">apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: devops
  labels:
    k8s-app: alertmanager
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
    version: v0<span class="token punctuation">.</span>14<span class="token punctuation">.</span>0
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: alertmanager
      version: v0<span class="token punctuation">.</span>14<span class="token punctuation">.</span>0
  template:
    metadata:
      labels:
        k8s-app: alertmanager
        version: v0<span class="token punctuation">.</span>14<span class="token punctuation">.</span>0
    spec:
      priorityClassName: system-cluster-critical
      containers:
        <span class="token operator">-</span> name: prometheus-alertmanager
          image: <span class="token string">"prom/alertmanager:v0.14.0"</span>
          imagePullPolicy: <span class="token string">"IfNotPresent"</span>
          args:
            <span class="token operator">-</span> <span class="token operator">--</span>config<span class="token punctuation">.</span>file=<span class="token operator">/</span>etc/config/alertmanager<span class="token punctuation">.</span>yml
            <span class="token operator">-</span> <span class="token operator">--</span>storage<span class="token punctuation">.</span>path=<span class="token operator">/</span><span class="token keyword">data</span>
            <span class="token operator">-</span> <span class="token operator">--</span>web<span class="token punctuation">.</span>external-url=<span class="token operator">/</span>
          ports:
            <span class="token operator">-</span> containerPort: 9093
          readinessProbe:
            httpGet:
              path: <span class="token operator">/</span><span class="token comment">#/status</span>
              port: 9093
            initialDelaySeconds: 30
            timeoutSeconds: 30
          volumeMounts:
            <span class="token operator">-</span> name: config-volume
              mountPath: <span class="token operator">/</span>etc/config
            <span class="token operator">-</span> name: alertmanager-<span class="token keyword">data</span>
              mountPath: <span class="token string">"/data"</span>
              subPath: <span class="token string">""</span>
          resources:
            limits:
              cpu: 10m
              memory: 50Mi
            requests:
              cpu: 10m
              memory: 50Mi
        <span class="token operator">-</span> name: prometheus-alertmanager-configmap-reload
          image: <span class="token string">"jimmidyson/configmap-reload:v0.1"</span>
          imagePullPolicy: <span class="token string">"IfNotPresent"</span>
          args:
            <span class="token operator">-</span> <span class="token operator">--</span>volume-<span class="token function">dir</span>=<span class="token operator">/</span>etc/config
            <span class="token operator">-</span> <span class="token operator">--</span>webhook-url=http:<span class="token operator">/</span><span class="token operator">/</span>localhost:9093/<span class="token operator">-</span><span class="token operator">/</span>reload
          volumeMounts:
            <span class="token operator">-</span> name: config-volume
              mountPath: <span class="token operator">/</span>etc/config
              readOnly: true
          resources:
            limits:
              cpu: 10m
              memory: 10Mi
            requests:
              cpu: 10m
              memory: 10Mi
      volumes:
        <span class="token operator">-</span> name: config-volume
          configMap:
            name: alertmanager-config
        <span class="token operator">-</span> name: alertmanager-<span class="token keyword">data</span>
          persistentVolumeClaim:
            claimName: alertmanager-<span class="token keyword">data</span>
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: devops
  labels:
    kubernetes<span class="token punctuation">.</span>io/cluster-service: <span class="token string">"true"</span>
    addonmanager<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/mode: Reconcile
    kubernetes<span class="token punctuation">.</span>io/name: <span class="token string">"Alertmanager"</span>
spec:
  <span class="token function">type</span>: NodePort
  ports:
    <span class="token operator">-</span> name: http
      port: 9093
      protocol: TCP
      targetPort: 9093
  selector:
    k8s-app: alertmanager

</code></pre> 
<p>配置告警规则<br> 进入到nfs服务器上prometheus-rules-data目录下，创建告警规则文件如下：<br> node_health.yaml：</p> 
<pre><code class="prism language-powershell">groups:
<span class="token operator">-</span> name: node_health
  rules:
  <span class="token operator">-</span> alert: HighMemoryUsage
    expr: node_memory_MemAvailable_bytes <span class="token operator">/</span> node_memory_MemTotal_bytes &lt; 0<span class="token punctuation">.</span>9
    <span class="token keyword">for</span>: 1m
    labels:
      severity: warning
    annotations:
      summary: <span class="token string">"Instance {<!-- -->{ <span class="token variable">$labels</span>.instance }}"</span>
      description: <span class="token string">"Instance {<!-- -->{ <span class="token variable">$labels</span>.instance }} of job {<!-- -->{ <span class="token variable">$labels</span>.job }} has High Memory."</span>

  <span class="token operator">-</span> alert: HighDiskUsage
    expr: node_filesystem_free_bytes<span class="token punctuation">{<!-- --></span>mountpoint=<span class="token string">'/'</span><span class="token punctuation">}</span> <span class="token operator">/</span> node_filesystem_size_bytes<span class="token punctuation">{<!-- --></span>mountpoint=<span class="token string">'/'</span><span class="token punctuation">}</span> &lt; 0<span class="token punctuation">.</span>71
    <span class="token keyword">for</span>: 1m
    labels:
      severity: warning
    annotations:
      summary: <span class="token string">"Instance {<!-- -->{ <span class="token variable">$labels</span>.instance }}"</span>
      description: <span class="token string">"Instance {<!-- -->{ <span class="token variable">$labels</span>.instance }} of job {<!-- -->{ <span class="token variable">$labels</span>.job }} has High Disk."</span>

  <span class="token operator">-</span> alert: NodeCPUUsage
    expr: 100 <span class="token operator">-</span> <span class="token punctuation">(</span>avg<span class="token punctuation">(</span>irate<span class="token punctuation">(</span>node_cpu_seconds_total<span class="token punctuation">{<!-- --></span>mode=<span class="token string">"idle"</span><span class="token punctuation">}</span><span class="token punctuation">[</span>5m<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> by <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token operator">*</span> 100<span class="token punctuation">)</span> &gt; 60
    <span class="token keyword">for</span>: 1m
    labels:
      severity: warning
    annotations:
      summary: <span class="token string">"Instance {<!-- -->{ <span class="token variable">$labels</span>.instance }} CPU使用率过高"</span>
      description: <span class="token string">"{<!-- -->{ <span class="token variable">$labels</span>.instance }} CPU使用大于60% (当前值: {<!-- -->{ <span class="token variable">$value</span> }})"</span>

</code></pre> 
<p>node_status.yaml：</p> 
<pre><code class="prism language-powershell">groups:
<span class="token operator">-</span> name: 实例存活告警规则
  rules:
  <span class="token operator">-</span> alert: 实例存活告警
    expr: up == 0
    <span class="token keyword">for</span>: 1m
    labels:
      user: prometheus
      severity: error
    annotations:
      summary: <span class="token string">"Instance {<!-- -->{ <span class="token variable">$labels</span>.instance }} is down"</span>
      description: <span class="token string">"Instance {<!-- -->{ <span class="token variable">$labels</span>.instance }} of job {<!-- -->{ <span class="token variable">$labels</span>.job }} has been down for more than 1 minutes."</span>
      value: <span class="token string">"{<!-- -->{ <span class="token variable">$value</span> }}"</span>

</code></pre> 
<p>修改prometheus的ConfigMap的内容，在最后增加以下部分：</p> 
<pre><code class="prism language-powershell">    alerting:         <span class="token comment">#这里是定义alertmanager告警的地址</span>
      alertmanagers:
      <span class="token operator">-</span> static_configs:
        <span class="token operator">-</span> targets:
          <span class="token operator">-</span> alertmanager<span class="token punctuation">.</span>devops<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local  <span class="token comment">#这里是alert的服务名称</span>
</code></pre> 
<p>以上是所有的配置。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b9148b037cc17f6687d55c8035ef117f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">RabbitMQ系列（19）--实现在RabbitMQ宕机的情况下对消息进行处理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cc1ec1fbe409157a71a9fbce3604b862/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用python求信号的样本熵</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>