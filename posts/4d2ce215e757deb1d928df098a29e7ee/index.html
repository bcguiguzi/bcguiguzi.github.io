<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ElasticSearch - 解决ES的深分页问题 (游标 scroll) - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ElasticSearch - 解决ES的深分页问题 (游标 scroll)" />
<meta property="og:description" content="https://www.jianshu.com/p/f4d322415d29
1.简介 ES为了避免深分页，不允许使用分页(from&amp;size)查询10000条以后的数据，因此如果要查询第10000条以后的数据，要使用ES提供的 scroll(游标) 来查询
假设取的页数较大时(深分页)，如请求第20页，Elasticsearch不得不取出所有分片上的第1页到第20页的所有文档，并做排序，最终再取出from后的size条结果作爲最终的返回值
假设你有16个分片，则需要在coordinate node彙总到 shards* (from&#43;size)条记录，即需要16*(20&#43;10)记录后做一次全局排序
所以，当索引非常非常大(千万或亿)，是无法使用from &#43; size 做深分页的，分页越深则越容易OOM，即便不OOM，也很消耗CPU和内存资源
因此ES使用index.max_result_window:10000作爲保护措施 ，即默认 from &#43; size 不能超过10000，虽然这个参数可以动态修改，也可以在配置文件配置，但是最好不要这麽做，应该改用ES游标来取得数据
2.scroll游标原理 可以把 scroll 理解爲关系型数据库里的 cursor，因此，scroll 并不适合用来做实时搜索，而更适用于后台批处理任务，比如群发
scroll 具体分爲初始化和遍历两步
初始化时将所有符合搜索条件的搜索结果缓存起来，可以想象成快照
在遍历时，从这个快照里取数据
也就是说，在初始化后对索引插入、删除、更新数据都不会影响遍历结果
游标可以增加性能的原因，是因为如果做深分页，每次搜索都必须重新排序，非常浪费，使用scroll就是一次把要用的数据都排完了，分批取出，因此比使用from&#43;size还好
3.具体实例 初始化
请求
注意要在URL中的search后加上scroll=1m，不能写在request body中，其中1m表示这个游标要保持开启1分钟
可以指定size大小，就是每次回传几笔数据，当回传到没有数据时，仍会返回200成功，只是hits裡的hits会是空list
在初始化时除了回传_scroll_id，也会回传前100笔(假设size=100)的数据
request body和一般搜索一样，因此可以说在初始化的过程中，除了加上scroll设置游标开启时间之外，其他的都跟一般的搜寻没有两样 (要设置查询条件，也会回传前size笔的数据)
POST 127.0.0.1:9200/my_index/_search?scroll=1m `注意这里的地址` { &#34;query&#34;:{ &#34;range&#34;:{ &#34;createTime&#34;: { &#34;gte&#34;: 1522229999999 } } }, &#34;size&#34;: 1000 } 返回结果
{ &#34;_scroll_id&#34;: &#34;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAfv5-FjNOamF0Mk1aUUhpUnU5ZWNMaHJocWcAAAAAAH7-gBYzTmphdDJNWlFIaVJ1OWVjTGhyaHFnAAAAAAB-_n8WM05qYXQyTVpRSGlSdTllY0xocmhxZwAAAAAAdsJxFmVkZTBJalJWUmp5UmI3V0FYc2lQbVEAAAAAAHbCcBZlZGUwSWpSVlJqeVJiN1dBWHNpUG1R&#34;, &#34;took&#34;: 2, &#34;timed_out&#34;: false, &#34;_shards&#34;: { &#34;total&#34;: 5, &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/4d2ce215e757deb1d928df098a29e7ee/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-09-30T15:12:00+08:00" />
<meta property="article:modified_time" content="2019-09-30T15:12:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ElasticSearch - 解决ES的深分页问题 (游标 scroll)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="cnblogs_post_body" class="blogpost-body"> 
 <p>https://www.jianshu.com/p/f4d322415d29</p> 
 <p> </p> 
 <h5>1.简介</h5> 
 <blockquote> 
  <p>ES为了避免深分页，不允许使用分页(from&amp;size)查询10000条以后的数据，因此如果要查询第10000条以后的数据，要使用ES提供的 scroll(游标) 来查询</p> 
 </blockquote> 
 <blockquote> 
  <p>假设取的页数较大时(深分页)，如请求第20页，Elasticsearch不得不取出所有分片上的第1页到第20页的所有文档，并做排序，最终再取出from后的size条结果作爲最终的返回值</p> 
 </blockquote> 
 <blockquote> 
  <p>假设你有16个分片，则需要在coordinate node彙总到 shards* (from+size)条记录，即需要16*(20+10)记录后做一次全局排序</p> 
 </blockquote> 
 <blockquote> 
  <p>所以，当索引非常非常大(千万或亿)，是无法使用from + size 做深分页的，分页越深则越容易OOM，即便不OOM，也很消耗CPU和内存资源</p> 
 </blockquote> 
 <blockquote> 
  <p>因此ES使用index.max_result_window:10000作爲保护措施 ，即默认 from + size 不能超过10000，虽然这个参数可以动态修改，也可以在配置文件配置，但是最好不要这麽做，应该改用ES游标来取得数据</p> 
 </blockquote> 
 <h5>2.scroll游标原理</h5> 
 <blockquote> 
  <p>可以把 scroll 理解爲关系型数据库里的 cursor，因此，scroll 并不适合用来做实时搜索，而更适用于后台批处理任务，比如群发</p> 
 </blockquote> 
 <blockquote> 
  <p>scroll 具体分爲初始化和遍历两步</p> 
 </blockquote> 
 <blockquote> 
  <p>初始化时将所有符合搜索条件的搜索结果缓存起来，可以想象成快照</p> 
 </blockquote> 
 <blockquote> 
  <p>在遍历时，从这个快照里取数据</p> 
 </blockquote> 
 <blockquote> 
  <p>也就是说，在初始化后对索引插入、删除、更新数据都不会影响遍历结果</p> 
 </blockquote> 
 <blockquote> 
  <p>游标可以增加性能的原因，是因为如果做深分页，每次搜索都必须重新排序，非常浪费，使用scroll就是一次把要用的数据都排完了，分批取出，因此比使用from+size还好</p> 
 </blockquote> 
 <h5>3.具体实例</h5> 
 <blockquote> 
  <p>初始化</p> 
 </blockquote> 
 <blockquote> 
  <p>请求</p> 
 </blockquote> 
 <blockquote> 
  <p>注意要在URL中的search后加上scroll=1m，不能写在request body中，其中1m表示这个游标要保持开启1分钟</p> 
 </blockquote> 
 <blockquote> 
  <p>可以指定size大小，就是每次回传几笔数据，当回传到没有数据时，仍会返回200成功，只是hits裡的hits会是空list</p> 
 </blockquote> 
 <blockquote> 
  <p>在初始化时除了回传_scroll_id，也会回传前100笔(假设size=100)的数据</p> 
 </blockquote> 
 <blockquote> 
  <p>request body和一般搜索一样，因此可以说在初始化的过程中，除了加上scroll设置游标开启时间之外，其他的都跟一般的搜寻没有两样 (要设置查询条件，也会回传前size笔的数据)</p> 
 </blockquote> 
 <pre class="line-numbers language-go"><code class="language-go">POST <span class="token number">127.0<span class="token number">.0<span class="token number">.1<span class="token punctuation">:<span class="token number">9200<span class="token operator">/my_index<span class="token operator">/_search?scroll<span class="token operator">=<span class="token number">1m <span class="token string">`注意这里的地址` <span class="token punctuation">{ <span class="token string">"query"<span class="token punctuation">:<span class="token punctuation">{ <span class="token string">"range"<span class="token punctuation">:<span class="token punctuation">{ <span class="token string">"createTime"<span class="token punctuation">: <span class="token punctuation">{ <span class="token string">"gte"<span class="token punctuation">: <span class="token number">1522229999999 <span class="token punctuation">} <span class="token punctuation">} <span class="token punctuation">}<span class="token punctuation">, <span class="token string">"size"<span class="token punctuation">: <span class="token number">1000 <span class="token punctuation">} </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre> 
 <blockquote> 
  <p>返回结果</p> 
 </blockquote> 
 <pre class="line-numbers language-json"><code class="language-json">
<span class="token punctuation">{
    <span class="token property">"_scroll_id"<span class="token operator">: <span class="token string">"DnF1ZXJ5VGhlbkZldGNoBQAAAAAAfv5-FjNOamF0Mk1aUUhpUnU5ZWNMaHJocWcAAAAAAH7-gBYzTmphdDJNWlFIaVJ1OWVjTGhyaHFnAAAAAAB-_n8WM05qYXQyTVpRSGlSdTllY0xocmhxZwAAAAAAdsJxFmVkZTBJalJWUmp5UmI3V0FYc2lQbVEAAAAAAHbCcBZlZGUwSWpSVlJqeVJiN1dBWHNpUG1R"<span class="token punctuation">, <span class="token property">"took"<span class="token operator">: <span class="token number">2<span class="token punctuation">, <span class="token property">"timed_out"<span class="token operator">: <span class="token boolean">false<span class="token punctuation">, <span class="token property">"_shards"<span class="token operator">: <span class="token punctuation">{ <span class="token property">"total"<span class="token operator">: <span class="token number">5<span class="token punctuation">, <span class="token property">"successful"<span class="token operator">: <span class="token number">5<span class="token punctuation">, <span class="token property">"skipped"<span class="token operator">: <span class="token number">0<span class="token punctuation">, <span class="token property">"failed"<span class="token operator">: <span class="token number">0 <span class="token punctuation">}<span class="token punctuation">, <span class="token property">"hits"<span class="token operator">: <span class="token punctuation">{ <span class="token property">"total"<span class="token operator">: <span class="token number">84<span class="token punctuation">, <span class="token property">"max_score"<span class="token operator">: <span class="token number">1<span class="token punctuation">, <span class="token property">"hits"<span class="token operator">: <span class="token punctuation">[ <span class="token punctuation">{ <span class="token property">"_index"<span class="token operator">: <span class="token string">"video1522821719"<span class="token punctuation">, <span class="token property">"_type"<span class="token operator">: <span class="token string">"doc"<span class="token punctuation">, <span class="token property">"_id"<span class="token operator">: <span class="token string">"84056"<span class="token punctuation">, <span class="token property">"_score"<span class="token operator">: <span class="token number">1<span class="token punctuation">, <span class="token property">"_source"<span class="token operator">: <span class="token punctuation">{ <span class="token property">"title"<span class="token operator">: <span class="token string">"三个院子"<span class="token punctuation">, <span class="token property">"createTime"<span class="token operator">: <span class="token number">1522239744000 <span class="token punctuation">} <span class="token punctuation">} ....<span class="token number">99 data <span class="token punctuation">] <span class="token punctuation">} <span class="token punctuation">} </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre> 
 <blockquote> 
  <p>遍历数据</p> 
 </blockquote> 
 <blockquote> 
  <p>请求</p> 
 </blockquote> 
 <blockquote> 
  <p>使用初始化返回的_scroll_id来进行请求，每一次请求都会继续返回初始化中未读完数据，并且会返回一个_scroll_id，这个_scroll_id可能会改变，因此每一次请求应该带上上一次请求返回的_scroll_id</p> 
 </blockquote> 
 <blockquote> 
  <p>要注意返回的是_scroll_id，但是放在请求裡的是scroll_id，两者拼写上有不同</p> 
 </blockquote> 
 <blockquote> 
  <p>且每次发送scroll请求时，都要再重新刷新这个scroll的开启时间，以防不小心超时导致数据取得不完整</p> 
 </blockquote> 
 <pre class="line-numbers language-go"><code class="language-go">POST <span class="token number">127.0<span class="token number">.0<span class="token number">.1<span class="token punctuation">:<span class="token number">9200<span class="token operator">/_search<span class="token operator">/scroll?scroll<span class="token operator">=<span class="token number">1m <span class="token string">`注意地址` <span class="token punctuation">{ <span class="token string">"scroll_id"<span class="token punctuation">: <span class="token string">"DnF1ZXJ5VGhlbkZldGNoBQAAAAAAdsMqFmVkZTBJalJWUmp5UmI3V0FYc2lQbVEAAAAAAHbDKRZlZGUwSWpSVlJqeVJiN1dBWHNpUG1RAAAAAABpX2sWclBEekhiRVpSRktHWXFudnVaQ3dIQQAAAAAAaV9qFnJQRHpIYkVaUkZLR1lxbnZ1WkN3SEEAAAAAAGlfaRZyUER6SGJFWlJGS0dZcW52dVpDd0hB" <span class="token punctuation">} </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre> 
 <blockquote> 
  <p>返回结果</p> 
 </blockquote> 
 <blockquote> 
  <p>如果没有数据了，就会回传空的hits，可以用这个判断是否遍历完成了数据</p> 
 </blockquote> 
 <pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{
    <span class="token property">"_scroll_id"<span class="token operator">: <span class="token string">"DnF1ZXJ5VGhlbkZldGNoBQAAAAAAdsMqFmVkZTBJalJWUmp5UmI3V0FYc2lQbVEAAAAAAHbDKRZlZGUwSWpSVlJqeVJiN1dBWHNpUG1RAAAAAABpX2sWclBEekhiRVpSRktHWXFudnVaQ3dIQQAAAAAAaV9qFnJQRHpIYkVaUkZLR1lxbnZ1WkN3SEEAAAAAAGlfaRZyUER6SGJFWlJGS0dZcW52dVpDd0hB"<span class="token punctuation">, <span class="token property">"took"<span class="token operator">: <span class="token number">2<span class="token punctuation">, <span class="token property">"timed_out"<span class="token operator">: <span class="token boolean">false<span class="token punctuation">, <span class="token property">"_shards"<span class="token operator">: <span class="token punctuation">{ <span class="token property">"total"<span class="token operator">: <span class="token number">5<span class="token punctuation">, <span class="token property">"successful"<span class="token operator">: <span class="token number">5<span class="token punctuation">, <span class="token property">"skipped"<span class="token operator">: <span class="token number">0<span class="token punctuation">, <span class="token property">"failed"<span class="token operator">: <span class="token number">0 <span class="token punctuation">}<span class="token punctuation">, <span class="token property">"hits"<span class="token operator">: <span class="token punctuation">{ <span class="token property">"total"<span class="token operator">: <span class="token number">84<span class="token punctuation">, <span class="token property">"max_score"<span class="token operator">: <span class="token null keyword">null<span class="token punctuation">, <span class="token property">"hits"<span class="token operator">: <span class="token punctuation">[<span class="token punctuation">] <span class="token punctuation">} <span class="token punctuation">} </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre> 
 <blockquote> 
  <p>优化scroll查询</p> 
 </blockquote> 
 <blockquote> 
  <p>在一般场景下，scroll通常用来取得需要排序过后的大笔数据，但是有时候数据之间的排序性对我们而言是没有关系的，只要所有数据都能取出来就好，这时能够对scroll进行优化</p> 
 </blockquote> 
 <blockquote> 
  <p>初始化</p> 
 </blockquote> 
 <blockquote> 
  <p>使用_doc去sort得出来的结果，这个执行的效率最快，但是数据就不会有排序，适合用在只想取得所有数据的场景</p> 
 </blockquote> 
 <pre class="line-numbers language-bash"><code class="language-bash">POST 127.0.0.1:9200/my_index/_search?scroll=1m
{
    "query": {
        "match_all" : {}
    },
    "sort": [
        "_doc"
        ]
    }
}
</code></pre> 
 <blockquote> 
  <p>清除scroll</p> 
 </blockquote> 
 <blockquote> 
  <p>虽然我们在设置开启scroll时，设置了一个scroll的存活时间，但是如果能够在使用完顺手关闭，可以提早释放资源，降低ES的负担</p> 
 </blockquote> 
 <pre class="line-numbers language-bash"><code class="language-bash">DELETE 127.0.0.1:9200/_search/scroll
{
    "scroll_id": "DnF1ZXJ5VGhlbkZldGNoBQAAAAAAdsMqFmVkZTBJalJWUmp5UmI3V0FYc2lQbVEAAAAAAHbDKRZlZGUwSWpSVlJqeVJiN1dBWHNpUG1RAAAAAABpX2sWclBEekhiRVpSRktHWXFudnVaQ3dIQQAAAAAAaV9qFnJQRHpIYkVaUkZLR1lxbnZ1WkN3SEEAAAAAAGlfaRZyUER6SGJFWlJGS0dZcW52dVpDd0hB"
}

</code></pre> 
 <h5>4.转发连接</h5> 
 <blockquote> 
  <p><a href="https://blog.csdn.net/weixin_40341116/article/details/80821655">https://blog.csdn.net/weixin_40341116/article/details/80821655</a></p> 
 </blockquote> 
</div> 
<p>转载于:https://www.cnblogs.com/xiang--liu/p/11612865.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/379c356487dd36aa969f04a96cc4918d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue-route&#43;webpack部署单页路由项目，访问刷新出现404问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f56185a92773492710ba5f7d7923ccf3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">elasticsearch——Rest Client</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>