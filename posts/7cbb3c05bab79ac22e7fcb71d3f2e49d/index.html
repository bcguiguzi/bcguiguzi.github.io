<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SqlAlchemy使用教程(六) -- ORM 表间关系的定义与CRUD操作 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SqlAlchemy使用教程(六) -- ORM 表间关系的定义与CRUD操作" />
<meta property="og:description" content="SqlAlchemy使用教程(一) 原理与环境搭建SqlAlchemy使用教程(二) 入门示例及编程步骤SqlAlchemy使用教程(三) CoreAPI访问与操作数据库详解SqlAlchemy使用教程(四) MetaData 与 SQL Express Language 的使用SqlAlchemy使用教程(五) ORM API 编程入门 本章内容，稍微有些复杂，建议腾出2小时空闲时间，冲杯咖啡或泡杯茶 😃 , 慢慢看，在电脑上跑下代码，可以加深理解.
六、表间关系的定义与CRUD操作 表间关系主要包括：一对多，一对一，多对多。其中一对多关系中也隐含了多对一关系。
表间关系是数据库操作中的重要技术点，非常有必要理解与掌握。
1、 一对多表间关系的定义 一对多表间关系实现语法 以一对多关系为例，
子表侧，与父表是一对多关系，父表侧，可以反向查询子表数据，与子表是多对一关系。 class Parent(Base): __tablename__ = &#34;parent_table&#34; id: Mapped[int] = mapped_column(primary_key=True) children: Mapped[List[&#34;Child&#34;]] = relationship(back_populates=&#34;parent&#34;) class Child(Base): __tablename__ = &#34;child_table&#34; id: Mapped[int] = mapped_column(primary_key=True) parent_id: Mapped[int] = mapped_column(ForeignKey(&#34;parent_table.id&#34;)) parent: Mapped[&#34;Parent&#34;] = relationship(back_populates=&#34;children&#34;) 说明：
1）在子表中添加外键字段，以及relationship()引用，
2）在父表中添加relationship()引用，用于反向查询。
示例代码 父表：company, 子表 person, 表结构类定义如下。
from sqlalchemy.orm import DeclarativeBase, Session from sqlalchemy." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/7cbb3c05bab79ac22e7fcb71d3f2e49d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-24T11:19:23+08:00" />
<meta property="article:modified_time" content="2024-01-24T11:19:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SqlAlchemy使用教程(六) -- ORM 表间关系的定义与CRUD操作</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/50/85/3CyvffIn_o.png" alt="在这里插入图片描述" width="1000"></p> 
<blockquote> 
 <ul><li><a href="https://blog.csdn.net/captain5339/article/details/135561292">SqlAlchemy使用教程(一) 原理与环境搭建</a></li><li><a href="https://blog.csdn.net/captain5339/article/details/135580682">SqlAlchemy使用教程(二) 入门示例及编程步骤</a></li><li><a href="https://blog.csdn.net/captain5339/article/details/135582739">SqlAlchemy使用教程(三) CoreAPI访问与操作数据库详解</a></li><li><a href="https://blog.csdn.net/captain5339/article/details/135598914">SqlAlchemy使用教程(四) MetaData 与 SQL Express Language 的使用</a></li><li><a href="https://blog.csdn.net/captain5339/article/details/135685624">SqlAlchemy使用教程(五) ORM API 编程入门</a></li></ul> 
</blockquote> 
<blockquote> 
 <p>本章内容，稍微有些复杂，建议腾出2小时空闲时间，冲杯咖啡或泡杯茶 😃 , 慢慢看，在电脑上跑下代码，可以加深理解.</p> 
</blockquote> 
<h2><a id="CRUD_9"></a>六、表间关系的定义与CRUD操作</h2> 
<p>表间关系主要包括：一对多，一对一，多对多。其中一对多关系中也隐含了多对一关系。<br> 表间关系是数据库操作中的重要技术点，非常有必要理解与掌握。</p> 
<h3><a id="1__13"></a>1、 一对多表间关系的定义</h3> 
<h4><a id="_14"></a>一对多表间关系实现语法</h4> 
<p>以一对多关系为例，</p> 
<ul><li>子表侧，与父表是一对多关系，</li><li>父表侧，可以反向查询子表数据，与子表是多对一关系。</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"parent_table"</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    children<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token string">"Child"</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship<span class="token punctuation">(</span>back_populates<span class="token operator">=</span><span class="token string">"parent"</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"child_table"</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    parent_id<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"parent_table.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    parent<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token string">"Parent"</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship<span class="token punctuation">(</span>back_populates<span class="token operator">=</span><span class="token string">"children"</span><span class="token punctuation">)</span>
</code></pre> 
<p>说明：<br> 1）在子表中添加外键字段，以及relationship()引用，<br> 2）在父表中添加relationship()引用，用于反向查询。</p> 
<h4><a id="_39"></a>示例代码</h4> 
<p>父表：company, 子表 person, 表结构类定义如下。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> DeclarativeBase<span class="token punctuation">,</span> Session
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> Mapped<span class="token punctuation">,</span> mapped_column
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> String<span class="token punctuation">,</span> Integer
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List

<span class="token keyword">class</span> <span class="token class-name">Base</span><span class="token punctuation">(</span>DeclarativeBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
<span class="token keyword">class</span> <span class="token class-name">Company</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"company"</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    company_name<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    persons<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token string">'Person'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship<span class="token punctuation">(</span>
        back_populates<span class="token operator">=</span><span class="token string">"company"</span><span class="token punctuation">,</span> cascade<span class="token operator">=</span><span class="token string">"all, delete-orphan"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"Company(id=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">, company_name=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>company_name<span class="token punctuation">}</span></span><span class="token string">)"</span></span>

<span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"person"</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    age<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span>
    company_id<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"company.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    company<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token string">'Company'</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship<span class="token punctuation">(</span>back_populates<span class="token operator">=</span><span class="token string">"persons"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"Person(id=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">, name=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">)"</span></span>
</code></pre> 
<p><strong>说明：</strong><br> 1）从子表视角看，1个人只属于1个Company; 但1个Company 对应多个人，因此在父表则，relationship() 左侧的类型注解为 List[‘Person’], 也可以用Set[‘Person’]<br> 2）父表中添加删除依赖，cascade=“all, delete-orphan”，即子表中不存在对父表记录的引用时，才能删除，以保证数据的完整性。<br> 3）当前版本可能存在bug, 官方文档中的示例中有的字段使用简化写法（右侧未给出mapped_column())，sqlite3运行是没有问题的，但mysql, postgresql创建表时会丢弃简化写法的字段，导致后续insert等操作失败。 因此请严格请勿采有简化写法。</p> 
<h4><a id="_80"></a>多对一关系的实现语法</h4> 
<p>当不需要反向查询时，则父表与子表形成Many to One 多对一关系， 在父表则添加子表的外键与relationship()引用，子表无须做额外配置</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"parent_table"</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    child_id<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"child_table.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    child<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token string">"Child"</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"child_table"</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<p>如果允许 child_id空值，则将改字段的类型注解修改为</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
child_id<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span>Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"child_table.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>对于3.10+版本，类型注解支持 | 操作符</p> 
<pre><code class="prism language-python">child_id<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"child_table.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
child<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span>Child <span class="token operator">|</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship<span class="token punctuation">(</span>back_populates<span class="token operator">=</span><span class="token string">"parents"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="2__115"></a>2、 插入数据与多表联合查询</h3> 
<h4><a id="1_116"></a>1）在数据库创建表</h4> 
<pre><code class="prism language-python"><span class="token comment"># 创建数据库连接引擎对象</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span>
    <span class="token string">"mysql+mysqlconnector://root:Admin&amp;123@localhost:3306/testdb"</span><span class="token punctuation">)</span>
<span class="token comment"># 将DDL语句映射到数据库表，如果数据库表不存在，则创建该表</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>
<span class="token comment"># 打印创建创建的表</span>
Print<span class="token punctuation">(</span>Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>tables<span class="token punctuation">)</span> 
</code></pre> 
<h4><a id="2_128"></a>2）插入数据</h4> 
<h5><a id="_129"></a>基本步骤包括：</h5> 
<p>(1)为测试方便，先写1个get_or_create()函数，如果插入对象在数据库中已存在则不插入，以方便连续测试。<br> (2)创建session对象<br> (3)先创建父表对象并插入<br> (4)创建子表对象并插入<br> (5)用多表查询方法检查结果</p> 
<h5><a id="Step1_create_or_create_136"></a>Step-1: 自定义create_or_create()函数</h5> 
<p>官方提供的upsert方法不通用。下面函数是通用的，</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_or_create</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> model<span class="token punctuation">,</span> defaults<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""如果不存在则创建，如果存在则返回
    输入参数：
        session: sqlalchemy session
        model: 自定义的ORM类
        defaults: 有默认值的字段
        kwargs: 其他字段(必须包含主要字段)
    返回值：
        instance: 返回的实例
    """</span>
    instance <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> instance<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"instance already exists"</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span>
        <span class="token keyword">return</span> instance
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        params <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>
                      <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> ClauseElement<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> defaults<span class="token punctuation">:</span>
            params<span class="token punctuation">.</span>update<span class="token punctuation">(</span>defaults<span class="token punctuation">)</span>
        instance <span class="token operator">=</span> model<span class="token punctuation">(</span><span class="token operator">**</span>params<span class="token punctuation">)</span>
        session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>instance<span class="token punctuation">)</span>
        session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"instance inserted"</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span>
        <span class="token keyword">return</span> instance
</code></pre> 
<h5><a id="Step2__166"></a>Step-2: 向两个关联表插入数据</h5> 
<p>用with 语句创建session对象，插入操作顺序，先父表再子表</p> 
<pre><code class="prism language-python"><span class="token keyword">with</span> Session<span class="token punctuation">(</span>engine<span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
    <span class="token comment"># 插入数据</span>
    get_or_create<span class="token punctuation">(</span>session<span class="token punctuation">,</span> Company<span class="token punctuation">,</span> company_name<span class="token operator">=</span><span class="token string">"蜀汉"</span><span class="token punctuation">)</span>
    get_or_create<span class="token punctuation">(</span>session<span class="token punctuation">,</span> Company<span class="token punctuation">,</span> company_name<span class="token operator">=</span><span class="token string">"曹魏"</span><span class="token punctuation">)</span>
    get_or_create<span class="token punctuation">(</span>session<span class="token punctuation">,</span> Company<span class="token punctuation">,</span> company_name<span class="token operator">=</span><span class="token string">"东吴"</span><span class="token punctuation">)</span>
    
    stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>Company<span class="token punctuation">)</span>
    results <span class="token operator">=</span> session<span class="token punctuation">.</span>scalars<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># insert data in person table</span>
    company_shu <span class="token operator">=</span> session<span class="token punctuation">.</span>scalars<span class="token punctuation">(</span>select<span class="token punctuation">(</span>Company<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>
        Company<span class="token punctuation">.</span>company_name <span class="token operator">==</span> <span class="token string">"蜀汉"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    get_or_create<span class="token punctuation">(</span>session<span class="token punctuation">,</span> Person<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"刘备"</span><span class="token punctuation">,</span>
                  age<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">,</span> company<span class="token operator">=</span>company_shu<span class="token punctuation">)</span>
    get_or_create<span class="token punctuation">(</span>session<span class="token punctuation">,</span> Person<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"关羽"</span><span class="token punctuation">,</span>
                  age<span class="token operator">=</span><span class="token number">40</span><span class="token punctuation">,</span> company<span class="token operator">=</span>company_shu<span class="token punctuation">)</span>
    get_or_create<span class="token punctuation">(</span>session<span class="token punctuation">,</span> Person<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"张飞"</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">38</span><span class="token punctuation">,</span> company<span class="token operator">=</span>company_shu<span class="token punctuation">)</span>
    company_wei <span class="token operator">=</span> session<span class="token punctuation">.</span>scalars<span class="token punctuation">(</span>select<span class="token punctuation">(</span>Company<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>
        Company<span class="token punctuation">.</span>company_name <span class="token operator">==</span> <span class="token string">"曹魏"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    get_or_create<span class="token punctuation">(</span>session<span class="token punctuation">,</span> Person<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"张辽"</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">40</span><span class="token punctuation">,</span> company<span class="token operator">=</span>company_wei<span class="token punctuation">)</span>
    get_or_create<span class="token punctuation">(</span>session<span class="token punctuation">,</span> Person<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"曹操"</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">38</span><span class="token punctuation">,</span> company<span class="token operator">=</span>company_wei<span class="token punctuation">)</span>
    company_wu <span class="token operator">=</span> session<span class="token punctuation">.</span>scalars<span class="token punctuation">(</span>select<span class="token punctuation">(</span>Company<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>
        Company<span class="token punctuation">.</span>company_name <span class="token operator">==</span> <span class="token string">"东吴"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    get_or_create<span class="token punctuation">(</span>session<span class="token punctuation">,</span> Person<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"周瑜"</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> company<span class="token operator">=</span>company_wu<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="3__197"></a>3) 多表联合查询</h4> 
<pre><code class="prism language-python">   <span class="token comment"># select with Join 多表查询</span>
    stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>Person<span class="token punctuation">.</span>company<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>
        Company<span class="token punctuation">.</span>company_name <span class="token operator">==</span> <span class="token string">"蜀汉"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>Person<span class="token punctuation">.</span>age<span class="token punctuation">)</span>
    results <span class="token operator">=</span> session<span class="token punctuation">.</span>scalars<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
    <span class="token comment"># 遍历结果</span>
    <span class="token keyword">for</span> r <span class="token keyword">in</span> results<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>age<span class="token punctuation">,</span> r<span class="token punctuation">.</span>company<span class="token punctuation">.</span>company_name<span class="token punctuation">)</span>
</code></pre> 
<p>Output:</p> 
<pre><code class="prism language-python">instance inserted Company<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> company_name<span class="token operator">=</span>蜀汉<span class="token punctuation">)</span>
instance inserted Company<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> company_name<span class="token operator">=</span>曹魏<span class="token punctuation">)</span>
instance inserted Company<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> company_name<span class="token operator">=</span>东吴<span class="token punctuation">)</span>
<span class="token punctuation">[</span>Company<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> company_name<span class="token operator">=</span>蜀汉<span class="token punctuation">)</span><span class="token punctuation">,</span> Company<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> company_name<span class="token operator">=</span>曹魏<span class="token punctuation">)</span><span class="token punctuation">,</span> Company<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> company_name<span class="token operator">=</span>东吴<span class="token punctuation">)</span><span class="token punctuation">]</span>
instance inserted Person<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span>刘备<span class="token punctuation">)</span>
instance inserted Person<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span>关羽<span class="token punctuation">)</span>
instance inserted Person<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> name<span class="token operator">=</span>张飞<span class="token punctuation">)</span>
instance inserted Person<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">=</span>张辽<span class="token punctuation">)</span>
instance inserted Person<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> name<span class="token operator">=</span>曹操<span class="token punctuation">)</span>
instance inserted Person<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> name<span class="token operator">=</span>周瑜<span class="token punctuation">)</span>
张飞 <span class="token number">38</span> 蜀汉
关羽 <span class="token number">40</span> 蜀汉
刘备 <span class="token number">42</span> 蜀汉
</code></pre> 
<p><strong>删除数据</strong><br> 当删除父表记录时，子表中应无对此数据的引用，否则无法删除。</p> 
<h3><a id="3__230"></a>3、 一对一关系</h3> 
<p>从外键角度看，一对一关系也是一对多关系。实现时，</p> 
<ul><li>在父表中收集子表数据时，类型注解不使用集合类型即可。</li><li>子表中relationship()方法中添加single_parent=True.</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"parent_table"</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
child<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token string">"Child"</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship<span class="token punctuation">(</span>back_populates<span class="token operator">=</span><span class="token string">"parent"</span><span class="token punctuation">)</span>   
    <span class="token comment"># 一对多时，使用child: Mapped[List["Child"]] </span>


<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"child_table"</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    parent_id<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"parent_table.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    parent<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token string">"Parent"</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship<span class="token punctuation">(</span>back_populates<span class="token operator">=</span><span class="token string">"child"</span>，single_parent<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="4__251"></a>4、 多对多关系</h3> 
<p>多对多关系特点：<br> 1）父表与子表，子表与父表之间均为多对多关系。<br> 2）通常使用1张中间表， 与父表、子表均实现1对多关系。<br> （当然有的ORM模型将中间表的创建隐藏起来，但在数据库中还是可以看到）</p> 
<h4><a id="_257"></a>多对多关系定义示例</h4> 
<pre><code class="prism language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> annotations

<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Table
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Integer
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> Mapped
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> mapped_column
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> DeclarativeBase
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship


<span class="token keyword">class</span> <span class="token class-name">Base</span><span class="token punctuation">(</span>DeclarativeBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>


<span class="token comment"># note for a Core table, we use the sqlalchemy.Column construct,</span>
<span class="token comment"># not sqlalchemy.orm.mapped_column</span>
association_table <span class="token operator">=</span> Table<span class="token punctuation">(</span>
    <span class="token string">"association_table"</span><span class="token punctuation">,</span>
    Base<span class="token punctuation">.</span>metadata<span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">"left_id"</span><span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">"left_table.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">"right_id"</span><span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">"right_table.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"left_table"</span>

    <span class="token builtin">id</span><span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    children<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Child<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship<span class="token punctuation">(</span>
        secondary<span class="token operator">=</span>association_table<span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"parents"</span>
    <span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"right_table"</span>

    <span class="token builtin">id</span><span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapped_column<span class="token punctuation">(</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    parents<span class="token punctuation">:</span> Mapped<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Parent<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship<span class="token punctuation">(</span>
        secondary<span class="token operator">=</span>association_table<span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"children"</span>
    <span class="token punctuation">)</span>
</code></pre> 
<p>多对多关系的查询、插入操作与一对多查询相似。 需要注意的是删除操作。</p> 
<h4><a id="_305"></a>从多对多关系中删除数据</h4> 
<p>用SQL来实现时，需要先从父表与子表删除数据，再从中间表删除。ORM API 可以自动完成这个过程。 如要删除子表的某条记录。</p> 
<pre><code class="prism language-python">myparent<span class="token punctuation">.</span>children<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>somechild<span class="token punctuation">)</span>
</code></pre> 
<p>注：通过session.delete(somechild)时，MySql可能会报错，我遇到的原因有多种，不建议使用。<br> 同样，如果要删除父表中的1条记录：</p> 
<pre><code class="prism language-python">mychild<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>someparent<span class="token punctuation">)</span> 
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/38449228a87b07958a47682629d30c12/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SqlAlchemy使用教程(五) ORM API 编程入门</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/97fbc6809c414facc270559f6c7e0879/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python学习从0到1 day8 Python循环语句</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>