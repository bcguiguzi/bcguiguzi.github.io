<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mysql循环删除或更新数据 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Mysql循环删除或更新数据" />
<meta property="og:description" content="使用前提：
1.删除或更新数据时，需要使用索引条件，并且控制每次更新或删除的行数。
2.更新后的数据不能再次被更新，可以通过where条件进行控制实现。
python3脚本如下
from pymysql import connect as MysqlConn #pip3 install pymysql==0.9.3 from datetime import datetime from time import sleep def loop_delete_update(host,port,user,pswd,db,sql): conn = MysqlConn(host=host, port=port, user=user, passwd=pswd, db=db, charset=&#39;utf8&#39;) total_count = 0 while True: with conn.cursor() as cursor: #cursor.execute(&#34;SET SQL_LOG_BIN=0&#34;) #是否关闭当前会话的binlog日志，关闭后速度更快，但是操作不会同步到从库 counts = cursor.execute(sql) conn.commit() total_count &#43;= counts print(&#34;%s\t%s&#34;%(datetime.now().strftime(&#34;%Y-%m-%dT%H:%M:%S.%f&#34;),total_count)) #执行进度 if counts == 0: #上一次更新或删除的行数为0时，退出循环 break sleep(0.01) #控制频率 conn.close() sql = &#34;DELETE FROM test WHERE create_time &lt; &#39;2020-10-01 00:00:00&#39; LIMIT 200 &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/14c7e647becf456aea69f17089589422/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-12T10:59:03+08:00" />
<meta property="article:modified_time" content="2020-11-12T10:59:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Mysql循环删除或更新数据</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><span style="color:#f33b45;"><strong>使用前提：</strong></span></p> 
<p style="text-indent:33px;">1.删除或更新数据时，需要使用索引条件，并且控制每次更新或删除的行数。</p> 
<p style="text-indent:33px;">2.更新后的数据不能再次被更新，可以通过where条件进行控制实现。</p> 
<p> </p> 
<p><span style="color:#f33b45;">python3脚本如下</span></p> 
<pre><code class="language-python">from pymysql import connect as MysqlConn   #pip3 install pymysql==0.9.3
from datetime import datetime
from time import sleep

def loop_delete_update(host,port,user,pswd,db,sql):
    conn = MysqlConn(host=host, port=port, user=user, passwd=pswd, db=db, charset='utf8')
    total_count = 0
    while True:
        with conn.cursor() as cursor:
            #cursor.execute("SET SQL_LOG_BIN=0")    #是否关闭当前会话的binlog日志，关闭后速度更快，但是操作不会同步到从库
            counts = cursor.execute(sql)
            conn.commit()
        total_count += counts
        print("%s\t%s"%(datetime.now().strftime("%Y-%m-%dT%H:%M:%S.%f"),total_count))  #执行进度
        if counts == 0:   #上一次更新或删除的行数为0时，退出循环
            break
        sleep(0.01)   #控制频率
    conn.close()


sql = "DELETE FROM test WHERE create_time &lt; '2020-10-01 00:00:00' LIMIT 200 "
loop_delete_update("127.0.0.1",3306,"root","123456","test",sql)
</code></pre> 
<p> </p> 
<p><span style="color:#f33b45;">Mysql存储过程</span></p> 
<pre><code class="language-sql">CREATE TABLE IF NOT EXISTS dba_loop_execute_delete_update_log(create_date datetime default CURRENT_TIMESTAMP,effect_rows int ) ENGINE=MEMORY;

DROP PROCEDURE IF EXISTS dba_loop_execute_delete_update;
DELIMITER ;;
CREATE PROCEDURE dba_loop_execute_delete_update()
BEGIN
		DECLARE effect_rows INT DEFAULT 0; #影响的总行数
		DECLARE effect_row INT DEFAULT 0;  #单次影响的行数

		outer_label:WHILE TRUE DO 

				##替换下面的脚本，进行自定义更新或删除
				DELETE FROM check_data_count WHERE id&lt;100000 LIMIT 1000;  ##执行删除操作


				SELECT ROW_COUNT() INTO effect_row;  ##上一次执行影响的行数
				IF effect_row &lt; 1 THEN   ##如果影响的行数小于1，则跳出循环
					LEAVE outer_label;
				ELSE
					 SET effect_rows=effect_rows + effect_row;
				END IF;

				#如果不需要写日志，看进度的话，此部分可以不需要
				IF MOD(effect_rows,10000) =0 THEN  ##每删除10000行，写一次日志
						INSERT INTO dba_loop_execute_delete_update_log(effect_rows) VALUES(effect_rows);
				END IF;

				SELECT SLEEP(0.1);   #控制频率
		END WHILE;

		#如果不需要写日志，看进度的话，此部分可以不需要
		INSERT INTO dba_loop_execute_delete_update_log(effect_rows) VALUES(effect_rows); #记录总的更新或删除的行数

END ;;
delimiter ;

CALL dba_loop_execute_delete_update();   ##执行存储过程
SELECT * FROM dba_loop_execute_delete_update_log; #查看进度，需要另开一个会话


DROP PROCEDURE IF EXISTS dba_loop_execute_delete_update;
DROP TABLE IF EXISTS dba_loop_execute_delete_update_log;

</code></pre> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6b2fc410bba413738d08f1d3d3afc749/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">cad快看_星期日来啦！分享5个珍藏已久的电影网站，各种大片免费看</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d63801db2748d48fbc0881fd67e4e383/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">区分in和exists、not in和not exists</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>