<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Type-C协议-CC检测原理 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Type-C协议-CC检测原理" />
<meta property="og:description" content="Type-C连接器中有两个管脚CC1和CC2，他们用于识别连接器的插入方向，以及不同的插入设备。本文介绍CC的基本识别原理。
先介绍几个概念：
DFP——Downstream Facing Port，也就是Host
UFP——Upstream Facing Port，也就是Device
DRP——Dual Role port，既可以做DFP，也可以做UFP。
在建立连接之前，DRP的角色在DFP和UPF之间切换。如果两个DRP连接，最先随机到那种角色后开始建立连接，之后可以通过USB协议协商进行动态切换。
USB Type-C插座和插头的两排管脚对称，USB数据信号都有两组重复的通道，但主控芯片通常只有一组TX/RX和D&#43;/-通道（某些芯片有两组TX/RX和D&#43;/-通道）。
由于USB2.0的数据率最高只有480Mbps, 可以不考虑信号走线的阻抗连续性，USB2.0的D&#43;/-信号可以不被MUX控制而直接从主控芯片走线，然后一分二连接至USB Type-C插座的两组D&#43;/-管脚上。
但USB3.0或者USB3.1的数据率高达5Gbps或者10Gbps，如果信号线还是被简单地一分二的话，不连续的信号线阻抗将严重破坏数据传输质量，因此必须由MUX切换来保证信号路径阻抗的一致性，以确保信号传输质量。
下图中右侧所示的MUX从TX1/RX1和TX2/RX2中选择一路连接至主控芯片，而这个MUX就必须被CC管脚控制。
在USB2.0应用中，无需考虑CC方向检测问题，但USB3.0或者USB3.1应用中，必须考虑CC方向检测问题。
注意UFP，比如U盘，移动硬盘内部不需要CC逻辑检测，因为它是上行，只有一对USB2.0或USB3.0信号，如下图
3 CC检测原理 CC信号有两根线，CC1和CC2，大部分USB线（不带芯片的线缆）里面只有一根CC线，DFP可根据两根CC线上的电压，判断是否已经插入设备。通过判断哪根CC线上有下拉电阻来判断方向，下图的说明已经非常清晰。
如果CC1引脚检测到有效的Rp/Rd连接（对应的电压），则认为电缆连接未翻转。
如果CC2引脚检测到有效的Rp/Rd连接（对应的电压），则认为电缆连接已翻转。
“有效的Rp/Rd连接”指在CC上形成了有效的电压。
从DFP的角度看，下表列出了所有可能的连接状态，
以上只是介绍了CC检测中判断是否翻转的原理，两个CC信号还有向UPF通告DFP提供电流能力的功能等，见下文
3.1 DFP的上拉电阻Rp DFP的CC1和CC2信号上都必须有上拉电阻Rp，上拉到5V或3.3V。或者CC1和CC2都用电流源上拉。最终的目的是在插入后，能检测到CC1或CC2上的电压，进而判断是否翻转以及DFP的电流能力。如下是所有可能的配置。可以选择右边三列中的任何一列作为上拉方式，比如Fairchild的FUSB300就是用330uA上拉，TI的TUSB320LAI用的是80uA的上拉，不同的上拉方式在CC引脚上形成的电压不同，不同的电压对应不同的电流能力。
3.2 UPF的Rd UFP的CC1和CC2管脚都要有一个下拉电阻Rd到GND（或者使用电压钳位）。Rd的处理方式如下表。
注意，最后一列的电流源连接至的电压，是指3.1节中表格的最后一列电流源的上拉电压。
结合这个表格，和3.1节的表格，我们把每种可能的上下拉范围都计算出了最终形成的电压范围，如下表。
CC检测芯片会检测这个电压，通过判断电压范围来决定下一步操作。下表是CC管脚上不同的电压对应的DFP能提供的电流能力。第二列列出的每一种电压范围，都分别覆盖了上表计算出的电压。Rp/Ra的计算是同理的。
3.3 数据线上的Ra 带电子标签的线缆，其中一个CC管脚被更名为VCONN，用于给电子标签芯片供电。这个VCONN管脚与GND之间需要一个Ra电阻，这个电阻值范围是800Ω~1.2KΩ。
3.4 VCONN电源 VCONN的允许范围是4.75V~5.5V，要求供电能力是1W。默认情况下DFP提供这个电源。如果两个DRP连接，则双方可以通过USB PD协议协商来交换VCONN供电方。
支持PD的USB3.0接口均需支持VCONN，可以通过下面两种方式之一提供VCONN电源。
如果其中一个CC引脚上检测到有效的Rp/Rd连接，则VCONN电源可以接到另一个对应的CC引脚。如果其中一个CC引脚上检测到有效的Rp/Rd连接，先检查另一个CC引脚是否也有Rp/Ra连接，然后再提供VCONN。先检测是否有Ra存在，如果有说明需要Vconn供电，此时再提供Vconn。检测过程不需要Vconn存在。
注意，每一个CC引脚内部都有一个开关，轮训CC和VCONN功能，下图是一个典型的连接方式： 4 手机都是DRP 现实中，我们的手机都是DRP，既能做DFP，又能做UFP，那么是如何切换呢？
DRP在待机模式下每50ms在DFP和UFP间切换一次。当切换至DFP时，CC管脚上必须有一个上拉至VBUS的电阻Rp或者输出一个电流源，当切换至UFP时，CC管脚上必须有一个下拉至GND的电阻Rd。此切换动作必须由CC Logic芯片来完成。当DFP检测到UFP插入之后才可以输出VBUS，当UFP拔出以后必须关闭VBUS。此动作必须由CC Logic芯片来完成。下面是一个CC逻辑芯片框图，CC上有一个开关，在不断切换功能。
USB Power Delivery 2.0
这个是由USB-IF制定的单线协议，在CC线上传输，用于协商供电角色，电压，最大供电能力，数据角色，备用模式等，端口与供电电缆之间的通信业通过PD协议进行。协议不做展开，详见USB-IF官网。下面是协议的几个特点：
所有通信均通过CC线。
DFP是总线主设备，用于发起所有通信。
所有消息均采用32bit 4b/5b编码的双向标记编码（Bi-phase Mark Coded，BMC）
300K波特率
CRC32错误检验&#43;消息重试
Type-C线缆规范
线缆至少支持10000次拔插。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/2844f089cfb263c55cd16cb903c2b514/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-29T11:31:40+08:00" />
<meta property="article:modified_time" content="2024-01-29T11:31:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Type-C协议-CC检测原理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><img alt="" height="202" src="https://images2.imgbox.com/74/7b/Ye4buaUk_o.png" width="789"></p> 
<p><img alt="" height="440" src="https://images2.imgbox.com/5c/68/zwALAkK0_o.png" width="854"></p> 
<p>Type-C连接器中有两个管脚CC1和CC2，他们用于识别连接器的插入方向，以及不同的插入设备。本文介绍CC的基本识别原理。</p> 
<p>先介绍几个概念：<br> DFP——Downstream Facing Port，也就是Host<br> UFP——Upstream Facing Port，也就是Device<br> DRP——Dual Role port，既可以做DFP，也可以做UFP。</p> 
<p>在建立连接之前，DRP的角色在DFP和UPF之间切换。如果两个DRP连接，最先随机到那种角色后开始建立连接，之后可以通过USB协议协商进行动态切换。</p> 
<p>USB Type-C插座和插头的两排管脚对称，USB数据信号都有两组重复的通道，<span style="color:#fe2c24;">但主控芯片通常只有一组TX/RX和D+/-通道（某些芯片有两组TX/RX和D+/-通道）。</span></p> 
<p>由于USB2.0的数据率最高只有480Mbps, 可以不考虑信号走线的阻抗连续性，USB2.0的D+/-信号可以不被MUX控制而直接从主控芯片走线，然后一分二连接至USB Type-C插座的两组D+/-管脚上。</p> 
<p>但USB3.0或者USB3.1的数据率高达5Gbps或者10Gbps，<span style="color:#fe2c24;">如果信号线还是被简单地一分二的话，不连续的信号线阻抗将严重破坏数据传输质量</span>，因<span style="color:#fe2c24;">此必须由MUX切换来保证信号路径阻抗的一致性，以确保信号传输质量。</span></p> 
<p>下图中右侧所示的MUX从TX1/RX1和TX2/RX2中选择一路连接至主控芯片，而这个MUX就必须被CC管脚控制。</p> 
<p>在USB2.0应用中，无需考虑CC方向检测问题，但USB3.0或者USB3.1应用中，必须考虑CC方向检测问题。</p> 
<p><img alt="" height="353" src="https://images2.imgbox.com/81/d6/FyCZ2Z7s_o.png" width="752"></p> 
<p>注意UFP，比如U盘，移动硬盘内部不需要CC逻辑检测，因为它是上行，只有一对USB2.0或USB3.0信号，如下图</p> 
<p><img alt="" height="331" src="https://images2.imgbox.com/13/e2/UqWL5TtS_o.png" width="727"></p> 
<h3>3 CC检测原理</h3> 
<p>CC信号有两根线，CC1和CC2，大部分USB线（不带芯片的线缆）里面只有一根CC线，DFP可根据两根CC线上的电压，判断是否已经插入设备。通过判断哪根CC线上有下拉电阻来判断方向，下图的说明已经非常清晰。</p> 
<p><img alt="" height="433" src="https://images2.imgbox.com/77/6a/BIiQA2Qr_o.png" width="725"></p> 
<p>如果CC1引脚检测到有效的Rp/Rd连接（对应的电压），则认为电缆连接未翻转。<br> 如果CC2引脚检测到有效的Rp/Rd连接（对应的电压），则认为电缆连接已翻转。</p> 
<p>“有效的Rp/Rd连接”指在CC上形成了有效的电压。<br> 从DFP的角度看，下表列出了所有可能的连接状态，</p> 
<p><img alt="" height="289" src="https://images2.imgbox.com/66/ee/BHZCsDwD_o.png" width="875"></p> 
<p>以上只是介绍了CC检测中判断是否翻转的原理，两个CC信号还有向UPF通告DFP提供电流能力的功能等，见下文</p> 
<h3>3.1 DFP的上拉电阻Rp</h3> 
<p><span style="color:#fe2c24;">DFP的CC1和CC2信号上都必须有上拉电阻Rp，上拉到5V或3.3V</span>。或者CC1和CC2都用电流源上拉。最终的目的是在插入后，能检测到CC1或CC2上的电压，进而判断是否翻转以及DFP的电流能力。如下是所有可能的配置。可以选择右边三列中的任何一列作为上拉方式，比如Fairchild的FUSB300就是用330uA上拉，TI的TUSB320LAI用的是80uA的上拉，不同的上拉方式在CC引脚上形成的电压不同，不同的电压对应不同的电流能力。</p> 
<p><img alt="" height="171" src="https://images2.imgbox.com/47/a3/Imi59Vkt_o.png" width="705"></p> 
<h3>3.2 UPF的Rd</h3> 
<p>UFP的CC1和CC2管脚都要有一个下拉电阻Rd到GND（或者使用电压钳位）。Rd的处理方式如下表。</p> 
<p><img alt="" height="172" src="https://images2.imgbox.com/65/5c/lSbpm2fR_o.png" width="741"></p> 
<p>注意，最后一列的电流源连接至的电压，是指3.1节中表格的最后一列电流源的上拉电压。<br> 结合这个表格，和3.1节的表格，我们把每种可能的上下拉范围都计算出了最终形成的电压范围，如下表。</p> 
<p><img alt="" height="174" src="https://images2.imgbox.com/47/90/Gr69Sssf_o.png" width="772"></p> 
<p>CC检测芯片会检测这个电压，通过判断电压范围来决定下一步操作。下表是C<span style="color:#fe2c24;">C管脚上不同的电压对应的DFP能提供的电流能力</span>。第二列列出的每一种电压范围，都分别覆盖了上表计算出的电压。Rp/Ra的计算是同理的。</p> 
<p><img alt="" height="130" src="https://images2.imgbox.com/99/37/jXCQdm6l_o.png" width="880"></p> 
<h3>3.3 数据线上的Ra</h3> 
<p><span style="color:#fe2c24;">带电子标签的线缆，其中一个CC管脚被更名为VCONN，用于给电子标签芯片供电</span>。这个VCONN管脚与GND之间需要一个Ra电阻，这个电阻值范围是800Ω~1.2KΩ。</p> 
<h3>3.4 VCONN电源</h3> 
<p>VCONN的允许范围是4.75V~5.5V，要求供电能力是1W。默认情况下DFP提供这个电源。如果两个DRP连接，则双方可以通过USB PD协议协商来交换VCONN供电方。<br> 支持PD的USB3.0接口均需支持VCONN，可以通过下面两种方式之一提供VCONN电源。</p> 
<ol><li>如果其中一个CC引脚上检测到有效的Rp/Rd连接，则VCONN电源可以接到另一个对应的CC引脚。</li><li>如果其中一个CC引脚上检测到有效的Rp/Rd连接，先检查另一个CC引脚是否也有Rp/Ra连接，然后再提供VCONN。</li><li>先检测是否有Ra存在，如果有说明需要Vconn供电，此时再提供Vconn。检测过程不需要Vconn存在。<br> 注意，每一个CC引脚内部都有一个开关，轮训CC和VCONN功能，下图是一个典型的连接方式：<img alt="" height="271" src="https://images2.imgbox.com/b6/e6/7elvhFQK_o.png" width="730"></li><li> <h3>4 手机都是DRP</h3> <p>现实中，我们的手机都是DRP，既能做DFP，又能做UFP，那么是如何切换呢？<br><span style="color:#fe2c24;">DRP在待机模式下每50ms在DFP和UFP间切换一次</span>。当切换至DFP时，CC管脚上必须有一个上拉至VBUS的电阻Rp或者输出一个电流源，当切换至UFP时，CC管脚上必须有一个下拉至GND的电阻Rd。此切换动作必须由CC Logic芯片来完成。当DFP检测到UFP插入之后才可以输出VBUS，当UFP拔出以后必须关闭VBUS。此动作必须由CC Logic芯片来完成。下面是一个CC逻辑芯片框图，CC上有一个开关，在不断切换功能。</p> </li><li> <p><img alt="" height="650" src="https://images2.imgbox.com/3a/a8/Q16RW18M_o.png" width="857"></p> <p>USB Power Delivery 2.0</p> <p>这个是由USB-IF制定的单线协议，在CC线上传输，用于协商供电角色，电压，最大供电能力，数据角色，备用模式等，端口与供电电缆之间的通信业通过PD协议进行。协议不做展开，详见USB-IF官网。下面是协议的几个特点：</p> <p>所有通信均通过CC线。</p> <p>DFP是总线主设备，用于发起所有通信。</p> <p>所有消息均采用32bit 4b/5b编码的双向标记编码（Bi-phase Mark Coded，BMC）</p> <p>300K波特率</p> <p>CRC32错误检验+消息重试</p> <p></p> </li><li> <p>Type-C线缆规范</p> <p>线缆至少支持10000次拔插。</p> <p>不规定信号线规，但是必须保证USB2.0和USB3.0的信号完整性</p> <p>CC和SUB1/SUB2线上的阻抗不大于50Ω</p> <p>GND返回路径上的最大IR压降为250mV</p> <p>Vbus上的最大IR压降为500mV</p> <p>USB Type-C规范中并未明确规定线缆长度，但是电器要求产生了一些物理限制。USB3.1 Type-C转<span style="color:#fe2c24;">Type-C电缆组件在5GHz下的插入损耗指定为为-6dB，</span>从而将电缆长度有效限制为1米。U<span style="color:#fe2c24;">SB3.0 Type-C转Type-C电缆组件在5GHz下的插入损耗指定为为-7dB</span>，从而将电缆长度有效限制为2米。<img alt="" height="197" src="https://images2.imgbox.com/70/51/Q9eSSTR5_o.png" width="734"></p> </li><li> <p>带电子标签的Type-C数据线</p> <p>如果<span style="color:#fe2c24;">Type-C数据线上带了芯片（我们称之为电子标签）</span>，这个芯片可以通过USB供电规范2.0 BMC协议与USB端口通信。电子标签电缆可用VCONN供电，也可以直接由Vbus供电，最高可消耗70mW的功率。如下类型的电缆必须要电子标签：</p> <p>兼容USB3.1的USB Type-C电缆</p> <p>100W供电电缆。能够实现60W以上功率承载能力的任何电缆都必须有电子标签，并且能够与DFP端口通信。</p> <p>带电子标签的电缆如果插入不支持USB供电规范2.0的插座中，其行为与标准的无源电缆完全相同。</p> </li><li> <p>音频配件模式</p> <p>8.1 数字耳机</p> <p>Type-C接口的数字耳机是一个UFP（Device），手机是DFP。耳机的CC1和CC2引脚上必须有Rd，实际上，乐视数字耳机的CC管脚上有一颗5.1K电阻。</p> <p>8.2 模拟耳机</p> <p>协议要求模拟耳机转接线上把两个CC引脚直接接到GND（必须小于Ra）<img alt="" height="607" src="https://images2.imgbox.com/96/a3/BLrZtgtN_o.png" width="867"></p> </li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3ddfdf33bf6ad88af73e5f6fc0b1a7ff/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">想用免费chat GPT？这里有你的答案（副链接）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/85dd01dce58e2aa383782ee86674e2e1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ubuntu18.04 安装anaconda</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>