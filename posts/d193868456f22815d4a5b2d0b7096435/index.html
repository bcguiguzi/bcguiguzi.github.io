<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>编写简单的WDF驱动程序 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="编写简单的WDF驱动程序" />
<meta property="og:description" content="编写简单的WDF驱动程序 在创建新的KMDF或UMDF程序时，必须选择一个不多于32个字符的驱动程序名称。此长度限制在wdfglobals.h中定义。如果驱动程序的名称超出最大尺度，则驱动程序无法加载。每个基于框架的驱动程序都包含一个DriverEntry例程和一组事件回调函数，框架在发生特定于对象的事件时将调用该函数。 基于框架的简单驱动程序可能由以下内容组成： DriverEntry例程，在加载驱动程序并调用WdfDriverCreate时调用。
一个EvtDriverDeviceAdd事件回调函数，当即插即用（PnP）管理器使用与驱动程序支持的硬件ID匹配的硬件标识符（ID）报告设备检测时，框架将调用该函数。
可以通过提供一个INF文件来指定驱动程序支持的硬件ID，操作系统会在第一次将设备连接到计算机时使用该文件来安装驱动程序。
驱动程序的EvtDriverDeviceAdd回调函数调用WdfDeviceCreate为检测到的设备创建框架设备对象。
当i/o管理器向驱动程序发送i/o请求时，框架调用请求处理程序（如EvtIoDefault回调函数）。
当i/o管理器将i/o请求发送到驱动程序时，框架会将请求放入i/o队列，然后通过调用请求处理程序通知你的驱动程序。
驱动程序必须为每个设备创建至少一个i/o队列，以便驱动程序可以接收设备的i/o请求。若要创建i/o队列，驱动程序将调用WdfQueueCreate，这将创建一个框架队列对象并注册设备的请求处理程序。
WDF驱动程序例程的DriverEntry DriverEntry是加载驱动程序后调用的第一个驱动程序提供的例程。它负责初始化驱动程序。
语法
NTSTATUS DriverEntry( _In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath ); 参数
DriverObject：指向驱动程序_对象结构的指针，该结构表示驱动程序的WDM驱动程序对象。
RegistryPath：指向UNICODE_字符串结构的指针，该字符串结构指定注册表中驱动程序的Parameters项的路径。
返回值
如果例程成功，则必须返回状态“_成功”，否则，它必须返回在ntstatus中定义的错误状态值之一。
备注
与所有WDM驱动程序一样，基于框架的驱动程序必须具有DriverEntry例程，该例程是在加载驱动程序后调用的。基于框架的驱动程序的DriverEntry例程必须：
激活WPP软件跟踪
DriverEntry应包含一个WPP_INIT_TRACING宏来激活软件跟踪。调用WdfDriverCreate
对WdfDriverCreate的调用使驱动程序可以使用Windows驱动程序框架接口。在调用WdfDriverCreate之前，驱动程序无法调用其他框架例程。分配任何特定于设备的系统资源和可能需要的全局变量
通常驱动程序将系统资源与单个设备相关联。因此，基于框架的驱动程序在EvtDriverDeviceAdd回调中分配大多数资源，在检测到各个设备时将调用该回调。因为UMDF驱动程序的多个实例可能由单独的Wudfhost实例托管，所以全局变量可能无法在UMDF驱动程序的所有实例中使用。从注册表获取驱动程序特定的参数
某些驱动程序从注册表中获取参数，这些驱动程序可以调用WdfDriverOpenParametersRegistryKey来打开包含这些参数的注册表项。提供DriverEntry返回值 串行（KMDF）示例驱动程序的DriverEntry例程 NTSTATUS DriverEntry( IN PDRIVEROBJECT DriverObject， IN PUNICODE RegistryPath ) { WDF_DRIVER_CONFIG config; WDFDRIVER hDriver; NTSTATUS status; WDF_OBJECT_ATTRIBUTES attributes; SERIAL_FIRMWARE_DATA driverDefaults; //初始化WPP 跟踪 WPP_INIT_TRACING( DriverObject, RegistryPath ); SerialDbgPrintEx( TRACING_LEVEL_INFORMATION, DBG_INIT, &#34;Serial Sample (WDF Version) - Built %s %s\n&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/d193868456f22815d4a5b2d0b7096435/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-02-24T12:05:28+08:00" />
<meta property="article:modified_time" content="2021-02-24T12:05:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">编写简单的WDF驱动程序</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="WDF_0"></a>编写简单的WDF驱动程序</h3> 
<ul><li>在创建新的KMDF或UMDF程序时，必须选择一个不多于32个字符的驱动程序名称。此长度限制在<strong>wdfglobals.h</strong>中定义。如果驱动程序的名称超出最大尺度，则驱动程序无法加载。</li><li>每个基于框架的驱动程序都包含一个<strong>DriverEntry</strong>例程和一组事件回调函数，框架在发生特定于对象的事件时将调用该函数。</li></ul> 
<h4><a id="_4"></a>基于框架的简单驱动程序可能由以下内容组成：</h4> 
<ul><li> <p><strong>DriverEntry</strong>例程，在加载驱动程序并调用<strong>WdfDriverCreate</strong>时调用。</p> </li><li> <p>一个<strong>EvtDriverDeviceAdd</strong>事件回调函数，当即插即用（PnP）管理器使用与驱动程序支持的硬件ID匹配的硬件标识符（ID）报告设备检测时，框架将调用该函数。</p> <p>可以通过提供一个INF文件来指定驱动程序支持的硬件ID，操作系统会在第一次将设备连接到计算机时使用该文件来安装驱动程序。<br> 驱动程序的<strong>EvtDriverDeviceAdd</strong>回调函数调用<strong>WdfDeviceCreate</strong>为检测到的设备创建框架设备对象。</p> </li><li> <p>当i/o管理器向驱动程序发送i/o请求时，框架调用请求处理程序（如<strong>EvtIoDefault</strong>回调函数）。<br> 当i/o管理器将i/o请求发送到驱动程序时，框架会将请求放入i/o队列，然后通过调用请求处理程序通知你的驱动程序。<br> 驱动程序必须为每个设备创建至少一个i/o队列，以便驱动程序可以接收设备的i/o请求。若要创建i/o队列，驱动程序将调用<strong>WdfQueueCreate</strong>，这将创建一个框架队列对象并注册设备的请求处理程序。</p> </li></ul> 
<h4><a id="WDFDriverEntry_14"></a>WDF驱动程序例程的DriverEntry</h4> 
<ul><li> <p><strong>DriverEntry</strong>是加载驱动程序后调用的第一个驱动程序提供的例程。它负责初始化驱动程序。</p> </li><li> <p>语法</p> <pre><code>NTSTATUS DriverEntry(
	_In_ PDRIVER_OBJECT DriverObject,
	_In_ PUNICODE_STRING RegistryPath
);
</code></pre> </li><li> <p>参数</p> <p><strong>DriverObject</strong>：指向<strong>驱动程序_对象</strong>结构的指针，该结构表示驱动程序的WDM驱动程序对象。</p> <p><strong>RegistryPath</strong>：指向<strong>UNICODE_字符串</strong>结构的指针，该字符串结构指定注册表中驱动程序的<strong>Parameters项</strong>的路径。</p> </li><li> <p>返回值<br> 如果例程成功，则必须返回状态“_成功”，否则，它必须返回在ntstatus中定义的错误状态值之一。</p> </li><li> <p><strong>备注</strong><br> 与所有WDM驱动程序一样，基于框架的驱动程序必须具有<strong>DriverEntry</strong>例程，该例程是在加载驱动程序后调用的。基于框架的驱动程序的<strong>DriverEntry</strong>例程必须：</p> 
  <ul><li>激活WPP软件跟踪<br> DriverEntry应包含一个WPP_INIT_TRACING宏来激活软件跟踪。</li><li>调用WdfDriverCreate<br> 对WdfDriverCreate的调用使驱动程序可以使用Windows驱动程序框架接口。在调用WdfDriverCreate之前，驱动程序无法调用其他框架例程。</li><li>分配任何特定于设备的系统资源和可能需要的全局变量<br> 通常驱动程序将系统资源与单个设备相关联。因此，基于框架的驱动程序在<strong>EvtDriverDeviceAdd</strong>回调中分配大多数资源，在检测到各个设备时将调用该回调。因为UMDF驱动程序的多个实例可能由单独的Wudfhost实例托管，所以全局变量可能无法在UMDF驱动程序的所有实例中使用。</li><li>从注册表获取驱动程序特定的参数<br> 某些驱动程序从注册表中获取参数，这些驱动程序可以调用<strong>WdfDriverOpenParametersRegistryKey</strong>来打开包含这些参数的注册表项。</li><li>提供<strong>DriverEntry</strong>返回值</li></ul> </li></ul> 
<h4><a id="KMDFDriverEntry_43"></a>串行（KMDF）示例驱动程序的DriverEntry例程</h4> 
<pre><code class="prism language-C++">NTSTATUS
DriverEntry(
	IN PDRIVEROBJECT DriverObject，
	IN PUNICODE RegistryPath
	)
{
	WDF_DRIVER_CONFIG config;
	WDFDRIVER hDriver;
	NTSTATUS status;
	WDF_OBJECT_ATTRIBUTES attributes;
	SERIAL_FIRMWARE_DATA driverDefaults;

	//初始化WPP 跟踪
	WPP_INIT_TRACING(
						DriverObject,
						RegistryPath
						);
	SerialDbgPrintEx(
						TRACING_LEVEL_INFORMATION,
						DBG_INIT,
						"Serial Sample (WDF Version) - Built %s %s\n",
						__DATE__,__TIME__
							);
	WDF_OBJECT_CONFIG_INIT(
							&amp;config,
							SerialEvtDeviceAdd
							);
	status = WdfDriverCreate(
								DriverObject,
								RegistryPath,
								&amp;attributes,
								&amp;config,
								&amp;hDriver
								);
	if(!NT_SUCCESS(status)){
		SreialDbgPrintEx(
							TRACE_LEVEL_ERROR,
							DBG_INIT,
							"WdfDriverCreate failed with status 0x%x\n",
							ststus
							);
		WPP_CLEANUP(DriverObject);
		return status;
	}
	SerialGetConfigDefaults(
								&amp;driverDefaults,
								hDriver
								);
	if(driverDefaults.ShouldBreakOnEntry){
		DbgBreakPoint();
	}
	return status;
}
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8b4066d0effe2296ae95731359ca2763/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">java zk客户端连接_关于java:java客户端连接Zookeeper服务器慢</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/01ba4b8c7271757a4682b7a9175f7964/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">UndefinedError: ‘int object’ has no attribute ‘endswith’</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>