<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring Session Data Redis实现session共享 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Spring Session Data Redis实现session共享" />
<meta property="og:description" content="1.前言
在开发中遇到一个关于用户体验的问题，每次当运维进行更新重启服务器时，都会导致会员平台中已登录的用户掉线。这是因为每个用户的会话信息及状态都是由session来保存的，而session对象是由服务器创建，并把session的Id以cookie的形式发送给客户端浏览器的（每个会话都有一个单独的sessionID）。当这个对象超过一定时间没有被使用或者服务器重启时，对象就会被销毁，也就导致了用户掉线。
2.解决办法
在解决问题过程中发现，只要记住了刚才用户的sessionID，重启服务器后仍使用原来的id，就不会掉线，也就是说要保证session不被改变才可以保持用户的登录状态。在这里使用了Spring Session Data Redis来实现session的共享（redis：高速缓存数据库），也就是说使用redis对session进行一个持久化操作（用mysql等数据库来单独存储session有点浪费了，速度也没有redis快），当服务器重启时，可以从redis中反序列化取出session，重新获取用户会话信息。
简要配置步骤：
（1）pom.xml加入依赖：spring-session-data-redis、spring-session，当然前提要有spring（4.3.5）、redis的依赖（redis使用了3.0版本）
1 &lt;dependency&gt; 2 &lt;groupId&gt;org.springframework.session&lt;/groupId&gt; 3 &lt;artifactId&gt;spring-session-data-redis&lt;/artifactId&gt; 4 &lt;version&gt;1.3.2.RELEASE&lt;/version&gt; 5 &lt;/dependency&gt; 6 &lt;dependency&gt; 7 &lt;groupId&gt;org.springframework.session&lt;/groupId&gt; 8 &lt;artifactId&gt;spring-session&lt;/artifactId&gt; 9 &lt;version&gt;1.3.2.RELEASE&lt;/version&gt; 10 &lt;/dependency&gt; （2）applicationContext.xml配置文件中增加RedisHttpSessionConfiguration（下面是单独的配置文件，然后import进去）
1 &lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt; 2 &lt;beans xmlns=&#34;http://www.springframework.org/schema/beans&#34; 3 xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34; 4 xmlns:p=&#34;http://www.springframework.org/schema/p&#34; 5 xsi:schemaLocation=&#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&#34;&gt; 6 &lt;bean id=&#34;jedisPoolConfig&#34; class=&#34;redis.clients.jedis.JedisPoolConfig&#34; &gt; 7 &lt;property name=&#34;maxIdle&#34; value=&#34;0&#34; /&gt; 8 &lt;property name=&#34;maxTotal&#34; value=&#34;20&#34; /&gt; 9 &lt;property name=&#34;maxWaitMillis&#34; value=&#34;1000&#34; /&gt; 10 &lt;property name=&#34;testOnBorrow&#34; value=&#34;true&#34; /&gt; 11 &lt;/bean&gt; 12 13 &lt;!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/4472582251363290a935bc06e25084de/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-08-21T14:53:02+08:00" />
<meta property="article:modified_time" content="2018-08-21T14:53:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring Session Data Redis实现session共享</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>1.前言</strong></p> 
<p>　　在开发中遇到一个关于用户体验的问题，每次当运维进行更新重启服务器时，都会导致会员平台中已登录的用户掉线。这是因为每个用户的会话信息及状态都是由session来保存的，而session对象是由服务器创建，并把session的Id以cookie的形式发送给客户端浏览器的（每个会话都有一个单独的sessionID）。当这个对象超过一定时间没有被使用或者服务器重启时，对象就会被销毁，也就导致了用户掉线。</p> 
<p><strong>2.解决办法</strong></p> 
<p>　　在解决问题过程中发现，只要记住了刚才用户的sessionID，重启服务器后仍使用原来的id，就不会掉线，也就是说要保证session不被改变才可以保持用户的登录状态。在这里使用了Spring Session Data Redis来实现session的共享（redis：高速缓存数据库），也就是说使用redis对session进行一个持久化操作（用mysql等数据库来单独存储session有点浪费了，速度也没有redis快），当服务器重启时，可以从redis中反序列化取出session，重新获取用户会话信息。</p> 
<p>　　简要配置步骤：</p> 
<p>　　（1）pom.xml加入依赖：spring-session-data-redis、spring-session，当然前提要有spring（4.3.5）、redis的依赖（redis使用了3.0版本）</p> 
<pre> 1 &lt;dependency&gt;
 2     &lt;groupId&gt;org.springframework.session&lt;/groupId&gt;
 3     &lt;artifactId&gt;spring-session-data-redis&lt;/artifactId&gt;
 4     &lt;version&gt;1.3.2.RELEASE&lt;/version&gt;
 5 &lt;/dependency&gt;
 6 &lt;dependency&gt;
 7     &lt;groupId&gt;org.springframework.session&lt;/groupId&gt;
 8     &lt;artifactId&gt;spring-session&lt;/artifactId&gt;
 9     &lt;version&gt;1.3.2.RELEASE&lt;/version&gt;
10 &lt;/dependency&gt;</pre> 
<p>　　（2）applicationContext.xml配置文件中增加RedisHttpSessionConfiguration（下面是单独的配置文件，然后import进去）</p> 
<pre> 1 &lt;?xml version="1.0" encoding="UTF-8"?&gt;
 2 &lt;beans xmlns="http://www.springframework.org/schema/beans"
 3        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 4        xmlns:p="http://www.springframework.org/schema/p"
 5        xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;
 6     &lt;bean id="jedisPoolConfig" class="redis.clients.jedis.JedisPoolConfig" &gt;
 7         &lt;property name="maxIdle" value="0" /&gt;
 8         &lt;property name="maxTotal" value="20" /&gt;
 9         &lt;property name="maxWaitMillis" value="1000" /&gt;
10         &lt;property name="testOnBorrow" value="true" /&gt;
11     &lt;/bean&gt;
12 
13     &lt;!-- redis连接配置，依次为主机ip，端口，是否使用池，(usePool=true时)redis的池配置 --&gt;
14     &lt;bean id="connectionFactory" class="org.springframework.data.redis.connection.jedis.JedisConnectionFactory"
15           p:host-name="0.0.0.0" p:port="1111" p:database="10" p:pool-config-ref="jedisPoolConfig"&gt;
16     &lt;/bean&gt;
17 
18     &lt;!-- 配置spring-session --&gt;
19     &lt;bean class="org.springframework.session.data.redis.config.annotation.web.http.RedisHttpSessionConfiguration"&gt;
20         &lt;!-- 过期时间100分钟 --&gt;
21         &lt;property name="maxInactiveIntervalInSeconds" value="6000"&gt;&lt;/property&gt;
22     &lt;/bean&gt;
23 &lt;/beans&gt;</pre> 
<p>　　（3）web.xml中配置filter、session超时时间</p> 
<pre> 1 &lt;filter&gt;
 2     &lt;filter-name&gt;springSessionRepositoryFilter&lt;/filter-name&gt;
 3     &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
 4 &lt;/filter&gt;
 5 &lt;filter-mapping&gt;
 6     &lt;filter-name&gt;springSessionRepositoryFilter&lt;/filter-name&gt;
 7     &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
 8 &lt;/filter-mapping&gt;
 9 &lt;session-config&gt;
10     &lt;!--60*60*24--&gt;
11     &lt;session-timeout&gt;86400&lt;/session-timeout&gt;
12 &lt;/session-config&gt;</pre> 
<p>　　配置完成后，基本就可以实现Session的共享了，重启服务器测试，已经登录的用户也不会发生掉线的情况了。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d1aab38bc32b2f7a3cfe71a1c0133593/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">HUSTOJ特判程序Special Judge使用方法整理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1ceb9f0011a2f8fe1d3f1675d3e4d340/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[学习][Math](几何)欧拉公式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>