<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ElasticSearch 8.x 使用 High Level Client 以 HTTPS 方式链接，SSL 证书、主机名验证器 各是什么，如何忽略 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ElasticSearch 8.x 使用 High Level Client 以 HTTPS 方式链接，SSL 证书、主机名验证器 各是什么，如何忽略" />
<meta property="og:description" content="ElasticSearch 1、ElasticSearch学习随笔之基础介绍
2、ElasticSearch学习随笔之简单操作
3、ElasticSearch学习随笔之java api 操作
4、ElasticSearch学习随笔之SpringBoot Starter 操作
5、ElasticSearch学习随笔之嵌套操作
6、ElasticSearch学习随笔之分词算法
7、ElasticSearch学习随笔之高级检索
8、ELK技术栈介绍
9、Logstash部署与使用
10、ElasticSearch 7.x 版本使用 BulkProcessor 实现批量添加数据
11、ElasticSearch 8.x 弃用了 High Level REST Client，移除了 Java Transport Client，推荐使用 Elasticsearch Java API
12、ElasticSearch 8.x 使用 snapshot（快照）进行数据迁移
13、ElasticSearch 8.x 版本如何使用 SearchRequestBuilder 检索
14、ElasticSearch 8.x 使用 High Level Client 以 HTTPS 方式链接，SSL 证书、主机名验证器 各是什么，如何忽略
15、ElasticSearch 8.x 创建父子文档，用Join类型字段以及用has_child、has_parent 检索
ElasticSearch，创始人 Shay Banon（谢巴农）
本文主要讲解ElasticSearch 高级搜索实战，来满足复杂的业务场景，还是用 Kibana 来操作。
文章目录 ElasticSearch前言一：pom 依赖二：开放式连接方式三：用户名密码验证方式四：忽略 SSL证书 和 主机名验证4.1 忽略 SSL 认证方式一方式二方式三 4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/fb4cbec07b4ef43d769ffd4742bd2146/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-29T10:50:47+08:00" />
<meta property="article:modified_time" content="2024-02-29T10:50:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ElasticSearch 8.x 使用 High Level Client 以 HTTPS 方式链接，SSL 证书、主机名验证器 各是什么，如何忽略</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="ElasticSearch_0"></a>ElasticSearch</h2> 
<p>1、<a href="https://blog.csdn.net/qq_19283249/article/details/124222352">ElasticSearch学习随笔之基础介绍</a><br> 2、<a href="https://blog.csdn.net/qq_19283249/article/details/124225211">ElasticSearch学习随笔之简单操作</a><br> 3、<a href="https://blog.csdn.net/qq_19283249/article/details/124227307">ElasticSearch学习随笔之java api 操作</a><br> 4、<a href="https://blog.csdn.net/qq_19283249/article/details/124832230">ElasticSearch学习随笔之SpringBoot Starter 操作</a><br> 5、<a href="https://blog.csdn.net/qq_19283249/article/details/127000665">ElasticSearch学习随笔之嵌套操作</a><br> 6、<a href="https://blog.csdn.net/qq_19283249/article/details/130470805">ElasticSearch学习随笔之分词算法</a><br> 7、<a href="https://blog.csdn.net/qq_19283249/article/details/130473909">ElasticSearch学习随笔之高级检索</a><br> 8、<a href="https://blog.csdn.net/qq_19283249/article/details/130790590">ELK技术栈介绍</a><br> 9、<a href="https://blog.csdn.net/qq_19283249/article/details/130839158">Logstash部署与使用</a><br> 10、<a href="https://blog.csdn.net/qq_19283249/article/details/135352497">ElasticSearch 7.x 版本使用 BulkProcessor 实现批量添加数据</a><br> 11、<a href="https://blog.csdn.net/qq_19283249/article/details/135352522">ElasticSearch 8.x 弃用了 High Level REST Client，移除了 Java Transport Client，推荐使用 Elasticsearch Java API</a><br> 12、<a href="https://blog.csdn.net/qq_19283249/article/details/135581208">ElasticSearch 8.x 使用 snapshot（快照）进行数据迁移</a><br> 13、<a href="https://blog.csdn.net/qq_19283249/article/details/135818373">ElasticSearch 8.x 版本如何使用 SearchRequestBuilder 检索</a><br> 14、<a href="https://blog.csdn.net/qq_19283249/article/details/135971652">ElasticSearch 8.x 使用 High Level Client 以 HTTPS 方式链接，SSL 证书、主机名验证器 各是什么，如何忽略</a><br> 15、<a href="https://blog.csdn.net/qq_19283249/article/details/136041108">ElasticSearch 8.x 创建父子文档，用Join类型字段以及用has_child、has_parent 检索</a></p> 
<p>ElasticSearch，创始人 Shay Banon（谢巴农）<br> 本文主要讲解ElasticSearch 高级搜索实战，来满足复杂的业务场景，还是用 Kibana 来操作。</p> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#ElasticSearch_0" rel="nofollow">ElasticSearch</a></li><li><a href="#_28" rel="nofollow">前言</a></li><li><a href="#pom__32" rel="nofollow">一：pom 依赖</a></li><li><a href="#_41" rel="nofollow">二：开放式连接方式</a></li><li><a href="#_43" rel="nofollow">三：用户名密码验证方式</a></li><li><a href="#_SSL___58" rel="nofollow">四：忽略 SSL证书 和 主机名验证</a></li><li><ul><li><a href="#41__SSL__60" rel="nofollow">4.1 忽略 SSL 认证</a></li><li><ul><li><a href="#_74" rel="nofollow">方式一</a></li><li><a href="#_124" rel="nofollow">方式二</a></li><li><a href="#_152" rel="nofollow">方式三</a></li></ul> 
   </li><li><a href="#42___186" rel="nofollow">4.2 忽略 主机名验证</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_28"></a>前言</h2> 
<p>在平时测试环境中，我们可以通过 <strong>IP 地址</strong> 或者 域名【<code>http://***</code>】来简单粗暴的连接 <code>ElasticSearch</code> 服务，比较内网测试没必要考虑别的，连接上能进行索引的操作即可；不过到了生产环境，安全问题成了 <strong>头号杀手</strong>，毕竟数据无价嚒，不过目前很多企业应用都会部署到云端，<strong>应用</strong> 和 <code>ElasticSearch</code> 服务之前其实也是属于内网连接，并不会暴漏链接到外面，再加上云服务自身的安全和防火前的保护，所以安全基本上不用考虑了。<br> 可以公司是有规范的，无论是 DB 数据库还是缓存，还是像 ElasticSearch 这种搜索引擎必须要有 <strong>用户名和密码</strong> 这层安全校验的，这是安全最基本的，所以应对不同的环境 <strong>或许</strong> 就需要不同的连接方式了。</p> 
<h2><a id="pom__32"></a>一：pom 依赖</h2> 
<p>对于 ElasticSearch 客户端的版本，不需要太高，稳定很重要，<strong>对于有些莫名其妙的问题，换一个 版本的 客户端有可能就好了，亲身经历</strong>。</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>elasticsearch<span class="token operator">-</span>rest<span class="token operator">-</span>high<span class="token operator">-</span>level<span class="token operator">-</span>client<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">7.15</span><span class="token number">.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<h2><a id="_41"></a>二：开放式连接方式</h2> 
<h2><a id="_43"></a>三：用户名密码验证方式</h2> 
<p>这种方式在其他博客中已经提到好几次了，放到这里只为有需要的 <strong>码友</strong> 们拷贝代码。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> hostname <span class="token operator">=</span> <span class="token string">"192.168.0.67"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token number">9200</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> esUsername <span class="token operator">=</span> <span class="token string">"your es username"</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> esPassword <span class="token operator">=</span> <span class="token string">"your es password"</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">CredentialsProvider</span> credentialsProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicCredentialsProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    credentialsProvider<span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span><span class="token class-name">AuthScope</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentials</span><span class="token punctuation">(</span>esUsername<span class="token punctuation">,</span> esPassword<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RestClientBuilder</span> restClientBuilder <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setHttpClientConfigCallback</span><span class="token punctuation">(</span>httpAsyncClientBuilder <span class="token operator">-&gt;</span> httpAsyncClientBuilder<span class="token punctuation">.</span><span class="token function">setDefaultCredentialsProvider</span><span class="token punctuation">(</span>credentialsProvider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>restClientBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_SSL___58"></a>四：忽略 SSL证书 和 主机名验证</h2> 
<p>生产环境的 ElasticSearch 有时可能是通过域名来访问的，并且是 <code>https</code> 开头的，那就需要 SSL/TLS 认证了，但是我们并不需要，那只能忽略了。</p> 
<h3><a id="41__SSL__60"></a>4.1 忽略 SSL 认证</h3> 
<p>按上面说的，ElasticSearch 访问地址是 <code>https://***</code>，而只配置了 用户名密码，那用客户端链接则 <strong>可能</strong> 会报如下错误：</p> 
<pre><code class="prism language-bash">javax.net.ssl.SSLHandshakeException:PKIX path building failed:sun.security.provider.certpath.SunCertPathBuilderException:unable to <span class="token function">find</span> valid certification path to requested target
at org.elasticsearch.client.RestClient.extractAndWrapCause<span class="token punctuation">(</span>RestClient.java:783<span class="token punctuation">)</span>
at org.elasticsearch.client.RestClient.performRequest<span class="token punctuation">(</span>RestClient.java:218<span class="token punctuation">)</span>
at org.elasticsearch.client.RestClient.performRequest<span class="token punctuation">(</span>RestClient.java:205<span class="token punctuation">)</span>
at org.elasticsearch.client.RestHighLevelclient.internalPerformRequest<span class="token punctuation">(</span>RestHighLevelclient.java:1454<span class="token punctuation">)</span>
at org.elasticsearch.client.RestHighLevelclient.performRequest<span class="token punctuation">(</span>RestHighLevelclient.java:1424<span class="token punctuation">)</span>
</code></pre> 
<p>此时我们需要忽略 SSL 认证，然忽略 SSL 的写法也有好几种。</p> 
<p><code>注意：</code> 以下三种方式选择其中一种就可以，那种适合就用那种。</p> 
<h4><a id="_74"></a>方式一</h4> 
<p>首先获取 TLS 的 SSLContext 实例，再进行初始化，初始化的时候什么都不做。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> hostname <span class="token operator">=</span> <span class="token string">"es.test.com"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token number">9200</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> esUsername <span class="token operator">=</span> <span class="token string">"your es username"</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> esPassword <span class="token operator">=</span> <span class="token string">"your es password"</span><span class="token punctuation">;</span>
    <span class="token comment">// 配置用户名和密码</span>
    <span class="token class-name">CredentialsProvider</span> credentialsProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicCredentialsProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    credentialsProvider<span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span><span class="token class-name">AuthScope</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentials</span><span class="token punctuation">(</span>esUsername<span class="token punctuation">,</span> esPassword<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RestClientBuilder</span> clientBuilder <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token string">"https"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    clientBuilder<span class="token punctuation">.</span><span class="token function">setHttpClientConfigCallback</span><span class="token punctuation">(</span> httpAsyncClientBuilder <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 配置认证支持</span>
                httpAsyncClientBuilder<span class="token punctuation">.</span><span class="token function">setDefaultCredentialsProvider</span><span class="token punctuation">(</span>credentialsProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 忽略证书配置</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">SSLContext</span> sslContext <span class="token operator">=</span> <span class="token class-name">SSLContext</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"TLS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sslContext<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TrustManager</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token keyword">new</span> <span class="token class-name">X509TrustManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token annotation punctuation">@Override</span>
                                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkClientTrusted</span><span class="token punctuation">(</span><span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> x509Certificates<span class="token punctuation">,</span> <span class="token class-name">String</span> s<span class="token punctuation">)</span>
                                                <span class="token keyword">throws</span> <span class="token class-name">CertificateException</span> <span class="token punctuation">{<!-- --></span>
                                            <span class="token comment">// 忽略证书错误 信任任何客户端证书</span>
                                        <span class="token punctuation">}</span>

                                        <span class="token annotation punctuation">@Override</span>
                                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkServerTrusted</span><span class="token punctuation">(</span><span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> x509Certificates<span class="token punctuation">,</span> <span class="token class-name">String</span> s<span class="token punctuation">)</span>
                                                <span class="token keyword">throws</span> <span class="token class-name">CertificateException</span> <span class="token punctuation">{<!-- --></span>
                                            <span class="token comment">// 忽略证书错误 信任任何客户端证书</span>
                                        <span class="token punctuation">}</span>

                                        <span class="token annotation punctuation">@Override</span>
                                        <span class="token keyword">public</span> <span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getAcceptedIssuers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                                        <span class="token punctuation">}</span>
                                    <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span>
                            <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    httpAsyncClientBuilder<span class="token punctuation">.</span><span class="token function">setSSLContext</span><span class="token punctuation">(</span>sslContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> <span class="token operator">|</span> <span class="token class-name">KeyManagementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"忽略证书错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 忽略 hostname 校验认证</span>
                httpAsyncClientBuilder<span class="token punctuation">.</span><span class="token function">setSSLHostnameVerifier</span><span class="token punctuation">(</span><span class="token class-name">NoopHostnameVerifier</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> httpAsyncClientBuilder<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>clientBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_124"></a>方式二</h4> 
<p>首先创建一个信任策略的 TrustStrategy，再通过策略构建一个 SSLContext 。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> hostname <span class="token operator">=</span> <span class="token string">"es.test.com"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token number">9200</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> esUsername <span class="token operator">=</span> <span class="token string">"your es username"</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> esPassword <span class="token operator">=</span> <span class="token string">"your es password"</span><span class="token punctuation">;</span>
    <span class="token comment">// 配置用户名和密码</span>
    <span class="token class-name">CredentialsProvider</span> credentialsProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicCredentialsProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    credentialsProvider<span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span><span class="token class-name">AuthScope</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentials</span><span class="token punctuation">(</span>esUsername<span class="token punctuation">,</span> esPassword<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RestClientBuilder</span> clientBuilder <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token string">"https"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    clientBuilder<span class="token punctuation">.</span><span class="token function">setHttpClientConfigCallback</span><span class="token punctuation">(</span>httpAsyncClientBuilder <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        httpAsyncClientBuilder<span class="token punctuation">.</span><span class="token function">setDefaultCredentialsProvider</span><span class="token punctuation">(</span>credentialsProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 创建一个信任所有证书的 TrustStrategy 策略</span>
            <span class="token class-name">TrustStrategy</span> acceptTrustStrategy <span class="token operator">=</span> <span class="token punctuation">(</span>chain<span class="token punctuation">,</span> authType<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// 使用 SSLContextBuilder 创建 SSLContext</span>
            <span class="token class-name">SSLContext</span> sslContext <span class="token operator">=</span> <span class="token class-name">SSLContextBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadTrustMaterial</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> acceptTrustStrategy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            httpAsyncClientBuilder<span class="token punctuation">.</span><span class="token function">setSSLContext</span><span class="token punctuation">(</span>sslContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> <span class="token operator">|</span> <span class="token class-name">KeyStoreException</span> <span class="token operator">|</span> <span class="token class-name">KeyManagementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> httpAsyncClientBuilder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>clientBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_152"></a>方式三</h4> 
<p>这里需要一个引入一个第三方的 jar 包，封装了我们需要的 SSL 认证实例。</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>hakky54<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>sslcontext<span class="token operator">-</span>kickstart<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">8.1</span><span class="token number">.4</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>下面通过第三方 jar 包提供的 SSLFactory 来得到 SSLContext 。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> hostname <span class="token operator">=</span> <span class="token string">"es.test.com"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token number">9200</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> esUsername <span class="token operator">=</span> <span class="token string">"your es username"</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> esPassword <span class="token operator">=</span> <span class="token string">"your es password"</span><span class="token punctuation">;</span>
    <span class="token comment">// 用户名和密码认证</span>
    <span class="token class-name">CredentialsProvider</span> credentialsProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicCredentialsProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    credentialsProvider<span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span><span class="token class-name">AuthScope</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentials</span><span class="token punctuation">(</span>esUsername<span class="token punctuation">,</span> esPassword<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 配置策略工厂</span>
    <span class="token class-name">SSLFactory</span> sslFactory <span class="token operator">=</span> <span class="token class-name">SSLFactory</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withUnsafeTrustMaterial</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withUnsafeHostnameVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RestClientBuilder</span> clientBuilder <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token string">"https"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    clientBuilder<span class="token punctuation">.</span><span class="token function">setHttpClientConfigCallback</span><span class="token punctuation">(</span>httpAsyncClientBuilder <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        httpAsyncClientBuilder<span class="token punctuation">.</span><span class="token function">setDefaultCredentialsProvider</span><span class="token punctuation">(</span>credentialsProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过策略工厂获取一个 SSLContext</span>
        httpAsyncClientBuilder<span class="token punctuation">.</span><span class="token function">setSSLContext</span><span class="token punctuation">(</span>sslFactory<span class="token punctuation">.</span><span class="token function">getSslContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> httpAsyncClientBuilder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>clientBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="42___186"></a>4.2 忽略 主机名验证</h3> 
<p>处理 SSL 认证，还有可能包如下错误：</p> 
<pre><code class="prism language-bash">java.io.IOException: Host name <span class="token string">'devintes.jibo.cn'</span> does not match the certificate subject provided by the peer <span class="token punctuation">(</span>CN<span class="token operator">=</span>elasticsearch-devint-master<span class="token punctuation">)</span>
</code></pre> 
<p>我们接着忽略，只需要在忽略 SSL 是再忽略 主机名验证就可以了，代码如下：</p> 
<pre><code class="prism language-java">httpAsyncClientBuilder<span class="token punctuation">.</span><span class="token function">setSSLHostnameVerifier</span><span class="token punctuation">(</span><span class="token class-name">NoopHostnameVerifier</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>其实再上面的 <strong>方式三</strong> 中，用 <code>SSLFactory</code> 也是可以忽略的。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/27b8d4893a3b89025bbe29150a595622/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SpringBoot整合ActiveMQ步骤</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b91d19ea8dc13220101635c82d704ee3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Prometheus的24节实战课</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>