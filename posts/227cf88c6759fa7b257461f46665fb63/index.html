<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>go 生成图片，邮件发送问题 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="go 生成图片，邮件发送问题" />
<meta property="og:description" content="一、问题背景： 每天发送各个部门的财报到邮件. 由于部门较多，且数据量较大，导致单纯的表格模式数字量太多. 影响观看，且不易发现问题,分析数据。 二、项目初审，项目技术选型 1、后端做定时任务调度 2、后端提供明细数据接口 3、前端做数据页面展示 4、使用PhantomJS 实现网页截图功能 5、图片以对象存储的形势保存 6、定时任务推送数据 三、项目涉及的技术解决方案 1、PhantomJS 官网链接：https://www.cnblogs.com/bangejingting/p/6907628.html 1.1、phantomjs的安装 安装目录放在data目录下
$ cd /data/
远程下载
$ wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2
解压tar.bz2文件
$ tar -jxvf phantomjs-2.1.1-linux-x86_64.tar.bz2
$ cd phantomjs-2.1.1-linux-x86_64/bin/
对可执行文件进行web用户授权
$ chown -R web:web bin/
将该脚本命令作为全局脚本
$ cp phantomjs /bin/
1.2、phantomjs的使用 调用脚本 参数为执行的js脚本文件 $ phantomjs --web-security=no xxx.js htmlPath imgPath 说明： --web-security=no // 解决跨域问题 xxx.js // 需要执行的脚本 htmlPath // 需要生成的网页地址， 可以是绝对路径下的html /data/html/index.html imgPath // 生成的图片地址及图片名称 /data/img/xxx.jpg xxx.js样例： var page = require(&#39;webpage&#39;)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/227cf88c6759fa7b257461f46665fb63/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-06T14:07:08+08:00" />
<meta property="article:modified_time" content="2021-09-06T14:07:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">go 生成图片，邮件发送问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>一、问题背景：</h3> 
<pre><code>	每天发送各个部门的财报到邮件.
	由于部门较多，且数据量较大，导致单纯的表格模式数字量太多.
	影响观看，且不易发现问题,分析数据。
</code></pre> 
<h3><a id="_7"></a>二、项目初审，项目技术选型</h3> 
<p><img src="https://images2.imgbox.com/f7/b7/emE4L3c7_o.png" alt="在这里插入图片描述"></p> 
<pre><code>1、后端做定时任务调度
2、后端提供明细数据接口
3、前端做数据页面展示
4、使用PhantomJS 实现网页截图功能
5、图片以对象存储的形势保存
6、定时任务推送数据
</code></pre> 
<h3><a id="_18"></a>三、项目涉及的技术解决方案</h3> 
<h4><a id="1PhantomJS_19"></a>1、PhantomJS</h4> 
<pre><code>官网链接：https://www.cnblogs.com/bangejingting/p/6907628.html
</code></pre> 
<h5><a id="11phantomjs_23"></a>1.1、phantomjs的安装</h5> 
<ul><li> <p>安装目录放在data目录下<br> $ cd /data/</p> </li><li> <p>远程下载<br> $ wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2</p> </li><li> <p>解压tar.bz2文件<br> $ tar -jxvf phantomjs-2.1.1-linux-x86_64.tar.bz2<br> $ cd phantomjs-2.1.1-linux-x86_64/bin/</p> </li><li> <p>对可执行文件进行web用户授权<br> $ chown -R web:web bin/</p> </li><li> <p>将该脚本命令作为全局脚本<br> $ cp phantomjs /bin/</p> </li></ul> 
<h5><a id="12phantomjs_40"></a>1.2、phantomjs的使用</h5> 
<ul><li>调用脚本 参数为执行的js脚本文件</li></ul> 
<pre><code>	$ phantomjs  --web-security=no xxx.js htmlPath imgPath

说明：
	--web-security=no  // 解决跨域问题
	 xxx.js  // 需要执行的脚本
	 htmlPath  // 需要生成的网页地址， 可以是绝对路径下的html  /data/html/index.html
	imgPath // 生成的图片地址及图片名称  /data/img/xxx.jpg  
</code></pre> 
<ul><li>xxx.js样例：</li></ul> 
<pre><code>var page = require('webpage').create(),
    system = require('system'),
    address, output, size;
// 设置整体渲染页面的大小，非必需设置
// page.viewportSize = {width: 800, height: 400};
address = system.args[1];
output = system.args[2];
// 打开的html文件，可以是相对地址
page.open(address, function (status) {
    page.render(output);
    page.close();
    phantom.exit(1);
    console.log('render ok');
});

说明：
	address：需要截图的地址
	output： 输出的图片
</code></pre> 
<h5><a id="phantomjs_73"></a>phantomjs的注意事项</h5> 
<ul><li>不支持es6语法，只能使用es5</li></ul> 
<h4><a id="2_77"></a>2、对象存储文件上传</h4> 
<ul><li>单文件上传</li></ul> 
<pre><code>// 单文件上传
func CloudUploadFile(f *multipart.FileHeader, fileName string) error {
	appID := AppID
	secretID := SecretID
	secretKey :=SecretKey
	u, _ := url.Parse("http://"+bucketName+"-"+appID+".cos.ap-xianggang.myqcloud.com")

	client := libcos.NewClient1(u, appID, secretID, secretKey, 10)

	// 读取文件内容
	fileContent, err := f.Open()
	if err != nil {
		fmt.Sprintf("err:%v\n",e.Error())
		return err
	}
	fi, err := ioutil.ReadAll(fileContent)
	if err != nil {
		fmt.Sprintf("err:%v\n",e.Error())
		return err
	}
	fReader := bytes.NewReader(fi)

	// 上传
	err = client.Put(context.Background(), fileName, fReader)
	if err != nil {
		fmt.Sprintf("err:%v\n",e.Error())
		return err
	}
	return nil
	}
</code></pre> 
<ul><li>文件夹上传</li></ul> 
<pre><code>//获取指定目录下的所有文件,包含子目录下的文件
func GetAllFiles(dirPth string) (files []string, err error) {
	var dirs []string
	dir, err := ioutil.ReadDir(dirPth)
	if err != nil {
		return nil, err
	}
	PthSep := string(os.PathSeparator)
	//suffix = strings.ToUpper(suffix) //忽略后缀匹配的大小写
	for _, fi := range dir {
		if fi.IsDir() { // 目录, 递归遍历
			dirs = append(dirs, dirPth+PthSep+fi.Name())
			GetAllFiles(dirPth + PthSep + fi.Name())
		} else {
			files = append(files, dirPth+PthSep+fi.Name())
		}
	}
	// 读取子目录下文件
	for _, table := range dirs {
		temp, _ := GetAllFiles(table)
		for _, temp1 := range temp {
			files = append(files, temp1)
		}
	}
	return files, nil
}

// 文件逐个上传
func DownloadFile(c *gin.Context, filePath string) error {
	// 获取所有文件 
	files, err := GetAllFiles(filePath)
	if err != nil {
		fmt.Sprintf("err:%v\n", e.Error())
		return err
	}
	start := time.Now().Unix()
	var wg sync.WaitGroup
	con := make(chan int, 30)
	// 遍历文件 逐个上传
	for _, v := range files {
		wg.Add(1)
		go func(v string) {
			con &lt;- 1
			defer func() {
				&lt;-con
				wg.Done()
			}()
			file, _ := os.Open(v)
			defer file.Close()
			stats, _ := file.Stat()
			fileByte := make([]byte, stats.Size())
			file.Read(fileByte)

			// 取每一个文件的实际地址  /home/web/game/1.txt  =&gt; 实际目录 /game/1.txt
			filepath := strings.Replace(v, "/home/web", "", 1)
			err = FileUploading(c, fileByte, filepath)
			if err != nil {
				fmt.Sprintf("err:%v\n", e.Error())
			}
		}(v)
	}
	wg.Wait()
	return err
}

//  上传文件夹到腾讯云 对象存储
func FileUploading(fileByte []byte, fileName string) error {
	bucketName := BucketName
	appID := AppID
	secretID := SecretID
	secretKey := SecretKey
	u, _ := url.Parse("http://" + bucketName + "-" + appID + ".cos.ap-xiangguang.myqcloud.com")
	client := libcos.NewClient1(u, appID, secretID, secretKey, 10)
	fReader := bytes.NewReader(fileByte)
	// 上传
	err := client.Put(context.Background(), fileName, fReader)
	if err != nil {
		fmt.Sprintf("err:%v\n", e.Error())
		return err
	}
	return nil
}

</code></pre> 
<h4><a id="3_198"></a>3、邮件发送</h4> 
<p>3.1、解决邮件文字显示乱码</p> 
<pre><code>$ yum install -y fontconfig mkfontscale
$ fc-list :lang=zh

$ mkdir -p /usr/share/fonts/zh_CN

# 提前复制平方、微软雅黑到服务器
$ cp /tmp/PingFang.ttc .
$ cp /tmp/msyh.ttf .
$ chmod -R 766 ../zh_CN/

$ mkfontscale
$ mkfontdir
</code></pre> 
<h5><a id="32_216"></a>3.2、发送邮件</h5> 
<p>邮箱配置<img src="https://images2.imgbox.com/72/4c/wtMiOY1M_o.png" alt="请添加图片描述"></p> 
<h5><a id="33_218"></a>3.3、发送邮件</h5> 
<pre><code>func SendEmail() error {
	m := gomail.NewMessage()
	m.SetHeader("From", xxx)        //发送人
	m.SetHeader("To",[]string{xxx,xxx})      //接收人 
	m.SetHeader("Subject",xxx ) //邮件主题 string
	m.SetBody("text/html", xxxx)      //正文 string
	// 发邮件地址 smtp.exmail.qq.com qq邮箱， port 邮箱设置里可以查到， 发送者邮箱名称， 邮箱密钥， 上一步可以查到，不是邮箱登录密码
	d := gomail.NewDialer(FromEmailAddr, FromEmailPort, FromEmailName, FromEmailPass)
	if err := d.DialAndSend(m); err != nil {
		return fmt.Errorf("err:%v\n", err.Error())
	}
	return nil
}
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/80e8d1d772bdbb5a5f42d9f14ec781e7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数字设计之取整</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e161af25f960acbffa69240f7ac64ef4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Simulink触发子系统使用方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>