<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C# 异步调用aysnc await - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C# 异步调用aysnc await" />
<meta property="og:description" content="一、基本概念 在C#中，async和await关键字用于异步编程。异步编程允许程序在执行I/O密集型操作时不会被阻塞，从而提高程序的性能和响应性。
async关键字用于定义异步方法，表明该方法可能包含await表达式，并且可以在其执行期间异步等待其他操作的完成。
await关键字用于等待异步操作完成，它只能在async方法内使用。await表达式会挂起当前方法的执行，直到其等待的操作完成，然后恢复方法的执行。
二、使用方法调用的方式 代码如下（示例）：
using System; using System.Collections.Generic; using System.Threading.Tasks; class Program { static void Main(string[] args) { // 调用 test 方法，该方法是异步的，但不会阻塞主线程 test(); Console.WriteLine(&#34;main end...&#34;); // 输出主函数结束的提示 Console.ReadKey(); // 等待用户输入任意键，保持程序运行 } // 异步方法 test static async void test() { // 异步等待 2000 毫秒（2 秒） await Task.Delay(2000); // 调用 stest 方法创建三个异步任务 Task&lt;int&gt; Result0 = stest(100, 2000); Task&lt;int&gt; Result1 = stest(200, 3000); Task&lt;int&gt; Result2 = stest(300, 4000); // 创建一个任务列表，将三个异步任务添加到列表中 List&lt;Task&lt;int&gt;&gt; tsklst = new List&lt;Task&lt;int&gt;&gt;(); tsklst." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/7c8d5053ae5d6071afea330b1f1cf5c5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-13T10:01:46+08:00" />
<meta property="article:modified_time" content="2024-03-13T10:01:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C# 异步调用aysnc await</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_1"></a>一、基本概念</h2> 
<p>在C#中，async和await关键字用于异步编程。异步编程允许程序在执行I/O密集型操作时不会被阻塞，从而提高程序的性能和响应性。</p> 
<p>async关键字用于定义异步方法，表明该方法可能包含await表达式，并且可以在其执行期间异步等待其他操作的完成。<br> await关键字用于等待异步操作完成，它只能在async方法内使用。await表达式会挂起当前方法的执行，直到其等待的操作完成，然后恢复方法的执行。</p> 
<hr> 
<h2><a id="_13"></a>二、使用方法调用的方式</h2> 
<p>代码如下（示例）：</p> 
<pre><code class="prism language-c">using System<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span>

class Program
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span>string<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 调用 test 方法，该方法是异步的，但不会阻塞主线程</span>
        <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"main end..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出主函数结束的提示</span>
        Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待用户输入任意键，保持程序运行</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 异步方法 test</span>
    <span class="token keyword">static</span> async <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 异步等待 2000 毫秒（2 秒）</span>
        await Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 调用 stest 方法创建三个异步任务</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> Result0 <span class="token operator">=</span> <span class="token function">stest</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> Result1 <span class="token operator">=</span> <span class="token function">stest</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> Result2 <span class="token operator">=</span> <span class="token function">stest</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建一个任务列表，将三个异步任务添加到列表中</span>
        List<span class="token operator">&lt;</span>Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> tsklst <span class="token operator">=</span> new List<span class="token operator">&lt;</span>Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tsklst<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>new List<span class="token operator">&lt;</span>Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{<!-- --></span> Result0<span class="token punctuation">,</span> Result1<span class="token punctuation">,</span> Result2 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 输出开始执行异步任务的提示</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"delegateFuncTaskReturn has been Started {0}"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用 Task.WhenAny 方法异步等待任务列表中的任意一个任务完成</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> firstCompletedTask <span class="token operator">=</span> await Task<span class="token punctuation">.</span><span class="token function">WhenAny</span><span class="token punctuation">(</span>tsklst<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 输出异步任务完成后的提示</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"after WhenAny"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"firstCompletedTask has been done and returned value {0}"</span><span class="token punctuation">,</span> firstCompletedTask<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"program end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出程序结束的提示</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 异步方法 stest，接受一个整数参数 input 和一个整数参数 delay</span>
    <span class="token keyword">static</span> async Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">stest</span><span class="token punctuation">(</span><span class="token keyword">int</span> input<span class="token punctuation">,</span> <span class="token keyword">int</span> delay<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 异步等待指定的延迟时间</span>
        await Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 输出异步方法执行完成的提示，并打印输入值加 1 的结果</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"delegateFuncTaskReturn has been done and returned value {0}"</span><span class="token punctuation">,</span> input <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 再次异步等待 1000 毫秒（1 秒）</span>
        await Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 返回输入值减去 1</span>
        <span class="token keyword">return</span> input <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>这段代码的主要逻辑是创建了三个异步任务（<code>Result0</code>、<code>Result1</code>、<code>Result2</code>），每个任务都会在一定的延迟后返回一个结果。然后，使用 <code>Task.WhenAny</code> 方法等待任意一个任务完成。在 <code>test</code> 方法中，还输出了一些提示信息以表示异步任务的启动和完成状态。</p> 
<p>以下是代码的执行过程和输出结果的总结：</p> 
<ol><li>主函数 <code>Main</code> 开始执行，调用 <code>test</code> 方法。</li><li><code>test</code> 方法异步等待了 2000 毫秒（2 秒）。</li><li><code>stest</code> 方法被调用三次，每次传入不同的参数，并且每个方法内部会异步等待一定的延迟时间后返回结果。</li><li>输出了五次 “delegateFuncTaskReturn has been Started 100” 的提示信息，表示异步任务已经启动。</li><li>使用 <code>Task.WhenAny</code> 方法等待任意一个任务完成。</li><li>当第一个任务完成时，输出了 “after WhenAny” 的提示信息，并打印了第一个完成任务的结果。</li><li>最后输出 “program end” 表示程序执行结束。</li></ol> 
<p>因为 <code>Task.WhenAny</code> 方法会返回第一个完成的任务，所以输出结果可能会因为任务执行顺序不同而有所不同，但总体上，程序会在异步任务完成后输出相应的提示信息和结果。输出结果如下：</p> 
<pre><code class="prism language-c#">test start...
main end...
delegateFuncTaskReturn has been Started 100
delegateFuncTaskReturn has been done and returned value 101
after WhenAny
firstCompletedTask has been done and returned value 99
program end
delegateFuncTaskReturn has been done and returned value 201
delegateFuncTaskReturn has been done and returned value 301
</code></pre> 
<h2><a id="lamda_102"></a>三、使用lamda和异步委托的方式</h2> 
<p>代码如下（示例）：</p> 
<pre><code class="prism language-c">using System<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span>

class Program
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span>string<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"test2 start..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出测试开始的提示信息</span>
        <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用异步方法 test2</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"main end..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出主函数结束的提示信息</span>
        Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待用户输入任意键，保持程序运行</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 异步方法 test2</span>
    <span class="token keyword">static</span> async <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        await Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异步等待 2000 毫秒（2 秒）</span>

        <span class="token comment">// 使用 lambda 表达式定义异步委托 stest</span>
        Func<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> stest <span class="token operator">=</span> <span class="token function">async</span> <span class="token punctuation">(</span><span class="token keyword">int</span> input<span class="token punctuation">,</span> <span class="token keyword">int</span> delay<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token punctuation">{<!-- --></span>
            await Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异步等待指定的延迟时间</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"delegateFuncTaskReturn has been done and returned value {0}"</span><span class="token punctuation">,</span> input <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出异步方法执行完成的提示，并打印输入值加 1 的结果</span>
            await Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 再次异步等待 1000 毫秒（1 秒）</span>
            <span class="token keyword">return</span> input <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 返回输入值减去 1</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 创建三个异步任务，每个任务传入不同的参数</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> Result0 <span class="token operator">=</span> <span class="token function">stest</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> Result1 <span class="token operator">=</span> <span class="token function">stest</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> Result2 <span class="token operator">=</span> <span class="token function">stest</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        List<span class="token operator">&lt;</span>Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> tsklst <span class="token operator">=</span> new List<span class="token operator">&lt;</span>Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建任务列表</span>
        tsklst<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>new List<span class="token operator">&lt;</span>Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{<!-- --></span> Result0<span class="token punctuation">,</span> Result1<span class="token punctuation">,</span> Result2 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将三个异步任务添加到列表中</span>
        
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"delegateFuncTaskReturn has been Started {0}"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出异步任务已经启动的提示信息</span>

        <span class="token comment">// 使用 Task.WhenAny 方法异步等待任务列表中的任意一个任务完成</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> firstCompletedTask <span class="token operator">=</span> await Task<span class="token punctuation">.</span><span class="token function">WhenAny</span><span class="token punctuation">(</span>tsklst<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"after WhenAny"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出异步任务完成后的提示信息</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"firstCompletedTask has been done and returned value {0}"</span><span class="token punctuation">,</span> firstCompletedTask<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印第一个完成任务的结果</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"program end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出程序结束的提示信息</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>这段代码与之前的代码类似，不同之处在于 <code>test2</code> 方法中使用了 lambda 表达式来定义异步委托 <code>stest</code>，而不是单独定义一个异步方法 <code>stest</code>。</p> 
<p>以下是代码的执行过程和解释：</p> 
<ol><li>主函数 <code>Main</code> 开始执行，调用 <code>test2</code> 方法。</li><li><code>test2</code> 方法异步等待了 2000 毫秒（2 秒）。</li><li>使用 lambda 表达式定义了一个异步委托 <code>stest</code>，该委托接受两个参数 <code>input</code> 和 <code>delay</code>，并在内部异步等待一定的延迟时间后返回一个结果。</li><li>使用 <code>stest</code> 异步委托创建了三个异步任务 <code>Result0</code>、<code>Result1</code> 和 <code>Result2</code>，每个任务传入不同的参数。</li><li>输出了五次 “delegateFuncTaskReturn has been Started 100” 的提示信息，表示异步任务已经启动。</li><li>使用 <code>Task.WhenAny</code> 方法等待任意一个任务完成。</li><li>当第一个任务完成时，输出了 “after WhenAny” 的提示信息，并打印了第一个完成任务的结果。</li><li>最后输出 “program end” 表示程序执行结束。</li></ol> 
<p>与之前的代码相比，这段代码的主要区别在于使用了 lambda 表达式来定义异步委托，使代码更加简洁和紧凑。代码主要利用了异步方法和异步委托来实现并行执行多个任务。主要执行步骤和注释已经在代码中说明。</p> 
<pre><code class="prism language-c#">test2 start...
main end...
delegateFuncTaskReturn has been Started 100
delegateFuncTaskReturn has been done and returned value 101
after WhenAny
firstCompletedTask has been done and returned value 99
program end
delegateFuncTaskReturn has been done and returned value 201
delegateFuncTaskReturn has been done and returned value 301
</code></pre> 
<h2><a id="test2UIUI_181"></a>四、稍加修改使test2变成阻塞当前线程的方法(后台阻塞，如果是UI界面不会影响UI线程响应)</h2> 
<p>代码如下（示例）：</p> 
<pre><code class="prism language-c"> using System<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span>

class Program
<span class="token punctuation">{<!-- --></span>

	<span class="token comment">//在main函数增加async 使之可以在test2前面加await阻塞当前这个方法，等待test2运行完成之后在运行后面的流程。</span>
    <span class="token keyword">static</span> async Task <span class="token function">Main</span><span class="token punctuation">(</span>string<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"test2 start..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出测试开始的提示信息</span>
        await <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异步调用 test2 方法，并等待其完成</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"main end..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出主函数结束的提示信息</span>
        Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待用户输入任意键，保持程序运行</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 异步方法 test2，返回一个 Task&lt;int&gt; 对象</span>
    <span class="token keyword">static</span> async Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        await Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异步等待 2000 毫秒（2 秒）</span>

        <span class="token comment">// 使用 lambda 表达式定义异步委托 stest</span>
        Func<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> stest <span class="token operator">=</span> <span class="token function">async</span> <span class="token punctuation">(</span><span class="token keyword">int</span> input<span class="token punctuation">,</span> <span class="token keyword">int</span> delay<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token punctuation">{<!-- --></span>
            await Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异步等待指定的延迟时间</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"delegateFuncTaskReturn has been done and returned value {0}"</span><span class="token punctuation">,</span> input <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出异步方法执行完成的提示，并打印输入值加 1 的结果</span>
            await Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 再次异步等待 1000 毫秒（1 秒）</span>
            <span class="token keyword">return</span> input <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 返回输入值减去 1</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 创建三个异步任务，每个任务传入不同的参数</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> Result0 <span class="token operator">=</span> <span class="token function">stest</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> Result1 <span class="token operator">=</span> <span class="token function">stest</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> Result2 <span class="token operator">=</span> <span class="token function">stest</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        List<span class="token operator">&lt;</span>Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> tsklst <span class="token operator">=</span> new List<span class="token operator">&lt;</span>Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建任务列表</span>
        tsklst<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>new List<span class="token operator">&lt;</span>Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{<!-- --></span> Result0<span class="token punctuation">,</span> Result1<span class="token punctuation">,</span> Result2 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将三个异步任务添加到列表中</span>
        
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"delegateFuncTaskReturn has been Started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出异步任务已经启动的提示信息</span>

        <span class="token comment">// 使用 Task.WhenAny 方法异步等待任务列表中的任意一个任务完成</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> firstCompletedTask <span class="token operator">=</span> await Task<span class="token punctuation">.</span><span class="token function">WhenAny</span><span class="token punctuation">(</span>tsklst<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"after WhenAny"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出异步任务完成后的提示信息</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"firstCompletedTask has been done and returned value {0}"</span><span class="token punctuation">,</span> firstCompletedTask<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印第一个完成任务的结果</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"program end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出程序结束的提示信息</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回 0，表示方法执行完成</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>这段代码利用了异步方法和异步委托来实现并行执行多个任务，并且在 Main 方法中也使用了异步特性。主要执行步骤和注释已经在代码中说明。增加await关键字使它变成阻塞的方法。<br> 输出结果如下：</p> 
<pre><code class="prism language-C">test2 start...
delegateFuncTaskReturn has been Started
delegateFuncTaskReturn has been done and returned value 101
after WhenAny
firstCompletedTask has been done and returned value 99
program end
main end...
delegateFuncTaskReturn has been done and returned value 201
delegateFuncTaskReturn has been done and returned value 301

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/898e6c828959ae7603ba0049f300729a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">个人注册公司流程及费用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a1d340d3bc448a89dadd24da6e0dd538/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何阅读“计算机界三大神书”之一 ——《计算机程序的构造和解释》SICP</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>