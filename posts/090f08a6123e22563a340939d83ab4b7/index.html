<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux高并发服务器开发第二章：Linux多进程开发 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux高并发服务器开发第二章：Linux多进程开发" />
<meta property="og:description" content="文章目录 1. 基本概念1.1 程序1.2 进程1.3 单道、多道程序设计1.4 时间片1.5 并行和并发1.6 进程控制块（PCB） 2. 进程的状态3. 进程相关命令4. 进程号和相关函数5. 进程创建、父子进程关系6. GDB 多进程调试7. exec 函数族（1）`int execl(const char *path, const char *arg, ...);`（2）`int execlp(const char *file, const char *arg, ... );` 8. 进程控制8.1 进程退出8.2 孤儿进程8.3 僵尸进程8.4 进程回收8.5 `pid_t wait(int *wstatus);`8.6 `pid_t waitpid(pid_t pid, int *wstatus, int options);`8.7 退出信息相关宏函数 9. 进程间通信9.1 进程间通信概念9.2 Linux 进程间通信的方式9.3 匿名管道9.4 管道的特点9.5 为什么可以使用管道进行进程间通信9.6 管道的数据结构9.7 创建匿名管道：`int pipe(int pipefd[2]);`9.8 查看管道缓存大小命令：`ulimit -a`9.9 查看管道缓冲大小函数：`long fpathconf(int fd, int name);`9.10 匿名管道的使用9." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/090f08a6123e22563a340939d83ab4b7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-11T17:48:42+08:00" />
<meta property="article:modified_time" content="2023-07-11T17:48:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux高并发服务器开发第二章：Linux多进程开发</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p></p> 
 <div class="toc"> 
  <h4>文章目录</h4> 
  <ul><li><ul><li><a href="#1__1" rel="nofollow">1. 基本概念</a></li><li><ul><li><a href="#11__2" rel="nofollow">1.1 程序</a></li><li><a href="#12__13" rel="nofollow">1.2 进程</a></li><li><a href="#13__17" rel="nofollow">1.3 单道、多道程序设计</a></li><li><a href="#14__23" rel="nofollow">1.4 时间片</a></li><li><a href="#15__27" rel="nofollow">1.5 并行和并发</a></li><li><a href="#16_PCB_33" rel="nofollow">1.6 进程控制块（PCB）</a></li></ul> 
    </li><li><a href="#2__49" rel="nofollow">2. 进程的状态</a></li><li><a href="#3__60" rel="nofollow">3. 进程相关命令</a></li><li><a href="#4__94" rel="nofollow">4. 进程号和相关函数</a></li><li><a href="#5__103" rel="nofollow">5. 进程创建、父子进程关系</a></li><li><a href="#6_GDB__177" rel="nofollow">6. GDB 多进程调试</a></li><li><a href="#7_exec__188" rel="nofollow">7. exec 函数族</a></li><li><ul><li><a href="#1int_execlconst_char_path_const_char_arg__194" rel="nofollow">（1）`int execl(const char *path, const char *arg, ...);`</a></li><li><a href="#2int_execlpconst_char_file_const_char_arg___245" rel="nofollow">（2）`int execlp(const char *file, const char *arg, ... );`</a></li></ul> 
    </li><li><a href="#8__305" rel="nofollow">8. 进程控制</a></li><li><ul><li><a href="#81__306" rel="nofollow">8.1 进程退出</a></li><li><a href="#82__318" rel="nofollow">8.2 孤儿进程</a></li><li><a href="#83__354" rel="nofollow">8.3 僵尸进程</a></li><li><a href="#84__390" rel="nofollow">8.4 进程回收</a></li><li><a href="#85_pid_t_waitint_wstatus_397" rel="nofollow">8.5 `pid_t wait(int *wstatus);`</a></li><li><a href="#86_pid_t_waitpidpid_t_pid_int_wstatus_int_options_475" rel="nofollow">8.6 `pid_t waitpid(pid_t pid, int *wstatus, int options);`</a></li><li><a href="#87__560" rel="nofollow">8.7 退出信息相关宏函数</a></li></ul> 
    </li><li><a href="#9__570" rel="nofollow">9. 进程间通信</a></li><li><ul><li><a href="#91__571" rel="nofollow">9.1 进程间通信概念</a></li><li><a href="#92_Linux__580" rel="nofollow">9.2 Linux 进程间通信的方式</a></li><li><a href="#93__583" rel="nofollow">9.3 匿名管道</a></li><li><a href="#94__587" rel="nofollow">9.4 管道的特点</a></li><li><a href="#95__597" rel="nofollow">9.5 为什么可以使用管道进行进程间通信</a></li><li><a href="#96__601" rel="nofollow">9.6 管道的数据结构</a></li><li><a href="#97_int_pipeint_pipefd2_604" rel="nofollow">9.7 创建匿名管道：`int pipe(int pipefd[2]);`</a></li><li><a href="#98_ulimit_a_682" rel="nofollow">9.8 查看管道缓存大小命令：`ulimit -a`</a></li><li><a href="#99_long_fpathconfint_fd_int_name_684" rel="nofollow">9.9 查看管道缓冲大小函数：`long fpathconf(int fd, int name);`</a></li><li><a href="#910__707" rel="nofollow">9.10 匿名管道的使用</a></li><li><a href="#911__774" rel="nofollow">9.11 管道的读写特点</a></li><li><a href="#913__793" rel="nofollow">9.13 将管道设置为非阻塞的操作</a></li><li><a href="#914__862" rel="nofollow">9.14 有名管道</a></li><li><a href="#915__871" rel="nofollow">9.15 有名管道的创建与使用</a></li><li><a href="#916__1000" rel="nofollow">9.16 使用有名管道实现简单版聊天功能</a></li><li><a href="#917__1167" rel="nofollow">9.17 内存映射</a></li><li><a href="#918__1251" rel="nofollow">9.18 内存映射的注意事项</a></li><li><a href="#919__1290" rel="nofollow">9.19 使用内存映射实现文件拷贝的功能</a></li><li><a href="#920__1358" rel="nofollow">9.20 信号的概念</a></li><li><a href="#921_Linux__1372" rel="nofollow">9.21 Linux 信号一览表</a></li><li><a href="#922_5_1377" rel="nofollow">9.22 信号的5种默认处理动作</a></li><li><ul><li><a href="#Core_1387" rel="nofollow">Core文件详解</a></li></ul> 
     </li><li><a href="#923__1425" rel="nofollow">9.23 信号相关的函数</a></li><li><a href="#924__1738" rel="nofollow">9.24 信号集</a></li><li><a href="#925__1773" rel="nofollow">9.25 信号集相关的函数</a></li><li><a href="#926_SIGCHLD_2037" rel="nofollow">9.26 SIGCHLD信号</a></li><li><a href="#927__2121" rel="nofollow">9.27 共享内存</a></li><li><a href="#928__2136" rel="nofollow">9.28 共享内存操作函数</a></li><li><a href="#929__2282" rel="nofollow">9.29 共享内存操作指令</a></li><li><a href="#930__2304" rel="nofollow">9.30 共享内存相关的常见问题</a></li><li><a href="#931__2334" rel="nofollow">9.31 守护进程</a></li><li><ul><li><a href="#01__2336" rel="nofollow">01 终端</a></li><li><a href="#02__2345" rel="nofollow">02 进程组</a></li><li><a href="#03__2351" rel="nofollow">03 会话</a></li><li><a href="#04__2358" rel="nofollow">04 进程组、会话、控制终端之间的关系</a></li><li><a href="#05__2363" rel="nofollow">05 进程组、会话操作函数</a></li><li><a href="#06__2375" rel="nofollow">06 守护进程</a></li><li><a href="#07__2383" rel="nofollow">07 守护进程的创建步骤</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
 </div> 
 <p></p> 
</blockquote> 
<h3><a id="1__1"></a>1. 基本概念</h3> 
<h4><a id="11__2"></a>1.1 程序</h4> 
<p>程序是包含一系列信息的文件，这些信息描述了如何在运行时创建一个进程：</p> 
<ul><li>二进制格式标识：每个程序文件都包含用于描述可执行文件格式的元信息。内核利用此信息来解释文件中的其他信息。（ELF可执行链接格式）</li><li>机器语言指令：对程序算法进行编码</li><li>程序入口地址：标识程序开始执行时的起始指令位置。</li><li>数据：程序文件包含的变量初始值和程序使用的字面量值（比如字符串）。</li><li>符号表及重定位表：描述程序中函数和变量的位置及名称。这些表格有多重用途，其中包括调试和运行时的符号解析（动态链接）。</li><li>共享库和动态链接信息：程序文件所包含的一些字段，列出了程序运行时需要使用的共享库，以及加载共享库的动态连接器的路径名。</li><li>其他信息：程序文件还包含许多其他信息，用以描述如何创建进程。</li></ul> 
<hr> 
<h4><a id="12__13"></a>1.2 进程</h4> 
<ul><li><strong>进程是正在运行的程序的实例</strong>。是一个具有一定独立功能的程序关于某个数据集合的一次运行活动。<strong>它是操作系统动态执行的基本单元，在传统的操作系统中，进程既是基本的分配单元，也是基本的执行单元。</strong></li><li>可以用一个程序来创建多个进程，进程是由内核定义的抽象实体，并为该实体分配用以执行程序的各项系统资源。从内核的角度看，进程由用户内存空间和一系列内核数据结构组成，其中用户内存空间包含了程序代码及代码所使用的变量，而内核数据结构则用于维护进程状态信息。记录在内核数据结构中的信息包括许多与进程相关的标识号（IDs）、虚拟内存表、打开文件的描述符表、信号传递及处理的有关信息、进程资源使用及限制、当前工作目录和大量的其他信息。</li></ul> 
<hr> 
<h4><a id="13__17"></a>1.3 单道、多道程序设计</h4> 
<ul><li>单道程序，即在计算机内存中只允许一个的程序运行。</li><li>多道程序设计技术是在计算机内存中同时存放几道相互独立的程序，使它们在管理程序控制下，相互穿插运行，两个或两个以上程序在计算机系统中同处于开始到结束之间的状态, 这些程序共享计算机系统资源。引入多道程序设计技术的根本目的是为了提高 CPU 的利用率。</li><li>对于一个单 CPU 系统来说，程序同时处于运行状态只是一种宏观上的概念，他们虽然都已经开始运行，但就微观而言，任意时刻，CPU 上运行的程序只有一个。</li><li>在多道程序设计模型中，多个进程轮流使用 CPU。而当下常见 CPU 为纳秒级，1秒可以执行大约 10 亿条指令。由于人眼的反应速度是毫秒级，所以看似同时在运行。</li></ul> 
<h4><a id="14__23"></a>1.4 时间片</h4> 
<ul><li>时间片（timeslice）又称为“量子（quantum）”或“处理器片（processor slice）”是操作系统分配给每个正在运行的进程微观上的一段 CPU 时间。事实上，虽然一台计算机通常可能有多个 CPU，但是同一个 CPU 永远不可能真正地同时运行多个任务。在只考虑一个 CPU 的情况下，这些进程“看起来像”同时运行的，实则是轮番穿插地运行，由于时间片通常很短（在 Linux 上为 5ms－800ms），用户不会感觉到。</li><li>时间片由操作系统内核的调度程序分配给每个进程。首先，内核会给每个进程分配相等的初始时间片，然后每个进程轮番地执行相应的时间，当所有进程都处于时间片耗尽的状态时，内核会重新为每个进程计算并分配时间片，如此往复。</li></ul> 
<hr> 
<h4><a id="15__27"></a>1.5 并行和并发</h4> 
<ul><li>并行(parallel)：指在同一时刻，有多条指令在多个处理器上同时执行。</li><li>并发(concurrency)：指在同一时刻只能有一条指令执行，但多个进程指令被快速的<br> 轮换执行，使得在宏观上具有多个进程同时执行的效果，但在微观上并不是同时执行的，<br> 只是把时间分成若干段，使多个进程快速交替的执行。</li></ul> 
<hr> 
<h4><a id="16_PCB_33"></a>1.6 进程控制块（PCB）</h4> 
<ul><li>为了管理进程，内核必须对每个进程所做的事情进行清楚的描述。内核为每个进程分配一个 PCB(Processing Control Block)进程控制块，维护进程相关的信息，Linux 内核的进程控制块是 task_struct 结构体。</li><li>在 /usr/src/linux-headers-xxx/include/linux/sched.h 文件中可以查看 struct task_struct 结构体定义。其内部成员有很多，我们只需要掌握以下部分即可： 
  <ul><li>进程id：系统中每个进程有唯一的 id，用 pid_t 类型表示，其实就是一个非负整数</li><li>进程的状态：有就绪、运行、挂起、停止等状态</li><li>进程切换时需要保存和恢复的一些CPU寄存器</li><li>描述虚拟地址空间的信息</li><li>描述控制终端的信息</li><li>当前工作目录（Current Working Directory）</li><li>umask 掩码</li><li>文件描述符表，包含很多指向 file 结构体的指针</li><li>和信号相关的信息</li><li>用户 id 和组 id</li><li>会话（Session）和进程组</li><li>进程可以使用的资源上限（Resource Limit）</li></ul> </li></ul> 
<hr> 
<h3><a id="2__49"></a>2. 进程的状态</h3> 
<p>进程状态反映进程执行过程的变化。这些状态随着进程的执行和外界条件的变化而转换。<br> 在三态模型中，进程状态分为三个基本状态，即就绪态，运行态，阻塞态。<br> 在五态模型中，进程分为新建态、就绪态，运行态，阻塞态，终止态。</p> 
<ul><li>运行态：进程占有处理器正在运行。</li><li>就绪态：进程具备运行条件，等待系统分配处理器以便运行。当进程已分配到除CPU以外的所有必要资源后，只要再获得CPU，便可立即执行。在一个系统中处于就绪状态的进程可能有多个，通常将它们排成一个队列，称为就绪队列。</li><li>阻塞态：又称为等待(wait)态或睡眠(sleep)态，指进程不具备运行条件，正在等待某个事件的完成。</li><li>新建态：进程刚被创建时的状态，尚未进入就绪队列。</li><li>终止态：进程完成任务到达正常结束点，或出现无法克服的错误而异常终止，或被操作系统及有终止权的进程所终止时所处的状态。进入终止态的进程以后不再执行，但依然保留在操作系统中等待善后。一旦其他进程完成了对终止态进程的信息抽取之后，操作系统将删除该进程。<br> <img src="https://images2.imgbox.com/db/b5/EdwPcBow_o.png" alt="在这里插入图片描述" width="700"></li></ul> 
<hr> 
<h3><a id="3__60"></a>3. 进程相关命令</h3> 
<ul><li><strong>查看进程：</strong><br> <code>ps aux</code>、<code>ps ajx</code><br> a：显示终端上的所有进程，包括其他用户的进程；<br> u：显示进程的详细信息<br> x：显示没有控制终端的进程<br> j：列出与作业控制相关的信息</li><li><strong>STAT参数意义：</strong><br> D：不可中断 Uninterruptible（usually IO）<br> R：正在运行，或在队列中的进程<br> S：处于休眠状态<br> T：停止或被追踪<br> Z：僵尸进程<br> W：进入内存交换（从内核2.6开始无效）<br> X：死掉的进程<br> &lt;：高优先级<br> N：低优先级<br> s：包含子进程<br> +：位于前台的进程组</li><li><strong>实时显示进程动态：</strong><br> <code>top</code><br> 可以在使用<code>top</code>命令时加上<code>-d</code>来指定显示信息更新的时间间隔，在<code>top</code>命令执行后，可以按以下按键对显示的结果进行排序：<br> M：根据内存使用量排序<br> P：根据 CPU 占有率进行排序<br> T：根据进程运行时间长短排序<br> U：根据用户名来筛选进程<br> K：输入指定的 PID 杀死进程</li><li><strong>杀死进程</strong><br> <code>kill [-signal] pid</code><br> <code>kill -</code> 列出所有信号<br> <code>kill -SIGKILL 进程ID</code><br> <code>kill -9 进程ID</code><br> <code>killall name</code> 根据进程名杀死进程</li></ul> 
<hr> 
<h3><a id="4__94"></a>4. 进程号和相关函数</h3> 
<ul><li>每个进程都由进程号来标识，其类型为 <code>pid_t</code>（整型），进程号的范围：<code>0～32767</code>。进程号总是唯一的，但可以重用。当一个进程终止后，其进程号就可以再次使用。</li><li>任何进程（除 <code>init</code> 进程）都是由另一个进程创建，该进程称为被创建进程的<strong>父进程</strong>，对应的进程号称为父进程号（PPID）。</li><li><strong>进程组</strong>是一个或多个进程的集合。他们之间相互关联，进程组可以接收同一终端的各种信号，关联的进程有一个进程组号（PGID）。默认情况下，当前的进程号会当做当前的进程组号。</li><li>进程号和进程组相关函数： 
  <ul><li><code>pid_t getpid(void);</code></li><li><code>pid_t getppid(void);</code></li><li><code>pid_t getpgid(pid_t pid);</code></li></ul> </li></ul> 
<hr> 
<h3><a id="5__103"></a>5. 进程创建、父子进程关系</h3> 
<p>系统允许一个进程创建新进程，新进程即为子进程，子进程还可以创建新的子进程，形成进程树结构模型。</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
pid_t <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>函数的作用：用于创建子进程。</li><li>返回值：<br> fork()的返回值会返回两次。一次是在父进程中，一次是在子进程中。 
  <ul><li>成功：子进程中返回 0，父进程中返回子进程 ID</li><li>失败：在父进程中返回-1，表示创建子进程失败，并且设置errno</li></ul> </li><li>如何区分父进程和子进程：通过fork的返回值。</li><li>失败的两个主要原因： 
  <ol><li>当前系统的进程数已经达到了系统规定的上限，这时 errno 的值被设置为 EAGAIN。</li><li>系统内存不足，这时 errno 的值被设置为 ENOMEM。</li></ol> </li><li>父子进程之间的关系：<br> 区别：<br> （1）fork()函数的返回值不同：父进程的返回值大于0，返回的是子进程的ID；子进程的返回值等于0。<br> （2）PCB中的一些数据不同：当前的进程的id pid、当前的进程的父进程的id ppid、信号集等。<br> 共同点：某些状态下，比如子进程刚被创建出来，还没有执行任何的写数据的操作时，用户区的数据、文件描述符表等相同。</li><li>父子进程对变量是不是共享的？ 
  <ul><li>刚开始的时候，是一样的，共享的。如果修改了数据，不共享了。</li><li>读时共享（子进程被创建，两个进程没有做任何的写的操作），写时拷贝。</li></ul> </li></ul> 
<p><strong>示例：</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建子进程</span>
    pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断是父进程还是子进程</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// printf("pid : %d\n", pid);</span>
        <span class="token comment">// 如果大于0，返回的是创建的子进程的进程号，当前是父进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am parent process, pid : %d, ppid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent num : %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        num <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent num += 10 : %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当前是子进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am child process, pid : %d, ppid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child num : %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        num <span class="token operator">+=</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child num += 100 : %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// for循环</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i : %d , pid : %d\n"</span><span class="token punctuation">,</span> i <span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>父子进程虚拟地址空间</strong><br> <img src="https://images2.imgbox.com/cf/37/MzdDuq4C_o.jpg" alt="在这里插入图片描述"><br> 实际上，更准确来说，Linux 的 fork() 使用是通过读时共享、写时拷贝（copy-on-write）的方式实现。写时拷贝是一种可以推迟甚至避免拷贝数据的技术。内核此时并不复制整个进程的地址空间，而是让父子进程共享同一个地址空间。只用在需要写入的时候才会复制地址空间，从而使各个进程拥有各自的地址空间。也就是说，资源的复制是在需要写入的时候才会进行，在此之前，只有以只读方式共享。</p> 
<p>注意⚠️：fork 之后父子进程共享文件，fork 产生的子进程与父进程的文件描述符相同，指向相同的文件表，引用计数增加，共享文件偏移指针。</p> 
<hr> 
<h3><a id="6_GDB__177"></a>6. GDB 多进程调试</h3> 
<ul><li>使用 GDB 调试的时候，GDB 默认只能跟踪一个进程，可以在 fork 函数调用之前，通过指令设置 GDB 调试工具跟踪父进程或者子进程，默认跟踪父进程。</li><li>设置调试父进程或者子进程的指令：<br> <code>set follow-fork-mode [parent（默认）| child]</code></li><li>设置调试模式：<br> <code>set detach-on-fork [on | off]</code><br> 默认为<code>on</code>，表示调试当前进程的时候，其它的进程继续运行；如果为<code>off</code>，调试当前进程的时候，其它的进程被 GDB 挂起。</li><li>查看调试的进程：<code>info inferiors</code></li><li>切换当前调试的进程：<code>inferior id</code></li><li>使进程脱离 GDB 调试：<code>detach inferiors id</code></li></ul> 
<h3><a id="7_exec__188"></a>7. exec 函数族</h3> 
<ul><li>exec 函数族的作用是根据指定的文件名找到可执行文件，并用它来取代调用进程的内容，换句话说，就是在调用进程内部执行一个可执行文件。</li><li>exec 函数族的函数执行成功后不会返回，因为调用进程的实体，包括代码段，数据段和堆栈等都已经被新的内容取代，只留下进程 ID 等一些表面上的信息仍保持原样，颇有些神似“三十六计”中的“金蝉脱壳”。看上去还是旧的躯壳，却已经注入了新的灵魂。只有调用失败了，它们才会返回 -1，从原程序的调用点接着往下执行。</li></ul> 
<p>exec 函数族<br> <img src="https://images2.imgbox.com/cd/a0/fmK1el5z_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="1int_execlconst_char_path_const_char_arg__194"></a>（1）<code>int execl(const char *path, const char *arg, ...);</code></h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">execl</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">-</span> 参数：
        <span class="token operator">-</span> path<span class="token operator">:</span>需要指定的可执行文件的路径或者名称
            a<span class="token punctuation">.</span>out <span class="token operator">/</span>home<span class="token operator">/</span>nowcoder<span class="token operator">/</span>a<span class="token punctuation">.</span>out 推荐使用绝对路径
            <span class="token punctuation">.</span><span class="token operator">/</span>a<span class="token punctuation">.</span>out

        <span class="token operator">-</span> arg<span class="token operator">:</span>是执行可执行文件所需要的参数列表
            第一个参数一般没有什么作用，为了方便，一般写的是执行的程序的名称
            从第二个参数开始往后，就是程序执行所需要的的参数列表。
            参数最后需要以<span class="token constant">NULL</span>结束（哨兵）

    <span class="token operator">-</span> 返回值：
        只有当调用失败，才会有返回值，返回<span class="token operator">-</span><span class="token number">1</span>，并且设置errno
        如果调用成功，没有返回值。
</code></pre> 
<p><strong>示例：</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>


    <span class="token comment">// 创建一个子进程，在子进程中执行exec函数族中的函数</span>
    pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 父进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am parent process, pid : %d\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 子进程</span>
        <span class="token comment">// execl("hello","hello",NULL);</span>

        <span class="token function">execl</span><span class="token punctuation">(</span><span class="token string">"/bin/ps"</span><span class="token punctuation">,</span> <span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am child process, pid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i = %d, pid = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2int_execlpconst_char_file_const_char_arg___245"></a>（2）<code>int execlp(const char *file, const char *arg, ... );</code></h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">-</span> 在环境变量中查找指定的可执行文件，如果找到了就执行，找不到就执行不成功。
    <span class="token operator">-</span> 参数：
        <span class="token operator">-</span> file<span class="token operator">:</span>需要执行的可执行文件的文件名
            a<span class="token punctuation">.</span>out
            ps

        <span class="token operator">-</span> arg<span class="token operator">:</span>是执行可执行文件所需要的参数列表
            第一个参数一般没有什么作用，为了方便，一般写的是执行的程序的名称
            从第二个参数开始往后，就是程序执行所需要的的参数列表。
            参数最后需要以<span class="token constant">NULL</span>结束（哨兵）

    <span class="token operator">-</span> 返回值：
        只有当调用失败，才会有返回值，返回<span class="token operator">-</span><span class="token number">1</span>，并且设置errno
        如果调用成功，没有返回值。


    <span class="token keyword">int</span> <span class="token function">execv</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    argv是需要的参数的一个字符串数组
    <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">execv</span><span class="token punctuation">(</span><span class="token string">"/bin/ps"</span><span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"/home/nowcoder"</span><span class="token punctuation">,</span> <span class="token string">"/home/bbb"</span><span class="token punctuation">,</span> <span class="token string">"/home/aaa"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>示例：</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>


    <span class="token comment">// 创建一个子进程，在子进程中执行exec函数族中的函数</span>
    pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 父进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am parent process, pid : %d\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 子进程</span>
        <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am child process, pid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i = %d, pid = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h3><a id="8__305"></a>8. 进程控制</h3> 
<h4><a id="81__306"></a>8.1 进程退出</h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">void</span> <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>status参数：是进程退出时的一个状态信息。父进程回收子进程资源的时候可以获取到。</p> 
<p><img src="https://images2.imgbox.com/f3/c4/aUYtLMcf_o.jpg" alt="在这里插入图片描述" width="400"></p> 
<h4><a id="82__318"></a>8.2 孤儿进程</h4> 
<ul><li>父进程运行结束，但子进程还在运行（未运行结束），这样的子进程就称为<strong>孤儿进程（Orphan Process）</strong>。</li><li>每当出现一个孤儿进程的时候，内核就把孤儿进程的父进程设置为<code>init</code> ，而 <code>init</code> 进程会循环地 <code>wait()</code> 已经退出的子进程。这样，当一个孤儿进程凄凉地结束了其生命周期的时候，<code>init</code> 进程就会代表党和政府出面处理它的一切善后工作。</li><li>因此孤儿进程并不会有什么危害。</li></ul> 
<p><strong>示例：</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 创建子进程</span>
    pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断是父进程还是子进程</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am parent process, pid : %d, ppid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 当前是子进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am child process, pid : %d, ppid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
    <span class="token punctuation">}</span>

    <span class="token comment">// for循环</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i : %d , pid : %d\n"</span><span class="token punctuation">,</span> i <span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="83__354"></a>8.3 僵尸进程</h4> 
<ul><li>每个进程结束之后, 都会释放自己地址空间中的用户区数据，内核区的 PCB 没有办法自己释放掉，需要父进程去释放。</li><li>进程终止时，父进程尚未回收，子进程残留资源（PCB）存放于内核中，变成僵尸（Zombie）进程。</li><li>僵尸进程不能被 kill -9 杀死，这样就会导致一个问题，如果父进程不调用 wait() 或 waitpid() 的话，那么保留的那段信息就不会释放，其进程号就会一直被占用，但是系统所能使用的进程号是有限的，如果大量的产生僵尸进程，将因为没有可用的进程号而导致系统不能产生新的进程，此即为僵尸进程的危害，应当避免。</li></ul> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 创建子进程</span>
    pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断是父进程还是子进程</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am parent process, pid : %d, ppid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当前是子进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am child process, pid : %d, ppid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
    <span class="token punctuation">}</span>

    <span class="token comment">// for循环</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i : %d , pid : %d\n"</span><span class="token punctuation">,</span> i <span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="84__390"></a>8.4 进程回收</h4> 
<ul><li>在每个进程退出的时候，内核释放该进程所有的资源、包括打开的文件、占用的内存等。但是仍然为其保留一定的信息，这些信息主要主要指进程控制块PCB的信息（包括进程号、退出状态、运行时间等）。</li><li>父进程可以通过调用<code>wait</code>或<code>waitpid</code>得到它的退出状态同时彻底清除掉这个进程。</li><li><code>wait()</code> 和 <code>waitpid()</code> 函数的功能一样，区别在于，<code>wait()</code> 函数会阻塞，<code>waitpid()</code> 可以设置不阻塞，<code>waitpid()</code> 还可以指定等待哪个子进程结束。</li></ul> 
<p>注意⚠️：一次<code>wait</code>或<code>waitpid</code>调用只能清理一个子进程，清理多个子进程应使用循环。</p> 
<h4><a id="85_pid_t_waitint_wstatus_397"></a>8.5 <code>pid_t wait(int *wstatus);</code></h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
pid_t <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>wstatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    功能：等待任意一个子进程结束，如果任意一个子进程结束了，次函数会回收子进程的资源。
    参数：<span class="token keyword">int</span> <span class="token operator">*</span>wstatus
        进程退出时的状态信息，传入的是一个<span class="token keyword">int</span>类型的地址，传出参数。
    返回值：
        <span class="token operator">-</span> 成功：返回被回收的子进程的id
        <span class="token operator">-</span> 失败：<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">(</span>所有的子进程都结束，调用函数失败<span class="token punctuation">)</span>

调用wait函数的进程会被挂起（阻塞），直到它的一个子进程退出或者收到一个不能被忽略的信号时才被唤醒（相当于继续往下执行）
如果没有子进程了，函数立刻返回，返回<span class="token operator">-</span><span class="token number">1</span>；如果子进程都已经结束了，也会立即返回，返回<span class="token operator">-</span><span class="token number">1.</span>
</code></pre> 
<p><strong>示例：</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 有一个父进程，创建5个子进程（兄弟）</span>
    pid_t pid<span class="token punctuation">;</span>

    <span class="token comment">// 创建5个子进程</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 父进程</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// int ret = wait(NULL);</span>
            <span class="token keyword">int</span> st<span class="token punctuation">;</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 是不是正常退出</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"退出的状态码：%d\n"</span><span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 是不是异常终止</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"被哪个信号干掉了：%d\n"</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child die, pid = %d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 子进程</span>
         <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child, pid = %d\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
         <span class="token punctuation">}</span>

        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// exit(0)</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h4><a id="86_pid_t_waitpidpid_t_pid_int_wstatus_int_options_475"></a>8.6 <code>pid_t waitpid(pid_t pid, int *wstatus, int options);</code></h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
pid_t <span class="token function">waitpid</span><span class="token punctuation">(</span>pid_t pid<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>wstatus<span class="token punctuation">,</span> <span class="token keyword">int</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    功能：回收指定进程号的子进程，可以设置是否阻塞。
    参数：
        <span class="token operator">-</span> pid<span class="token operator">:</span>
            pid <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">:</span> 某个子进程的pid
            pid <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">:</span> 回收当前进程组的所有子进程    
            pid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> 回收所有的子进程，相当于 <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  （最常用）
            pid <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> 某个进程组的组id的绝对值，回收指定进程组中的子进程
        <span class="token operator">-</span> options：设置阻塞或者非阻塞
            <span class="token number">0</span> <span class="token operator">:</span> 阻塞
            WNOHANG <span class="token operator">:</span> 非阻塞
        <span class="token operator">-</span> 返回值：
            <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">:</span> 返回子进程的id
            <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">:</span> options<span class="token operator">=</span>WNOHANG<span class="token punctuation">,</span> 表示还有子进程活着
            <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> ：错误，或者没有子进程了
</code></pre> 
<p><strong>示例：</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 有一个父进程，创建5个子进程（兄弟）</span>
    pid_t pid<span class="token punctuation">;</span>

    <span class="token comment">// 创建5个子进程</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 父进程</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> st<span class="token punctuation">;</span>
            <span class="token comment">// int ret = waitpid(-1, &amp;st, 0);</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 说明还有子进程存在</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 是不是正常退出</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"退出的状态码：%d\n"</span><span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 是不是异常终止</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"被哪个信号干掉了：%d\n"</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child die, pid = %d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
           
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 子进程</span>
         <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child, pid = %d\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
         <span class="token punctuation">}</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h4><a id="87__560"></a>8.7 退出信息相关宏函数</h4> 
<ul><li>WIFEXITED(status) 非0，进程正常退出</li><li>WEXITSTATUS(status) 如果上宏为真，获取进程退出的状态（exit的参数）</li><li>WIFSIGNALED(status) 非0，进程异常终止</li><li>WTERMSIG(status) 如果上宏为真，获取使进程终止的信号编号</li><li>WIFSTOPPED(status) 非0，进程处于暂停状态</li><li>WSTOPSIG(status) 如果上宏为真，获取使进程暂停的信号的编号</li><li>WIFCONTINUED(status) 非0，进程暂停后已经继续运行</li></ul> 
<hr> 
<h3><a id="9__570"></a>9. 进程间通信</h3> 
<h4><a id="91__571"></a>9.1 进程间通信概念</h4> 
<ul><li>进程是一个独立的资源分配单元，不同进程（这里所说的进程通常是指用户进程）之间的资源是独立的，没有关联，不能在一个进程中直接访问另一个进程的资源。</li><li>但是，进程不是孤立的，不同的进程需要进行信息的交互和状态的传递等，因此需要进程间通信 ( IPC：Inter Processes Communication )。</li><li>进程间通信的目的： 
  <ul><li>数据传输：一个进程需要将它的数据发送给另一个进程。</li><li>通知事件：一个进程需要向另一个或一组进程发送消息，通知它（它们）发生了某种事件（如进程终止时要通知父进程）。</li><li>资源共享：多个进程之间共享同样的资源。为了做到这一点，需要内核提供互斥和同步机制。</li><li>进程控制：有些进程希望完全控制另一个进程的执行（如 Debug 进程），此时控制进程希望能够拦截另一个进程的所有陷入和异常，并能够及时知道它的状态改变。</li></ul> </li></ul> 
<hr> 
<h4><a id="92_Linux__580"></a>9.2 Linux 进程间通信的方式</h4> 
<p><img src="https://images2.imgbox.com/e6/4b/601KGsfw_o.jpg" alt="在这里插入图片描述" width="650"></p> 
<hr> 
<h4><a id="93__583"></a>9.3 匿名管道</h4> 
<ul><li>管道也叫匿名（无名）管道，它是 UNIX 系统 IPC（进程间通信）最古老的形式，所以的 UNIX 系统都支持这种通信机制。</li><li>统计一个目录中文件的数目命令：<code>ls | wc -l</code>，为了执行该命令，shell 创建了两个进程来分别执行 ls 和 wc。<br> <img src="https://images2.imgbox.com/eb/f2/DJlrjK0E_o.jpg" alt="在这里插入图片描述" width="800"></li></ul> 
<h4><a id="94__587"></a>9.4 管道的特点</h4> 
<ul><li>管道其实是一个在内核内存中维护的缓冲器，这个缓冲器的存储能力是有限的，不同的操作系统大小不一定相同。</li><li>管道拥有文件的特质：读文件、写文件，匿名管道没有文件实体，有名管道有文件实体，但是文件不存储数据。可以按照操作文件的方式对管道进行操作。</li><li>管道上的数据是以字节流的方式进行传输，使用管道时不存在消息或者消息边界的概念，从管道读取数据的进程可以读取任意大小的数据块，而不管写入管道的数据块的大小是多少。</li><li>通过管道传递的数据是顺序的，从管道中读取出来的字节的顺序和数据被写入管道的顺序是完全一致的。</li><li>数据在管道中的传递方向是单向的，一端用于写入，一端用于读取，管道是半双工的。</li><li>从管道中读取数据是一次性操作，数据一旦被读取，它就从管道中被抛弃，释放空间以便写入更多的数据，在管道中无法使用 <code>lseek()</code> 来随机的访问数据。</li><li>匿名管道只能在具有公共祖先的进程间通信时使用，比如父进程与子进程、两个兄弟进程以及具有亲缘关系的进程间通信。<br> <img src="https://images2.imgbox.com/2c/6a/P7GuMqBY_o.jpg" alt="在这里插入图片描述" width="800"></li></ul> 
<hr> 
<h4><a id="95__597"></a>9.5 为什么可以使用管道进行进程间通信</h4> 
<p>因为当父进程fork一个子进程时，子进程会复制父进程的虚拟地址空间，在父进程虚拟地址空间内核区中的文件描述符表会被复制到子进程中，因此父子进程可通过相同的文件描述符对管道进行读写操作。<br> <img src="https://images2.imgbox.com/29/92/N40GcjUZ_o.jpg" alt="在这里插入图片描述" width="850"></p> 
<hr> 
<h4><a id="96__601"></a>9.6 管道的数据结构</h4> 
<p><img src="https://images2.imgbox.com/a0/5e/m7jOcuu8_o.jpg" alt="在这里插入图片描述" width="800"></p> 
<hr> 
<h4><a id="97_int_pipeint_pipefd2_604"></a>9.7 创建匿名管道：<code>int pipe(int pipefd[2]);</code></h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    功能：创建一个匿名管道，用来进程间通信。
    参数：<span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> 这个数组是一个传出参数。
         pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> 对应的是管道的读端
         pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> 对应的是管道的写端
    返回值：
        <span class="token operator">-</span> 成功：<span class="token number">0</span>
        <span class="token operator">-</span> 失败：<span class="token operator">-</span><span class="token number">1</span>

管道默认是阻塞的：如果管道中没有数据，read阻塞，如果管道满了，write阻塞

注意：匿名管道只能用于具有关系的进程之间的通信（父子进程，兄弟进程）
</code></pre> 
<p><strong>示例：</strong></p> 
<pre><code class="prism language-cpp"><span class="token comment">// 子进程发送数据给父进程，父进程读取到数据输出</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 在fork之前创建管道</span>
    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建子进程</span>
    pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 父进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am parent process, pid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 关闭写端</span>
        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 从管道的读取端读取数据</span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent recv : %s, pid : %d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 向管道中写入数据</span>
            <span class="token comment">//char * str = "hello,i am parent";</span>
            <span class="token comment">//write(pipefd[1], str, strlen(str));</span>
            <span class="token comment">//sleep(1);</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 子进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am child process, pid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关闭读端</span>
        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//char buf[1024] = {0};</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 向管道中写入数据</span>
            <span class="token keyword">char</span> <span class="token operator">*</span> str <span class="token operator">=</span> <span class="token string">"hello,i am child"</span><span class="token punctuation">;</span>
            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//sleep(1);</span>

            <span class="token comment">// int len = read(pipefd[0], buf, sizeof(buf));</span>
            <span class="token comment">// printf("child recv : %s, pid : %d\n", buf, getpid());</span>
            <span class="token comment">// bzero(buf, 1024);</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h4><a id="98_ulimit_a_682"></a>9.8 查看管道缓存大小命令：<code>ulimit -a</code></h4> 
<hr> 
<h4><a id="99_long_fpathconfint_fd_int_name_684"></a>9.9 查看管道缓冲大小函数：<code>long fpathconf(int fd, int name);</code></h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取管道的大小</span>
    <span class="token keyword">long</span> size <span class="token operator">=</span> <span class="token function">fpathconf</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> _PC_PIPE_BUF<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipe size : %ld\n"</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h4><a id="910__707"></a>9.10 匿名管道的使用</h4> 
<p><img src="https://images2.imgbox.com/9a/83/PSI3erPC_o.jpg" alt="在这里插入图片描述" width="800"><br> <strong>示例：</strong><br> 实现 <code>ps aux | grep xxx</code>父子进程间通信</p> 
<p>解析：子进程执行<code>ps aux</code>，子进程执行结束后，将数据发送给父进程；父进程获取到数据后，对数据进行过滤。<br> <code>pipe()</code>、<code>execp()</code>，子进程将标准输出<code>stdout_fileno</code>重定向到管道的写端:<code>dup2()</code>。</p> 
<p>代码实现：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;wait.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 创建一个管道</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建子进程</span>
    pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 父进程</span>
        <span class="token comment">// 关闭写端</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从管道中读取</span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 过滤数据输出</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 子进程</span>
        <span class="token comment">// 关闭读端</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 文件描述符的重定向 stdout_fileno -&gt; fd[1]</span>
        <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行 ps aux</span>
        <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execlp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h4><a id="911__774"></a>9.11 管道的读写特点</h4> 
<ul><li>使用管道时，需要注意以下几种特殊的情况（假设都是阻塞I/O操作）：</li></ul> 
<ol><li>如果所有指向管道写端的文件描述符都已关闭（管道的写端引用计数为0），有进程从管道的读端读数据，那么管道中剩余的数据被读取完以后，再次<code>read</code>数据会返回<code>0</code>，就像读取到文件末尾一样。</li><li>如果有指向管道写端的文件描述符没有关闭（管道的写端引用计数大于0），而持有管道写端的进程也没有向管道中写数据，这个时候有进程从管道中读取数据，那么管道中剩余的数据被读取后，再次<code>read</code>数据会阻塞，直到管道中有数据，才读取数据并返回。</li><li>如果所有指向管道读端的文件描述符都已关闭（管道的读端引用计数为0），这个时候有进程向管道中写数据，那么该进程会收到一个信号<code>SIGPIPE</code>，通常会导致进程异常终止。</li><li>如果有指向管道读端的文件描述符没有关闭（管道的读端引用计数大于0），而持有管道读端的进程也没有从管道中读数据，这时有进程向管道中写数据，那么当管道被写满的时候再次<code>write</code>会阻塞，直到管道中有空位置才能再次写入数据并返回。</li></ol> 
<p><strong>总结：</strong></p> 
<p>读数据：</p> 
<ul><li>当管道中有数据，<code>read</code>返回实际读取到的字节数。</li><li>当管道中无数据，写端被全部关闭时，<code>read</code>返回<code>0</code>（相当于读取到文件的末尾）。</li><li>当管道中无数据，写端没有完全关闭时，<code>read</code>阻塞等待。</li></ul> 
<p>写数据：</p> 
<ul><li>当管道读端全部关闭时，进程会异常终止（进程收到<code>SIGPIPE</code>信号）。</li><li>当管道读端没有全部关闭，管道已满时，<code>write</code>阻塞。</li><li>当管道读端没有全部关闭，管道没有满时，<code>weite</code>将数据写入，并返回实际写入的字节数。</li></ul> 
<hr> 
<h4><a id="913__793"></a>9.13 将管道设置为非阻塞的操作</h4> 
<p>将管道读端设置为非阻塞</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取原来的flag</span>
flags <span class="token operator">|=</span> O_NONBLOCK<span class="token punctuation">;</span>            <span class="token comment">// 修改flag的值</span>
<span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 设置新的flag</span>
</code></pre> 
<p><strong>示例：</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 在fork之前创建管道</span>
    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建子进程</span>
    pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 父进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am parent process, pid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 关闭写端</span>
        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 从管道的读取端读取数据</span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取原来的flag</span>
        flags <span class="token operator">|=</span> O_NONBLOCK<span class="token punctuation">;</span>            <span class="token comment">// 修改flag的值</span>
        <span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 设置新的flag</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"len : %d\n"</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent recv : %s, pid : %d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 子进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am child process, pid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关闭读端</span>
        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 向管道中写入数据</span>
            <span class="token keyword">char</span> <span class="token operator">*</span> str <span class="token operator">=</span> <span class="token string">"hello,i am child"</span><span class="token punctuation">;</span>
            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h4><a id="914__862"></a>9.14 有名管道</h4> 
<ul><li>匿名管道，由于没有文件实体，只能用于亲缘关系的进程间通信。为了克服这个缺点，提出了有名管道（FIFO），也叫命名管道、FIFO文件。</li><li>有名管道（FIFO）不同于匿名管道之处在于它提供了一个路径名与之关联，以 FIFO 的文件形式存在于文件系统中，并且其打开方式与打开一个普通文件一样，这样即使使用 FIFO 进行不存在亲缘关系的进程间通信，只要进程可以访问该路径，就能够彼此通过 FIFO 相互通信，因此，通过 FIFO 不相关的进程也能交换数据。</li><li>一旦打开了 FIFO，就能在它上面使用与操作匿名管道和其他文件的系统调用一样的 I/O 系统调用了（如read()、write()和close()）。与管道一样，FIFO 也有一个写端和读端，并且从管道中读取数据的顺序与写入数据的顺序是一样的。FIFO 的名称也由此而来：先入先出。</li><li>有名管道（FIFO）和匿名管道（pipe）有一些不同点： 
  <ol><li>FIFO 在文件系统中作为一个特殊文件存在，但 FIFO 中的内容却存放在内存中。</li><li>当使用 FIFO 的进程退出后，FIFO 文件将继续保存在文件系统中以便以后使用。</li><li>FIFO 有名字，不相关的进程可以通过打开有名管道进行通信。</li></ol> </li></ul> 
<hr> 
<h4><a id="915__871"></a>9.15 有名管道的创建与使用</h4> 
<ul><li>通过命令创建有名管道：<code>mkfifo 管道名称</code></li><li>通过函数创建有名管道：</li></ul> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> mode_t mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    参数：
        <span class="token operator">-</span> pathname<span class="token operator">:</span> 管道名称的路径
        <span class="token operator">-</span> mode<span class="token operator">:</span> 文件的权限 和 open 的 mode 是一样的
                是一个八进制的数
    返回值：成功返回<span class="token number">0</span>，失败返回<span class="token operator">-</span><span class="token number">1</span>，并设置错误号
</code></pre> 
<p><strong>示例：</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 判断文件是否存在</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"fifo1"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"管道不存在，创建管道\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"fifo1"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkfifo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>       

    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li> <p>一旦使用 <code>mkfifo</code> 创建一个FIFO，就可以使用 open 打开它，常见的文件 I/O 函数都可用于 FIFO，如：close、read、write、unlink 等。</p> </li><li> <p>FIFO 严格遵循先进先出（First in First out），对管道及 FIFO 的读总是从开始处返回数据，对它们的写则把数据添加到末尾。它们不支持如 lseek() 等文件定位操作。</p> </li><li> <p>有名管道注意事项：</p> 
  <ol><li>一个为只读而打开一个管道的进程会阻塞，直到另外一个进程为只写打开管道</li><li>一个为只写而打开一个管道的进程会阻塞，直到另外一个进程为只读打开管道</li></ol> </li><li> <p>用有名管道实现两个进程间的通信<br> （1）write.c文件</p> </li></ul> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 1.判断文件是否存在</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"管道不存在，创建管道\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 2.创建管道文件</span>
        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkfifo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>       

    <span class="token punctuation">}</span>

    <span class="token comment">// 3.以只写的方式打开管道</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 写数据</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"hello, %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write data : %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（2）read.c文件</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token comment">// 从管道中读取数据</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.打开管道文件</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读数据</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"写端断开连接了...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv buf : %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h4><a id="916__1000"></a>9.16 使用有名管道实现简单版聊天功能</h4> 
<p><img src="https://images2.imgbox.com/99/0a/WEKBiPHZ_o.png" alt="在这里插入图片描述" width="900"></p> 
<hr> 
<p>（1）chatA.c 文件</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 1.判断有名管道文件是否存在</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"fifo1"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 文件不存在</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"管道不存在，创建对应的有名管道\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"fifo1"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkfifo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"fifo2"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 文件不存在</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"管道不存在，创建对应的有名管道\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"fifo2"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkfifo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2.以只写的方式打开管道fifo1</span>
    <span class="token keyword">int</span> fdw <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"fifo1"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"打开管道fifo1成功，等待写入...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.以只读的方式打开管道fifo2</span>
    <span class="token keyword">int</span> fdr <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"fifo2"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fdr <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"打开管道fifo2成功，等待读取...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.循环的写读数据</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取标准输入的数据</span>
        <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 写数据</span>
        ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fdw<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 5.读管道数据</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fdr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buf: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 6.关闭文件描述符</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fdr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fdw<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<p>（2）chatB.c 文件</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 1.判断有名管道文件是否存在</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"fifo1"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 文件不存在</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"管道不存在，创建对应的有名管道\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"fifo1"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkfifo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"fifo2"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 文件不存在</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"管道不存在，创建对应的有名管道\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"fifo2"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkfifo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2.以只读的方式打开管道fifo1</span>
    <span class="token keyword">int</span> fdr <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"fifo1"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fdr <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"打开管道fifo1成功，等待读取...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.以只写的方式打开管道fifo2</span>
    <span class="token keyword">int</span> fdw <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"fifo2"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"打开管道fifo2成功，等待写入...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.循环的读写数据</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 5.读管道数据</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fdr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buf: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取标准输入的数据</span>
        <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 写数据</span>
        ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fdw<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 6.关闭文件描述符</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fdr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fdw<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h4><a id="917__1167"></a>9.17 内存映射</h4> 
<ul><li>内存映射（Memory-mapped I/O）是将磁盘文件的数据映射到内存，用户通过修改内存就能修改磁盘文件。<br> <img src="https://images2.imgbox.com/40/19/LzLicfoV_o.jpg" alt="在这里插入图片描述" width="800"></li></ul> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> size_t length<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> off_t offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">-</span> 功能：将一个文件或者设备的数据映射到内存中
    <span class="token operator">-</span> 参数：
        <span class="token operator">-</span> <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> 由内核指定
        <span class="token operator">-</span> length <span class="token operator">:</span> 要映射的数据的长度，这个值不能为<span class="token number">0</span>。建议使用文件的长度。
                获取文件的长度：stat lseek
        <span class="token operator">-</span> prot <span class="token operator">:</span> 对申请的内存映射区的操作权限
            <span class="token operator">-</span>PROT_EXEC ：可执行的权限
            <span class="token operator">-</span>PROT_READ ：读权限
            <span class="token operator">-</span>PROT_WRITE ：写权限
            <span class="token operator">-</span>PROT_NONE ：没有权限
            要操作映射内存，必须要有读的权限。
            PROT_READ、PROT_READ<span class="token operator">|</span>PROT_WRITE
        <span class="token operator">-</span> flags <span class="token operator">:</span>
            <span class="token operator">-</span> MAP_SHARED <span class="token operator">:</span> 映射区的数据会自动和磁盘文件进行同步，进程间通信，必须要设置这个选项
            <span class="token operator">-</span> MAP_PRIVATE ：不同步，内存映射区的数据改变了，对原来的文件不会修改，会重新创建一个新的文件。（copy on write）
        <span class="token operator">-</span> fd<span class="token operator">:</span> 需要映射的那个文件的文件描述符
            <span class="token operator">-</span> 通过open得到，open的是一个磁盘文件
            <span class="token operator">-</span> 注意：文件的大小不能为<span class="token number">0</span>，open指定的权限不能和prot参数有冲突。
                prot<span class="token operator">:</span> PROT_READ                open<span class="token operator">:</span>只读<span class="token operator">/</span>读写 
                prot<span class="token operator">:</span> PROT_READ <span class="token operator">|</span> PROT_WRITE   open<span class="token operator">:</span>读写
        <span class="token operator">-</span> offset：偏移量，一般不用。必须指定的是<span class="token number">4</span>k的整数倍，<span class="token number">0</span>表示不便宜。
    <span class="token operator">-</span> 返回值：返回创建的内存的首地址
        失败返回MAP_FAILED，<span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span>

<span class="token keyword">int</span> <span class="token function">munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> size_t length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">-</span> 功能：释放内存映射
    <span class="token operator">-</span> 参数：
        <span class="token operator">-</span> addr <span class="token operator">:</span> 要释放的内存的首地址
        <span class="token operator">-</span> length <span class="token operator">:</span> 要释放的内存的大小，要和mmap函数中的length参数的值一样。
</code></pre> 
<ul><li>使用内存映射实现进程间通信： 
  <ol><li>有关系的进程间通信（父子进程）：通过唯一的父进程，先创建内存映射区，有了内存映射区以后，创建子进程，父子进程共享创建的内存映射区。</li><li>没有关系的进程间通信：首先准备一个大小不为0的磁盘空间，对于进程1来说，通过磁盘文件创建内存映射区，得到一个操作这块内存的指针；对于进程2来说，同样通过磁盘文件创建内存映射区，得到一个操作这块内存的指针，然后使用内存映射区进行通信。<br> 注意⚠️：内存映射区通信，是非阻塞的。</li></ol> </li></ul> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;wait.h&gt;</span></span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 1.打开一个文件</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取文件的大小</span>

    <span class="token comment">// 2.创建内存映射区</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3.创建子进程</span>
    pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 父进程</span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read data : %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
       
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 子进程</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">,</span> <span class="token string">"hello, james!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 关闭内存映射区</span>
    <span class="token function">munmap</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="918__1251"></a>9.18 内存映射的注意事项</h4> 
<ol><li> <p>如果对mmap的返回值(ptr)做++操作(ptr++), munmap是否能够成功?</p> <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ptr<span class="token operator">++</span><span class="token punctuation">;</span>  可以对其进行<span class="token operator">++</span>操作
<span class="token function">munmap</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 错误,要保存地址</span>
</code></pre> </li><li> <p>如果 open 时 O_RDONLY , mmap 时 prot 参数指定 PROT_READ | PROT_WRITE 会怎样?<br> 错误，返回MAP_FAILED。open()函数中的权限建议和prot参数的权限保持一致。</p> </li><li> <p>如果文件偏移量为1000会怎样?<br> 偏移量必须是4K的整数倍，返回MAP_FAILED。</p> </li><li> <p>mmap什么情况下会调用失败?</p> 
  <ul><li>第二个参数：length = 0</li><li>第三个参数：prot 
    <ul><li>只指定了写权限</li><li>prot PROT_READ | PROT_WRITE<br> 第5个参数fd 通过open函数时指定的 O_RDONLY / O_WRONLY</li></ul> </li></ul> </li><li> <p>可以open的时候O_CREAT一个新文件来创建映射区吗?</p> 
  <ul><li>可以的，但是创建的文件的大小如果为0的话，肯定不行。</li><li>可以对新的文件进行扩展 
    <ul><li>lseek()</li><li>truncate()</li></ul> </li></ul> </li><li> <p>mmap后关闭文件描述符，对mmap映射有没有影响？</p> <pre><code class="prism language-cpp"><span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"XXX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mmap</span><span class="token punctuation">(</span><span class="token punctuation">,</span><span class="token punctuation">,</span><span class="token punctuation">,</span><span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <p>映射区还存在，创建映射区的fd被关闭，没有任何影响。</p> </li><li> <p>对ptr越界操作会怎样？<br> void * ptr = mmap(NULL, 100,);<br> 4K<br> 越界操作操作的是非法的内存 -&gt; 段错误</p> </li></ol> 
<hr> 
<h4><a id="919__1290"></a>9.19 使用内存映射实现文件拷贝的功能</h4> 
<p>思路：</p> 
<ol><li>对原始的文件进行内存映射</li><li>创建一个新文件（拓展该文件）</li><li>把新文件的数据映射到内存中</li><li>通过内存拷贝将第一个文件的内存数据拷贝到新的文件内存中</li><li>释放资源</li></ol> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 1.对原始的文件进行内存映射</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"english.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取原始文件的大小</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2.创建一个新文件（拓展该文件）</span>
    <span class="token keyword">int</span> fd1 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"cpy.txt"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd1 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 对新创建的文件进行拓展</span>
    <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token string">"cpy.txt"</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd1<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3.分别做内存映射</span>
    <span class="token keyword">void</span> <span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span> ptr1 <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ptr1 <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 内存拷贝</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>ptr1<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 释放资源</span>
    <span class="token function">munmap</span><span class="token punctuation">(</span>ptr1<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">munmap</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="920__1358"></a>9.20 信号的概念</h4> 
<ul><li>信号是 Linux 进程间通信最古老的方式之一，是事件发生时对进程的通知机制，有时也称之为软件中断，它是在软件层面上对中断机制的一种模拟，是一种异步通信的方式。信号可以导致一个正在运行的进程被另一个正在运行的异步进程中断，转而处理某一个突发事件。</li><li>发往进程的诸多信号，通常都是源于内核。引发内核为进程产生信号的各类事件如下： 
  <ul><li>对于前台进程，用户可以通过输入特殊的终端字符来给它发送信号。比如输入Ctrl+C，通常会给进程发送一个中断信号。</li><li>硬件发生异常，即硬件检测到一个错误条件并通知内核，随即再由内核发送相应信号给相关进程。比如执行一条异常的机器语言指令，诸如被 0 除，或者引用了无法访问的内存区域。</li><li>系统状态变化，比如 alarm 定时器到期将引起 SIGALRM 信号，进程执行的 CPU 时间超限，或者该进程的某个子进程退出。</li><li>运行 kill 命令或调用 kill 函数。</li></ul> </li><li>使用信号的两个主要目的是： 
  <ul><li>让进程知道已经发生了一个特定的事情。</li><li>强迫进程执行它自己代码中的信号处理程序。</li></ul> </li><li>信号的特点：简单、不能携带大量信号、满足某个特定条件才发送、优先级比较高。</li><li>查看系统定义的信号列表：<code>kill -l</code></li><li>前 31 个信号为常规信号，其余信号为实时信号。</li></ul> 
<hr> 
<h4><a id="921_Linux__1372"></a>9.21 Linux 信号一览表</h4> 
<p><img src="https://images2.imgbox.com/56/12/GxmTGYaF_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/22/78/bsLWj5VL_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a6/ce/izxcSUHP_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/72/17/cwVNijDm_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="922_5_1377"></a>9.22 信号的5种默认处理动作</h4> 
<ul><li>查看信号的详细内容：<code>man 7 signal</code></li><li>信号的5种默认处理行为 
  <ul><li><code>Term</code> 终止进程</li><li><code>Ign</code> 当前进程忽略掉这个信号</li><li><code>Core</code> 终止进程，并生成一个Core文件</li><li><code>Stop</code> 暂停当前进程</li><li><code>Cont</code> 继续执行当前被暂停的进程</li></ul> </li><li>信号的几种状态：产生、未决、递达</li><li><code>SIGKILL</code>和<code>SIGSTOP</code>信号不能被捕捉、阻塞或者忽略，只能执行默认动作。</li></ul> 
<h5><a id="Core_1387"></a>Core文件详解</h5> 
<p>在当前目录编写一个<code>core.c</code>的程序，源代码为</p> 
<pre><code class="prism language-c++">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int main()
{
    char * buf;
    strcpy(buf, "hello");
    return 0;
}
</code></pre> 
<p>很明显在执行<code>strcpy</code>函数时，出现了非法访问内存的现象，也就是段错误，那么如何生成<code>Core</code>文件，查看错误产生的原因呢？</p> 
<ul><li> <p>在当前目录下，输入<code>ulimit -a</code>，可查看<code>core file size</code></p> <p>如果<code>core</code>文件的大小为0，则需要更改其大小，指令为<code>ulimit -c 1024</code>，这里的<code>1024</code>为<code>core</code>文件更改后的大小。</p> </li><li> <p>由于需要对<code>core</code>文件进行操作，所以编译时可使用指令<code>gcc core.c -g</code>，生成可执行文件<code>a.out</code>。</p> </li><li> <p>执行<code>./a.out</code>，就会在当前目录下生成<code>core</code>文件</p> </li><li> <p>通过<code>gdb a.out</code>调试程序，在<code>gdb</code>模式下执行<code>core-file core</code>便可查看错误产生的原因，如下所示：</p> <pre><code class="prism language-c++">[New LWP 1275052]
Core was generated by `./a.out'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x0000565221b77135 in main () at core.c:7
7           strcpy(buf, "hello");
</code></pre> </li></ul> 
<h4><a id="923__1425"></a>9.23 信号相关的函数</h4> 
<ol><li> <p><code>int kill(pid_t pid, int sig);</code> 给任何的进程或者进程组pid, 发送任何的信号 sig</p> </li><li> <p><code>int raise(int sig);</code> 给当前进程发送信号</p> </li><li> <p><code>void abort(void);</code> 发送<code>SIGABRT</code>信号给当前的进程，杀死当前进程</p> </li></ol> 
<pre><code class="prism language-cpp"><span class="token comment">/*  
    #include &lt;sys/types.h&gt;
    #include &lt;signal.h&gt;

    int kill(pid_t pid, int sig);
        - 功能：给任何的进程或者进程组pid, 发送任何的信号 sig
        - 参数：
            - pid ：
                &gt; 0 : 将信号发送给指定的进程
                = 0 : 将信号发送给当前的进程组
                = -1 : 将信号发送给每一个有权限接收这个信号的进程
                &lt; -1 : 这个pid=某个进程组的ID取反 （-12345）
            - sig : 需要发送的信号的编号或者是宏值，0表示不发送任何信号

        kill(getppid(), 9);
        kill(getpid(), 9);
        
    int raise(int sig);
        - 功能：给当前进程发送信号
        - 参数：
            - sig : 要发送的信号
        - 返回值：
            - 成功 0
            - 失败 非0
        等价于 kill(getpid(), sig);   

    void abort(void);
        - 功能： 发送SIGABRT信号给当前的进程，杀死当前进程
        等价于 kill(getpid(), SIGABRT);
*/</span>
   
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 子进程</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child process\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 父进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent process\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"kill child process now\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>执行结果：</p> 
<pre><code>parent process
child process
child process
kill child process now
</code></pre> 
<p>在这次执行时，子进程输出两次<code>child process</code>后，就被父进程给杀死。</p> 
<hr> 
<ol start="4"><li><code>unsigned int alarm(unsigned int seconds);</code></li></ol> 
<pre><code class="prism language-cpp"><span class="token comment">/*
    #include &lt;unistd.h&gt;
    unsigned int alarm(unsigned int seconds);
        - 功能：设置定时器（闹钟）。函数调用，开始倒计时，当倒计时为0的时候，
                函数会给当前的进程发送一个信号：SIGALARM
        - 参数：
            seconds: 倒计时的时长，单位：秒。如果参数为0，定时器无效（不进行倒计时，不发信号）。
                    取消一个定时器，通过alarm(0)。
        - 返回值：
            - 之前没有定时器，返回0
            - 之前有定时器，返回之前的定时器剩余的时间

    - SIGALARM ：默认终止当前的进程，每一个进程都有且只有唯一的一个定时器。
        alarm(10);  -&gt; 返回0
        过了1秒
        alarm(5);   -&gt; 返回9

    alarm(100) -&gt; 该函数是不阻塞的
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">int</span> seconds <span class="token operator">=</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"seconds = %d\n"</span><span class="token punctuation">,</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 0</span>

    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seconds <span class="token operator">=</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 不阻塞</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"seconds = %d\n"</span><span class="token punctuation">,</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 3</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行结果为：</p> 
<pre><code>seconds = 0
seconds = 3
zsh: alarm
</code></pre> 
<p>例子：1秒钟电脑能数多少个数？</p> 
<pre><code class="prism language-cpp"><span class="token comment">// 1秒钟电脑能数多少个数？</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token comment">/*
    实际的时间 = 内核时间 + 用户时间 + 消耗的时间
    进行文件IO操作的时候比较浪费时间

    定时器，与进程的状态无关（自然定时法）。无论进程处于什么状态，alarm都会计时。
*/</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    

    <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%i\n"</span><span class="token punctuation">,</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<ol start="5"><li><code>int setitimer(int which, const struct itimerval *new_val, struct itimerval *old_value);</code></li></ol> 
<pre><code class="prism language-cpp"><span class="token comment">/*
    #include &lt;sys/time.h&gt;
    int setitimer(int which, const struct itimerval *new_value,
                        struct itimerval *old_value);
    
        - 功能：设置定时器（闹钟）。可以替代alarm函数。精度微秒us，可以实现周期性定时
        - 参数：
            - which : 定时器以什么时间计时
              ITIMER_REAL: 真实时间，时间到达，发送 SIGALRM   常用
              ITIMER_VIRTUAL: 用户时间，时间到达，发送 SIGVTALRM
              ITIMER_PROF: 以该进程在用户态和内核态下所消耗的时间来计算，时间到达，发送 SIGPROF

            - new_value: 设置定时器的属性
            
                struct itimerval {      // 定时器的结构体
                struct timeval it_interval;  // 每个阶段的时间，间隔时间
                struct timeval it_value;     // 延迟多长时间执行定时器
                };

                struct timeval {        // 时间的结构体
                    time_t      tv_sec;     //  秒数     
                    suseconds_t tv_usec;    //  微秒    
                };

            过3秒后，每隔2秒定时一次
           
            - old_value ：记录上一次的定时的时间参数，一般不使用，指定NULL
        
        - 返回值：
            成功 0
            失败 -1 并设置错误号
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token comment">// 过3秒以后，每隔2秒钟定时一次</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> new_value<span class="token punctuation">;</span>

    <span class="token comment">// 设置间隔的时间</span>
    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置延迟的时间,3秒之后开始第一次定时</span>
    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>


    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞的</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"定时器开始了...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setitimer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行结果为：</p> 
<pre><code>定时器开始了...
zsh: alarm
</code></pre> 
<p>在这个程序中，第一次定时的时间到达以后，整个进程就终止了，原因就是该程序没有去捕捉<code>SIGALARM</code>信号。</p> 
<hr> 
<ol start="6"><li><code>sighandler_t signal(int signum, sighandler_t handler);</code></li></ol> 
<pre><code class="prism language-cpp"><span class="token comment">/*
    #include &lt;signal.h&gt;
    typedef void (*sighandler_t)(int);
    sighandler_t signal(int signum, sighandler_t handler);
        - 功能：设置某个信号的捕捉行为
        - 参数：
            - signum: 要捕捉的信号
            - handler: 捕捉到信号要如何处理
                - SIG_IGN ： 忽略信号
                - SIG_DFL ： 使用信号默认的行为
                - 回调函数 :  这个函数是内核调用，程序员只负责编写回调函数，捕捉到信号后由内核自动调用该函数去处理信号。
                回调函数：
                    - 需要程序员实现，提前准备好的，函数的类型根据实际需求，看函数指针的定义
                    - 不是程序员调用，而是当信号产生，由内核调用
                    - 函数指针是实现回调的手段，函数实现之后，将函数名放到函数指针的位置就可以了。

        - 返回值：
            成功，返回上一次注册的信号处理函数的地址。第一次调用返回NULL
            失败，返回SIG_ERR，设置错误号
            
    SIGKILL SIGSTOP不能被捕捉，不能被忽略。
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">myalarm</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"捕捉到了信号的编号是：%d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"xxxxxxx\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 过3秒以后，每隔2秒钟定时一次</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 注册信号捕捉</span>
    <span class="token comment">// signal(SIGALRM, SIG_IGN);</span>
    <span class="token comment">// signal(SIGALRM, SIG_DFL);</span>
    <span class="token comment">// void (*sighandler_t)(int); 函数指针，int类型的参数表示捕捉到的信号的值。</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span> myalarm<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> new_value<span class="token punctuation">;</span>

    <span class="token comment">// 设置间隔的时间</span>
    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置延迟的时间,3秒之后开始第一次定时</span>
    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞的</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"定时器开始了...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setitimer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="7"><li><code>int sigaction(int signum, const struct sigaction *act, struct sigaction *oldact);</code></li></ol> 
<hr> 
<h4><a id="924__1738"></a>9.24 信号集</h4> 
<ul><li> <p>许多信号相关的系统调用都需要能表示一组不同的信号，多个信号可使用一个称之为信号集的数据结构来表示，其系统数据类型为 sigset_t。</p> </li><li> <p>在 PCB 中有两个非常重要的信号集。一个称之为 “阻塞信号集” ，另一个称之为“未决信号集” 。这两个信号集都是内核使用位图机制来实现的。但操作系统不允许我们直接对这两个信号集进行位操作。而需自定义另外一个集合，借助信号集操作函数来对 PCB 中的这两个信号集进行修改。</p> </li><li> <p>信号的 “未决” 是一种状态，指的是从信号的产生到信号被处理前的这一段时间。</p> </li><li> <p>信号的 “阻塞” 是一个开关动作，指的是阻止信号被处理，但不是阻止信号产生。</p> </li><li> <p>信号的阻塞就是让系统暂时保留信号留待以后发送。由于另外有办法让系统忽略信号，所以一般情况下信号的阻塞只是暂时的，只是为了防止信号打断敏感的操作。</p> </li></ul> 
<p>信号从产生到最终被处理的过程：</p> 
<p>1.用户通过键盘 <code>Ctrl + C</code>，产生2号信号<code>SIGINT</code> (信号被创建)</p> 
<p>2.信号产生但是没有被处理 （未决）</p> 
<ul><li>在内核中将所有的没有被处理的信号存储在一个集合中 （未决信号集）</li><li><code>SIGINT</code>信号状态被存储在第二个标志位上 
  <ul><li>这个标志位的值为<code>0</code>， 说明信号不是未决状态</li><li>这个标志位的值为<code>1</code>， 说明信号处于未决状态</li></ul> </li></ul> 
<p>3.这个未决状态的信号，需要被处理，处理之前需要和另一个信号集（阻塞信号集），进行比较</p> 
<ul><li>阻塞信号集默认不阻塞任何的信号</li><li>如果想要阻塞某些信号需要用户调用系统的<code>API</code></li></ul> 
<p>4.在处理的时候对阻塞信号集中的标志位进行查询，看是不是对该信号设置阻塞了</p> 
<ul><li>如果没有阻塞，这个信号就被处理</li><li>如果阻塞了，这个信号就继续处于未决状态，直到阻塞解除，这个信号才被处理</li></ul> 
<p><img src="https://images2.imgbox.com/ee/41/NvTLfO5u_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="925__1773"></a>9.25 信号集相关的函数</h4> 
<p><strong>以下信号集相关的5个函数都是对自定义的信号集进行操作。</strong></p> 
<ol><li><code>int sigemptyset(sigset_t *set);</code> 
  <ul><li>功能：清空信号集中的数据,将信号集中的所有的标志位置为<code>0</code></li><li>参数：<code>set</code>，传出参数，需要操作的信号集</li><li>返回值：成功返回<code>0</code>， 失败返回<code>-1</code></li></ul> </li><li><code>int sigfillset(sigset_t *set);</code> 
  <ul><li>功能：将信号集中的所有的标志位置为<code>1</code></li><li>参数：<code>set</code>，传出参数，需要操作的信号集</li><li>返回值：成功返回<code>0</code>， 失败返回<code>-1</code></li></ul> </li><li><code>int sigaddset(sigset_t *set, int signum);</code> 
  <ul><li>功能：设置信号集中的某一个信号对应的标志位为<code>1</code>，<strong>表示阻塞这个信号</strong></li><li>参数： 
    <ul><li><code>set</code>：传出参数，需要操作的信号集</li><li><code>signum</code>：需要设置为阻塞的那个信号</li></ul> </li><li>返回值：成功返回<code>0</code>， 失败返回<code>-1</code></li></ul> </li><li><code>int sigdelset(sigset_t *set, int signum);</code> 
  <ul><li>功能：设置信号集中的某一个信号对应的标志位为<code>0</code>，<strong>表示不阻塞这个信号</strong></li><li>参数： 
    <ul><li><code>set</code>：传出参数，需要操作的信号集</li><li><code>signum</code>：需要设置不阻塞的那个信号</li></ul> </li><li>返回值：成功返回<code>0</code>， 失败返回<code>-1</code></li></ul> </li><li><code>int sigismember(const sigset_t *set, int signum);</code> 
  <ul><li>功能：<strong>判断某个信号是否阻塞</strong></li><li>参数： 
    <ul><li><code>set</code>：需要操作的信号集</li><li><code>signum</code>：需要判断的那个信号</li></ul> </li><li>返回值： 
    <ul><li><code>1</code> ： <code>signum</code>被阻塞</li><li><code>0</code> ： <code>signum</code>不阻塞</li><li><code>-1</code> ： 失败</li></ul> </li></ul> </li></ol> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 创建一个信号集</span>
    sigset_t set<span class="token punctuation">;</span>

    <span class="token comment">// 清空信号集的内容</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断 SIGINT 是否在信号集 set 里</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGINT 不阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGINT 阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 添加几个信号到信号集中</span>
    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断SIGINT是否在信号集中</span>
    ret <span class="token operator">=</span> <span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGINT 不阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGINT 阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 判断SIGQUIT是否在信号集中</span>
    ret <span class="token operator">=</span> <span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGQUIT 不阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGQUIT 阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 从信号集中删除一个信号</span>
    <span class="token function">sigdelset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断SIGQUIT是否在信号集中</span>
    ret <span class="token operator">=</span> <span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGQUIT 不阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGQUIT 阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行结果为：</p> 
<pre><code>SIGINT 不阻塞
SIGINT 阻塞
SIGQUIT 阻塞
SIGQUIT 不阻塞
</code></pre> 
<hr> 
<ol start="6"><li><code>int sigprocmask(int how, const sigset_t *set, sigset_t *oldset);</code></li></ol> 
<ul><li>功能：将自定义信号集中的数据设置到内核中（设置阻塞，解除阻塞，替换）</li><li>参数： 
  <ul><li><code>how</code> : 如何对内核阻塞信号集进行处理 
    <ul><li><code>SIG_BLOCK</code>: 将用户设置的阻塞信号集添加到内核中，内核中原来的数据不变<br> 假设内核中默认的阻塞信号集是mask， mask | set</li><li><code>SIG_UNBLOCK</code>: 根据用户设置的数据，对内核中的数据进行解除阻塞<br> mask &amp;= ~set</li><li><code>SIG_SETMASK</code>:覆盖内核中原来的值</li></ul> </li><li><code>set</code> ：已经初始化好的用户自定义的信号集</li><li><code>oldset</code> : 保存设置之前的内核中的阻塞信号集的状态，可以是 <code>NULL</code></li></ul> </li><li>返回值： 
  <ul><li>成功：<code>0</code></li><li>失败：<code>-1</code> 
    <ul><li>设置错误号：<code>EFAULT</code>、<code>EINVAL</code></li></ul> </li></ul> </li></ul> 
<ol start="7"><li> <p><code>int sigpending(sigset_t *set);</code></p> 
  <ul><li>功能：获取内核中的未决信号集</li><li>参数：<code>set</code>，传出参数，保存的是内核中的未决信号集中的信息。</li></ul> </li></ol> 
<p><strong>编写一个程序，把所有的常规信号（1-31）的未决状态打印到屏幕。</strong></p> 
<p><strong>设置某些信号是阻塞的，通过键盘产生这些信号。</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 设置2、3号信号阻塞</span>
    sigset_t set<span class="token punctuation">;</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将2号和3号信号添加到信号集中</span>
    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 修改内核中的阻塞信号集</span>
    <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        num<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取当前的未决信号集的数据</span>
        sigset_t pendingset<span class="token punctuation">;</span>
        <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pendingset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sigpending</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pendingset<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 遍历前31位</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">31</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pendingset<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pendingset<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"sigismember"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 解除阻塞</span>
            <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_UNBLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
  
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<p>9.23节第7个函数：第2个信号捕捉函数<code>int sigaction(int signum, const struct sigaction *act, struct sigaction *oldact);</code></p> 
<ul><li> <p>头文件：<code>#include &lt;signal.h&gt;</code></p> </li><li> <p>功能：信号捕捉，检查或者改变信号的处理。</p> </li><li> <p>参数：</p> 
  <ul><li><code>signum</code> ：需要捕捉的信号的编号或者宏值（信号的名称）</li><li><code>act</code> ：捕捉到信号之后的处理动作</li><li><code>oldact</code> : 上一次对信号捕捉相关的设置，一般不使用，传递NULL</li></ul> </li><li> <p>返回值：</p> 
  <ul><li>成功 <code>0</code></li><li>失败 <code>-1</code></li></ul> </li><li> <p><code>struct sigaction</code> 的内部结构：</p> </li></ul> 
<pre><code class="prism language-cpp"> <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 函数指针，指向的函数就是信号捕捉到之后的处理函数</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 不常用</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_sigaction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> siginfo_t <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 临时阻塞信号集，在信号捕捉函数执行过程中，临时阻塞某些信号。</span>
    sigset_t sa_mask<span class="token punctuation">;</span>
    <span class="token comment">// 使用哪一个信号处理函数对捕捉到的信号进行处理</span>
    <span class="token comment">// 这个值可以是0，表示使用sa_handler,也可以是SA_SIGINFO表示使用sa_sigaction</span>
    <span class="token keyword">int</span> sa_flags<span class="token punctuation">;</span>
    <span class="token comment">// 被废弃掉了</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_restorer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>案例：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">myalarm</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"捕捉到了信号的编号是：%d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"xxxxxxx\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 过3秒以后，每隔2秒钟定时一次</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>
    act<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> myalarm<span class="token punctuation">;</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 清空临时阻塞信号集</span>
   
    <span class="token comment">// 注册信号捕捉</span>
    <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>act<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> new_value<span class="token punctuation">;</span>

    <span class="token comment">// 设置间隔的时间</span>
    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置延迟的时间,3秒之后开始第一次定时</span>
    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞的</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"定时器开始了...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setitimer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// getchar();</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b4/c3/HwZgg2m8_o.png" alt="请添加图片描述"></p> 
<h4><a id="926_SIGCHLD_2037"></a>9.26 SIGCHLD信号</h4> 
<ul><li><code>SIGCHLD</code>信号产生的条件 
  <ul><li>子进程终止时</li><li>子进程接收到 <code>SIGSTOP</code> 信号停止时</li><li>子进程处在停止态，接受到 <code>SIGCONT</code> 后唤醒时</li></ul> </li><li>以上三种条件都会给父进程发送 <code>SIGCHLD</code> 信号，父进程默认会忽略该信号</li></ul> 
<p><strong>可使用SIGCHLD信号解决僵尸进程的问题。</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">myFun</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"捕捉到的信号 ：%d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 回收子进程PCB的资源</span>
    <span class="token comment">// while(1) {<!-- --></span>
    <span class="token comment">//     wait(NULL); </span>
    <span class="token comment">// }</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child die , pid = %d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">// 说明还有子进程活着</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">// 没有子进程</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 提前设置好阻塞信号集，阻塞SIGCHLD，因为有可能子进程很快结束，父进程还没有注册完信号捕捉</span>
    sigset_t set<span class="token punctuation">;</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGCHLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建一些子进程</span>
    pid_t pid<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 父进程</span>

        <span class="token comment">// 捕捉子进程死亡时发送的SIGCHLD信号</span>
        <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>
        act<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> myFun<span class="token punctuation">;</span>
        <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>act<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 注册完信号捕捉以后，解除阻塞</span>
        <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_UNBLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent process pid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 子进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child process pid : %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h4><a id="927__2121"></a>9.27 共享内存</h4> 
<ul><li> <p><strong>共享内存允许两个或者多个进程共享物理内存的同一块区域（通常被称为段）</strong>。由于一个共享内存段会称为一个进程用户空间的一部分，因此这种 IPC 机制无需内核介入。所有需要做的就是让一个进程将数据复制进共享内存中，并且这部分数据会对其他所有共享同一个段的进程可用。</p> </li><li> <p>与管道等要求发送进程将数据从用户空间的缓冲区复制进内核内存和接收进程将数据从内核内存复制进用户空间的缓冲区的做法相比，这种 IPC 技术的速度更快。</p> </li><li> <p>调用 <code>shmget()</code> 创建一个新共享内存段或取得一个既有共享内存段的标识符（即由其他进程创建的共享内存段）。这个调用将返回后续调用中需要用到的共享内存标识符。</p> </li><li> <p>使用 <code>shmat()</code> 来附上共享内存段，使该段成为调用进程的虚拟内存的一部分。</p> <p>此刻在程序中可以像对待其他可用内存那样对待这个共享内存段。为引用这块共享内存，程序需要使用由 <code>shmat()</code> 调用返回的 <code>addr</code> 值，它是一个指向进程的虚拟地址空间中该共享内存段的起点的指针。</p> </li><li> <p>调用 <code>shmdt()</code> 来分离共享内存段。在这个调用之后，进程就无法再引用这块共享内存了。这一步是可选的，并且在进程终止时会自动完成这一步。</p> </li><li> <p>调用 <code>shmctl()</code> 来删除共享内存段。只有当当前所有附加内存段的进程都与之分离之后内存段才会销毁。只有一个进程需要执行这一步。</p> </li></ul> 
<h4><a id="928__2136"></a>9.28 共享内存操作函数</h4> 
<p>调用共享内存相关操作函数需要引入的头文件：</p> 
<pre><code class="prism language-c++">include &lt;sys/ipc.h&gt;
include &lt;sys/shm.h&gt;
</code></pre> 
<ol><li><code>int shmget(key_t key, size_t size, int shmflg);</code></li></ol> 
<ul><li>功能 : 创建一个新的共享内存段，或者获取一个既有的共享内存段的标识。新创建的内存段中的数据都会被初始化为0。</li><li>参数 : 
  <ul><li><code>key</code> : <code>key_t</code>类型是一个整型，进程通过这个参数找到或者创建一个共享内存。<br> 一般使用<code>16</code>进制表示，非<code>0</code>值</li><li><code>size</code> : 共享内存的大小</li><li><code>shmflg</code> : 属性 
    <ul><li>访问权限</li><li>附加属性：创建、判断共享内存是不是存在 
      <ul><li>创建 : <code>IPC_CREAT</code></li><li>判断共享内存是否存在 : <code>IPC_EXCL</code> ，需要和<code>IPC_CREAT</code>一起使用<br> <code>IPC_CREAT | IPC_EXCL | 0664</code></li></ul> </li></ul> </li></ul> </li><li>返回值 : 
  <ul><li>失败 : <code>-1</code> 并设置错误号</li><li>成功 : <code>&gt;0</code> 返回共享内存的引用的<code>ID</code>，后面操作共享内存都是通过这个值。</li></ul> </li></ul> 
<ol start="2"><li><code>void *shmat(int shmid, const void *shmaddr, int shmflg);</code></li></ol> 
<ul><li> <p>功能 : 和当前的进程进行关联</p> </li><li> <p>参数 :</p> 
  <ul><li><code>shmid</code> : 共享内存的标识（<code>ID</code>）,由<code>shmget()</code>返回值获取</li><li><code>shmaddr</code> : 申请的共享内存的起始地址，指定<code>NULL</code>，内核指定</li><li><code>shmflg</code> : 对共享内存的操作 
    <ul><li>读 : <code>SHM_RDONLY</code>， 必须要有读权限</li><li>读写 : <code>0</code></li></ul> </li></ul> </li><li> <p>返回值：</p> 
  <ul><li> <p>成功：返回共享内存的首（起始）地址。</p> </li><li> <p>失败 : <code>(void *) -1</code></p> </li></ul> </li></ul> 
<ol start="3"><li><code>int shmdt(const void *shmaddr);</code></li></ol> 
<ul><li>功能 : 解除当前进程和共享内存的关联</li><li>参数 : 
  <ul><li><code>shmaddr</code>：共享内存的首地址</li></ul> </li><li>返回值：成功 <code>0</code>， 失败 <code>-1</code></li></ul> 
<ol start="4"><li><code>int shmctl(int shmid, int cmd, struct shmid_ds *buf);</code></li></ol> 
<ul><li> <p>功能 : 对共享内存进行操作。删除共享内存，共享内存要删除才会消失，创建共享内存的进行被销毁了，对共享内存是没有任何影响。</p> 
  <ul><li>参数 : 
    <ul><li><code>shmid</code> : 共享内存的<code>ID</code></li><li><code>cmd</code> : 要做的操作 
      <ul><li><code>IPC_STAT</code> : 获取共享内存的当前的状态</li><li><code>IPC_SET</code> : 设置共享内存的状态</li><li><code>IPC_RMID</code> : 标记共享内存被销毁</li></ul> </li><li><code>buf</code> : 需要设置或者获取的共享内存的属性信息 
      <ul><li><code>IPC_STAT</code> : <code>buf</code>存储数据</li><li><code>IPC_SET</code> : <code>buf</code>中需要初始化数据，设置到内核中</li><li><code>IPC_RMID</code> : <code>buf</code>没有用，传递<code>NULL</code></li></ul> </li></ul> </li></ul> </li></ul> 
<ol start="5"><li><code>key_t ftok(const char *pathname, int proj_id);</code></li></ol> 
<ul><li> <p>功能 : 根据指定的路径名，和<code>int</code>值，生成一个共享内存的<code>key</code>，可作为函数<code>shmget</code>的<code>key</code>实参。</p> </li><li> <p>参数 :</p> 
  <ul><li> <p><code>pathname</code> : 指定一个存在的路径，比如<code>/home/nowcoder/Linux/a.txt</code>、<code>/</code></p> </li><li> <p><code>proj_id</code> : <code>int</code>类型的值，但是这系统调用只会使用其中的<code>1</code>个字节</p> <p>​ 范围为 <code>0-255</code> 一般指定一个字符<code> 'a'</code></p> </li></ul> </li></ul> 
<p><strong>write.c</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    

    <span class="token comment">// 1.创建一个共享内存</span>
    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> IPC_CREAT<span class="token operator">|</span><span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"shmid : %d\n"</span><span class="token punctuation">,</span> shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 2.和当前进程进行关联</span>
    <span class="token keyword">void</span> <span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> <span class="token operator">*</span> str <span class="token operator">=</span> <span class="token string">"helloworld"</span><span class="token punctuation">;</span>

    <span class="token comment">// 3.写数据</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"按任意键继续\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.解除关联</span>
    <span class="token function">shmdt</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5.删除共享内存</span>
    <span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>read.c</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    

    <span class="token comment">// 1.获取一个共享内存</span>
    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"shmid : %d\n"</span><span class="token punctuation">,</span> shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2.和当前进程进行关联</span>
    <span class="token keyword">void</span> <span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3.读数据</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"按任意键继续\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.解除关联</span>
    <span class="token function">shmdt</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5.删除共享内存</span>
    <span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="929__2282"></a>9.29 共享内存操作指令</h4> 
<ul><li> <p><code>ipcs</code> 用法</p> 
  <ul><li> <p><code>ipcs -a</code> // 打印当前系统中<strong>所有</strong>的进程间通信方式的信息</p> </li><li> <p><code>ipcs -m</code> // 打印出使用<strong>共享内存</strong>进行进程间通信的信息</p> </li><li> <p><code>ipcs -q</code> // 打印出使用<strong>消息队列</strong>进行进程间通信的信息</p> </li><li> <p><code>ipcs -s</code> // 打印出使用<strong>信号</strong>进行进程间通信的信息</p> </li></ul> </li><li> <p><code>ipcrm</code> 用法</p> 
  <ul><li> <p><code>ipcrm -M shmkey</code> // 移除用<strong>shmkey</strong>创建的共享内存段</p> </li><li> <p><code>ipcrm -m shmid</code> // 移除用<strong>shmid</strong>标识的共享内存段</p> </li><li> <p><code>ipcrm -Q msgkey</code> // 移除用<strong>msqkey</strong>创建的消息队列</p> </li><li> <p><code>ipcrm -q msqid</code> // 移除用<strong>msqid</strong>标识的消息队列</p> </li><li> <p><code>ipcrm -S semkey</code> // 移除用<strong>semkey</strong>创建的信号</p> </li><li> <p><code>ipcrm -s semid</code> // 移除用<strong>semid</strong>标识的信号</p> </li></ul> </li></ul> 
<h4><a id="930__2304"></a>9.30 共享内存相关的常见问题</h4> 
<p><strong>问题1：操作系统如何知道一块共享内存被多少个进程关联？</strong></p> 
<p>共享内存维护了一个结构体 <code>struct shmid_ds</code> ，这个结构体中有一个成员 <code>shm_nattch</code>，<code>shm_nattach</code> 记录了关联的进程个数。</p> 
<p><strong>问题2：可不可以对共享内存进行多次删除 shmctl</strong></p> 
<p>可以的，因为 <code>shmctl</code> 标记删除共享内存，不是直接删除。当和共享内存关联的进程数为<code>0</code>的时候，就真正被删除。</p> 
<p>当共享内存的<code>key</code>为<code>0</code>的时候，表示共享内存被标记删除了。</p> 
<p>如果一个进程和共享内存取消关联，那么这个进程就不能继续操作这个共享内存。也不能进行关联。</p> 
<p><strong>问题3：共享内存和内存映射的区别</strong></p> 
<ol><li> <p>共享内存可以直接创建，内存映射需要磁盘文件（匿名映射除外）</p> </li><li> <p>共享内存效率更高</p> </li><li> <p>内存</p> 
  <ul><li>共享内存，所有的进程操作的是同一块共享内存。</li><li>内存映射，每个进程在自己的虚拟地址空间中有一个独立的内存。</li></ul> </li><li> <p>数据安全</p> 
  <ul><li>当进程突然退出时，共享内存还存在，而内存映射区就消失了。</li><li>当运行进程的电脑死机、宕机时，共享内存中的数据就消失了，而内存映射区的数据 ，由于磁盘文件中的数据还在，所以内存映射区的数据还存在。</li></ul> </li><li> <p>生命周期</p> 
  <ul><li>共享内存，进程退出，共享内存还在，标记删除（所有的关联的进程数为0），或者关机。<br> 如果一个进程退出，会自动和共享内存进行取消关联。</li><li>内存映射，进程退出，内存映射区销毁。</li></ul> </li></ol> 
<h4><a id="931__2334"></a>9.31 守护进程</h4> 
<h5><a id="01__2336"></a>01 终端</h5> 
<ul><li> <p>在 <code>UNIX</code> 系统中，用户通过终端登录系统后得到一个 <code>shell</code> 进程，这个终端成为 <code>shell</code> 进程的控制终端（Controlling Terminal）。进程中，控制终端是</p> <p>保存在 <code>PCB</code> 中的信息，而 <code>fork()</code> 会复制 PCB 中的信息，因此由 <code>shell</code> 进程启动的其它进程的控制终端也是这个终端。通过<code>echo $$</code>可查看当前终端的进程<code>pid</code>，<code>tty</code>查看当前终端。</p> </li><li> <p>默认情况下（没有重定向），每个进程的标准输入、标准输出和标准错误输出都指向控制终端，进程从标准输入读也就是读用户的键盘输入，进程往标准输出或标准错误输出写也就是输出到显示器上。</p> </li><li> <p>在控制终端输入一些特殊的控制键可以给前台进程发信号，例如 <code>Ctrl + C</code> 会产生 <code>SIGINT</code> 信号，<code>Ctrl + \</code> 会产生 <code>SIGQUIT</code> 信号。</p> </li></ul> 
<h5><a id="02__2345"></a>02 进程组</h5> 
<ul><li>进程组和会话在进程之间形成了一种两级层次关系：进程组是一组相关进程的集合，会话是一组相关进程组的集合。进程组和会话是为支持 <code>shell</code> 作业控制而定义的抽象概念，用户通过 <code>shell</code> 能够交互式地在前台或后台运行命令。</li><li>**进程组由一个或多个共享同一进程组标识符（PGID）的进程组成。**一个进程组拥有一个进程组首进程，该进程是创建该组的进程，其进程 <code>ID</code> 为该进程组的 <code>ID</code>，新进程会继承其父进程所属的进程组 <code>ID</code>。</li><li>进程组拥有一个生命周期，其开始时间为首进程创建组的时刻，结束时间为最后一个成员进程退出组的时刻。一个进程可能会因为终止而退出进程组，也可能会因为加入了另外一个进程组而退出进程组。进程组首进程无需是最后一个离开进程组的成员。</li></ul> 
<h5><a id="03__2351"></a>03 会话</h5> 
<ul><li><strong>会话是一组进程组的集合</strong>。会话首进程是创建该新会话的进程，其进程 <code>ID</code> 会成为会话 <code>ID</code>。新进程会继承其父进程的会话 <code>ID</code>。</li><li><strong>一个会话中的所有进程共享单个控制终端</strong>。控制终端会在会话首进程首次打开一个终端设备时被建立。<strong>一个终端最多可能会成为一个会话的控制终端。</strong></li><li>在任一时刻，会话中的其中一个进程组会成为终端的前台进程组，其他进程组会成为后台进程组。<strong>只有前台进程组中的进程才能从控制终端中读取输入</strong>。当用户在控制终端中输入终端字符生成信号后，该信号会被发送到前台进程组中的所有成员。</li><li>当控制终端的连接建立起来之后，会话首进程会成为该终端的控制进程。</li></ul> 
<h5><a id="04__2358"></a>04 进程组、会话、控制终端之间的关系</h5> 
<p><img src="https://images2.imgbox.com/52/69/g8grOY80_o.png" alt="请添加图片描述"></p> 
<h5><a id="05__2363"></a>05 进程组、会话操作函数</h5> 
<ul><li> <p><code>pid_t getpgrp(void);</code></p> </li><li> <p><code>pid_t getpgid(pid_t pid);</code></p> </li><li> <p><code>int setpgid(pid_t pid, pid_t pgid);</code></p> </li><li> <p><code>pid_t getsid(pid_t pid);</code></p> </li><li> <p><code>pid_t setsid(void);</code></p> </li></ul> 
<h5><a id="06__2375"></a>06 守护进程</h5> 
<ul><li>守护进程（<code>Daemon Process</code>），也就是通常说的 <code>Daemon</code> 进程（精灵进程），是 <code>Linux</code> 中的<strong>后台服务进程</strong>。<strong>它是一个生存期较长的进程，通常独立于控制终端并且周期性地执行某种任务或等待处理某些发生的事件</strong>。一般采用以 <code>d</code> 结尾的名字。</li><li>守护进程具备下列特征： 
  <ul><li>生命周期很长，守护进程会在系统启动的时候被创建并一直运行直至系统被关闭。</li><li>它在后台运行并且不拥有控制终端。没有控制终端确保了内核永远不会为守护进程自动生成任何控制信号以及终端相关的信号（如 <code>SIGINT</code>、<code>SIGQUIT</code>）。</li></ul> </li><li><strong>Linux 的大多数服务器就是用守护进程实现的</strong>。比如，Internet 服务器 inetd，Web 服务器 httpd 等。</li></ul> 
<h5><a id="07__2383"></a>07 守护进程的创建步骤</h5> 
<ul><li>执行一个 <code>fork()</code>，之后父进程退出，子进程继续执行。</li><li>子进程调用 <code>setsid()</code> 开启一个新会话。</li><li>清除进程的 <code>umask</code> 以确保当守护进程创建文件和目录时拥有所需的权限。</li><li>修改进程的当前工作目录，通常会改为根目录（<code>/</code>）。</li><li>关闭守护进程从其父进程继承而来的所有打开着的文件描述符。</li><li>在关闭了文件描述符<code>0、1、2</code>之后，守护进程通常会打开 <code>/dev/null</code> 并使用 <code>dup2()</code> 使所有这些描述符指向这个设备。</li><li>核心业务逻辑。</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9787ee4739498a27fa2bbc70e8bc3889/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Flutter】移动开发者的Flutter Web实践（利用GitHub Pages进行部署）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/47e454c77dc74818b1d1a176516e3e01/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ChatGPT 简介</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>