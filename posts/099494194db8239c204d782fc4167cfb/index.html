<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SLB-负载均衡 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SLB-负载均衡" />
<meta property="og:description" content="负载均衡技术原理浅析 https://help.aliyun.com/knowledge_detail/39444.html?spm=5176.7839438.2.6.XBbX5l
阿里定制版的LVC 开源地址：https://github.com/alibaba/LVS?spm=5176.7739444.2.10.WxLaqZ
更新时间：2016-07-12 13:21:10 1、技术架构
2、LVS技术特点
FULLNAT技术概述
SYNPROXY技术概述
集群部署方式
Keepalived优化
3、Tengine技术特点
4、更多功能
SLB（Server Load Balancer）服务通过设置虚拟服务地址（IP），将位于同一地域（Region）的多台云服务器（Elastic Compute Service，简称ECS）资源虚拟成一个高性能、高可用的应用服务池；再根据应用指定的方式，将来自客户端的网络请求分发到云服务器池中。
SLB服务会检查云服务器池中ECS的健康状态，自动隔离异常状态的ECS，从而解决了单台ECS的单点问题，同时提高了应用的整体服务能力。在标准的负载均衡功能之外，SLB服务还具备TCP与HTTP抗DDoS攻击的特性，增强了应用服务器的防护能力。
SLB服务是ECS面向多机方案的一个配套服务，需要同ECS结合使用。
1、技术架构 整个负载均衡系统由3部分构成：四层负载均衡、七层负载均衡和控制系统，如下图所示：
四层负载均衡
采用开源软件LVS（Linux Virtual Server）构建，并根据云计算需求对其进行了定制和优化。
七层负载均衡
采用开源软件Tengine构建。
控制系统
用于配置和监控负载均衡系统。
2、LVS技术特点 LVS是全球最流行的四层负载均衡开源软件，可以实现LINUX平台下的负载均衡。
LVS是 基于Linux Netfilter框架实现的一个内核模块（ IPTables是基于Netfilter基本架构实现的一个可扩展的数据报高级管理系统或核外配置工具），名称为IPVS。其钩子函数分别HOOK在LOCAL_IN和FORWARD两个HOOK点，如下图所示：
在云计算大规模网络环境下，官方LVS存在如下问题：
问题1：LVS支持NAT/DR/TUNNEL三种转发模式，上述模式在多VLAN网络环境下部署时，存在网络拓扑复杂，运维成本高的问题。
问题2：和商用负载均衡设备（如F5等）相比，LVS缺少DDOS攻击防御功能。
问题3：LVS采用PC服务器，常用Keepalived软件的VRRP心跳协议进行主备部署，其性能无法扩展。
问题4：LVS常用管理软件Keepalived的配置和健康检查性能不足。
为了解决上述问题， SLB在官方LVS基础上进行了如下定制化和优化：
解决1：新增转发模式FULLNAT，实现LVS-RealServer间跨VLAN通讯。
解决2：新增了SYNPROXY等TCP标志位DDOS攻击防御功能。
解决3：采用LVS集群方式部署。
解决4：对Keepalived的性能进行了优化。
Aliyun-LVS开源地址： https://github.com/alibaba/LVS 。 更多相关说明如下所述。
FULLNAT技术概述 如下图所示，FULLNAT主要实现方式为：
引入local address（内网IP地址）。cip-vip转换为lip-&gt;rip，而 lip和rip均为IDC内网IP，可以跨VLAN通讯。
IN/OUT的数据流全部经过LVS，为了保证带宽，采用万兆（10G）网卡。
FULLNAT转发模式，当前仅支持TCP协议。
SYNPROXY技术概述 LVS针对TCP标志位DDOS攻击，采取如下策略：
对于SYN flood类型攻击，利用SYNPROXY模块进行防御。
如下图所示，主要实现方式为：参照Linux TCP协议栈中SYN cookie的思想，LVS代理TCP三次握手。代理过程：
1) Client发送SYN包给LVS。
2) LVS构造特殊SEQ的SYN ACK包给Client。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/099494194db8239c204d782fc4167cfb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-12T22:05:55+08:00" />
<meta property="article:modified_time" content="2022-10-12T22:05:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SLB-负载均衡</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>负载均衡技术原理浅析</h2> 
<p>https://help.aliyun.com/knowledge_detail/39444.html?spm=5176.7839438.2.6.XBbX5l</p> 
<p>阿里定制版的LVC 开源地址：https://github.com/alibaba/LVS?spm=5176.7739444.2.10.WxLaqZ</p> 
<p>更新时间：2016-07-12 13:21:10   </p> 
<p>1、<a href="https://help.aliyun.com/knowledge_detail/39444.html?spm=5176.7839438.2.6.XBbX5l#%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84" rel="nofollow" title="技术架构">技术架构</a></p> 
<p>2、<a href="https://help.aliyun.com/knowledge_detail/39444.html?spm=5176.7839438.2.6.XBbX5l#LVS%E6%8A%80%E6%9C%AF%E7%89%B9%E7%82%B9" rel="nofollow" title="LVS技术特点">LVS技术特点</a></p> 
<ul><li> <p><a href="https://help.aliyun.com/knowledge_detail/39444.html?spm=5176.7839438.2.6.XBbX5l#FULLNAT%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0" rel="nofollow" title="FULLNAT技术概述">FULLNAT技术概述</a></p> </li><li> <p><a href="https://help.aliyun.com/knowledge_detail/39444.html?spm=5176.7839438.2.6.XBbX5l#SYNPROXY%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0" rel="nofollow" title="SYNPROXY技术概述">SYNPROXY技术概述</a></p> </li><li> <p><a href="https://help.aliyun.com/knowledge_detail/39444.html?spm=5176.7839438.2.6.XBbX5l#%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F" rel="nofollow" title="集群部署方式">集群部署方式</a></p> </li><li> <p><a href="https://help.aliyun.com/knowledge_detail/39444.html?spm=5176.7839438.2.6.XBbX5l#Keepalived%E4%BC%98%E5%8C%96" rel="nofollow" title="Keepalived优化">Keepalived优化</a></p> </li></ul> 
<p>3、<a href="https://help.aliyun.com/knowledge_detail/39444.html?spm=5176.7839438.2.6.XBbX5l#Tengine%E6%8A%80%E6%9C%AF%E7%89%B9%E7%82%B9" rel="nofollow" title="Tengine技术特点">Tengine技术特点</a></p> 
<p>4、<a href="https://help.aliyun.com/knowledge_detail/39444.html?spm=5176.7839438.2.6.XBbX5l#%E6%9B%B4%E5%A4%9A%E5%8A%9F%E8%83%BD" rel="nofollow" title="更多功能">更多功能</a></p> 
<hr> 
<p>SLB（Server Load Balancer）服务通过设置虚拟服务地址（IP），将位于同一地域（Region）的多台云服务器（Elastic Compute Service，简称ECS）资源虚拟成一个高性能、高可用的应用服务池；再根据应用指定的方式，将来自客户端的网络请求分发到云服务器池中。</p> 
<p>SLB服务会检查云服务器池中ECS的健康状态，自动隔离异常状态的ECS，从而解决了单台ECS的单点问题，同时提高了应用的整体服务能力。在标准的负载均衡功能之外，SLB服务还具备TCP与HTTP抗DDoS攻击的特性，增强了应用服务器的防护能力。</p> 
<p>SLB服务是ECS面向多机方案的一个配套服务，需要同ECS结合使用。</p> 
<h2>1、技术架构</h2> 
<p>整个负载均衡系统由3部分构成：四层负载均衡、七层负载均衡和控制系统，如下图所示：</p> 
<p></p> 
<ul><li> <p>四层负载均衡</p> <p>采用开源软件LVS（Linux Virtual Server）构建，并根据云计算需求对其进行了定制和优化。</p> </li><li> <p>七层负载均衡</p> <p>采用开源软件Tengine构建。</p> </li><li> <p>控制系统</p> <p>用于配置和监控负载均衡系统。<img alt="" height="413" src="https://images2.imgbox.com/36/8f/MiaAGCIp_o.png" width="554"></p> </li></ul> 
<h2>2、LVS技术特点</h2> 
<p>LVS是全球最流行的四层负载均衡开源软件，可以实现LINUX平台下的负载均衡。</p> 
<p>LVS是 基于Linux Netfilter框架实现的一个内核模块（ IPTables是基于Netfilter基本架构实现的一个可扩展的数据报高级管理系统或核外配置工具），名称为IPVS。其钩子函数分别HOOK在LOCAL_IN和FORWARD两个HOOK点，如下图所示：</p> 
<p></p> 
<p>在云计算大规模网络环境下，官方LVS存在如下问题：</p> 
<ul><li> <p>问题1：LVS支持NAT/DR/TUNNEL三种转发模式，上述模式在多VLAN网络环境下部署时，存在网络拓扑复杂，运维成本高的问题。</p> </li><li> <p>问题2：和商用负载均衡设备（如F5等）相比，LVS缺少DDOS攻击防御功能。</p> </li><li> <p>问题3：LVS采用PC服务器，常用Keepalived软件的VRRP心跳协议进行主备部署，其性能无法扩展。</p> </li><li> <p>问题4：LVS常用管理软件Keepalived的配置和健康检查性能不足。</p> </li></ul> 
<p>为了解决上述问题， SLB在官方LVS基础上进行了如下定制化和优化：</p> 
<ul><li> <p>解决1：新增转发模式FULLNAT，实现LVS-RealServer间跨VLAN通讯。</p> </li><li> <p>解决2：新增了SYNPROXY等TCP标志位DDOS攻击防御功能。</p> </li><li> <p>解决3：采用LVS集群方式部署。</p> </li><li> <p>解决4：对Keepalived的性能进行了优化。</p> </li></ul> 
<p> <img alt="" height="246" src="https://images2.imgbox.com/8f/1c/csC2qoUv_o.png" width="505"></p> 
<p>Aliyun-LVS开源地址： <a href="https://github.com/alibaba/LVS?spm=5176.7739444.2.10.WxLaqZ" title="https://github.com/alibaba/LVS">https://github.com/alibaba/LVS</a> 。 更多相关说明如下所述。</p> 
<ul><li> <h3>FULLNAT技术概述</h3> </li></ul> 
<p>如下图所示，FULLNAT主要实现方式为：</p> 
<ul><li> <p>引入local address（内网IP地址）。cip-vip转换为lip-&gt;rip，而 lip和rip均为IDC内网IP，可以跨VLAN通讯。</p> </li><li> <p>IN/OUT的数据流全部经过LVS，为了保证带宽，采用万兆（10G）网卡。</p> </li><li> <p>FULLNAT转发模式，当前仅支持TCP协议。</p> </li></ul> 
<p> <img alt="" height="295" src="https://images2.imgbox.com/40/ad/qEqNSZPA_o.png" width="558"></p> 
<ul><li> <h3>SYNPROXY技术概述</h3> </li></ul> 
<p>LVS针对TCP标志位DDOS攻击，采取如下策略：</p> 
<ul><li> <p>对于SYN flood类型攻击，利用SYNPROXY模块进行防御。</p> </li></ul> 
<p>如下图所示，主要实现方式为：参照Linux TCP协议栈中SYN cookie的思想，LVS代理TCP三次握手。代理过程：</p> 
<p>1)     Client发送SYN包给LVS。</p> 
<p>2)     LVS构造特殊SEQ的SYN ACK包给Client。</p> 
<p>3)     Client回复ACK给LVS。</p> 
<p>4)     LVS验证ACK包中ack_seq是否合法。</p> 
<p>5)     如果合法，则LVS再和Realserver建立3次握手。</p> 
<p></p> 
<ul><li> <p> 对于ACK/FIN/RSTFlood类型攻击，查找连接表，如果不存在，则直接丢弃。</p> </li></ul> 
<h4> <img alt="" height="286" src="https://images2.imgbox.com/46/ec/FCKhE5tK_o.png" width="508"></h4> 
<ul><li> <h4>集群部署方式</h4> </li></ul> 
<p>LVS集群部署方式实现的主要方式为：</p> 
<ul><li> <p>LVS和上联交换机间运行OSPF协议。</p> </li><li> <p>上联交换机通过ECMP等价路由，将数据流分发给LVS集群。</p> </li><li> <p>LVS集群再转发给业务服务器。</p> </li></ul> 
<p>集群方式部署极大的保证了异常情况下，负载均衡服务的稳定性：</p> 
<ul><li> <p>健壮性</p> <p>LVS和交换机间运行OSPF心跳。1个VIP配置在集群的所有LVS上。当一台LVS down，交换机会自动发现并将其从ECMP等价路由中剔除。</p> </li><li> <p>可扩展</p> <p>如果当前LVS集群无法支撑某个VIP的流量，LVS集群可以进行水平扩容。</p> </li></ul> 
<p> <img alt="" height="338" src="https://images2.imgbox.com/d2/47/cYws5YPW_o.png" width="498"></p> 
<ul><li> <h3>Keepalived优化</h3> </li></ul> 
<p>阿里云在SLB中针对LVS管理软件Keepalived进行了全面优化，主要包括：</p> 
<ul><li> <p>优化了网络异步模型，select方式改为epoll方式。</p> </li><li> <p>优化了reload过程。</p> </li></ul> 
<p>综上所述，基于LVS的SLB四层负载均衡产品具有如下特点；</p> 
<ul><li> <p>高可用：LVS集群保证了冗余性，无单点。</p> </li><li> <p>安全：LVS自带攻击防御+云盾，提供了接近于实时防御的能力。</p> </li><li> <p>健康检查：SLB对后端ECS进行健康检查，自动屏蔽异常状态的ECS，待该ECS恢复正常后自动解除屏蔽。</p> </li></ul> 
<h2>3、Tengine技术特点</h2> 
<p>Tengine是阿里巴巴发起的WEB服务器项目，其在Nginx的基础上，针对大访问量网站的需求，添加了很多高级功能和特性是当前最流行的7层负载均衡开源软件之一。Tengine的性能和稳定性已经在大型的网站如<a href="http://www.taobao.com/?spm=5176.7739444.2.11.WxLaqZ" rel="nofollow" title="淘宝网">淘宝网</a>，<a href="http://www.tmall.com/?spm=5176.7739444.2.12.WxLaqZ" rel="nofollow" title="天猫商城">天猫商城</a>等得到了很好的检验。它的最终目标是打造一个高效、稳定、安全、易用的Web平台。</p> 
<p>注：Tengine开源地址http://tengine.taobao.org/。</p> 
<p>针对云计算场景，Tengine定制的主要特性如下：</p> 
<ul><li> <p>继承Nginx-1.4.6的所有特性，100%兼容Nginx的配置。</p> </li><li> <p>动态模块加载（DSO）支持。加入一个模块不再需要重新编译整个Tengine。</p> </li><li> <p>更加强大的负载均衡能力，包括一致性Hash模块、会话保持模块，还可以对后端的服务器进行主动健康检查，根据服务器状态自动上线下线。</p> </li><li> <p>监控系统的负载和资源占用从而对系统进行保护。</p> </li><li> <p>对运维人员更友好的出错信息，便于定位出错机器。</p> </li><li> <p>更强大的防攻击（访问速度限制等）模块。</p> </li></ul> 
<p>采用Tengine作为SLB的基础模块的阿里云SLB七层负载均衡产品，具有如下特点：</p> 
<ul><li> <p>高可用：Tengine集群保证了冗余性，无单点。</p> </li><li> <p>安全：多维度的CC攻击防御能力。</p> </li><li> <p>健康检查：SLB对后端ECS进行健康检查，自动屏蔽异常状态的ECS，待该ECS恢复正常后自动解除屏蔽。</p> </li><li> <p>会话保持：支持7层会话保持功能。</p> </li><li> <p>一致性：支持一致性hash调度。</p> </li></ul> 
<h2>4、更多功能</h2> 
<p>SLB作为负载均衡设备，其最重要的指标是【稳定性】，在进一步提高稳定性方面，主要工作包括：</p> 
<ul><li> <p>支持集群内部 session同步。</p> </li><li> <p>采用Anycast技术实现同城双A。</p> </li></ul> 
<p>在功能方面有更多支持，包括：</p> 
<ul><li> <p>白名单访问控制</p> <p>从SLB层面实现访问控制，用户可以在SLB系统上配置白名单，便于用户灵活限定外部访问请求。</p> </li><li> <p>更多服务协议的支持</p> <p>当前已经支持HTTPS、UDP。</p> </li></ul> 
<h2><a href="http://kb.cnblogs.com/page/188170/" rel="nofollow" title="四层和七层负载均衡的区别">四层和七层负载均衡的区别</a></h2> 
<p>　　（一）</p> 
<p>　　简单理解四层和七层负载均衡:</p> 
<p>　　① 所谓四层就是基于IP+端口的负载均衡；七层就是基于URL等应用层信息的负载均衡；同理，还有基于MAC地址的二层负载均衡和基于IP地址的三层负载均衡。 换句换说，二层负载均衡会通过一个虚拟MAC地址接收请求，然后再分配到真实的MAC地址；三层负载均衡会通过一个虚拟IP地址接收请求，然后再分配到真实的IP地址；四层通过虚拟IP+端口接收请求，然后再分配到真实的服务器；七层通过虚拟的URL或主机名接收请求，然后再分配到真实的服务器。</p> 
<p>　　② 所谓的四到七层负载均衡，就是在对后台的服务器进行负载均衡时，依据四层的信息或七层的信息来决定怎么样转发流量。 比如四层的负载均衡，就是通过发布三层的IP地址（VIP），然后加四层的端口号，来决定哪些流量需要做负载均衡，对需要处理的流量进行NAT处理，转发至后台服务器，并记录下这个TCP或者UDP的流量是由哪台服务器处理的，后续这个连接的所有流量都同样转发到同一台服务器处理。七层的负载均衡，就是在四层的基础上（没有四层是绝对不可能有七层的），再考虑应用层的特征，比如同一个Web服务器的负载均衡，除了根据VIP加80端口辨别是否需要处理的流量，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡。举个例子，如果你的Web服务器分成两组，一组是中文语言的，一组是英文语言的，那么七层负载均衡就可以当用户来访问你的域名时，自动辨别用户语言，然后选择对应的语言服务器组进行负载均衡处理。</p> 
<p>　　③ 负载均衡器通常称为四层交换机或七层交换机。四层交换机主要分析IP层及TCP/UDP层，实现四层流量负载均衡。七层交换机除了支持四层负载均衡以外，还有分析应用层的信息，如HTTP协议URI或Cookie信息。</p> 
<p>　　1、负载均衡分为L4 switch（四层交换），即在OSI第4层工作，就是TCP层啦。此种Load Balance不理解应用协议（如HTTP/FTP/MySQL等等）。例子：LVS，F5。</p> 
<p>　　2、另一种叫做L7 switch（七层交换），OSI的最高层，应用层。此时，该Load Balancer能理解应用协议。例子：  haproxy，MySQL Proxy。</p> 
<p>　　注意：上面的很多Load Balancer既可以做四层交换，也可以做七层交换。</p> 
<p>　　（二）</p> 
<p>　<strong>　负载均衡设备也常被称为"四到七层交换机"，那么四层和七层两者到底区别在哪里？</strong></p> 
<p><strong>　　第一，技术原理上的区别。</strong></p> 
<p>　<strong>　所谓四层负载均衡</strong>，也就是主要通过报文中的目标地址和端口，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器。</p> 
<p>　　以常见的TCP为例，负载均衡设备在接收到第一个来自客户端的SYN 请求时，即通过上述方式选择一个最佳的服务器，并对报文中目标IP地址进行修改(改为后端服务器IP），直接转发给该服务器。TCP的连接建立，即三次握手是客户端和服务器直接建立的，负载均衡设备只是起到一个类似路由器的转发动作。在某些部署情况下，为保证服务器回包可以正确返回给负载均衡设备，在转发报文的同时可能还会对报文原来的源地址进行修改。</p> 
<p><img alt="" height="274" src="https://images2.imgbox.com/8e/f1/nklgpA0N_o.png" width="426"></p> 
<p><strong>　　所谓七层负载均衡</strong>，也称为“内容交换”，也就是主要通过报文中的真正有意义的应用层内容，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器。</p> 
<p>　　以常见的TCP为例，负载均衡设备如果要根据真正的应用层内容再选择服务器，只能先代理最终的服务器和客户端建立连接(三次握手)后，才可能接受到客户端发送的真正应用层内容的报文，然后再根据该报文中的特定字段，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器。负载均衡设备在这种情况下，更类似于一个代理服务器。负载均衡和前端的客户端以及后端的服务器会分别建立TCP连接。所以从这个技术原理上来看，七层负载均衡明显的对负载均衡设备的要求更高，处理七层的能力也必然会低于四层模式的部署方式。</p> 
<p><strong>　　第二，应用场景的需求。</strong></p> 
<p>　　七层应用负载的好处，是使得整个网络更<strong>"智能化"</strong>。例如访问一个网站的用户流量，可以通过七层的方式，将对图片类的请求转发到特定的图片服务器并可以使用缓存技术；将对文字类的请求可以转发到特定的文字服务器并可以使用压缩技术。当然这只是七层应用的一个小案例，从技术原理上，这种方式可以对客户端的请求和服务器的响应进行任意意义上的修改，极大的提升了应用系统在网络层的灵活性。很多在后台，例如Nginx或者Apache上部署的功能可以前移到负载均衡设备上，例如客户请求中的Header重写，服务器响应中的关键字过滤或者内容插入等功能。</p> 
<p>　　另外一个常常被提到功能就<strong>是安全性</strong>。网络中最常见的SYN Flood攻击，即黑客控制众多源客户端，使用虚假IP地址对同一目标发送SYN攻击，通常这种攻击会大量发送SYN报文，耗尽服务器上的相关资源，以达到Denial of Service(DoS)的目的。从技术原理上也可以看出，四层模式下这些SYN攻击都会被转发到后端的服务器上；而七层模式下这些SYN攻击自然在负载均衡设备上就截止，不会影响后台服务器的正常运营。另外负载均衡设备可以在七层层面设定多种策略，过滤特定报文，例如SQL Injection等应用层面的特定攻击手段，从应用层面进一步提高系统整体安全。</p> 
<p>　　现在的7层负载均衡，主要还是着<strong>重于应用</strong>HTTP协议，所以其应用范围主要是众多的网站或者内部信息平台等基于B/S开发的系统。 4层负载均衡则对应其他TCP应用，例如基于C/S开发的ERP等系统。</p> 
<p>　<strong>　第三，七层应用需要考虑的问题。</strong></p> 
<p><strong>　　1：是否真的必要</strong>，七层应用的确可以提高流量智能化，同时必不可免的带来设备配置复杂，负载均衡压力增高以及故障排查上的复杂性等问题。在设计系统时需要考虑四层七层同时应用的混杂情况。</p> 
<p>　　<strong>2：是否真的可以提高安全性。</strong>例如SYN Flood攻击，七层模式的确将这些流量从服务器屏蔽，但负载均衡设备本身要有强大的抗DDoS能力，否则即使服务器正常而作为中枢调度的负载均衡设备故障也会导致整个应用的崩溃。</p> 
<p>　<strong>　3：是否有足够的灵活度。</strong>七层应用的优势是可以让整个应用的流量智能化，但是负载均衡设备需要提供完善的七层功能，满足客户根据不同情况的基于应用的调度。最简单的一个考核就是能否取代后台Nginx或者Apache等服务器上的调度功能。能够提供一个七层应用开发接口的负载均衡设备，可以让客户根据需求任意设定功能，才真正有可能提供强大的灵活性和智能性。</p> 
<p>　　（本节出自 “ADC技术博客” 博客，请务必保留此出处http://virtualadc.blog.51cto.com/3027116/591396）</p> 
<p>　　（三）</p> 
<p>　　<strong>负载均衡四七层介绍:</strong></p> 
<p>　　负载均衡（Load Balance）建立在现有网络结构之上，它提供了一种廉价有效透明的方法扩展网络设备和服务器的带宽、增加吞吐量、加强网络数据处理能力、提高网络的灵活性和可用性。</p> 
<p>　　负载均衡有两方面的含义：首先，大量的并发访问或数据流量分担到多台节点设备上分别处理，减少用户等待响应的时间；其次，单个重负载的运算分担到多台节点设备上做并行处理，每个节点设备处理结束后，将结果汇总，返回给用户，系统处理能力得到大幅度提高。</p> 
<p>　　本文所要介绍的负载均衡技术主要是指在均衡服务器群中所有服务器和应用程序之间流量负载的应用，目前负载均衡技术大多数是用于提高诸如在Web服务器、FTP服务器和其它关键任务服务器上的Internet服务器程序的可用性和可伸缩性。</p> 
<p>　　<strong>负载均衡技术分类</strong></p> 
<p>　　目前有许多不同的负载均衡技术用以满足不同的应用需求，下面从负载均衡所采用的设备对象、应用的网络层次（指OSI参考模型）及应用的地理结构等来分类。</p> 
<p><strong>　　软/硬件负载均衡</strong></p> 
<p>　　软件负载均衡解决方案是指在一台或多台服务器相应的操作系统上安装一个或多个附加软件来实现负载均衡，如DNS Load Balance，CheckPoint Firewall-1 ConnectControl等，它的优点是基于特定环境，配置简单，使用灵活，成本低廉，可以满足一般的负载均衡需求。</p> 
<p>　　软件解决方案缺点也较多，因为每台服务器上安装额外的软件运行会消耗系统不定量的资源，越是功能强大的模块，消耗得越多，所以当连接请求特别大的时候，软件本身会成为服务器工作成败的一个关键；软件可扩展性并不是很好，受到操作系统的限制；由于操作系统本身的Bug，往往会引起安全问题。</p> 
<p>　　硬件负载均衡解决方案是直接在服务器和外部网络间安装负载均衡设备，这种设备我们通常称之为负载均衡器，由于专门的设备完成专门的任务，独立于操作系统，整体性能得到大量提高，加上多样化的负载均衡策略，智能化的流量管理，可达到最佳的负载均衡需求。 </p> 
<p>　　负载均衡器有多种多样的形式，除了作为独立意义上的负载均衡器外，有些负载均衡器集成在交换设备中，置于服务器与Internet链接之间，有些则以两块网络适配器将这一功能集成到PC中，一块连接到Internet上，一块连接到后端服务器群的内部网络上。</p> 
<p>　　一般而言，硬件负载均衡在功能、性能上优于软件方式，不过成本昂贵。</p> 
<p>　　<strong>本地/全局负载均衡</strong></p> 
<p>　　负载均衡从其应用的地理结构上分为本地负载均衡(Local Load Balance)和全局负载均衡(Global Load Balance，也叫地域负载均衡)，本地负载均衡是指对本地的服务器群做负载均衡，全局负载均衡是指对分别放置在不同的地理位置、有不同网络结构的服务器群间作负载均衡。</p> 
<p>　　本地负载均衡能有效地解决数据流量过大、网络负荷过重的问题，并且不需花费昂贵开支购置性能卓越的服务器，充分利用现有设备，避免服务器单点故障造成数据流量的损失。其有灵活多样的均衡策略把数据流量合理地分配给服务器群内的服务器共同负担。即使是再给现有服务器扩充升级，也只是简单地增加一个新的服务器到服务群中，而不需改变现有网络结构、停止现有的服务。 </p> 
<p>　　全局负载均衡主要用于在一个多区域拥有自己服务器的站点，为了使全球用户只以一个IP地址或域名就能访问到离自己最近的服务器，从而获得最快的访问速度，也可用于子公司分散站点分布广的大公司通过Intranet（企业内部互联网）来达到资源统一合理分配的目的。</p> 
<p><strong>　　网络层次上的负载均衡</strong></p> 
<p>　　针对网络上负载过重的不同瓶颈所在，从网络的不同层次入手，我们可以采用相应的负载均衡技术来解决现有问题。 </p> 
<p>　　随着带宽增加，数据流量不断增大，网络核心部分的数据接口将面临瓶颈问题，原有的单一线路将很难满足需求，而且线路的升级又过于昂贵甚至难以实现，这时就可以考虑采用链路聚合（Trunking）技术。</p> 
<p>　　链路聚合技术（第二层负载均衡）将多条物理链路当作一条单一的聚合逻辑链路使用，网络数据流量由聚合逻辑链路中所有物理链路共同承担，由此在逻辑上增大了链路<a href="http://hi.baidu.com/aking_roc" rel="nofollow" title="的">的</a>容量，使其能满足带宽增加的需求。</p> 
<p>　　现代负载均衡技术通常操作于网络的第四层或第七层。第四层负载均衡将一个Internet上合法注册的IP地址映射为多个内部服务器的IP地址，对每次 TCP连接请求动态使用其中一个内部IP地址，达到负载均衡的目的。在第四层交换机中，此种均衡技术得到广泛的应用，一个目标地址是服务器群VIP（虚拟 IP，Virtual IP address）连接请求的数据包流经交换机，交换机根据源端和目的IP地址、TCP或UDP端口号和一定的负载均衡策略，在服务器IP和VIP间进行映射，选取服务器群中最好的服务器来处理连接请求。</p> 
<p>　　第七层负载均衡控制应用层服务的内容，提供了一种对访问流量的高层控制方式，适合对HTTP服务器群的应用。<strong>第七层负载均衡技术通过检查流经的HTTP报头，根据报头内的信息来执行负载均衡任务。 </strong></p> 
<p>　　第七层负载均衡优点表现在如下几个方面： </p> 
<p>　　通过对HTTP报头的检查，可以检测出HTTP400、500和600系列的错误信息，因而能透明地将连接请求重新定向到另一台服务器，避免应用层故障。</p> 
<p>　　可根据流经的数据类型（如判断数据包是图像文件、压缩文件或多媒体文件格式等），把数据流量引向相应内容的服务器来处理，增加系统性能。</p> 
<p>　　能根据连接请求的类型，如是普通文本、图象等静态文档请求，还是asp、cgi等的动态文档请求，把相应的请求引向相应的服务器来处理，提高系统的性能及安全性。</p> 
<p>　　第七层负载均衡受到其所支持的协议限制（一般只有HTTP），这样就限制了它应用的广泛性，并且检查HTTP报头会占用大量的系统资源，势必会影响到系统的性能，在大量连接请求的情况下，负载均衡设备自身容易成为网络整体性能的瓶颈。</p> 
<p>　<strong>　负载均衡策略</strong></p> 
<p>　　在实际应用中，我们可能不想仅仅是把客户端的服务请求平均地分配给内部服务器，而不管服务器是否宕机。而是想使Pentium III服务器比Pentium II能接受更多的服务请求，一台处理服务请求较少的服务器能分配到更多的服务请求，出现故障的服务器将不再接受服务请求直至故障恢复等等。</p> 
<p>　　选择合适的负载均衡策略，使多个设备能很好的共同完成任务，消除或避免现有网络负载分布不均、数据流量拥挤反应时间长的瓶颈。在各负载均衡方式中，针对不同的应用需求，在OSI参考模型的第二、三、四、七层的负载均衡都有相应的负载均衡策略。</p> 
<p>　　负载均衡策略的优劣及其实现的难易程度有两个关键因素：一、负载均衡算法，二、对网络系统状况的检测方式和能力。 </p> 
<p>　　考虑到服务请求的不同类型、服务器的不同处理能力以及随机选择造成的负载分配不均匀等问题，为了更加合理的把负载分配给内部的多个服务器，就需要应用相应的能够正确反映各个服务器处理能力及网络状态的<strong>负载均衡算法：</strong></p> 
<p>　　轮循均衡（Round Robin）：每一次来自网络的请求轮流分配给内部中的服务器，从1至N然后重新开始。此种均衡算法适合于服务器组中的所有服务器都有相同的软硬件配置并且平均服务请求相对均衡的情况。</p> 
<p>　　权重轮循均衡（Weighted Round Robin）：根据服务器的不同处理能力，给每个服务器分配不同的权值，使其能够接受相应权值数的服务请求。例如：服务器A的权值被设计成1，B的权值是 3，C的权值是6，则服务器A、B、C将分别接受到10%、30％、60％的服务请求。此种均衡算法能确保高性能的服务器得到更多的使用率，避免低性能的服务器负载过重。</p> 
<p>　　随机均衡（Random）：把来自网络的请求随机分配给内部中的多个服务器。</p> 
<p>　　权重随机均衡（Weighted Random）：此种均衡算法类似于权重轮循算法，不过在处理请求分担时是个随机选择的过程。</p> 
<p>　　响应速度均衡（Response Time）：负载均衡设备对内部各服务器发出一个探测请求（例如Ping），然后根据内部中各服务器对探测请求的最快响应时间来决定哪一台服务器来响应客户端的服务请求。此种均衡算法能较好的反映服务器的当前运行状态，但这最快响应时间仅仅指的是负载均衡设备与服务器间的最快响应时间，而不是客户端与服务器间的最快响应时间。</p> 
<p>　　最少连接数均衡（Least Connection）：客户端的每一次请求服务在服务器停留的时间可能会有较大的差异，随着工作时间加长，如果采用简单的轮循或随机均衡算法，每一台服务器上的连接进程可能会产生极大的不同，并没有达到真正的负载均衡。最少连接数均衡算法对内部中需负载的每一台服务器都有一个数据记录，记录当前该服务器正在处理的连接数量，当有新的服务连接请求时，将把当前请求分配给连接数最少的服务器，使均衡更加符合实际情况，负载更加均衡。此种均衡算法适合长时处理的请求服务，如FTP。 </p> 
<p>　　处理能力均衡：此种均衡算法将把服务请求分配给内部中处理负荷（根据服务器CPU型号、CPU数量、内存大小及当前连接数等换算而成）最轻的服务器，由于考虑到了内部服务器的处理能力及当前网络运行状况，所以此种均衡算法相对来说更加精确，尤其适合运用到第七层（应用层）负载均衡的情况下。</p> 
<p>　　DNS响应均衡（Flash DNS）：在Internet上，无论是HTTP、FTP或是其它的服务请求，客户端一般都是通过域名解析来找到服务器确切的IP地址的。在此均衡算法下，分处在不同地理位置的负载均衡设备收到同一个客户端的域名解析请求，并在同一时间内把此域名解析成各自相对应服务器的IP地址（即与此负载均衡设备在同一位地理位置的服务器的IP地址）并返回给客户端，则客户端将以最先收到的域名解析IP地址来继续请求服务，而忽略其它的IP地址响应。在种均衡策略适合应用在全局负载均衡的情况下，对本地负载均衡是没有意义的。</p> 
<p>　　尽管有多种的负载均衡算法可以较好的把数据流量分配给服务器去负载，但如果负载均衡策略没有对网络系统状况的检测方式和能力，一旦在某台服务器或某段负载均衡设备与服务器网络间出现故障的情况下，负载均衡设备依然把一部分数据流量引向那台服务器，这势必造成大量的服务请求被丢失，达不到不间断可用性的要求。所以良好的负载均衡策略应有对网络故障、服务器系统故障、应用服务故障的<strong>检测方式和能力：</strong></p> 
<p>　　Ping侦测：通过ping的方式检测服务器及网络系统状况，此种方式简单快速，但只能大致检测出网络及服务器上的操作系统是否正常，对服务器上的应用服务检测就无能为力了。</p> 
<p>　　TCP Open侦测：每个服务都会开放某个通过TCP连接，检测服务器上某个TCP端口（如Telnet的23口，HTTP的80口等）是否开放来判断服务是否正常。</p> 
<p>　　HTTP URL侦测：比如向HTTP服务器发出一个对main.html文件的访问请求，如果收到错误信息，则认为服务器出现故障。</p> 
<p>　　负载均衡策略的优劣除受上面所讲的两个因素影响外，在有些应用情况下，我们需要将来自同一客户端的所有请求都分配给同一台服务器去负担，例如服务器将客户端注册、购物等服务请求信息保存的本地数据库的情况下，把客户端的子请求分配给同一台服务器来处理就显的至关重要了。有两种方式可以解决此问题，一是根据IP地址把来自同一客户端的多次请求分配给同一台服务器处理，客户端IP地址与服务器的对应信息是保存在负载均衡设备上的；二是在客户端浏览器 cookie内做独一无二的标识来把多次请求分配给同一台服务器处理，适合通过代理服务器上网的客户端。</p> 
<p>　　还有一种路径外返回模式（Out of Path Return），当客户端连接请求发送给负载均衡设备的时候，中心负载均衡设备将请求引向某个服务器，服务器的回应请求不再返回给中心负载均衡设备，即绕过流量分配器，直接返回给客户端，因此中心负载均衡设备只负责接受并转发请求，其网络负担就减少了很多，并且给客户端提供了更快的响应时间。此种模式一般用于HTTP服务器群，在各服务器上要安装一块虚拟网络适配器，并将其IP地址设为服务器群的VIP，这样才能在服务器直接回应客户端请求时顺利的达成三次握手。</p> 
<p><strong>　　负载均衡实施要素</strong></p> 
<p>　　负载均衡方案应是在网站建设初期就应考虑的问题，不过有时随着访问流量的爆炸性增长，超出决策者的意料，这也就成为不得不面对的问题。当我们在引入某种负载均衡方案乃至具体实施时，像其他的许多方案一样，首先是确定当前及将来的应用需求，然后在代价与收效之间做出权衡。</p> 
<p>　　针对当前及将来的应用需求，分析网络瓶颈的不同所在，我们就需要确立是采用哪一类的负载均衡技术，采用什么样的均衡策略，在可用性、兼容性、安全性等等方面要满足多大的需求，如此等等。 </p> 
<p>　　不管负载均衡方案是采用花费较少的软件方式，还是购买代价高昂在性能功能上更强的第四层交换机、负载均衡器等硬件方式来实现，亦或其他种类不同的均衡技术，下面这几项都是我们在引入均衡方案时可能要考虑的问题：</p> 
<p>　　性能：性能是我们在引入均衡方案时需要重点考虑的问题，但也是一个最难把握的问题。衡量性能时可将每秒钟通过网络的数据包数目做为一个参数，另一个参数是均衡方案中服务器群所能处理的最大并发连接数目，但是，假设一个均衡系统能处理百万计的并发连接数，可是却只能以每秒2个包的速率转发，这显然是没有任何作用的。性能的优劣与负载均衡设备的处理能力、采用的均衡策略息息相关，并且有两点需要注意：一、均衡方案对服务器群整体的性能，这是响应客户端连接请求速度的关键；二、负载均衡设备自身的性能，避免有大量连接请求时自身性能不足而成为服务瓶颈。有时我们也可以考虑采用混合型负载均衡策略来提升服务器群的总体性能，如DNS负载均衡与NAT负载均衡相结合。另外，针对有大量静态文档请求的站点，也可以考虑采用高速缓存技术，相对来说更节省费用，更能提高响应性能；对有大量ssl/xml内容传输的站点，更应考虑采用ssl/xml加速技术。</p> 
<p>　　可扩展性：IT技术日新月异，一年以前最新的产品，现在或许已是网络中性能最低的产品；业务量的急速上升，一年前的网络，现在需要新一轮的扩展。合适的均衡解决方案应能满足这些需求，能均衡不同操作系统和硬件平台之间的负载，能均衡HTTP、邮件、新闻、代理、数据库、防火墙和 Cache等不同服务器的负载，并且能以对客户端完全透明的方式动态增加或删除某些资源。</p> 
<p>　　灵活性：均衡解决方案应能灵活地提供不同的应用需求，满足应用需求的不断变化。在不同的服务器群有不同的应用需求时，应有多样的均衡策略提供更广泛的选择。</p> 
<p>　　可靠性：在对服务质量要求较高的站点，负载均衡解决方案应能为服务器群提供完全的容错性和高可用性。但在负载均衡设备自身出现故障时，应该有良好的冗余解决方案，提高可靠性。使用冗余时，处于同一个冗余单元的多个负载均衡设备必须具有有效的方式以便互相进行监控，保护系统尽可能地避免遭受到重大故障的损失。</p> 
<p>　　易管理性：不管是通过软件还是硬件方式的均衡解决方案，我们都希望它有灵活、直观和安全的管理方式，这样便于安装、配置、维护和监控，提高工作效率，避免差错。在硬件负载均衡设备上，目前主要有三种管理方式可供选择：一、命令行接口（CLI：Command Line Interface），可通过超级终端连接负载均衡设备串行接口来管理，也能telnet远程登录管理，在初始化配置时，往往要用到前者；二、图形用户接口（GUI：Graphical User Interfaces），有基于普通web页的管理，也有通过Java Applet 进行安全管理，一般都需要管理端安装有某个版本的浏览器；三、SNMP（Simple Network Management Protocol，简单网络管理协议）支持，通过第三方网络管理软件对符合SNMP标准的设备进行管理。</p> 
<p></p> 
<p><a href="http://blog.csdn.net/gzh0222/article/details/8540604" title="lvs、haproxy、nginx 负载均衡的比较分析">lvs、haproxy、nginx 负载均衡的比较分析</a></p> 
<p>对软件实现<a href="http://www.linuxso.com/fuzai/" rel="nofollow" title="负载均衡">负载均衡</a>的几个软件，小D详细看了一下，从性能和稳定上还是LVS最牛，基本达到了F5硬件设备的60%性能，其他几个10%都有点困难。</p> 
<p>     不过就因为LVS忒牛了，配置也最麻烦了，而且健康检测需要另外配置Ldirector，其他HAPROXY和NGINX自己就用，而且配置超级简单。</p> 
<p></p> 
<p>     所以小D建议，如果网站访问量不是门户级别的用HAPROXY或者NGINX就OK了，到了门户级别在用LVS+Idirector吧 哈哈</p> 
<p>    lvs和nginx都可以用作多机负载的方案，它们各有优缺，在生产环境中需要好好分析实际情况并加以利用。</p> 
<p></p> 
<p>首先提醒，做技术切不可人云亦云，我云即你云；同时也不可太趋向保守，过于相信旧有方式而等别人来帮你做垫被测试。把所有即时听说到的好东西加以钻研，从而提高自己对技术的认知和水平，乃是一个好习惯。</p> 
<p>下面来分析一下两者：</p> 
<p>一、lvs的优势：</p> 
<p>1、抗负载能力强，因为lvs工作方式的逻辑是非常之简单，而且工作在网络4层仅做请求分发之用，没有流量，所以在效率上基本不需要太过考虑。在我手里的 lvs，仅仅出过一次问题：在并发最高的一小段时间内均衡器出现丢包现象，据分析为网络问题，即网卡或linux2.4内核的承载能力已到上限，内存和 <a href="http://www.linuxso.com/command/cp.html" rel="nofollow" title="cp">cp</a>u方面基本无消耗。</p> 
<p></p> 
<p>2、配置性低，这通常是一大劣势，但同时也是一大优势，因为没有太多可配置的选项，所以除了增减服务器，并不需要经常去触碰它，大大减少了人为出错的几率。</p> 
<p></p> 
<p>3、工作稳定，因为其本身抗负载能力很强，所以稳定性高也是顺理成章，另外各种lvs都有完整的双机热备方案，所以一点不用担心均衡器本身会出什么问题，节点出现故障的话，lvs会自动判别，所以系统整体是非常稳定的。</p> 
<p></p> 
<p>4、无流量，上面已经有所提及了。lvs仅仅分发请求，而流量并不从它本身出去，所以可以利用它这点来做一些线路分流之用。没有流量同时也保住了均衡器的IO性能不会受到大流量的影响。</p> 
<p></p> 
<p>5、基本上能支持所有应用，因为lvs工作在4层，所以它可以对几乎所有应用做负载均衡，包括http、数据库、聊天室等等。</p> 
<p></p> 
<p>另：lvs也不是完全能判别节点故障的，譬如在wlc分配方式下，<a href="http://www.linuxso.com/linuxjiqun/" rel="nofollow" title="集群">集群</a>里有一个节点没有配置VIP，会使整个集群不能使用，这时使用wrr分配方式则会丢掉一台机。目前这个问题还在进一步测试中。所以，用lvs也得多多当心为妙。</p> 
<p></p> 
<p>二、nginx和lvs作对比的结果</p> 
<p></p> 
<p>1、nginx工作在网络的7层，所以它可以针对http应用本身来做分流策略，比如针对域名、目录结构等，相比之下lvs并不具备这样的功能，所以 nginx单凭这点可利用的场合就远多于lvs了；但nginx有用的这些功能使其可调整度要高于lvs，所以经常要去触碰触碰，由lvs的第2条优点 看，触碰多了，人为出问题的几率也就会大。</p> 
<p></p> 
<p>2、nginx对网络的依赖较小，理论上只要<a href="http://www.linuxso.com/command/ping.html" rel="nofollow" title="ping">ping</a>得通，网页访问正常，nginx就能连得通，nginx同时还能区分内外网，如果是同时拥有内外网的 节点，就相当于单机拥有了备份线路；lvs就比较依赖于网络环境，目前来看服务器在同一网段内并且lvs使用direct方式分流，效果较能得到保证。另 外注意，lvs需要向托管商至少申请多一个ip来做Vi<a href="http://www.linuxso.com/command/su.html" rel="nofollow" title="su">su</a>al IP，貌似是不能用本身的IP来做VIP的。要做好LVS管理员，确实得跟进学习很多有关网络通信方面的知识，就不再是一个HTTP那么简单了。</p> 
<p></p> 
<p>3、nginx安装和配置比较简单，测试起来也很方便，因为它基本能把错误用日志打印出来。lvs的安装和配置、测试就要花比较长的时间了，因为同上所述，lvs对网络依赖比较大，很多时候不能配置成功都是因为网络问题而不是配置问题，出了问题要解决也相应的会麻烦得多。</p> 
<p></p> 
<p>4、nginx也同样能承受很高负载且稳定，但负载度和稳定度差lvs还有几个等级：nginx处理所有流量所以受限于机器IO和配置；本身的bug也还是难以避免的；nginx没有现成的双机热备方案，所以跑在单机上还是风险较大，单机上的事情全都很难说。</p> 
<p></p> 
<p>5、nginx可以检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点。目前lvs中 ldirectd也能支持针对服务器内部的情况来监控，但lvs的原理使其不能重发请求。重发请求这点，譬如用户正在上传一个文件，而处理该上传的节点刚 好在上传过程中出现故障，nginx会把上传切到另一台服务器重新处理，而lvs就直接断掉了，如果是上传一个很大的文件或者很重要的文件的话，用户可能 会因此而恼火。</p> 
<p></p> 
<p>6、nginx对请求的异步处理可以帮助节点服务器减轻负载，假如使用apache直接对外服务，那么出现很多的窄带链接时apache服务器将会占用大 量内存而不能释放，使用多一个nginx做apache代理的话，这些窄带链接会被nginx挡住，apache上就不会堆积过多的请求，这样就减少了相 当多的内存占用。这点使用squ<a href="http://www.linuxso.com/command/id.html" rel="nofollow" title="id">id</a>也有相同的作用，即使squid本身配置为不缓存，对apache还是有很大帮助的。lvs没有这些功能，也就无法能 比较。</p> 
<p></p> 
<p>7、nginx能支持http和email（email的功能估计比较少人用），lvs所支持的应用在这点上会比nginx更多。</p> 
<p></p> 
<p>在使用上，一般最前端所采取的策略应是lvs，也就是DNS的指向应为lvs均衡器，lvs的优点令它非常适合做这个任务。</p> 
<p></p> 
<p>重要的ip地址，最好交由lvs托管，比如数据库的ip、webservice服务器的ip等等，这些ip地址随着时间推移，使用面会越来越大，如果更换ip则故障会接踵而至。所以将这些重要ip交给lvs托管是最为稳妥的，这样做的唯一缺点是需要的VIP数量会比较多。</p> 
<p></p> 
<p>nginx可作为lvs节点机器使用，一是可以利用nginx的功能，二是可以利用nginx的性能。当然这一层面也可以直接使用squid，squid的功能方面就比nginx弱不少了，性能上也有所逊色于nginx。</p> 
<p></p> 
<p>nginx也可作为中层代理使用，这一层面nginx基本上无对手，唯一可以撼动nginx的就只有lig<a href="http://www.linuxso.com/command/httpd.html" rel="nofollow" title="httpd">httpd</a>了，不过lighttpd目前还没有 能做到nginx完全的功能，配置也不那么清晰易读。另外，中层代理的IP也是重要的，所以中层代理也拥有一个VIP和lvs是最完美的方案了。</p> 
<p></p> 
<p>nginx也可作为网页静态服务器，不过超出了本文讨论的范畴，简单提一下。</p> 
<p></p> 
<p>具体的应用还得具体分析，如果是比较小的网站（日PV&lt;1000万），用nginx就完全可以了，如果机器也不少，可以用DNS轮询，lvs所耗费的机器还是比较多的；大型网站或者重要的服务，机器不发愁的时候，要多多考虑利用lvs。</p> 
<p>************************************************************************************************************************************************************************************************</p> 
<p>Nginx的优点:</p> 
<p>性能好，可以负载超过1万的并发。</p> 
<p>功能多，除了负载均衡，还能作Web服务器，而且可以通过Geo模块来实现流量分配。</p> 
<p>社区活跃，第三方补丁和模块很多</p> 
<p>支持g<a href="http://www.linuxso.com/command/zip.html" rel="nofollow" title="zip">zip</a> proxy</p> 
<p>缺点:</p> 
<p>不支持session保持。</p> 
<p>对后端rea<a href="http://www.linuxso.com/command/ls.html" rel="nofollow" title="ls">ls</a>erver的健康检查功能效果不好。而且只支持通过端口来检测，不支持通过url来检测。</p> 
<p>nginx对big request header的支持不是很好，如果client_header_buffer_size设置的比较小，就会返回400bad request页面。</p> 
<p>Haproxy的优点:</p> 
<p>它的优点正好可以补充nginx的缺点。支持session保持，同时支持通过获取指定的url来检测后端服务器的状态。</p> 
<p>支持tcp模式的负载均衡。比如可以给<a href="http://lib.csdn.net/base/mysql" rel="nofollow" title="MySQL">MySQL</a>的从服务器集群和邮件服务器做负载均衡。</p> 
<p>缺点：</p> 
<p>不支持虚拟主机(这个很傻啊)</p> 
<p>目前没有nagios和cacti的性能监控模板</p> 
<p>LVS的优点:</p> 
<p>性能好，接近硬件设备的网络吞吐和连接负载能力。</p> 
<p>LVS的DR模式，支持通过广域网进行负载均衡。这个其他任何负载均衡软件目前都不具备。</p> 
<p>缺点：</p> 
<p>比较重型。另外社区不如nginx活跃。</p> 
<p>*************************************************************************************</p> 
<p></p> 
<p>现在网络中常见的的负载均衡主要分为两种：一种是通过硬件来进行进行，常见的硬件有比较昂贵的NetScaler、F5、Radware和Array等商用的负载均衡器，也有类似于LVS、Nginx、HAproxy的基于<a href="http://lib.csdn.net/base/linux" rel="nofollow" title="Linux">Linux</a>的开源的负载均衡策略,</p> 
<p>商用负载均衡里面NetScaler从效果上比F5的效率上更高。对于负载均衡器来说，不过商用负载均衡由于可以建立在四~七层协议之上，因此适用 面更广所以有其不可替代性，他的优点就是有专业的维护团队来对这些服务进行维护、缺点就是花销太大，所以对于规模较小的网络服务来说暂时还没有需要使用。</p> 
<p>另一种负载均衡的方式是通过软件：比较常见的有LVS、Nginx、HAproxy等，其中LVS是建立在四层协议上面的，而另外Nginx和HAproxy是建立在七层协议之上的，下面分别介绍关于</p> 
<p>LVS：使用集群技术和Linux<a href="http://lib.csdn.net/base/operatingsystem" rel="nofollow" title="操作系统">操作系统</a>实现一个高性能、高可用的服务器，它具有很好的可伸缩性（Scalability）、可靠性（Reliability）和可管理性（Manageability）。</p> 
<p>LVS的特点是：</p> 
<p>1、抗负载能力强、是工作在网络4层之上仅作分发之用，没有流量的产生；</p> 
<p>2、配置性比较低，这是一个缺点也是一个优点，因为没有可太多配置的东西，所以并不需要太多接触，大大减少了人为出错的几率；</p> 
<p>3、工作稳定，自身有完整的双机热备方案；</p> 
<p>4、无流量，保证了均衡器IO的性能不会收到大流量的影响；</p> 
<p>5、应用范围比较广，可以对所有应用做负载均衡；</p> 
<p>6、LVS需要向IDC多申请一个IP来做Visual IP，因此需要一定的网络知识，所以对操作人的要求比较高。</p> 
<p>Nginx的特点是：</p> 
<p>1、工作在网络的7层之上，可以针对http应用做一些分流的策略，比如针对域名、目录结构；</p> 
<p>2、Nginx对网络的依赖比较小；</p> 
<p>3、Nginx安装和配置比较简单，<a href="http://lib.csdn.net/base/softwaretest" rel="nofollow" title="测试">测试</a>起来比较方便；</p> 
<p>4、也可以承担高的负载压力且稳定，一般能支撑超过1万次的并发；</p> 
<p>5、Nginx可以通过端口检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点，不过其中缺点就是不支持url来检测；</p> 
<p>6、Nginx对请求的异步处理可以帮助节点服务器减轻负载；</p> 
<p>7、Nginx能支持http和Email，这样就在适用范围上面小很多；</p> 
<p>8、不支持Session的保持、对Big request header的支持不是很好，另外默认的只有Round-robin和IP-hash两种负载均衡<a href="http://lib.csdn.net/base/datastructure" rel="nofollow" title="算法">算法</a>。</p> 
<p>HAProxy的特点是：</p> 
<p>1、HAProxy是工作在网络7层之上。</p> 
<p>2、能够补充Nginx的一些缺点比如Session的保持，Cookie的引导等工作</p> 
<p>3、支持url检测后端的服务器出问题的检测会有很好的帮助。</p> 
<p>4、更多的负载均衡策略比如：动态加权轮循(Dynamic Round Robin)，加权源地址哈希(Weighted Source Hash)，加权URL哈希和加权参数哈希(Weighted Parameter Hash)已经实现</p> 
<p>5、单纯从效率上来讲HAProxy更会比Nginx有更出色的负载均衡速度。</p> 
<p>6、HAProxy可以对Mysql进行负载均衡，对后端的DB节点进行检测和负载均衡。</p> 
<p>***********************************************************************************************</p> 
<p><strong>现在网站发展的趋势对网络负载均衡的使用是随着网站规模的提升根据不同的阶段来使用不同的技术：</strong></p> 
<p>第一阶段：利用Nginx或者HAProxy进行单点的负载均衡，这一阶段服务器规模刚脱离开单服务器、单<a href="http://lib.csdn.net/base/mysql" rel="nofollow" title="数据库">数据库</a>的模式，需要一定的负载均衡，但是 仍然规模较小没有专业的维护团队来进行维护，也没有需要进行大规模的网站部署。这样利用Nginx或者HAproxy就是第一选择，此时这些东西上手快， 配置容易，在七层之上利用HTTP协议就可以。这时是第一选择</p> 
<p>第二阶段：随着网络服务进一步扩大，这时单点的Nginx已经不能满足，这时使用LVS或者商用F5就是首要选择，Nginx此时就作为LVS或者 F5的节点来使用，具体LVS或者F5的是选择是根据公司规模，人才以及资金能力来选择的，这里也不做详谈，但是一般来说这阶段相关人才跟不上业务的提 升，所以购买商业负载均衡已经成为了必经之路。</p> 
<p>第三阶段：这时网络服务已经成为主流产品，此时随着公司知名度也进一步扩展，相关人才的能力以及数量也随之提升，这时无论从开发适合自身产品的定制，以及降低成本来讲开源的LVS，已经成为首选，这时LVS会成为主流。</p> 
<p>最终形成比较理想的状态为：F5/LVS&lt;—&gt;Haproxy&lt;—&gt;Squid/Varnish&lt;—&gt;AppServer。</p> 
<h2>LVS：三种负载均衡方式比较</h2> 
<h4>1、什么是<a href="http://www.chinabyte.com/keyword/LVS/" rel="nofollow" title="LVS">LVS</a>？</h4> 
<p>　　首先简单介绍一下LVS (<a href="http://www.chinabyte.com/keyword/Linux/" rel="nofollow" title="Linux">Linux</a> Virtual Server)到底是什么东西，其实它是一种集群(Cluster)技术，采用IP负载均衡技术和基于内容请求分发技术。调度器具有很好的吞吐率，将请求均衡地转移到不同的<a href="http://server.chinabyte.com/" rel="nofollow" title="服务器">服务器</a>上执行，且调度器自动屏蔽掉服务器的故障，从而将一组服务器构成一个高性能的、高可用的虚拟服务器。整个服务器集群的结构对客户是透明的，而且无需修改客户端和服务器端的程序。</p> 
<p>　　为此，在设计时需要考虑系统的透明性、可伸缩性、高可用性和易管理性。一般来说，LVS集</p> 
<p>　　群采用三层结构，其体系结构如图所示：</p> 
<p><img alt="" height="479" src="https://images2.imgbox.com/d7/1d/ej07Jvss_o.jpg" width="457"></p> 
<h2>　　LVS集群的体系结构</h2> 
<h4>　　2、LVS主要组成部分为：</h4> 
<p>　　负载调度器(load balancer/<a href="http://www.chinabyte.com/keyword/Director/" rel="nofollow" title=" Director"> Director</a>)，它是整个集群对外面的前端机，负责将客户的请求发送到一组服务器上执行，而客户认为服务是来自一个IP地址(我们可称之为虚拟IP地址)上的。</p> 
<p>　　服务器池(server pool/ Realserver)，是一组真正执行客户请求的服务器，执行的服务一般有WEB、MAIL、<a href="http://www.chinabyte.com/keyword/FTP/" rel="nofollow" title="FTP">FTP</a>和DNS等。</p> 
<p>　　共享<a href="http://storage.chinabyte.com/" rel="nofollow" title="存储">存储</a>(shared storage)，它为服务器池提供一个共享的存储区，这样很容易使得服务器池拥有相同的内容，提供相同的服务。</p> 
<h4>　　3、LVS负载均衡方式:</h4> 
<p>　　◆Virtual Server via Network<a href="http://www.chinabyte.com/keyword/address/" rel="nofollow" title=" Address"> Address</a> Translation NAT(VS/NAT)</p> 
<p>　　VS/NAT是一种最简单的方式，所有的RealServer只需要将自己的<a href="http://www.chinabyte.com/keyword/%E7%BD%91%E5%85%B3/" rel="nofollow" title="网关">网关</a>指向Director即可。客户端可以是任意<a href="http://soft.chinabyte.com/os/" rel="nofollow" title="操作系统">操作系统</a>，但此方式下，一个Director能够带动的RealServer比较有限。在VS/NAT的方式下，Director也可以兼为一台RealServer。VS/NAT的体系结构如图所示。</p> 
<p><img alt="" height="605" src="https://images2.imgbox.com/86/ea/QQz8ItFw_o.jpg" width="649"></p> 
<p>　　VS/NAT的体系结构</p> 
<p>　　◆Virtual Server via IP Tunneling(VS/TUN)</p> 
<p>　　IP隧道(IP tunneling)是将一个IP报文<a href="http://www.chinabyte.com/keyword/%E5%B0%81%E8%A3%85/" rel="nofollow" title="封装">封装</a>在另一个IP报文的技术，这可以使得目标为一个IP地址的数据报文能被封装和转发到另一个IP地址。IP隧道技术亦称为IP封装技术(IP encapsulation)。IP隧道主要用于移动主机和虚拟私有网络(Virtual Private Network)，在其中隧道都是静态建立的，隧道一端有一个IP地址，另一端也有唯一的IP地址。它的连接调度和管理与VS/NAT中的一样，只是它的报文转发方法不同。调度器根据各个服务器的负载情况，动态地选择一台服务器，将请求报文封装在另一个IP报文中，再将封装后的IP报文转发给选出的服务器;服务器收到报文后，先将报文解封获得原来目标地址为 VIP 的报文，服务器发现VIP地址被配置在本地的IP隧道设备上，所以就处理这个请求，然后根据路由表将响应报文直接返回给客户。</p> 
<p><img alt="" height="659" src="https://images2.imgbox.com/52/d9/lyuEfX0z_o.jpg" width="691"></p> 
<p>　　VS/TUN的体系结构</p> 
<p>　　VS/TUN的工作流程：</p> 
<p><img alt="" height="280" src="https://images2.imgbox.com/4c/22/G2utwino_o.jpg" width="478"></p> 
<p>　　◆Virtual Server via Direct Routing(VS/DR)</p> 
<p>　　VS/DR方式是通过改写请求报文中的<a href="http://www.chinabyte.com/keyword/Mac/" rel="nofollow" title="MAC">MAC</a>地址部分来实现的。Director和RealServer必需在物理上有一个网卡通过不间断的<a href="http://www.chinabyte.com/keyword/%E5%B1%80%E5%9F%9F%E7%BD%91/" rel="nofollow" title="局域网">局域网</a>相连。 RealServer上绑定的VIP配置在各自Non-<a href="http://www.chinabyte.com/keyword/ARP/" rel="nofollow" title="ARP">ARP</a>的网络设备上(如lo或tunl),Director的VIP地址对外可见，而RealServer的VIP对外是不可见的。RealServer的地址即可以是内部地址，也可以是真实地址。</p> 
<p><img alt="" height="661" src="https://images2.imgbox.com/bd/81/ByoX4TPb_o.jpg" width="691"></p> 
<p>　　VS/DR的体系结构</p> 
<p>　　VS/DR的工作流程</p> 
<p>　　VS/DR的工作流程如图所示：它的连接调度和管理与VS/NAT和VS/TUN中的一样，它的报文转发方法又有不同，将报文直接路由给目标服务器。在VS/DR中，调度器根据各个服务器的负载情况，动态地选择一台服务器，不修改也不封装IP报文，而是将数据帧的MAC地址改为选出服务器的MAC地址，再将修改后的数据帧在与服务器组的局域网上发送。因为数据帧的MAC地址是选出的服务器，所以服务器肯定可以收到这个数据帧，从中可以获得该IP报文。当服务器发现报文的目标地址VIP是在本地的网络设备上，服务器处理这个报文，然后根据路由表将响应报文直接返回给客户。</p> 
<p><img alt="" height="280" src="https://images2.imgbox.com/7d/77/CfHejLxI_o.jpg" width="478"></p> 
<p>　　VS/DR的工作流程</p> 
<p>　　4、三种负载均衡方式比较：</p> 
<p>　　◆Virtual Server via NAT</p> 
<p>　　VS/NAT 的优点是服务器可以运行任何支持<a href="http://www.chinabyte.com/keyword/TCP/IP/" rel="nofollow" title="TCP/IP">TCP/IP</a>的操作系统，它只需要一个IP地址配置在调度器上，服务器组可以用私有的IP地址。缺点是它的伸缩能力有限，当服务器结点数目升到20时，调度器本身有可能成为系统的新瓶颈，因为在VS/NAT中请求和响应报文都需要通过负载调度器。我们在Pentium166<a href="http://www.chinabyte.com/keyword/%E5%A4%84%E7%90%86%E5%99%A8/" rel="nofollow" title=" 处理器"> 处理器</a>的主机上测得重写报文的平均延时为60us，<a href="http://www.chinabyte.com/keyword/%E6%80%A7%E8%83%BD%E6%9B%B4%E9%AB%98/" rel="nofollow" title="性能更高">性能更高</a>的处理器上延时会短一些。假设TCP报文的平均长度为536 Bytes，则调度器的最大吞吐量为8.93 MBytes/s. 我们再假设每台服务器的吞吐量为800KBytes/s，这样一个调度器可以带动10台服务器。(注：这是很早以前测得的数据)</p> 
<p>　　基于 VS/NAT的的集群系统可以适合许多服务器的性能要求。如果负载调度器成为系统新的瓶颈，可以有三种方法解决这个问题：混合方法、VS/TUN和 VS/DR。在DNS混合集群系统中，有若干个VS/NAT负调度器，每个负载调度器带自己的服务器集群，同时这些负载调度器又通过RR-DNS组成简单的<a href="http://www.chinabyte.com/keyword/%E5%9F%9F%E5%90%8D/" rel="nofollow" title="域名">域名</a>。</p> 
<p>　　但VS/TUN和VS/DR是提高系统吞吐量的更好方法。</p> 
<p>　　对于那些将IP地址或者端口号在报文数据中传送的网络服务，需要编写相应的应用<a href="http://www.chinabyte.com/keyword/%E6%A8%A1%E5%9D%97/" rel="nofollow" title="模块">模块</a>来转换报文数据中的IP地址或者端口号。这会带来实现的工作量，同时应用模块检查报文的开销会降低系统的吞吐率。</p> 
<p>　　◆Virtual Server via IP Tunneling</p> 
<p>　　在VS/TUN 的集群系统中，负载调度器只将请求调度到不同的后端服务器，后端服务器将应答的数据直接返回给用户。这样，负载调度器就可以处理大量的请求，它甚至可以调度百台以上的服务器(同等规模的服务器)，而它不会成为系统的瓶颈。即使负载调度器只有100Mbps的全双工网卡，整个系统的最大吞吐量可超过 1Gbps。所以，VS/TUN可以极大地增加负载调度器调度的服务器数量。VS/TUN调度器可以调度上百台服务器，而它本身不会成为系统的瓶颈，可以用来构建高性能的超级服务器。VS/TUN技术对服务器有要求，即所有的服务器必须支持“IP Tunneling”或者“IP Encapsulation”协议。目前，VS/TUN的后端服务器主要运行Linux操作系统，我们没对其他操作系统进行测试。因为“IP Tunneling”正成为各个操作系统的标准协议，所以VS/TUN应该会适用运行其他操作系统的后端服务器。</p> 
<p>　　◆Virtual Server via Direct Routing</p> 
<p>　　跟VS/TUN方法一样，VS/DR调度器只处理客户到服务器端的连接，响应数据可以直接从独立的网络路由返回给客户。这可以极大地提高LVS集群系统的伸缩性。跟VS/TUN相比，这种方法没有IP隧道的开销，但是要求负载调度器与实际服务器都有一块网卡连在同一物理网段上，服务器网络设备(或者设备别名)不作ARP响应，或者能将报文重定向(Redirect)到本地的Socket端口上。</p> 
<p>　　三种LVS负载均衡技术的优缺点归纳以下表：</p> 
<p>　　VS/NATVS/TUNVS/DR</p> 
<p>　　服务器操作系统任意支持隧道多数(支持Non-arp)</p> 
<p>　　服务器网络私有网络局域网/广域网局域网</p> 
<p>　　服务器数目(100M网络)10~20100大于100</p> 
<p>　　服务器网关负载均衡器自己的路由自己的路由</p> 
<p>　　效率一般高最高</p> 
<p>　　注：以上三种方法所能支持最大服务器数目的估计是假设调度器使用100M网卡，调度器的硬件配置与后端服务器的硬件配置相同，而且是对一般Web服务。使 用更高的硬件配置(如千兆网卡和更快的处理器)作为调度器，调度器所能调度的服务器数量会相应增加。当应用不同时，服务器的数目也会相应地改变。所以，以上数据估计主要是为三种方法的伸缩性进行量化比较。</p> 
<p>　　5、负载均衡调度算法</p> 
<p>　　◆最少的连接方式(Least Connection)：传递新的连接给那些进行最少连接处理的服务器。当其中某个服务器发生第二到第7 层的故障，BIG-IP 就把其从服务器队列中拿出，不参加下一次的用户请求的分配, 直到其恢复正常。</p> 
<p>　　◆最快模式(Fastest)：传递连接给那些响应最快的服务器。当其中某个服务器发生第二到第7 层的故障，BIG-IP 就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。</p> 
<p>　　◆观察模式(Observed)：连接数目和响应时间以这两项的最佳平衡为依据为新的请求选择服务器。当其中某个服务器发生第二到第7 层的故障，BIG-IP就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。</p> 
<p>　　◆预测模式(Predictive)：BIG-IP利用收集到的服务器当前的性能指标，进行预测分析，选择一台服务器在下一个时间片内，其性能将达到最佳的服务器相应用户的请求。(被BIG-IP 进行检测)</p> 
<p>　　◆动态性能分配(Dynamic Ratio-APM):BIG-IP 收集到的应用程序和<a href="http://www.chinabyte.com/keyword/%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1/" rel="nofollow" title="应用服务">应用服务</a>器的各项性能参数，动态调整流量分配。</p> 
<p>　　◆动态服务器补充(Dynamic Server Act.):当主服务器群中因故障导致数量减少时，动态地将备份服务器补充至主服务器群。</p> 
<p>　　◆服务质量(QoS):按不同的优先级对数据流进行分配。</p> 
<p>　　◆服务类型(ToS): 按不同的服务类型(在Type of Field中标识)负载均衡对数据流进行分配。</p> 
<p>　　◆规则模式：针对不同的数据流设置导向规则，用户可自行</p> 
<h4>1、什么是<a href="http://www.chinabyte.com/keyword/LVS/" rel="nofollow" title="LVS">LVS</a>？</h4> 
<p>　　首先简单介绍一下LVS (<a href="http://www.chinabyte.com/keyword/Linux/" rel="nofollow" title="Linux">Linux</a> Virtual Server)到底是什么东西，其实它是一种集群(Cluster)技术，采用IP负载均衡技术和基于内容请求分发技术。调度器具有很好的吞吐率，将请求均衡地转移到不同的<a href="http://server.chinabyte.com/" rel="nofollow" title="服务器">服务器</a>上执行，且调度器自动屏蔽掉服务器的故障，从而将一组服务器构成一个高性能的、高可用的虚拟服务器。整个服务器集群的结构对客户是透明的，而且无需修改客户端和服务器端的程序。</p> 
<p>　　为此，在设计时需要考虑系统的透明性、可伸缩性、高可用性和易管理性。一般来说，LVS集</p> 
<p>　　群采用三层结构，其体系结构如图所示：</p> 
<p><img alt="" height="479" src="https://images2.imgbox.com/4e/5a/FselxBHc_o.jpg" width="457"></p> 
<p>　　LVS集群的体系结构</p> 
<h4>　　2、LVS主要组成部分为：</h4> 
<p>　　负载调度器(load balancer/<a href="http://www.chinabyte.com/keyword/Director/" rel="nofollow" title=" Director"> Director</a>)，它是整个集群对外面的前端机，负责将客户的请求发送到一组服务器上执行，而客户认为服务是来自一个IP地址(我们可称之为虚拟IP地址)上的。</p> 
<p>　　服务器池(server pool/ Realserver)，是一组真正执行客户请求的服务器，执行的服务一般有WEB、MAIL、<a href="http://www.chinabyte.com/keyword/FTP/" rel="nofollow" title="FTP">FTP</a>和DNS等。</p> 
<p>　　共享<a href="http://storage.chinabyte.com/" rel="nofollow" title="存储">存储</a>(shared storage)，它为服务器池提供一个共享的存储区，这样很容易使得服务器池拥有相同的内容，提供相同的服务。</p> 
<h4>　　3、LVS负载均衡方式:</h4> 
<p>　　◆Virtual Server via Network<a href="http://www.chinabyte.com/keyword/address/" rel="nofollow" title=" Address"> Address</a> Translation NAT(VS/NAT)</p> 
<p>　　VS/NAT是一种最简单的方式，所有的RealServer只需要将自己的<a href="http://www.chinabyte.com/keyword/%E7%BD%91%E5%85%B3/" rel="nofollow" title="网关">网关</a>指向Director即可。客户端可以是任意<a href="http://soft.chinabyte.com/os/" rel="nofollow" title="操作系统">操作系统</a>，但此方式下，一个Director能够带动的RealServer比较有限。在VS/NAT的方式下，Director也可以兼为一台RealServer。VS/NAT的体系结构如图所示。</p> 
<p><img alt="" height="605" src="https://images2.imgbox.com/67/cf/6zri9hsx_o.jpg" width="649"></p> 
<p>　　VS/NAT的体系结构</p> 
<p>　　◆Virtual Server via IP Tunneling(VS/TUN)</p> 
<p>　　IP隧道(IP tunneling)是将一个IP报文<a href="http://www.chinabyte.com/keyword/%E5%B0%81%E8%A3%85/" rel="nofollow" title="封装">封装</a>在另一个IP报文的技术，这可以使得目标为一个IP地址的数据报文能被封装和转发到另一个IP地址。IP隧道技术亦称为IP封装技术(IP encapsulation)。IP隧道主要用于移动主机和虚拟私有网络(Virtual Private Network)，在其中隧道都是静态建立的，隧道一端有一个IP地址，另一端也有唯一的IP地址。它的连接调度和管理与VS/NAT中的一样，只是它的报文转发方法不同。调度器根据各个服务器的负载情况，动态地选择一台服务器，将请求报文封装在另一个IP报文中，再将封装后的IP报文转发给选出的服务器;服务器收到报文后，先将报文解封获得原来目标地址为 VIP 的报文，服务器发现VIP地址被配置在本地的IP隧道设备上，所以就处理这个请求，然后根据路由表将响应报文直接返回给客户。</p> 
<p><img alt="" height="659" src="https://images2.imgbox.com/a8/f1/a3MARqU7_o.jpg" width="691"></p> 
<p>　　VS/TUN的体系结构</p> 
<p>　　VS/TUN的工作流程：</p> 
<p><img alt="" height="280" src="https://images2.imgbox.com/7f/69/f5YEIVLS_o.jpg" width="478"></p> 
<p>　　◆Virtual Server via Direct Routing(VS/DR)</p> 
<p>　　VS/DR方式是通过改写请求报文中的<a href="http://www.chinabyte.com/keyword/Mac/" rel="nofollow" title="MAC">MAC</a>地址部分来实现的。Director和RealServer必需在物理上有一个网卡通过不间断的<a href="http://www.chinabyte.com/keyword/%E5%B1%80%E5%9F%9F%E7%BD%91/" rel="nofollow" title="局域网">局域网</a>相连。 RealServer上绑定的VIP配置在各自Non-<a href="http://www.chinabyte.com/keyword/ARP/" rel="nofollow" title="ARP">ARP</a>的网络设备上(如lo或tunl),Director的VIP地址对外可见，而RealServer的VIP对外是不可见的。RealServer的地址即可以是内部地址，也可以是真实地址。</p> 
<p><img alt="" height="661" src="https://images2.imgbox.com/c7/cb/gfDwJDAG_o.jpg" width="691"></p> 
<p>　　VS/DR的体系结构</p> 
<p>　　VS/DR的工作流程</p> 
<p>　　VS/DR的工作流程如图所示：它的连接调度和管理与VS/NAT和VS/TUN中的一样，它的报文转发方法又有不同，将报文直接路由给目标服务器。在VS/DR中，调度器根据各个服务器的负载情况，动态地选择一台服务器，不修改也不封装IP报文，而是将数据帧的MAC地址改为选出服务器的MAC地址，再将修改后的数据帧在与服务器组的局域网上发送。因为数据帧的MAC地址是选出的服务器，所以服务器肯定可以收到这个数据帧，从中可以获得该IP报文。当服务器发现报文的目标地址VIP是在本地的网络设备上，服务器处理这个报文，然后根据路由表将响应报文直接返回给客户。</p> 
<p><img alt="" height="280" src="https://images2.imgbox.com/b5/32/UcUeyWpJ_o.jpg" width="478"></p> 
<p>　　VS/DR的工作流程</p> 
<h4>　　4、三种负载均衡方式比较：</h4> 
<p>　　◆Virtual Server via NAT</p> 
<p>　　VS/NAT 的优点是服务器可以运行任何支持<a href="http://www.chinabyte.com/keyword/TCP/IP/" rel="nofollow" title="TCP/IP">TCP/IP</a>的操作系统，它只需要一个IP地址配置在调度器上，服务器组可以用私有的IP地址。缺点是它的伸缩能力有限，当服务器结点数目升到20时，调度器本身有可能成为系统的新瓶颈，因为在VS/NAT中请求和响应报文都需要通过负载调度器。我们在Pentium166<a href="http://www.chinabyte.com/keyword/%E5%A4%84%E7%90%86%E5%99%A8/" rel="nofollow" title=" 处理器"> 处理器</a>的主机上测得重写报文的平均延时为60us，<a href="http://www.chinabyte.com/keyword/%E6%80%A7%E8%83%BD%E6%9B%B4%E9%AB%98/" rel="nofollow" title="性能更高">性能更高</a>的处理器上延时会短一些。假设TCP报文的平均长度为536 Bytes，则调度器的最大吞吐量为8.93 MBytes/s. 我们再假设每台服务器的吞吐量为800KBytes/s，这样一个调度器可以带动10台服务器。(注：这是很早以前测得的数据)</p> 
<p>　　基于 VS/NAT的的集群系统可以适合许多服务器的性能要求。如果负载调度器成为系统新的瓶颈，可以有三种方法解决这个问题：混合方法、VS/TUN和 VS/DR。在DNS混合集群系统中，有若干个VS/NAT负调度器，每个负载调度器带自己的服务器集群，同时这些负载调度器又通过RR-DNS组成简单的<a href="http://www.chinabyte.com/keyword/%E5%9F%9F%E5%90%8D/" rel="nofollow" title="域名">域名</a>。</p> 
<p>　　但VS/TUN和VS/DR是提高系统吞吐量的更好方法。</p> 
<p>　　对于那些将IP地址或者端口号在报文数据中传送的网络服务，需要编写相应的应用<a href="http://www.chinabyte.com/keyword/%E6%A8%A1%E5%9D%97/" rel="nofollow" title="模块">模块</a>来转换报文数据中的IP地址或者端口号。这会带来实现的工作量，同时应用模块检查报文的开销会降低系统的吞吐率。</p> 
<p>　　◆Virtual Server via IP Tunneling</p> 
<p>　　在VS/TUN 的集群系统中，负载调度器只将请求调度到不同的后端服务器，后端服务器将应答的数据直接返回给用户。这样，负载调度器就可以处理大量的请求，它甚至可以调度百台以上的服务器(同等规模的服务器)，而它不会成为系统的瓶颈。即使负载调度器只有100Mbps的全双工网卡，整个系统的最大吞吐量可超过 1Gbps。所以，VS/TUN可以极大地增加负载调度器调度的服务器数量。VS/TUN调度器可以调度上百台服务器，而它本身不会成为系统的瓶颈，可以用来构建高性能的超级服务器。VS/TUN技术对服务器有要求，即所有的服务器必须支持“IP Tunneling”或者“IP Encapsulation”协议。目前，VS/TUN的后端服务器主要运行Linux操作系统，我们没对其他操作系统进行测试。因为“IP Tunneling”正成为各个操作系统的标准协议，所以VS/TUN应该会适用运行其他操作系统的后端服务器。</p> 
<p>　　◆Virtual Server via Direct Routing</p> 
<p>　　跟VS/TUN方法一样，VS/DR调度器只处理客户到服务器端的连接，响应数据可以直接从独立的网络路由返回给客户。这可以极大地提高LVS集群系统的伸缩性。跟VS/TUN相比，这种方法没有IP隧道的开销，但是要求负载调度器与实际服务器都有一块网卡连在同一物理网段上，服务器网络设备(或者设备别名)不作ARP响应，或者能将报文重定向(Redirect)到本地的Socket端口上。</p> 
<p>　　三种LVS负载均衡技术的优缺点归纳以下表：</p> 
<p>　　VS/NATVS/TUNVS/DR</p> 
<p>　　服务器操作系统任意支持隧道多数(支持Non-arp)</p> 
<p>　　服务器网络私有网络局域网/广域网局域网</p> 
<p>　　服务器数目(100M网络)10~20100大于100</p> 
<p>　　服务器网关负载均衡器自己的路由自己的路由</p> 
<p>　　效率一般高最高</p> 
<p>　　注：以上三种方法所能支持最大服务器数目的估计是假设调度器使用100M网卡，调度器的硬件配置与后端服务器的硬件配置相同，而且是对一般Web服务。使 用更高的硬件配置(如千兆网卡和更快的处理器)作为调度器，调度器所能调度的服务器数量会相应增加。当应用不同时，服务器的数目也会相应地改变。所以，以上数据估计主要是为三种方法的伸缩性进行量化比较。</p> 
<h4>　　5、负载均衡调度算法</h4> 
<p>　　◆最少的连接方式(Least Connection)：传递新的连接给那些进行最少连接处理的服务器。当其中某个服务器发生第二到第7 层的故障，BIG-IP 就把其从服务器队列中拿出，不参加下一次的用户请求的分配, 直到其恢复正常。</p> 
<p>　　◆最快模式(Fastest)：传递连接给那些响应最快的服务器。当其中某个服务器发生第二到第7 层的故障，BIG-IP 就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。</p> 
<p>　　◆观察模式(Observed)：连接数目和响应时间以这两项的最佳平衡为依据为新的请求选择服务器。当其中某个服务器发生第二到第7 层的故障，BIG-IP就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。</p> 
<p>　　◆预测模式(Predictive)：BIG-IP利用收集到的服务器当前的性能指标，进行预测分析，选择一台服务器在下一个时间片内，其性能将达到最佳的服务器相应用户的请求。(被BIG-IP 进行检测)</p> 
<p>　　◆动态性能分配(Dynamic Ratio-APM):BIG-IP 收集到的应用程序和<a href="http://www.chinabyte.com/keyword/%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1/" rel="nofollow" title="应用服务">应用服务</a>器的各项性能参数，动态调整流量分配。</p> 
<p>　　◆动态服务器补充(Dynamic Server Act.):当主服务器群中因故障导致数量减少时，动态地将备份服务器补充至主服务器群。</p> 
<p>　　◆服务质量(QoS):按不同的优先级对数据流进行分配。</p> 
<p>　　◆服务类型(ToS): 按不同的服务类型(在Type of Field中标识)负载均衡对数据流进行分配。</p> 
<p>　　◆规则模式：针对不同的数据流设置导向规则，用户可自行</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dacfabcc155c061ed269dfbf74ad1e51/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">经典图像去噪算法概述</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dd6967a31e8f69ebe5c0432abbb490b8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Mysql解决中文乱码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>