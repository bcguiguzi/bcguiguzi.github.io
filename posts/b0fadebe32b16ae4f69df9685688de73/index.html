<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Iris搭建路由模块controller&#43;审计中间件 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Iris搭建路由模块controller&#43;审计中间件" />
<meta property="og:description" content="Iris搭建路由模块controller&#43;审计中间件 封装NewControllerRoute方法：iris_demo/route/route.go封住NewSignRoute方法，添加自定义中间件：iris_demo/util/route_util.go自定义中间件：iris_demo/middleware/audittrail_middleware.go、iris_demo/middleware/signature_middleware.go定义通用返回值：iris_demo/response/response.go封装baseController，通用controller方法：iris_demo/controller/base_controller.go定义业务controller：iris_demo/controller/user_controller.gomain方法中初始化controllers：initControllers 完整代码：
https://github.com/ziyifast/ziyifast-code_instruction/tree/main/iris_demo
项目整体结构：
1 定义route/route.go：NewControllerRoute iris_demo/route/route.go
package route import ( &#34;github.com/kataras/iris/v12/context&#34; ) var ControllerList = make([]*ControllerRoute, 0) type ControllerRoute struct { RouteName string ControllerObj interface{} ServiceSlice []interface{} MiddlewareSlice []context.Handler DoneHandleSlice []context.Handler } func NewControllerRoute(routeName string, controller interface{}, middlewares []context.Handler, doneHandle []context.Handler) { route := &amp;ControllerRoute{ RouteName: routeName, ControllerObj: controller, MiddlewareSlice: middlewares, DoneHandleSlice: doneHandle, } ControllerList = append(ControllerList, route) } 2 定义util/route_util.go：NewSignRoute 定义签名路由：iris_demo/util/route_util.go
package util import ( &#34;github.com/kataras/iris/v12/context&#34; &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/b0fadebe32b16ae4f69df9685688de73/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-07T07:53:12+08:00" />
<meta property="article:modified_time" content="2024-03-07T07:53:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Iris搭建路由模块controller&#43;审计中间件</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Iriscontroller_0"></a>Iris搭建路由模块controller+审计中间件</h2> 
<blockquote> 
 <ol><li>封装NewControllerRoute方法：iris_demo/route/route.go</li><li>封住NewSignRoute方法，添加自定义中间件：iris_demo/util/route_util.go</li><li>自定义中间件：iris_demo/middleware/audittrail_middleware.go、iris_demo/middleware/signature_middleware.go</li><li>定义通用返回值：iris_demo/response/response.go</li><li>封装baseController，通用controller方法：iris_demo/controller/base_controller.go</li><li>定义业务controller：iris_demo/controller/user_controller.go</li><li>main方法中初始化controllers：initControllers</li></ol> 
</blockquote> 
<p>完整代码：<br> https://github.com/ziyifast/ziyifast-code_instruction/tree/main/iris_demo</p> 
<p>项目整体结构：<br> <img src="https://images2.imgbox.com/ae/a9/M1M1TcSn_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="1_routeroutegoNewControllerRoute_15"></a>1 定义route/route.go：NewControllerRoute</h3> 
<blockquote> 
 <p>iris_demo/route/route.go</p> 
</blockquote> 
<pre><code class="prism language-go"><span class="token keyword">package</span> route

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/kataras/iris/v12/context"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> ControllerList <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>ControllerRoute<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> ControllerRoute <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	RouteName       <span class="token builtin">string</span>
	ControllerObj   <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	ServiceSlice    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	MiddlewareSlice <span class="token punctuation">[</span><span class="token punctuation">]</span>context<span class="token punctuation">.</span>Handler
	DoneHandleSlice <span class="token punctuation">[</span><span class="token punctuation">]</span>context<span class="token punctuation">.</span>Handler
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewControllerRoute</span><span class="token punctuation">(</span>routeName <span class="token builtin">string</span><span class="token punctuation">,</span> controller <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> middlewares <span class="token punctuation">[</span><span class="token punctuation">]</span>context<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> doneHandle <span class="token punctuation">[</span><span class="token punctuation">]</span>context<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	route <span class="token operator">:=</span> <span class="token operator">&amp;</span>ControllerRoute<span class="token punctuation">{<!-- --></span>
		RouteName<span class="token punctuation">:</span>       routeName<span class="token punctuation">,</span>
		ControllerObj<span class="token punctuation">:</span>   controller<span class="token punctuation">,</span>
		MiddlewareSlice<span class="token punctuation">:</span> middlewares<span class="token punctuation">,</span>
		DoneHandleSlice<span class="token punctuation">:</span> doneHandle<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	ControllerList <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ControllerList<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2_utilroute_utilgoNewSignRoute_45"></a>2 定义util/route_util.go：NewSignRoute</h3> 
<blockquote> 
 <p>定义签名路由：iris_demo/util/route_util.go</p> 
</blockquote> 
<pre><code class="prism language-go"><span class="token keyword">package</span> util

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/kataras/iris/v12/context"</span>
	<span class="token string">"myTest/demo_home/blom_filter/middleware"</span>
	<span class="token string">"myTest/demo_home/blom_filter/route"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">NewSignRoute</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> routeName <span class="token builtin">string</span><span class="token punctuation">,</span> controllerVar <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> extraHandler <span class="token operator">...</span>context<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	middleWares <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>context<span class="token punctuation">.</span>Handler<span class="token punctuation">{<!-- --></span>middleware<span class="token punctuation">.</span>SignatureMiddleware<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>extraHandler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		middleWares <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>middleWares<span class="token punctuation">,</span> extraHandler<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	doneHandler <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>context<span class="token punctuation">.</span>Handler<span class="token punctuation">{<!-- --></span>middleware<span class="token punctuation">.</span>AuditTrailMiddleware<span class="token punctuation">}</span>
	route<span class="token punctuation">.</span><span class="token function">NewControllerRoute</span><span class="token punctuation">(</span>prefix<span class="token operator">+</span>routeName<span class="token punctuation">,</span> controllerVar<span class="token punctuation">,</span> middleWares<span class="token punctuation">,</span> doneHandler<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_middleware_66"></a>3 定义中间件middleware：用于验签、审计等</h3> 
<blockquote> 
 <p>自定义中间件：i</p> 
 <ul><li>ris_demo/middleware/audittrail_middleware.go</li><li>iris_demo/middleware/signature_middleware.go</li></ul> 
</blockquote> 
<p>ris_demo/middleware/audittrail_middleware.go：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> middleware

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/kataras/iris/v12"</span>
	<span class="token string">"github.com/ziyifast/log"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">AuditTrailMiddleware</span><span class="token punctuation">(</span>ctx iris<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"audit trail ...."</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>iris_demo/middleware/signature_middleware.go：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> middleware

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/kataras/iris/v12"</span>
	<span class="token string">"github.com/ziyifast/log"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">SignatureMiddleware</span><span class="token punctuation">(</span>ctx iris<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"SignatureMiddleware...do some signature check"</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="4_responsego_101"></a>4 定义通用返回值：response.go</h3> 
<blockquote> 
 <p>iris_demo/response/response.go</p> 
</blockquote> 
<pre><code class="prism language-go"><span class="token keyword">package</span> response

<span class="token keyword">type</span> Code <span class="token builtin">string</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	ReturnCodeError   Code <span class="token operator">=</span> <span class="token string">"0"</span>
	ReturnCodeSuccess Code <span class="token operator">=</span> <span class="token string">"1"</span>
	SuccessMsg             <span class="token operator">=</span> <span class="token string">"success"</span>
	SuccessStatus          <span class="token operator">=</span> <span class="token string">"success"</span>
	FailedStatus           <span class="token operator">=</span> <span class="token string">"failed"</span>

	ContentTypeJson <span class="token operator">=</span> <span class="token string">"application/json"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> JsonResponse <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Code    Code        <span class="token string">`json:"code"`</span>
	Msg     <span class="token builtin">string</span>      <span class="token string">`json:"msg"`</span>
	Content <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token string">`json:"data"`</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="5_baseControllercontroller_126"></a>5 封装baseController，通用controller方法</h3> 
<blockquote> 
 <p>封装baseController，通用controller方法：iris_demo/controller/base_controller.go</p> 
</blockquote> 
<pre><code class="prism language-go"><span class="token keyword">package</span> controller

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"encoding/json"</span>
	<span class="token string">"github.com/kataras/iris/v12"</span>
	<span class="token string">"github.com/kataras/iris/v12/mvc"</span>
	<span class="token string">"github.com/ziyifast/log"</span>
	<span class="token string">"myTest/demo_home/iris_demo/response"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"strconv"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> BaseController <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Ctx iris<span class="token punctuation">.</span>Context
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">Param</span><span class="token punctuation">(</span>paraName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Params</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>paraName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">ParamInt64Default</span><span class="token punctuation">(</span>paramName <span class="token builtin">string</span><span class="token punctuation">,</span> defaultValue <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Params</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetInt64Default</span><span class="token punctuation">(</span>paramName<span class="token punctuation">,</span> defaultValue<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">ParamInt64</span><span class="token punctuation">(</span>paramName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Params</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetInt64</span><span class="token punctuation">(</span>paramName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">ParamInt32Default</span><span class="token punctuation">(</span>paramName <span class="token builtin">string</span><span class="token punctuation">,</span> defaultValue <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token builtin">int32</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Params</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetInt32Default</span><span class="token punctuation">(</span>paramName<span class="token punctuation">,</span> defaultValue<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">ParamInt32</span><span class="token punctuation">(</span>paramName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int32</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Params</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetInt32</span><span class="token punctuation">(</span>paramName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">ParamIntDefault</span><span class="token punctuation">(</span>paramName <span class="token builtin">string</span><span class="token punctuation">,</span> defaultValue <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Params</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetIntDefault</span><span class="token punctuation">(</span>paramName<span class="token punctuation">,</span> defaultValue<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">ParamInt</span><span class="token punctuation">(</span>paramName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Params</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span>paramName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">ReadParamJson</span><span class="token punctuation">(</span>paramName <span class="token builtin">string</span><span class="token punctuation">,</span> result <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	paramJson <span class="token operator">:=</span> c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span>paramName<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>paramJson<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unmarshal request param[%s] fail, param body [%v] error [%v]"</span><span class="token punctuation">,</span> paramName<span class="token punctuation">,</span> paramJson<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">GetIntFormValue</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> defaultValue <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span>
	value <span class="token operator">:=</span> c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> defaultValue
	<span class="token punctuation">}</span>
	atoi<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> defaultValue
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> atoi
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">Message</span><span class="token punctuation">(</span>responseCode response<span class="token punctuation">.</span>Code<span class="token punctuation">,</span> msg <span class="token builtin">string</span><span class="token punctuation">,</span> content <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Result <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">commonResp</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> responseCode<span class="token punctuation">,</span> content<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">Ok</span><span class="token punctuation">(</span>content <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Result <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">commonResp</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>SuccessMsg<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> response<span class="token punctuation">.</span>ReturnCodeSuccess<span class="token punctuation">,</span> content<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">OkWithMsg</span><span class="token punctuation">(</span>str <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Result <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">commonResp</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>SuccessMsg<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> response<span class="token punctuation">.</span>ReturnCodeSuccess<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">Failed</span><span class="token punctuation">(</span>errMsg <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Result <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">commonResp</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> response<span class="token punctuation">.</span>ReturnCodeError<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">Forbidden</span><span class="token punctuation">(</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Result <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">commonResp</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">,</span> response<span class="token punctuation">.</span>ReturnCodeError<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">BadRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Result <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">commonResp</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> response<span class="token punctuation">.</span>ReturnCodeError<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">BadRequestWithMsg</span><span class="token punctuation">(</span>errMsg <span class="token builtin">string</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Result <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">commonResp</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> response<span class="token punctuation">.</span>ReturnCodeError<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">SystemInternalError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Result <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">commonResp</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> response<span class="token punctuation">.</span>ReturnCodeError<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">Unauthorized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Result <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">commonResp</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> response<span class="token punctuation">.</span>ReturnCodeError<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">SystemInternalErrorWithMsg</span><span class="token punctuation">(</span>errMsg <span class="token builtin">string</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Result <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">commonResp</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> response<span class="token punctuation">.</span>ReturnCodeError<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">NotFoundError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Result <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">commonResp</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">,</span> response<span class="token punctuation">.</span>ReturnCodeError<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BaseController<span class="token punctuation">)</span> <span class="token function">TooManyRequestError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Result <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">commonResp</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusTooManyRequests<span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusTooManyRequests<span class="token punctuation">,</span> response<span class="token punctuation">.</span>ReturnCodeError<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">commonResp</span><span class="token punctuation">(</span>errMsg <span class="token builtin">string</span><span class="token punctuation">,</span> httpCode <span class="token builtin">int</span><span class="token punctuation">,</span> returnCode response<span class="token punctuation">.</span>Code<span class="token punctuation">,</span> content <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Response <span class="token punctuation">{<!-- --></span>
	payload <span class="token operator">:=</span> <span class="token operator">&amp;</span>response<span class="token punctuation">.</span>JsonResponse<span class="token punctuation">{<!-- --></span>
		Code<span class="token punctuation">:</span>    returnCode<span class="token punctuation">,</span>
		Msg<span class="token punctuation">:</span>     errMsg<span class="token punctuation">,</span>
		Content<span class="token punctuation">:</span> content<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	contentDetail<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"marshal json response error %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> mvc<span class="token punctuation">.</span>Response<span class="token punctuation">{<!-- --></span>
		Code<span class="token punctuation">:</span>        httpCode<span class="token punctuation">,</span>
		Content<span class="token punctuation">:</span>     contentDetail<span class="token punctuation">,</span>
		ContentType<span class="token punctuation">:</span> response<span class="token punctuation">.</span>ContentTypeJson<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="6_ControllerUserController_257"></a>6 定义业务Controller：UserController等</h3> 
<blockquote> 
 <p>定义业务controller：iris_demo/controller/user_controller.go</p> 
</blockquote> 
<pre><code class="prism language-go"><span class="token keyword">package</span> controller

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/kataras/iris/v12/mvc"</span>
	<span class="token string">"github.com/ziyifast/log"</span>
	<span class="token string">"net/http"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> UserController <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	BaseController
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>UserController<span class="token punctuation">)</span> <span class="token function">BeforeActivation</span><span class="token punctuation">(</span>b mvc<span class="token punctuation">.</span>BeforeActivation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	b<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">"/smoke"</span><span class="token punctuation">,</span> <span class="token string">"Smoke"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>UserController<span class="token punctuation">)</span> <span class="token function">Smoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>Result <span class="token punctuation">{<!-- --></span>
	log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"user controller"</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">Ok</span><span class="token punctuation">(</span><span class="token string">"smoke"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="7_irisinitControllers_283"></a>7 启动iris：initControllers</h3> 
<blockquote> 
 <p>iris_demo/main.go</p> 
</blockquote> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/aobco/log"</span>
	<span class="token string">"github.com/kataras/iris/v12"</span>
	<span class="token string">"github.com/kataras/iris/v12/mvc"</span>
	<span class="token string">"github.com/kataras/iris/v12/sessions"</span>
	<span class="token string">"myTest/demo_home/iris_demo/controller"</span>
	<span class="token string">"myTest/demo_home/iris_demo/route"</span>
	<span class="token string">"myTest/demo_home/iris_demo/util"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	signaturePrefix <span class="token operator">=</span> <span class="token string">"/yi/anon/"</span>
	SessionMgr      <span class="token operator">*</span>sessions<span class="token punctuation">.</span>Sessions
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">InitControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	app <span class="token operator">:=</span> iris<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">initMvcHandle</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
	app<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">":8899"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">initSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	sessionCfg <span class="token operator">:=</span> sessions<span class="token punctuation">.</span>Config<span class="token punctuation">{<!-- --></span>
		Cookie<span class="token punctuation">:</span>  <span class="token string">"test"</span><span class="token punctuation">,</span>
		Expires<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	SessionMgr <span class="token operator">=</span> sessions<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>sessionCfg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">initMvcHandle</span><span class="token punctuation">(</span>app <span class="token operator">*</span>iris<span class="token punctuation">.</span>Application<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">initSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> route<span class="token punctuation">.</span>ControllerList <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">"routeName:%s middleware:%v  doneHandler:%v"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>RouteName<span class="token punctuation">,</span> v<span class="token punctuation">.</span>MiddlewareSlice<span class="token punctuation">,</span> v<span class="token punctuation">.</span>DoneHandleSlice<span class="token punctuation">)</span>
		myMvc <span class="token operator">:=</span> mvc<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">Party</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>RouteName<span class="token punctuation">)</span><span class="token punctuation">)</span>
		myMvc<span class="token punctuation">.</span>Router<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>MiddlewareSlice<span class="token operator">...</span><span class="token punctuation">)</span>
		myMvc<span class="token punctuation">.</span>Router<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>DoneHandleSlice<span class="token operator">...</span><span class="token punctuation">)</span>
		myMvc<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>SessionMgr<span class="token punctuation">.</span>Start<span class="token punctuation">)</span>
		myMvc<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>ControllerObj<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">InitControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	util<span class="token punctuation">.</span><span class="token function">NewSignRoute</span><span class="token punctuation">(</span>signaturePrefix<span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token function">new</span><span class="token punctuation">(</span>controller<span class="token punctuation">.</span>UserController<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_334"></a>效果</h3> 
<p>启动程序，浏览器访问：http://localhost:8899/yi/sign/user/smoke</p> 
<ul><li>根据我们注册的路由来拼接：prefix+routeName+path<br> <img src="https://images2.imgbox.com/b4/a1/PeZnLHPJ_o.png" alt="在这里插入图片描述"></li></ul> 
<blockquote> 
 <p>可以看到是：验签 - 业务逻辑 - 审计追踪</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/10/0e/OfoEuGCX_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5eb1d88e513ee05ae0c8c6c60bfe1a60/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【数据结构】图解二叉搜索树的新增、搜索、删除</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2b97539af024b91efd30ada704cc5321/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">论文翻译 - Visual Adversarial Examples Jailbreak Large Language Models</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>