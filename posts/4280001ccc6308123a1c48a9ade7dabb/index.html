<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>在Ubuntu下使用QEMU搭建arm开发环境（六）配置网络 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="在Ubuntu下使用QEMU搭建arm开发环境（六）配置网络" />
<meta property="og:description" content="背景 为了 实现 uboot 中连接上 QEMU-host 的网络。
非常奇怪，本人的 系统中 存在/dev/net/tun驱动，但是 lsmod | grep tun 却没有任何结果，所以实际上，这篇文章本人仅仅停留在理论基础之上。
概念 QEMU中的网络，包含两部分的内容：
客户机使用的虚拟网络设备和上述虚拟设备通信的网络后端，这些后端负责把虚拟设备的数据包发到宿主机的网络中 要创建一个网络后端，可以指定如下选项：
# TYPE为后端类型：user、tap、bridge、socket、vde等 # id为一个标识符，将虚拟网络设备和网络后端关联在一起 # 如果客户机有多个虚拟网络设备，则每一个都需要自己的网络后端 -netdev TYPE,id=NAME,... QEMU 两种上网方式(不同的网络后端)：
user mode network :
这种方式实现虚拟机上网很简单，类似vmware里的nat，qemu启动时加入-user-net参数，虚拟机里使用dhcp方式，即可与互联网通信，但是这种方式虚拟机与主机的通信不方便。
tap/tun network :
这种方式要比user mode复杂一些，但是设置好后 虚拟机&lt;--&gt;互联网 虚拟机&lt;--&gt;主机 通信都很容易
这种方式设置上类似vmware的host-only,qemu使用tun/tap设备在主机上增加一块虚拟网络设备(tun0),然后就可以象真实网卡一样配置它。
QEME支持多种网络后端： USER后端 如果没有指定网络选项，QEMU默认会模拟单张Intel e1000 PCI网卡，该网卡基于user后端（SLIRP）连接到宿主机：
# 不指定网络 qemu # 等价配置。自0.12开始废弃的配置方式 -net nic相当于-device DEVNAME；-net TYPE相当于-netdev TYPE qemu -hda disk.img -net nic -net user # 等价配置。-netdev指定网络后端，-device指定虚拟网络设备，后者通过netdev字段引用后端的ID qemu -netdev user,id=network0 -device e1000,netdev=network0 在客户机看来：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/4280001ccc6308123a1c48a9ade7dabb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-26T10:30:32+08:00" />
<meta property="article:modified_time" content="2020-08-26T10:30:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">在Ubuntu下使用QEMU搭建arm开发环境（六）配置网络</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3 id="scroller-0">背景</h3> 
<p>为了 实现 uboot 中连接上 QEMU-host 的网络。</p> 
<blockquote> 
 <p>非常奇怪，本人的 系统中 存在<code>/dev/net/tun</code>驱动，但是 <code>lsmod | grep tun</code> 却没有任何结果，所以实际上，这篇文章本人仅仅停留在理论基础之上。</p> 
</blockquote> 
<h3 id="scroller-1">概念</h3> 
<p>QEMU中的网络，包含两部分的内容：</p> 
<ol><li>客户机使用的虚拟网络设备</li><li>和上述虚拟设备通信的网络后端，这些后端负责把虚拟设备的数据包发到宿主机的网络中</li></ol> 
<p>要创建一个网络后端，可以指定如下选项：</p> 
<pre><code># TYPE为后端类型：user、tap、bridge、socket、vde等
# id为一个标识符，将虚拟网络设备和网络后端关联在一起
# 如果客户机有多个虚拟网络设备，则每一个都需要自己的网络后端
-netdev TYPE,id=NAME,...
</code></pre> 
<p><strong>QEMU 两种上网方式(不同的网络后端)：</strong></p> 
<p><strong>user mode network :</strong></p> 
<p>这种方式实现虚拟机上网很简单，类似vmware里的nat，qemu启动时加入-user-net参数，虚拟机里使用dhcp方式，即可与互联网通信，但是这种方式虚拟机与主机的通信不方便。</p> 
<p><strong>tap/tun network :</strong></p> 
<p>这种方式要比user mode复杂一些，但是设置好后 虚拟机&lt;--&gt;互联网 虚拟机&lt;--&gt;主机 通信都很容易</p> 
<p>这种方式设置上类似vmware的host-only,qemu使用tun/tap设备在主机上增加一块虚拟网络设备(tun0),然后就可以象真实网卡一样配置它。</p> 
<h3 id="scroller-2">QEME支持多种网络后端：</h3> 
<h4 id="scroller-3"><strong>USER后端</strong></h4> 
<p>如果没有指定网络选项，QEMU默认会模拟单张Intel e1000 PCI网卡，该网卡基于user后端（SLIRP）连接到宿主机：</p> 
<pre><code># 不指定网络
qemu 
# 等价配置。自0.12开始废弃的配置方式 -net nic相当于-device DEVNAME；-net TYPE相当于-netdev TYPE
qemu -hda disk.img -net nic -net user
# 等价配置。-netdev指定网络后端，-device指定虚拟网络设备，后者通过netdev字段引用后端的ID
qemu -netdev user,id=network0 -device e1000,netdev=network0
</code></pre> 
<p>在客户机看来：</p> 
<ol><li>本身的IP地址被分配为 10.0.2.15+</li><li>分配IP的虚拟DHCP为 10.0.2.2</li><li>虚拟DNS服务器为 10.0.2.3</li><li>虚拟Samba服务器为 10.0.2.4，客户机可以通过此服务器访问宿主机的文件系统</li></ol> 
<p>用户模式网络可以很方便的访问网络资源。但是它有很多限制：</p> 
<ol><li>默认的，它运作方式类似于防火墙，且不允许任何入站流量。这个限制可以通过端口重定向解决</li><li>仅仅支持TCP、UDP协议，对于ICMP则不支持</li><li>性能比较差</li></ol> 
<p>为了支持入站请求，你可以使用端口重定向（Redirecting ports）——把针对宿主机某个端口的请求转发给客户机的某个端口。映射后，客户机可以对外提供SSH、HTTP等服务：</p> 
<pre><code># 把宿主机的7080端口重定向到客户机的80端口；把宿主机的7022端口重定向到客户机的22端口
qemu-system-x86_64 -redir tcp:7080::80 -redir tcp:7022::22 -hda ~/Vmware/KVM/centos7-base.img -m 512 
 
# 从宿主机SSH到客户机
ssh root@127.0.0.1 -p 7022
</code></pre> 
<p>你可以不使用默认的10.0.2网段：</p> 
<pre><code>Shell
1
-netdev user,id=network0,net=192.168.5.0/24,dhcpstart=192.168.5.9 
</code></pre> 
<p><strong>客户机OS配置</strong></p> 
<p>依据客户机安装的操作系统，可能需要进行一些配置，才能正常使用网络。以CentOS 7 Minimal + 用户模式网络为例，需要修改以下配置文件：</p> 
<pre><code>NETWORKING=yes
# 如果不使用IPV6
NETWORKING_IPV6=no
</code></pre> 
<p># 如果不使用IPV6</p> 
<p>IPV6INIT=no</p> 
<p># 开机启动此网卡，默认不启动</p> 
<p>ONBOOT=yes</p> 
<p>网关、DNS不需要设置。修改完这些配置文件后，重启客户机网络： /etc/init.d/network restart 。然后执行yum update 测试一下能否正常联网（不要使用ping测试）</p> 
<h4 id="scroller-4"><strong>TAP后端</strong></h4> 
<p>QEMU的TAP后端利用宿主机的TAP设备，为客户机提供完整的<a href="https://blog.gmem.cc/network-faq#bridging" rel="nofollow">桥接网络</a>支持，如果外部需要使用标准端口连接到客户机， 或者多个客户机需要相互通信，可以使用该方式。 TAP后端还具有以下优势：</p> 
<ol><li>非常好的性能</li><li>可以配置以支持各种网络拓扑</li></ol> 
<p>但是，你需要在宿主机上进行网络拓扑的配置，而且各种系统的配置不同。</p> 
<p><strong>主机安装工具包：</strong></p> 
<pre><code>sudo apt-get install uml-utilities bridge-utils -y
</code></pre> 
<p>使用TAP后端前，你需要确认你的宿主机的内核支持TAP网络接口： <code>/dev/net/tun</code> 文件存在则说明支持。</p> 
<pre><code>$ ls /dev/net
tun
</code></pre> 
<p> </p> 
<p>如果没有这样的文件，可以尝试手工创建：</p> 
<pre><code>sudo mkdir /dev/net
sudo mknod /dev/net/tun c 10 200
sudo /sbin/modprobe tun

</code></pre> 
<p><strong>修改网络配置文件（重启生效）</strong></p> 
<pre><code>sudo vi /etc/network/interface
</code></pre> 
<p>添加以下内容，注意 根据自己的实际情况 修改 bridge_ports</p> 
<pre><code>auto br0
iface br0 inet dhcp

bridge_ports ens33
</code></pre> 
<p><strong>添加qemu有关系统脚本</strong></p> 
<p>在<strong>/etc/qemu-ifup</strong>文件中添加以下内容</p> 
<pre><code>#!/bin/sh

echo sudo tunctl -u $(id -un) -t $1

sudo tunctl -u $(id -un) -t $1
echo sudo ifconfig $1 0.0.0.0 promisc up
sudo ifconfig $1 0.0.0.0 promisc up
echo sudo brctl addif br0 $1
sudo brctl addif br0 $1
echo brctl show
brctl show

sudo ifconfig br0 192.168.31.241
# 根据自己的实际情况修改 IP地址，注意：uboot 中的 CONFIG_SERVERIP(serverip) 要跟这里一样
</code></pre> 
<p>在<strong>/etc/qemu-ifdown</strong>文件中添加以下内容</p> 
<pre><code>#!/bin/sh

echo sudo brctl delif br0 $1
sudo brctl delif br0 $1
echo sudo tunctl -d $1
sudo tunctl -d $1
echo brctl show
brctl show
</code></pre> 
<p>给上面的脚本添加执行权限</p> 
<pre><code>sudo chmod +x /etc/qemu*
</code></pre> 
<p><strong>重启网络使生效</strong></p> 
<pre id="copy_target_13"><code>sudo service networking restart
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/49d623dc2608c46ec384adcf6dc20a74/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C#中 GridView控件的使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3110dab780291a7188bc0187c7644134/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">微服务和DDD到底有什么关系？微服务如何拆分？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>