<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于aarch64分析kernel源码 五：idle进程(0号进程) - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于aarch64分析kernel源码 五：idle进程(0号进程)" />
<meta property="og:description" content="一、参考 linux — 0号进程，1号进程，2号进程 - 流水灯 - 博客园 (cnblogs.com)
Linux0号进程，1号进程，2号进程_0号进程和1号进程-CSDN博客
二、idle进程的创建流程 start_kernel --&gt; arch_call_rest_init --&gt; rest_init --&gt; cpu_startup_entry --&gt; while(1) { do_idle(); } start_kernel 函数在完成系统初始化后会进入死循环调用 do_idle 函数，相当于 start_kernel 函数完成初始化后会退化成 idle 进程。
三、idle 进程控制块 idle 进程控制块是 init_task，init_task 是一个全局静态变量，定义在 init/init_task.c 文件中。
/* * Set up the first task table, touch at your own risk!. Base=0, * limit=0x1fffff (=2MB) */ struct task_struct init_task #ifdef CONFIG_ARCH_TASK_STRUCT_ON_STACK __init_task_data #endif __aligned(L1_CACHE_BYTES) = { #ifdef CONFIG_THREAD_INFO_IN_TASK ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/6858858c87bf89884d88b3d3ac9e4264/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-09T16:36:36+08:00" />
<meta property="article:modified_time" content="2023-10-09T16:36:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于aarch64分析kernel源码 五：idle进程(0号进程)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_1"></a>一、参考</h2> 
<p><a href="https://www.cnblogs.com/god-of-death/p/17092485.html" rel="nofollow">linux — 0号进程，1号进程，2号进程 - 流水灯 - 博客园 (cnblogs.com)</a></p> 
<p><a href="https://dragonkingzhu.blog.csdn.net/article/details/104363832" rel="nofollow">Linux0号进程，1号进程，2号进程_0号进程和1号进程-CSDN博客</a></p> 
<h2><a id="idle_7"></a>二、idle进程的创建流程</h2> 
<pre><code class="prism language-log">start_kernel 
	--&gt; arch_call_rest_init 
		--&gt; rest_init
			--&gt; cpu_startup_entry 
				--&gt; while(1) { do_idle(); }
</code></pre> 
<p><code>start_kernel</code> 函数在完成系统初始化后会进入死循环调用 <code>do_idle</code> 函数，相当于 <code>start_kernel</code> 函数完成初始化后会退化成 <code>idle</code> 进程。</p> 
<h2><a id="idle__19"></a>三、idle 进程控制块</h2> 
<p><code>idle</code> 进程控制块是 <code>init_task</code>，<code>init_task</code> 是一个全局静态变量，定义在 <code>init/init_task.c</code> 文件中。</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * Set up the first task table, touch at your own risk!. Base=0,
 * limit=0x1fffff (=2MB)
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> init_task
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_ARCH_TASK_STRUCT_ON_STACK</span></span>
	__init_task_data
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token function">__aligned</span><span class="token punctuation">(</span>L1_CACHE_BYTES<span class="token punctuation">)</span>
<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_THREAD_INFO_IN_TASK</span></span>
	<span class="token punctuation">.</span>thread_info	<span class="token operator">=</span> <span class="token function">INIT_THREAD_INFO</span><span class="token punctuation">(</span>init_task<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>stack_refcount	<span class="token operator">=</span> <span class="token function">REFCOUNT_INIT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token punctuation">.</span>__state	<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>stack		<span class="token operator">=</span> init_stack<span class="token punctuation">,</span>		<span class="token comment">// init_stack 值定义在链接脚本中（init_stack是内核栈的静态的定义）</span>
	<span class="token punctuation">.</span>usage		<span class="token operator">=</span> <span class="token function">REFCOUNT_INIT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>flags		<span class="token operator">=</span> PF_KTHREAD<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>prio		<span class="token operator">=</span> MAX_PRIO <span class="token operator">-</span> <span class="token number">20</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>static_prio	<span class="token operator">=</span> MAX_PRIO <span class="token operator">-</span> <span class="token number">20</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>normal_prio	<span class="token operator">=</span> MAX_PRIO <span class="token operator">-</span> <span class="token number">20</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>policy		<span class="token operator">=</span> SCHED_NORMAL<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>cpus_ptr	<span class="token operator">=</span> <span class="token operator">&amp;</span>init_task<span class="token punctuation">.</span>cpus_mask<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>user_cpus_ptr	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>cpus_mask	<span class="token operator">=</span> CPU_MASK_ALL<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>nr_cpus_allowed<span class="token operator">=</span> NR_CPUS<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>mm		<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>active_mm	<span class="token operator">=</span> <span class="token operator">&amp;</span>init_mm<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>restart_block	<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>fn <span class="token operator">=</span> do_no_restart_syscall<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>se		<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>group_node 	<span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>se<span class="token punctuation">.</span>group_node<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>rt		<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>run_list	<span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>rt<span class="token punctuation">.</span>run_list<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>time_slice	<span class="token operator">=</span> RR_TIMESLICE<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>tasks		<span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>tasks<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_SMP</span></span>
	<span class="token punctuation">.</span>pushable_tasks	<span class="token operator">=</span> <span class="token function">PLIST_NODE_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>pushable_tasks<span class="token punctuation">,</span> MAX_PRIO<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_CGROUP_SCHED</span></span>
	<span class="token punctuation">.</span>sched_task_group <span class="token operator">=</span> <span class="token operator">&amp;</span>root_task_group<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token punctuation">.</span>ptraced	<span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>ptraced<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ptrace_entry	<span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>ptrace_entry<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>real_parent	<span class="token operator">=</span> <span class="token operator">&amp;</span>init_task<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>parent		<span class="token operator">=</span> <span class="token operator">&amp;</span>init_task<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>children	<span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>sibling	<span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>group_leader	<span class="token operator">=</span> <span class="token operator">&amp;</span>init_task<span class="token punctuation">,</span>
	<span class="token function">RCU_POINTER_INITIALIZER</span><span class="token punctuation">(</span>real_cred<span class="token punctuation">,</span> <span class="token operator">&amp;</span>init_cred<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token function">RCU_POINTER_INITIALIZER</span><span class="token punctuation">(</span>cred<span class="token punctuation">,</span> <span class="token operator">&amp;</span>init_cred<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>comm		<span class="token operator">=</span> INIT_TASK_COMM<span class="token punctuation">,</span>	<span class="token comment">// #define INIT_TASK_COMM "swapper" - 0号进程的名称</span>
	<span class="token punctuation">.</span>thread		<span class="token operator">=</span> INIT_THREAD<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>fs		<span class="token operator">=</span> <span class="token operator">&amp;</span>init_fs<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>files		<span class="token operator">=</span> <span class="token operator">&amp;</span>init_files<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_IO_URING</span></span>
	<span class="token punctuation">.</span>io_uring	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token punctuation">.</span>signal		<span class="token operator">=</span> <span class="token operator">&amp;</span>init_signals<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>sighand	<span class="token operator">=</span> <span class="token operator">&amp;</span>init_sighand<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>nsproxy	<span class="token operator">=</span> <span class="token operator">&amp;</span>init_nsproxy<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>pending	<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>list <span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>signal <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>blocked	<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>alloc_lock	<span class="token operator">=</span> <span class="token function">__SPIN_LOCK_UNLOCKED</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>alloc_lock<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>journal_info	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
	<span class="token function">INIT_CPU_TIMERS</span><span class="token punctuation">(</span>init_task<span class="token punctuation">)</span>
	<span class="token punctuation">.</span>pi_lock	<span class="token operator">=</span> <span class="token function">__RAW_SPIN_LOCK_UNLOCKED</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>pi_lock<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>timer_slack_ns <span class="token operator">=</span> <span class="token number">50000</span><span class="token punctuation">,</span> <span class="token comment">/* 50 usec default slack */</span>
	<span class="token punctuation">.</span>thread_pid	<span class="token operator">=</span> <span class="token operator">&amp;</span>init_struct_pid<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>thread_group	<span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>thread_group<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>thread_node	<span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_signals<span class="token punctuation">.</span>thread_head<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_AUDIT</span></span>
	<span class="token punctuation">.</span>loginuid	<span class="token operator">=</span> INVALID_UID<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>sessionid	<span class="token operator">=</span> AUDIT_SID_UNSET<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PERF_EVENTS</span></span>
	<span class="token punctuation">.</span>perf_event_mutex <span class="token operator">=</span> <span class="token function">__MUTEX_INITIALIZER</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>perf_event_mutex<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>perf_event_list <span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>perf_event_list<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PREEMPT_RCU</span></span>
	<span class="token punctuation">.</span>rcu_read_lock_nesting <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>rcu_read_unlock_special<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>rcu_node_entry <span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>rcu_node_entry<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>rcu_blocked_node <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_TASKS_RCU</span></span>
	<span class="token punctuation">.</span>rcu_tasks_holdout <span class="token operator">=</span> false<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>rcu_tasks_holdout_list <span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>rcu_tasks_holdout_list<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>rcu_tasks_idle_cpu <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_TASKS_TRACE_RCU</span></span>
	<span class="token punctuation">.</span>trc_reader_nesting <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>trc_reader_special<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>trc_holdout_list <span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>trc_holdout_list<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>trc_blkd_node <span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>trc_blkd_node<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_CPUSETS</span></span>
	<span class="token punctuation">.</span>mems_allowed_seq <span class="token operator">=</span> <span class="token function">SEQCNT_SPINLOCK_ZERO</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>mems_allowed_seq<span class="token punctuation">,</span>
						 <span class="token operator">&amp;</span>init_task<span class="token punctuation">.</span>alloc_lock<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_RT_MUTEXES</span></span>
	<span class="token punctuation">.</span>pi_waiters	<span class="token operator">=</span> RB_ROOT_CACHED<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>pi_top_task	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token function">INIT_PREV_CPUTIME</span><span class="token punctuation">(</span>init_task<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_VIRT_CPU_ACCOUNTING_GEN</span></span>
	<span class="token punctuation">.</span>vtime<span class="token punctuation">.</span>seqcount	<span class="token operator">=</span> <span class="token function">SEQCNT_ZERO</span><span class="token punctuation">(</span>init_task<span class="token punctuation">.</span>vtime_seqcount<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>vtime<span class="token punctuation">.</span>starttime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>vtime<span class="token punctuation">.</span>state	<span class="token operator">=</span> VTIME_SYS<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_NUMA_BALANCING</span></span>
	<span class="token punctuation">.</span>numa_preferred_nid <span class="token operator">=</span> NUMA_NO_NODE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>numa_group	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>numa_faults	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_KASAN_GENERIC<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_KASAN_SW_TAGS<span class="token punctuation">)</span></span></span>
	<span class="token punctuation">.</span>kasan_depth	<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_KCSAN</span></span>
	<span class="token punctuation">.</span>kcsan_ctx <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>scoped_accesses	<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>LIST_POISON1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_TRACE_IRQFLAGS</span></span>
	<span class="token punctuation">.</span>softirqs_enabled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_LOCKDEP</span></span>
	<span class="token punctuation">.</span>lockdep_depth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">/* no locks held yet */</span>
	<span class="token punctuation">.</span>curr_chain_key <span class="token operator">=</span> INITIAL_CHAIN_KEY<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>lockdep_recursion <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_FUNCTION_GRAPH_TRACER</span></span>
	<span class="token punctuation">.</span>ret_stack		<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>tracing_graph_pause	<span class="token operator">=</span> <span class="token function">ATOMIC_INIT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_TRACING<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_PREEMPTION<span class="token punctuation">)</span></span></span>
	<span class="token punctuation">.</span>trace_recursion <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_LIVEPATCH</span></span>
	<span class="token punctuation">.</span>patch_state	<span class="token operator">=</span> KLP_UNDEFINED<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_SECURITY</span></span>
	<span class="token punctuation">.</span>security	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_SECCOMP_FILTER</span></span>
	<span class="token punctuation">.</span>seccomp	<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>filter_count <span class="token operator">=</span> <span class="token function">ATOMIC_INIT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>init_task<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_181"></a>四、源码分析</h2> 
<h3><a id="10PCB_183"></a>1、设置0号进程PCB</h3> 
<pre><code class="prism language-asm">/* 代码位置: /arch/arm64/kernel/head.S */
	/*
	 * Initialize CPU registers with task-specific and cpu-specific context.
	 *
	 * Create a final frame record at task_pt_regs(current)-&gt;stackframe, so
	 * that the unwinder can identify the final frame record of any task by
	 * its location in the task stack. We reserve the entire pt_regs space
	 * for consistency with user tasks and kthreads.
	 */
	.macro	init_cpu_task tsk, tmp1, tmp2
	msr	sp_el0, \tsk

	ldr	\tmp1, [\tsk, #TSK_STACK]
	add	sp, \tmp1, #THREAD_SIZE
	sub	sp, sp, #PT_REGS_SIZE

	stp	xzr, xzr, [sp, #S_STACKFRAME]
	add	x29, sp, #S_STACKFRAME

	scs_load_current

	adr_l	\tmp1, __per_cpu_offset
	ldr	w\tmp2, [\tsk, #TSK_TI_CPU]
	ldr	\tmp1, [\tmp1, \tmp2, lsl #3]
	set_this_cpu_offset \tmp1
	.endm

/*
 * The following fragment of code is executed with the MMU enabled.
 *
 *   x0 = __pa(KERNEL_START)
 */
SYM_FUNC_START_LOCAL(__primary_switched)
	adr_l	x4, init_task
	init_cpu_task x4, x5, x6
	……
	bl	start_kernel
	ASM_BUG()
SYM_FUNC_END(__primary_switched)
</code></pre> 
<p>在 <code>__primary_switched</code> 函数中将 <code>init_task</code> 值保存到 <code>sp_el0</code> 寄存器中，然后调用 <code>start_kernel</code> 函数。至此成功将 <code>init_task</code> 设置成 <code>0</code> 号进程的进程控制块，并成功运行 <code>0</code> 号进程。</p> 
<h3><a id="2_229"></a>2、设置栈底魔数</h3> 
<p>置栈底魔数，用于栈溢出检查。</p> 
<pre><code class="prism language-c"><span class="token comment">/* 函数定义在 /init/main.c 中 */</span>

asmlinkage __visible <span class="token keyword">void</span> __init __no_sanitize_address __noreturn <span class="token function">start_kernel</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> <span class="token operator">*</span>command_line<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>after_dashes<span class="token punctuation">;</span>

	<span class="token function">set_task_stack_end_magic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>init_task<span class="token punctuation">)</span><span class="token punctuation">;</span>
	……
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_246"></a>3、其他配置</h3> 
<p>详细配置见 <code>Linux</code> 源码。</p> 
<h2><a id="PCB_250"></a>五、获取当前PCB</h2> 
<pre><code class="prism language-c"><span class="token comment">/* 函数定义在 arch/arm64/include/asm/current.h 文件中 */</span>

<span class="token comment">/*
 * We don't use read_sysreg() as we want the compiler to cache the value where
 * possible.
 */</span>
<span class="token keyword">static</span> __always_inline <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token function">get_current</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> sp_el0<span class="token punctuation">;</span>

	<span class="token keyword">asm</span> <span class="token punctuation">(</span><span class="token string">"mrs %0, sp_el0"</span> <span class="token operator">:</span> <span class="token string">"=r"</span> <span class="token punctuation">(</span>sp_el0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span>sp_el0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">current</span> <span class="token expression"><span class="token function">get_current</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/39aa985a88d846529627b8eecd34f6cb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">跟着李沐学AI（动手学深度学习 PyTorch版）学习笔记——03安装（环境配置d2l、pytorch）（python3.7版本&#43;Windows&#43;各种问题解决措施）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b0c7d06c0cfd81b6865ce2e48b4aad6b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于科来网络分析系统 技术交流版</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>