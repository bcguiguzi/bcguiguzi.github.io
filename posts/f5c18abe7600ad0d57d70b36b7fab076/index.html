<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>VC&#43;&#43;检测可执行程序DLL、EXE等是32位还是64位 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="VC&#43;&#43;检测可执行程序DLL、EXE等是32位还是64位" />
<meta property="og:description" content="1.首先介绍PE结构
Windows系统下的可执行文件，是基于Microsoft设计的一种新的文件结构，此结构被称之为PE结构。PE的意思是Portable Executable(可移植的执行体)，所有Win32执行体都是用PE文件格式，其中包括SYS、DLL、EXE、COM、OCX等。（不管是学习逆向、破解还是安全，了解PE文件格式都是非常必要的。）
PE文件的第一个部分是IMAGE_DOS_HEADER，大小为64B，这里面有两个重要的数据成员。第一个为e_magic，这个必须为MZ，即0x5A4D。当然，0x5A4D这是典型的小端格式（Little Endian）；另一个重要的数据成员是最后一个成员e_lfanew，这个成员的值为IMAGE_NT_HEADERS的偏移。在IMAGE_DOS_HEADER和IMAGE_NT_HEADERS之间一个DOS Stub，这段程序用于在DOS环境中显示一个字符串，“This program cannot be run in DOS mode”，现在DOS早已灭绝，这段数据由编译器生成，可以用0填充或者删除（删除的话要移动很多数据）。
IMAGE_DOS_HEADER的定义如下：
IMAGE_DOS_HEADER STRUCT {//（注：最左边是文件头的偏移量。） &#43;0h WORD e_magic	//Magic DOS signature MZ(4Dh 5Ah)	DOS可执行文件标记 &#43;2h WORD e_cblp	//Bytes on last page of file &#43;4h WORD e_cp	//Pages in file &#43;6h WORD e_crlc	//Relocations &#43;8h WORD e_cparhdr	//Size of header in paragraphs &#43;0ah WORD e_minalloc //Minimun extra paragraphs needs &#43;0ch WORD e_maxalloc	//Maximun extra paragraphs needs &#43;0eh WORD e_ss	//intial(relative)SS value	DOS代码的初始化堆栈SS &#43;10h WORD e_sp	//intial SP value	DOS代码的初始化堆栈指针SP &#43;12h WORD e_csum	//Checksum &#43;14h WORD e_ip	//intial IP value	DOS代码的初始化指令入口[指针IP] &#43;16h WORD e_cs	//intial(relative)CS value	DOS代码的初始堆栈入口 &#43;18h WORD e_lfarlc	//File Address of relocation table &#43;1ah WORD e_ovno	//Overlay number &#43;1ch WORD e_res[4]	//Reserved words &#43;24h WORD e_oemid	//OEM identifier(for e_oeminfo) &#43;26h WORD e_oeminfo	//OEM information;e_oemid specific &#43;29h WORD e_res2[10]	// Reserved words &#43;3ch DWORD e_lfanew //Offset to start of PE header	指向PE文件头 } IMAGE_DOS_HEADER ENDS 用C32Asm查看一个EXE程序的结构：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/f5c18abe7600ad0d57d70b36b7fab076/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-03-29T16:51:52+08:00" />
<meta property="article:modified_time" content="2013-03-29T16:51:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">VC&#43;&#43;检测可执行程序DLL、EXE等是32位还是64位</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"> </p> 
<pre><code class="language-cpp"></code></pre> 
<p style="margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"></p> 
<p style="margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"><code class="language-cpp">1.首先介绍PE结构</code></p> 
<p style="margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"><code class="language-cpp">    Windows系统下的可执行文件，是基于Microsoft设计的一种新的文件结构，此结构被称之为PE结构。PE的意思是Portable Executable(可移植的执行体)，所有Win32执行体都是用PE文件格式，其中包括SYS、DLL、EXE、COM、OCX等。（不管是学习逆向、破解还是安全，了解PE文件格式都是非常必要的。）</code></p> 
<p style="margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"><code class="language-cpp">    PE文件的第一个部分是IMAGE_DOS_HEADER，大小为64B，这里面有两个重要的数据成员。第一个为e_magic，这个必须为MZ，即0x5A4D。当然，0x5A4D这是典型的小端格式（Little Endian）；另一个重要的数据成员是最后一个成员e_lfanew，这个成员的值为IMAGE_NT_HEADERS的偏移。在IMAGE_DOS_HEADER和IMAGE_NT_HEADERS之间一个DOS Stub，这段程序用于在DOS环境中显示一个字符串，“This program cannot be run in DOS mode”，现在DOS早已灭绝，这段数据由编译器生成，可以用0填充或者删除（删除的话要移动很多数据）。</code></p> 
<p style="margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"><code class="language-cpp">IMAGE_DOS_HEADER的定义如下：</code></p> 
<p style="margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"></p> 
<pre name="code" class="cpp" style="font-size: 14px; line-height: 20px; "><code class="language-cpp">IMAGE_DOS_HEADER STRUCT
{//（注：最左边是文件头的偏移量。）
+0h  WORD e_magic		//Magic DOS signature MZ(4Dh 5Ah)		      DOS可执行文件标记
+2h  WORD e_cblp		//Bytes on last page of file  
+4h  WORD e_cp			//Pages in file
+6h  WORD e_crlc		//Relocations
+8h  WORD e_cparhdr	        //Size of header in paragraphs
+0ah WORD e_minalloc            //Minimun extra paragraphs needs
+0ch WORD e_maxalloc		//Maximun extra paragraphs needs
+0eh WORD e_ss			//intial(relative)SS value				DOS代码的初始化堆栈SS
+10h WORD e_sp			//intial SP value					DOS代码的初始化堆栈指针SP
+12h WORD e_csum		//Checksum
+14h WORD e_ip			//intial IP value					DOS代码的初始化指令入口[指针IP]
+16h WORD e_cs			//intial(relative)CS value				DOS代码的初始堆栈入口
+18h WORD e_lfarlc		//File Address of relocation table
+1ah WORD e_ovno		//Overlay number
+1ch WORD e_res[4]		//Reserved words
+24h WORD e_oemid		//OEM identifier(for e_oeminfo)
+26h WORD e_oeminfo	        //OEM information;e_oemid specific 
+29h WORD e_res2[10]		// Reserved words
+3ch DWORD e_lfanew             //Offset to start of PE header			         指向PE文件头
} IMAGE_DOS_HEADER ENDS</code></pre> 
<br> 
<p></p> 
<p style="margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"> <span style="color:rgb(85,85,85); font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px">用C32Asm查看一个EXE程序的结构：</span><br> </p> 
<p style="margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"> <span style="color:rgb(85,85,85); font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"><img src="https://images2.imgbox.com/1c/37/4jT8blfr_o.jpg" alt=""><br> </span></p> 
<p style="margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"> <span style="color:rgb(85,85,85); font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"><br> </span></p> 
<p style="margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"> <span style="color:rgb(85,85,85); font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px">     PE Header 是PE相关结构NT映像头（IMAGE_NT_HEADER）的简称，里边包含着许多PE装载器用到的重要字段。IMAGE_NT_HEADERS 结构的定义：<br> IMAGE_NT_HEADERS STRUCT <br> { <br> +0h  DWORD  Signature;<br> +4h  IMAGE_FILE_HEADER  FileHeader;<br> +18h IMAGE_OPTIONAL_HEADER32  OptionalHeader;<br> } IMAGE_NT_HEADERS ENDS<br> Signature 字段：在一个有效的 PE 文件里，Signature 字段被设置为00004550h,ASCII 码字符是“PE00”。标志这 PE 文件头的开始。“PE00” 字符串是 PE 文件头的开始，DOS 头部的 e_lfanew 字段正是指向这里，如上图所示。<br> <br> IMAGE_FILE_HEADER 结构定义：<br> typedef struct _IMAGE_FILE_HEADER <br> {<!-- --><br> +04h<span style="white-space:pre"> </span>  WORD  <span style="white-space:pre"> </span> Machine;                   </span><span style="font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"><span style="color:#ff0000"> // 运行平台</span><br> <span style="color:#555555">+06h  WORD  </span><span style="color:rgb(85,85,85); white-space:pre"></span><span style="color:#555555">NumberOfSections;</span><span style="color:rgb(85,85,85); white-space:pre"></span><span style="color:#555555">// 文件的区块数目</span><br> <span style="color:#555555">+08h  DWORD </span><span style="color:rgb(85,85,85); white-space:pre"></span><span style="color:#555555">TimeDateStamp;</span><span style="color:rgb(85,85,85); white-space:pre"></span><span style="color:#555555">// 文件创建日期和时间</span><br> <span style="color:#555555">+0Ch  DWORD </span><span style="color:rgb(85,85,85); white-space:pre"></span><span style="color:#555555">PointerToSymbolTable;// 指向符号表(主要用于调试)</span><br> <span style="color:#555555">+10h  DWORD </span><span style="color:rgb(85,85,85); white-space:pre"></span><span style="color:#555555">NumberOfSymbols;</span><span style="color:rgb(85,85,85); white-space:pre"></span><span style="color:#555555">// 符号表中符号个数(同上)</span><br> <span style="color:#555555">+14h  WORD  </span><span style="color:rgb(85,85,85); white-space:pre"></span><span style="color:#555555">SizeOfOptionalHeader;</span><span style="color:rgb(85,85,85); white-space:pre"></span><span style="color:#555555">// IMAGE_OPTIONAL_HEADER32 结构大小</span><br> <span style="color:#555555">+16h  WORD  </span><span style="color:rgb(85,85,85); white-space:pre"></span><span style="color:#555555">Characteristics;</span><span style="color:rgb(85,85,85); white-space:pre"></span><span style="color:#555555">        // 文件属性</span><br> <span style="color:#555555">} IMAGE_FILE_HEADER,  *PIMAGE_FILE_HEADER;</span><br> <span style="color:#555555">（1）Machine：可执行文件的目标CPU类型。</span><br> <span style="color:#ff0000">IMAGE_FILE_MACHINE_I386 0x014c  x86<br> IMAGE_FILE_MACHINE_IA64 0x0200  Intel Itanium<br> IMAGE_FILE_MACHINE_AMD64 0x8664 x64</span><br> <span style="color:#555555">（2）NumberOfSection: 区块的数目。（注：区块表是紧跟在 IMAGE_NT_HEADERS 后边的）</span><br> <span style="color:#555555">（3）TimeDataStamp: 表明文件是何时被创建的。</span><br> <span style="color:#555555">这个值是自1970年1月1日以来用格林威治时间（GMT）计算的秒数，这个值是比文件系统（FILESYSTEM）的日期时间更加精确的指示器。</span><br> <span style="color:#555555">提示：VC的话可以用_ctime 函数或者 gmtime 函数。</span><br> <span style="color:#555555">（4）PointerToSymbolTable: COFF 符号表的文件偏移位置，现在基本没用了。</span><br> <span style="color:#555555">（5）NumberOfSymbols: 如果有COFF 符号表，它代表其中的符号数目，COFF符号是一个大小固定的结构，如果想找到COFF 符号表的结束位置，则需要这个变量。</span><br> <span style="color:#555555">（6）SizeOfOptionalHeader: 紧跟着IMAGE_FILE_HEADER 后边的数据结构（IMAGE_OPTIONAL_HEADER）的大小。(对于32位PE文件，这个值通常是00E0h；对于64位PE32+文件，这个值是00F0h )。</span><br> <span style="color:#555555">（7）Characteristics: 文件属性，有选择的通过几个值可以运算得到。( 这些标志的有效值是定义于 winnt.h 内的 IMAGE_FILE_** 的值，具体含义见下表。普通的EXE文件这个字段的值一般是 0100h，DLL文件这个字段的值一般是 210Eh。)</span><br> </span></p> 
<p style="margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px">     2.然后我们通过读取PE文件的运行平台字段判断是32位还是64位：(这里我写的VC++6.0是Win32控制台应用程序)</p> 
<p style="margin-top:0px; margin-bottom:10px; padding-top:0px; padding-bottom:0px; font-family:Verdana,'BitStream vera Sans',Tahoma,Helvetica,sans-serif; font-size:14px; line-height:20px"> </p> 
<pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
int CrnGetImageFileMachine(char* lpFileName);
int main()
{
    int n = CrnGetImageFileMachine("C:\\Users\\Administrator\\Desktop\\VS版 ADT控制卡程序 x64\\adt8948.dll");//需要检测的可执行文件
    if (n == 0x014C) printf("x86\n");//32位
    else if (n == 0x0200) printf("IA64\n");//纯64位
    else if (n == 0x8664) printf("x64\n");//64位
    else printf("未知\n");

    return 1;
}
int CrnGetImageFileMachine(char* lpFileName)
{
    IMAGE_DOS_HEADER idh;
    FILE *f = fopen(lpFileName, "rb");
    fread(&amp;idh, sizeof(idh), 1, f);</code></pre> 
<pre><code class="language-cpp">    IMAGE_FILE_HEADER ifh;
    fseek(f, idh.e_lfanew + 4, SEEK_SET);
    fread(&amp;ifh, sizeof(ifh), 1, f);
    fclose(f);
 
    return ifh.Machine;
}
</code></pre>编译运行查看结果。 
<br> 
<br> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0b61510d194d328f1a04bb14e157d17a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">电脑开机后进入不了桌面</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c7edf3109dcac16cd3311de53a259ee7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">.Net单元测试之NMock</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>