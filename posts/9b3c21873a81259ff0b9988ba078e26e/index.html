<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Delphi中ClientDataSet的用法小结 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Delphi中ClientDataSet的用法小结" />
<meta property="og:description" content="Delphi中ClientDataSet的用法小结
TClientDataSet控件继承自TDataSet，其数据存储文件格式扩展名为 .cds，是基于文件型数据存储和操作的控件。该控件封装了对数据进行操作处理的接口和功能，而本身并不依赖上述几种数据库驱动程序，基本上能满足单机&#34;瘦&#34;数据库应用程序的需要。
一、TClientDataSet的基本属性和方法介绍
1、FieldDefs: 字段定义列表属性
开发者可通过单击属性编辑器中该属性编辑按钮，或在该控件上单击右键选择弹出菜单中的&#34;Fields Editor&#34;菜单进行字段编辑。设置完此属性后，实际上就相当于定义了表的结构；如果想装入已有的数据表的结构和数据，可通过单击右键选择弹出菜单中的&#34;Assign Local Data&#34;菜单，从弹出对话框中选取当前窗体中已与数据库连接好的数据集控件名称即可（当前窗体中必须已放置好要套用的数据集控件并打开激活）。
使用注意：
对于自定义的字段名表，该属性编辑完后，该控件仍然无法打开。必须右键单击该控件，选择弹出菜单中的&#34;Create DataSet&#34;菜单，让该控件以上述编辑的字段列表为依据，创建数据集后，才能够被激活打开和使用。否则，会出现类似&#34;ClientDataSet1: Missing data provider or data packet.&#34;的错误（包括在运行期，运行期可调用该控件的CreateDataSet方法，从而动态定义字段和表）。
2、FileName属性
说明：数据存储文件的名称。因该控件是基于文件型的数据操作控件，因此，必须指定所操作的数据文件名称（默认扩展名称.cds），从而打开和激活该控件，进而进行数据编辑。
例1：利用此属性打开指定的.cds文件
Delphi代码
var Path:string; begin Path:=ExtractFilePath(Application.ExeName);//取得可执行文件路径 CDataSet1.FileName:=Path&#43;&#39;test.cds&#39;; CDataSet1.Open; end; 3、CreateDataSet方法
说明：该方法以FieldDefs中的字段名表为结构建立数据集，常用来进行动态定义表。
例2：动态创建一具有姓名和年龄两个字段的数据集。
Delphi代码
//创建字段名表 CDataSet.FieldDefs.Clear; withCDataSet.FieldDefs.AddFieldDefdo begin Name:=&#39;Name&#39;; Size:=10; DataType:=ftString; end; withCDataSet.FieldDefs.AddFieldDefdo begin Name:=&#39;Age&#39;; DataType:=ftInteger; end; //动态创建数据集 CDataSet.CreateDataSet; //激活和打开该数据集 CDataSet.Open; 4、Open方法
说明： 打开和激活数据集控件，从而进行数据编辑。a. 如果指定了FileName属性，则直接用Open方法即可打开和激活该控件,见例1。b. 如果未指定FileName属性，可使用例2方法动态创建和打开数据集,进而操作数据。
5、LoadFromFile和SaveToFile
说明：从文件中装入表结构和数据以及存储数据到文件。该方法类似于Word中的打开新文件和另存为的功能。
例3:将数据集的数据存储到指定文件中
Delphi代码
CDataSet.SaveToFile(&#39;C:WindowsHUTest.cds&#39;); 6、First（到首），Prior(向前)，Next(向后)，Last(到尾)，Edit(编辑)，CanCel(取消编辑)，Post(保存)，Insert(插入记录)，Append(添加记录)，Delete（删除），Refresh（数据刷新）等数据集常用方法。
说明：当指定了FileName属性时，其Post方法可将数据存入指定的文件中,类似其SaveToFile方法；如果未指定存储文件名，则Post方法只将数据存储在RAM中。其它方法，同一般数据集控件使用方法，略。
7、Filter, Filtered: 过滤筛选属性
说明:用于筛选指定条件的记录,用法同一般数据集控件,略。
例4：在已经激活打开的数据集中筛选性别为男性的记录
Delphi代码" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/9b3c21873a81259ff0b9988ba078e26e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-27T15:40:59+08:00" />
<meta property="article:modified_time" content="2023-09-27T15:40:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Delphi中ClientDataSet的用法小结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>Delphi中ClientDataSet的用法小结</p> 
<p>TClientDataSet控件继承自TDataSet，其数据存储文件格式扩展名为 .cds，是基于文件型数据存储和操作的控件。该控件封装了对数据进行操作处理的接口和功能，而本身并不依赖上述几种数据库驱动程序，基本上能满足单机"瘦"数据库应用程序的需要。</p> 
<p>一、TClientDataSet的基本属性和方法介绍</p> 
<p>1、FieldDefs: 字段定义列表属性</p> 
<p>开发者可通过单击属性编辑器中该属性编辑按钮，或在该控件上单击右键选择弹出菜单中的"Fields Editor"菜单进行字段编辑。设置完此属性后，实际上就相当于定义了表的结构；如果想装入已有的数据表的结构和数据，可通过单击右键选择弹出菜单中的"Assign Local Data"菜单，从弹出对话框中选取当前窗体中已与数据库连接好的数据集控件名称即可（当前窗体中必须已放置好要套用的数据集控件并打开激活）。</p> 
<p><em>使用注意：</em></p> 
<p>对于自定义的字段名表，该属性编辑完后，该控件仍然无法打开。必须右键单击该控件，选择弹出菜单中的"Create DataSet"菜单，让该控件以上述编辑的字段列表为依据，创建数据集后，才能够被激活打开和使用。否则，会出现类似"ClientDataSet1: Missing data provider or data packet."的错误（包括在运行期，运行期可调用该控件的CreateDataSet方法，从而动态定义字段和表）。</p> 
<p>2、FileName属性</p> 
<p>说明：数据存储文件的名称。因该控件是基于文件型的数据操作控件，因此，必须指定所操作的数据文件名称（默认扩展名称.cds），从而打开和激活该控件，进而进行数据编辑。</p> 
<p>例1：利用此属性打开指定的.cds文件</p> 
<p>Delphi代码</p> 
<pre><code class="language-Delphi">var
Path:string;
begin
　Path:=ExtractFilePath(Application.ExeName);//取得可执行文件路径
　CDataSet1.FileName:=Path+'test.cds';
　CDataSet1.Open;
end;</code></pre> 
<p>3、CreateDataSet方法</p> 
<p>说明：该方法以FieldDefs中的字段名表为结构建立数据集，常用来进行动态定义表。</p> 
<p>例2：动态创建一具有姓名和年龄两个字段的数据集。</p> 
<p>Delphi代码</p> 
<pre><code class="language-Delphi">//创建字段名表
CDataSet.FieldDefs.Clear;
withCDataSet.FieldDefs.AddFieldDefdo
begin
　Name:='Name';
　Size:=10;
　DataType:=ftString;
end;
withCDataSet.FieldDefs.AddFieldDefdo
begin
　Name:='Age';
　DataType:=ftInteger;
end;

//动态创建数据集
　CDataSet.CreateDataSet;
//激活和打开该数据集
　CDataSet.Open;</code></pre> 
<p>4、Open方法</p> 
<p>说明： 打开和激活数据集控件，从而进行数据编辑。a. 如果指定了FileName属性，则直接用Open方法即可打开和激活该控件,见<strong>例1</strong>。b. 如果未指定FileName属性，可使用例2方法动态创建和打开数据集,进而操作数据。</p> 
<p>5、LoadFromFile和SaveToFile</p> 
<p>说明：从文件中装入表结构和数据以及存储数据到文件。该方法类似于Word中的打开<a href="http://wenwen.soso.com/z/Search.e?sp=S%E6%96%B0%E6%96%87&amp;ch=w.search.intlink" rel="nofollow" title="新文">新文</a>件和另存为的功能。</p> 
<p>例3:将数据集的数据存储到指定文件中</p> 
<p>Delphi代码</p> 
<pre><code class="language-Delphi">CDataSet.SaveToFile('C:WindowsHUTest.cds');</code></pre> 
<p>6、First（到首），Prior(向前)，Next(向后)，Last(到尾)，Edit(编辑)，CanCel(取消编辑)，Post(保存)，Insert(插入记录)，Append(添加记录)，Delete（删除），Refresh（数据刷新）等数据集常用方法。</p> 
<p></p> 
<p>说明：当指定了FileName属性时，其Post方法可将数据存入指定的文件中,类似其SaveToFile方法；如果未指定存储文件名，则Post方法只将数据存储在RAM中。其它方法，同一般数据集控件使用方法，略。</p> 
<p>7、Filter, Filtered: 过滤筛选属性</p> 
<p>说明:用于筛选指定条件的记录,用法同一般数据集控件,略。</p> 
<p>例4：在已经激活打开的数据集中筛选性别为男性的记录</p> 
<p>Delphi代码</p> 
<pre><code class="language-Delphi">CDataSet.Close;
CDataSet.Filter:='性别='''+'男'+'''';
CDataSet.Filtered:=True;
CDataSet.Open;</code></pre> 
<p>二、使用TClientDataSet控件的应用程序发布的注意事项：</p> 
<p>如前所述，使用TClientDataSet控件的程序发布时不需要任何数据库驱动程序，大大节省了安装文件的大小。但是，在发布程序时别忘了将Windows系统目录下midas.dll(257KB)与应用程序一起发布（运行必须），否则，程序仍然无<a href="http://wenwen.soso.com/z/Search.e?sp=S%E6%B3%95%E6%AD%A3&amp;ch=w.search.intlink" rel="nofollow" title="法正">法正</a>常运行。</p> 
<p>通过使用Delphi中TClientDataSet控件，既实现了应用程序可彻底脱离数据库驱动程序，也实现了常规数据集控件简单易用的特性，为编写"瘦"数据库应用程序提供了一种技术方法和手段。</p> 
<p></p> 
<p>三、TClientDataSet在三层结构中，TClientDataSet的地位是不可估量的，本文从以下几个方面阐述她的使用。</p> 
<p>1、动态索引</p> 
<p>Delphi代码</p> 
<pre><code class="language-Delphi">procedureTForm1.DBGrid1TitleClick(Column:TColumn);
begin
if(notcolumn.FieldisTblobfield)then//Tblobfield不能索引，二进制
ClientDataSet1.IndexFieldNames:=column.Field.FieldName;
end;</code></pre> 
<p>2、多层结构中主从表的实现</p> 
<p>设主表ClientDataSet1.packetrecord为-1，所有记录；</p> 
<p>设从表ClientDataSet1.packetrecord为0，当前记录。</p> 
<p>3、Taggregates使用</p> 
<p>（1）在字段编辑中add new field类型为aggregates<br> 后设置expression（表达试)<br> 设置active:=true即可<br> 使用dbedit的field为前者即可<br> （2）使用Aggergates属性add设计表达试<br> 调用</p> 
<p>Delphi代码</p> 
<pre><code class="language-Delphi">ShowMessage(FloatTostr(ClientDataSet1.Aggregates.Count));
ShowMessage(ClientDataSet1.Aggregates.Items[0].Value);</code></pre> 
<p>4、在单层数据库中不要BDE</p> 
<p>使用ClientDataSet代替table,使用ClientDataSet的loadfilename装入cds代替table的tablename的db或者dbf</p> 
<p>引用：</p> 
<p>原来的程序改造方法:<br> 加一个ClientDataSet，使用右键assign locate data<br> 后savetofile,再loadfromfile,后删除table<br> 将原连table的datasource设为ClientDataSet<br> 唯一注意的是：要将midas.dll拷到system或者当前目录</p> 
<p>5、三层结构的公文包的实现方法</p> 
<p>同时设定:filename(*.cds)2.remote server</p> 
<p>6、可以对data赋值（从另一个数据集取值)</p> 
<p>Delphi代码</p> 
<pre><code class="language-Delphi">ClientDataSet2.Data:=ClientDataSet1.Data;
ClientDataSet2.Open;</code></pre> 
<p>或者</p> 
<p>Delphi代码</p> 
<pre><code class="language-Delphi">ClientDataSet2.CloneCursor(ClientDataSet1,true);
ClientDataSet2.Open;</code></pre> 
<p>7、附加数据取得</p> 
<p>客户程序向应用服务器请求数据。如果TClientDataSet 的FetchOnDemand 属性设为True，客户程序会根据需要自动检索附加的数据包如BLOB字段的值或嵌套表的内容。否则，客户程序需要显式地调用GetNextPacket 才能获得这些附加的数据包。ClientDataSet的packetrecords设置一次取得的记录个数。</p> 
<p>8、ClientDataSet与服务器端query连接方法</p> 
<p>（1）sql内容为空</p> 
<p>Delphi代码</p> 
<pre><code class="language-Delphi">ClientDataSet1.Close;
ClientDataSet1.CommandText:=edit1.Text;//即sql内容
ClientDataSet1.Open;</code></pre> 
<p>对于没有应用服务器设置filter 如：country like 'A%'，filtered=true可实现sql功能。</p> 
<p>（2）有参数</p> 
<p>如服务端query的sql为</p> 
<pre><code class="language-sql">select * from animals
where name like :dd</code></pre> 
<p>则:客户端ClientDataSet</p> 
<p>Delphi代码</p> 
<pre><code class="language-Delphi">var
pm:Tparam;
begin
ClientDataSet1.Close;
ClientDataSet1.ProviderName:='DataSetProvider1';
pm:=Tparam.Create(nil);
pm.Name:='dd';
pm.DataType:=ftString;
ClientDataSet1.Params.Clear;
ClientDataSet1.Params.AddParam(pm);
ClientDataSet1.Params.ParamByName('dd').AsString:=edit1.Text;
ClientDataSet1.Open;
pm.Free;
end;</code></pre> 
<p>9、数据的更新管理</p> 
<p>（1）savepoint 保存目前为止数据状态，可以恢复到这个状态</p> 
<p>Delphi代码</p> 
<pre><code class="language-Delphi">var
pp:integer;
begin
pp:=ClientDataSet1.SavePoint;
ClientDataSet1.Edit;
ClientDataSet1.FieldByName('姓名').asstring:='古话';
ClientDataSet1.Post;
table1.Refresh;
end;</code></pre> 
<p>恢复点:ClientDataSet1.SavePoint:=pp;</p> 
<p>（2）Cancel,RevertRecord</p> 
<p>取消对当前记录的修改，只适合没有post的，如果post，调用RevertRecord 。</p> 
<p>（3）CancelUpdate</p> 
<p>取消对数据库所有的修改</p> 
<p>（4）UndoLastChange(boolean),changecount</p> 
<p>取消上一次的修改，可以实现连续撤消。参数为true:光标到恢复处；false:光标在当前位置不动。changecount返回修改记录的次数，一个记录修改多次，返回只一次，但UndoLastChange只撤消一次。</p> 
<p>10、可写的recno</p> 
<p>对于Ttable和Tquery的recno是只读的，而TClientDataSet的recno可读可写ClientDataSet1.recno:=5;是设第五个记录为当前记录。</p> 
<p>11、数据保存</p> 
<p>对于table使用post可更新数据，而ClientDataSet1的post只更新内存数据，要更新服务器数据要使ApplyUpdates（MaxErrors: Integer),他有一个参数，是允许发出错误的次数,-1表示无数次,使用simpleobjectbroker时常设为0，实现自动容错和负载平衡。</p> 
<p></p> 
<p>1.基本情况介绍; clientdataset内存表，他的data属性存放的是数据， delta 增量记录的是日志， 就相当于数据库的 savepoint保存点；每当clientdataset的数据有变化时（onbeforeedit, onafteredit），savepoint都会变化。如果我们想取消一段时间的操作，我们可以先记录下这个savepoint,然后修改，如果想取消，直接让这个savepoint = 以前的那个点即可。</p> 
<pre><code class="language-Delphi">try this

var
BaseLine:Integer;
begin
with ClientDataSet1 do
begin
BaseLine:=SavePoint;
Insert;
FieldByName('Name').AsString:= Edit1.Text;
FieldByName('Weight').AsInteger:= StrToInt(Edit2.Text);
if 提交 then
MergeChangeLog
else //取消
SavePoint:=BaseLine;
end;
end;</code></pre> 
<ol><li>clientdaset可以不连接数据库直接使用，如果设置了clientdataset的filename属性，那么在数据集打开或者关闭的时候，都会将数据集里的数据保存到对应的文件中，这个过程是会合并日志的。也就是说你编辑到什么状态，然后下次打开还是什么状态。</li></ol> 
<p>3.mergechangelog; 就是将 delta里面的操作日志跟 data合并，</p> 
<p>4.emptydataset，清空数据集。</p> 
<p>5.三层服务的构造方法，在客户端放上clientdataset, 然后放上socketconnect; webconnection是不是也可以？然后将clientdataset的remoteserver 指向 socketserver; clientdataset的dataprovider设置为服务器上的datasetprovider 服务器上放上dataprovider即可。provide里面有个onrequest命令，可以接受客户端发过来的命令。</p> 
<p>6.创建内存表：createdataset，创建数据集。</p> 
<pre><code class="language-Delphi">//明细表内存对象创建
with cdsDtl do
begin
with FieldDefs do
begin
Clear;
//数据库字段
Add('Num', ftString, 14, False);
Add('Cls', ftString, 10, False);
Add('Line', ftInteger, 0, False);
Add('GDCode', ftString, 20, False);
Add('sl', ftInteger, 0, False);
Add('GID', ftInteger, 0, False);
//ToDo 增加业务明细字段

//辅助字段
Add('GDName', ftString, 120, False);
Add('Note', ftString, 255, False);
Add('LSTINPRC', ftFloat, 0, False);
end;
IndexDefs.Add('','Line',[ixPrimary]);
CreateDataSet;
Append;
end;

procedure TForm1.FormCreate(Sender: TObject);
begin
self.ds1.FieldDefs.Add('Name',ftString,50);
self.ds1.FieldDefs.Add('Age',ftString,50);
self.ds1.CreateDataSet;
self.ds2.FieldDefs.Add('Name',ftString,50);
self.ds2.FieldDefs.Add('Age',ftString,50);
self.ds2.CreateDataSet;

self.ds1.AppendRecord(['100','100']);
self.ds1.AppendRecord(['100','100']);
self.ds1.AppendRecord(['100','100']);
self.ds1.AppendRecord(['100','100']);
self.ds1.AppendRecord(['100','100']);
self.ds1.AppendRecord(['100','100']);
self.ds2.Data:=self.ds1.Delta;
end;


procedure TForm1.btn1Click(Sender: TObject);
begin
self.ds1.AppendRecord(['1001','100']);//添加新纪录
self.ds2.Data:=self.ds1.Delta;
end;</code></pre> 
<p>李维的书，有空还是看看吧。</p> 
<p>提交数据的时候，记得applyupdates(-1,0.3)，分别是提交正常的，不管不正常的了，0出错，允许3个出错。</p> 
<p>如果我想要通过sql语句更新客户修改的数据，那么我们可以这样做</p> 
<pre><code class="language-Delphi">再放一个ClientDataSet2，用ClientDataSet2.Data=ClientDataSet1.Delta;
while not ClientDataSet2.Eof do
case ClientDataSet2.UpdateStatus of
usDeleted:
XXX</code></pre> 
<p>通过将原 clientdataset里面的日志复制到另一个数据集，然后遍历记录，看看修改过的日志。就可以找到修改过的数据了。</p> 
<p>Clientdataset在处理几千行数据还是很快的，要是处理上万行数据，是比较慢的。</p> 
<p>ClientDataSet1.IndexFieldNames:=’列1;列2’; 添加索引</p> 
<p>if ClientDataSet1.FindKey([这里填什么？,X]) then 查找字段。</p> 
<pre><code class="language-Delphi">if ClientDataSet1.State in [DsEdit, DSInsert] then ClientDataSet1.Post;
if ClientDataSet1.ChangeCount &gt; 0 then
begin
if ClientDataSet1.ApplyUpdates(0) = 0 then ClientDataSet1.MergeChangeLog;
end
else
abort;
end
else
exit;</code></pre> 
<p>changecount,可以看出数据集是否有改动。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1d2fa743f20b4561b4e6306f12a688ef/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【IDEA】idea恢复pom.xml文件显示灰色并带有删除线</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/16c8a799bc439d289a24cecd1dde15b0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Langchain里的“记忆力”，让AI只记住有用的事</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>