<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>以太网移植操作 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="以太网移植操作" />
<meta property="og:description" content="以太网：ST芯片内只有集成了MAC，并没有PHY，所以要外接一个LAN8720（DM9000）以太网芯片，之所以不集成到芯片内部是可能还是因为该芯片是模拟电路，如果添加进去会造成一定的功耗或IC的工艺不够
通信过程：MAC---》MII/RMII接口--》PHY
1.STM32F4以太网(Ethernet)MAC
1.1、MAC简介
STM32F407自带有10/100Mbit/s的以太网MAC内核，这个以太网MAC内核有 如下特性：
1、支持外部PHY接口实现10/100Mbit/s数据传输速率。
2、通过符合IEEE802.3的MII接口与外接快速以太网PHY进行通信
3、支持全双工和半双工操作
4、报头和帧起始数据(SFD)在发送路径中插入、在接收路径中删除
5、可逐帧控制CRC和pad自动生成。
6、可编程帧长度，支持高大16KB的巨型帧。
7、可编程帧间隔。
8、支持通过MDIO接口配置和管理PHY设备
STM32F407的ETH框图如下：
1.2、F407的MAC有3种接口：SMI、MII和RMII。
1.2.1、SMI站管理接口，程序中可以通过这个接口来访问PHY寄存器，SMI接口有两条线：数据线MDIO和时钟线MDC，该接口支持访问多达32个PHY。
MDC：周期性时钟，提供以最大频率 2.5 MHz 传输数据时的参考时序，在空闲状态下， SMI 管理接口将MDC 时钟信号驱动为低电平。
MDIO：数据输入/输出比特流，用于通过 MDC时钟信号向/从PHY 设备同步传输状态信息。
1.2.2、 MII介质独立接口：定义了 10Mbit/s 和100 Mbit/s 的数据传输速率下MAC 子层与PHY 之间的互连。
TX_CLK和RX_CLK为发送和接收连续时钟，当速率为10Mbit/s时为2.5MHZ，速率为100Mbit/s时为25MHZ。
要生成TX_CLK和RX_CLK时钟，必须向外部PHY提供25MHZ时钟，通常我们使用25M的晶振，也可以使用STM32F4xx的MCO引脚输出25MHZ的时钟。
1.2.3、RMII精简介质独立接口:规范降低了 10/100Mbit/s 下微控制器以太网外设与外部PHY 间的引脚数。根据 IEEE 802.3u 标准，MII 包括16 个数据和控制信号的引脚。RMII 规范将引脚数减少为 7 个（引脚数减少62.5%）。不过RMII接口的参考时钟必须是50MHZ！
RMII时钟源：通常使用50MHZ的时钟驱动PHY或使用嵌入式PLL生成50MHZ频率来驱动PHY。
2、LAN8720
2.1、LAN8720简介
LAN8720是低功耗的10/100M以太网PHY层芯片，I/O引脚电压符合IEEE802.3-2005标准。LAN8720支持通过RMII接口与以太网MAC层通信，内置10-BASE-T/100BASE-TX全双工传输模块，支持10Mbps和100Mbps。LAN8720可以通过自协商的方式与目的主机最佳的连接方式(速度和双工模式)。支持HP Auto-MDIX自动翻转功能，无需更换网线即可将连接更改为直连或交叉连接。
1、支持RMII接口以减少引脚数
2、支持全双工和半双工模式
3、可以使用25M晶振以降低成本
4、支持SMI串行管理接口
5、支持MAC接口
PHY地址设置
前面说了MAC可以通过SMI接口来读写PHY(LAN8720)的寄存器，SMI最多可以控制32个PHY芯片，通过不同的PHY芯片地址来对不同的PHY操作。LAN8720通过设置RXER/PHYAD0引脚来设置其PHY地址，默认情况下为0，其地址设置如下表所示。我们STM32F407开发板使用的是默认地址，也就是0X00。
RXER/PHYAD0引脚状态
PHY地址
上拉
0X01
下拉（默认）
0X00
nINT/REFCLKO配置
nINTSEL引脚(2号引脚)用于设置nINT/REFCLKO引脚(14号引脚)的功能。nINTSEL配置如下表所示。我们STM32F407开发板使用的是REF_CLK Out模式" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/e5a0d41d865016a87175667fbfc4c5c5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-27T10:37:03+08:00" />
<meta property="article:modified_time" content="2023-02-27T10:37:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">以太网移植操作</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>以太网：ST芯片内只有集成了MAC，并没有PHY，所以要外接一个LAN8720（DM9000）以太网芯片，之所以不集成到芯片内部是可能还是因为该芯片是模拟电路，如果添加进去会造成一定的功耗或IC的工艺不够</p> 
<p>通信过程：MAC---》MII/RMII接口--》PHY</p> 
<p><span style="background-color:#ffffff;color:#000000;">1.STM32F4以太网(</span><span style="color:#333333;">Ethernet</span><span style="background-color:#ffffff;color:#000000;">)MAC</span></p> 
<p>1.1、MAC简介</p> 
<p>STM32F407自带有10/100Mbit/s的以太网MAC内核，这个以太网MAC内核有 如下特性：</p> 
<p>1、支持外部PHY接口实现10/100Mbit/s数据传输速率。</p> 
<p>2、通过符合IEEE802.3的MII接口与外接快速以太网PHY进行通信</p> 
<p>3、支持全双工和半双工操作</p> 
<p>4、报头和帧起始数据(SFD)在发送路径中插入、在接收路径中删除</p> 
<p>5、可逐帧控制CRC和pad自动生成。</p> 
<p>6、可编程帧长度，支持高大16KB的巨型帧。</p> 
<p>7、可编程帧间隔。</p> 
<p>8、支持通过MDIO接口配置和管理PHY设备</p> 
<p></p> 
<p>STM32F407的ETH框图如下：</p> 
<p><img alt="" src="https://images2.imgbox.com/73/ee/gHhoyzSz_o.png"></p> 
<p>1.2、F407的MAC有3种接口：SMI、MII和RMII。</p> 
<p>1.2.1、SMI站管理接口，程序中可以通过这个接口来访问PHY寄存器，SMI接口有两条线：数据线MDIO和时钟线MDC，该接口支持访问多达32个PHY。</p> 
<p>MDC：周期性时钟，提供以最大频率 2.5 MHz 传输数据时的参考时序，在空闲状态下， SMI 管理接口将MDC 时钟信号驱动为低电平。</p> 
<p>MDIO：数据输入/输出比特流，用于通过 MDC时钟信号向/从PHY 设备同步传输状态信息。</p> 
<p><img alt="" src="https://images2.imgbox.com/d1/e1/pfNL7moi_o.png"></p> 
<p>1.2.2、 MII介质独立接口：定义了 10Mbit/s 和100 Mbit/s 的数据传输速率下MAC 子层与PHY 之间的互连。</p> 
<p><img alt="" src="https://images2.imgbox.com/71/d6/j60bOl5Y_o.png"></p> 
<p>TX_CLK和RX_CLK为发送和接收连续时钟，当速率为10Mbit/s时为2.5MHZ，速率为100Mbit/s时为25MHZ。</p> 
<p>要生成TX_CLK和RX_CLK时钟，必须向外部PHY提供25MHZ时钟，通常我们使用25M的晶振，也可以使用STM32F4xx的MCO引脚输出25MHZ的时钟。</p> 
<p><img alt="" src="https://images2.imgbox.com/aa/94/WRfJLG0m_o.png"></p> 
<p> 1.2.3、RMII精简介质独立接口:规范降低了 10/100Mbit/s 下微控制器以太网外设与外部PHY 间的引脚数。根据 IEEE 802.3u 标准，MII 包括16 个数据和控制信号的引脚。RMII 规范将引脚数减少为 7 个（引脚数减少62.5%）。<span style="color:#ff0000;">不过</span><span style="color:#ff0000;">RMII</span><span style="color:#ff0000;">接口的参考时钟必须是</span><span style="color:#ff0000;">50MHZ</span><span style="color:#ff0000;">！</span></p> 
<p><span style="color:#ff0000;"><img alt="" src="https://images2.imgbox.com/9f/3d/NXy7dP4v_o.png"></span></p> 
<p>RMII时钟源：通常使用50MHZ的时钟驱动PHY或使用嵌入式PLL生成50MHZ频率来驱动PHY。</p> 
<p><img alt="" src="https://images2.imgbox.com/e5/46/rklpHOVy_o.png"></p> 
<p></p> 
<p>2、LAN8720</p> 
<p>2.1、LAN8720简介</p> 
<p>LAN8720是低功耗的10/100M以太网PHY层芯片，I/O引脚电压符合IEEE802.3-2005标准。LAN8720支持通过RMII接口与以太网MAC层通信，内置10-BASE-T/100BASE-TX全双工传输模块，支持10Mbps和100Mbps。LAN8720可以通过自协商的方式与目的主机最佳的连接方式(速度和双工模式)。支持HP Auto-MDIX自动翻转功能，无需更换网线即可将连接更改为直连或交叉连接。</p> 
<p>1、支持RMII接口以减少引脚数</p> 
<p>2、支持全双工和半双工模式</p> 
<p>3、可以使用25M晶振以降低成本</p> 
<p>4、支持SMI串行管理接口</p> 
<p>5、支持MAC接口</p> 
<p></p> 
<p>PHY地址设置</p> 
<p>前面说了MAC可以通过SMI接口来读写PHY(LAN8720)的寄存器，SMI最多可以控制32个PHY芯片，通过不同的PHY芯片地址来对不同的PHY操作。LAN8720通过设置RXER/PHYAD0引脚来设置其PHY地址，默认情况下为0，其地址设置如下表所示。我们STM32F407开发板使用的是默认地址，也就是0X00。</p> 
<p></p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td style="background-color:#189e8e;"> <p><strong>RXER/PHYAD0引脚状态</strong></p> </td><td style="background-color:#189e8e;"> <p><strong>PHY地址</strong></p> </td></tr><tr><td style="background-color:#ccdfdb;"> <p>上拉</p> </td><td style="background-color:#ccdfdb;"> <p>0X01</p> </td></tr><tr><td style="background-color:#e7f0ee;"> <p>下拉（默认）</p> </td><td style="background-color:#e7f0ee;"> <p>0X00</p> </td></tr></tbody></table> 
<p> nINT/REFCLKO配置</p> 
<p>nINTSEL引脚(2号引脚)用于设置nINT/REFCLKO引脚(14号引脚)的功能。nINTSEL配置如下表所示。我们STM32F407开发板使用的是REF_CLK Out模式</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td style="background-color:#189e8e;"> <p><strong>nINTSEL引脚值</strong></p> </td><td style="background-color:#189e8e;"> <p><strong>模式</strong></p> </td><td style="background-color:#189e8e;"> <p><strong> nINT/REFCLKO引脚功能</strong></p> </td></tr><tr><td style="background-color:#ccdfdb;"> <p><strong>nINTSEL=0</strong></p> </td><td style="background-color:#ccdfdb;"> <p><strong>REF_CLK Out模式</strong></p> </td><td style="background-color:#ccdfdb;"> <p><strong>作为REF_CLK时钟源</strong></p> </td></tr><tr><td style="background-color:#e7f0ee;"> <p><strong>nINTSEL=1</strong></p> </td><td style="background-color:#e7f0ee;"> <p><strong>REF_CLK In模式</strong></p> </td><td style="background-color:#e7f0ee;"> <p><strong>作为中断引脚</strong></p> </td></tr></tbody></table> 
<p> REF_CLK In模式</p> 
<p>当工作在REF_CLKIn模式时，50MHz的外部时钟信号应接到LAN8720的XTAL1/CKIN引脚(5号引脚)和STM32F407的RMII_REF_CLK(PA1)引脚上，如下图所示。</p> 
<p><img alt="" src="https://images2.imgbox.com/42/5f/cfdjkEvW_o.png"></p> 
<p></p> 
<p>REF_CLKOut模式</p> 
<p>为了降低成本，LAN8720可以从外部的25MHz的晶振中产生REF_CLK时钟。到要使用此功能时应工作在REF_CLK Out模式时。当工作在REF_CLO Out模式时REF_CLK的时钟源如下图所示。</p> 
<p> <img alt="" src="https://images2.imgbox.com/18/40/dsAklhCY_o.png"></p> 
<p> 2.2、LAN8720寄存器</p> 
<p>PHY是由IEEE 802.3定义的，一般通过SMI对PHY进行管理和控制,也就是读写PHY内部寄存器。PHY寄存器的地址空间为5位，可以定义0~31共32个寄存器，但是随之PHY芯片功能的增加，很多PHY芯片采用分页技术来扩展地址空间，定义更多的寄存器，在这里我们不讨论这种情况。IEEE 802.3定义了0~15这16个寄存器的功能，16~31寄存器由芯片制造商自由定义。</p> 
<p>BCR寄存器(0)</p> 
<p><img alt="" src="https://images2.imgbox.com/39/ef/ngycmw58_o.png"></p> 
<p></p> 
<p>BSR寄存器(1)</p> 
<p><img alt="" src="https://images2.imgbox.com/58/8b/GO6yvj0Z_o.png"></p> 
<p> 在ST的以太网驱动库stm32f4x7_eth.h中定义了PHY的BCR和BSR寄存器的地址和这两个寄存器对应bit的意义，如下：</p> 
<p>#define PHY_BCR               0          /*!&lt; Transceiver Basic ControlRegister */</p> 
<p>#define PHY_BSR               1          /*!&lt; Transceiver Basic StatusRegister */</p> 
<p>#define PHY_Reset                            ((uint16_t)0x8000)</p> 
<p>#define PHY_Loopback                         ((uint16_t)0x4000)<br> #define PHY_FULLDUPLEX_100M               ((uint16_t)0x2100)</p> 
<p>#define PHY_HALFDUPLEX_100M             ((uint16_t)0x2000)</p> 
<p>#define PHY_FULLDUPLEX_10M              ((uint16_t)0x0100)</p> 
<p>#define PHY_HALFDUPLEX_10M              ((uint16_t)0x0000)</p> 
<p>#define PHY_AutoNegotiation                    ((uint16_t)0x1000)</p> 
<p>…………                                          </p> 
<p>#define PHY_AutoNego_Complete              ((uint16_t)0x0020)</p> 
<p>#define PHY_Linked_Status                      ((uint16_t)0x0004)</p> 
<p>#define PHY_Jabber_detection                   ((uint16_t)0x0002)</p> 
<p></p> 
<p>LAN8720特殊功能寄存器(31)</p> 
<p><img alt="" src="https://images2.imgbox.com/62/82/5AYWQS8g_o.png"></p> 
<p>LAN8720的特殊功能寄存器中的bit2~4是我们关心的，因为从这3个bit中，我们可以判断出当前开发板网络的双工方式和网速。这个寄存器的地址和bit的意义需要我们手动添加到ST的以太网驱动库文件stm32f4x7_eth_conf.h中</p> 
<p>3、硬件连接</p> 
<p><img alt="" src="https://images2.imgbox.com/bf/55/vva7Cz89_o.png"></p> 
<p>4、以太网DMA描述符</p> 
<p>4.1、以太网DMA描述符</p> 
<p>F407有一个以太网专用的DAM，DMA可以在CPU完全不干预的情况下，通过描述符有效地将数据从源传送到目标，接收缓冲区和发送缓冲区的数据都可以通过以太网DMA来传送。</p> 
<p>共有两个描述符：一个用于接收，一个用于发送。描述符是一种链表，最后一个描述符会指回第一个描述符以构成环形结构。描述符列表位于主机的物理存储空间，两个列表的基址分别写入ETH_DMARDLAR寄存器和ETH_DMATDLAR寄存器中。每个描述符最多可指向两个缓冲区，描述符一共有两种结构：环形结构和链接结构。</p> 
<p><img alt="" src="https://images2.imgbox.com/f8/19/neDl2gqC_o.png"></p> 
<p>4.2、DMA描述符链接结构</p> 
<p>在ST提供的以太网驱动库stm32f4x7_eth.c中使用是链接结构，链接结构如下</p> 
<p><img alt="" src="https://images2.imgbox.com/ff/c2/75rWry8K_o.png"></p> 
<p> 描述符注意事项：</p> 
<p> 1、一个以太网数据包可以跨越一个或多个DMA描述符     </p> 
<p> 2、一个DMA描述符只能用于一个以太网数据包</p> 
<p> 3、DMA描述符列表中的最后一个描述符指向第一个，形成链式结构！</p> 
<p></p> 
<p>描述符不是实际存在的物理结构，而是在程序中通过软件实现的，其实就是一个结构体！在ST的以太网驱动库stm32f4x7_eth.h中有个结构体ETH_DMADESCTypeDef，这个结构体就是DMA描述符！！！</p> 
<p>typedef struct  {<!-- --></p> 
<p>  __IO uint32_t   Status;                  //状态</p> 
<p>  uint32_t   ControlBufferSize;     //控制和buffer1，buffer2的长度</p> 
<p>  uint32_t   Buffer1Addr;           //buffer1地址</p> 
<p>  uint32_t   Buffer2NextDescAddr;   //buffer2地址或下一个描述符地址</p> 
<p>//一下只有增强的以太网DMA描述符含有</p> 
<p>#ifdef USE_ENHANCED_DMA_DESCRIPTORS</p> 
<p>  uint32_t   ExtendedStatus;                //增强描述符状态</p> 
<p>  uint32_t   Reserved1;                    //保留</p> 
<p>  uint32_t   TimeStampLow;                 //时间戳低位</p> 
<p>  uint32_t   TimeStampHigh;        //时间戳高位</p> 
<p>#endif</p> 
<p>} ETH_DMADESCTypeDef;</p> 
<p></p> 
<p>描述符有分为增强描述符和常规描述符，我们只讲常规描述符！因为我们的网络例程只使用到了常规描述符。常规描述符和增强描述符的结构体成员变量不同。常规描述符只使用了描述符的前4个成员变量。</p> 
<p>常规描述符和增强描述符又有发送描述符和接收描述符两种，下图是常规Tx DMA描述符：</p> 
<p><img alt="" src="https://images2.imgbox.com/0d/2c/2mvIv6Ci_o.png"></p> 
<p>常规Tx DMA描述符中TDES0的bit20用来表示描述符中的第二个地址是用来保存下一个描述符地址还是第二个缓冲区的地址，这点很重要！</p> 
<p>常规Rx DMA描述符如下！</p> 
<p><img alt="" src="https://images2.imgbox.com/55/79/6XS2kewp_o.png"></p> 
<p>常规Tx DMA描述符和常规Rx DMA描述符的成员变量的意义不同！</p> 
<p>常规Rx DMA描述符中RDES1的bit14用来表示描述符中的第二个地址是用来保存一个描述符地址还是第二个缓冲区的地址。</p> 
<p>我们说过ST官方以太网库stm32f4x7中使用链接结构的DMA描述符，那么在以太网描述符结构体ETH_DMADESCTypeDef中Buffer1Addr就是缓冲区的地址，Buffer2NextDescAddr就是下一个描述符的地址，如下图。</p> 
<p><img alt="" src="https://images2.imgbox.com/d6/b5/TULKd8UI_o.png"></p> 
<p>在stm32f4x7_eth.c中定义了两个DMA描述符数组，一个用于DMA接收，一个用于DMA发送，如下：</p> 
<p>__align(4) ETH_DMADESCTypeDef  DMARxDscrTab[ETH_RXBUFNB];</p> 
<p>__align(4) ETH_DMADESCTypeDef  DMATxDscrTab[ETH_TXBUFNB];</p> 
<p>接收和发送描述的大小通过宏ETH_RXBUFNB和ETH_TXBUFNB来定义，默认都为5。</p> 
<p>我们知道以链接结构太网描述符的Buffer1Addr成员用来存放缓冲区地址，那么数据缓冲区在哪里？这个数据缓冲区也是定义为数组的，如下：</p> 
<p>__align(4) uint8_tRx_Buff[ETH_RXBUFNB][ETH_RX_BUF_SIZE];</p> 
<p>__align(4) uint8_tTx_Buff[ETH_TXBUFNB][ETH_TX_BUF_SIZE];</p> 
<p>作者：广东松山电子实验室</p> 
<p>+WeChat（linzebinwinner）</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6eea291e4783c44c1476b1c0e8adc9cc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">css 修改浏览器滚动条样式（火狐Firefox，谷歌google）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5149958a81895494360eba5baf5fa0d7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Windows7下安装Anaconda3</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>