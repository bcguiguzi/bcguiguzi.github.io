<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>onvif 客户端的发现 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="onvif 客户端的发现" />
<meta property="og:description" content="1、解压：unzip -X gsoap_2.8.10.zip 编译
2、下载：
wget http://www.onvif.org/onvif/ver10/network/wsdl/remotediscovery.wsdl
3、复制：
cp gsoap-2.8/gsoap/typemap.dat .
4、在typemap.dat 中添加：
#Use gSOAP 2.8.10 and up. In the typemap.dat file used by wsdl2h, add: #	ONVIF recommended prefixes tds	= &#34;http://www.onvif.org/ver10/device/wsdl&#34; tev	= &#34;http://www.onvif.org/ver10/events/wsdl&#34; tls	= &#34;http://www.onvif.org/ver10/display/wsdl&#34; tmd	= &#34;http://www.onvif.org/ver10/deviceIO/wsdl&#34; timg	= &#34;http://www.onvif.org/ver20/imaging/wsdl&#34; trt	= &#34;http://www.onvif.org/ver10/media/wsdl&#34; tptz	= &#34;http://www.onvif.org/ver20/ptz/wsdl&#34; trv	= &#34;http://www.onvif.org/ver10/receiver/wsdl&#34; trc	= &#34;http://www.onvif.org/ver10/recording/wsdl&#34; tse	= &#34;http://www.onvif.org/ver10/search/wsdl&#34; trp	= &#34;http://www.onvif.org/ver10/replay/wsdl&#34; tan	= &#34;http://www.onvif.org/ver20/analytics/wsdl&#34; tad	= &#34;http://www.onvif.org/ver10/analyticsdevice/wsdl&#34; tdn	= &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/85e5aaa8c2dfc225510e688aafc0e24d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-06-18T17:37:39+08:00" />
<meta property="article:modified_time" content="2013-06-18T17:37:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">onvif 客户端的发现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>1、解压：unzip -X gsoap_2.8.10.zip 编译</p> 
<p>2、下载：</p> 
<p>wget http://www.onvif.org/onvif/ver10/network/wsdl/remotediscovery.wsdl</p> 
<p>3、复制：</p> 
<p>cp gsoap-2.8/gsoap/typemap.dat .<br> </p> 
<p>4、在typemap.dat 中添加：</p> 
<p></p> 
<pre><code class="language-cpp">#Use gSOAP 2.8.10 and up. In the typemap.dat file used by wsdl2h, add:
#	ONVIF recommended prefixes
tds	= "http://www.onvif.org/ver10/device/wsdl"
tev	= "http://www.onvif.org/ver10/events/wsdl"
tls	= "http://www.onvif.org/ver10/display/wsdl"
tmd	= "http://www.onvif.org/ver10/deviceIO/wsdl"
timg	= "http://www.onvif.org/ver20/imaging/wsdl"
trt	= "http://www.onvif.org/ver10/media/wsdl"
tptz	= "http://www.onvif.org/ver20/ptz/wsdl"
trv	= "http://www.onvif.org/ver10/receiver/wsdl"
trc	= "http://www.onvif.org/ver10/recording/wsdl"
tse	= "http://www.onvif.org/ver10/search/wsdl"
trp	= "http://www.onvif.org/ver10/replay/wsdl"
tan	= "http://www.onvif.org/ver20/analytics/wsdl"
tad	= "http://www.onvif.org/ver10/analyticsdevice/wsdl"
tdn	= "http://www.onvif.org/ver10/network/wsdl"
tt	= "http://www.onvif.org/ver10/schema"
#	OASIS recommended prefixes
wsnt	= "http://docs.oasis-open.org/wsn/b-2"
wsntw	= "http://docs.oasis-open.org/wsn/bw-2"
wsrfbf	= "http://docs.oasis-open.org/wsrf/bf-2"
wsrfr	= "http://docs.oasis-open.org/wsrf/r-2"
wsrfrw  = "http://docs.oasis-open.org/wsrf/rw-2"
wstop	= "http://docs.oasis-open.org/wsn/t-1"
#	WS-Discovery 1.0 remapping
wsdd10__HelloType		= | wsdd__HelloType
wsdd10__ByeType			= | wsdd__ByeType
wsdd10__ProbeType		= | wsdd__ProbeType
wsdd10__ProbeMatchesType	= | wsdd__ProbeMatchesType
wsdd10__ProbeMatchType		= | wsdd__ProbeMatchType
wsdd10__ResolveType		= | wsdd__ResolveType
wsdd10__ResolveMatchesType	= | wsdd__ResolveMatchesType
wsdd10__ResolveMatchType	= | wsdd__ResolveMatchType
#	SOAP-ENV mapping
SOAP_ENV__Envelope	= struct SOAP_ENV__Envelope { struct SOAP_ENV__Header *SOAP_ENV__Header; _XML SOAP_ENV__Body; }; | struct SOAP_ENV__Envelope
SOAP_ENV__Header	= | struct SOAP_ENV__Header
SOAP_ENV__Fault		= | struct SOAP_ENV__Fault
SOAP_ENV__Detail	= | struct SOAP_ENV__Detail
SOAP_ENV__Code		= | struct SOAP_ENV__Code
SOAP_ENV__Subcode	= | struct SOAP_ENV__Subcode
SOAP_ENV__Reason	= | struct SOAP_ENV__Reason</code></pre> 
<p></p> 
<p><br> </p> 5、把编译好的wsdl2h,soapcpp2复制到本目录 
<br> 6、./wsdl2h -o onvif.h -c -s -t typemap.dat remotediscovery.wsdl 
<p>7、./soapcpp2 -c onvif.h -x -I /workplace/mywork/onvif/gsoap-x86/gsoap-2.8/gsoap/import</p> 
<p>8、复制文件：</p> 
<p>cp gsoap-2.8/gsoap/stdsoap2.* .<br> </p> 
<p>9、测试代码：</p> 
<p></p> 
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include "wsdd.nsmap"
#include "soapH.h"
using namespace std;
int main()
{
    struct soap *soap;
    struct wsdd__ProbeType req;
    struct __wsdd__ProbeMatches resp;
    struct wsdd__ScopesType sScope;
    struct SOAP_ENV__Header header;
    int count = 0;
    int result = 0; 

    char guid_string[100];

     soap = soap_new(); 
    if(soap==NULL)
    {
        return -1;
    }
 
    soap_set_namespaces(soap, namespaces); 

    soap-&gt;recv_timeout = 5;		//超过5秒钟没有数据就退出
    soap_default_SOAP_ENV__Header(soap, &amp;header);
 
    header.wsa__MessageID = guid_string;
    header.wsa__To= "urn:schemas-xmlsoap-org:ws:2005:04:discovery";
    header.wsa__Action= "http://schemas.xmlsoap.org/ws/2005/04/discovery/Probe";
    soap-&gt;header = &amp;header;

    soap_default_wsdd__ScopesType(soap, &amp;sScope);
    sScope.__item = "";
    soap_default_wsdd__ProbeType(soap, &amp;req);
    req.Scopes = &amp;sScope;
    req.Types = "";

    result = soap_send___wsdd__Probe(soap, "soap.udp://239.255.255.250:3702", NULL, &amp;req);

    do{
         result = soap_recv___wsdd__ProbeMatches(soap, &amp;resp); 
         if (soap-&gt;error) 
         { 
             cout&lt;&lt;"soap error:"&lt;&lt;soap-&gt;error&lt;&lt;soap_faultcode(soap)&lt;&lt;"---"&lt;&lt;soap_faultstring(soap)&lt;&lt;endl; 
             result = soap-&gt;error; 
             break;
         } 
         else
         {
            cout&lt;&lt;"========================================="&lt;&lt;endl;
 
            cout&lt;&lt;"Match size:"&lt;&lt;resp.wsdd__ProbeMatches-&gt;__sizeProbeMatch&lt;&lt;endl;
            cout&lt;&lt;"xsd-unsignedInt:"&lt;&lt;resp.wsdd__ProbeMatches-&gt;ProbeMatch-&gt;MetadataVersion&lt;&lt;endl;
            cout&lt;&lt;"scopes item:"&lt;&lt;resp.wsdd__ProbeMatches-&gt;ProbeMatch-&gt;Scopes-&gt;__item&lt;&lt;endl;
            //cout&lt;&lt;"scopes matchby:"&lt;&lt;resp.wsdd__ProbeMatches-&gt;ProbeMatch-&gt;Scopes-&gt;MatchBy&lt;&lt;endl;
            cout&lt;&lt;"QName:"&lt;&lt;resp.wsdd__ProbeMatches-&gt;ProbeMatch-&gt;Types&lt;&lt;endl;
            cout&lt;&lt;"xsd:string:"&lt;&lt;resp.wsdd__ProbeMatches-&gt;ProbeMatch-&gt;wsa__EndpointReference.Address&lt;&lt;endl;
            cout&lt;&lt;"xsd:QName:"&lt;&lt;resp.wsdd__ProbeMatches-&gt;ProbeMatch-&gt;wsa__EndpointReference.PortType&lt;&lt;endl;
            cout&lt;&lt;"wsa:ServiceNameType:"&lt;&lt;resp.wsdd__ProbeMatches-&gt;ProbeMatch-&gt;wsa__EndpointReference.ServiceName&lt;&lt;endl;
            cout&lt;&lt;"sequence of elements:"&lt;&lt;resp.wsdd__ProbeMatches-&gt;ProbeMatch-&gt;wsa__EndpointReference.__size&lt;&lt;endl;
            cout&lt;&lt;"xsd:anyType:"&lt;&lt;resp.wsdd__ProbeMatches-&gt;ProbeMatch-&gt;wsa__EndpointReference.__anyAttribute&lt;&lt;endl;
            cout&lt;&lt;"endpoint any:"&lt;&lt;resp.wsdd__ProbeMatches-&gt;ProbeMatch-&gt;wsa__EndpointReference.__any&lt;&lt;endl;
            cout&lt;&lt;"wsdd:UriListType:"&lt;&lt;resp.wsdd__ProbeMatches-&gt;ProbeMatch-&gt;XAddrs&lt;&lt;endl;
         }
     }while(1);

    soap_destroy(soap); // remove deserialized class instances (C++ only) 
    soap_end(soap);		// clean up and remove deserialized data
    soap_done(soap);

    return result;
}</code></pre> 
<br> 编译：g++ cc.cpp soapC.c  stdsoap2.cpp soapClient.c -I/gsoap-2.8/gsoap 
<p></p> 
<p>10、运行：./a.out</p> 
<p>结果：</p> 
<p>1、因为有多个ip(多个网卡）</p> 
<p></p> 
<pre><code class="language-cpp">xy@xy-pc:/workplace/mywork/onvif/gsoap-x86/mytest/myonvif/test$ ./a.out 
soap error:-10x8a29778---0x8a2977c</code></pre> 
<br> 2、只有一个网卡，且ip所在网段正好有两个支持onvif的设备： 
<p></p> 
<p></p> 
<pre><code class="language-cpp">xy@xy-pc:/workplace/mywork/onvif/gsoap-x86/mytest/myonvif/test$ ./a.out 
=========================================
Match size:1
xsd-unsignedInt:1
scopes item:onvif://www.onvif.org/type/video_encoder onvif://www.onvif.org/type/ptz onvif://www.onvif.org/type/audio_encoder onvif://www.onvif.org/type/network_video_transmitter onvif://www.onvif.org/hardware/DM368 onvif://www.onvif.org/location/country/china onvif://www.onvif.org/name/Dahua
QName:tdn:NetworkVideoTransmitter
xsd:string:urn:uuid:5b71c61f-220b-475d-9eca-dd7941f07767
xsd:QName:0
wsa:ServiceNameType:0
sequence of elements:0
xsd:anyType:
endpoint any:0
wsdd:UriListType:http://192.168.9.110:9988/onvif/device_service
soap error:-10x87a99f8---0x87a99fc
xy@xy-pc:/workplace/mywork/onvif/gsoap-x86/mytest/myonvif/test$ 
xy@xy-pc:/workplace/mywork/onvif/gsoap-x86/mytest/myonvif/test$ 
xy@xy-pc:/workplace/mywork/onvif/gsoap-x86/mytest/myonvif/test$ ./a.out 
=========================================
Match size:1
xsd-unsignedInt:1
scopes item:onvif://www.onvif.org/type/video_encoder onvif://www.onvif.org/type/ptz onvif://www.onvif.org/type/audio_encoder onvif://www.onvif.org/type/network_video_transmitter onvif://www.onvif.org/hardware/DM368 onvif://www.onvif.org/location/country/china onvif://www.onvif.org/name/Dahua
QName:tdn:NetworkVideoTransmitter
xsd:string:urn:uuid:5b71c61f-220b-475d-9eca-dd7941f07767
xsd:QName:0
wsa:ServiceNameType:0
sequence of elements:0
xsd:anyType:
endpoint any:0
wsdd:UriListType:http://192.168.9.110:9988/onvif/device_service
soap error:-10x86929f8---0x86929fc
</code></pre> 
<br> 参考： 
<p></p> 
<p>http://my.oschina.net/yunuo/blog/119206<br> http://blog.csdn.net/ghostyu/article/details/8182516<br> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4b924d19c0516214b71a5bbca1dbb188/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">linux 内核线程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/323736547daf5fb54c444a41df03b2e1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Visual Studio属性配置中使用宏</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>