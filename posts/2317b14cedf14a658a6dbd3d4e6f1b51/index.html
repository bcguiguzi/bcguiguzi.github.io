<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>一文彻底明白linux中的selinux到底是什么 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="一文彻底明白linux中的selinux到底是什么" />
<meta property="og:description" content="一、前言
安全增强型 Linux（Security-Enhanced Linux）简称 SELinux，它是一个 Linux 内核模块，也是 Linux 的一个安全子系统。
SELinux 主要由美国国家安全局开发。2.6 及以上版本的 Linux 内核都已经集成了 SELinux 模块。
SELinux 的结构及配置非常复杂，而且有大量概念性的东西，要学精难度较大。很多 Linux 系统管理员嫌麻烦都把 SELinux 关闭了。
如果可以熟练掌握 SELinux 并正确运用，我觉得整个系统基本上可以到达&#34;坚不可摧&#34;的地步了（请永远记住没有绝对的安全）。
掌握 SELinux 的基本概念以及简单的配置方法是每个 Linux 系统管理员的必修课。
本文均在 CentOS 7.4.1708 系统中操作。
本文纯属个人学习经验分享交流，出错再所难免，仅供参考！如果发现错误的地方，可以的话麻烦指点下，特别感谢！
二、SELinux 的作用及权限管理机制
2.1 SELinux 的作用
SELinux 主要作用就是最大限度地减小系统中服务进程可访问的资源（最小权限原则）。
设想一下，如果一个以 root 身份运行的网络服务存在 0day 漏洞，黑客就可以利用这个漏洞，以 root 的身份在您的服务器上为所欲为了。是不是很可怕？
SELinux 就是来解决这个问题的。
2.2 DAC
在没有使用 SELinux 的操作系统中，决定一个资源是否能被访问的因素是：某个资源是否拥有对应用户的权限（读、写、执行）。
只要访问这个资源的进程符合以上的条件就可以被访问。
而最致命问题是，root 用户不受任何管制，系统上任何资源都可以无限制地访问。
这种权限管理机制的主体是用户，也称为自主访问控制（DAC）。
2.3 MAC
在使用了 SELinux 的操作系统中，决定一个资源是否能被访问的因素除了上述因素之外，还需要判断每一类进程是否拥有对某一类资源的访问权限。
这样一来，即使进程是以 root 身份运行的，也需要判断这个进程的类型以及允许访问的资源类型才能决定是否允许访问某个资源。进程的活动空间也可以被压缩到最小。
即使是以 root 身份运行的服务进程，一般也只能访问到它所需要的资源。即使程序出了漏洞，影响范围也只有在其允许访问的资源范围内。安全性大大增加。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/2317b14cedf14a658a6dbd3d4e6f1b51/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-01-17T15:32:46+08:00" />
<meta property="article:modified_time" content="2019-01-17T15:32:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">一文彻底明白linux中的selinux到底是什么</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:0cm;"><strong><span style="color:#555555;">一、前言</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">安全增强型</span><span style="color:#555555;"> Linux</span><span style="color:#555555;">（</span><span style="color:#555555;">Security-Enhanced Linux</span><span style="color:#555555;">）简称</span><span style="color:#555555;"> SELinux</span><span style="color:#555555;">，它是一个</span><span style="color:#555555;"> Linux </span><span style="color:#555555;">内核模块，也是</span><span style="color:#555555;"> Linux </span><span style="color:#555555;">的一个安全子系统。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">SELinux </span><span style="color:#555555;">主要由美国国家安全局开发。</span><span style="color:#555555;">2.6 </span><span style="color:#555555;">及以上版本的</span><span style="color:#555555;"> Linux </span><span style="color:#555555;">内核都已经集成了</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">模块。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">SELinux </span><span style="color:#555555;">的结构及配置非常复杂，而且有大量概念性的东西，要学精难度较大。很多</span><span style="color:#555555;"> Linux </span><span style="color:#555555;">系统管理员嫌麻烦都把</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">关闭了。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">如果可以熟练掌握</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">并正确运用，我觉得整个系统基本上可以到达</span><span style="color:#555555;">"</span><span style="color:#555555;">坚不可摧</span><span style="color:#555555;">"</span><span style="color:#555555;">的地步了（请永远记住<strong>没有绝对的安全</strong>）。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">掌握</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">的基本概念以及简单的配置方法是每个</span><span style="color:#555555;"> Linux </span><span style="color:#555555;">系统管理员的必修课。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">本文均在</span><span style="color:#555555;"> <strong>CentOS 7.4.1708</strong> </span><span style="color:#555555;">系统中操作。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">本文纯属个人学习经验分享交流，出错再所难免，仅供参考！如果发现错误的地方，可以的话麻烦指点下，特别感谢！</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">二、</span></strong><strong><span style="color:#555555;">SELinux </span></strong><strong><span style="color:#555555;">的作用及权限管理机制</span></strong></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">2.1 SELinux </span></strong><strong><span style="color:#555555;">的作用</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">SELinux </span><span style="color:#555555;">主要作用就是<strong>最大限度地减小系统中服务进程可访问的资源</strong>（最小权限原则）。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">设想一下，如果一个以</span><span style="color:#555555;"> root </span><span style="color:#555555;">身份运行的网络服务存在</span><span style="color:#555555;"> 0day </span><span style="color:#555555;">漏洞，黑客就可以利用这个漏洞，<strong>以</strong></span><strong><span style="color:#555555;"> root </span></strong><strong><span style="color:#555555;">的身份在您的服务器上为所欲为了</span></strong><span style="color:#555555;">。是不是很可怕？</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">SELinux </span><span style="color:#555555;">就是来解决这个问题的。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">2.2 DAC</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">在没有使用</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">的操作系统中，决定一个资源是否能被访问的因素是：<strong>某个资源是否拥有对应用户的权限（读、写、执行）</strong>。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">只要访问这个资源的进程符合以上的条件就可以被访问。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">而最致命问题是，</span><strong><span style="color:#555555;">root </span></strong><strong><span style="color:#555555;">用户不受任何管制</span></strong><span style="color:#555555;">，系统上任何资源都可以无限制地访问。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">这种权限管理机制的主体是<strong>用户</strong>，也称为<strong>自主访问控制（</strong></span><strong><span style="color:#555555;">DAC</span></strong><strong><span style="color:#555555;">）</span></strong><span style="color:#555555;">。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">2.3 MAC</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">在使用了</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">的操作系统中，决定一个资源是否能被访问的因素除了上述因素之外，还需要判断<strong>每一类进程是否拥有对某一类资源的访问权限</strong>。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">这样一来，即使进程是以</span><span style="color:#555555;"> root </span><span style="color:#555555;">身份运行的，也需要判断这个进程的类型以及允许访问的资源类型才能决定是否允许访问某个资源。进程的活动空间也可以被压缩到最小。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">即使是以</span><span style="color:#555555;"> root </span><span style="color:#555555;">身份运行的服务进程，一般也只能访问到它所需要的资源。即使程序出了漏洞，影响范围也只有在其允许访问的资源范围内。安全性大大增加。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">这种权限管理机制的主体是<strong>进程</strong>，也称为<strong>强制访问控制（</strong></span><strong><span style="color:#555555;">MAC</span></strong><strong><span style="color:#555555;">）</span></strong><span style="color:#555555;">。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">而</span><span style="color:#555555;"> MAC </span><span style="color:#555555;">又细分为了两种方式，一种叫<strong>类别安全（</strong></span><strong><span style="color:#555555;">MCS</span></strong><strong><span style="color:#555555;">）模式</span></strong><span style="color:#555555;">，另一种叫<strong>多级安全（</strong></span><strong><span style="color:#555555;">MLS</span></strong><strong><span style="color:#555555;">）模式</span></strong><span style="color:#555555;">。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">下文中的操作均为</span><span style="color:#555555;"> <strong>MCS</strong> </span><span style="color:#555555;">模式。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">2.4 DAC </span></strong><strong><span style="color:#555555;">和</span></strong><strong><span style="color:#555555;"> MAC </span></strong><strong><span style="color:#555555;">的对比</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">这里引用一张图片来说明。</span></p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="231" src="https://images2.imgbox.com/91/a6/2RpJF1IE_o.jpg" width="720"></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">￼</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">可以看到，在</span><span style="color:#555555;"> DAC </span><span style="color:#555555;">模式下，只要相应目录有相应用户的权限，就可以被访问。而在</span><span style="color:#555555;"> MAC </span><span style="color:#555555;">模式下，还要受进程允许访问目录范围的限制。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">三、</span></strong><strong><span style="color:#555555;">SELinux </span></strong><strong><span style="color:#555555;">基本概念</span></strong></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">3.1 </span></strong><strong><span style="color:#555555;">主体（</span></strong><strong><span style="color:#555555;">Subject</span></strong><strong><span style="color:#555555;">）</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">可以完全等同于<strong>进程</strong>。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">注：为了方便理解，如无特别说明，以下均把<strong>进程</strong>视为主体。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">3.2 </span></strong><strong><span style="color:#555555;">对象（</span></strong><strong><span style="color:#555555;">Object</span></strong><strong><span style="color:#555555;">）</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">被主体访问的<strong>资源</strong>。可以是文件、目录、端口、设备等。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">注：为了方便理解，如无特别说明，以下均把<strong>文件或者目录</strong>视为对象。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">3.3 </span></strong><strong><span style="color:#555555;">政策和规则（</span></strong><strong><span style="color:#555555;">Policy &amp; Rule</span></strong><strong><span style="color:#555555;">）</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">系统中通常有大量的文件和进程，为了节省时间和开销，通常我们只是<strong>选择性</strong>地对某些进程进行管制。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">而哪些进程需要管制、要怎么管制是由政策决定的。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">一套政策里面有多个规则。部分规则可以按照需求启用或禁用（以下把该类型的规则称为<strong>布尔型</strong>规则）。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">规则是<strong>模块化、可扩展</strong>的。在安装新的应用程序时，应用程序可通过添加新的模块来添加规则。用户也可以手动地增减规则。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">在</span><span style="color:#555555;"> CentOS 7 </span><span style="color:#555555;">系统中，有三套政策，分别是：</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">1. targeted</span><span style="color:#555555;">：对大部分网络服务进程进行管制。这是系统<strong>默认使用</strong>的政策（下文均使用此政策）。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">2. minimum</span><span style="color:#555555;">：以</span><span style="color:#555555;"> targeted </span><span style="color:#555555;">为基础，仅对选定的网络服务进程进行管制。一般不用。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">3. mls</span><span style="color:#555555;">：多级安全保护。对所有的进程进行管制。这是最严格的政策，配置难度非常大。一般不用，除非对安全性有极高的要求。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">政策可以在</span><span style="color:#555555;"> /etc/selinux/config </span><span style="color:#555555;">中设定。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">3.4 </span></strong><strong><span style="color:#555555;">安全上下文（</span></strong><strong><span style="color:#555555;">Security Context</span></strong><strong><span style="color:#555555;">）</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">安全上下文是</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">的<strong>核心</strong>。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">安全上下文我自己把它分为「进程安全上下文」和「文件安全上下文」。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">一个</span></strong><span style="color:#555555;">「进程安全上下文」一般对应<strong>多个</strong>「文件安全上下文」。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">只有两者的安全上下文对应上了，进程才能访问文件。</span></strong><span style="color:#555555;">它们的对应关系由政策中的规则决定。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">文件安全上下文由<strong>文件创建的位置和创建文件的进程所决定</strong>。而且系统有一套默认值，用户也可以对默认值进行设定。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">需要注意的是，单纯的<strong>移动文件</strong>操作并<strong>不会</strong>改变文件的安全上下文。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">安全上下文的结构及含义</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">安全上下文有四个字段，分别用冒号隔开。形如：</span><span style="color:#555555;">system_u:object_r:admin_home_t:s0</span><span style="color:#555555;">。</span></p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="375" src="https://images2.imgbox.com/ef/28/mcWhBmab_o.jpg" width="640"></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">3.5 SELinux </span></strong><strong><span style="color:#555555;">的工作模式</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">SELinux </span><span style="color:#555555;">有三种工作模式，分别是：</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">1. enforcing</span><span style="color:#555555;">：强制模式。违反</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">规则的行为将被<strong>阻止</strong>并<strong>记录到日志中</strong>。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">2. permissive</span><span style="color:#555555;">：宽容模式。违反</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">规则的行为只会<strong>记录到日志中</strong>。一般为调试用。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">3. disabled</span><span style="color:#555555;">：关闭</span><span style="color:#555555;"> SELinux</span><span style="color:#555555;">。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">SELinux </span><span style="color:#555555;">工作模式可以在</span><span style="color:#555555;"> /etc/selinux/config </span><span style="color:#555555;">中设定。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">如果想从</span><span style="color:#555555;"> disabled </span><span style="color:#555555;">切换到</span><span style="color:#555555;"> enforcing </span><span style="color:#555555;">或者</span><span style="color:#555555;"> permissive </span><span style="color:#555555;">的话，需要<strong>重启系统</strong>。反过来也一样。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">enforcing </span><span style="color:#555555;">和</span><span style="color:#555555;"> permissive </span><span style="color:#555555;">模式可以通过</span><span style="color:#555555;"> setenforce 1|0 </span><span style="color:#555555;">命令快速切换。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">需要注意的是，如果系统已经在关闭</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">的状态下运行了一段时间，在打开</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">之后的第一次重启速度可能会比较慢。因为系统必须为磁盘中的文件<strong>创建安全上下文</strong>（我表示我重启了大约</span><span style="color:#555555;"> 10 </span><span style="color:#555555;">分钟，还以为是死机了</span><span style="color:#555555;">……</span><span style="color:#555555;">）。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">SELinux </span><span style="color:#555555;">日志的记录需要借助</span><span style="color:#555555;"> auditd.service </span><span style="color:#555555;">这个服务，请<strong>不要禁用</strong>它。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">3.6 SELinux </span></strong><strong><span style="color:#555555;">工作流程</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">这里引用一张图片，不必过多解释。</span></p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="335" src="https://images2.imgbox.com/00/88/cbQcINyt_o.jpg" width="640"></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">￼</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">注：上面的<strong>安全文本</strong>指的就是<strong>安全上下文</strong>。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">四、</span></strong><strong><span style="color:#555555;">SELinux </span></strong><strong><span style="color:#555555;">基本操作</span></strong></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">4.1 </span></strong><strong><span style="color:#555555;">查询文件或目录的安全上下文</span></strong></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">命令基本用法</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">ls -Z &lt;</span><span style="color:#555555;">文件或目录</span><span style="color:#555555;">&gt;</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">用法举例</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">查询</span><span style="color:#555555;"> /etc/hosts </span><span style="color:#555555;">的安全上下文。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">ls -Z /etc/hosts</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">执行结果</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">-rw-r--r--. root root system_u:object_r:net_conf_t:s0 /etc/hosts</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">4.2 </span></strong><strong><span style="color:#555555;">查询进程的安全上下文</span></strong></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">命令基本用法</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">ps auxZ | grep -v grep | grep &lt;</span><span style="color:#555555;">进程名</span><span style="color:#555555;">&gt;</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">用法举例</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">查询</span><span style="color:#555555;"> Nginx </span><span style="color:#555555;">相关进程的安全上下文。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">ps auxZ | grep -v grep | grep nginx</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">执行结果</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">system_u:system_r:httpd_t:s0 root 7997 0.0 0.0 122784 2156 ? Ss 14:31 0:00 nginx: master process /usr/sbin/nginx</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">system_u:system_r:httpd_t:s0 nginx 7998 0.0 0.0 125332 7560 ? S 14:31 0:00 nginx: worker process</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">4.3 </span></strong><strong><span style="color:#555555;">手动修改文件或目录的安全上下文</span></strong></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">命令基本用法</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">chcon &lt;</span><span style="color:#555555;">选项</span><span style="color:#555555;">&gt; &lt;</span><span style="color:#555555;">文件或目录</span><span style="color:#555555;"> 1&gt; [&lt;</span><span style="color:#555555;">文件或目录</span><span style="color:#555555;"> 2&gt;...]</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">选项功能</span></strong><span style="color:#555555;">-u &lt;</span><span style="color:#555555;">值</span><span style="color:#555555;">&gt;</span><span style="color:#555555;">修改安全上下文的用户字段</span><span style="color:#555555;">-r &lt;</span><span style="color:#555555;">值</span><span style="color:#555555;">&gt;</span><span style="color:#555555;">修改安全上下文的角色字段</span><span style="color:#555555;">-t &lt;</span><span style="color:#555555;">值</span><span style="color:#555555;">&gt;</span><span style="color:#555555;">修改安全上下文的类型字段</span><span style="color:#555555;">-l &lt;</span><span style="color:#555555;">值</span><span style="color:#555555;">&gt;</span><span style="color:#555555;">修改安全上下文的级别字段</span><span style="color:#555555;">--reference &lt;</span><span style="color:#555555;">文件或目录</span><span style="color:#555555;">&gt;</span><span style="color:#555555;">修改与指定文件或目录相一致的安全上下文</span><span style="color:#555555;">-R</span><span style="color:#555555;">递归操作</span><span style="color:#555555;">-h</span><span style="color:#555555;">修改软链接的安全上下文（不加此选项则修改软链接对应文件）</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">用法举例</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">修改</span><span style="color:#555555;"> test </span><span style="color:#555555;">的安全上下文为</span><span style="color:#555555;"> aaa_u:bbb_r:ccc_t:s0</span><span style="color:#555555;">。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">chcon -u aaa_u -r bbb_r -t ccc_t test</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">4.4 </span></strong><strong><span style="color:#555555;">把文件或目录的安全上下文恢复到默认值</span></strong></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">命令基本用法</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">restorecon [</span><span style="color:#555555;">选项</span><span style="color:#555555;">] &lt;</span><span style="color:#555555;">文件或目录</span><span style="color:#555555;"> 1&gt; [&lt;</span><span style="color:#555555;">文件或目录</span><span style="color:#555555;"> 2&gt;...]</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">选项功能</span></strong><span style="color:#555555;">-v</span><span style="color:#555555;">打印操作过程</span><span style="color:#555555;">-R</span><span style="color:#555555;">递归操作</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">用法举例</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">添加一些网页文件到</span><span style="color:#555555;"> Nginx </span><span style="color:#555555;">服务器的目录之后，为这些新文件设置正确的安全上下文。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">restorecon -R /usr/share/nginx/html/</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">4.5 </span></strong><strong><span style="color:#555555;">查询系统中的布尔型规则及其状态</span></strong></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">命令基本用法</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">getsebool -a</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">由于该命令要么<strong>查询所有规则</strong>，要么<strong>只查询一个规则</strong>，所以一般都是先查询所有规则然后用</span><span style="color:#555555;"> grep </span><span style="color:#555555;">筛选。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">用法举例</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">查询与</span><span style="color:#555555;"> httpd </span><span style="color:#555555;">有关的布尔型规则。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">getsebool -a | grep httpd</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">执行结果</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">httpd_anon_write --&gt; off</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">httpd_builtin_scripting --&gt; on</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">httpd_can_check_spam --&gt; off</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">httpd_can_connect_ftp --&gt; off</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">#</span><span style="color:#555555;">以下省略</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">4.6 </span></strong><strong><span style="color:#555555;">开关一个布尔型规则</span></strong></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">命令基本用法</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">setsebool [</span><span style="color:#555555;">选项</span><span style="color:#555555;">] &lt;</span><span style="color:#555555;">规则名称</span><span style="color:#555555;">&gt; &lt;on|off&gt;</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">选项功能</span></strong><span style="color:#555555;">-P</span><span style="color:#555555;">重启依然生效</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">用法举例</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">开启</span><span style="color:#555555;"> httpd_anon_write </span><span style="color:#555555;">规则。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">setsebool -P httpd_anon_write on</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">4.7 </span></strong><strong><span style="color:#555555;">添加目录的默认安全上下文</span></strong></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">命令基本用法</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">semanage fcontext -a -t &lt;</span><span style="color:#555555;">文件安全上下文中的类型字段</span><span style="color:#555555;">&gt; "&lt;</span><span style="color:#555555;">目录（后面不加斜杠）</span><span style="color:#555555;">&gt;(/.*)?"</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">注：目录或文件的默认安全上下文可以通过</span><span style="color:#555555;"> semanage fcontext -l </span><span style="color:#555555;">命令配合</span><span style="color:#555555;"> grep</span><span style="color:#555555;">过滤查看。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">用法举例</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">为</span><span style="color:#555555;"> Nginx </span><span style="color:#555555;">新增一个网站目录</span><span style="color:#555555;"> /usr/share/nginx/html2 </span><span style="color:#555555;">之后，需要为其设置与原目录相同的默认安全上下文。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">semanage fcontext -a -t httpd_sys_content_t "/usr/share/nginx/html2(/.*)?"</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">4.8 </span></strong><strong><span style="color:#555555;">添加某类进程允许访问的端口</span></strong></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">命令基本用法</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">semanage port -a -t &lt;</span><span style="color:#555555;">服务类型</span><span style="color:#555555;">&gt; -p &lt;</span><span style="color:#555555;">协议</span><span style="color:#555555;">&gt; &lt;</span><span style="color:#555555;">端口号</span><span style="color:#555555;">&gt;</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">注：各种服务类型所允许的端口号可以通过</span><span style="color:#555555;"> semanage port -l </span><span style="color:#555555;">命令配合</span><span style="color:#555555;"> grep </span><span style="color:#555555;">过滤查看。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">用法举例</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">为</span><span style="color:#555555;"> Nginx </span><span style="color:#555555;">需要使用</span><span style="color:#555555;"> 10080 </span><span style="color:#555555;">的端口用于</span><span style="color:#555555;"> HTTP </span><span style="color:#555555;">服务。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">semanage port -a -t http_port_t -p tcp 10080</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">五、</span></strong><strong><span style="color:#555555;">SELinux </span></strong><strong><span style="color:#555555;">错误分析和解决</span></strong></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">5.1 </span></strong><strong><span style="color:#555555;">认识</span></strong><strong><span style="color:#555555;"> SELinux </span></strong><strong><span style="color:#555555;">日志</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">当开启了</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">之后，很多服务的一些正常行为都会被视为违规行为（标题及下文中的错误均指违规行为）。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">这时候我们就需要借助</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">违规日志来分析解决。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">SELinux </span><span style="color:#555555;">违规日志保存在</span><span style="color:#555555;"> /var/log/audit/audit.log </span><span style="color:#555555;">中。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">/var/log/audit/audit.log </span><span style="color:#555555;">的内容大概是这样的。</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">type=LOGIN msg=audit(1507898701.391:515): pid=8523 uid=0 subj=system_u:system_r:crond_t:s0-s0:c0.c1023 old-auid=4294967295 auid=0 tty=(none) old-ses=4294967295 ses=25 res=1</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">type=USER_START msg=audit(1507898701.421:516): pid=8523 uid=0 auid=0 ses=25 subj=system_u:system_r:crond_t:s0-s0:c0.c1023 msg='op=PAM:session_open grantors=pam_loginuid,pam_keyinit,pam_limits,pam_systemd acct="root" exe="/usr/sbin/crond" hostname=? addr=? terminal=cron res=success'</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">...</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">该文件的内容很多，而且混有很多与</span><span style="color:#555555;"> SELinux </span><span style="color:#555555;">错误无关的系统审计日志。我们要借助</span><span style="color:#555555;"> sealert </span><span style="color:#555555;">这个实用工具来帮忙分析（如果提示找不到命令的话请安装</span><span style="color:#555555;"> setroubleshoot </span><span style="color:#555555;">软件包）。</span></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">5.2 </span></strong><strong><span style="color:#555555;">使用</span></strong><span style="color:#555555;"> <strong>sealert</strong> </span><strong><span style="color:#555555;">分析错误</span></strong></p> 
<p style="margin-left:0cm;"><strong><span style="color:#555555;">命令基本用法</span></strong></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">sealert -a /var/log/audit/audit.log</span></p> 
<p style="margin-left:0cm;"><span style="color:#555555;">执行完命令之后，系统需要花一段时间去分析日志中的违规行为并给出分析报告。分析报告的结构讲解请看下图：</span></p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="766" src="https://images2.imgbox.com/78/99/oTwhOfDu_o.jpg" width="640"></p> 
<p style="margin-left:0cm;"><img alt="" class="has" height="360" src="https://images2.imgbox.com/bd/68/dhM13ezs_o.jpg" width="640"></p> 
<p style="margin-left:0cm;"> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9d7aeff5cae3ffcaec47556445303380/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">详细讨论Java中偏向锁、轻量级锁及重量级锁实现原理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5e43199014b11e61008d365c362afe2f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Format-String Vulnerability Lab  格式化字符串漏洞 （shellcode写进环境变量）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>