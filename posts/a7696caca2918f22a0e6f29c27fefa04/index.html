<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux设备驱动五 (1)总线、设备和驱动 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux设备驱动五 (1)总线、设备和驱动" />
<meta property="og:description" content="一、sysfs文件系统
设备模型是2.6内核新引入的特征。设备模型提供了一个独立的机制专门来表示设备，并描述其在系统中的拓扑结构。
在2.4内核中，设备的信息放在/proc中。
而在2.6内核，内核把设备相关的信息归类在新增加sysfs文件系统，并将它挂载到/sys目录中，把设备信息归类的同时，让用户可以通过用户空间访问。
接下来简单介绍一些sys中的目录：
block：用于管理块设备，系统中的每一个块设备会在该目录下对应一个子目录。
bus：用于管理总线，没注册一条总线，在该目录下有一个对应的子目录。
其中，每个总线子目录下会有两个子目录：devices和drivers。
devices包含里系统中所有属于该总线的的设备。
drivers包含里系统中所有属于该总线的的驱动。
class：将系统中的设备按功能分类。
devices：该目录提供了系统中设备拓扑结构图。
dev：该目录已注册的设备节点的视图。
kernel：内核中的相关参数。
module：内核中的模块信息。
fireware：内核中的固件信息。
Fs：描述内核中的文件系统。
上面的目录，接下来的章节会常常提起bus和device。
再说说这些目录,来个简单的命令：
root@xiaobai-laptop:/sys# ll class/net/eth0
lrwxrwxrwx 1 root root 0 2011-01-31 10:11 class/net/eth0 -&gt; ../../devices/pci0000:00/0000:00:1c.5/0000:86:00.0/net/eth0/
上面的命令也可以看到class/net/eth0的路径其实就是devices目录中一个网卡设备的软连接。
贴个书上的图：
由上面两个例子看到，sys中的其他目录都是将devvice目录下的数据加以转换加工而得。上面的图中，将use设备归类到bus总线上，又把它归类到class。正是在sys中有很多这样的结构，内核就有一个完整而且复杂的拓扑结构图。
而维护这些关系的结构体就包括kobject、kset、ktype和subsystem等数据结构，不过这里就先不介绍。
通过设备模型，内核就能实现多种不同的任务，如：
1、电源管理和系统关机。
2、与用户空间通信。这个就比较容易理解，sys目录向用户展示了设备模型的结构图。
3、热插拔设备。大概意思就是，当设备插入后，内核会根据插入的设备安装驱动，设备拔出后，内核又会自动卸载驱动。
4、设备类型。将设备归类。
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
在接下来的内容会简单介绍总线、设备和驱动程序的概念和函数调用，以下的函数我将模拟创建一条ubs总线，一个usb设备和一个usb驱动。
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
二、总线
总线是处理器和设备之间的通道，在设备模型中，所有的设备都通过总线相连，以总线来管理设备和驱动函数。总线有bus_type结构表示。
/*linux/device.h*/
51 struct bus_type {
52 const char *name;
53 struct bus_attribute *bus_attrs;
54 struct device_attribute *dev_attrs;
55 struct driver_attribute *drv_attrs;
56
57 int (*match)(struct device *dev, struct device_driver *drv);" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/a7696caca2918f22a0e6f29c27fefa04/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-12-28T21:42:58+08:00" />
<meta property="article:modified_time" content="2016-12-28T21:42:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux设备驱动五 (1)总线、设备和驱动</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <br> 
<br> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">一、</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">sysfs</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">文件系统</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">设备模型是</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">2.6</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">内核新引入的特征。设备模型提供了一个独立的机制专门来表示设备，并描述其在系统中的拓扑结构。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">在</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">2.4</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">内核中，设备的信息放在</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">/proc</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">中。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">而在</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">2.6</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">内核，内核把设备相关的信息归类在新增加</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">sysfs</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">文件系统，并将它挂载到</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">/sys</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">目录中，把设备信息归类的同时，让用户可以通过用户空间访问。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">接下来简单介绍一些</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">sys</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">中的目录：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">block</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：用于管理块设备，系统中的每一个块设备会在该目录下对应一个子目录。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">bus</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：用于管理总线，没注册一条总线，在该目录下有一个对应的子目录。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word"></span><span style="font-family:Times New Roman,serif; word-wrap:break-word">其中，每个总线子目录下会有两个子目录：</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">devices</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">和</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">drivers</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">devices</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">包含里系统中所有属于该总线的的设备。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">drivers</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">包含里系统中所有属于该总线的的驱动。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">class</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：将系统中的设备按功能分类。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">devices</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：该目录提供了系统中设备拓扑结构图。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">dev</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：该目录已注册的设备节点的视图。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">kernel</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：内核中的相关参数。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">module</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：内核中的模块信息。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">fireware</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：内核中的固件信息。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">Fs</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：描述内核中的文件系统。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:Times New Roman,serif; word-wrap:break-word">上面的目录，接下来的章节会常常提起</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">bus</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">和</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">device</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">。</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">再说说这些目录</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">,</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">来个简单的命令：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">root@xiaobai-laptop:/sys# ll class/net/eth0</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">lrwxrwxrwx 1 root root 0 2011-01-31 10:11 class/net/eth0 -&gt; ../../devices/pci0000:00/0000:00:1c.5/0000:86:00.0/net/eth0/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">上面的命令也可以看到</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">class/net/eth0</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">的路径其实就是</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">devices</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">目录中一个网卡设备的<span style="color:#ff0000; word-wrap:break-word">软连接</span>。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">贴个书上的图：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <a target="_blank" href="http://blog.chinaunix.net/attachment/201102/1/25014876_1296562467cFAa.png" rel="nofollow noopener noreferrer" style="word-wrap:break-word; text-decoration:none; color:rgb(25,89,155)"><img src="https://images2.imgbox.com/67/97/2qxnqKUr_o.png" border="0" alt="" style="word-wrap:break-word; border:0px"></a></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">由上面两个例子看到，</span></span><span style="font-family:Times New Roman,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">sys</span></span><span style="font-family:Times New Roman,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">中的其他目录都是将</span></span><span style="font-family:Times New Roman,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">devvice</span></span><span style="font-family:Times New Roman,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">目录下的数据加以转换加工而得</span>。上面的图中，将</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">use</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">设备归类到</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">bus</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">总线上，又把它归类到</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">class</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">。正是在</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">sys</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">中有很多这样的结构，内核就有一个完整而且复杂的拓扑结构图。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:Times New Roman,serif; word-wrap:break-word">而维护这些关系的结构体就包括</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">kobject</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">kset</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">ktype</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">和</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">subsystem</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">等数据结构，不过这里就先不介绍。</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">通过设备模型，内核就能实现多种不同的任务，如：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">1</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、电源管理和系统关机。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">2</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、与用户空间通信。这个就比较容易理解，</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">sys</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">目录向用户展示了设备模型的结构图。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">3</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、热插拔设备。大概意思就是，当设备插入后，内核会根据插入的设备安装驱动，设备拔出后，内核又会自动卸载驱动。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">4</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、设备类型。将设备归类。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">在接下来的内容会简单介绍总线、设备和驱动程序的概念和函数调用，以下的函数我将<span style="color:#ff0000; word-wrap:break-word">模拟</span>创建一条</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">ubs</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">总线，一个</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">usb</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">设备和一个</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">usb</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">驱动。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">二、总线</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">总线是处理器和设备之间的通道，在设备模型中，所有的设备都通过总线相连，<span style="color:#ff0000; word-wrap:break-word">以总线来管理设备和驱动函数</span>。总线有</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">bus_type</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">结构表示。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*linux/device.h*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">51 struct bus_type {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">52 const char *name;</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">53 struct bus_attribute *bus_attrs;</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">54 struct device_attribute *dev_attrs;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">55 struct driver_attribute *drv_attrs;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">56</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">57 int (*match)(struct device *dev, struct device_driver *drv);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">58 int (*uevent)(struct device *dev, struct kobj_uevent_env *env);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">59 int (*probe)(struct device *dev);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">60 int (*remove)(struct device *dev);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">61 void (*shutdown)(struct device *dev);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">62</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">63 int (*suspend)(struct device *dev, pm_message_t state);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">64 int (*suspend_late)(struct device *dev, pm_message_t state);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">65 int (*resume_early)(struct device *dev);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">66 int (*resume)(struct device *dev);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">67</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">68 struct dev_pm_ops *pm;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">69</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">70 struct bus_type_private *p;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">71 };</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 红色部分是以后将会介绍的成员，其中<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>是总线的名<span style="color:#333333; word-wrap:break-word">字， <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attrs</span></span><span style="color:#333333; word-wrap:break-word">是总线的属性，那些函数指针的操作总线的方法，在这一章节先不讲总线的方法。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:Times New Roman,serif; word-wrap:break-word">总线的注册和删除：</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">总线的注册有两个步骤：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">1</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、定义一个</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">bus_type</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">结构体，并设置好需要设置的结构体成员。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">2</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、调用函数</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">bus_register</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">注册总线。函数原型如下：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*drivers/base/bus.c*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">865 int bus_register(struct bus_type *bus)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> 该调用有可能失败，所以必须检查它的返回值，如果注册成功，会在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus</span>下看到指定名字的总线。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">总线删除时调用：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">/*drivers/base/bus.c*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">946 void bus_unregister(struct bus_type *bus)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">接下来贴个函数：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_1/1st/bus.c*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1 #include</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2 #include</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">3</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">4 #include</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">5</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">6 struct bus_type usb_bus = {<!-- --></span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">7 .name = "usb", //</span>定义总线的名字为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span>，注册成功后将在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus</span>目录下看到</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 }; //</span></span><span style="color:#ff0000; word-wrap:break-word">目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span></span><span style="color:#ff0000; word-wrap:break-word">，如果你的系统已经有<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span></span><span style="color:#ff0000; word-wrap:break-word">总线，那你就要换个名字。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 static int __init usb_bus_init(void)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 int ret;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13 /*</span>总线注册，必须检测返回值<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14 ret = bus_register(&amp;usb_bus);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 if(ret){<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16 printk("bus register failed!\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 return ret;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">20 printk("usb bus init\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">21 return 0;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">22 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">23</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">24 static void __exit usb_bus_exit(void)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">25 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">26 bus_unregister(&amp;usb_bus);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">27 printk("usb bus bye!\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30 module_init(usb_bus_init);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">31 module_exit(usb_bus_exit);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">32</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">33 MODULE_LICENSE("GPL");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">上面的函数可以看到，我<span style="color:#ff0000; word-wrap:break-word">仅仅定义了总线的名字为</span></span><span style="font-family:Times New Roman,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">usb</span></span><span style="font-family:Times New Roman,serif; word-wrap:break-word">，其他的都没有做。看看效果：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# insmod bus.ko</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus init</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# ls /sys/bus/usb/ //sys/bus</span>目录下多了一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span>的目录，但是里面的东西都是空的，</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">devices drivers_autoprobe uevent //</span>因为我仅仅设置了总线的名字</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">drivers drivers_probe</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">总线属性添加和删除：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">个人理解，设置总线的属性后，会在对应的总线目录下增加了一个新的文件，通过对该文件的读写访问，触发相应的函数操作，<span style="color:#ff0000; word-wrap:break-word">从而实现<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/</span></span><span style="color:#ff0000; word-wrap:break-word">的文件接口与内核设备模型的数据交互</span>。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*linux/sysfs.h*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 struct attribute {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29 const char *name; //</span>设定该文件的名字</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30 struct module *owner; //</span>设定该文件的属主</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">31 mode_t mode; //</span>设定该文件的文件操作权限</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">32 };</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*linux/device.h*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">38 struct bus_attribute {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">39 struct attribute attr;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">40 ssize_t (*show)(struct bus_type *bus, char *buf);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">41 ssize_t (*store)(struct bus_type *bus, const char *buf, size_t count);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">42 };</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attribute</span>中有两个函数指针，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">当访问总线目录中的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>文件时，就会触发<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>函数，一般会将指定的信息存放到数组<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">buf</span>，并传到用户空间显示。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">当修改总线目录中的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>文件是，就会触发<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">stroe</span>函数，一般会将从用户空间传来的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">buf</span>指针存放的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">count</span>个字节内容存放到内核中。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">由此可以看到，通过这样的文件，就能实现<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">sys</span>目录下的文件与内核设备模型之间的数据交互。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设置总线属性有两个步骤：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1</span>、创建并初始化<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attribute</span>结构，使用宏<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">BUS_ATTR</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">BUS_ATTR(_name, _mode, _show, _store)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">该宏会定义一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">bus_attr_</span>_name</span>（红色部分是固定的）的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attibute</span>的结构，并且成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_name</span>，文件权限<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">mode</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_mode</span>，两个函数调用分别人<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2</span>、将<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attibute</span>添加到指定的总线上，使用以下调用：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*/drivers/base/bus.c*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">123 int bus_create_file(struct bus_type *bus, struct bus_attribute *attr)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> 该函数失败时返回错误号。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">一旦调用该函数，会就在指定<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus</span>总线的目录下新建一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_name</span>的文件，权限为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_mode</span>，当访问和修改该文件是会分别调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>函数调用。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">如果不需要该属性时，使用以下函数删除：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*/drivers/base/bus.c*/</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">135 void bus_remove_file(struct bus_type *bus, struct bus_attribute *attr)</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">说了这么多，马上来个程序：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_1/2nd/bus.c*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1 #include</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2 #include</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">3</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">4 #include</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">5</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">6 #define VER_SIZE 100</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">7</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 struct bus_type usb_bus = {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9 .name = "usb",</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 };</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 char Version[VER_SIZE] = <span style="color:#ff0000; word-wrap:break-word">"xiaobai V1.0"</span>;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#333333; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14 static ssize_t <span style="color:#ff0000; word-wrap:break-word">show_bus_version</span>(struct bus_type *bus, char *buf)</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16 return snprintf(buf, VER_SIZE, "%s\n", Version);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#333333; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 static ssize_t <span style="color:#ff0000; word-wrap:break-word">store_bus_version</span>(struct bus_type *bus, const char *buf, size_t count)</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">20 return snprintf(Version, VER_SIZE, "%s", buf);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">21 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">22 /*</span>该宏会定义一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attr_version</span>的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attribute</span>的结构，并且成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">23 * version</span>，文件权限<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">mode</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">S_IRUGO|S_IWUGO</span>，并设置<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>函数为</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">24 * show_bus_version</span>，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">stror </span>函数为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">stroe_bus_version*/</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">25 static BUS_ATTR(version, S_IRUGO|S_IWUGO, show_bus_version, store_bus_version);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">26</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">27 static int __init usb_bus_init(void)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29 int ret;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">31 /*</span>总线注册<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">32 ret = bus_register(&amp;usb_bus);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">33 if(ret){<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">34 printk("bus register failed!\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">35 goto err1;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">36 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">37 /*</span>为总线添加属性，调用成功后在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/usb</span>目录下有一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>的文件，权限为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">38 * S_IRUGO|S_IWUGO</span>，查看该文件时会调用函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show_bus_version,</span>修改时调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>。<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">*/</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">39 ret = bus_create_file(&amp;usb_bus, &amp;bus_attr_version);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">40 if(ret){<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">41 printk("bus creat file failed!\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">42 goto err2;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">43 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">44 printk("usb bus init\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">45 return 0;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">46</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">47 err2:</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">48 bus_unregister(&amp;usb_bus);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">49 err1:</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">50 return ret;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">51 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">52</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">53 static void __exit usb_bus_exit(void)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">54 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">55 bus_remove_file(&amp;usb_bus, &amp;bus_attr_version); //</span>不调用这个也可以的，删除总线时会删除</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">56 bus_unregister(&amp;usb_bus);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">57 printk("usb bus bye!\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">58 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">验证一下：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# insmod bus.ko</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus init</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# ls /sys/bus/usb/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">devices drivers_autoprobe uevent</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">drivers drivers_probe <span style="color:#ff0000; word-wrap:break-word">version //</span></span><span style="color:#ff0000; word-wrap:break-word">多了一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span></span><span style="color:#ff0000; word-wrap:break-word">文件</span><span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# ls -l /sys/bus/usb/version <span style="color:#ff0000; word-wrap:break-word">//</span></span><span style="color:#ff0000; word-wrap:break-word">文件的权限的可读可写（<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">S_IRUGO|S_IWUGO</span></span><span style="color:#ff0000; word-wrap:break-word">）</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">-rw-rw-rw- </span>1 root root 4096 Oct 27 23:46 /sys/bus/usb/version</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# cat /sys/bus/usb/version //</span>读文件时触发<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>函数</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xiaobai V1.0</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# echo "haha"&gt; /sys/bus/usb/version //</span>写文件是触发<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>函数</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# cat /sys/bus/usb/version</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">haha</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">三、设备</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">在最底层，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">linux</span>系统中每个设备都用一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device</span>结构的表示，如下，我省略掉部分成员：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*linux/device.h*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">369 struct device {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">370 struct klist klist_children;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">371 struct klist_node knode_parent; /* node in sibling list */</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">372 struct klist_node knode_driver;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">373 struct klist_node knode_bus;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">374 struct device *parent; //</span>指定该设备的父设备，如果不指定<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(NULL)</span>，注册后的设备目录</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">375 ///</span>在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">sys/device</span>下</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">376 struct kobject kobj;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">377 char bus_id[BUS_ID_SIZE]; /* position on parent bus */ //</span>在总线生识别设备的字符串，</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">385 //</span>同时也是设备注册后的目录名字。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">386 struct bus_type *bus; /* type of bus device is on */ //</span>指定该设备连接的总线</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">387 struct device_driver *driver; /* which driver has allocated this</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">388 device */ //</span>管理该设备的驱动函数</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">389 void *driver_data; /* data private to the driver */ //</span>驱动程序的私有数据</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">392 struct dev_pm_info power;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">422 void (*release)(struct device *dev); //</span>当给设备的最后一个引用被删除时，调用该函数</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">423 };</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">在<span style="color:#ff0000; word-wrap:break-word">注册一个完整的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device</span></span><span style="color:#ff0000; word-wrap:break-word">结构前，至少定义<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">parrent</span></span><span style="color:#ff0000; word-wrap:break-word">、<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_id</span></span><span style="color:#ff0000; word-wrap:break-word">、<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus</span></span><span style="color:#ff0000; word-wrap:break-word">和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span></span><span style="color:#ff0000; word-wrap:break-word">成员</span>。但我接下来的程序仅仅定义了<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_id</span>（指定目录的名字）、<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus</span>（对应的总线，不加也行）和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">release</span></span><span style="color:#ff0000; word-wrap:break-word">（这是必须的</span>，不然卸载模块时会出错，不信自己试试）。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">设备注册和注销：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">与总线的注册一样：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1</span>、定义结构体<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device</span>。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2</span>、调用注册函数：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">int device_register(struct device *dev)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> 函数失败返回非零，需要判断返回值来检查注册是否成功。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设备注销函数：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">void device_unregister(struct device *dev)</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">设备属性：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">这个也是和总线属性差不多，不细讲：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设备相关的结构体和总线的类似，处理指定文件属性为，还定义了<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>两个函数。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*linux/device.h*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">300 struct device_attribute {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">301 struct attribute attr;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">302 ssize_t (*show)(struct device *dev, struct device_attribute *attr,</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">303 char *buf);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">304 ssize_t (*store)(struct device *dev, struct device_attribute *attr,</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">305 const char *buf, size_t count);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">306 };</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设置设备属性有两个步骤：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1</span>、创建并初始化<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_attribute</span>结构，使用宏<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">DEVICE_ATTR</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">DEVICE_ATTR(_name, _mode, _show, _store)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">该宏会定义一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">dev_attr_</span>_name</span>（红色部分是固定的）的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_attibute</span>的结构，并且成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_name</span>，文件权限<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">mode</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_mode</span>，两个函数调用分别人<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2</span>、将<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_attibute</span>添加到指定的设备上，使用以下调用：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*drivers/base/core.c*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">430 int device_create_file(struct device *dev, struct device_attribute *attr)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> 该函数失败时返回错误号。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">一旦调用该函数，会就在指定<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">dev</span>设备的目录下新建一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_name</span>的文件，权限为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_mode</span>，当访问和修改该文件是会分别调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>函数调用。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">如果不需要该属性时，使用以下函数删除：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*drivers/base/core.c*/</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">443 void device_remove_file(struct device *dev, struct device_attribute *attr)</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">讲了这么多，来个函数，和总线那个函数差不多，具体功能就是新建了一个执行名字<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(usb_device)</span>的的设备目录，并且里面有一个属性文件<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_1/3rd/device.c*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1 #include</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2 #include</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">3</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">4 #include</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">5</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">6 #define VER_SIZE 100</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">7</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 extern struct bus_type usb_bus;</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#333333; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 void usb_dev_release(struct device *dev)</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#333333; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11 {<!-- --></span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#333333; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 printk(" release\n");</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#333333; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13 }</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#333333; word-wrap:break-word">14</span></span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 struct device usb_device = {<!-- --></span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16 .bus_id = "usb_device",</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 .bus = &amp;usb_bus, //</span>指定该设备的总线，这样会在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">sys/bus/usb/device</span>目录下有一个软连接<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 .release = usb_dev_release, //</span>必须要都有<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span>函数，不然卸载时会出错<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19 };</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 char Version[VER_SIZE] = "xiaobai V1.0";</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14 static ssize_t <span style="color:#ff0000; word-wrap:break-word">show_device_version</span>(struct device *dev,</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 struct device_attribute *attr, char *buf)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 return snprintf(buf, VER_SIZE, "%s\n", Version);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19 static ssize_t <span style="color:#ff0000; word-wrap:break-word">store_device_version(</span>struct device *dev,</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">20 struct device_attribute *attr, const char *buf, size_t count)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">21 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">22 return snprintf(Version, VER_SIZE, "%s", buf);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">23 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">24 /*</span>该宏会定义一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">dev_attr_version</span>的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_attribute</span>的结构，并且成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>设置<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">25 * </span>为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>，文件权限<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">mode</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">S_IRUGO|S_IWUGO</span>，并设置<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>函数为</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">26 *show_device_version, </span>，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">stror</span>函数为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">stroe_device_version*/</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">27 static DEVICE_ATTR(version, S_IRUGO|S_IWUGO,</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 show_device_version, store_device_version);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30 static int __init usb_device_init(void)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">31 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">32 int ret;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">33</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">34 /*</span>设备注册，注册成功后在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">/sys/device</span></span>目录下创建目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_device*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">35 ret = device_register(&amp;usb_device);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">36 if(ret){<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">37 printk("device register failed!\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">38 goto err1;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">39 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">40 /*</span>为设备添加属性，调用成功后在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/device/usb_device/</span>目录下有一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">41 * </span>文件，权限为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">S_IRUG<span style="color:#333333; word-wrap:break-word">O|S_IWUGO</span></span>，查看该文件时会调用函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show_device_version,</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">42 * </span>修改时调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store_device_version</span>。<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">43 ret = device_create_file(&amp;usb_device, &amp;dev_attr_version);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">44 if(ret){<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">45 printk("device creat file failed!\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">46 goto err2;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">47 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">48 printk("usb device init\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">49 return 0;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">50</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">51 err2:</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">52 device_unregister(&amp;usb_device);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">53 err1:</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">54 return ret;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">55 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">56</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">57 static void __exit usb_device_exit(void)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">58 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">59 device_remove_file(&amp;usb_device, &amp;dev_attr_version);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">60 device_unregister(&amp;usb_device);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">61 printk("usb device bye!\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">62 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">63</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">64 module_init(usb_device_init);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">65 module_exit(usb_device_exit);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">再看看效果，这是没有设置总线<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(bus = &amp;usb_bus)</span>时的效果，<span style="color:#ff0000; word-wrap:break-word">代码在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8th_devModule_1/3rd/device_bak.c</span></span><span style="color:#ff0000; word-wrap:break-word">，我没有编译，如果需要的话自己编译运行看看</span>：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3rd]# insmod device.ko</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device init</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# find -name "usb_device" //</span>注册后查找一下在哪里有以设备<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_id</span>为名字的目录</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">.<span style="color:#ff0000; word-wrap:break-word">/sys/devices/usb_device ///sys/device</span></span><span style="color:#ff0000; word-wrap:break-word">下有一个</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]#</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# ls /sys/devices/usb_device/ //</span>里面有一个空文件，一个属性文件<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">uevent version</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# cat /sys/devices/usb_device/version //</span>查看一下<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version,</span>调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">shoe</span>函数</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xiaobai V1.0</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# echo "haha" &gt; /sys/devices/usb_device/version //</span>修改<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>，调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>函数</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# cat /sys/devices/usb_device/version</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">haha</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">下面的是程序<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8th_devModule_1/3rd/device.c</span>的效果：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# cd review_driver/8th_devModule/8th_devModule_1/3rd/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3rd]# insmod bus.ko //</span>先加载总线的模块</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus init</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3rd]# insmod device.ko //</span>再加载设备的模块</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device init</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3rd]# cd /</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# find -name "usb_device" //</span>查找一下<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_device</span>，发现比没有指定总线时多了一个路径</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">./sys/devices/usb_device //</span>这个目录的出现是因为语句（<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">.bus = &amp;usb_bus,</span>）</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">./sys/bus/usb/devices/usb_device //</span>这个目录的出现是因为语句（<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_register(&amp;usb_device);</span>）</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# cat /sys/devices/usb_device/version</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xiaobai V1.0</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# ls -l sys/bus/usb/devices //</span>原来该路径只是一个软连接，是该设备归类到<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_bus</span>总线下</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">lrwxrwxrwx 1 root root 0 Oct 27 13:49 usb_device -&gt; ../../../devices/usb_device</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# rmmod device</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release //</span>下载时调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span>函数调用，如果没有设置<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span>，卸载时会出错。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device bye!</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# rmmod bus</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus bye!</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]#</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">上面的验证需要先加载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus.ko</span>，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus.c</span>源程序和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1st/bus.c</span>的函数没什么区别，只是将<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_bus</span>导出到符号表。不然的话，加载模块时不能找到对应的总线。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">四、驱动程序</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设备模型跟踪所有系统所知道的设备。进行跟踪的主要原因是让驱动程序协调与设备之间的关系。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">先看驱动程序的结构体，我仅仅贴出一些重要的成员：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*linux/device.h*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">122 struct device_driver {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">123 const char *name; //</span>驱动函数的名字，在对应总线的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver</span>目录下显示</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">124 struct bus_type *bus; //</span>指定该驱动程序所操作的总线类型，必须设置，不然会注册失败</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">125</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">126 struct module *owner;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">127 const char *mod_name; /* used for built-in modules */</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">128</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">129 int (*probe) (struct device *dev); //</span>探测函数，以后会讲</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">130 int (*remove) (struct device *dev); //</span>卸载函数，当设备从系统中删除时调用，以后讲</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">131 void (*shutdown) (struct device *dev); //</span>当系统关机是调用</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">132 int (*suspend) (struct device *dev, pm_message_t state);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">133 int (*resume) (struct device *dev);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">134 struct attribute_group **groups;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">135</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">136 struct dev_pm_ops *pm;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">137</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">138 struct driver_private *p;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">139 };</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">和设备不一样的是，在注册驱动函数是必须指定该驱动函数对应的总线</span>，因为驱动函数注册成功后，会存放在对应总线的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver</span>目录下，如果没有总线，注册当然会失败。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">与总线的注册一样：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1</span>、定义结构体<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_driver</span>。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2</span>、调用注册函数：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">214 int driver_register(struct device_driver *drv)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> 函数失败返回非零，需要判断返回值来检查注册是否成功。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设备注销函数：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">249 void driver_unregister(struct device_driver *drv)</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">驱动函数属性：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">这个也是和总线属性差不多，不细讲：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">驱动函数相关的结构体和总线的类似，处理指定文件属性为，还定义了<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>两个函数。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">155 struct driver_attribute {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">156 struct attribute attr;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">157 ssize_t (*show)(struct device_driver *driver, char *buf);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">158 ssize_t (*store)(struct device_driver *driver, const char *buf,</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">159 size_t count);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">160 };</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设置设备属性有两个步骤：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1</span>、创建并初始化<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_attribute</span>结构，使用宏<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">DEVICE_ATTR</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">DRIVER_ATTR(_name, _mode, _show, _store)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">该宏会定义一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">driver_attr_</span>_name</span>（红色部分是固定的）的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver_attibute</span>的结构，并且成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_name</span>，文件权限<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">mode</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_mode</span>，两个函数调用分别人<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2</span>、将<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_attibute</span>添加到指定的驱动函数上，使用以下调用：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*drivers/base/driver.c*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">93 int driver_create_file(struct device_driver *drv, struct driver_attribute *attr)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> 该函数失败时返回错误号。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">一旦调用该函数，会就在指定<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">dev</span>设备的目录下新建一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_name</span>的文件，权限为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_mode</span>，当访问和修改该文件是会分别调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>函数调用。</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">如果不需要该属性时，使用以下函数删除：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*drivers/base/driver.c*/</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">110 void driver_remove_file(struct device_driver *drv, struct driver_attribute *attr)</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">贴上函数：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_1/4th/driver.c*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1 #include</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2 #include</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">3</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">4 #include</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">5</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">6 #define VER_SIZE 100</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">7</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 extern struct bus_type usb_bus;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 struct device_driver usb_driver = {<!-- --></span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11 .name = "usb_driver",</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 .bus = &amp;usb_bus,</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13 };</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 char Version[VER_SIZE] = "xiaobai V1.0";</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 static ssize_t <span style="color:#ff0000; word-wrap:break-word">show_driver_version</span>(struct device_driver *drv, char *buf)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19 return snprintf(buf, VER_SIZE, "%s\n", Version);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">20 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">21 static ssize_t <span style="color:#ff0000; word-wrap:break-word">store_driver_version</span>(struct device_driver *drv,</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">22 const char *buf, size_t count)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">23 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">24 return snprintf(Version, VER_SIZE, "%s", buf);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">25 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">26 /*</span>该宏会定义一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver_attr_version</span>的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver_attribute</span>的结构，并且成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">27 * name</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>，文件权限<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">mode</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">S_IRUGO|S_IWUGO</span>，并设置<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>函数为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 * show_driver_version,stror</span>函数为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">stroe_driver_version*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29 static DRIVER_ATTR(version, S_IRUGO|S_IWUGO,</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30 show_driver_version, store_driver_version);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">31</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">32 static int __init usb_driver_init(void)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">33 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">34 int ret;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">35</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">36 /*</span>驱动注册，注册成功后在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/usb/driver</span>目录下创建目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_driver*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">37 ret = driver_register(&amp;usb_driver);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">38 if(ret){<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">39 printk("driver register failed!\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">40 goto err1;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">41 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">42 /*</span>为驱动添加属性，调用成功后在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/usb/dirver</span>目录下有一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">43 * </span>文件，权限为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">S_IRUGO|S_IWUGO</span>，查看该文件时会调用函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show_driver_version,</span>修改时<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">44 * </span>调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store_driver_version</span>。<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">*/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">45 ret = driver_create_file(&amp;usb_driver, &amp;driver_attr_version);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">46 if(ret){<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">47 printk("driver creat file failed!\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">48 goto err2;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">49 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">50 printk("usb driver init\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">51 return 0;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">52</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">53 err2:</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">54 driver_unregister(&amp;usb_driver);</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">55 err1:</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">56 return ret;</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">57 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">58</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">59 static void __exit usb_driver_exit(void)</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">60 {<!-- --></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">61 driver_remove_file(&amp;usb_driver, &amp;driver_attr_version);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">62 driver_unregister(&amp;usb_driver);</span></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">63 printk("usb driver bye!\n");</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">64 }</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">看看效果，同样必须先加载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus.ko</span>：</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# cd review_driver/8th_devModule/8th_devModule_1/4th/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 4th]# insmod bus.ko //</span>必须先加载总线</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus init</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 4th]# insmod driver.ko</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb driver init</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 4th]# cd /</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# find -name "usb_driver" //</span>只有一处创建了<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_driver</span>目录</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">./sys/bus/usb/drivers/usb_driver</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# ls /sys/bus/usb/drivers/usb_driver/</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bind uevent unbind version</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">[root: /]# cat /sys/bus/usb/drivers/usb_driver/version //</span></span><span style="color:#ff0000; word-wrap:break-word">访问<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span></span><span style="color:#ff0000; word-wrap:break-word">文件是触发<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span></span><span style="color:#ff0000; word-wrap:break-word">函数</span><span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xiaobai V1.0</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 五、总结</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 这节讲得内容其实不多，归纳起来就是<span style="color:#ff0000; word-wrap:break-word">四个函数一个属性结构体</span>。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 属性结构体：<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xx_attribute</span>。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 注册函数：<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xx_register</span>。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 注销函数：<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xx+unregister</span>。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 创建属性文件函数：<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xx_create_file</span>。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 删除属性文件函数：<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xx_remove_file</span>。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 其中<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xx</span>可以是总线<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(bus)</span>、设备<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(device)</span>或者驱动函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(deriver)</span>。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 一但注册成功，就会在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys</span>目录下相应的地方创建一个自己命名的目录。其中，设备和驱动函数还可以添加到指定的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus</span>目录下。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 总线的成功注册后会在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus</span>目录下创建相应的目录。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 设备的成功注册后会在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/device</span>目录下创建相应的目录，如果指定总线，会在指定总线目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/xx/device</span>下创建一个指向<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/device</span>目录的软连接。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 驱动函数的公共注册会在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/xx/driver</span>目录下创建相应的目录。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 属性文件提供了<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">shoe</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>两个函数调用，当读写文件时会触发相应的函数调用，实现内核<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">sysfs</span>与用户空间的数据交互。</p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
<p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 三者具体的关系就在后面章节介绍。</p> 
<div style="top:0px"> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">一、</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">sysfs</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">文件系统</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">设备模型是</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">2.6</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">内核新引入的特征。设备模型提供了一个独立的机制专门来表示设备，并描述其在系统中的拓扑结构。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">在</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">2.4</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">内核中，设备的信息放在</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">/proc</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">中。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">而在</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">2.6</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">内核，内核把设备相关的信息归类在新增加</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">sysfs</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">文件系统，并将它挂载到</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">/sys</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">目录中，把设备信息归类的同时，让用户可以通过用户空间访问。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">接下来简单介绍一些</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">sys</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">中的目录：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">block</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：用于管理块设备，系统中的每一个块设备会在该目录下对应一个子目录。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">bus</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：用于管理总线，没注册一条总线，在该目录下有一个对应的子目录。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word"></span><span style="font-family:Times New Roman,serif; word-wrap:break-word">其中，每个总线子目录下会有两个子目录：</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">devices</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">和</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">drivers</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">devices</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">包含里系统中所有属于该总线的的设备。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">drivers</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">包含里系统中所有属于该总线的的驱动。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">class</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：将系统中的设备按功能分类。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">devices</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：该目录提供了系统中设备拓扑结构图。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">dev</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：该目录已注册的设备节点的视图。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">kernel</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：内核中的相关参数。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">module</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：内核中的模块信息。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">fireware</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：内核中的固件信息。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">Fs</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">：描述内核中的文件系统。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:Times New Roman,serif; word-wrap:break-word">上面的目录，接下来的章节会常常提起</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">bus</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">和</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">device</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">。</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">再说说这些目录</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">,</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">来个简单的命令：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">root@xiaobai-laptop:/sys# ll class/net/eth0</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">lrwxrwxrwx 1 root root 0 2011-01-31 10:11 class/net/eth0 -&gt; ../../devices/pci0000:00/0000:00:1c.5/0000:86:00.0/net/eth0/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">上面的命令也可以看到</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">class/net/eth0</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">的路径其实就是</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">devices</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">目录中一个网卡设备的<span style="color:#ff0000; word-wrap:break-word">软连接</span>。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">贴个书上的图：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <a target="_blank" href="http://blog.chinaunix.net/attachment/201102/1/25014876_1296562467cFAa.png" rel="nofollow noopener noreferrer" style="word-wrap:break-word; text-decoration:none; color:rgb(25,89,155)"><img src="https://images2.imgbox.com/88/fc/9Y5c5AS3_o.png" border="0" alt="" style="word-wrap:break-word; border:0px"></a></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">由上面两个例子看到，</span></span><span style="font-family:Times New Roman,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">sys</span></span><span style="font-family:Times New Roman,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">中的其他目录都是将</span></span><span style="font-family:Times New Roman,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">devvice</span></span><span style="font-family:Times New Roman,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">目录下的数据加以转换加工而得</span>。上面的图中，将</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">use</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">设备归类到</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">bus</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">总线上，又把它归类到</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">class</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">。正是在</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">sys</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">中有很多这样的结构，内核就有一个完整而且复杂的拓扑结构图。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:Times New Roman,serif; word-wrap:break-word">而维护这些关系的结构体就包括</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">kobject</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">kset</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">ktype</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">和</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">subsystem</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">等数据结构，不过这里就先不介绍。</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">通过设备模型，内核就能实现多种不同的任务，如：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">1</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、电源管理和系统关机。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">2</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、与用户空间通信。这个就比较容易理解，</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">sys</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">目录向用户展示了设备模型的结构图。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">3</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、热插拔设备。大概意思就是，当设备插入后，内核会根据插入的设备安装驱动，设备拔出后，内核又会自动卸载驱动。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">4</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、设备类型。将设备归类。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">在接下来的内容会简单介绍总线、设备和驱动程序的概念和函数调用，以下的函数我将<span style="color:#ff0000; word-wrap:break-word">模拟</span>创建一条</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">ubs</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">总线，一个</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">usb</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">设备和一个</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">usb</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">驱动。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">二、总线</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">总线是处理器和设备之间的通道，在设备模型中，所有的设备都通过总线相连，<span style="color:#ff0000; word-wrap:break-word">以总线来管理设备和驱动函数</span>。总线有</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">bus_type</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">结构表示。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*linux/device.h*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">51 struct bus_type {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">52 const char *name;</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">53 struct bus_attribute *bus_attrs;</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">54 struct device_attribute *dev_attrs;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">55 struct driver_attribute *drv_attrs;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">56</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">57 int (*match)(struct device *dev, struct device_driver *drv);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">58 int (*uevent)(struct device *dev, struct kobj_uevent_env *env);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">59 int (*probe)(struct device *dev);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">60 int (*remove)(struct device *dev);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">61 void (*shutdown)(struct device *dev);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">62</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">63 int (*suspend)(struct device *dev, pm_message_t state);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">64 int (*suspend_late)(struct device *dev, pm_message_t state);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">65 int (*resume_early)(struct device *dev);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">66 int (*resume)(struct device *dev);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">67</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">68 struct dev_pm_ops *pm;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">69</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">70 struct bus_type_private *p;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">71 };</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 红色部分是以后将会介绍的成员，其中<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>是总线的名<span style="color:#333333; word-wrap:break-word">字， <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attrs</span></span><span style="color:#333333; word-wrap:break-word">是总线的属性，那些函数指针的操作总线的方法，在这一章节先不讲总线的方法。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:Times New Roman,serif; word-wrap:break-word">总线的注册和删除：</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">总线的注册有两个步骤：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">1</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、定义一个</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">bus_type</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">结构体，并设置好需要设置的结构体成员。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">2</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">、调用函数</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">bus_register</span><span style="font-family:Times New Roman,serif; word-wrap:break-word">注册总线。函数原型如下：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*drivers/base/bus.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">865 int bus_register(struct bus_type *bus)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> 该调用有可能失败，所以必须检查它的返回值，如果注册成功，会在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus</span>下看到指定名字的总线。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">总线删除时调用：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">/*drivers/base/bus.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">946 void bus_unregister(struct bus_type *bus)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">接下来贴个函数：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_1/1st/bus.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1 #include</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2 #include</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">3</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">4 #include</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">5</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">6 struct bus_type usb_bus = {<!-- --></span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">7 .name = "usb", //</span>定义总线的名字为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span>，注册成功后将在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus</span>目录下看到</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 }; //</span></span><span style="color:#ff0000; word-wrap:break-word">目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span></span><span style="color:#ff0000; word-wrap:break-word">，如果你的系统已经有<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span></span><span style="color:#ff0000; word-wrap:break-word">总线，那你就要换个名字。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 static int __init usb_bus_init(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 int ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13 /*</span>总线注册，必须检测返回值<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14 ret = bus_register(&amp;usb_bus);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 if(ret){<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16 printk("bus register failed!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 return ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">20 printk("usb bus init\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">21 return 0;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">22 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">23</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">24 static void __exit usb_bus_exit(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">25 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">26 bus_unregister(&amp;usb_bus);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">27 printk("usb bus bye!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30 module_init(usb_bus_init);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">31 module_exit(usb_bus_exit);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">32</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">33 MODULE_LICENSE("GPL");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:Times New Roman,serif; word-wrap:break-word">上面的函数可以看到，我<span style="color:#ff0000; word-wrap:break-word">仅仅定义了总线的名字为</span></span><span style="font-family:Times New Roman,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">usb</span></span><span style="font-family:Times New Roman,serif; word-wrap:break-word">，其他的都没有做。看看效果：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# insmod bus.ko</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# ls /sys/bus/usb/ //sys/bus</span>目录下多了一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span>的目录，但是里面的东西都是空的，</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">devices drivers_autoprobe uevent //</span>因为我仅仅设置了总线的名字</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">drivers drivers_probe</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">总线属性添加和删除：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">个人理解，设置总线的属性后，会在对应的总线目录下增加了一个新的文件，通过对该文件的读写访问，触发相应的函数操作，<span style="color:#ff0000; word-wrap:break-word">从而实现<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/</span></span><span style="color:#ff0000; word-wrap:break-word">的文件接口与内核设备模型的数据交互</span>。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*linux/sysfs.h*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 struct attribute {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29 const char *name; //</span>设定该文件的名字</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30 struct module *owner; //</span>设定该文件的属主</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">31 mode_t mode; //</span>设定该文件的文件操作权限</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">32 };</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*linux/device.h*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">38 struct bus_attribute {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">39 struct attribute attr;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">40 ssize_t (*show)(struct bus_type *bus, char *buf);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">41 ssize_t (*store)(struct bus_type *bus, const char *buf, size_t count);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">42 };</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attribute</span>中有两个函数指针，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">当访问总线目录中的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>文件时，就会触发<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>函数，一般会将指定的信息存放到数组<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">buf</span>，并传到用户空间显示。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">当修改总线目录中的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>文件是，就会触发<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">stroe</span>函数，一般会将从用户空间传来的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">buf</span>指针存放的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">count</span>个字节内容存放到内核中。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">由此可以看到，通过这样的文件，就能实现<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">sys</span>目录下的文件与内核设备模型之间的数据交互。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设置总线属性有两个步骤：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1</span>、创建并初始化<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attribute</span>结构，使用宏<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">BUS_ATTR</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">BUS_ATTR(_name, _mode, _show, _store)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">该宏会定义一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">bus_attr_</span>_name</span>（红色部分是固定的）的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attibute</span>的结构，并且成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_name</span>，文件权限<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">mode</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_mode</span>，两个函数调用分别人<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2</span>、将<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attibute</span>添加到指定的总线上，使用以下调用：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*/drivers/base/bus.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">123 int bus_create_file(struct bus_type *bus, struct bus_attribute *attr)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> 该函数失败时返回错误号。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">一旦调用该函数，会就在指定<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus</span>总线的目录下新建一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_name</span>的文件，权限为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_mode</span>，当访问和修改该文件是会分别调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>函数调用。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">如果不需要该属性时，使用以下函数删除：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*/drivers/base/bus.c*/</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">135 void bus_remove_file(struct bus_type *bus, struct bus_attribute *attr)</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">说了这么多，马上来个程序：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_1/2nd/bus.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1 #include</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2 #include</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">3</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">4 #include</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">5</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">6 #define VER_SIZE 100</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">7</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 struct bus_type usb_bus = {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9 .name = "usb",</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 };</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 char Version[VER_SIZE] = <span style="color:#ff0000; word-wrap:break-word">"xiaobai V1.0"</span>;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#333333; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14 static ssize_t <span style="color:#ff0000; word-wrap:break-word">show_bus_version</span>(struct bus_type *bus, char *buf)</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16 return snprintf(buf, VER_SIZE, "%s\n", Version);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#333333; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 static ssize_t <span style="color:#ff0000; word-wrap:break-word">store_bus_version</span>(struct bus_type *bus, const char *buf, size_t count)</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">20 return snprintf(Version, VER_SIZE, "%s", buf);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">21 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">22 /*</span>该宏会定义一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attr_version</span>的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_attribute</span>的结构，并且成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">23 * version</span>，文件权限<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">mode</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">S_IRUGO|S_IWUGO</span>，并设置<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>函数为</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">24 * show_bus_version</span>，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">stror </span>函数为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">stroe_bus_version*/</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">25 static BUS_ATTR(version, S_IRUGO|S_IWUGO, show_bus_version, store_bus_version);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">26</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">27 static int __init usb_bus_init(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29 int ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">31 /*</span>总线注册<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">32 ret = bus_register(&amp;usb_bus);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">33 if(ret){<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">34 printk("bus register failed!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">35 goto err1;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">36 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">37 /*</span>为总线添加属性，调用成功后在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/usb</span>目录下有一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>的文件，权限为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">38 * S_IRUGO|S_IWUGO</span>，查看该文件时会调用函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show_bus_version,</span>修改时调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>。<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">*/</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">39 ret = bus_create_file(&amp;usb_bus, &amp;bus_attr_version);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">40 if(ret){<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">41 printk("bus creat file failed!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">42 goto err2;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">43 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">44 printk("usb bus init\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">45 return 0;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">46</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">47 err2:</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">48 bus_unregister(&amp;usb_bus);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">49 err1:</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">50 return ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">51 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">52</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">53 static void __exit usb_bus_exit(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">54 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">55 bus_remove_file(&amp;usb_bus, &amp;bus_attr_version); //</span>不调用这个也可以的，删除总线时会删除</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">56 bus_unregister(&amp;usb_bus);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">57 printk("usb bus bye!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">58 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">验证一下：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# insmod bus.ko</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# ls /sys/bus/usb/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">devices drivers_autoprobe uevent</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">drivers drivers_probe <span style="color:#ff0000; word-wrap:break-word">version //</span></span><span style="color:#ff0000; word-wrap:break-word">多了一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span></span><span style="color:#ff0000; word-wrap:break-word">文件</span><span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# ls -l /sys/bus/usb/version <span style="color:#ff0000; word-wrap:break-word">//</span></span><span style="color:#ff0000; word-wrap:break-word">文件的权限的可读可写（<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">S_IRUGO|S_IWUGO</span></span><span style="color:#ff0000; word-wrap:break-word">）</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">-rw-rw-rw- </span>1 root root 4096 Oct 27 23:46 /sys/bus/usb/version</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# cat /sys/bus/usb/version //</span>读文件时触发<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>函数</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xiaobai V1.0</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# echo "haha"&gt; /sys/bus/usb/version //</span>写文件是触发<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>函数</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# cat /sys/bus/usb/version</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">haha</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">三、设备</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">在最底层，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">linux</span>系统中每个设备都用一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device</span>结构的表示，如下，我省略掉部分成员：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*linux/device.h*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">369 struct device {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">370 struct klist klist_children;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">371 struct klist_node knode_parent; /* node in sibling list */</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">372 struct klist_node knode_driver;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">373 struct klist_node knode_bus;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">374 struct device *parent; //</span>指定该设备的父设备，如果不指定<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(NULL)</span>，注册后的设备目录</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">375 ///</span>在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">sys/device</span>下</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">376 struct kobject kobj;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">377 char bus_id[BUS_ID_SIZE]; /* position on parent bus */ //</span>在总线生识别设备的字符串，</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">385 //</span>同时也是设备注册后的目录名字。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">386 struct bus_type *bus; /* type of bus device is on */ //</span>指定该设备连接的总线</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">387 struct device_driver *driver; /* which driver has allocated this</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">388 device */ //</span>管理该设备的驱动函数</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">389 void *driver_data; /* data private to the driver */ //</span>驱动程序的私有数据</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">392 struct dev_pm_info power;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">422 void (*release)(struct device *dev); //</span>当给设备的最后一个引用被删除时，调用该函数</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">423 };</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">在<span style="color:#ff0000; word-wrap:break-word">注册一个完整的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device</span></span><span style="color:#ff0000; word-wrap:break-word">结构前，至少定义<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">parrent</span></span><span style="color:#ff0000; word-wrap:break-word">、<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_id</span></span><span style="color:#ff0000; word-wrap:break-word">、<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus</span></span><span style="color:#ff0000; word-wrap:break-word">和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span></span><span style="color:#ff0000; word-wrap:break-word">成员</span>。但我接下来的程序仅仅定义了<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_id</span>（指定目录的名字）、<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus</span>（对应的总线，不加也行）和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">release</span></span><span style="color:#ff0000; word-wrap:break-word">（这是必须的</span>，不然卸载模块时会出错，不信自己试试）。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">设备注册和注销：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">与总线的注册一样：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1</span>、定义结构体<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device</span>。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2</span>、调用注册函数：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">int device_register(struct device *dev)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> 函数失败返回非零，需要判断返回值来检查注册是否成功。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设备注销函数：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">void device_unregister(struct device *dev)</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">设备属性：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">这个也是和总线属性差不多，不细讲：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设备相关的结构体和总线的类似，处理指定文件属性为，还定义了<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>两个函数。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*linux/device.h*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">300 struct device_attribute {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">301 struct attribute attr;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">302 ssize_t (*show)(struct device *dev, struct device_attribute *attr,</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">303 char *buf);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">304 ssize_t (*store)(struct device *dev, struct device_attribute *attr,</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">305 const char *buf, size_t count);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">306 };</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设置设备属性有两个步骤：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1</span>、创建并初始化<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_attribute</span>结构，使用宏<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">DEVICE_ATTR</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">DEVICE_ATTR(_name, _mode, _show, _store)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">该宏会定义一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">dev_attr_</span>_name</span>（红色部分是固定的）的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_attibute</span>的结构，并且成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_name</span>，文件权限<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">mode</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_mode</span>，两个函数调用分别人<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2</span>、将<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_attibute</span>添加到指定的设备上，使用以下调用：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*drivers/base/core.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">430 int device_create_file(struct device *dev, struct device_attribute *attr)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> 该函数失败时返回错误号。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">一旦调用该函数，会就在指定<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">dev</span>设备的目录下新建一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_name</span>的文件，权限为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_mode</span>，当访问和修改该文件是会分别调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>函数调用。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">如果不需要该属性时，使用以下函数删除：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*drivers/base/core.c*/</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">443 void device_remove_file(struct device *dev, struct device_attribute *attr)</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">讲了这么多，来个函数，和总线那个函数差不多，具体功能就是新建了一个执行名字<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(usb_device)</span>的的设备目录，并且里面有一个属性文件<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_1/3rd/device.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1 #include</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2 #include</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">3</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">4 #include</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">5</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">6 #define VER_SIZE 100</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">7</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 extern struct bus_type usb_bus;</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#333333; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 void usb_dev_release(struct device *dev)</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#333333; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11 {<!-- --></span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#333333; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 printk(" release\n");</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#333333; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13 }</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#333333; word-wrap:break-word">14</span></span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 struct device usb_device = {<!-- --></span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16 .bus_id = "usb_device",</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 .bus = &amp;usb_bus, //</span>指定该设备的总线，这样会在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">sys/bus/usb/device</span>目录下有一个软连接<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 .release = usb_dev_release, //</span>必须要都有<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span>函数，不然卸载时会出错<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19 };</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 char Version[VER_SIZE] = "xiaobai V1.0";</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14 static ssize_t <span style="color:#ff0000; word-wrap:break-word">show_device_version</span>(struct device *dev,</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 struct device_attribute *attr, char *buf)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 return snprintf(buf, VER_SIZE, "%s\n", Version);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19 static ssize_t <span style="color:#ff0000; word-wrap:break-word">store_device_version(</span>struct device *dev,</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">20 struct device_attribute *attr, const char *buf, size_t count)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">21 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">22 return snprintf(Version, VER_SIZE, "%s", buf);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">23 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">24 /*</span>该宏会定义一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">dev_attr_version</span>的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_attribute</span>的结构，并且成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>设置<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">25 * </span>为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>，文件权限<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">mode</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">S_IRUGO|S_IWUGO</span>，并设置<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>函数为</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">26 *show_device_version, </span>，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">stror</span>函数为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">stroe_device_version*/</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">27 static DEVICE_ATTR(version, S_IRUGO|S_IWUGO,</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 show_device_version, store_device_version);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30 static int __init usb_device_init(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">31 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">32 int ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">33</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">34 /*</span>设备注册，注册成功后在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">/sys/device</span></span>目录下创建目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_device*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">35 ret = device_register(&amp;usb_device);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">36 if(ret){<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">37 printk("device register failed!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">38 goto err1;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">39 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">40 /*</span>为设备添加属性，调用成功后在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/device/usb_device/</span>目录下有一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">41 * </span>文件，权限为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">S_IRUG<span style="color:#333333; word-wrap:break-word">O|S_IWUGO</span></span>，查看该文件时会调用函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show_device_version,</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">42 * </span>修改时调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store_device_version</span>。<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">43 ret = device_create_file(&amp;usb_device, &amp;dev_attr_version);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">44 if(ret){<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">45 printk("device creat file failed!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">46 goto err2;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">47 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">48 printk("usb device init\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">49 return 0;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">50</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">51 err2:</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">52 device_unregister(&amp;usb_device);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">53 err1:</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">54 return ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">55 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">56</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">57 static void __exit usb_device_exit(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">58 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">59 device_remove_file(&amp;usb_device, &amp;dev_attr_version);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">60 device_unregister(&amp;usb_device);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">61 printk("usb device bye!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">62 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">63</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">64 module_init(usb_device_init);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">65 module_exit(usb_device_exit);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">再看看效果，这是没有设置总线<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(bus = &amp;usb_bus)</span>时的效果，<span style="color:#ff0000; word-wrap:break-word">代码在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8th_devModule_1/3rd/device_bak.c</span></span><span style="color:#ff0000; word-wrap:break-word">，我没有编译，如果需要的话自己编译运行看看</span>：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3rd]# insmod device.ko</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# find -name "usb_device" //</span>注册后查找一下在哪里有以设备<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_id</span>为名字的目录</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">.<span style="color:#ff0000; word-wrap:break-word">/sys/devices/usb_device ///sys/device</span></span><span style="color:#ff0000; word-wrap:break-word">下有一个</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]#</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# ls /sys/devices/usb_device/ //</span>里面有一个空文件，一个属性文件<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">uevent version</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# cat /sys/devices/usb_device/version //</span>查看一下<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version,</span>调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">shoe</span>函数</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xiaobai V1.0</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# echo "haha" &gt; /sys/devices/usb_device/version //</span>修改<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>，调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>函数</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# cat /sys/devices/usb_device/version</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">haha</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">下面的是程序<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8th_devModule_1/3rd/device.c</span>的效果：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# cd review_driver/8th_devModule/8th_devModule_1/3rd/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3rd]# insmod bus.ko //</span>先加载总线的模块</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3rd]# insmod device.ko //</span>再加载设备的模块</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3rd]# cd /</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# find -name "usb_device" //</span>查找一下<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_device</span>，发现比没有指定总线时多了一个路径</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">./sys/devices/usb_device //</span>这个目录的出现是因为语句（<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">.bus = &amp;usb_bus,</span>）</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">./sys/bus/usb/devices/usb_device //</span>这个目录的出现是因为语句（<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_register(&amp;usb_device);</span>）</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# cat /sys/devices/usb_device/version</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xiaobai V1.0</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# ls -l sys/bus/usb/devices //</span>原来该路径只是一个软连接，是该设备归类到<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_bus</span>总线下</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">lrwxrwxrwx 1 root root 0 Oct 27 13:49 usb_device -&gt; ../../../devices/usb_device</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# rmmod device</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release //</span>下载时调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span>函数调用，如果没有设置<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span>，卸载时会出错。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device bye!</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# rmmod bus</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus bye!</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]#</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">上面的验证需要先加载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus.ko</span>，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus.c</span>源程序和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1st/bus.c</span>的函数没什么区别，只是将<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_bus</span>导出到符号表。不然的话，加载模块时不能找到对应的总线。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">四、驱动程序</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设备模型跟踪所有系统所知道的设备。进行跟踪的主要原因是让驱动程序协调与设备之间的关系。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">先看驱动程序的结构体，我仅仅贴出一些重要的成员：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*linux/device.h*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">122 struct device_driver {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">123 const char *name; //</span>驱动函数的名字，在对应总线的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver</span>目录下显示</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">124 struct bus_type *bus; //</span>指定该驱动程序所操作的总线类型，必须设置，不然会注册失败</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">125</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">126 struct module *owner;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">127 const char *mod_name; /* used for built-in modules */</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">128</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">129 int (*probe) (struct device *dev); //</span>探测函数，以后会讲</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">130 int (*remove) (struct device *dev); //</span>卸载函数，当设备从系统中删除时调用，以后讲</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">131 void (*shutdown) (struct device *dev); //</span>当系统关机是调用</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">132 int (*suspend) (struct device *dev, pm_message_t state);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">133 int (*resume) (struct device *dev);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">134 struct attribute_group **groups;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">135</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">136 struct dev_pm_ops *pm;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">137</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">138 struct driver_private *p;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">139 };</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">和设备不一样的是，在注册驱动函数是必须指定该驱动函数对应的总线</span>，因为驱动函数注册成功后，会存放在对应总线的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver</span>目录下，如果没有总线，注册当然会失败。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">与总线的注册一样：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1</span>、定义结构体<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_driver</span>。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2</span>、调用注册函数：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">214 int driver_register(struct device_driver *drv)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> 函数失败返回非零，需要判断返回值来检查注册是否成功。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设备注销函数：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">249 void driver_unregister(struct device_driver *drv)</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">驱动函数属性：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">这个也是和总线属性差不多，不细讲：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">驱动函数相关的结构体和总线的类似，处理指定文件属性为，还定义了<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>两个函数。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">155 struct driver_attribute {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">156 struct attribute attr;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">157 ssize_t (*show)(struct device_driver *driver, char *buf);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">158 ssize_t (*store)(struct device_driver *driver, const char *buf,</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">159 size_t count);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">160 };</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">设置设备属性有两个步骤：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1</span>、创建并初始化<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_attribute</span>结构，使用宏<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">DEVICE_ATTR</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">DRIVER_ATTR(_name, _mode, _show, _store)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">该宏会定义一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">driver_attr_</span>_name</span>（红色部分是固定的）的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver_attibute</span>的结构，并且成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_name</span>，文件权限<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">mode</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_mode</span>，两个函数调用分别人<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2</span>、将<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_attibute</span>添加到指定的驱动函数上，使用以下调用：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*drivers/base/driver.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">93 int driver_create_file(struct device_driver *drv, struct driver_attribute *attr)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> 该函数失败时返回错误号。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">一旦调用该函数，会就在指定<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">dev</span>设备的目录下新建一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_name</span>的文件，权限为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">_mode</span>，当访问和修改该文件是会分别调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>函数调用。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">如果不需要该属性时，使用以下函数删除：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*drivers/base/driver.c*/</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#000000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">110 void driver_remove_file(struct device_driver *drv, struct driver_attribute *attr)</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">贴上函数：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_1/4th/driver.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1 #include</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2 #include</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">3</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">4 #include</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">5</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">6 #define VER_SIZE 100</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">7</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 extern struct bus_type usb_bus;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 struct device_driver usb_driver = {<!-- --></span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11 .name = "usb_driver",</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 .bus = &amp;usb_bus,</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13 };</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 char Version[VER_SIZE] = "xiaobai V1.0";</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 static ssize_t <span style="color:#ff0000; word-wrap:break-word">show_driver_version</span>(struct device_driver *drv, char *buf)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19 return snprintf(buf, VER_SIZE, "%s\n", Version);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">20 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">21 static ssize_t <span style="color:#ff0000; word-wrap:break-word">store_driver_version</span>(struct device_driver *drv,</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">22 const char *buf, size_t count)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">23 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">24 return snprintf(Version, VER_SIZE, "%s", buf);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">25 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">26 /*</span>该宏会定义一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver_attr_version</span>的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver_attribute</span>的结构，并且成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">27 * name</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>，文件权限<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">mode</span>设置为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">S_IRUGO|S_IWUGO</span>，并设置<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span>函数为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 * show_driver_version,stror</span>函数为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">stroe_driver_version*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29 static DRIVER_ATTR(version, S_IRUGO|S_IWUGO,</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30 show_driver_version, store_driver_version);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">31</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">32 static int __init usb_driver_init(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">33 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">34 int ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">35</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">36 /*</span>驱动注册，注册成功后在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/usb/driver</span>目录下创建目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_driver*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">37 ret = driver_register(&amp;usb_driver);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">38 if(ret){<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">39 printk("driver register failed!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">40 goto err1;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">41 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">42 /*</span>为驱动添加属性，调用成功后在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/usb/dirver</span>目录下有一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span>的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">43 * </span>文件，权限为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">S_IRUGO|S_IWUGO</span>，查看该文件时会调用函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show_driver_version,</span>修改时<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">44 * </span>调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store_driver_version</span>。<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">45 ret = driver_create_file(&amp;usb_driver, &amp;driver_attr_version);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">46 if(ret){<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">47 printk("driver creat file failed!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">48 goto err2;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">49 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">50 printk("usb driver init\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">51 return 0;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">52</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">53 err2:</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">54 driver_unregister(&amp;usb_driver);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">55 err1:</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">56 return ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">57 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">58</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">59 static void __exit usb_driver_exit(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">60 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">61 driver_remove_file(&amp;usb_driver, &amp;driver_attr_version);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">62 driver_unregister(&amp;usb_driver);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">63 printk("usb driver bye!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">64 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#000000; word-wrap:break-word">看看效果，同样必须先加载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus.ko</span>：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# cd review_driver/8th_devModule/8th_devModule_1/4th/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 4th]# insmod bus.ko //</span>必须先加载总线</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 4th]# insmod driver.ko</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb driver init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 4th]# cd /</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# find -name "usb_driver" //</span>只有一处创建了<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_driver</span>目录</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">./sys/bus/usb/drivers/usb_driver</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# ls /sys/bus/usb/drivers/usb_driver/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bind uevent unbind version</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">[root: /]# cat /sys/bus/usb/drivers/usb_driver/version //</span></span><span style="color:#ff0000; word-wrap:break-word">访问<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">version</span></span><span style="color:#ff0000; word-wrap:break-word">文件是触发<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">show</span></span><span style="color:#ff0000; word-wrap:break-word">函数</span><span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xiaobai V1.0</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 五、总结</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 这节讲得内容其实不多，归纳起来就是<span style="color:#ff0000; word-wrap:break-word">四个函数一个属性结构体</span>。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 属性结构体：<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xx_attribute</span>。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 注册函数：<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xx_register</span>。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 注销函数：<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xx+unregister</span>。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 创建属性文件函数：<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xx_create_file</span>。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 删除属性文件函数：<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xx_remove_file</span>。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 其中<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xx</span>可以是总线<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(bus)</span>、设备<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(device)</span>或者驱动函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(deriver)</span>。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 一但注册成功，就会在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys</span>目录下相应的地方创建一个自己命名的目录。其中，设备和驱动函数还可以添加到指定的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus</span>目录下。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 总线的成功注册后会在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus</span>目录下创建相应的目录。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 设备的成功注册后会在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/device</span>目录下创建相应的目录，如果指定总线，会在指定总线目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/xx/device</span>下创建一个指向<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/device</span>目录的软连接。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 驱动函数的公共注册会在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/xx/driver</span>目录下创建相应的目录。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 属性文件提供了<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">shoe</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">store</span>两个函数调用，当读写文件时会触发相应的函数调用，实现内核<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">sysfs</span>与用户空间的数据交互。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 三者具体的关系就在后面章节介绍。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 一、总线、设备和驱动函数在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/</span>中的框架</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 首先要写三个函数，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus.c</span>、<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device.c</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver.c</span>。这几个函数其实就是上一节函数的精简版，去掉属性文件的创建，仅仅保留创建和注销操作。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 第一个函数是<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus.c</span>，加载模块会创建了一条名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span>的总线，总线目录放在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/</span>目录下：</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_2/1st/bus.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">6 struct bus_type usb_bus = {<!-- --></span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">7 .name = "usb",         //</span>注册成功后将在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus</span>目录下看到目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 };</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 static int __init usb_bus_init(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 int ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13 /*</span>总线注册，必须检测返回值<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14 ret = bus_register(&amp;usb_bus);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 if(ret){<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16 printk("bus register failed!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 return ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">20 printk("usb bus init\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">21 return 0;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">22 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">23</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">24 static void __exit usb_bus_exit(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">25 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">26 bus_unregister(&amp;usb_bus);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">27 printk("usb bus bye!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 第二个函数是<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device.c</span>，加载模块会创建目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/device/usb_device</span>来管理这个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span>设备。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 由于该设备指定了所属的总线是<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_bus</span>，所有会在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/usb/device</span>目录下创建一了指向<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_device</span>的软连接。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 同时，在卸载模块时，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_deivce</span>被删除，内核自动调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span>函数，现实当中<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span>函数应该做一些卸载设备的相关操作，但是我的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span>设备是我虚拟出来的，所以<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span>函数只是打印了一句话。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_2/1st/device.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">5 extern struct bus_type usb_bus;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">6</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">7 void usb_dev_release(struct device *dev) //</span>卸载函数没有干具体的事情</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9 printk(" release\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 struct device usb_device = {<!-- --></span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13 .bus_id = "usb_device",</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14 .bus = &amp;usb_bus,                   //</span>指定该设备的总线<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">,</span>在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/usb</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 .release = usb_dev_release, //</span>必须要都有<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span>函数，不然卸载时会出错</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16 };</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 static int __init usb_device_init(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">20 int ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">21 /*</span>设备注册，注册成功后在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/device</span>目录下创建目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_device</span>并在指定总线</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">22 * usb_bus</span>的目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/usb/device</span>创建<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/device/usb_device</span>的软连接<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">23 ret = device_register(&amp;usb_device);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">24 if(ret){<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">25 printk("device register failed!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">26 return ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">27 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29 printk("usb device init\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30 return 0;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">31 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">32</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">33 static void __exit usb_device_exit(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">34 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">35 device_unregister(&amp;usb_device);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">36 printk("usb device bye!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">37 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 第三个函数是<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver.c</span>，加载模块后会在指定的总线目录的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver</span>目录，即<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/usb/driver</span>目录下创建一个名叫<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_driver</span>的目录来管理这个驱动函数。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_2/1st/driver.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">6 extern struct bus_type usb_bus;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">7</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 struct device_driver usb_driver = {<!-- --></span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9 .name = "usb_driver", //</span>在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/</span>中的驱动目录名字</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 .bus = &amp;usb_bus,      //</span>必须指定驱动函数所属总线，不然不能注册。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11 };</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13 static int __init usb_driver_init(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 int ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16 /*</span>驱动注册，注册成功后在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus/usb/driver</span>目录下创建目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_driver*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 ret = driver_register(&amp;usb_driver);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 if(ret){<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19 printk("driver register failed!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">20 return ret;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">21 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">22 printk("usb driver init\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">23 return 0;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">24 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">25</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">26 static void __exit usb_driver_exit(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">27 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 driver_unregister(&amp;usb_driver);</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29 printk("usb driver bye!\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 接下来看看效果，因为设备和驱动的都指定了所属总线，所以必须先加载总线的模块。同样的，在卸载总线的模块前，必须先把设备和驱动的模块先卸载。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# insmod bus.ko //</span>先加载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus.ko</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# ls /sys/bus/ //sys/bus</span>目录下多了一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span>目录</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">platform scsi <span style="color:#ff0000; word-wrap:break-word">usb</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# insmod device.ko //</span>再加载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device.ko</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# ls /sys/devices/ //sys/device</span>目录下多了一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_device</span>目录</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">platform system <span style="color:#ff0000; word-wrap:break-word">usb_device </span>virtual</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# ls -l /sys/bus/usb/devices/ //</span>同时将该目录软连接到指定的总线目录下</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">lrwxrwxrwx 1 root root 0 Oct 27 13:28 <span style="color:#ff0000; word-wrap:break-word">usb_device -&gt; ../../../devices/usb_device</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# insmod driver.ko //</span>加载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver.ko</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb driver init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# ls /sys/bus/usb/drivers //</span>在指定总线的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver</span>目录下多了一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_driver</span>目录</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_driver <span style="color:#333333; word-wrap:break-word">//</span></span><span style="color:#333333; word-wrap:break-word">但它和设备的目录不一样，它并不是软连接。</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# lsmod //</span>查看一下当前加载的模块</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver 1256 0 - Live 0xbf00c000</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device 1560 0 - Live 0xbf006000</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus 1336 <span style="color:#ff0000; word-wrap:break-word">2 driver,device</span>, Live 0xbf000000 //</span>模块的引用计数，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus</span>模块被<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver</span>引用</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# rmmod bus //</span>如果你要卸载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus</span>模块，它会提示出错，要先卸载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">rmmod: remove 'bus': Resource temporarily unavailable</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# rmmod driver</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb driver bye!</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# rmmod device //</span>卸载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device</span>时，内核自动调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device</span>结构体中指定的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span>函数</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device bye!</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# lsmod //bus</span>的引用计数为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">0</span>，可以卸载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus</span>了</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus 1336 <span style="color:#ff0000; word-wrap:break-word">0</span> - Live 0xbf012000</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 1st]# rmmod bus</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus bye!</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 最后来个图：</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <a target="_blank" href="http://blog.chinaunix.net/attachment/201102/2/25014876_1296659670mg55.png" rel="nofollow noopener noreferrer" style="word-wrap:break-word; text-decoration:none; color:rgb(25,89,155)"><img src="https://images2.imgbox.com/d9/a7/j6a7tgX7_o.png" border="0" alt="" style="word-wrap:break-word; border:0px"></a></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><br style="word-wrap:break-word"> </span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 二、配对函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(match)</span>、探测函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(probe)</span>和卸载函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(remove)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 现在讲一下三个函数：</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">第一个</span>是配对函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(match)</span>，它是总线结构体<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_type</span>的其中一个成员：</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">57 int (*match)(struct device *dev, struct device_driver *drv);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 当总线上添加了新设备或者新驱动函数的时候，内核会调用一次或者多次这个函数。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 举例，如果我现在添加了一个新的驱动函数，内核就会调用所属总线的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">match</span>函数，配对总线上所有的设备，如果驱动能够处理其中一个设备，函数返回<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">0</span>，告诉内核配对成功。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 一般的，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">match</span></span><span style="color:#ff0000; word-wrap:break-word">函数是判断设备的结构体成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device-&gt;bus_id</span></span><span style="color:#ff0000; word-wrap:break-word">和驱动函数的结构体成员<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device_driver-&gt;name</span></span><span style="color:#ff0000; word-wrap:break-word">是否一致，如果一致，那就表明配对成功</span>。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 所以，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus.c</span>修改如下，贴上修改的代码：</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_2/2nd/bus.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">6 int <span style="color:#ff0000; word-wrap:break-word">usb_bus_match</span>(struct device *dev, struct device_driver *drv)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">7 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 if(!<span style="color:#ff0000; word-wrap:break-word">strcmp(dev-&gt;bus_id, drv-&gt;name)</span>){<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9 printk("match success\n"); //</span>为了配对成功，设备的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus_id</span>和驱动的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">name</span>我都更改为</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 return 1;                             //<span style="color:#f00000; word-wrap:break-word">usb_mouse</span></span>，详细的可以查看<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device.c</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver.c</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11 }else{<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 printk("match failed\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13 return 0;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 struct bus_type usb_bus = {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 .name = "usb",                    //</span>注册成功后将在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/bus</span>目录下看到目录<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">19 .<span style="color:#ff0000; word-wrap:break-word">match = usb_bus_match</span>,</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">20 };</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">第二个是探测函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(probe)</span>，它是驱动函数结构体中的一个成员：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">129 int (*probe) (struct device *dev);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 当配对<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(match)</span>成功后，内核就会调用指定驱动中的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">probe</span>函数来查询设备能否被该驱动操作，如果可以，驱动就会对该设备进行相应的操作，如初始化。<span style="color:#ff0000; word-wrap:break-word">所以说，真正的驱动函数入口是在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">probe</span></span><span style="color:#ff0000; word-wrap:break-word">函数中</span>。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 所以，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver.c</span>修改如下：</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_2/2nd/driver.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 void init_mouse(void)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 printk("init usb mouse\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13 int usb_driver_probe(struct device *dev)</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14 {//</span>查询特定设备是否存在，以及是否能够才操作该设备，然后再进行设备操作。<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 //check_mouse(); //</span>自己假设一下检查设备<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">16 init_mouse(); //usb</span>鼠标驱动的真正入口<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">17 return 0;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">18 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> 。。。。。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">26 struct device_driver usb_driver = {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">27 .name = "<span style="color:#ff0000; word-wrap:break-word">usb_mouse</span>", //</span>在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/</span>中的驱动目录名字，为了配对成功，修改为<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb_mouse</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 .bus = &amp;usb_bus, //</span>必须指定驱动函数所属总线，不然不能注册。<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29 <span style="color:#ff0000; word-wrap:break-word">.probe = usb_driver_probe,</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30 </span>。。。。。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">31 };</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word">第三个是卸载函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">(remove)</span>，它是驱动函数结构体中的一个成员：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">130 int (*remove) (struct device *dev);</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 当该驱动函数或者驱动函数正在操作的设备被移除时，内核会调用驱动函数中的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">remove</span>函数调用，进行一些设备卸载相应的操作。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 所以，<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver.c</span>修改如下：</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_2/2nd/driver.c*/</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">20 int <span style="color:#ff0000; word-wrap:break-word">usb_driver_remove</span>(struct device *dev)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">21 {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">22 printk("remove mouse driver\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">23 return 0;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">24 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">25</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">26 struct device_driver usb_driver = {<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">27 .name = "usb_mouse", //</span>在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/sys/</span>中的驱动目录名字<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">28 .bus = &amp;usb_bus, //</span>必须指定驱动函数所属总线，不然不能注册。<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">29 .probe = usb_driver_probe,</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">30 <span style="color:#ff0000; word-wrap:break-word">.remove = usb_driver_remove,</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">31 };</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 接下来就要验证一下了。当然，我的函数里面并没有真正的硬件操作，仅仅是打印出一句话：</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# insmod bus.ko //</span>必须先加载总线模块</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# insmod device.ko</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# insmod driver.ko</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">match success </span>//</span>当加载了设备和驱动的模块后，内核调用总线的配对函数</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">match success //</span>并且配对成功。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">init usb mouse </span>//</span>配对成功后内核调用探测函数<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">probe</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb driver init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# rmmod device</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">remove mouse driver </span>//</span>当设备卸载时，内核调用驱动函数中的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">remove</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release //</span>同时也会调用设备中的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">release</span>函数调用</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device bye!</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 2nd]# rmmod driver</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb driver bye!</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 又到了举例时间，程序员最喜欢就是男女关系，那就以男女关系举例：</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <a target="_blank" href="http://blog.chinaunix.net/attachment/201102/2/25014876_12966596970SlQ.png" rel="nofollow noopener noreferrer" style="word-wrap:break-word; text-decoration:none; color:rgb(25,89,155)"><img src="https://images2.imgbox.com/f1/97/InNLeyYq_o.png" border="0" alt="" style="word-wrap:break-word; border:0px"></a></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 三、多个设备和驱动之间的配对</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 上面讲的内容都是一对一的配对，但是如果系统中有多个配对成功，内核会如何处理呢？</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">1</span>、多个设备对应一个驱动：</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 下面要讲的情况是，如果多个设备与内核中的一个驱动函数配对成功时，内核会进行怎么样的操作，先看实例。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 为了能够让多个设备配对成功，我将<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">bus.c</span>的配对条件修改了一下：</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">/*8th_devModule_2/3th/bus.c */</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">6 int usb_bus_match(struct device *dev, struct device_driver *drv)</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">7 { //</span>仅仅配对名字的前<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9</span>个字母是否相同<span style="font-family:DejaVu Serif,serif; word-wrap:break-word"></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">8 if(!<span style="color:#f00000; word-wrap:break-word">strncmp(dev-&gt;bus_id, drv-&gt;name, 9)</span>){<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9 printk("match success\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">10 return 1;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">11 }else{<!-- --></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">12 printk("match failed\n");</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">13 return 0;</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">14 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(153,204,255)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">15 }</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 同时在<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device.c</span>的基础上拷贝了<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device<span style="color:#ff0000; word-wrap:break-word">1.</span>c</span>和<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">devic<span style="color:#ff0000; word-wrap:break-word">e2</span>.c</span>，三个程序都差不多，可以自己看看。接下来直接看效果：</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: /]# cd /review_driver/8th_devModule/8th_devModule_2/3th</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3th]# insmod bus.ko //</span>先加载总线</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3th]# insmod driver.ko //</span>再加载驱动</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb driver init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3th]# insmod device.ko //</span>当加载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device.ko</span>时，配对成功</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">match success</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">init usb mouse </span>//</span>内核调用驱动中的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">probe</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3th]# insmod device1.ko //</span>再加载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device1.ko</span>，也配对成功</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">match success</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">init usb mouse </span>//</span>内核有调用驱动中的<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">probe</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device1 init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3th]# insmod device2.ko //</span>加载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">device2.ko</span>，配对不成功</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">match failed</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device2 init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 上面的验证表明，<span style="color:#f00000; word-wrap:break-word">一个驱动可以对应多个设备</span>。在联想起我举得男人女人——一个男人可以配对多个女人，哈哈。</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">2</span>、一个设备对应多个驱动</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> <br style="word-wrap:break-word"> </p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 这个例子中我将<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver.c</span>拷贝多了一个<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver<span style="color:#ff0000; word-wrap:break-word">1</span>.c</span>，两个程序基本相同，都能配对成功，但看看效果：</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3th]# insmod bus.ko //</span>先加载总线</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb bus init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3th]# insmod device.ko //</span>再加载设备</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb device init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3th]# insmod driver.ko //</span>加载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver.ko</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#ff0000; word-wrap:break-word">match success </span>//</span>配对成功</p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">match success</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">init usb mouse //</span>并且调用了<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">probe</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="font-family:DejaVu Serif,serif; word-wrap:break-word">usb driver init</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">[root: 3th]# insmod driver1.ko //</span>再加载<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">driver1.ko</span></span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word">match success //</span>因为名字的前<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">9</span>个字母一样，所以也会配对成功</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding:0cm; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px; border:medium none; background:none 0% 0% repeat scroll rgb(230,230,230)"> <span style="color:#ff0000; word-wrap:break-word"><span style="font-family:DejaVu Serif,serif; word-wrap:break-word"><span style="color:#333333; word-wrap:break-word">usb driver1 init </span>//</span>但不会调用<span style="font-family:DejaVu Serif,serif; word-wrap:break-word">probe</span>，因为已经有一个驱动跟该设备配对了。</span></p> 
 <p style="word-wrap:break-word; margin-top:5px; margin-bottom:0cm; padding-top:0px; padding-bottom:0px; color:rgb(102,102,102); font-family:宋体,Arial; font-size:16px; line-height:26px"> 上面的验证表明，<span style="color:#f00000; word-wrap:break-word">一个设备只能对应一个驱动</span>。</p> 
 <div> 
  <br> 
 </div> 
 <br> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a4f02642e1ecaa9b220bf1b0b7bcff07/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CS143-project3 基于bag of words 的场景识别 Scene Recognition with Bag of Words</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a187320da6b915639a119dd197acc6cc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CS143-project4基于滑窗的人脸检测 Face detection with a sliding window</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>