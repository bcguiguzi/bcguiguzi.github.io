<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Backtrader 文档学习-Data Feeds（上） - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Backtrader 文档学习-Data Feeds（上）" />
<meta property="og:description" content="Backtrader 文档学习-Data Feeds 1.数据载入 Quickstart中已经学习了基础的数据载入到cerebro中。
self.datas 是按插入顺序的数组数组对象的别名self.data 和 self.data0 一样，都是指向第一组数据self.dataX 指向第N组数据 import backtrader as bt import backtrader.feeds as btfeeds data = btfeeds.YahooFinanceCSVData(dataname=&#39;wheremydatacsvis.csv&#39;) cerebro = bt.Cerebro() cerebro.adddata(data) # a &#39;name&#39; parameter can be passed for plotting purposes 从github上下载BackTrader包，有用例中提供的所有的测试数据，有txt和csv的数据版本：
# ll total 3436 -rw-r--r--. 1 root root 24109 Apr 19 2023 2005-2006-day-001.txt -rw-r--r--. 1 root root 1820067 Apr 19 2023 2006-01-02-volume-min-001.txt -rw-r--r--. 1 root root 15123 Apr 19 2023 2006-day-001-optix.txt -rw-r--r--. 1 root root 12030 Apr 19 2023 2006-day-001." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/0908e8d8bb8a76a825e62375b5991dff/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-20T08:40:25+08:00" />
<meta property="article:modified_time" content="2023-12-20T08:40:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Backtrader 文档学习-Data Feeds（上）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Backtrader_Data_Feeds_0"></a>Backtrader 文档学习-Data Feeds</h3> 
<h4><a id="1_1"></a>1.数据载入</h4> 
<p>Quickstart中已经学习了基础的数据载入到cerebro中。</p> 
<ul><li>self.datas 是按插入顺序的数组</li><li>数组对象的别名</li><li>self.data 和 self.data0 一样，都是指向第一组数据</li><li>self.dataX 指向第N组数据</li></ul> 
<pre><code>import backtrader as bt
import backtrader.feeds as btfeeds

data = btfeeds.YahooFinanceCSVData(dataname='wheremydatacsvis.csv')

cerebro = bt.Cerebro()

cerebro.adddata(data)  # a 'name' parameter can be passed for plotting purposes
</code></pre> 
<p>从github上下载BackTrader包，有用例中提供的所有的测试数据，有txt和csv的数据版本：</p> 
<pre><code># ll
total 3436
-rw-r--r--. 1 root root   24109 Apr 19  2023 2005-2006-day-001.txt
-rw-r--r--. 1 root root 1820067 Apr 19  2023 2006-01-02-volume-min-001.txt
-rw-r--r--. 1 root root   15123 Apr 19  2023 2006-day-001-optix.txt
-rw-r--r--. 1 root root   12030 Apr 19  2023 2006-day-001.txt
-rw-r--r--. 1 root root    6108 Apr 19  2023 2006-day-002.txt
-rw-r--r--. 1 root root  120002 Apr 19  2023 2006-min-005.txt
-rw-r--r--. 1 root root     609 Apr 19  2023 2006-month-001.txt
-rw-r--r--. 1 root root   15130 Apr 19  2023 2006-volume-day-001.txt
-rw-r--r--. 1 root root    2489 Apr 19  2023 2006-week-001.txt
-rw-r--r--. 1 root root    1267 Apr 19  2023 2006-week-002.txt
-rw-r--r--. 1 root root     543 Apr 19  2023 bidask2.csv
-rw-r--r--. 1 root root     358 Apr 19  2023 bidask.csv
-rw-r--r--. 1 root root  272573 Apr 19  2023 nvda-1999-2014.txt
-rw-r--r--. 1 root root   17462 Apr 19  2023 nvda-2014.txt
-rw-r--r--. 1 root root  345989 Apr 19  2023 orcl-1995-2014.txt
-rw-r--r--. 1 root root   52877 Apr 19  2023 orcl-2003-2005.txt
-rw-r--r--. 1 root root   17638 Apr 19  2023 orcl-2014.txt
-rw-r--r--. 1 root root    8207 Apr 19  2023 ticksample.csv
-rw-r--r--. 1 root root  324337 Apr 19  2023 yhoo-1996-2014.txt
-rw-r--r--. 1 root root  341934 Apr 19  2023 yhoo-1996-2015.txt
-rw-r--r--. 1 root root   52718 Apr 19  2023 yhoo-2003-2005.txt
-rw-r--r--. 1 root root   17666 Apr 19  2023 yhoo-2014.txt
</code></pre> 
<h4><a id="2__45"></a>2. 数据载入的常用参数</h4> 
<p>参数：</p> 
<ul><li>dataname (默认: None) - 必须提供。含义随数据馈送类型（文件位置，代码等）而异。</li><li>name (默认: ‘’) - 绘图中用于装饰目的的意思。如果未指定，则可以从数据名派生（例如：文件路径的最后一部分）。</li><li>fromdate (默认: mindate) - Python datetime对象，指示应忽略此日期之前的任何datetime。</li><li>todate (默认: maxdate) - Python datetime对象，指示该日期之后的任何datetime应该被忽略。</li><li>timeframe (默认是TimeFrame.Days)， 其他可以设置的值: Ticks, Seconds, Minutes, Days, Weeks, Months and Years</li><li>compression （默认是1），从实际的bar中取有效的bar，提供有用信息的仅在数据重新采样/回放中有效。</li><li>sessionstart （默认None），指示数据的会话开始时间。可以由类用于重新采样等目的。</li><li>sessionend （默认None），指示数据的会话结束时间。可以由类用于重新采样等目的。</li></ul> 
<h4><a id="3CSV_57"></a>3.CSV分隔符</h4> 
<pre><code>- headers （默认True）指示传递的数据是否具有初始标题行
- separator （默认分隔符，）用于标记每个CSV行分割
</code></pre> 
<h4><a id="3_GenericCSVData_62"></a>3. GenericCSVData方法</h4> 
<p>参数说明：</p> 
<ul><li>dataname (默认: None) - CSV 文件的路径或文件名。这是必需的参数，用于指定要加载的 CSV 文件的位置。</li><li>datetime (默认: 0) - CSV 文件中包含日期时间的列的索引。 BackTrader 哪一列包含日期时间信息。</li><li>open (默认: 1) - CSV 文件中包含开盘价的列的索引。 BackTrader 哪一列包含开盘价数据。</li><li>high (默认: 2) - CSV 文件中包含最高价的列的索引。 BackTrader 哪一列包含最高价数据。</li><li>low (默认: 3) - CSV 文件中包含最低价的列的索引。 BackTrader 哪一列包含最低价数据。</li><li>close (默认: 4) - CSV 文件中包含收盘价的列的索引。 BackTrader 哪一列包含收盘价数据。</li><li>volume (默认: 5) - CSV 文件中包含成交量的列的索引。可选参数，用于指定成交量数据所在的列。</li><li>openinterest (默认: 6) - CSV 文件中包含持仓量的列的索引。可选参数，用于指定持仓量数据所在的列。</li><li>nullvalue (默认: float(‘NaN’))如果缺少应存在的值（CSV字段为空），将指定使用值替代。</li><li>dtformat (默认: ‘%Y-%m-%d’) - 日期时间格式字符串。用于解析 CSV 文件中的日期时间数据。</li><li>nullvalue (默认: float(‘NaN’))如果缺少应存在的值（CSV字段为空），将指定使用值替代。</li><li>dtformat (默认: ‘%Y-%m-%d’) 日期时间格式字符串。用于解析 CSV 文件中的日期数据。</li><li>tmformat (默认: %H:%M:%S) 时间格式字符串。用于解析 CSV 文件中的时间数据。</li></ul> 
<pre><code>import datetime
import backtrader as bt
import backtrader.feeds as btfeeds

...
...

data = btfeeds.GenericCSVData(
    dataname='mydata.csv',

    fromdate=datetime.datetime(2000, 1, 1),
    todate=datetime.datetime(2000, 12, 31),

    nullvalue=0.0,

    dtformat=('%Y-%m-%d'),

    datetime=0,
    high=1,
    low=2,
    open=3,
    close=4,
    volume=5,
    openinterest=-1
)

...
</code></pre> 
<p>说明：</p> 
<ul><li>限制输入到2000年</li><li>顺序是HLOC而不是OHLC</li><li>缺失值用0替代</li><li>日线的日期格式是YYYY-MM-DD</li><li>当前数据没有openinterest 值<br> 也可以子类参数定义导入csv文件</li></ul> 
<pre><code>import datetime
import backtrader.feeds as btfeed

class MyHLOC(btfreeds.GenericCSVData):

  params = (
    ('fromdate', datetime.datetime(2000, 1, 1)),
    ('todate', datetime.datetime(2000, 12, 31)),
    ('nullvalue', 0.0),
    ('dtformat', ('%Y-%m-%d')),
    ('tmformat', ('%H.%M.%S')),

    ('datetime', 0),
    ('time', 1),
    ('high', 2),
    ('low', 3),
    ('open', 4),
    ('close', 5),
    ('volume', 6),
    ('openinterest', -1)
)
</code></pre> 
<h4><a id="4_140"></a>4.扩展数据导入</h4> 
<p>除了OHLC之外，能否提供自定义的列 ，当然可以。<br> 增加PE列：</p> 
<pre><code>from backtrader.feeds import GenericCSVData

class GenericCSV_PE(GenericCSVData):

    # Add a 'pe' line to the inherited ones from the base class
    lines = ('pe',)

    # openinterest in GenericCSVData has index 7 ... add 1
    # add the parameter to the parameters inherited from the base class
    params = (('pe', 8),)
</code></pre> 
<p>使用PE数据</p> 
<pre><code>import backtrader as bt

....

class MyStrategy(bt.Strategy):

    ...

    def next(self):

        if self.data.close &gt; 2000 and self.data.pe &lt; 12:
            # TORA TORA TORA --- Get off this market
            self.sell(stake=1000000, price=0.01, exectype=Order.Limit)
    ...
</code></pre> 
<p>用PE数据做图</p> 
<pre><code>import backtrader as bt
import backtrader.indicators as btind

....

class MyStrategy(bt.Strategy):

    def __init__(self):

        # The indicator autoregisters and will plot even if no obvious
        # reference is kept to it in the class
        btind.SMA(self.data.pe, period=1, subplot=False)

    ...

    def next(self):

        if self.data.close &gt; 2000 and self.data.pe &lt; 12:
            # TORA TORA TORA --- Get off this market
            self.sell(stake=1000000, price=0.01, exectype=Order.Limit)
    ...
</code></pre> 
<h4><a id="5_CSV_198"></a>5. CSV导入</h4> 
<p>CSV Data Feed Development 和 Binary Datafeed Development<br> 两节都是深入的CSV数据导入的细节，暂时不用，实际还是从库里加载数据比较方便。。</p> 
<h4><a id="6_202"></a>6.多周期导入</h4> 
<p>投资决策需要使用不同的时间区间</p> 
<ul><li>周线用于评估趋势</li><li>日线用于执行投资<br> 或者是5分钟线和60分钟线<br> BackTrader原生支持不同的时间区间，用户需遵循以下规则：</li><li>最小的时间区间数据（也就是数据量最多的）应第一个被加载到cerebro中</li><li>数据的日期必须对齐一致，平台才能理解处理</li></ul> 
<p>用户可以随意应用indicator处理更短或更长的时间区间。</p> 
<ul><li>指示器应用长的时间区间产生更少的数据bar</li><li>最小时间区间的数据可以用于更长的时间区间</li></ul> 
<p>看最后的总结示例（程序命名multitimeframe-example.py），统一演示。<br> 需要注意原始示例中：</p> 
<blockquote> 
 <p>parser.add_argument(‘–timeframe’, default=‘weekly’, required=False,<br> choices=[‘daily’, ‘weekly’, ‘monhtly’],<br> monhtly拼写错误，月线执行会报错，修改monthly。</p> 
</blockquote> 
<pre><code>from __future__ import (absolute_import, division, print_function,
                        unicode_literals)

import argparse

import backtrader as bt
import backtrader.feeds as btfeeds
import backtrader.indicators as btind


class SMAStrategy(bt.Strategy):
    params = (
        ('period', 10),
        ('onlydaily', False),
    )

    def __init__(self):
        self.sma_small_tf = btind.SMA(self.data, period=self.p.period)
        if not self.p.onlydaily:
            self.sma_large_tf = btind.SMA(self.data1, period=self.p.period)

    def nextstart(self):
        print('--------------------------------------------------')
        print('nextstart called with len', len(self))
        print('--------------------------------------------------')

        super(SMAStrategy, self).nextstart()


def runstrat():
    args = parse_args()

    # Create a cerebro entity
    cerebro = bt.Cerebro(stdstats=False)

    # Add a strategy
    if not args.indicators:
        cerebro.addstrategy(bt.Strategy)
    else:
        cerebro.addstrategy(
            SMAStrategy,

            # args for the strategy
            period=args.period,
            onlydaily=args.onlydaily,
        )

    # Load the Data
    datapath = args.dataname or '../../datas/2006-day-001.txt'
    data = btfeeds.BacktraderCSVData(dataname=datapath)
    cerebro.adddata(data)  # First add the original data - smaller timeframe

    tframes = dict(daily=bt.TimeFrame.Days, weekly=bt.TimeFrame.Weeks,
                   monthly=bt.TimeFrame.Months)

    # Handy dictionary for the argument timeframe conversion
    # Resample the data
    if args.noresample:
        datapath = args.dataname2 or '../../datas/2006-week-001.txt'
        data2 = btfeeds.BacktraderCSVData(dataname=datapath)
        # And then the large timeframe
        cerebro.adddata(data2)
    else:
        cerebro.resampledata(data, timeframe=tframes[args.timeframe],
                             compression=args.compression)

    # Run over everything
    cerebro.run()

    # Plot the result
    cerebro.plot(style='bar')


def parse_args():
    parser = argparse.ArgumentParser(
        description='Multitimeframe test')

    parser.add_argument('--dataname', default='', required=False,
                        help='File Data to Load')

    parser.add_argument('--dataname2', default='', required=False,
                        help='Larger timeframe file to load')

    parser.add_argument('--noresample', action='store_true',
                        help='Do not resample, rather load larger timeframe')

    parser.add_argument('--timeframe', default='weekly', required=False,
                        choices=['daily', 'weekly', 'monthly'],
                        help='Timeframe to resample to')

    parser.add_argument('--compression', default=1, required=False, type=int,
                        help='Compress n bars into 1')

    parser.add_argument('--indicators', action='store_true',
                        help='Wether to apply Strategy with indicators')

    parser.add_argument('--onlydaily', action='store_true',
                        help='Indicator only to be applied to daily timeframe')

    parser.add_argument('--period', default=10, required=False, type=int,
                        help='Period to apply to indicator')

    return parser.parse_args()


if __name__ == '__main__':
    runstrat()
</code></pre> 
<p>调用参数的设置很好，值得学习。<br> 说明：</p> 
<ul><li>使用git下载的示例数据，把程序放在和datas目录外</li><li>核心是下面一段程序<br> 如果没有参数，复制数据加载到cerebro中，cerebro中有两个一样的数据<br> 如果有参数，参数带入到resampledata方法中执行<br> 最后做图</li></ul> 
<pre><code>    if args.noresample:
        datapath = args.dataname2 or '../../datas/2006-week-001.txt'
        data2 = btfeeds.BacktraderCSVData(dataname=datapath)
        # And then the large timeframe
        cerebro.adddata(data2)
    else:
        cerebro.resampledata(data, timeframe=tframes[args.timeframe],
                             compression=args.compression)
</code></pre> 
<ul><li>通过变化参数，理解resampledata方法：</li></ul> 
<h5><a id="1help_351"></a>（1）参数help</h5> 
<blockquote> 
 <p>python ./multitimeframe-example.py --help</p> 
</blockquote> 
<pre><code>usage: multitimeframe-example.py [-h] [--dataname DATANAME]
                                 [--dataname2 DATANAME2] [--noresample]
                                 [--timeframe {daily,weekly,monthly}]
                                 [--compression COMPRESSION] [--indicators]
                                 [--onlydaily] [--period PERIOD]

Multitimeframe test

optional arguments:
  -h, --help            show this help message and exit
  --dataname DATANAME   File Data to Load
  --dataname2 DATANAME2
                        Larger timeframe file to load
  --noresample          Do not resample, rather load larger timeframe
  --timeframe {daily,weekly,monthly}
                        Timeframe to resample to
  --compression COMPRESSION
                        Compress n bars into 1
  --indicators          Wether to apply Strategy with indicators
  --onlydaily           Indicator only to be applied to daily timeframe
  --period PERIOD       Period to apply to indicator
</code></pre> 
<h5><a id="2_378"></a>（2）周线</h5> 
<blockquote> 
 <p>python ./multitimeframe-example.py --timeframe weekly --compression 1</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/73/ac/ti90tgJS_o.png" alt="在这里插入图片描述"><br> 周线</p> 
<h5><a id="3_384"></a>（3）日线压缩</h5> 
<blockquote> 
 <p>python ./multitimeframe-example.py --timeframe daily --compression 2</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/4e/b8/bDtAsydh_o.png" alt="在这里插入图片描述"><br> 日线压缩2倍</p> 
<h5><a id="4SMA_390"></a>（4）使用日线SMA</h5> 
<blockquote> 
 <p>python ./multitimeframe-example.py --timeframe weekly --compression 1 --indicators --onlydaily</p> 
</blockquote> 
<pre><code>--------------------------------------------------
nextstart called with len 10
--------------------------------------------------
</code></pre> 
<p><img src="https://images2.imgbox.com/4a/19/YzClUZ5h_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="5_401"></a>（5）指示器压缩周线</h5> 
<ul><li>策略不是在10个周期后调用，而是在50个周期后第一次调用。 是因为在更长的(每周)时间框架上应用的简单移动平均线在10周后产生一个值，即10周* 5天/周=50天，nextstart第一个长度是51 。</li><li>nextstart执行5次<br> 是混合时间区间的自然副作用，在这种情况下，指标只应用于更大的时间区间。 较大的时间框架简单移动平均线产生5倍的相同价值，同时消耗5根日线。 SMA的默认周期是10，指示器受控于更大的时间区间。</li></ul> 
<pre><code>python ./multitimeframe-example.py --timeframe weekly --compression 1 --indicators
--------------------------------------------------
nextstart called with len 51
--------------------------------------------------
--------------------------------------------------
nextstart called with len 52
--------------------------------------------------
--------------------------------------------------
nextstart called with len 53
--------------------------------------------------
--------------------------------------------------
nextstart called with len 54
--------------------------------------------------
--------------------------------------------------
nextstart called with len 55
--------------------------------------------------
</code></pre> 
<p><img src="https://images2.imgbox.com/ee/97/DzgykuAV_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="6_426"></a>（6）周线压缩</h5> 
<blockquote> 
 <p>python ./multitimeframe-example.py --timeframe weekly --compression 2<br> <img src="https://images2.imgbox.com/ce/a6/RMZz9RD6_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<h5><a id="7_431"></a>（7）月线</h5> 
<blockquote> 
 <p>python ./multitimeframe-example.py --timeframe monthly --compression 1</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/eb/c2/xp3H84K0_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fcfc43c9f3cf08a60452f14d8be1b2c6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Codeforces1913 D. Array Collapse（笛卡尔树&#43;树上dp）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7638f8f7c5625d0abcd332dc5721973d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">通达信自定义数据采集系统5.0</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>