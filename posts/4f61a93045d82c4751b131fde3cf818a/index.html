<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>大文件切片上传 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="大文件切片上传" />
<meta property="og:description" content="封装成通用组件：
&lt;template&gt; &lt;div id=&#34;app&#34;&gt; &lt;!-- 上传组件 --&gt; &lt;el-upload action=&#34;&#34; :auto-upload=&#34;false&#34; :show-file-list=&#34;false&#34; :on-change=&#34;handleChange&#34;&gt; &lt;el-button size=&#34;small&#34; type=&#34;primary&#34;&gt;点击上传&lt;/el-button&gt; &lt;div slot=&#34;tip&#34; class=&#34;el-upload__tip&#34;&gt;{{ placeholder }}&lt;/div&gt; &lt;/el-upload&gt; &lt;el-dialog title=&#34;提示&#34; :visible.sync=&#34;dialog&#34; width=&#34;400px&#34; center&gt; &lt;div class=&#34;display-flex fd-column ai-center&#34;&gt; &lt;p class=&#34;mt-0&#34;&gt;关闭弹窗后可继续上传，不推荐关闭，以免文件传输失败&lt;/p&gt; &lt;el-progress type=&#34;circle&#34; :percentage=&#34;Number(percent.toFixed())&#34;&gt;&lt;/el-progress&gt; &lt;div class=&#34;mt-20&#34;&gt; &lt;el-button type=&#34;primary&#34; size=&#34;mini&#34; @click=&#34;handleClickBtn&#34;&gt;{{ upload | btnTextFilter}}&lt;/el-button&gt; &lt;el-button type=&#34;warning&#34; size=&#34;mini&#34; @click=&#34;handleClose&#34;&gt;取消上传&lt;/el-button&gt; &lt;/div&gt; &lt;/div&gt; &lt;/el-dialog&gt; &lt;div v-for=&#34;(item, index) in fileList&#34; :key=&#34;index&#34; class=&#34;display-flex ai-center jc-space-between fs-14 mt-6 cursor-pointer&#34; :style=&#34;{width: fileWidth}&#34;&gt; &lt;div class=&#34;display-flex ai-center&#34; style=&#34;width: 90%;&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/4f61a93045d82c4751b131fde3cf818a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-29T13:57:26+08:00" />
<meta property="article:modified_time" content="2024-02-29T13:57:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">大文件切片上传</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>封装成通用组件：</p> 
<pre><code class="hljs">&lt;template&gt;
  &lt;div id="app"&gt;
    &lt;!-- 上传组件 --&gt;
    &lt;el-upload
      action=""
      :auto-upload="false"
      :show-file-list="false"
      :on-change="handleChange"&gt;
      &lt;el-button size="small" type="primary"&gt;点击上传&lt;/el-button&gt;
      &lt;div slot="tip" class="el-upload__tip"&gt;{<!-- -->{ placeholder }}&lt;/div&gt;
    &lt;/el-upload&gt;
    &lt;el-dialog
      title="提示"
      :visible.sync="dialog"
      width="400px"
      center&gt;
      &lt;div class="display-flex fd-column ai-center"&gt;
        &lt;p class="mt-0"&gt;关闭弹窗后可继续上传，不推荐关闭，以免文件传输失败&lt;/p&gt;
        &lt;el-progress type="circle" :percentage="Number(percent.toFixed())"&gt;&lt;/el-progress&gt;
        &lt;div class="mt-20"&gt;
          &lt;el-button type="primary" size="mini" @click="handleClickBtn"&gt;{<!-- -->{ upload | btnTextFilter}}&lt;/el-button&gt;
          &lt;el-button type="warning" size="mini" @click="handleClose"&gt;取消上传&lt;/el-button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/el-dialog&gt;
    &lt;div v-for="(item, index) in fileList" :key="index" class="display-flex ai-center jc-space-between fs-14 mt-6 cursor-pointer" :style="{width: fileWidth}"&gt;
      &lt;div class="display-flex ai-center" style="width: 90%;"&gt;
        &lt;i class="el-icon-document"&gt;&lt;/i&gt;
        &lt;span class="ml-4 text-ellipsis" style="width: 90%;"&gt;{<!-- -->{item.name}}&lt;/span&gt;
      &lt;/div&gt;
      &lt;i class="el-icon-close" @click="delFile(item)"&gt;&lt;/i&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import axios from 'axios'

export default {
  name: 'BigFileUpload',
  props: {
    placeholder: {
      type: String,
      default () {
        return '可上传多个文件，不限制格式'
      }
    },
    folder: {
      type: String,
      default () {
        return 'test'
      }
    },
    fileWidth: {
      type: String,
      default () {
        return '300px'
      }
    }
  },
  filters: {
    btnTextFilter (val) {
      return val ? '暂停上传' : '继续上传'
    }
  },
  watch: {
    fileList: {
      handler: function (value) {
        this.$emit('change', value)
      },
      deep: true
    }
  },
  data () {
    return {
      dialog: false,
      fileList: [],
      index: 0, // 当前传输位置
      uploadId: null,
      totalChunks: 0,
      percent: 0,
      upload: false,
      percentCount: 0,
      chunkList: []
    }
  },
  methods: {
    handleClose () {
      this.$confirm('此操作将取消并关闭上传此文件, 是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() =&gt; {
        const data = {
          folder: this.folder,
          uploadId: this.uploadId
        }
        axios.delete('/big/file/delete/oss/part', {
          data: data
        }).then(() =&gt; {
          this.$message.success('取消成功')
          this.upload = false
          this.dialog = false
        })
      }).catch(() =&gt; {
      });
    },
    delFile (file) {
      this.$confirm('此操作将永久删除该数据, 是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() =&gt; {
        const data = {
          filenames: [file.url],
          folder: this.folder
        }
        axios.delete('/big/file/delete/oss/file', {
          data: data
        }).then(() =&gt; {
          this.fileList = this.fileList.filter(item =&gt; item.url !== file.url)
          this.$message.success('删除成功')
        })
      }).catch(() =&gt; {
      });
    },
    handleChange (file) {
      this.upload = true
      this.percent = 0
      this.percentCount = 0
      this.index = 0
      this.chunkList = []
      this.filename = file.name
      axios.post('/big/file/initUpload', {
        filename: this.filename,
        folder: this.folder
      }).then(res =&gt; {
        this.dialog = true
        this.uploadId = res.data.data
        // 获取文件并转成 ArrayBuffer 对象
        const fileObj = file.raw
        // 将文件按固定大小（5M）进行切片，注意此处同时声明了多个常量
        const chunkSize = 5242880;
        const chunkList = []; // 保存所有切片的数组
        const chunkListLength = Math.ceil(fileObj.size / chunkSize); // 计算总共多个切片
        // 生成切片，这里后端要求传递的参数为字节数据块（chunk）和每个数据块的文件名（fileName）
        let curChunk = 0 // 切片时的初始位置
        for (let i = 0; i &lt; chunkListLength; i++) {
          const item = {
            index: i,
            chunk: fileObj.slice(curChunk, curChunk + chunkSize)
          }
          curChunk += chunkSize
          chunkList.push(item)
        }
        this.totalChunks = chunkListLength
        this.chunkList = chunkList // sendRequest 要用到
        this.sendRequest()
      })
    },

    // 发送请求
    sendRequest () {
      const requestList = [] // 请求集合
      if (this.index) {
        this.chunkList = this.chunkList.filter(item =&gt; item.index &gt; this.index)
      }
      this.chunkList.forEach(item =&gt; {
        const fn = () =&gt; {
          return new Promise((resolve, reject) =&gt; {
            const formData = new FormData()
            formData.append('file', item.chunk)
            formData.append('index', item.index)
            formData.append('uploadId', this.uploadId)
            return axios({
              url: '/big/file/uploadChunk',
              method: 'post',
              headers: {
                'Content-Type': 'multipart/form-data',
                Authorization: this.$store.state.token,
                tenant_id: this.$cookies.get('tenant_id') || undefined
              },
              timeout: 100000,
              data: formData
            }).then(res =&gt; {
              if (res.data.code === 200) {
                resolve(res)
                this.index = item.index
                if (this.percentCount === 0) { // 避免上传成功后会删除切片改变 chunkList 的长度影响到 percentCount 的值
                  this.percentCount = 100 / this.chunkList.length
                }
                this.percent += this.percentCount // 改变进度
              } else {
                reject(res)
              }
            }).catch((err) =&gt; {
              reject(err)
              this.upload = false
            })
          })
        }
        requestList.push(fn)
      })
      console.log(requestList, 11111111111111)
      let i = 0 // 记录发送的请求个数
      const complete = () =&gt; {
        axios({
          url: `/big/file/mergeFile?uploadId=${this.uploadId}`,
          method: 'post',
          headers: {
            Authorization: this.$store.state.token,
            tenant_id: this.$cookies.get('tenant_id') || undefined
          }
        }).then(res =&gt; {
          this.fileList.push({
            name: this.filename,
            url: res.data.data
          })
          this.dialog = false
        })
      }
      const send = async () =&gt; {
        if (!this.upload) return
        if (i &gt;= requestList.length) {
          // 发送完毕
          complete()
          return
        }
        await requestList[i]()
        i++
        send()
      }
      send() // 发送请求
    },
    // 按下暂停按钮
    handleClickBtn () {
      this.upload = !this.upload
      // 如果不暂停则继续上传
      if (this.upload) this.sendRequest()
    }
  }
}
&lt;/script&gt;

&lt;style scoped lang="scss"&gt;
&lt;/style&gt;
</code></pre> 
<p>引入使用：</p> 
<pre><code class="hljs">import BigFileUpload from '@/components/BigFileUpload';
&lt;big-file-upload folder="report" @change="data =&gt; drawerAddForm.file = data"&gt;&lt;/big-file-upload&gt;</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b91d19ea8dc13220101635c82d704ee3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Prometheus的24节实战课</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/001b3f5a657914c2c4eeb9e41b312c0e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">QTableWidget实现复制粘贴</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>