<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>爬取医药卫生知识服务系统的药品数据——超详细流程 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="爬取医药卫生知识服务系统的药品数据——超详细流程" />
<meta property="og:description" content="爬取医药卫生知识服务系统的药品数据——超详细流程 文章目录 爬取医药卫生知识服务系统的药品数据——超详细流程前言一、寻找药品数据二、爬取药品ID1.资源获取2.数据提取3.资源保存4.主函数5.总体代码 三、爬取药品信息1.加载资源ID2.获取数据3.数据提取4.保存信息5.主函数6.总体代码 小结 前言 最近，实验室的项目需要用到医药卫生知识服务系统的药品数据，查看发现该网站上的数据不少，手动采集数据比较麻烦，考虑使用网络爬虫，交由我来进行分析和爬取。
在我爬取药品数据的时候，发现该系统的数据是通过 AJAX 动态加载的，直接无脑复制 URL 使用 request.get 爬取的简单方式是行不通的。于是我爬取完之后写下这篇博客作为一个记录，也方便后来者进行学习。
医药卫生知识服务系统的网址是 https://med.ckcest.cn/
我们点击右上方的 资源导航 -&gt; 医药百科，进入药品目录页
可以看到这些药品数据都是我们需要的，网站进行了分页展示，每一页展示十条
点击第一条药品 氨己烯酸，就会在新的标签页中可以看到药品的详细数据，这是药品的详情页。
总的任务就是把所有药品数据都爬取下来，每一个药品数据都用单独一个文件进行保存。
请大家在这一步记住目录页和详情页是怎么找到的，之后的步骤中会直接提及这两个概念。
一、寻找药品数据 每一个药品都用了单独的标签页进行展示，那么每一个药品都会对应一个链接来获取数据，因此我们找到这些 URL 的规律就可以爬取了。
我们点开第一个药品 氨己烯酸 和第二个药品 奥卡西平的详情页，在浏览器的地址栏中观察两个药品的URL：
https://med.ckcest.cn/details.html?id=5005884384970756&amp;classesEn=wiki&amp;searchValue= https://med.ckcest.cn/details.html?id=5005884384954370&amp;classesEn=wiki&amp;searchValue= 我们发现，URL仅在 id 部分发生了变化，其余完全相同。这意味着 id 即为每个药品数据的标识，我们只需要找到每个药品的 id ，对 URL 进行拼接就可以对应获取到单个药品数据了。
因此，我们只需要拿到所有药品的 id 信息，然后遍历每一条 id ，就能依次拿到所有药品的数据了。那么药品的 id 信息又从哪拿呢，我们可以通过药品目录页进行爬取。
接下来是具体的找 id 的步骤，这里我使用的是谷歌浏览器。注意，找数据是编写爬虫最关键的部分，这非常重要。
第一步，用谷歌浏览器进入药品目录页 第二步，按 F12 键，打开浏览器的控制台，转到 NetWork 部分。（可以看到此时 Network 部分什么数据都没有） 第三步，键盘按 F5 进行页面刷新，Network部分会加载该页面的全部数据 第四步，在控制台左侧的 Search 窗口搜索第一条药品的名字 氨己烯酸 可以看到，搜出了两个对应链接，我们分别点击链接，右侧的 response 会具体展示其数据。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/d6c4bb12f0246c3d26425286b9feb0d6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-12T22:46:03+08:00" />
<meta property="article:modified_time" content="2022-11-12T22:46:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">爬取医药卫生知识服务系统的药品数据——超详细流程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>爬取医药卫生知识服务系统的药品数据——超详细流程</h2> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_0" rel="nofollow">爬取医药卫生知识服务系统的药品数据——超详细流程</a></li><li><ul><li><a href="#_3" rel="nofollow">前言</a></li><li><a href="#_25" rel="nofollow">一、寻找药品数据</a></li><li><a href="#ID_72" rel="nofollow">二、爬取药品ID</a></li><li><ul><li><a href="#1_81" rel="nofollow">1.资源获取</a></li><li><a href="#2_188" rel="nofollow">2.数据提取</a></li><li><a href="#3_208" rel="nofollow">3.资源保存</a></li><li><a href="#4_231" rel="nofollow">4.主函数</a></li><li><a href="#5_267" rel="nofollow">5.总体代码</a></li></ul> 
   </li><li><a href="#_377" rel="nofollow">三、爬取药品信息</a></li><li><ul><li><a href="#1ID_403" rel="nofollow">1.加载资源ID</a></li><li><a href="#2_423" rel="nofollow">2.获取数据</a></li><li><a href="#3_473" rel="nofollow">3.数据提取</a></li><li><a href="#4_595" rel="nofollow">4.保存信息</a></li><li><a href="#5_620" rel="nofollow">5.主函数</a></li><li><a href="#6_646" rel="nofollow">6.总体代码</a></li></ul> 
   </li><li><a href="#_794" rel="nofollow">小结</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_3"></a>前言</h3> 
<p>最近，实验室的项目需要用到医药卫生知识服务系统的药品数据，查看发现该网站上的数据不少，手动采集数据比较麻烦，考虑使用网络爬虫，交由我来进行分析和爬取。</p> 
<p>在我爬取药品数据的时候，发现该系统的数据是通过 AJAX 动态加载的，直接无脑复制 URL 使用 request.get 爬取的简单方式是行不通的。于是我爬取完之后写下这篇博客作为一个记录，也方便后来者进行学习。</p> 
<p>医药卫生知识服务系统的网址是 <code>https://med.ckcest.cn/</code></p> 
<p><img src="https://images2.imgbox.com/24/1e/2WcWDQDJ_o.png" alt="v1" width="800"><br> 我们点击右上方的 <code>资源导航</code> -&gt; <code>医药百科</code>，进入<strong>药品目录页</strong></p> 
<p><img src="https://images2.imgbox.com/1c/59/gfYgzDo7_o.png" alt="v2" width="800"><br> 可以看到这些药品数据都是我们需要的，网站进行了分页展示，每一页展示十条</p> 
<p><img src="https://images2.imgbox.com/b0/de/w82OuhaX_o.png" alt="v3" width="900"><br> 点击第一条药品 <code>氨己烯酸</code>，就会在新的标签页中可以看到药品的详细数据，这是<strong>药品的详情页</strong>。</p> 
<p><img src="https://images2.imgbox.com/91/d6/p2xDKate_o.png" alt="v4" width="800"><br> 总的任务就是把所有药品数据都爬取下来，每一个药品数据都用单独一个文件进行保存。</p> 
<p>请大家在这一步记住目录页和详情页是怎么找到的，之后的步骤中会直接提及这两个概念。</p> 
<h3><a id="_25"></a>一、寻找药品数据</h3> 
<p>每一个药品都用了单独的标签页进行展示，那么每一个药品都会对应一个链接来获取数据，因此我们找到这些 URL 的规律就可以爬取了。</p> 
<p>我们点开第一个药品 <code>氨己烯酸</code> 和第二个药品 <code>奥卡西平</code>的详情页，在浏览器的地址栏中观察两个药品的URL：</p> 
<pre><code>https://med.ckcest.cn/details.html?id=5005884384970756&amp;classesEn=wiki&amp;searchValue=
https://med.ckcest.cn/details.html?id=5005884384954370&amp;classesEn=wiki&amp;searchValue=
</code></pre> 
<p>我们发现，URL仅在 id 部分发生了变化，其余完全相同。这意味着 <strong>id 即为每个药品数据的标识，我们只需要找到每个药品的 id ，对 URL 进行拼接就可以对应获取到单个药品数据了</strong>。</p> 
<p>因此，我们只需要拿到所有药品的 id 信息，然后遍历每一条 id ，就能依次拿到所有药品的数据了。那么药品的 id 信息又从哪拿呢，我们可以通过药品目录页进行爬取。</p> 
<p>接下来是具体的找 id 的步骤，这里我使用的是谷歌浏览器。<strong>注意，找数据是编写爬虫最关键的部分，这非常重要。</strong></p> 
<ul><li>第一步，用谷歌浏览器进入药品目录页</li></ul> 
<p><img src="https://images2.imgbox.com/07/0d/5kP6KJDC_o.png" alt="v5" width="800"></p> 
<ul><li>第二步，按 <code>F12</code> 键，打开浏览器的控制台，转到 <code>NetWork</code> 部分。（可以看到此时 Network 部分什么数据都没有）</li></ul> 
<p><img src="https://images2.imgbox.com/a3/08/ABCQBjZy_o.png" alt="v6" width="800"></p> 
<ul><li>第三步，键盘按 F5 进行页面刷新，<code>Network</code>部分会加载该页面的全部数据</li></ul> 
<p><img src="https://images2.imgbox.com/70/7f/tLJWianX_o.png" alt="v7"></p> 
<ul><li>第四步，在控制台左侧的 <code>Search</code> 窗口搜索第一条药品的名字 <code>氨己烯酸</code></li></ul> 
<p><img src="https://images2.imgbox.com/86/06/LS34ECD9_o.png" alt="v8" width="800"><br> 可以看到，搜出了两个对应链接，我们分别点击链接，右侧的 <code>response</code> 会具体展示其数据。</p> 
<p><img src="https://images2.imgbox.com/05/f7/mVgClP57_o.png" alt="v9"></p> 
<p>通过 response 的对比发现，queryDetail.do 是单个药品的数据信息，而 searchList.do 是这一页十条药品的数据汇集信息。很明显，我们需要的是所有药品的 id，所以我们应当去分析 searchList.do 。</p> 
<ul><li>第五步，点击 searchList.do，在右侧中查看其 <code>Header</code></li></ul> 
<p><img src="https://images2.imgbox.com/d3/98/iSC1wL2g_o.png" alt="v10"><br> 可以看到，该链接使用的是 get 请求方法，URL中包含了两个重要参数：<code>page=1</code> 和 <code>pageNum=10</code>。参数的暗示就很明显了，这是第一页，这一页包含了十条数据。</p> 
<ul><li>第六步，我们新开一个标签页，把这个 URL 复制进去，可以正常看到十条药品的信息。如果把 <code>page=1</code>改为<code>page=2</code>，就可以看到第二页的药品信息。</li></ul> 
<p><img src="https://images2.imgbox.com/01/e5/FhQIlRoP_o.png" alt="v11"><br> 当然，这样乱糟糟的页面是十分难看的，于是我装了一个浏览器插件：JSONVue，可以对 JSON 数据进行有效排列，展示会更加直观好看。（要装这个插件的自行百度就可以）。</p> 
<p>这一步是为了熟悉对应数据的 JSON 结构，方便之后的编码工作进行数据的提取。如果使用熟练的话则可以跳过此步。</p> 
<p><img src="https://images2.imgbox.com/6b/e6/eB1aEA2M_o.png" alt="v12"></p> 
<h3><a id="ID_72"></a>二、爬取药品ID</h3> 
<p>我们已经找到了药品 id 对应的链接，并且查看了对应数据的 JSON 格式，下面对药品 ID 进行爬取。</p> 
<p>简单分为以下几个函数进行编写：</p> 
<ol><li>资源获取函数 <code>getTotal()</code></li><li>数据提取函数 <code>findTotal()</code></li><li>资源保存函数 <code>saveTotal()</code></li><li>主函数 <code>main()</code></li></ol> 
<h4><a id="1_81"></a>1.资源获取</h4> 
<p>这里使用 request.get（）方法进行资源获取，有两个注意事项：</p> 
<ol><li>准备多个用户代理 UA 来随机选取</li><li>每爬取一次页面沉睡一些时间</li></ol> 
<p>这两点的作用都是模拟用户的操作，更好地<strong>避免爬取过快导致爬虫被识别</strong>。同时，使用 try-except 结构也能更好地捕捉异常情况。</p> 
<blockquote> 
 <p>Tips：如果报异常的话，可以考虑 time.sleep() 多沉睡一点时间，例如 5 秒</p> 
</blockquote> 
<p>getTotal（）函数有一个参数，就是需要资源获取的 URL</p> 
<pre><code class="prism language-python"><span class="token comment"># 设置代理</span>
UA <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/22.0.1207.1 Safari/537.1"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (X11; CrOS i686 2268.111.0) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.57 Safari/536.11"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.6 (KHTML, like Gecko) Chrome/20.0.1092.0 Safari/536.6"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (Windows NT 6.2) AppleWebKit/536.6 (KHTML, like Gecko) Chrome/20.0.1090.0 Safari/536.6"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/19.77.34.5 Safari/537.1"</span>
    <span class="token punctuation">]</span>

<span class="token comment"># 获取url资源</span>
<span class="token keyword">def</span> <span class="token function">getTotal</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>

    this_ua <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>UA<span class="token punctuation">)</span>    <span class="token comment"># 随机选用使用代理</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> this_ua
    <span class="token punctuation">}</span>

    params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'enc'</span><span class="token punctuation">:</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span> <span class="token comment"># 链接url</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 沉睡1秒，避免爬取过快</span>
        r<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>    			<span class="token comment"># 判断异常</span>
        r<span class="token punctuation">.</span>encoding <span class="token operator">=</span> r<span class="token punctuation">.</span>apparent_encoding  	<span class="token comment"># 转码</span>
        <span class="token comment"># print(r.json())</span>
        <span class="token keyword">return</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 返回json文件</span>

    <span class="token keyword">except</span> HTTPError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># 异常提示</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'总页面链接异常！！！'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'总页面链接异常！！！'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'总页面链接异常！！！'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">''</span>
</code></pre> 
<p>getTotal() 函数结束后会返回一个 json 文件，这个就是十条药品数据信息汇总的 json 文件。这里我给出第一条做个大概的示意</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token key atrule">showList</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"wiki;title"</span><span class="token punctuation">,</span>
            <span class="token string">"wiki;abstracts"</span><span class="token punctuation">,</span>
            <span class="token string">"wiki;keywords"</span><span class="token punctuation">,</span>
            <span class="token string">"wiki;drug_category"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token key atrule">search</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token key atrule">data</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        <span class="token string">"氨己烯酸"</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token key atrule">abstracts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        <span class="token string">"&lt;p&gt;常用于癫痫部分性发作，也可与其他抗癫痫药合用治疗难治性癫痫。还可用于儿童Lennox-Gastaut综合征和West综合征（婴儿痉挛症）。对癫痫小发作、肌阵挛发作效果欠佳。&lt;/p&gt;"</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token key atrule">keywords</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        <span class="token string">"婴儿痉挛"</span><span class="token punctuation">,</span>
                        <span class="token string">"发作"</span><span class="token punctuation">,</span>
                        <span class="token string">"肌阵挛"</span><span class="token punctuation">,</span>
                        <span class="token string">"癫痫"</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token key atrule">drug_category</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        <span class="token string">"神经系统用药"</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token key atrule">classEn</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        <span class="token string">"wiki"</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token key atrule">create_time</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
                        <span class="token key atrule">day</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
                        <span class="token key atrule">hours</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
                        <span class="token key atrule">minutes</span><span class="token punctuation">:</span> <span class="token number">31</span><span class="token punctuation">,</span>
                        <span class="token key atrule">month</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
                        <span class="token key atrule">seconds</span><span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
                        <span class="token key atrule">time</span><span class="token punctuation">:</span> <span class="token number">1594369910000</span><span class="token punctuation">,</span>
                        <span class="token key atrule">timezoneOffset</span><span class="token punctuation">:</span> <span class="token number">-480</span><span class="token punctuation">,</span>
                        <span class="token key atrule">year</span><span class="token punctuation">:</span> <span class="token number">120</span>
                    <span class="token punctuation">}</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token key atrule">classZh</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        <span class="token string">"百科"</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        <span class="token string">"5005884384970756"</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="2_188"></a>2.数据提取</h4> 
<p><strong>数据提取时这里有一个需要注意的点，不是所有的数据都是药品数据</strong>。例如在药品目录页的第三页，第22条是鼻出血、第23条是病毒性肺炎，它们都不是我们所要的药品信息，对于这些非药品可以直接忽略。</p> 
<p>于是，我去仔细对比了药品与非药品的 JSON 数据。通过对比发现，药品的数据中会有 <code>drug_category</code> 这个属性，而非药品是没有的。因此，我选择使用 <code>drug_category</code> 属性来鉴别药品。</p> 
<p>我们使用 findTotal（）函数来进行数据处理，该函数有两个参数，一个是待处理的 json 文件，一个是用于保存药品 id 信息的列表</p> 
<pre><code class="prism language-python"><span class="token comment"># 获取总体页面下各个药的ID</span>
<span class="token keyword">def</span> <span class="token function">findTotal</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> IdList<span class="token punctuation">)</span><span class="token punctuation">:</span>
    yaopinTotal <span class="token operator">=</span> json<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'search'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span>  <span class="token comment"># 定位药品总列表</span>
    <span class="token keyword">for</span> yaopin <span class="token keyword">in</span> yaopinTotal<span class="token punctuation">:</span>
        <span class="token comment"># drug_category存在的才是药物，存入其ID</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'drug_category'</span> <span class="token keyword">in</span> yaopin <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>yaopin<span class="token punctuation">[</span><span class="token string">'drug_category'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            yaopinId <span class="token operator">=</span> yaopin<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            IdList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>yaopinId<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 不存在的则不是药物，跳过即可</span>
            <span class="token keyword">continue</span>
</code></pre> 
<h4><a id="3_208"></a>3.资源保存</h4> 
<p>所有的药品 id 信息提取完成之后，我们将其保存到文件中。为了方便查找，这里我将其保存在代码的同级目录下</p> 
<p>saveTotal（）函数进行文件的保存，该函数有一个参数，就是保存药品 id 信息的列表</p> 
<pre><code class="prism language-python"><span class="token comment"># 保存资源</span>
<span class="token keyword">def</span> <span class="token function">saveTotal</span><span class="token punctuation">(</span>IdList<span class="token punctuation">)</span><span class="token punctuation">:</span>

    path <span class="token operator">=</span> <span class="token string">'./'</span>

    file_name <span class="token operator">=</span> <span class="token string">"药品ID.csv"</span>

    <span class="token comment"># 写入数据</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path <span class="token operator">+</span> file_name<span class="token punctuation">,</span> <span class="token string">'w+'</span><span class="token punctuation">,</span> newline<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        writer <span class="token operator">=</span> csv<span class="token punctuation">.</span>writer<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        writer<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ID'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 写入文件的表头</span>

        <span class="token keyword">for</span> u <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>IdList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            writer<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span><span class="token punctuation">[</span>IdList<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># 一次写入一行信息</span>

</code></pre> 
<h4><a id="4_231"></a>4.主函数</h4> 
<p>目录页有三种方式，分别展示十条、二十条、三十条。</p> 
<p><img src="https://images2.imgbox.com/a5/dd/XDnfbaX2_o.png" alt="v13"><br> 主函数中通过循环控制 <code>page</code> 、<code>pageNum</code> 两个参数即可生成 URL。这里我选择每次取三十条</p> 
<pre><code class="prism language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------------爬取开始--------------------"</span><span class="token punctuation">)</span>

    page <span class="token operator">=</span> <span class="token number">1</span>    <span class="token comment"># 控制页数和每页个数</span>
    nums <span class="token operator">=</span> <span class="token number">30</span>
    IdList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 所有的ID结果存放</span>

    <span class="token comment"># # 每页展示10条，一共214页。若每页展示30条，一共72页</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 提示信息</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"正在爬取第%d页"</span> <span class="token operator">%</span> i<span class="token punctuation">)</span>

        <span class="token comment"># 构造ID的URL</span>
        urlId <span class="token operator">=</span> <span class="token string">'https://med.ckcest.cn/searchList.do?'</span> \
              <span class="token string">'page='</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">''</span> \
            <span class="token string">'&amp;classen=wiki&amp;searchText=&amp;searchText2=&amp;sort=have_'</span> \
            <span class="token string">'abstracts+asc%3Bknowledge_map+desc%3Bwiki_first_letter+asc&amp;'</span> \
            <span class="token string">'pageNumber='</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">''</span> \
            <span class="token string">'&amp;userId='</span>

        jsonTotal <span class="token operator">=</span> getTotal<span class="token punctuation">(</span>urlId<span class="token punctuation">)</span> <span class="token comment"># 爬取页面</span>
        findTotal<span class="token punctuation">(</span>jsonTotal<span class="token punctuation">,</span> IdList<span class="token punctuation">)</span>    <span class="token comment"># 存入ID</span>

    saveTotal<span class="token punctuation">(</span>IdList<span class="token punctuation">)</span>   <span class="token comment"># 保存至文件</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------------爬取结束--------------------"</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="5_267"></a>5.总体代码</h4> 
<p>总体代码如下：</p> 
<pre><code class="prism language-python"><span class="token comment">#coding=utf-8</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> csv
<span class="token keyword">import</span> random
<span class="token keyword">import</span> time
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>error <span class="token keyword">import</span> HTTPError

<span class="token comment"># 设置代理</span>
UA <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/22.0.1207.1 Safari/537.1"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (X11; CrOS i686 2268.111.0) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.57 Safari/536.11"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.6 (KHTML, like Gecko) Chrome/20.0.1092.0 Safari/536.6"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (Windows NT 6.2) AppleWebKit/536.6 (KHTML, like Gecko) Chrome/20.0.1090.0 Safari/536.6"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/19.77.34.5 Safari/537.1"</span>
    <span class="token punctuation">]</span>

<span class="token comment"># 获取url资源</span>
<span class="token keyword">def</span> <span class="token function">getTotal</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>

    this_ua <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>UA<span class="token punctuation">)</span>    <span class="token comment"># 随机选用使用代理</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> this_ua
    <span class="token punctuation">}</span>

    params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'enc'</span><span class="token punctuation">:</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span> <span class="token comment"># 链接url</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 沉睡1秒，避免爬取过快</span>
        r<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>    			<span class="token comment"># 判断异常</span>
        r<span class="token punctuation">.</span>encoding <span class="token operator">=</span> r<span class="token punctuation">.</span>apparent_encoding  	<span class="token comment"># 转码</span>
        <span class="token comment"># print(r.json())</span>
        <span class="token keyword">return</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 返回json文件</span>

    <span class="token keyword">except</span> HTTPError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># 异常提示</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'总页面链接异常！！！'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'总页面链接异常！！！'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'总页面链接异常！！！'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">''</span>

<span class="token comment"># 获取总体页面下各个药的ID</span>
<span class="token keyword">def</span> <span class="token function">findTotal</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> IdList<span class="token punctuation">)</span><span class="token punctuation">:</span>
    yaopinTotal <span class="token operator">=</span> json<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'search'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span>  <span class="token comment"># 定位药品总列表</span>
    <span class="token keyword">for</span> yaopin <span class="token keyword">in</span> yaopinTotal<span class="token punctuation">:</span>
        <span class="token comment"># drug_category存在的才是药物，存入其ID</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'drug_category'</span> <span class="token keyword">in</span> yaopin <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>yaopin<span class="token punctuation">[</span><span class="token string">'drug_category'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            yaopinId <span class="token operator">=</span> yaopin<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            IdList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>yaopinId<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 不存在的则不是药物，跳过即可</span>
            <span class="token keyword">continue</span>

<span class="token comment"># 保存资源</span>
<span class="token keyword">def</span> <span class="token function">saveTotal</span><span class="token punctuation">(</span>IdList<span class="token punctuation">)</span><span class="token punctuation">:</span>

    path <span class="token operator">=</span> <span class="token string">'./'</span>

    file_name <span class="token operator">=</span> <span class="token string">"药品ID.csv"</span>

    <span class="token comment"># 写入数据</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path <span class="token operator">+</span> file_name<span class="token punctuation">,</span> <span class="token string">'w+'</span><span class="token punctuation">,</span> newline<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        writer <span class="token operator">=</span> csv<span class="token punctuation">.</span>writer<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        writer<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ID'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 写入文件的表头</span>

        <span class="token keyword">for</span> u <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>IdList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            writer<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span><span class="token punctuation">[</span>IdList<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># 一次写入一行信息</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------------爬取开始--------------------"</span><span class="token punctuation">)</span>

    page <span class="token operator">=</span> <span class="token number">1</span>    <span class="token comment"># 控制页数和每页个数</span>
    nums <span class="token operator">=</span> <span class="token number">30</span>
    IdList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 所有的ID结果存放</span>

    <span class="token comment"># # 每页展示10条，一共214页。若每页展示30条，一共72页</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 提示信息</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"正在爬取第%d页"</span> <span class="token operator">%</span> i<span class="token punctuation">)</span>

        <span class="token comment"># 构造ID的URL</span>
        urlId <span class="token operator">=</span> <span class="token string">'https://med.ckcest.cn/searchList.do?'</span> \
              <span class="token string">'page='</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">''</span> \
            <span class="token string">'&amp;classen=wiki&amp;searchText=&amp;searchText2=&amp;sort=have_'</span> \
            <span class="token string">'abstracts+asc%3Bknowledge_map+desc%3Bwiki_first_letter+asc&amp;'</span> \
            <span class="token string">'pageNumber='</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">''</span> \
            <span class="token string">'&amp;userId='</span>

        jsonTotal <span class="token operator">=</span> getTotal<span class="token punctuation">(</span>urlId<span class="token punctuation">)</span> <span class="token comment"># 爬取页面</span>
        findTotal<span class="token punctuation">(</span>jsonTotal<span class="token punctuation">,</span> IdList<span class="token punctuation">)</span>    <span class="token comment"># 存入ID</span>

    saveTotal<span class="token punctuation">(</span>IdList<span class="token punctuation">)</span>   <span class="token comment"># 保存至文件</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------------爬取结束--------------------"</span><span class="token punctuation">)</span>
</code></pre> 
<p>程序运行大概需要几分钟的时间，爬取完成的程序输出：</p> 
<p><img src="https://images2.imgbox.com/98/9d/kxpR5zrg_o.png" alt="v14"></p> 
<p>保存到的 药品ID.csv 文件如下图所示：</p> 
<p><img src="https://images2.imgbox.com/bc/0c/z1Mdfy3t_o.png" alt="v15"></p> 
<h3><a id="_377"></a>三、爬取药品信息</h3> 
<p>有了药品 id 之后，我们就可以爬取每个药品具体的数据了。</p> 
<p>还是以第一个药品 <code>氨己烯酸</code> 为例，我们去寻找它的数据，操作方法与本博客的第一节 <code>一、寻找药品数据</code> 完全一模一样。</p> 
<p>具体流程：在 <code>氨己烯酸</code> 的详情页，点击 F12，找到 <code>Network</code>，刷新加载数据后，搜索关键字 “氨己烯酸”。依次对比后发现 <code>queryDetail.do</code> 的 response 才与详情页的数据相匹配。</p> 
<p><img src="https://images2.imgbox.com/8a/c5/lY6PClsY_o.png" alt="v16"><br> 查看 <code>queryDetail.do</code> 的 <code>Header</code> 部分，发现其使用 的是 POST 请求方法，URL 链接是 https://med.ckcest.cn/queryDetails.do</p> 
<p><img src="https://images2.imgbox.com/c6/ed/xZN4qH3R_o.png" alt="v17"><br> 于是我们查看 <code>Payload</code> 部分，该部分写明了该链接要传递的参数是 id 和 nameEn</p> 
<p><img src="https://images2.imgbox.com/32/ec/4nmmaALQ_o.png" alt="v18"><br> 我们直接将参数拼接成一个新的 URL ：<code>https://med.ckcest.cn/queryDetails.do?id=5005884384970756&amp;nameEn=wiki</code>，在浏览器中开一个新窗口输入这个URL。可以看到，我们已经成功找到了该药品详情页的数据</p> 
<p><img src="https://images2.imgbox.com/93/d5/dSQlQsmE_o.png" alt="v19"><br> 药品的 ID 我们刚才已经爬取过了，可以再次编写爬虫爬取每个药品的详情数据了。</p> 
<p>这里大概分为五个函数：</p> 
<ol><li>加载资源ID <code>readerID()</code></li><li>获取数据 <code>getJson()</code></li><li>数据提取 <code>findJson()</code></li><li>保存信息 <code>saveMedicine()</code></li><li>主函数 <code>main()</code></li></ol> 
<h4><a id="1ID_403"></a>1.加载资源ID</h4> 
<p>药品ID.csv 是上一个爬虫程序爬取的关于所有药品 id 信息的文件，就放在同级目录下。</p> 
<p>readerID（）函数有一个参数，传入一个空列表，将 id 读取之后存入列表中</p> 
<pre><code class="prism language-python"><span class="token comment"># 加载ID资源</span>
<span class="token keyword">def</span> <span class="token function">readerId</span><span class="token punctuation">(</span>idList<span class="token punctuation">)</span><span class="token punctuation">:</span>

    path <span class="token operator">=</span> <span class="token string">'./'</span>
    file_name <span class="token operator">=</span> <span class="token string">"药品ID.csv"</span>

    <span class="token comment"># 打开csv文件</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path <span class="token operator">+</span> file_name<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> newline<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        reader <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        headers <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span>  <span class="token comment"># 读取表头</span>
        <span class="token keyword">for</span> row <span class="token keyword">in</span> reader<span class="token punctuation">:</span>      <span class="token comment"># 循环获取表头之后的每一行</span>
            idList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># 取第一列</span>
</code></pre> 
<h4><a id="2_423"></a>2.获取数据</h4> 
<p>写法与之前几乎没有区别，只是改成了 post 方法，需要定义 data 来传递参数。</p> 
<p>getJson（）函数有一个参数，接受传入的药品 id ，作为 post 的参数。</p> 
<pre><code class="prism language-python"><span class="token comment"># 设置代理</span>
UA <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/22.0.1207.1 Safari/537.1"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (X11; CrOS i686 2268.111.0) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.57 Safari/536.11"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.6 (KHTML, like Gecko) Chrome/20.0.1092.0 Safari/536.6"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (Windows NT 6.2) AppleWebKit/536.6 (KHTML, like Gecko) Chrome/20.0.1090.0 Safari/536.6"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/19.77.34.5 Safari/537.1"</span>
    <span class="token punctuation">]</span>


<span class="token comment"># 获取url请求</span>
<span class="token keyword">def</span> <span class="token function">getJson</span><span class="token punctuation">(</span>medicineID<span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">'https://med.ckcest.cn/queryDetails.do'</span>
    this_ua <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>UA<span class="token punctuation">)</span>    <span class="token comment"># 随机选用使用代理</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> this_ua
    <span class="token punctuation">}</span>

    <span class="token comment"># 关键参数</span>
    data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'id'</span><span class="token punctuation">:</span> medicineID<span class="token punctuation">,</span>
        <span class="token string">'nameEn'</span><span class="token punctuation">:</span> <span class="token string">'wiki'</span>
    <span class="token punctuation">}</span>

    params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'enc'</span><span class="token punctuation">:</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span> <span class="token comment"># 链接url</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 避免爬取过快</span>
        r<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 判断异常</span>
        r<span class="token punctuation">.</span>encoding <span class="token operator">=</span> r<span class="token punctuation">.</span>apparent_encoding  <span class="token comment"># 转码</span>
        <span class="token comment"># print(r.json())</span>
        <span class="token keyword">return</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 返回json文件</span>

    <span class="token keyword">except</span> HTTPError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># 异常提示</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'链接异常！！！'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'链接异常！！！'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'链接异常！！！'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">''</span>
</code></pre> 
<h4><a id="3_473"></a>3.数据提取</h4> 
<p>数据提取这部分比较麻烦，因为它存在两个问题。</p> 
<p><strong>第一是每个药品数据属性不统一的问题</strong>。每条数据从 “keys” 属性大概分为头部和尾部两部分。在数据的头部，每一个药品从 titleZh 到 speciesZh 一共有固定的 14 个中文属性；但是在数据的尾部，有具体值的属性大概在5——10个不等。例如<code>氨己烯酸</code>一共有 8 个有具体值的属性，而 <code>氨力农</code> 却有 10 个属性有值。</p> 
<p>以下是<code>氨己烯酸</code>的详细数据：</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token string">"5005884384970756"</span><span class="token punctuation">,</span>
        <span class="token key atrule">classZh</span><span class="token punctuation">:</span> <span class="token string">"百科"</span><span class="token punctuation">,</span>
        <span class="token key atrule">titleZh</span><span class="token punctuation">:</span> <span class="token string">"名称"</span><span class="token punctuation">,</span>
        <span class="token key atrule">abstractsZh</span><span class="token punctuation">:</span> <span class="token string">"简介"</span><span class="token punctuation">,</span>
        <span class="token key atrule">symptomsZh</span><span class="token punctuation">:</span> <span class="token string">"症状"</span><span class="token punctuation">,</span>
        <span class="token key atrule">diagnosisZh</span><span class="token punctuation">:</span> <span class="token string">"诊断"</span><span class="token punctuation">,</span>
        <span class="token key atrule">treatmentZh</span><span class="token punctuation">:</span> <span class="token string">"治疗"</span><span class="token punctuation">,</span>
        <span class="token key atrule">checksZh</span><span class="token punctuation">:</span> <span class="token string">"检查"</span><span class="token punctuation">,</span>
        <span class="token key atrule">keywordsZh</span><span class="token punctuation">:</span> <span class="token string">"关键词"</span><span class="token punctuation">,</span>
        <span class="token key atrule">drug_aliasesZh</span><span class="token punctuation">:</span> <span class="token string">"药物别名"</span><span class="token punctuation">,</span>
        <span class="token key atrule">drug_propertiesZh</span><span class="token punctuation">:</span> <span class="token string">"药物性状"</span><span class="token punctuation">,</span>
        <span class="token key atrule">drug_indicationsZh</span><span class="token punctuation">:</span> <span class="token string">"药物适应症"</span><span class="token punctuation">,</span>
        <span class="token key atrule">adverse_drug_reactionsZh</span><span class="token punctuation">:</span> <span class="token string">"药物不良反应"</span><span class="token punctuation">,</span>
        <span class="token key atrule">matters_needing_attentionZh</span><span class="token punctuation">:</span> <span class="token string">"注意事项"</span><span class="token punctuation">,</span>
        <span class="token key atrule">contraindicationZh</span><span class="token punctuation">:</span> <span class="token string">"禁忌症"</span><span class="token punctuation">,</span>
        <span class="token key atrule">speciesZh</span><span class="token punctuation">:</span> <span class="token string">"百科分类"</span><span class="token punctuation">,</span>
        <span class="token key atrule">keys</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"title"</span><span class="token punctuation">,</span>
            <span class="token string">"abstracts"</span><span class="token punctuation">,</span>
            <span class="token string">"symptoms"</span><span class="token punctuation">,</span>
            <span class="token string">"diagnosis"</span><span class="token punctuation">,</span>
            <span class="token string">"treatment"</span><span class="token punctuation">,</span>
            <span class="token string">"checks"</span><span class="token punctuation">,</span>
            <span class="token string">"keywords"</span><span class="token punctuation">,</span>
            <span class="token string">"drug_aliases"</span><span class="token punctuation">,</span>
            <span class="token string">"drug_properties"</span><span class="token punctuation">,</span>
            <span class="token string">"drug_indications"</span><span class="token punctuation">,</span>
            <span class="token string">"adverse_drug_reactions"</span><span class="token punctuation">,</span>
            <span class="token string">"matters_needing_attention"</span><span class="token punctuation">,</span>
            <span class="token string">"contraindication"</span><span class="token punctuation">,</span>
            <span class="token string">"species"</span><span class="token punctuation">,</span>
            <span class="token string">"classZh"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">"氨己烯酸"</span><span class="token punctuation">,</span>
        <span class="token key atrule">abstracts</span><span class="token punctuation">:</span> <span class="token string">"&lt;p&gt;常用于癫痫部分性发作，也可与其他抗癫痫药合用治疗难治性癫痫。还可用于儿童Lennox-Gastaut综合征和West综合征（婴儿痉挛症）。对癫痫小发作、肌阵挛发作效果欠佳。&lt;/p&gt;"</span><span class="token punctuation">,</span>
        <span class="token key atrule">keywords</span><span class="token punctuation">:</span> <span class="token string">"婴儿痉挛;发作;肌阵挛;癫痫"</span><span class="token punctuation">,</span>
        <span class="token key atrule">drug_aliases</span><span class="token punctuation">:</span> <span class="token string">"&lt;p&gt;思波平；喜保宁；Gamma-vinyl;aminobutyric;acid;Sabril;Sabrilex;Vigabatrinum;Vinylaminobutyricacid;&lt;/p&gt;"</span><span class="token punctuation">,</span>
        <span class="token key atrule">drug_indications</span><span class="token punctuation">:</span> <span class="token string">"&lt;p&gt;常用于癫痫部分性发作，也可与其他抗癫痫药合用治疗难治性癫痫。还可用于儿童Lennox-Gastaut综合征和West综合征（婴儿痉挛症）。对癫痫小发作、肌阵挛发作效果欠佳。&lt;/p&gt;"</span><span class="token punctuation">,</span>
        <span class="token key atrule">adverse_drug_reactions</span><span class="token punctuation">:</span> "&lt;p<span class="token punctuation">&gt;</span>    1．可见嗜睡、头晕、头痛、疲乏、体重增加、易激惹、神经质等。
            2．当本药用于代替其他抗癫痫药时应逐渐增量。联合用药时亦应逐渐增加剂量，以达到所需的血药浓度。当与静脉注射用地西泮合用时，本药初次剂量可以较大，以迅速达到有效治疗浓度。
            3．当成人剂量超过一日1.5g，6岁以下儿童剂量超过1g时，应密切注意毒性反应。
            4．急性过量产生中枢抑制症状，包括呼吸抑制、昏迷。
            5．用药过量的处理：包括催吐（除非患者很快得到缓解或处于昏睡、痉挛状态）、洗胃、活性炭吸附、导泻以及常规支持治疗。必要时可使用血液透析。&lt;/p<span class="token punctuation">&gt;</span>"<span class="token punctuation">,</span>
        <span class="token key atrule">matters_needing_attention</span><span class="token punctuation">:</span> "&lt;p<span class="token punctuation">&gt;</span>    1．慎用：肾功能不全者。
            2．药物对老人的影响：老年患者慎用本药。
            3．药物对妊娠的影响：大剂量时在动物实验中观察到胎仔畸形，孕妇不宜使用。
            4．药物对哺乳的影响：哺乳妇女不宜使用本药。
            5．用药前后及用药时：应当检查或监测长期服用本药的患者，应每6个月做1次眼科检查（尤其是视野检查）。&lt;/p<span class="token punctuation">&gt;</span>"<span class="token punctuation">,</span>
        <span class="token key atrule">species</span><span class="token punctuation">:</span> <span class="token string">"medicine"</span><span class="token punctuation">,</span>
        <span class="token key atrule">fileServer</span><span class="token punctuation">:</span> <span class="token string">"https://med.ckcest.cn/attachments_la/"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>针对这种情况，我的做法是，依次从数据头部取出 14 个属性的英文名，然后按英文名对比是否有值。因为 JSON 数据是键值对的形式，很好地支持了这种对比。</p> 
<p>例如，titleZh 是“名称” 属性，我把最后两个字母 Zh 去掉，剩下 title，查找 title 键是否有值。如果该属性比对有值，则记录；如果结果是 None，则证明该属性没有具体值，直接跳过。</p> 
<p><strong>第二个问题是某些属性值存在 <code>&lt;p&gt;</code> 这样的 html 标签，以及 <code>\r\n</code> 换行符</strong>。</p> 
<p>关于 <code>&lt;p&gt;</code> 标签，我考虑使用正则表达式进行去除，将该标签全部替换为空值。</p> 
<pre><code class="prism language-python"><span class="token comment"># 这是一个示例</span>
value <span class="token operator">=</span> <span class="token string">"&lt;p&gt; 1．可见嗜睡、头晕、头痛、疲乏、体重增加、易激惹、神经质等。&lt;/p&gt;"</span>
regex <span class="token operator">=</span> <span class="token string">r'&lt;/?p&gt;'</span>  <span class="token comment"># 正则检索 p 标签</span>
value <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>regex<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> re<span class="token punctuation">.</span>I<span class="token punctuation">)</span>  <span class="token comment"># sub函数替换p标签为空，re.I不区分大小写</span>
</code></pre> 
<p>至于<code>\r\n</code> 换行符，使用自带的 replace 函数将其替换为空值即可。不过这里有个小细节，<code>\r\n</code>这种连在一起的换行符，必须要连写在一起才能生效</p> 
<pre><code class="prism language-python"><span class="token comment"># 有效写法</span>
value<span class="token operator">=</span> value<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

<span class="token comment"># 无效写法</span>
value <span class="token operator">=</span> value<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
value <span class="token operator">=</span> value<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
</code></pre> 
<p>最后我使用了两个列表，第一个列表存入中文属性名，第二个列表存入对应属性值，最后把两个列表都统一存入一个新列表中，进行数据传递。</p> 
<p>findJson（）函数有两个参数，第一个参数是待处理的 Json 文件，第二个参数是传递数据的统一列表。</p> 
<pre><code class="prism language-python"><span class="token comment"># 处理json</span>
<span class="token keyword">def</span> <span class="token function">findJson</span><span class="token punctuation">(</span>pageJson<span class="token punctuation">,</span> medicineInfo<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> pageJson<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 获取列表中的键值对对象</span>
    keysTmp <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 转化为列表方便操作</span>
    keysTmp <span class="token operator">=</span> keysTmp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 去除最前面的两个键,id和class</span>


    realKeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>       <span class="token comment"># 保存键</span>
    realValues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>     <span class="token comment"># 保存值</span>

    <span class="token keyword">for</span> key <span class="token keyword">in</span> keysTmp<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span>__eq__<span class="token punctuation">(</span><span class="token string">"keys"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 只取keys之前的做匹配</span>
            <span class="token keyword">break</span>
        key2 <span class="token operator">=</span> key<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># 去除最后两个字母Zh 再进行匹配</span>
        valueRaw <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key2<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">not</span> valueRaw <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 如果找得到值，证明value存在，加入</span>
            <span class="token comment"># 此步进行数据清洗，去除p标签，\r\n</span>
            regex <span class="token operator">=</span> <span class="token string">r'&lt;/?p&gt;'</span>  <span class="token comment"># 正则检索 p 标签</span>
            value <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>regex<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> valueRaw<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span> re<span class="token punctuation">.</span>I<span class="token punctuation">)</span>  <span class="token comment"># sub函数替换p标签为空，re.I不区分大小写</span>

            <span class="token comment"># 数据加入key-value队列</span>
            realKeys<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
            realValues<span class="token punctuation">.</span>append<span class="token punctuation">(</span>value<span class="token punctuation">)</span>

    <span class="token comment"># 保存药品的键值对列表信息</span>
    medicineInfo<span class="token punctuation">.</span>append<span class="token punctuation">(</span>realKeys<span class="token punctuation">)</span>
    medicineInfo<span class="token punctuation">.</span>append<span class="token punctuation">(</span>realValues<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="4_595"></a>4.保存信息</h4> 
<p>写法与之前基本一样，文件名由具体的药品名称来命名，保存在同级目录下</p> 
<p>这里我选择的是第一列写入属性名，第二列写入属性值。（当然也可以按照自己的需求来进行更改）</p> 
<p>saveMedicine（）函数有一个参数，即 findJson 函数处理好的数据列表</p> 
<pre><code class="prism language-python"><span class="token comment"># 保存药品信息</span>
<span class="token keyword">def</span> <span class="token function">saveMedicine</span><span class="token punctuation">(</span>medicineInfo<span class="token punctuation">)</span><span class="token punctuation">:</span>

    path <span class="token operator">=</span> <span class="token string">'./'</span>
    file_name <span class="token operator">=</span> medicineInfo<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".csv"</span>

    <span class="token comment"># 写入数据</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path <span class="token operator">+</span> file_name<span class="token punctuation">,</span> <span class="token string">'w+'</span><span class="token punctuation">,</span> newline<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>     <span class="token comment"># newline=''保证逐行写入</span>
        writer <span class="token operator">=</span> csv<span class="token punctuation">.</span>writer<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

        <span class="token keyword">for</span> u <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>medicineInfo<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                writer<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span><span class="token punctuation">[</span>medicineInfo<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span> medicineInfo<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 一次写入一行信息</span>
</code></pre> 
<p>效果大概是这个样子</p> 
<p><img src="https://images2.imgbox.com/65/6d/03BwKEwY_o.png" alt="v20"></p> 
<h4><a id="5_620"></a>5.主函数</h4> 
<p>主函数的写法与之前也基本一样。因为每个药品要生成一个文件，所以把保存数据写在了循环里面</p> 
<pre><code class="prism language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------------爬取开始--------------------"</span><span class="token punctuation">)</span>

    idList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    readerId<span class="token punctuation">(</span>idList<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>idList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 每一个ID都是页面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 提示信息</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"正在爬取第%d页"</span> <span class="token operator">%</span> i<span class="token punctuation">)</span>

        pageJson <span class="token operator">=</span> getJson<span class="token punctuation">(</span>idList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># print(pageJson)</span>

        medicineInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>           <span class="token comment"># 药品信息</span>
        findJson<span class="token punctuation">(</span>pageJson<span class="token punctuation">,</span> medicineInfo<span class="token punctuation">)</span>    <span class="token comment"># 提取药品信息</span>

        saveMedicine<span class="token punctuation">(</span>medicineInfo<span class="token punctuation">)</span>  <span class="token comment"># 药品保存到文件</span>


    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------------爬取结束--------------------"</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="6_646"></a>6.总体代码</h4> 
<p>总体代码如下：</p> 
<pre><code class="prism language-python"><span class="token comment">#coding=utf-8</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> csv
<span class="token keyword">import</span> re
<span class="token keyword">import</span> random
<span class="token keyword">import</span> time
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>error <span class="token keyword">import</span> HTTPError


<span class="token comment"># 设置代理</span>
UA <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/22.0.1207.1 Safari/537.1"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (X11; CrOS i686 2268.111.0) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.57 Safari/536.11"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.6 (KHTML, like Gecko) Chrome/20.0.1092.0 Safari/536.6"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (Windows NT 6.2) AppleWebKit/536.6 (KHTML, like Gecko) Chrome/20.0.1090.0 Safari/536.6"</span><span class="token punctuation">,</span>
        <span class="token string">"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/19.77.34.5 Safari/537.1"</span>
    <span class="token punctuation">]</span>


<span class="token comment"># 获取url请求</span>
<span class="token keyword">def</span> <span class="token function">getJson</span><span class="token punctuation">(</span>medicineID<span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">'https://med.ckcest.cn/queryDetails.do'</span>
    this_ua <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>UA<span class="token punctuation">)</span>    <span class="token comment"># 随机选用使用代理</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> this_ua
    <span class="token punctuation">}</span>

    <span class="token comment"># 关键参数</span>
    data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'id'</span><span class="token punctuation">:</span> medicineID<span class="token punctuation">,</span>
        <span class="token string">'nameEn'</span><span class="token punctuation">:</span> <span class="token string">'wiki'</span>
    <span class="token punctuation">}</span>

    params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'enc'</span><span class="token punctuation">:</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span> <span class="token comment"># 链接url</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 避免爬取过快</span>
        r<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 判断异常</span>
        r<span class="token punctuation">.</span>encoding <span class="token operator">=</span> r<span class="token punctuation">.</span>apparent_encoding  <span class="token comment"># 转码</span>
        <span class="token comment"># print(r.json())</span>
        <span class="token keyword">return</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 返回json文件</span>

    <span class="token keyword">except</span> HTTPError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># 异常提示</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'链接异常！！！'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'链接异常！！！'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'链接异常！！！'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">''</span>


<span class="token comment"># 处理json</span>
<span class="token keyword">def</span> <span class="token function">findJson</span><span class="token punctuation">(</span>pageJson<span class="token punctuation">,</span> medicineInfo<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> pageJson<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 获取列表中的键值对对象</span>
    keysTmp <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 转化为列表方便操作</span>
    keysTmp <span class="token operator">=</span> keysTmp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 去除最前面的两个键,id和class</span>


    realKeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>       <span class="token comment"># 保存键</span>
    realValues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>     <span class="token comment"># 保存值</span>

    <span class="token keyword">for</span> key <span class="token keyword">in</span> keysTmp<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span>__eq__<span class="token punctuation">(</span><span class="token string">"keys"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 只取keys之前的做匹配</span>
            <span class="token keyword">break</span>
        key2 <span class="token operator">=</span> key<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># 去除最后两个字母Zh 再进行匹配</span>
        valueRaw <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key2<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">not</span> valueRaw <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 如果找得到值，证明value存在，加入</span>
            <span class="token comment"># 此步进行数据清洗，去除p标签，\r\n</span>
            regex <span class="token operator">=</span> <span class="token string">r'&lt;/?p&gt;'</span>  <span class="token comment"># 正则检索 p 标签</span>
            value <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>regex<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> valueRaw<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\r'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span> re<span class="token punctuation">.</span>I<span class="token punctuation">)</span>  <span class="token comment"># sub函数替换p标签为空，re.I不区分大小写</span>

            <span class="token comment"># 数据加入key-value队列</span>
            realKeys<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
            realValues<span class="token punctuation">.</span>append<span class="token punctuation">(</span>value<span class="token punctuation">)</span>

    <span class="token comment"># 保存药品的键值对列表信息</span>
    medicineInfo<span class="token punctuation">.</span>append<span class="token punctuation">(</span>realKeys<span class="token punctuation">)</span>
    medicineInfo<span class="token punctuation">.</span>append<span class="token punctuation">(</span>realValues<span class="token punctuation">)</span>

<span class="token comment"># 加载ID资源</span>
<span class="token keyword">def</span> <span class="token function">readerId</span><span class="token punctuation">(</span>idList<span class="token punctuation">)</span><span class="token punctuation">:</span>

    path <span class="token operator">=</span> <span class="token string">'./'</span>
    file_name <span class="token operator">=</span> <span class="token string">"药品ID.csv"</span>

    <span class="token comment"># 打开csv文件</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path <span class="token operator">+</span> file_name<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> newline<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        reader <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        headers <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span>  <span class="token comment"># 读取表头</span>
        <span class="token keyword">for</span> row <span class="token keyword">in</span> reader<span class="token punctuation">:</span>      <span class="token comment"># 循环获取表头之后的每一行</span>
            idList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># 取第一列</span>



<span class="token comment"># 保存药品信息</span>
<span class="token keyword">def</span> <span class="token function">saveMedicine</span><span class="token punctuation">(</span>medicineInfo<span class="token punctuation">)</span><span class="token punctuation">:</span>

    path <span class="token operator">=</span> <span class="token string">'./'</span>
    file_name <span class="token operator">=</span> medicineInfo<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".csv"</span>

    <span class="token comment"># 写入数据</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path <span class="token operator">+</span> file_name<span class="token punctuation">,</span> <span class="token string">'w+'</span><span class="token punctuation">,</span> newline<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>     <span class="token comment"># newline=''保证逐行写入</span>
        writer <span class="token operator">=</span> csv<span class="token punctuation">.</span>writer<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

        <span class="token keyword">for</span> u <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>medicineInfo<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                writer<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span><span class="token punctuation">[</span>medicineInfo<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span> medicineInfo<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 一次写入一行信息</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------------爬取开始--------------------"</span><span class="token punctuation">)</span>

    idList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    readerId<span class="token punctuation">(</span>idList<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>idList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 每一个ID都是页面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 提示信息</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"正在爬取第%d页"</span> <span class="token operator">%</span> i<span class="token punctuation">)</span>

        pageJson <span class="token operator">=</span> getJson<span class="token punctuation">(</span>idList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># print(pageJson)</span>

        medicineInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>           <span class="token comment"># 药品信息</span>
        findJson<span class="token punctuation">(</span>pageJson<span class="token punctuation">,</span> medicineInfo<span class="token punctuation">)</span>    <span class="token comment"># 提取药品信息</span>

        saveMedicine<span class="token punctuation">(</span>medicineInfo<span class="token punctuation">)</span>  <span class="token comment"># 药品保存到文件</span>


    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------------爬取结束--------------------"</span><span class="token punctuation">)</span>
</code></pre> 
<p>因为每一页都要进行文件写入，所以程序运行时间会比较长，大概需要十分钟。爬取完成的程序输出：</p> 
<p><img src="https://images2.imgbox.com/ed/b0/A4OJb6Yw_o.png" alt="v21"></p> 
<p>最终写入的文件如下：</p> 
<p><img src="https://images2.imgbox.com/7b/c0/YLBFbXwp_o.png" alt="v22"><br> <img src="https://images2.imgbox.com/a0/79/kHzvvrIk_o.png" alt="v23"></p> 
<h3><a id="_794"></a>小结</h3> 
<p>要写好一个爬虫进行数据的爬取，还是挺劳心费神。</p> 
<p>必须得对网页的数据加载方式有一个清晰的认知，对于JSON数据的传递链接有合理的分析。抓取到数据之后，要想方法筛选提炼数据，还要按自己所需要的格式进行清洗。</p> 
<p>我在提取药品详细数据时，所使用的键值对的对比方法，也不见得是很好的，它只是我个人想到的一个可以完成当前任务的方法。大家也可以再想想别的办法来处理数据，很可能就比我这个更好。</p> 
<p><strong>拥有良好的编程基础，加上清晰的分析方法，才能有效地完成任务</strong>。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3f1d285d932ed1572c1e21d27c31b1e5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Quartus II 18.1的下载安装和注册</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9975050f66a73c95f759745013e49635/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【NODE.JS】多进程架构（一）——基本概念</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>