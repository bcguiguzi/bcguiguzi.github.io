<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>QSIP驱动W25Q256调试记录 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="QSIP驱动W25Q256调试记录" />
<meta property="og:description" content="QSIP驱动W25Q256调试记录 发现异常初始化配置指令时序分析与驱动函数W25Q256JV 数据手册纠错 驱动函数编程读Flash:0x6C纠错 扇区擦除:0x21写FLASH(最大256字节）:0x34 总结：补充说明（等待FLASH空闲） 记录调试QSPI方式驱动W25Q256，其中以正点原子和野火的STM32F767系列的例程作为参考。
发现异常 正点原子 &amp; 野火 例程中有水分,不适合参考指令。W25Q256JV 数据手册中部分指令的图表与时序图不符。 初始化配置 引脚初始化 /** * @brief QSPI引脚初始化 * @param None * @retval None */ void HAL_QSPI_MspInit(QSPI_HandleTypeDef *hqspi) { //忽略 } QSPI模式初始化 /** * @brief QSPI模式初始化 * @param None * @retval 失败回复QSPI_ERROR ，成功回复QSPI_OK */ uint8_t QSPI_Init(void) { QSPI_Handler.Instance = QUADSPI; //QSPI QSPI_Handler.Init.ClockPrescaler = 1; QSPI_Handler.Init.FifoThreshold = 4; QSPI_Handler.Init.SampleShifting = QSPI_SAMPLE_SHIFTING_HALFCYCLE; QSPI_Handler.Init.FlashSize = 25 - 1; QSPI_Handler.Init.ChipSelectHighTime = QSPI_CS_HIGH_TIME_6_CYCLE; QSPI_Handler." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/71d382032e1cace359499dca5c50f4c0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-11T10:37:38+08:00" />
<meta property="article:modified_time" content="2021-05-11T10:37:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">QSIP驱动W25Q256调试记录</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>QSIP驱动W25Q256调试记录</h4> 
 <ul><li><a href="#_6" rel="nofollow">发现异常</a></li><li><a href="#_11" rel="nofollow">初始化配置</a></li><li><a href="#_97" rel="nofollow">指令时序分析与驱动函数</a></li><li><ul><li><a href="#W25Q256JV__98" rel="nofollow">W25Q256JV 数据手册</a></li><li><ul><li><ul><li><a href="#_113" rel="nofollow">纠错</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_117" rel="nofollow">驱动函数编程</a></li><li><ul><li><a href="#Flash0x6C_119" rel="nofollow">读Flash:0x6C</a></li><li><ul><li><a href="#_170" rel="nofollow">纠错</a></li></ul> 
    </li><li><a href="#0x21_204" rel="nofollow">扇区擦除:0x21</a></li><li><a href="#FLASH2560x34_249" rel="nofollow">写FLASH(最大256字节）:0x34</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_298" rel="nofollow">总结：</a></li><li><a href="#FLASH_304" rel="nofollow">补充说明（等待FLASH空闲）</a></li></ul> 
</div> 
<p></p> 
<p><strong>记录调试QSPI方式驱动W25Q256，其中以正点原子和野火的STM32F767系列的例程作为参考。</strong></p> 
<h2><a id="_6"></a>发现异常</h2> 
<ol><li><strong>正点原子</strong> &amp; <strong>野火</strong> 例程中有水分,不适合参考指令。</li><li><strong>W25Q256JV</strong> 数据手册中部分指令的图表与时序图不符。</li></ol> 
<h2><a id="_11"></a>初始化配置</h2> 
<ul><li>引脚初始化</li></ul> 
<pre><code class="prism language-javascript"><span class="token comment">/**
  * @brief  QSPI引脚初始化
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">HAL_QSPI_MspInit</span><span class="token punctuation">(</span>QSPI_HandleTypeDef <span class="token operator">*</span>hqspi<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">//忽略</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>QSPI模式初始化</li></ul> 
<pre><code class="prism language-javascript"><span class="token comment">/**
  * @brief  QSPI模式初始化
  * @param  None
  * @retval 失败回复QSPI_ERROR ，成功回复QSPI_OK
  */</span>
uint8_t <span class="token function">QSPI_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QSPI_Handler<span class="token punctuation">.</span>Instance <span class="token operator">=</span> <span class="token constant">QUADSPI</span><span class="token punctuation">;</span>                                  <span class="token comment">//QSPI</span>
    QSPI_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ClockPrescaler   <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                       
    QSPI_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>FifoThreshold    <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>                          
    QSPI_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>SampleShifting   <span class="token operator">=</span> <span class="token constant">QSPI_SAMPLE_SHIFTING_HALFCYCLE</span><span class="token punctuation">;</span>
    QSPI_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>FlashSize      <span class="token operator">=</span> <span class="token number">25</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>                        
    QSPI_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ChipSelectHighTime <span class="token operator">=</span> <span class="token constant">QSPI_CS_HIGH_TIME_6_CYCLE</span><span class="token punctuation">;</span>
    QSPI_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ClockMode      <span class="token operator">=</span> <span class="token constant">QSPI_CLOCK_MODE_0</span><span class="token punctuation">;</span>            
    QSPI_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>FlashID       <span class="token operator">=</span> <span class="token constant">QSPI_FLASH_ID_1</span><span class="token punctuation">;</span>               
    QSPI_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>DualFlash      <span class="token operator">=</span> <span class="token constant">QSPI_DUALFLASH_DISABLE</span><span class="token punctuation">;</span>     
    <span class="token function">HAL_QSPI_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>QSPI_Handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* 设置QSPI存储器为4字节地址模式 */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">QSPI_SetMode_4ByteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">QSPI_OK</span><span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"QSPI_ERROR \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">QSPI_ERROR</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token constant">QSPI_OK</span><span class="token punctuation">;</span>

</code></pre> 
<ul><li>初始化要点<br> 初始化后，应该马上将地址模式设置为“4字节模式”。<br> 指令：0xB7<br> 检验是否初始化成功，可以使用读ID指令检验。后述有驱动配置细讲，不再贴代码。</li></ul> 
<pre><code class="prism language-javascript"><span class="token comment">/**
 * @brief  设置QSPI存储器为4字节地址模式(该函数只能在单线模式下）
 * @param  None
 * @retval 失败回复QSPI_ERROR ，成功回复QSPI_OK
 */</span>
uint8_t <span class="token function">QSPI_SetMode_4ByteAddr</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
QSPI_CommandTypeDef s_cmd<span class="token punctuation">;</span>
 <span class="token comment">/*可以通过读SR3来查看ADS位确定是否需要继续*/</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">W25Q_ReadSR</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">W25Q_FSR3_ADS</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"4ByteAddr already set! \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token constant">QSPI_OK</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
s_cmd<span class="token punctuation">.</span>InstructionMode   <span class="token operator">=</span> <span class="token constant">QSPI_INSTRUCTION_1_LINE</span><span class="token punctuation">;</span>        <span class="token comment">//指令模式 :单线</span>
s_cmd<span class="token punctuation">.</span>Instruction       <span class="token operator">=</span> W25X_Enable4ByteAddr<span class="token punctuation">;</span>              <span class="token comment">//指令0xB7 </span>
s_cmd<span class="token punctuation">.</span>AddressMode       <span class="token operator">=</span> <span class="token constant">QSPI_ADDRESS_NONE</span><span class="token punctuation">;</span>               <span class="token comment">//地址模式 :无</span>
s_cmd<span class="token punctuation">.</span>Address      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                         					    <span class="token comment">//地址   :无</span>
s_cmd<span class="token punctuation">.</span>AlternateByteMode <span class="token operator">=</span> <span class="token constant">QSPI_ALTERNATE_BYTES_NONE</span><span class="token punctuation">;</span>    <span class="token comment">//交替字节 :无</span>
s_cmd<span class="token punctuation">.</span>DataMode          <span class="token operator">=</span> <span class="token constant">QSPI_DATA_NONE</span><span class="token punctuation">;</span>     	   	 <span class="token comment">//数据   :无        </span>
s_cmd<span class="token punctuation">.</span>NbData       <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            			  			  <span class="token comment">//数据长度 :0      </span>
s_cmd<span class="token punctuation">.</span>DummyCycles       <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            		  			  <span class="token comment">//空周期  :0</span>
s_cmd<span class="token punctuation">.</span>DdrMode           <span class="token operator">=</span> <span class="token constant">QSPI_DDR_MODE_DISABLE</span><span class="token punctuation">;</span>      <span class="token comment">//DDR   :禁止</span>
s_cmd<span class="token punctuation">.</span>DdrHoldHalfCycle  <span class="token operator">=</span> <span class="token constant">QSPI_DDR_HHC_ANALOG_DELAY</span><span class="token punctuation">;</span>    <span class="token comment">//DDR延迟 :模拟延迟</span>
s_cmd<span class="token punctuation">.</span>SIOOMode          <span class="token operator">=</span> <span class="token constant">QSPI_SIOO_INST_EVERY_CMD</span><span class="token punctuation">;</span>    <span class="token comment">//SIO0模式:不起作用</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_QSPI_Command</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>QSPI_Handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s_cmd<span class="token punctuation">,</span> <span class="token constant">QPSI_TIMEOUT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">HAL_OK</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token constant">QSPI_ERROR</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>到此处，QSPI初始化已经完成。但在正点原子的例程中，初始化有进入QSPI模式的指令操作，<strong>指令0x38</strong>，但在W25Q256JV手册搜索并未发现该指令。查找发现 W25Q256的其他系列（非JV)有出现过0x38的指令。</li><li>经测试，使用EnterQPIMode指令后，指令模式只能使用4线，无法再用单线指令，而数据手册时序图皆以单线指令作为指引。<br> 所以此处不建议继续参考正点原子的例程，会带来不必要的麻烦。</li></ul> 
<pre><code class="prism language-javascript">#define W25X_EnterQPIMode       <span class="token number">0x38</span> <span class="token comment">//正点原子的非jv系列指令，不建议再使用</span>
</code></pre> 
<hr> 
<h2><a id="_97"></a>指令时序分析与驱动函数</h2> 
<h3><a id="W25Q256JV__98"></a>W25Q256JV 数据手册</h3> 
<p>数据手册Instruction Set Table四个图表需要重点理解，分别是</p> 
<pre><code>8.1.2 Instruction Set Table 1 (Standard/Dual/Quad SPI, 3-Byte Address Mode)
8.1.3 Instruction Set Table 2 (Dual/Quad SPI Instructions,3-Byte Address Mode)
8.1.4 Instruction Set Table 3 (Standard SPI, 4-Byte Address Mode)
8.1.5 Instruction Set Table 4 (Dual/Quad SPI Instructions, 4-Byte Address Mode)
</code></pre> 
<p>可以见到，除了<strong>Table3</strong> 不是QSPI的指令，其他3个图表指令皆可以当QSPI下使用，但因为地址模式已经设置为 <strong>4-Byte Address Mode</strong>，所以我们要用的就应该是 <strong>Table 4</strong>的指令表格。</p> 
<p><img src="https://images2.imgbox.com/9c/c6/tDIOaBQE_o.png" alt="8.1.5 Instruction Set Table 4 (Dual/Quad SPI Instructions, 4-Byte Address Mode)"><br> 这里我曾出现一个误区，认为如果使用QSPI指令的话，那么<strong>Table 3</strong> 的 4地址_SPI指令就不能再使用。其实这样的思维是错误的！在没有使用正点原子中的<strong>0x38-QSPImode</strong>指令时，QSPI和SPI指令都是可以照常使用的，也就是在进行一些简单的读写寄存器，可以继续使用SPI指令，如<strong>TABLE 3</strong>中的<strong>05h-读寄存器</strong>、<strong>01h-写寄存器</strong>！</p> 
<p><img src="https://images2.imgbox.com/ef/83/59cLxzrj_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_113"></a>纠错</h5> 
<p><strong>正点原子中，完全没有使用Table 4的 Dual/Quad SPI Instructions, 4-Byte Address Mode 指令，所以此处第二次建议不要参考正点原子代码中的指令，容易误入思维误区！</strong></p> 
<hr> 
<h3><a id="_117"></a>驱动函数编程</h3> 
<p>以<strong>读flash</strong>和<strong>写flash</strong>作为举例。</p> 
<h4><a id="Flash0x6C_119"></a>读Flash:0x6C</h4> 
<p>因为读Flash包含大量的数据，建议使用QSPI指令，也就是<strong>Table 4</strong>的指令</p> 
<p><img src="https://images2.imgbox.com/96/d9/eTCEe8Yj_o.png" alt="在这里插入图片描述"></p> 
<ul><li>快速读QSPI-4字节地址-6Ch<br> <img src="https://images2.imgbox.com/3a/18/SOCP5uwt_o.png" alt="在这里插入图片描述"><br> 根据上面的时序图分析：<br> 指令模式：单线 8位（1字节）<br> 地址模式：单线 32位（4字节）<br> 交替： 0<br> 空周期：单线 8位（1字节）<br> 数据：4线 （QSPI)</li></ul> 
<p>读FLASH驱动如下：</p> 
<pre><code class="prism language-javascript"><span class="token comment">/**
 * @brief  快速读数据 (4线4地址指令）
 * @param 	pBuffer：输入读缓冲buf；Address：读开始flash地址；NumByte ：读的字节量
 * @retval 空闲回复QSPI_OK,忙回复QSPI_BUSY
 */</span>
 <span class="token keyword">void</span> <span class="token function">W25Q_FastReadData</span><span class="token punctuation">(</span>uint8_t <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span>uint32_t Address<span class="token punctuation">,</span>uint16_t NumByte<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

   QSPI_CommandTypeDef s_cmd<span class="token punctuation">;</span>
   <span class="token function">W25Q_BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//等待空闲</span>
   s_cmd<span class="token punctuation">.</span>Instruction       <span class="token operator">=</span> <span class="token number">0x6C</span><span class="token punctuation">;</span>   		    <span class="token comment">//指令     :6C</span>
   s_cmd<span class="token punctuation">.</span>InstructionMode   <span class="token operator">=</span> <span class="token constant">QSPI_INSTRUCTION_1_LINE</span><span class="token punctuation">;</span>        <span class="token comment">//指令模式 :1线</span>
   
   s_cmd<span class="token punctuation">.</span>Address					  <span class="token operator">=</span> Address<span class="token punctuation">;</span>									    
   s_cmd<span class="token punctuation">.</span>AddressMode       <span class="token operator">=</span> <span class="token constant">QSPI_ADDRESS_1_LINE</span><span class="token punctuation">;</span>             <span class="token comment">//地址模式 :1线</span>
   s_cmd<span class="token punctuation">.</span>AddressSize		  	<span class="token operator">=</span> <span class="token constant">QSPI_ADDRESS_32_BITS</span><span class="token punctuation">;</span>		 <span class="token comment">//地址大小 ：32bit</span>
   
   s_cmd<span class="token punctuation">.</span>DataMode          <span class="token operator">=</span> <span class="token constant">QSPI_DATA_4_LINES</span><span class="token punctuation">;</span>               <span class="token comment">//数据模式 :4线</span>
   s_cmd<span class="token punctuation">.</span>NbData						<span class="token operator">=</span> NumByte<span class="token punctuation">;</span>												 <span class="token comment">//数据长度	:NumByte			</span>
   
   s_cmd<span class="token punctuation">.</span>AlternateByteMode <span class="token operator">=</span> <span class="token constant">QSPI_ALTERNATE_BYTES_NONE</span><span class="token punctuation">;</span>			  <span class="token comment">//交替字节 :无</span>
   s_cmd<span class="token punctuation">.</span>DummyCycles       <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>								<span class="token comment">//空周期		:8位 （重点）</span>
   s_cmd<span class="token punctuation">.</span>DdrMode           <span class="token operator">=</span> <span class="token constant">QSPI_DDR_MODE_DISABLE</span><span class="token punctuation">;</span>					  <span class="token comment">//DDR			:禁止</span>
   s_cmd<span class="token punctuation">.</span>DdrHoldHalfCycle  <span class="token operator">=</span> <span class="token constant">QSPI_DDR_HHC_ANALOG_DELAY</span><span class="token punctuation">;</span>			  <span class="token comment">//DDR延迟 :模拟延迟</span>
   s_cmd<span class="token punctuation">.</span>SIOOMode          <span class="token operator">=</span> <span class="token constant">QSPI_SIOO_INST_EVERY_CMD</span><span class="token punctuation">;</span>			    <span class="token comment">//SIO0模式:不起作用</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_QSPI_Command</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>QSPI_Handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s_cmd<span class="token punctuation">,</span> <span class="token constant">QPSI_TIMEOUT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">HAL_OK</span><span class="token punctuation">)</span>
   	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"W25Q_FastReadData Time out \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   	
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_QSPI_Receive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>QSPI_Handler<span class="token punctuation">,</span>pBuffer<span class="token punctuation">,</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">HAL_OK</span><span class="token punctuation">)</span>
   	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"W25Q_FastReadData receive fault \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
   <span class="token function">W25Q_BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//等待空闲</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_170"></a>纠错</h5> 
<p><strong>W25Q datasheet 的图表和时序图空周期长度不符。<br> 野火并未使用QSPI指令读数据。</strong></p> 
<ul><li> <p>手册上 指令<strong>6Ch</strong> 的时序图的空周期是8位的，而<strong>Table 4</strong>上标的是2个字节（16位）的空周期，因为当时测试没仔细对比两个图的异样，填的是16位，导致<strong>读Flash</strong>测试时前4字的数据丢失，无法被读取。<em>遇到同样故障的小伙伴可以留意下空周期数和地址长度是否不符问题</em>。</p> </li><li> <p><strong>野火</strong>的例程虽然在<strong>写FLASH</strong>操作上使用<strong>Table 4</strong>指令，但<strong>读FLASH</strong>仍然用的SPI <strong>03h</strong>指令，所以建议也不要参考<strong>野火</strong>例程的指令，自行编写更好。</p> </li></ul> 
<p>以下是野火例程（不要参考）：</p> 
<pre><code class="prism language-javascript"><span class="token comment">/* 读操作 */</span>
#define <span class="token constant">READ_CMD</span>                             <span class="token number">0x03</span>           <span class="token comment">//野火例程中，读操作只使用了0X03</span>
#define <span class="token constant">FAST_READ_CMD</span>                        <span class="token number">0x0B</span>
#define <span class="token constant">DUAL_OUT_FAST_READ_CMD</span>               <span class="token number">0x3B</span>
#define <span class="token constant">DUAL_INOUT_FAST_READ_CMD</span>             <span class="token number">0xBB</span>
#define <span class="token constant">QUAD_OUT_FAST_READ_CMD</span>               <span class="token number">0x6B</span>
#define <span class="token constant">QUAD_INOUT_FAST_READ_CMD</span>             <span class="token number">0xEB</span>
<span class="token comment">/**
 * @brief  从QSPI存储器中读取大量数据.
 * @param  pData: 指向要读取的数据的指针
 * @param  ReadAddr: 读取起始地址
 * @param  Size: 要读取的数据大小    
 * @retval QSPI存储器状态
 */</span>
 uint8_t <span class="token function">BSP_QSPI_Read</span><span class="token punctuation">(</span>uint8_t<span class="token operator">*</span> pData<span class="token punctuation">,</span> uint32_t ReadAddr<span class="token punctuation">,</span> uint32_t Size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">/*其他省略*/</span>
s_command<span class="token punctuation">.</span>Instruction       <span class="token operator">=</span> <span class="token constant">READ_CMD</span><span class="token punctuation">;</span>  <span class="token comment">//0x03</span>
<span class="token punctuation">}</span>

</code></pre> 
<hr> 
<h4><a id="0x21_204"></a>扇区擦除:0x21</h4> 
<ul><li>因为擦除没有数据交互，可以使用TABLE 3的 SPI指令<br> <img src="https://images2.imgbox.com/01/1c/UG2jYdhL_o.png" alt="在这里插入图片描述"><br> 根据上面的时序图分析：<br> 指令模式：单线 8位（1字节）<br> 地址模式：单线 32位（4字节）<br> 交替： 0<br> 空周期：0<br> 数据：0</li></ul> 
<pre><code class="prism language-javascript"><span class="token comment">/**
  * @brief  扇区擦除
  * @param 	Page：扇区页码
  * @retval 
  */</span>
  <span class="token keyword">void</span> <span class="token function">W25Q_Erase_Sector</span><span class="token punctuation">(</span>uint16_t Page<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	QSPI_CommandTypeDef s_cmd<span class="token punctuation">;</span>
	uint32_t Addr<span class="token punctuation">;</span>
	Addr <span class="token operator">=</span> Page <span class="token operator">*</span> <span class="token constant">W25Q_SECTORSBYTE</span><span class="token punctuation">;</span>
	
	<span class="token function">W25Q_Write_Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//写使能</span>
	<span class="token function">W25Q_BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//等待空闲</span>
	
	s_cmd<span class="token punctuation">.</span>InstructionMode   <span class="token operator">=</span> <span class="token constant">QSPI_INSTRUCTION_1_LINE</span><span class="token punctuation">;</span>        <span class="token comment">//指令模式 :1线</span>
	s_cmd<span class="token punctuation">.</span>Instruction       <span class="token operator">=</span> <span class="token number">0x21</span><span class="token punctuation">;</span>                           <span class="token comment">//指令 ：SPI    </span>
	s_cmd<span class="token punctuation">.</span>Address					  <span class="token operator">=</span> Addr<span class="token punctuation">;</span>						   <span class="token comment">//地址			</span>
	s_cmd<span class="token punctuation">.</span>AddressSize			  <span class="token operator">=</span> <span class="token constant">QSPI_ADDRESS_32_BITS</span><span class="token punctuation">;</span>           <span class="token comment">//地址长度：4字节</span>
	s_cmd<span class="token punctuation">.</span>AddressMode       <span class="token operator">=</span> <span class="token constant">QSPI_ADDRESS_1_LINE</span><span class="token punctuation">;</span>            <span class="token comment">//地址模式 :1线</span>
	s_cmd<span class="token punctuation">.</span>DataMode          <span class="token operator">=</span> <span class="token constant">QSPI_DATA_NONE</span><span class="token punctuation">;</span>                  <span class="token comment">//指令模式 :0</span>
	s_cmd<span class="token punctuation">.</span>NbData						<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>															 <span class="token comment">//数据长度	:0			</span>
	s_cmd<span class="token punctuation">.</span>DummyCycles       <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>										<span class="token comment">//空周期		:0</span>
	s_cmd<span class="token punctuation">.</span>AlternateByteMode <span class="token operator">=</span> <span class="token constant">QSPI_ALTERNATE_BYTES_NONE</span><span class="token punctuation">;</span>			 <span class="token comment">//交替字节 :无</span>
	s_cmd<span class="token punctuation">.</span>DdrMode           <span class="token operator">=</span> <span class="token constant">QSPI_DDR_MODE_DISABLE</span><span class="token punctuation">;</span>					 <span class="token comment">//DDR			:禁止</span>
	s_cmd<span class="token punctuation">.</span>DdrHoldHalfCycle  <span class="token operator">=</span> <span class="token constant">QSPI_DDR_HHC_ANALOG_DELAY</span><span class="token punctuation">;</span>			 <span class="token comment">//DDR延迟 :模拟延迟</span>
	s_cmd<span class="token punctuation">.</span>SIOOMode          <span class="token operator">=</span> <span class="token constant">QSPI_SIOO_INST_EVERY_CMD</span><span class="token punctuation">;</span>			   <span class="token comment">//SIO0模式:不起作用</span>
		
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_QSPI_Command</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>QSPI_Handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s_cmd<span class="token punctuation">,</span> <span class="token constant">QPSI_TIMEOUT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">HAL_OK</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"W25Q_Erase_Sector Time out \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">W25Q_BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//等待空闲</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h4><a id="FLASH2560x34_249"></a>写FLASH(最大256字节）:0x34</h4> 
<ul><li>因为写Flash包含大量的数据，建议使用QSPI指令，也就是Table 4的指令<br> <img src="https://images2.imgbox.com/70/11/vcJluH2h_o.png" alt="在这里插入图片描述"><br> 根据上面的时序图分析：<br> 指令模式：单线 8位（1字节）<br> 地址模式：单线 32位（4字节）<br> 交替： 0<br> 空周期：0<br> 数据：4线 （QSPI)</li></ul> 
<pre><code class="prism language-javascript"> <span class="token comment">/**
  * @brief  FLASH页编程。每次最大可写256BYTE
  * @param 	Page：扇区页码
  * @retval 
  */</span>
<span class="token keyword">void</span> <span class="token function">W25Q_Program_Page</span><span class="token punctuation">(</span>uint8_t <span class="token operator">*</span>pBuff<span class="token punctuation">,</span>uint32_t Addr<span class="token punctuation">,</span>uint16_t NumByte<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	QSPI_CommandTypeDef s_cmd<span class="token punctuation">;</span>
	
	<span class="token function">W25Q_Write_Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//写使能</span>
	<span class="token function">W25Q_BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//等待空闲</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"start program\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	s_cmd<span class="token punctuation">.</span>InstructionMode   <span class="token operator">=</span> <span class="token constant">QSPI_INSTRUCTION_1_LINE</span><span class="token punctuation">;</span>       <span class="token comment">//指令模式 :1线</span>
	s_cmd<span class="token punctuation">.</span>Instruction       <span class="token operator">=</span> <span class="token number">0x34</span><span class="token punctuation">;</span>                          <span class="token comment">//指令     :QSPI</span>
	
  s_cmd<span class="token punctuation">.</span>AddressMode       <span class="token operator">=</span> <span class="token constant">QSPI_ADDRESS_1_LINE</span><span class="token punctuation">;</span>           <span class="token comment">//地址模式 :1线</span>
	s_cmd<span class="token punctuation">.</span>AddressSize			  <span class="token operator">=</span> <span class="token constant">QSPI_ADDRESS_32_BITS</span><span class="token punctuation">;</span>           <span class="token comment">//地址长度:4字</span>
	s_cmd<span class="token punctuation">.</span>Address					  <span class="token operator">=</span> Addr<span class="token punctuation">;</span>					<span class="token comment">//地址			Addr</span>
	
	s_cmd<span class="token punctuation">.</span>DataMode          <span class="token operator">=</span> <span class="token constant">QSPI_DATA_4_LINES</span><span class="token punctuation">;</span>               <span class="token comment">//指令模式 :0</span>
	CmdHandler<span class="token punctuation">.</span>NbData			  <span class="token operator">=</span> NumByte<span class="token punctuation">;</span>				   <span class="token comment">//数据长度	:						</span>
	s_cmd<span class="token punctuation">.</span>DummyCycles       <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>							 <span class="token comment">//空周期		:0</span>
	
	s_cmd<span class="token punctuation">.</span>AlternateByteMode <span class="token operator">=</span> <span class="token constant">QSPI_ALTERNATE_BYTES_NONE</span><span class="token punctuation">;</span>			 <span class="token comment">//交替字节 :无</span>
	s_cmd<span class="token punctuation">.</span>DdrMode           <span class="token operator">=</span> <span class="token constant">QSPI_DDR_MODE_DISABLE</span><span class="token punctuation">;</span>					 <span class="token comment">//DDR			:禁止</span>
	s_cmd<span class="token punctuation">.</span>DdrHoldHalfCycle  <span class="token operator">=</span> <span class="token constant">QSPI_DDR_HHC_ANALOG_DELAY</span><span class="token punctuation">;</span>			 <span class="token comment">//DDR延迟 :模拟延迟</span>
	s_cmd<span class="token punctuation">.</span>SIOOMode          <span class="token operator">=</span> <span class="token constant">QSPI_SIOO_INST_EVERY_CMD</span><span class="token punctuation">;</span>			   <span class="token comment">//SIO0模式:不起作用</span>
		
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_QSPI_Command</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>QSPI_Handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s_cmd<span class="token punctuation">,</span> <span class="token constant">QPSI_TIMEOUT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">HAL_OK</span><span class="token punctuation">)</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"W25Q_Program_Page Time out \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">HAL_QSPI_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>QSPI_Handler<span class="token punctuation">,</span>pBuff<span class="token punctuation">,</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">W25Q_BusyWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//等待空闲</span>
	
<span class="token punctuation">}</span>  

</code></pre> 
<h2><a id="_298"></a>总结：</h2> 
<p>1.正点原子和野火的例程都存在不严谨的问题，虽然结果能实现，但不适合初学者去区分QSPI和SPI的运用。<br> 2.W25Q数据手册图表也存在空周期数不符问题，大家在使用数据手册过程中，一定要确保数据手册与IC对上，如测试过程中出现问题，第一时间翻查时序图确保各项参数正常。</p> 
<h2><a id="FLASH_304"></a>补充说明（等待FLASH空闲）</h2> 
<p><strong>野火</strong>例程中有状态轮询操作，而正点原子是使用读SR1的0位（busy）来等待完成，两者都可以完成等待<strong>Flash空闲</strong>，但测试时，轮询功能因失败导致QSPI进入错误故障中，无法继续正常读写，对后续程序影响较大，推荐直接使用读busy位作为判断。</p> 
<ul><li>推荐循环读SR1</li></ul> 
<pre><code class="prism language-javascript"><span class="token comment">/*推荐使用*/</span>
#define 			<span class="token constant">W25Q_FSR_WRIEN</span>  							<span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>					<span class="token comment">/*!&lt; write enable */</span>
#define 			<span class="token constant">W25Q_FSR_BUSY</span>              				   <span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   		  <span class="token comment">/*!&lt; busy */</span>
#define			  <span class="token constant">W25Q_FSR2_QE</span>									<span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>				  <span class="token comment">/*!&lt; quad enable */</span>
#define				<span class="token constant">W25Q_FSR3_ADS</span>							    <span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>					<span class="token comment">/*!&lt; 4address enable */</span>
 <span class="token comment">/**
  * @brief  FLASH 空闲状态检测（循环等待空闲）
  * @param 	无
  * @retval 
  */</span>
<span class="token keyword">void</span> <span class="token function">W25Q_BusyWait</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
	<span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token function">W25Q_ReadSR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">W25Q_FSR_BUSY</span><span class="token punctuation">)</span> <span class="token operator">==</span>  <span class="token constant">W25Q_FSR_BUSY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SR 1 : %d\r\n"</span><span class="token punctuation">,</span><span class="token function">W25Q_ReadSR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<ul><li>HAL_QSPI_AutoPolling，需要重新配置CmdHandler和PollingHandler，如掩码错误会引起不必要的故障，故不推荐轮询模式。</li></ul> 
<pre><code class="prism language-javascript"><span class="token comment">/**
  * @brief  QSPI_AutoPollingReady 读取存储器的SR并等待EOP
  * @param  None
  * @retval 失败回复QSPI_ERROR ，成功回复QSPI_OK
  */</span>
uint8_t <span class="token function">QSPI_AutoPollingReady</span><span class="token punctuation">(</span>uint32_t timeout<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* 配置自动轮询模式等待存储器准备就绪 */</span>  
	CmdHandler<span class="token punctuation">.</span>InstructionMode   <span class="token operator">=</span> <span class="token constant">QSPI_INSTRUCTION_1_LINE</span><span class="token punctuation">;</span>        <span class="token comment">//指令模式 :单线</span>
	CmdHandler<span class="token punctuation">.</span>Instruction       <span class="token operator">=</span> W25X_ReadStatusReg1<span class="token punctuation">;</span>					   <span class="token comment">//指令		  :读状态寄存器</span>
	CmdHandler<span class="token punctuation">.</span>AddressMode       <span class="token operator">=</span> <span class="token constant">QSPI_ADDRESS_NONE</span><span class="token punctuation">;</span>						   <span class="token comment">//地址模式	:无</span>
	CmdHandler<span class="token punctuation">.</span>Address					 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>															 <span class="token comment">//地址			:无</span>
	CmdHandler<span class="token punctuation">.</span>AlternateByteMode <span class="token operator">=</span> <span class="token constant">QSPI_ALTERNATE_BYTES_NONE</span><span class="token punctuation">;</span>			 <span class="token comment">//交替字节 :无</span>
	CmdHandler<span class="token punctuation">.</span>DataMode          <span class="token operator">=</span> <span class="token constant">QSPI_DATA_1_LINE</span><span class="token punctuation">;</span>							 <span class="token comment">//数据模式	:单线</span>
	CmdHandler<span class="token punctuation">.</span>NbData						 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>															 <span class="token comment">//数据长度	:1BYTE							</span>
	CmdHandler<span class="token punctuation">.</span>DummyCycles       <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>															 <span class="token comment">//空周期		:0</span>
	CmdHandler<span class="token punctuation">.</span>DdrMode           <span class="token operator">=</span> <span class="token constant">QSPI_DDR_MODE_DISABLE</span><span class="token punctuation">;</span>					 <span class="token comment">//DDR			:禁止</span>
	CmdHandler<span class="token punctuation">.</span>DdrHoldHalfCycle  <span class="token operator">=</span> <span class="token constant">QSPI_DDR_HHC_ANALOG_DELAY</span><span class="token punctuation">;</span>			 <span class="token comment">//DDR延迟 :模拟延迟</span>
	CmdHandler<span class="token punctuation">.</span>SIOOMode          <span class="token operator">=</span> <span class="token constant">QSPI_SIOO_INST_EVERY_CMD</span><span class="token punctuation">;</span>			 <span class="token comment">//SIO0模式:不起作用</span>
	
	PollingHandler<span class="token punctuation">.</span>Match           <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>												
	PollingHandler<span class="token punctuation">.</span>Mask            <span class="token operator">=</span> <span class="token constant">W25Q_FSR_BUSY</span><span class="token punctuation">;</span>								 <span class="token comment">//掩码:		((uint8_t)(1 &lt;&lt; 0)) </span>
	PollingHandler<span class="token punctuation">.</span>MatchMode       <span class="token operator">=</span> <span class="token constant">QSPI_MATCH_MODE_AND</span><span class="token punctuation">;</span>
	PollingHandler<span class="token punctuation">.</span>StatusBytesSize <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	PollingHandler<span class="token punctuation">.</span>Interval        <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
	PollingHandler<span class="token punctuation">.</span>AutomaticStop   <span class="token operator">=</span> <span class="token constant">QSPI_AUTOMATIC_STOP_ENABLE</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_QSPI_AutoPolling</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>QSPI_Handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CmdHandler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>PollingHandler<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">HAL_OK</span><span class="token punctuation">)</span>  <span class="token comment">//自动轮询</span>
		<span class="token keyword">return</span> <span class="token constant">QSPI_ERROR</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token constant">QSPI_OK</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre> 
<p><strong>此记录用于本人留底翻查，并提供给其他与我一样的新用户参考，如有其他意见，可以留言或发邮箱到 xiaojianjiande@163.com 纠错。</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bf0a66cc2b4a7020fd4d76e1f9584875/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">axios请求添加token的方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d7ede634445fc7944933dc7cdb16bf63/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Acrobat DC 更改背景颜色会有一条条白色横纹</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>