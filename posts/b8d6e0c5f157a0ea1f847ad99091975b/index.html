<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Cesium 之加载倾斜摄影3d模型（解决倾斜漂移问题） - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Cesium 之加载倾斜摄影3d模型（解决倾斜漂移问题）" />
<meta property="og:description" content="以Cesium3DTileset方式加载服务发布的倾斜摄影静态资源Json文件，参考如下：
item.url=&#39;倾斜摄影的json地址/tileset.json&#39;; let tileset = window.viewer.scene.primitives.add(new Cesium.Cesium3DTileset({ url: item.url, // modelMatrix: Cesium.Matrix4.fromArray([1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1]), baseScreenSpaceError: 1024, //【重要】数值加大，能让最终成像变模糊 skipScreenSpaceErrorFactor: 16, skipLevels: 1, immediatelyLoadDesiredLevelOfDetail: false, loadSiblings: false, cullWithChildrenBounds: true, skipLevelOfDetail: true, //开启跳级加载 //这个参数默认是false，同等条件下，叶子节点会优先加载。但是Cesium的tile加载优先级有很多考虑条件， //这个只是其中之一，如果skipLevelOfDetail=false，这个参数几乎无意义。所以要配合skipLevelOfDetail=true来使用， //此时设置preferLeaves=true。这样我们就能最快的看见符合当前视觉精度的块，对于提升大数据以及网络环境不好的前提下有一点点改善意义。 preferLeaves: true, //【重要】内存建议显存大小的50%左右，内存分配变小有利于倾斜摄影数据回收，提升性能体验 maximumMemoryUsage: 1024 //控制切片视角显示的数量，可调整性能 // maximumScreenSpaceError: 2,//最大的屏幕空间误差 // maximumNumberOfLoadedTiles: 100000, //最大加载瓦片个数 })); 加载完后，打开浏览器往往会发现不尽人意，并且有可能与真实位置不匹配，与影像底图不贴合或者偏移了很远，这是可能是因为坐标系问题导致倾斜的中心点定位有问题，需要调整中心点位置。
下面以代码方式动态调整倾斜中心点坐标。
item.longitudeOffset=.. item.latitudeOffset=.. item.heightOffset=.. tileset.readyPromise.then(function (palaceTileset) { var longitude = item." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/b8d6e0c5f157a0ea1f847ad99091975b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-19T17:20:04+08:00" />
<meta property="article:modified_time" content="2022-03-19T17:20:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Cesium 之加载倾斜摄影3d模型（解决倾斜漂移问题）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>        以Cesium3DTileset方式加载服务发布的倾斜摄影静态资源Json文件，参考如下：</p> 
<pre><code class="language-javascript">item.url='倾斜摄影的json地址/tileset.json';
let tileset = window.viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
     url: item.url,
     // modelMatrix: Cesium.Matrix4.fromArray([1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1]),
     baseScreenSpaceError: 1024,
     //【重要】数值加大，能让最终成像变模糊
     skipScreenSpaceErrorFactor: 16,
     skipLevels: 1,
     immediatelyLoadDesiredLevelOfDetail: false,
     loadSiblings: false,
     cullWithChildrenBounds: true,
     skipLevelOfDetail: true, //开启跳级加载
     //这个参数默认是false，同等条件下，叶子节点会优先加载。但是Cesium的tile加载优先级有很多考虑条件，
     //这个只是其中之一，如果skipLevelOfDetail=false，这个参数几乎无意义。所以要配合skipLevelOfDetail=true来使用，
     //此时设置preferLeaves=true。这样我们就能最快的看见符合当前视觉精度的块，对于提升大数据以及网络环境不好的前提下有一点点改善意义。
      preferLeaves: true,
      //【重要】内存建议显存大小的50%左右，内存分配变小有利于倾斜摄影数据回收，提升性能体验
      maximumMemoryUsage: 1024
      //控制切片视角显示的数量，可调整性能
      // maximumScreenSpaceError: 2,//最大的屏幕空间误差
      // maximumNumberOfLoadedTiles: 100000, //最大加载瓦片个数
}));</code></pre> 
<p>        加载完后，打开浏览器往往会发现不尽人意，并且有可能与真实位置不匹配，与影像底图不贴合或者偏移了很远，这是可能是因为坐标系问题导致倾斜的中心点定位有问题，需要调整中心点位置。</p> 
<p>        下面以代码方式动态调整倾斜中心点坐标。</p> 
<pre><code class="language-javascript">    item.longitudeOffset=..
    item.latitudeOffset=..
    item.heightOffset=..
tileset.readyPromise.then(function (palaceTileset) {
     var longitude = item.longitudeOffset //模型需要改变的经度
     var latitude = item.latitudeOffset //模型需要改变的纬度
     //获取3Dtlies的bounds范围
     var boundingSphere = palaceTileset.boundingSphere;
     //获取3Dtlies的范围中心点的弧度
     var cartographic = Cesium.Cartographic.fromCartesian(boundingSphere.center);
     //定义3Dtlies改变之后中心点的弧度
      var offsetvalue = Cesium.Cartographic.fromDegrees(longitude, latitude, item.heightOffset)
     // debugger
     //模型本身的位置
     var surface = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, cartographic.height);
     //模型改变的位置
     var offset = Cesium.Cartesian3.fromRadians(offsetvalue.longitude, offsetvalue.latitude, item.heightOffset);
     //定义模型的改变状态
     var translation = Cesium.Cartesian3.subtract(offset, surface, new Cesium.Cartesian3());
     //修改模型的位置
     palaceTileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation);

     var headingAngle = item.headingAngle;
     var pitchAngle = item.pitchAngle;
     var rollAngle = item.rollAngle;
     var lon = item.lon;
     var lat = item.lat;
     var height = item.height;
     if (headingAngle &amp;&amp; pitchAngle &amp;&amp; rollAngle &amp;&amp; lon &amp;&amp; lat &amp;&amp; height) {
     window.viewer.scene.camera.setView({
     // 初始化相机经纬度
     destination: Cesium.Cartesian3.fromDegrees(lon, lat, height),
     orientation: {
     heading: Cesium.Math.toRadians(headingAngle),
     pitch: Cesium.Math.toRadians(pitchAngle), //从上往下看为-90
     roll: Cesium.Math.toRadians(rollAngle)
     }
   });

   } else {
       window.viewer.flyTo(tileset)
   }
})</code></pre> 
<p>通过以上设置如果发现</p> 
<p>（1）首次加载时已经和影像底图贴合，但是移动视角后，仍然会出现倾斜漂移问题，如下图所示</p> 
<p><img alt="" height="437" src="https://images2.imgbox.com/cf/7b/qsBgAx0b_o.png" width="740"></p> 
<p> </p> 
<p><img alt="" height="560" src="https://images2.imgbox.com/84/b0/drUXb6SR_o.png" width="891"></p> 
<p> 说明倾斜的高度比实际地形更高，需要适当降低高度，直至调到合适高度为止。</p> 
<p>（2）如果无论怎么设置，要么出现漂移，要么倾斜跑地下被挡住，这有可能是地形的精度不够或与倾斜精度相差太大所导致。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/837a92c0b95f1cdae996e33466d59fb3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">利用tensorboard来展示图片的逐步展示</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ee64ed3a9fb018b83da0eaee4a792b6a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue3中自定义ref</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>