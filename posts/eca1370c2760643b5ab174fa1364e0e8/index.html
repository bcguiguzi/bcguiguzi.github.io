<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android筑基——BroadcastReceiver 的动态注册、发送和接收过程（基于api21） - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android筑基——BroadcastReceiver 的动态注册、发送和接收过程（基于api21）" />
<meta property="og:description" content="目录 1. 前言2. 正文2.1 广播接收者的动态注册2.1.1 ContextWrapper.registerReceiver() 方法2.1.2 ContextImpl.registerReceiver() 方法2.1.3 ContextImpl.registerReceiverInternal() 方法2.1.3.1 LoadedApk.getReceiverDispatcher() 方法2.1.3.2 new LoadedApk.ReceiverDispatcher() 方法2.1.3.3 ActivityManagerNative.getDefault() 方法 2.1.4 ActivityManagerProxy.registerReceiver() 方法2.1.5 ActivityManagerNative.onTransact() 方法2.1.6 ActivityManagerService.registerReceiver() 方法2.1.6.1 IntentResolver.addFilter()方法 2.2 发送普通广播2.2.1 ContextWrapper.sendBroadcast() 方法2.2.2 ContextImpl.sendBroadcast() 方法2.2.3 ActivityManagerProxy.broadcastIntent() 方法2.2.4 ActivityManagerNative.onTransact() 方法2.2.5 ActivityManagerService.broadcastIntent() 方法2.2.6 ActivityManagerService.broadcastIntentLocked() 方法2.2.6.1 ActivityManagerService.collectReceiverComponents() 方法2.2.6.2 IntentResolver.queryIntent() 方法2.2.6.3 IntentResolver.buildResolveList() 方法2.2.6.4 new BroadcastRecord() 方法2.2.6.5 BroadcastQueue.enqueueParallelBroadcastLocked() 方法 2.3 接收普通广播2.3.1 BroadcastQueue.scheduleBroadcastsLocked() 方法2.3.2 BroadcastHandler.handleMessage() 方法2.3.3 BroadcastQueue.processNextBroadcast() 方法2.3.4 BroadcastQueue.deliverToRegisteredReceiverLocked() 方法2.3.5 BroadcastQueue.performReceiveLocked() 方法2.3.6 ApplicationThreadProxy.scheduleRegisteredReceiver() 方法2.3.7 ApplicationThreadNative.onTransact() 方法2.3.8 ApplicationThread.scheduleRegisteredReceiver() 方法2.3.9 InnerReceiver." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/eca1370c2760643b5ab174fa1364e0e8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-24T09:52:48+08:00" />
<meta property="article:modified_time" content="2021-12-24T09:52:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android筑基——BroadcastReceiver 的动态注册、发送和接收过程（基于api21）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#1__2" rel="nofollow">1. 前言</a></li><li><a href="#2__11" rel="nofollow">2. 正文</a></li><li><ul><li><a href="#21__76" rel="nofollow">2.1 广播接收者的动态注册</a></li><li><ul><li><a href="#211_ContextWrapperregisterReceiver__78" rel="nofollow">2.1.1 ContextWrapper.registerReceiver() 方法</a></li><li><a href="#212_ContextImplregisterReceiver__95" rel="nofollow">2.1.2 ContextImpl.registerReceiver() 方法</a></li><li><a href="#213_ContextImplregisterReceiverInternal__165" rel="nofollow">2.1.3 ContextImpl.registerReceiverInternal() 方法</a></li><li><ul><li><a href="#2131_LoadedApkgetReceiverDispatcher__222" rel="nofollow">2.1.3.1 LoadedApk.getReceiverDispatcher() 方法</a></li><li><a href="#2132_new_LoadedApkReceiverDispatcher__274" rel="nofollow">2.1.3.2 new LoadedApk.ReceiverDispatcher() 方法</a></li><li><a href="#2133_ActivityManagerNativegetDefault__390" rel="nofollow">2.1.3.3 ActivityManagerNative.getDefault() 方法</a></li></ul> 
    </li><li><a href="#214_ActivityManagerProxyregisterReceiver__439" rel="nofollow">2.1.4 ActivityManagerProxy.registerReceiver() 方法</a></li><li><a href="#215_ActivityManagerNativeonTransact__482" rel="nofollow">2.1.5 ActivityManagerNative.onTransact() 方法</a></li><li><a href="#216_ActivityManagerServiceregisterReceiver__524" rel="nofollow">2.1.6 ActivityManagerService.registerReceiver() 方法</a></li><li><ul><li><a href="#2161_IntentResolveraddFilter_628" rel="nofollow">2.1.6.1 IntentResolver.addFilter()方法</a></li></ul> 
   </li></ul> 
   </li><li><a href="#22__652" rel="nofollow">2.2 发送普通广播</a></li><li><ul><li><a href="#221_ContextWrappersendBroadcast__654" rel="nofollow">2.2.1 ContextWrapper.sendBroadcast() 方法</a></li><li><a href="#222_ContextImplsendBroadcast__667" rel="nofollow">2.2.2 ContextImpl.sendBroadcast() 方法</a></li><li><a href="#223_ActivityManagerProxybroadcastIntent__689" rel="nofollow">2.2.3 ActivityManagerProxy.broadcastIntent() 方法</a></li><li><a href="#224_ActivityManagerNativeonTransact__743" rel="nofollow">2.2.4 ActivityManagerNative.onTransact() 方法</a></li><li><a href="#225_ActivityManagerServicebroadcastIntent__786" rel="nofollow">2.2.5 ActivityManagerService.broadcastIntent() 方法</a></li><li><a href="#226_ActivityManagerServicebroadcastIntentLocked__824" rel="nofollow">2.2.6 ActivityManagerService.broadcastIntentLocked() 方法</a></li><li><ul><li><a href="#2261_ActivityManagerServicecollectReceiverComponents__995" rel="nofollow">2.2.6.1 ActivityManagerService.collectReceiverComponents() 方法</a></li><li><a href="#2262_IntentResolverqueryIntent__1036" rel="nofollow">2.2.6.2 IntentResolver.queryIntent() 方法</a></li><li><a href="#2263_IntentResolverbuildResolveList__1088" rel="nofollow">2.2.6.3 IntentResolver.buildResolveList() 方法</a></li><li><a href="#2264_new_BroadcastRecord__1147" rel="nofollow">2.2.6.4 new BroadcastRecord() 方法</a></li><li><a href="#2265_BroadcastQueueenqueueParallelBroadcastLocked__1224" rel="nofollow">2.2.6.5 BroadcastQueue.enqueueParallelBroadcastLocked() 方法</a></li></ul> 
   </li></ul> 
   </li><li><a href="#23__1237" rel="nofollow">2.3 接收普通广播</a></li><li><ul><li><a href="#231_BroadcastQueuescheduleBroadcastsLocked__1239" rel="nofollow">2.3.1 BroadcastQueue.scheduleBroadcastsLocked() 方法</a></li><li><a href="#232_BroadcastHandlerhandleMessage__1291" rel="nofollow">2.3.2 BroadcastHandler.handleMessage() 方法</a></li><li><a href="#233_BroadcastQueueprocessNextBroadcast__1315" rel="nofollow">2.3.3 BroadcastQueue.processNextBroadcast() 方法</a></li><li><a href="#234_BroadcastQueuedeliverToRegisteredReceiverLocked__1365" rel="nofollow">2.3.4 BroadcastQueue.deliverToRegisteredReceiverLocked() 方法</a></li><li><a href="#235_BroadcastQueueperformReceiveLocked__1412" rel="nofollow">2.3.5 BroadcastQueue.performReceiveLocked() 方法</a></li><li><a href="#236_ApplicationThreadProxyscheduleRegisteredReceiver__1447" rel="nofollow">2.3.6 ApplicationThreadProxy.scheduleRegisteredReceiver() 方法</a></li><li><a href="#237_ApplicationThreadNativeonTransact__1476" rel="nofollow">2.3.7 ApplicationThreadNative.onTransact() 方法</a></li><li><a href="#238_ApplicationThreadscheduleRegisteredReceiver__1510" rel="nofollow">2.3.8 ApplicationThread.scheduleRegisteredReceiver() 方法</a></li><li><a href="#239_InnerReceiverperformReceive__1543" rel="nofollow">2.3.9 InnerReceiver.performReceive() 方法</a></li><li><a href="#2310_ReceiverDispatcherperformReceive__1577" rel="nofollow">2.3.10 ReceiverDispatcher.performReceive() 方法</a></li><li><a href="#2311_Argsrun__1606" rel="nofollow">2.3.11 Args.run() 方法</a></li><li><a href="#2312_MyDynamicReceiveronReceive__1658" rel="nofollow">2.3.12 MyDynamicReceiver.onReceive() 方法</a></li></ul> 
  </li></ul> 
  </li><li><a href="#3_1679" rel="nofollow">3.最后</a></li><li><a href="#4__1681" rel="nofollow">4. 参考</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__2"></a>1. 前言</h2> 
<p><code>BroadcastReceiver</code> 的工作过程主要包括两个方面的内容：</p> 
<ol><li>广播接收者的注册过程（静态注册和动态注册）；</li><li>广播的发送（包括发送普通广播、有序广播和粘性广播）和接收过程。</li></ol> 
<p>本文主要分析广播接收者的动态注册，普通广播的发送和接收过程。</p> 
<h2><a id="2__11"></a>2. 正文</h2> 
<p>首先，看一下我们要分析的代码：</p> 
<ol><li> <p>定义广播接收者，继承 <code>BroadcastReceiver</code> 抽象类并重写它的 <code>onReceive()</code> 方法：</p> <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDynamicReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TAG <span class="token operator">=</span> <span class="token string">"MyDynamicReceiver"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ACTION_LAUNCH_DYNAMIC <span class="token operator">=</span> <span class="token string">"com.wzc.receiver.LAUNCH_DYNAMIC"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onReceive: receive action = "</span> <span class="token operator">+</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ACTION_LAUNCH_DYNAMIC<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onReceive: do launch work..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>点击按钮动态注册以及动态注销广播接收者</p> <pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">MyDynamicReceiver</span> receiver<span class="token punctuation">;</span>
<span class="token comment">// 动态注册广播接收者</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerReceiver</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">IntentFilter</span> intentFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intentFilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span>ACTION_LAUNCH_DYNAMIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        receiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyDynamicReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerReceiver</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> intentFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 动态注销广播接收者</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unregisterReceiver</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">unregisterReceiver</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        receiver <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>点击按钮发送广播</p> <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendBroadcast</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    intent<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span>ACTION_LAUNCH_DYNAMIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sendBroadcast</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<p>先点击动态注册广播接收者按钮，再点击发送广播按钮，查看日志如下：</p> 
<pre><code class="prism language-txt">D/MyDynamicReceiver: onReceive: receive action = com.wzc.receiver.LAUNCH_DYNAMIC
D/MyDynamicReceiver: onReceive: do launch work...
</code></pre> 
<p>如果不对广播接收者进行动态注册，直接点击发送广播按钮，是看不到 <code>onReceive</code> 方法里的日志的。</p> 
<p>现在我们开始查看相关的源码吧。</p> 
<h3><a id="21__76"></a>2.1 广播接收者的动态注册</h3> 
<h4><a id="211_ContextWrapperregisterReceiver__78"></a>2.1.1 ContextWrapper.registerReceiver() 方法</h4> 
<ul><li>BroadcastReceiver receiver, MyDynamicReceiver 对象</li><li>IntentFilter filter, 添加了 action 的 IntentFilter 对象</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Intent</span> <span class="token function">registerReceiver</span><span class="token punctuation">(</span>
    <span class="token class-name">BroadcastReceiver</span> receiver<span class="token punctuation">,</span> <span class="token class-name">IntentFilter</span> filter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> mBase<span class="token punctuation">.</span><span class="token function">registerReceiver</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里的 <code>ContextWrapper</code>其实是装饰器设计模式的应用了，类结构图如下所示：<br> <img src="https://images2.imgbox.com/33/6f/JcgfevIM_o.png" alt="在这里插入图片描述"><br> 调用装饰类 <code>ContextWrapper</code> 的 <code>registerReceiver</code> 方法，内部真正调用的是核心实现类 <code>ContextImpl</code> 的 <code>registerReceiver</code> 方法。所以 <code>mBase</code> 实际上是一个 <code>ContextImpl</code> 类型的对象。</p> 
<h4><a id="212_ContextImplregisterReceiver__95"></a>2.1.2 ContextImpl.registerReceiver() 方法</h4> 
<ul><li>BroadcastReceiver receiver, MyDynamicReceiver 对象</li><li>IntentFilter filter, 添加了 action 的 IntentFilter 对象</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Intent</span> <span class="token function">registerReceiver</span><span class="token punctuation">(</span><span class="token class-name">BroadcastReceiver</span> receiver<span class="token punctuation">,</span> <span class="token class-name">IntentFilter</span> filter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">registerReceiver</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>内部调用重载的 <code>registerReceiver</code> 方法</p> 
<ul><li>BroadcastReceiver receiver, MyDynamicReceiver 对象</li><li>IntentFilter filter, 添加了 action 的 IntentFilter 对象</li><li>String broadcastPermission, null</li><li>Handler scheduler, null</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Intent</span> <span class="token function">registerReceiver</span><span class="token punctuation">(</span><span class="token class-name">BroadcastReceiver</span> receiver<span class="token punctuation">,</span> <span class="token class-name">IntentFilter</span> filter<span class="token punctuation">,</span>
        <span class="token class-name">String</span> broadcastPermission<span class="token punctuation">,</span> <span class="token class-name">Handler</span> scheduler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">registerReceiverInternal</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            filter<span class="token punctuation">,</span> broadcastPermission<span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span> <span class="token function">getOuterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里的 <code>getOuterContext()</code> 方法获取的是 <code>mOuterContext</code> 对象，是通过 <code>setOuterContext</code> 方法赋值的。</p> 
<p>我们这里的 <code>ContextImpl</code> 对象是在创建 <code>MainActivity</code> 的时候被初始化的，具体来说是在 <code>ActivityThread</code> 的 <code>performLaunchActivity</code> 方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">Activity</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Activity</span> activity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span> cl <span class="token operator">=</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建 Activity 对象</span>
        activity <span class="token operator">=</span> mInstrumentation<span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span>
                cl<span class="token punctuation">,</span> component<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">Application</span> app <span class="token operator">=</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mInstrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 创建 ContextImpl 对象</span>
            <span class="token class-name">Context</span> appContext <span class="token operator">=</span> <span class="token function">createBaseContextForActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 把 ContextImpl 对象和 Activity 对象相关联</span>
            activity<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>token<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>ident<span class="token punctuation">,</span> app<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> title<span class="token punctuation">,</span> r<span class="token punctuation">.</span>parent<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>embeddedID<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastNonConfigurationInstances<span class="token punctuation">,</span> config<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>    
    <span class="token keyword">return</span> activity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 <code>createBaseContextForActivity</code> 方法中，调用 <code>setOuterContext</code> 方法把 <code>activity</code> 对象赋值给 <code>ContextImpl</code> 对象。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">Context</span> <span class="token function">createBaseContextForActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">Activity</span> activity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ContextImpl</span> appContext <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token function">createActivityContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>packageInfo<span class="token punctuation">,</span> r<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    appContext<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Context</span> baseContext <span class="token operator">=</span> appContext<span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> baseContext<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>所以，<code>getOuterContext()</code> 方法获取的就是 <code>MainActivity</code> 对象。</p> 
<h4><a id="213_ContextImplregisterReceiverInternal__165"></a>2.1.3 ContextImpl.registerReceiverInternal() 方法</h4> 
<ul><li>BroadcastReceiver receiver, MyDynamicReceiver 对象</li><li>int userId, 通过 UserHandle 对象的 getIdentifier() 方法获得</li><li>IntentFilter filter, 添加了 action 的 IntentFilter 对象</li><li>String broadcastPermission, null</li><li>Handler scheduler, null</li><li>Context context, MainActivity 对象</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">Intent</span> <span class="token function">registerReceiverInternal</span><span class="token punctuation">(</span><span class="token class-name">BroadcastReceiver</span> receiver<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span>
        <span class="token class-name">IntentFilter</span> filter<span class="token punctuation">,</span> <span class="token class-name">String</span> broadcastPermission<span class="token punctuation">,</span>
        <span class="token class-name">Handler</span> scheduler<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">IIntentReceiver</span> rd <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进入此分支</span>
    	<span class="token comment">// mPackageInfo 是 LoadedApk 对象，是在创建 ContextImpl 的时候赋值的，不为 null</span>
    	<span class="token comment">// context 是 MainActivity 对象，不为 null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> context <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进入此分支</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进入此分支，对 scheduler 进行赋值</span>
            	<span class="token comment">// mMainThread 是 ActivityThread 对象，通过 getHandler() 方法获取的是它的 H mH 对象。</span>
                scheduler <span class="token operator">=</span> mMainThread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 获取 InnerReceiver 对象，见[2.1.3.1]</span>
            rd <span class="token operator">=</span> mPackageInfo<span class="token punctuation">.</span><span class="token function">getReceiverDispatcher</span><span class="token punctuation">(</span>
                receiver<span class="token punctuation">,</span> context<span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span>
                mMainThread<span class="token punctuation">.</span><span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 不会进入这里</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 调用到这里，通过 AMP 经过 binder 驱动，向 AMS 发起远程调用。</span>
    	<span class="token comment">// ActivityManagerNative.getDefault() 见[2.1.3.3]</span>
        <span class="token keyword">return</span> <span class="token class-name">ActivityManagerNative</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerReceiver</span><span class="token punctuation">(</span>
                mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mBasePackageName<span class="token punctuation">,</span>
                rd<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> broadcastPermission<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在这里思考一下，为什么我们不直接把 <code>BroadcastReceiver</code> 对象传递给 AMS，而是把通过 <code>getReceiverDispatcher()</code> 方法获取的 <code>InnerReceiver</code> 对象传递给 AMS？</p> 
<p>这是因为 <code>BroadcastReceiver</code> 仅仅是一个普通的 java 类而已：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastReceiver</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>而广播接收者的注册过程是一个进程间通信的过程， <code>BroadcastReceiver</code> 作为一个普通的 java 类，不具备跨进程通信的能力，所以 Android 封装了具有跨进程传输能力的 <code>InnerReciver</code> 来完成 <code>BroadcastReceiver</code> 不能完成的工作。</p> 
<p>当 <code>InnerReciver</code> 接收到广播时，会再调用到 <code>BroadcastReceiver</code> 的 <code>onReceive()</code> 方法，也就是说，<code>InnerReciver</code> 起到了一个中转作用。</p> 
<h5><a id="2131_LoadedApkgetReceiverDispatcher__222"></a>2.1.3.1 LoadedApk.getReceiverDispatcher() 方法</h5> 
<ul><li>BroadcastReceiver r, MyDynamicReceiver 对象</li><li>Context context, MainActivity 对象</li><li>Handler handler, ActivityThread 里的 mH 对象</li><li>Instrumentation instrumentation, Instrumentation 对象，是在 ActivityThread 的 handleBindApplication 方法中创建的</li><li>boolean registered, true</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">LoadedApk</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// mReceivers 是一个 ArrayMap 集合，以 Context 为键，以 ArrayMap&lt;BroadcastReceiver, ReceiverDispatcher&gt; 为值</span>
	<span class="token comment">// 其中值又是一个 ArrayMap 集合，以 BroadcastReceiver 为键，以 ReceiverDispatcher 为值</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Context</span><span class="token punctuation">,</span> <span class="token class-name">ArrayMap</span><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastReceiver</span><span class="token punctuation">,</span> <span class="token class-name">ReceiverDispatcher</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mReceivers
			<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Context</span><span class="token punctuation">,</span> <span class="token class-name">ArrayMap</span><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastReceiver</span><span class="token punctuation">,</span> <span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token class-name">IIntentReceiver</span> <span class="token function">getReceiverDispatcher</span><span class="token punctuation">(</span><span class="token class-name">BroadcastReceiver</span> r<span class="token punctuation">,</span>
			<span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Handler</span> handler<span class="token punctuation">,</span>
			<span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">,</span> <span class="token keyword">boolean</span> registered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mReceivers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 获取一个 ReceiverDispatcher 对象</span>
			<span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span> rd <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastReceiver</span><span class="token punctuation">,</span> <span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// registered 为 true，进入此分支</span>
				<span class="token comment">// 根据 context 对象，从 mReceivers 里面取出 map 对象</span>
				map <span class="token operator">=</span> mReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 如果 map 不为 null，再根据 r 对象，取出 ReceiverDispatcher rd 对象</span>
					rd <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>rd <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 创建 ReceiverDispatcher 对象，见[2.1.3.2]</span>
				rd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReceiverDispatcher</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> context<span class="token punctuation">,</span> handler<span class="token punctuation">,</span>
						instrumentation<span class="token punctuation">,</span> registered<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进入此分支</span>
					<span class="token comment">// 把 rd 存到 mReceivers 这个数据结构中</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastReceiver</span><span class="token punctuation">,</span> <span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						mReceivers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> rd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				rd<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			rd<span class="token punctuation">.</span>mForgotten <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token comment">// 通过 ReceiverDispatcher 对象，获取 InnerReceiver 对象。</span>
			<span class="token keyword">return</span> rd<span class="token punctuation">.</span><span class="token function">getIIntentReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2132_new_LoadedApkReceiverDispatcher__274"></a>2.1.3.2 new LoadedApk.ReceiverDispatcher() 方法</h5> 
<ul><li>BroadcastReceiver r, MyDynamicReceiver 对象</li><li>Context context, MainActivity 对象</li><li>Handler activityThread, ActivityThread 里的 mH 对象</li><li>Instrumentation instrumentation, Instrumentation 对象，是在 ActivityThread 的 handleBindApplication 方法中创建的</li><li>boolean registered, true</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">LoadedApk</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ReceiverDispatcher</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InnerReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">IIntentReceiver<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">final</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span><span class="token punctuation">&gt;</span></span> mDispatcher<span class="token punctuation">;</span>
			<span class="token keyword">final</span> <span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span> mStrongRef<span class="token punctuation">;</span>
			<span class="token class-name">InnerReceiver</span><span class="token punctuation">(</span><span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span> rd<span class="token punctuation">,</span> <span class="token keyword">boolean</span> strong<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				mDispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>rd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				mStrongRef <span class="token operator">=</span> strong <span class="token operator">?</span> rd <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performReceive</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">,</span>
					<span class="token class-name">Bundle</span> extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span> rd <span class="token operator">=</span> mDispatcher<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>rd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					rd<span class="token punctuation">.</span><span class="token function">performReceive</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span>
							ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> 
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">final</span> <span class="token class-name">IIntentReceiver<span class="token punctuation">.</span>Stub</span> mIIntentReceiver<span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">BroadcastReceiver</span> mReceiver<span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">Context</span> mContext<span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">Handler</span> mActivityThread<span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">Instrumentation</span> mInstrumentation<span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token keyword">boolean</span> mRegistered<span class="token punctuation">;</span>
		<span class="token keyword">boolean</span> mForgotten<span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver<span class="token punctuation">.</span>PendingResult</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">private</span> <span class="token class-name">Intent</span> mCurIntent<span class="token punctuation">;</span>
			<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> mOrdered<span class="token punctuation">;</span>
			<span class="token keyword">public</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> resultData<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> resultExtras<span class="token punctuation">,</span>
					<span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">super</span><span class="token punctuation">(</span>resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span>
						mRegistered <span class="token operator">?</span> TYPE_REGISTERED <span class="token operator">:</span> TYPE_UNREGISTERED<span class="token punctuation">,</span>
						ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> mIIntentReceiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
				mCurIntent <span class="token operator">=</span> intent<span class="token punctuation">;</span>
				mOrdered <span class="token operator">=</span> ordered<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">final</span> <span class="token class-name">BroadcastReceiver</span> receiver <span class="token operator">=</span> mReceiver<span class="token punctuation">;</span>
				<span class="token keyword">final</span> <span class="token keyword">boolean</span> ordered <span class="token operator">=</span> mOrdered<span class="token punctuation">;</span>
				
				<span class="token keyword">final</span> <span class="token class-name">IActivityManager</span> mgr <span class="token operator">=</span> <span class="token class-name">ActivityManagerNative</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">final</span> <span class="token class-name">Intent</span> intent <span class="token operator">=</span> mCurIntent<span class="token punctuation">;</span>
				mCurIntent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				
				<span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mForgotten<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>mRegistered <span class="token operator">&amp;&amp;</span> ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">return</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
					<span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span>  mReceiver<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
					receiver<span class="token punctuation">.</span><span class="token function">setPendingResult</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					receiver<span class="token punctuation">.</span><span class="token function">onReceive</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
				
				<span class="token keyword">if</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">getPendingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">ReceiverDispatcher</span><span class="token punctuation">(</span><span class="token class-name">BroadcastReceiver</span> receiver<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span>
				<span class="token class-name">Handler</span> activityThread<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">,</span>
				<span class="token keyword">boolean</span> registered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			mIIntentReceiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InnerReceiver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">!</span>registered<span class="token punctuation">)</span><span class="token punctuation">;</span>
			mReceiver <span class="token operator">=</span> receiver<span class="token punctuation">;</span>
			mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
			mActivityThread <span class="token operator">=</span> activityThread<span class="token punctuation">;</span>
			mInstrumentation <span class="token operator">=</span> instrumentation<span class="token punctuation">;</span>
			mRegistered <span class="token operator">=</span> registered<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token class-name">IIntentReceiver</span> <span class="token function">getIIntentReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> mIIntentReceiver<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performReceive</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">,</span>
				<span class="token class-name">Bundle</span> extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Args</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span>
					sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mActivityThread<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>IIntentReceiver.aidl</code> 文件如下：</p> 
<pre><code class="prism language-java">oneway <span class="token keyword">interface</span> <span class="token class-name">IIntentReceiver</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">void</span> <span class="token function">performReceive</span><span class="token punctuation">(</span>in <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">,</span>
            in <span class="token class-name">Bundle</span> extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>类结构图如下：<br> <img src="https://images2.imgbox.com/0e/09/m0KwgoqG_o.png" alt="在这里插入图片描述"><br> 从类结构图可以看到，</p> 
<ul><li><code>LoadedApk.ReceiverDispatcher</code> 分别持有 <code>InnerReceiver</code> 对象 和 <code>BroadcastReceiver</code> 对象，这样 <code>LoadedApk.ReceiverDispatcher</code> 可以获取到 <code>BroadcastReceiver</code> 对象；</li><li><code>InnerReceiver</code> 通过弱引用持有 <code>LoadedApk.ReceiverDispatcher</code> 对象，所以 <code>InnerReceiver</code> 可以找到 <code>LoadedApk.ReceiverDispatcher</code> 对象；</li><li><code>InnerReceiver</code> 可以获取<code>LoadedApk.ReceiverDispatcher</code> 对象，且<code>LoadedApk.ReceiverDispatcher</code> 可以获取到 <code>BroadcastReceiver</code> 对象，因此 <code>InnerReceiver</code> 可以通过 <code>LoadedApk.ReceiverDispatcher</code>获取<code>BroadcastReceiver</code> 对象（这样我们可以说 <code>LoadedApk.ReceiverDispatcher</code>起到了连接 <code>InnerReceiver</code> 和<code>BroadcastReceiver</code>的作用）；</li><li><code>InnerReceiver</code> 是一个继承于 <code>IIntentReceiver.Stub</code> 的类，所以它是一个 binder 通信的服务端类。</li></ul> 
<h5><a id="2133_ActivityManagerNativegetDefault__390"></a>2.1.3.3 ActivityManagerNative.getDefault() 方法</h5> 
<pre><code class="prism language-java"><span class="token comment">// ActivityManagerNative 类：</span>
<span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token class-name">IActivityManager</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> gDefault<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityManager</span><span class="token punctuation">&gt;</span></span> gDefault <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityManager</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span> <span class="token class-name">IActivityManager</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">IBinder</span> b <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token string">"activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IActivityManager</span> am <span class="token operator">=</span> <span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> am<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 因为这里客户端和服务端不处于同一个进程，所以这个方法返回的是 ActivityManagerProxy 对象。</span>
<span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token class-name">IActivityManager</span> <span class="token function">asInterface</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">IActivityManager</span> in <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token class-name">IActivityManager</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">queryLocalInterface</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> in<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ActivityManagerProxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> mInstance<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">T</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mInstance <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> mInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>这里采用的是局部单例技术，保证获取到的 <code>IActivityManager</code> 对象总是一个对象，实际上是 <code>ActivityManagerProxy</code> 对象。</p> 
<h4><a id="214_ActivityManagerProxyregisterReceiver__439"></a>2.1.4 ActivityManagerProxy.registerReceiver() 方法</h4> 
<ul><li>IApplicationThread caller, ApplicationThread 对象，作为 binder 服务端，用于 AMS 进程向客户端进程发起通信</li><li>String packageName, 包名，即 “com.wzc.chapter_9”</li><li>IIntentReceiver receiver, InnerReceiver 对象</li><li>IntentFilter filter, 添加了 action 的 IntentFilter 对象</li><li>String perm, null</li><li>int userId, 通过 UserHandle 对象的 getIdentifier() 方法获得</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">ActivityManagerProxy</span> <span class="token keyword">implements</span> <span class="token class-name">IActivityManager</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span> <span class="token class-name">Intent</span> <span class="token function">registerReceiver</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> packageName<span class="token punctuation">,</span>
			<span class="token class-name">IIntentReceiver</span> receiver<span class="token punctuation">,</span>
			<span class="token class-name">IntentFilter</span> filter<span class="token punctuation">,</span> <span class="token class-name">String</span> perm<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Parcel</span> data <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Parcel</span> reply <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token class-name">IActivityManager</span><span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> caller<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>receiver <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> receiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		filter<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mRemote<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span>REGISTER_RECEIVER_TRANSACTION<span class="token punctuation">,</span> data<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		reply<span class="token punctuation">.</span><span class="token function">readException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> haveIntent <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>haveIntent <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			intent <span class="token operator">=</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>CREATOR<span class="token punctuation">.</span><span class="token function">createFromParcel</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		reply<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> intent<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个方法仍是在客户端进程调用的。</p> 
<p><code>mRemote.transact()</code> 是客户端进程发起 binder 通信的方法，经过 binder 驱动，最后会到 binder 服务端 <code>ActivityManagerNative</code>的 <code>onTransact()</code> 方法。</p> 
<h4><a id="215_ActivityManagerNativeonTransact__482"></a>2.1.5 ActivityManagerNative.onTransact() 方法</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">Parcel</span> data<span class="token punctuation">,</span> <span class="token class-name">Parcel</span> reply<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token keyword">case</span> REGISTER_RECEIVER_TRANSACTION<span class="token operator">:</span>
		<span class="token punctuation">{<!-- --></span>
			data<span class="token punctuation">.</span><span class="token function">enforceInterface</span><span class="token punctuation">(</span><span class="token class-name">IActivityManager</span><span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">IBinder</span> b <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 这里获取的是 ApplicationThreadProxy 对象，是 binder 客户端对象。</span>
			<span class="token class-name">IApplicationThread</span> app <span class="token operator">=</span>
				b <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">ApplicationThreadNative</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> packageName <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			b <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 这里获取的是 IIntentReceiver.Stub.Proxy 对象，是 binder 客户端对象。</span>
			<span class="token class-name">IIntentReceiver</span> rec
				<span class="token operator">=</span> b <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">IIntentReceiver<span class="token punctuation">.</span>Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token class-name">IntentFilter</span> filter <span class="token operator">=</span> <span class="token class-name">IntentFilter</span><span class="token punctuation">.</span>CREATOR<span class="token punctuation">.</span><span class="token function">createFromParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> perm <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> userId <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 调用到这里，进入 AMS，见[2.1.6]</span>
			<span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token function">registerReceiver</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> packageName<span class="token punctuation">,</span> rec<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> perm<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
			reply<span class="token punctuation">.</span><span class="token function">writeNoException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				reply<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				intent<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				reply<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>ActivityManagerNative</code> 是抽象类，<code>registerReceiver()</code> 是它的一个抽象方法。</p> 
<p><code>ActivityManagerService</code> 继承了 <code>ActivityManagerNative</code>，实现了 <code>registerReceiver()</code> 这个抽象方法。</p> 
<h4><a id="216_ActivityManagerServiceregisterReceiver__524"></a>2.1.6 ActivityManagerService.registerReceiver() 方法</h4> 
<ul><li>IApplicationThread caller, ApplicationThreadProxy对象，作为 binder 客户端</li><li>String packageName, 包名，即 “com.wzc.chapter_9”</li><li>IIntentReceiver receiver, InnerReceiver.Stub.Proxy对象</li><li>IntentFilter filter, 添加了 action 的 IntentFilter 对象</li><li>String perm, null</li><li>int userId, 通过 UserHandle 对象的 getIdentifier() 方法获得</li></ul> 
<pre><code class="prism language-java"><span class="token comment">// mRegisteredReceivers 用于记录所有已经被注册给广播的 IIntentReceiver</span>
<span class="token comment">// 键为 InnerReceiver.Stub.Proxy 对应的 BinderProxy 对象</span>
<span class="token comment">// 值为 ReceiverList 对象</span>
<span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IBinder</span><span class="token punctuation">,</span> <span class="token class-name">ReceiverList</span><span class="token punctuation">&gt;</span></span> mRegisteredReceivers <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IBinder</span><span class="token punctuation">,</span> <span class="token class-name">ReceiverList</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">IntentResolver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastFilter</span><span class="token punctuation">,</span> <span class="token class-name">BroadcastFilter</span><span class="token punctuation">&gt;</span></span> mReceiverResolver
        <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentResolver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastFilter</span><span class="token punctuation">,</span> <span class="token class-name">BroadcastFilter</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">Intent</span> <span class="token function">registerReceiver</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callerPackage<span class="token punctuation">,</span>
        <span class="token class-name">IIntentReceiver</span> receiver<span class="token punctuation">,</span> <span class="token class-name">IntentFilter</span> filter<span class="token punctuation">,</span> <span class="token class-name">String</span> permission<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> callingUid<span class="token punctuation">;</span>
    <span class="token keyword">int</span> callingPid<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ProcessRecord</span> callerApp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进入此分支</span>
			<span class="token comment">// 获取发起方的进程记录对象</span>
            callerApp <span class="token operator">=</span> <span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 不为 null</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 本次分析 callerApp.pkgList.containsKey(callerPackage) 为 true，所以不会进入此分支。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid <span class="token operator">!=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span>SYSTEM_UID <span class="token operator">&amp;&amp;</span>
                    <span class="token operator">!</span>callerApp<span class="token punctuation">.</span>pkgList<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>callerPackage<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token operator">!</span><span class="token string">"android"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>callerPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            callingUid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
            callingPid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 不会进入此分支</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        userId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleIncomingUser</span><span class="token punctuation">(</span>callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
                <span class="token boolean">true</span><span class="token punctuation">,</span> ALLOW_FULL_ONLY<span class="token punctuation">,</span> <span class="token string">"registerReceiver"</span><span class="token punctuation">,</span> callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span> allSticky <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// Look for any matching sticky broadcasts...</span>
        <span class="token class-name">Iterator</span> actions <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">actionsIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>actions <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进入此分支</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>actions<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">String</span> action <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>actions<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 获取 sticky intent 的列表，本次分析没有 sticky intent，所以 allSticky 为 null。</span>
                allSticky <span class="token operator">=</span> <span class="token function">getStickiesLocked</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> allSticky<span class="token punctuation">,</span>
                        <span class="token class-name">UserHandle</span><span class="token punctuation">.</span>USER_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                allSticky <span class="token operator">=</span> <span class="token function">getStickiesLocked</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> allSticky<span class="token punctuation">,</span>
                        <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> 
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Intent</span> sticky <span class="token operator">=</span> allSticky <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">)</span>allSticky<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 返回 null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 不为 null</span>
            <span class="token keyword">return</span> sticky<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 从 mRegisteredReceivers 获取对应 InnerReceiver.Stub.Proxy 对应的 BinderProxy 对象 的 ReceiverList 集合</span>
		<span class="token comment">// 因为我们是首次注册，所以这里获取到的 rl 是 null</span>
        <span class="token class-name">ReceiverList</span> rl
            <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ReceiverList</span><span class="token punctuation">)</span>mRegisteredReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进入此分支</span>
			<span class="token comment">// 创建一个 ReceiverList 对象。</span>
            rl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReceiverList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                    userId<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rl<span class="token punctuation">.</span>app <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// r1.app 就是 callerApp，不为 null，进入此分支</span>
                rl<span class="token punctuation">.</span>app<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把 rl 添加到 ProcessRecord 的 receivers 列表里面保存。</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 把新建的 rl 添加到 mRegisteredReceivers 集合里面保存。</span>
            mRegisteredReceivers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token comment">// 创建 BroadcastFilter 对象，BroadcastFilter 是 IntentFilter 的子类</span>
        <span class="token class-name">BroadcastFilter</span> bf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> rl<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span>
                permission<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 保存在 rl 里面</span>
        rl<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// BroadcastFilter 对象添加到 mReceiverResolver 里面。</span>
        mReceiverResolver<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>bf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>allSticky <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// allSticky 为 null，不会进入此分支</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sticky<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法的作用：</p> 
<ol><li>创建 <code>ReceiverList</code> 对象，它封装了 <code>InnerReceiver.Stub.Proxy</code>对象，并保存在 <code>mRegisteredReceivers</code> 集合里面；</li><li>创建 <code>BroadcastFilter</code> 对象，封装了 <code>IntentFilter</code> 对象， <code>ReceiverList</code> 对象，并保存在 <code>mReceiverResolver</code> 和 <code>ReceiverList</code> 集合对象里面。</li></ol> 
<p>类结构图如下：</p> 
<p><img src="https://images2.imgbox.com/14/96/qWgotR2Q_o.png" alt="在这里插入图片描述"></p> 
<p>这样，广播接收者的注册就完成了。</p> 
<h5><a id="2161_IntentResolveraddFilter_628"></a>2.1.6.1 IntentResolver.addFilter()方法</h5> 
<ul><li>F f, BroadcastFilter 对象</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">IntentResolver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">F</span> <span class="token keyword">extends</span> <span class="token class-name">IntentFilter</span><span class="token punctuation">,</span> <span class="token class-name">R</span> <span class="token keyword">extends</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 以 BroadcastFilter 为元素的列表</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">F</span><span class="token punctuation">&gt;</span></span> mFilters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">F</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 以 action 为键，以 BroadcastFilter[] 为值的集合</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> mActionToFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token class-name">F</span> f<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		mFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> numS <span class="token operator">=</span> <span class="token function">register_intent_filter</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">schemesIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				mSchemeToFilter<span class="token punctuation">,</span> <span class="token string">"      Scheme: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 没有设置 schema，所以返回 0</span>
		<span class="token keyword">int</span> numT <span class="token operator">=</span> <span class="token function">register_mime_types</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"      Type: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 没有设置 type，所以返回 0</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>numS <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> numT <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进入此分支，把 F f 存放到 mActionToFilter 集合里面。</span>
			<span class="token function">register_intent_filter</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">actionsIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					mActionToFilter<span class="token punctuation">,</span> <span class="token string">"      Action: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22__652"></a>2.2 发送普通广播</h3> 
<h4><a id="221_ContextWrappersendBroadcast__654"></a>2.2.1 ContextWrapper.sendBroadcast() 方法</h4> 
<ul><li>Intent intent, 添加了 action 的 Intent 对象</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendBroadcast</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    mBase<span class="token punctuation">.</span><span class="token function">sendBroadcast</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>同 2.1.1， <code>mBase</code> 实际上是一个 <code>ContextImpl</code> 类型的对象。</p> 
<h4><a id="222_ContextImplsendBroadcast__667"></a>2.2.2 ContextImpl.sendBroadcast() 方法</h4> 
<ul><li>Intent intent, 添加了 action 的 Intent 对象</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendBroadcast</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> resolvedType <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 调用到这里，见[2.2.3]</span>
        <span class="token class-name">ActivityManagerNative</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">broadcastIntent</span><span class="token punctuation">(</span>
            mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            <span class="token class-name">Activity</span><span class="token punctuation">.</span>RESULT_OK<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">AppOpsManager</span><span class="token punctuation">.</span>OP_NONE<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由 2.1.3.3，<code>ActivityManagerNative.getDefault()</code> 获取的是一个<code>ActivityManagerProxy</code> 对象。</p> 
<h4><a id="223_ActivityManagerProxybroadcastIntent__689"></a>2.2.3 ActivityManagerProxy.broadcastIntent() 方法</h4> 
<ul><li>IApplicationThread caller, ApplicationThread 对象，作为 binder 服务端，用于 AMS 进程向客户端进程发起通信</li><li>Intent intent, 添加了 action 的 Intent 对象</li><li>String resolvedType, 由 intent.resolveTypeIfNeeded 得到</li><li>IIntentReceiver resultTo, null</li><li>int resultCode, Activity.RESULT_OK，值为 -1</li><li>String resultData, null</li><li>Bundle map, null</li><li>String requiredPermission, null</li><li>int appOp, AppOpsManager.OP_NONE，值为 -1</li><li>boolean serialized, false，表示不是有序广播</li><li>boolean sticky, false，表示不是粘性广播</li><li>int userId, mUser.getIdentifier() 得到</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">ActivityManagerProxy</span> <span class="token keyword">implements</span> <span class="token class-name">IActivityManager</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">broadcastIntent</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span>
			<span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span>  <span class="token class-name">IIntentReceiver</span> resultTo<span class="token punctuation">,</span>
			<span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> resultData<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> map<span class="token punctuation">,</span>
			<span class="token class-name">String</span> requiredPermission<span class="token punctuation">,</span> <span class="token keyword">int</span> appOp<span class="token punctuation">,</span> <span class="token keyword">boolean</span> serialized<span class="token punctuation">,</span>
			<span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Parcel</span> data <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Parcel</span> reply <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token class-name">IActivityManager</span><span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> caller<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		intent<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>resolvedType<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>resultTo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> resultTo<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>resultCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>resultData<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeBundle</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>requiredPermission<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>appOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>serialized <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>sticky <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 调用到这里，见[2.2.4]</span>
		mRemote<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span>BROADCAST_INTENT_TRANSACTION<span class="token punctuation">,</span> data<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		reply<span class="token punctuation">.</span><span class="token function">readException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> res <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		reply<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> res<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个方法仍是在客户端进程调用的。</p> 
<p><code>mRemote.transact()</code> 是客户端进程发起 binder 通信的方法，经过 binder 驱动，最后会到 binder 服务端 <code>ActivityManagerNative</code>的 <code>onTransact()</code> 方法。</p> 
<h4><a id="224_ActivityManagerNativeonTransact__743"></a>2.2.4 ActivityManagerNative.onTransact() 方法</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">Parcel</span> data<span class="token punctuation">,</span> <span class="token class-name">Parcel</span> reply<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token keyword">case</span> BROADCAST_INTENT_TRANSACTION<span class="token operator">:</span>
		<span class="token punctuation">{<!-- --></span>
			data<span class="token punctuation">.</span><span class="token function">enforceInterface</span><span class="token punctuation">(</span><span class="token class-name">IActivityManager</span><span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">IBinder</span> b <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 这里获取的是 ApplicationThreadProxy 对象，是 binder 客户端对象。</span>
			<span class="token class-name">IApplicationThread</span> app <span class="token operator">=</span>
				b <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">ApplicationThreadNative</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>CREATOR<span class="token punctuation">.</span><span class="token function">createFromParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> resolvedType <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			b <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 这里 resultTo 为 null，因为 b 为 null。</span>
			<span class="token class-name">IIntentReceiver</span> resultTo <span class="token operator">=</span>
				b <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">IIntentReceiver<span class="token punctuation">.</span>Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> resultCode <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> resultData <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Bundle</span> resultExtras <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> perm <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> appOp <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">boolean</span> serialized <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">boolean</span> sticky <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> userId <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 调用到这里，见[2.2.5]</span>
			<span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">broadcastIntent</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span>
					resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span> perm<span class="token punctuation">,</span> appOp<span class="token punctuation">,</span>
					serialized<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
			reply<span class="token punctuation">.</span><span class="token function">writeNoException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			reply<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里已经在 system_server 进程了。</p> 
<h4><a id="225_ActivityManagerServicebroadcastIntent__786"></a>2.2.5 ActivityManagerService.broadcastIntent() 方法</h4> 
<ul><li>IApplicationThread caller, ApplicationThreadProxy 对象，作为 binder 客户端</li><li>Intent intent, 添加了 action 的 Intent 对象</li><li>String resolvedType, 由 intent.resolveTypeIfNeeded 得到</li><li>IIntentReceiver resultTo, null</li><li>int resultCode, Activity.RESULT_OK，值为 -1</li><li>String resultData, null</li><li>Bundle map, null</li><li>String requiredPermission, null</li><li>int appOp, AppOpsManager.OP_NONE，值为 -1</li><li>boolean serialized, false，表示不是有序广播</li><li>boolean sticky, false，表示不是粘性广播</li><li>int userId, mUser.getIdentifier() 得到</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">broadcastIntent</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span>
        <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IIntentReceiver</span> resultTo<span class="token punctuation">,</span>
        <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> resultData<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> map<span class="token punctuation">,</span>
        <span class="token class-name">String</span> requiredPermission<span class="token punctuation">,</span> <span class="token keyword">int</span> appOp<span class="token punctuation">,</span> <span class="token keyword">boolean</span> serialized<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        intent <span class="token operator">=</span> <span class="token function">verifyBroadcastLocked</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取发起方的进程记录对象</span>
        <span class="token keyword">final</span> <span class="token class-name">ProcessRecord</span> callerApp <span class="token operator">=</span> <span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> callingPid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">broadcastIntentLocked</span><span class="token punctuation">(</span>callerApp<span class="token punctuation">,</span>
                callerApp <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span>
                resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> map<span class="token punctuation">,</span> requiredPermission<span class="token punctuation">,</span> appOp<span class="token punctuation">,</span> serialized<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span>
                callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="226_ActivityManagerServicebroadcastIntentLocked__824"></a>2.2.6 ActivityManagerService.broadcastIntentLocked() 方法</h4> 
<ul><li>ProcessRecord callerApp, 发起方的进程记录对象</li><li>String callerPackage, 发起方的包名</li><li>Intent intent, 添加了 action 的 Intent 对象</li><li>String resolvedType, 由 intent.resolveTypeIfNeeded 得到，为 null</li><li>IIntentReceiver resultTo, null</li><li>int resultCode, Activity.RESULT_OK，值为 -1</li><li>String resultData, null</li><li>Bundle map, null</li><li>String requiredPermission, null</li><li>int appOp, AppOpsManager.OP_NONE，值为 -1</li><li>boolean ordered, false，表示不是有序广播</li><li>boolean sticky, false，表示不是粘性广播</li><li>int callingPid,</li><li>int callingUid,</li><li>int userId, mUser.getIdentifier() 得到，值为 0</li></ul> 
<pre><code class="prism language-java"><span class="token comment">// 记录处于开启状态的 user</span>
<span class="token keyword">final</span> <span class="token class-name">SparseArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserStartedState</span><span class="token punctuation">&gt;</span></span> mStartedUsers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparseArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserStartedState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">final</span> <span class="token class-name">IntentResolver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastFilter</span><span class="token punctuation">,</span> <span class="token class-name">BroadcastFilter</span><span class="token punctuation">&gt;</span></span> mReceiverResolver
        <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentResolver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastFilter</span><span class="token punctuation">,</span> <span class="token class-name">BroadcastFilter</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">broadcastIntentLocked</span><span class="token punctuation">(</span><span class="token class-name">ProcessRecord</span> callerApp<span class="token punctuation">,</span>
        <span class="token class-name">String</span> callerPackage<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span>
        <span class="token class-name">IIntentReceiver</span> resultTo<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> resultData<span class="token punctuation">,</span>
        <span class="token class-name">Bundle</span> map<span class="token punctuation">,</span> <span class="token class-name">String</span> requiredPermission<span class="token punctuation">,</span> <span class="token keyword">int</span> appOp<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> callingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span>
        <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ====&gt; 1，设置广播 flag</span>
    intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// Intent.FLAG_EXCLUDE_STOPPED_PACKAGES 用来控制广播不对停止状态的应用起作用</span>
    intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_EXCLUDE_STOPPED_PACKAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>
    userId <span class="token operator">=</span> <span class="token function">handleIncomingUser</span><span class="token punctuation">(</span>callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span>
            <span class="token boolean">true</span><span class="token punctuation">,</span> ALLOW_NON_FULL<span class="token punctuation">,</span> <span class="token string">"broadcast"</span><span class="token punctuation">,</span> callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 确保正在接收广播的用户已经开启了；否则，跳过本次广播发送。</span>
	<span class="token comment">// 本次分析不会进入此分支。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">!=</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span>USER_ALL <span class="token operator">&amp;&amp;</span> mStartedUsers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callingUid <span class="token operator">!=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span>SYSTEM_UID <span class="token operator">||</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_RECEIVER_BOOT_UPGRADE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>BROADCAST_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// ====&gt; 2，广播权限的验证</span>
	<span class="token comment">// 阻止非系统代码去发送受保护的广播。</span>
    <span class="token keyword">int</span> callingAppId <span class="token operator">=</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callingAppId <span class="token operator">==</span> <span class="token class-name">Process</span><span class="token punctuation">.</span>SYSTEM_UID <span class="token operator">||</span> callingAppId <span class="token operator">==</span> <span class="token class-name">Process</span><span class="token punctuation">.</span>PHONE_UID
        <span class="token operator">||</span> callingAppId <span class="token operator">==</span> <span class="token class-name">Process</span><span class="token punctuation">.</span>SHELL_UID <span class="token operator">||</span> callingAppId <span class="token operator">==</span> <span class="token class-name">Process</span><span class="token punctuation">.</span>BLUETOOTH_UID
        <span class="token operator">||</span> callingAppId <span class="token operator">==</span> <span class="token class-name">Process</span><span class="token punctuation">.</span>NFC_UID <span class="token operator">||</span> callingUid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Always okay.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>callerApp<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// callerApp.persistent 为 false，进入此分支</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AppGlobals</span><span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isProtectedBroadcast</span><span class="token punctuation">(</span>
                    intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 判断 action 是不是受保护的，本次不会进入此分支</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AppWidgetManager</span><span class="token punctuation">.</span>ACTION_APPWIDGET_CONFIGURE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 不会进入此分支</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>BROADCAST_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// ====&gt; 3，处理系统相关广播</span>
	<span class="token comment">// 处理特殊广播，如包移除广播</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> uidRemoved <span class="token operator">=</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_UID_REMOVED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>
            intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_PACKAGE_REMOVED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_PACKAGE_CHANGED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_EXTERNAL_APPLICATIONS_UNAVAILABLE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_EXTERNAL_APPLICATIONS_AVAILABLE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> uidRemoved<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 本次分析没有移除包，不会进入此分支</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">// 本次分析没有安装包，不会进入此分支</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_PACKAGE_ADDED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 本次分析没有时区改变，不会进入此分支</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_TIMEZONE_CHANGED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>UPDATE_TIME_ZONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 如果是时间改变广播，通知所有运行的进程，本次分析不会进入此分支。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_TIME_CHANGED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_CLEAR_DNS_CACHE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mHandler<span class="token punctuation">.</span><span class="token function">sendEmptyMessage</span><span class="token punctuation">(</span>CLEAR_DNS_CACHE_MSG<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Proxy</span><span class="token punctuation">.</span>PROXY_CHANGE_ACTION<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ProxyInfo</span> proxy <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span><span class="token class-name">Proxy</span><span class="token punctuation">.</span>EXTRA_PROXY_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>UPDATE_HTTP_PROXY_MSG<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// ====&gt; 4，是 sticky 广播，就添加 sticky 广播</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sticky<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// sticky 为 false，不会进入此分支</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span>USER_ALL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        users <span class="token operator">=</span> mStartedUserArray<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 我们不考虑多用户，进入此分支</span>
        users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>userId<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// ====&gt; 5，查询 receivers 和 registeredReceivers</span>
    <span class="token class-name">List</span> receivers <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastFilter</span><span class="token punctuation">&gt;</span></span> registeredReceivers <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token comment">// Intent.FLAG_RECEIVER_REGISTERED_ONLY 表示仅仅动态注册的广播接收者才会被调用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_RECEIVER_REGISTERED_ONLY<span class="token punctuation">)</span>
             <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 成立，进入此分支</span>
        <span class="token comment">// 收集静态注册的广播接收者，返回的是 List&lt;ResolveInfo&gt;，见[2.2.6.1]</span>
        receivers <span class="token operator">=</span> <span class="token function">collectReceiverComponents</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> users<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进入此分支</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span>USER_ALL <span class="token operator">&amp;&amp;</span> callingUid <span class="token operator">==</span> <span class="token class-name">Process</span><span class="token punctuation">.</span>SHELL_UID<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进入此分支</span>
			<span class="token comment">// 收集动态注册的广播接收者，见[2.2.6.2]</span>
            registeredReceivers <span class="token operator">=</span> mReceiverResolver<span class="token punctuation">.</span><span class="token function">queryIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span>
                    resolvedType<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> replacePending <span class="token operator">=</span> <span class="token comment">// 没有设置此 flag，所以返回 false。</span>
            <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_RECEIVER_REPLACE_PENDING<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
    
    <span class="token keyword">int</span> NR <span class="token operator">=</span> registeredReceivers <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> registeredReceivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  	<span class="token comment">// ====&gt; 6. 处理并行广播</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ordered <span class="token operator">&amp;&amp;</span> NR <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进入此分支</span>
		<span class="token comment">// 获取到的是 BroadcastQueue mBgBroadcastQueue，它是在 AMS 构造方法中初始化的。</span>
        <span class="token keyword">final</span> <span class="token class-name">BroadcastQueue</span> queue <span class="token operator">=</span> <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建 BroadcastRecord 对象，见[2.2.6.4]</span>
        <span class="token class-name">BroadcastRecord</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span>
                callerPackage<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> requiredPermission<span class="token punctuation">,</span>
                appOp<span class="token punctuation">,</span> registeredReceivers<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> map<span class="token punctuation">,</span>
                ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> replaced <span class="token operator">=</span> replacePending <span class="token operator">&amp;&amp;</span> queue<span class="token punctuation">.</span><span class="token function">replaceParallelBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>replaced<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进入此分支</span>
        	<span class="token comment">// 将 BroadcastRecord 对象添加到并行广播队列，见[2.2.6.5 ]</span>
            queue<span class="token punctuation">.</span><span class="token function">enqueueParallelBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 处理广播，见[2.3.1]</span>
            queue<span class="token punctuation">.</span><span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        registeredReceivers <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        NR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Merge into one list.</span>
    <span class="token keyword">int</span> ir <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>receivers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// receivers 为 null，不会进入此分支</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>ir <span class="token operator">&lt;</span> NR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// ir = 0,NR = 0，不会进入此循环</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>receivers <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> resultTo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// receivers 为 null，且 resultTo 为 null，不会进入此分支</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span>BROADCAST_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法的作用：</p> 
<ol><li>设置广播 flag；</li><li>广播权限的验证；</li><li>处理系统相关广播；</li><li>是 sticky 广播，就添加 sticky 广播；</li><li>查询 receivers 和 registeredReceivers；<br> 在 2.1.6 中，通过 <code>mReceiverResolver.addFilter(bf);</code>添加了 <code>BroadcastFiilter</code> 对象，这里通过 <code>mReceiverResolver.queryIntent</code> 获取之前添加的 <code>BroadcastFiilter</code> 对象列表，赋值给 <code>registeredReceivers</code>。</li><li>处理并行广播。</li></ol> 
<p>需要再次说明的是，我们本次分析的场景是发送普通广播，所以不用关心有序广播和粘性广播的情况。我们有意限定了分析的范围，这样才不会迷失在源码里面。</p> 
<h5><a id="2261_ActivityManagerServicecollectReceiverComponents__995"></a>2.2.6.1 ActivityManagerService.collectReceiverComponents() 方法</h5> 
<ul><li>Intent intent, 添加了 action 的 Intent 对象</li><li>String resolvedType, 由 intent.resolveTypeIfNeeded 得到，为 null</li><li>int callingUid,</li><li>int[] users, 只包含了当前的用户id的数组，这里的用户id的值是0</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResolveInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">collectReceiverComponents</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span>
        <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResolveInfo</span><span class="token punctuation">&gt;</span></span> receivers <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentName</span><span class="token punctuation">&gt;</span></span> singleUserReceivers <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> scannedFirstReceivers <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> user <span class="token operator">:</span> users<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// users 里只有一个元素，所以只会循环一次。</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token comment">// 解析清单文件中静态注册的 receiver，返回可能为 null。</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResolveInfo</span><span class="token punctuation">&gt;</span></span> newReceivers <span class="token operator">=</span> <span class="token class-name">AppGlobals</span><span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">queryIntentReceivers</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> STOCK_PM_FLAGS<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> newReceivers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// user 为 0，不会进入此分支</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newReceivers <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newReceivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 不会进入此分支</span>
                newReceivers <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>receivers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进入此分支</span>
                receivers <span class="token operator">=</span> newReceivers<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newReceivers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 走第一个 if 了，不会再进入 else if</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> receivers<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法的作用：收集静态注册的广播接收者，返回的是 <code>List&lt;ResolveInfo&gt;</code>。</p> 
<p>本次分析没有静态注册广播接收者，所以这个方法会返回 <code>null</code>。</p> 
<h5><a id="2262_IntentResolverqueryIntent__1036"></a>2.2.6.2 IntentResolver.queryIntent() 方法</h5> 
<ul><li>Intent intent, 添加了 action 的 Intent 对象</li><li>String resolvedType, null</li><li>boolean defaultOnly, false</li><li>int userId, 0</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">IntentResolver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">F</span> <span class="token keyword">extends</span> <span class="token class-name">IntentFilter</span><span class="token punctuation">,</span> <span class="token class-name">R</span> <span class="token keyword">extends</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 以 action 为键，以 BroadcastFilter[] 为值的集合</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> mActionToFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryIntent</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token keyword">boolean</span> defaultOnly<span class="token punctuation">,</span>
			<span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">String</span> scheme <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回 null</span>
		<span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> finalList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">F</span><span class="token punctuation">[</span><span class="token punctuation">]</span> firstTypeCut <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token class-name">F</span><span class="token punctuation">[</span><span class="token punctuation">]</span> secondTypeCut <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token class-name">F</span><span class="token punctuation">[</span><span class="token punctuation">]</span> thirdTypeCut <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token class-name">F</span><span class="token punctuation">[</span><span class="token punctuation">]</span> schemeCut <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// resolvedType 为 null，不会进入此分支</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>scheme <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// scheme 为 null，不会进入此分支</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedType <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> scheme <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			firstTypeCut <span class="token operator">=</span> mActionToFilter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">FastImmutableArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> categories <span class="token operator">=</span> <span class="token function">getFastIntentCategories</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回 null</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>firstTypeCut <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		    <span class="token comment">// 见[2.2.6.3]</span>
			<span class="token function">buildResolveList</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> categories<span class="token punctuation">,</span> debug<span class="token punctuation">,</span> defaultOnly<span class="token punctuation">,</span>
					resolvedType<span class="token punctuation">,</span> scheme<span class="token punctuation">,</span> firstTypeCut<span class="token punctuation">,</span> finalList<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>secondTypeCut <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进不去</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>thirdTypeCut <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进不去</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>schemeCut <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 进不去</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
		<span class="token function">sortResults</span><span class="token punctuation">(</span>finalList<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> finalList<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法的作用：从 <code>mActionToFilter</code> 获取 <code>BroadcastFiilter</code> 对象列表。</p> 
<h5><a id="2263_IntentResolverbuildResolveList__1088"></a>2.2.6.3 IntentResolver.buildResolveList() 方法</h5> 
<ul><li>Intent intent, 添加了 action 的 Intent 对象</li><li>FastImmutableArraySet categories, null</li><li>boolean debug, false</li><li>boolean defaultOnly, false</li><li>String resolvedType, null</li><li>String scheme, null</li><li>F[] src, BroadcastFilter[] 对象</li><li>List dest, 容器参数 List 对象</li><li>int userId, 0</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">IntentResolver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">F</span> <span class="token keyword">extends</span> <span class="token class-name">IntentFilter</span><span class="token punctuation">,</span> <span class="token class-name">R</span> <span class="token keyword">extends</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 以 action 为键，以 BroadcastFilter[] 为值的集合</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> mActionToFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">buildResolveList</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">FastImmutableArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> categories<span class="token punctuation">,</span>
			<span class="token keyword">boolean</span> debug<span class="token punctuation">,</span> <span class="token keyword">boolean</span> defaultOnly<span class="token punctuation">,</span>
			<span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">String</span> scheme<span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">[</span><span class="token punctuation">]</span> src<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> dest<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">final</span> <span class="token class-name">String</span> action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "com.wzc.receiver.LAUNCH_DYNAMIC"</span>
		<span class="token keyword">final</span> <span class="token class-name">Uri</span> data <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// null</span>
		<span class="token keyword">final</span> <span class="token class-name">String</span> packageName <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// null</span>
		<span class="token keyword">final</span> <span class="token keyword">boolean</span> excludingStopped <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">isExcludingStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
		<span class="token keyword">final</span> <span class="token class-name">Printer</span> logPrinter<span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">PrintWriter</span> logPrintWriter<span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token class-name">N</span> <span class="token operator">=</span> src <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> src<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">boolean</span> hasNonDefaults <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> i<span class="token punctuation">;</span>
		<span class="token class-name">F</span> filter<span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token class-name">N</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>filter<span class="token operator">=</span>src<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span> match<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>excludingStopped <span class="token operator">&amp;&amp;</span> <span class="token function">isFilterStopped</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>packageName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isPackageForFilter</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
			match <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> scheme<span class="token punctuation">,</span> data<span class="token punctuation">,</span> categories<span class="token punctuation">,</span> TAG<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>defaultOnly <span class="token operator">||</span> filter<span class="token punctuation">.</span><span class="token function">hasCategory</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>CATEGORY_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">final</span> <span class="token class-name">R</span> oneResult <span class="token operator">=</span> <span class="token function">newResult</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> match<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>oneResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						dest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>oneResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
					hasNonDefaults <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法的作用是：对 <code>BroadcastFilter</code> 对象数组进行一些过滤，通过容器参数返回符合条件的 <code>BroadcastFilter</code> 对象。</p> 
<h5><a id="2264_new_BroadcastRecord__1147"></a>2.2.6.4 new BroadcastRecord() 方法</h5> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastRecord</span> <span class="token keyword">extends</span> <span class="token class-name">Binder</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">;</span>    <span class="token comment">// 产生广播的原始 Intent</span>
    <span class="token keyword">final</span> <span class="token class-name">ComponentName</span> targetComp<span class="token punctuation">;</span> <span class="token comment">// 设置在 Intent 上的原始的组件名对象</span>
    <span class="token keyword">final</span> <span class="token class-name">ProcessRecord</span> callerApp<span class="token punctuation">;</span> <span class="token comment">// 发送广播的进程</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> callerPackage<span class="token punctuation">;</span> <span class="token comment">// 发送方的包名</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> callingPid<span class="token punctuation">;</span>   <span class="token comment">// 发起方的pid</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">;</span>   <span class="token comment">// 发起方的uid</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">;</span>  <span class="token comment">// 是否是有序广播</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">;</span>   <span class="token comment">// 是否是粘性广播</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> initialSticky<span class="token punctuation">;</span> 
    <span class="token keyword">final</span> <span class="token keyword">int</span> userId<span class="token punctuation">;</span>       
    <span class="token keyword">final</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">;</span> <span class="token comment">// mime type</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> requiredPermission<span class="token punctuation">;</span> <span class="token comment">// 广播权限</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> appOp<span class="token punctuation">;</span>        
    <span class="token keyword">final</span> <span class="token class-name">List</span> receivers<span class="token punctuation">;</span>   <span class="token comment">// 广播接收器，包括动态注册(BroadcastFilter)和静态注册(ResolveInfo)</span>
    <span class="token class-name">IIntentReceiver</span> resultTo<span class="token punctuation">;</span> <span class="token comment">// null</span>
    <span class="token keyword">long</span> dispatchTime<span class="token punctuation">;</span>      <span class="token comment">// 广播分发时间点</span>
    <span class="token keyword">long</span> dispatchClockTime<span class="token punctuation">;</span> <span class="token comment">// the clock time the dispatch started</span>
    <span class="token keyword">long</span> receiverTime<span class="token punctuation">;</span>      <span class="token comment">// 当前 receiver 开始处理时间点</span>
    <span class="token keyword">long</span> finishTime<span class="token punctuation">;</span>        <span class="token comment">// 广播处理完成时间点.</span>
    <span class="token keyword">int</span> resultCode<span class="token punctuation">;</span>         <span class="token comment">// current result code value.</span>
    <span class="token class-name">String</span> resultData<span class="token punctuation">;</span>      <span class="token comment">// current result data value.</span>
    <span class="token class-name">Bundle</span> resultExtras<span class="token punctuation">;</span>    <span class="token comment">// current result extra data values.</span>
    <span class="token keyword">boolean</span> resultAbort<span class="token punctuation">;</span>    <span class="token comment">// current result abortBroadcast value.</span>
    <span class="token keyword">int</span> nextReceiver<span class="token punctuation">;</span>       <span class="token comment">// next receiver to be executed.</span>
    <span class="token class-name">IBinder</span> receiver<span class="token punctuation">;</span>       <span class="token comment">// who is currently running, null if none.</span>
    <span class="token keyword">int</span> state<span class="token punctuation">;</span>
    <span class="token keyword">int</span> anrCount<span class="token punctuation">;</span>           <span class="token comment">// has this broadcast record hit any ANRs?</span>
    <span class="token class-name">BroadcastQueue</span> queue<span class="token punctuation">;</span>   <span class="token comment">// 处理广播的队列</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> IDLE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> APP_RECEIVE <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CALL_IN_RECEIVE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CALL_DONE_RECEIVE <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> WAITING_SERVICES <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token class-name">BroadcastFilter</span> curFilter<span class="token punctuation">;</span>
    <span class="token class-name">ProcessRecord</span> curApp<span class="token punctuation">;</span>       <span class="token comment">// hosting application of current receiver.</span>
    <span class="token class-name">ComponentName</span> curComponent<span class="token punctuation">;</span> <span class="token comment">// the receiver class that is currently running.</span>
    <span class="token class-name">ActivityInfo</span> curReceiver<span class="token punctuation">;</span>   <span class="token comment">// info about the receiver that is currently running.</span>

    <span class="token class-name">BroadcastRecord</span><span class="token punctuation">(</span><span class="token class-name">BroadcastQueue</span> _queue<span class="token punctuation">,</span>
            <span class="token class-name">Intent</span> _intent<span class="token punctuation">,</span> <span class="token class-name">ProcessRecord</span> _callerApp<span class="token punctuation">,</span> <span class="token class-name">String</span> _callerPackage<span class="token punctuation">,</span>
            <span class="token keyword">int</span> _callingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> _callingUid<span class="token punctuation">,</span> <span class="token class-name">String</span> _resolvedType<span class="token punctuation">,</span> <span class="token class-name">String</span> _requiredPermission<span class="token punctuation">,</span>
            <span class="token keyword">int</span> _appOp<span class="token punctuation">,</span> <span class="token class-name">List</span> _receivers<span class="token punctuation">,</span> <span class="token class-name">IIntentReceiver</span> _resultTo<span class="token punctuation">,</span> <span class="token keyword">int</span> _resultCode<span class="token punctuation">,</span>
            <span class="token class-name">String</span> _resultData<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> _resultExtras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> _serialized<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> _sticky<span class="token punctuation">,</span> <span class="token keyword">boolean</span> _initialSticky<span class="token punctuation">,</span>
            <span class="token keyword">int</span> _userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        queue <span class="token operator">=</span> _queue<span class="token punctuation">;</span>
        intent <span class="token operator">=</span> _intent<span class="token punctuation">;</span>
        targetComp <span class="token operator">=</span> _intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        callerApp <span class="token operator">=</span> _callerApp<span class="token punctuation">;</span>
        callerPackage <span class="token operator">=</span> _callerPackage<span class="token punctuation">;</span>
        callingPid <span class="token operator">=</span> _callingPid<span class="token punctuation">;</span>
        callingUid <span class="token operator">=</span> _callingUid<span class="token punctuation">;</span>
        resolvedType <span class="token operator">=</span> _resolvedType<span class="token punctuation">;</span>
        requiredPermission <span class="token operator">=</span> _requiredPermission<span class="token punctuation">;</span>
        appOp <span class="token operator">=</span> _appOp<span class="token punctuation">;</span>
        receivers <span class="token operator">=</span> _receivers<span class="token punctuation">;</span>
        resultTo <span class="token operator">=</span> _resultTo<span class="token punctuation">;</span>
        resultCode <span class="token operator">=</span> _resultCode<span class="token punctuation">;</span>
        resultData <span class="token operator">=</span> _resultData<span class="token punctuation">;</span>
        resultExtras <span class="token operator">=</span> _resultExtras<span class="token punctuation">;</span>
        ordered <span class="token operator">=</span> _serialized<span class="token punctuation">;</span>
        sticky <span class="token operator">=</span> _sticky<span class="token punctuation">;</span>
        initialSticky <span class="token operator">=</span> _initialSticky<span class="token punctuation">;</span>
        userId <span class="token operator">=</span> _userId<span class="token punctuation">;</span>
        nextReceiver <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        state <span class="token operator">=</span> IDLE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，<code>BroadcastRecord</code> 是继承于 <code>Binder</code> 类的。</p> 
<h5><a id="2265_BroadcastQueueenqueueParallelBroadcastLocked__1224"></a>2.2.6.5 BroadcastQueue.enqueueParallelBroadcastLocked() 方法</h5> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastQueue</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastRecord</span><span class="token punctuation">&gt;</span></span> mParallelBroadcasts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastRecord</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enqueueParallelBroadcastLocked</span><span class="token punctuation">(</span><span class="token class-name">BroadcastRecord</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法的作用：把 <code>BroadcastRecord r</code> 对象添加到 <code>mParallelBroadcasts</code> 列表而已。</p> 
<h3><a id="23__1237"></a>2.3 接收普通广播</h3> 
<h4><a id="231_BroadcastQueuescheduleBroadcastsLocked__1239"></a>2.3.1 BroadcastQueue.scheduleBroadcastsLocked() 方法</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastQueue</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">boolean</span> mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">BroadcastHandler</span> mHandler<span class="token punctuation">;</span>
	
	<span class="token class-name">BroadcastQueue</span><span class="token punctuation">(</span><span class="token class-name">ActivityManagerService</span> service<span class="token punctuation">,</span> <span class="token class-name">Handler</span> handler<span class="token punctuation">,</span>
			<span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">long</span> timeoutPeriod<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowDelayBehindServices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		mService <span class="token operator">=</span> service<span class="token punctuation">;</span>
		mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBroadcastsScheduled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>BROADCAST_INTENT_MSG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法的作用是：通过 <code>mHandler</code> 发送一个 <code>what</code> 为 <code>BROADCAST_INTENT_MSG</code> ，<code>object</code> 为 <code>BroadcastQueue</code> 对象的消息。</p> 
<p><code>mHandler</code> 是在 <code>BroadcastQueue</code> 的构造方法中初始化的：<code>mHandler = new BroadcastHandler(handler.getLooper())</code>，需要特别说明的是，这里的 <code>hanlder.getLooper()</code> 是一个名字 <code>"ActivityManager"</code> 为子线程的 <code>Looper</code> 对象，因为这个 <code>Looper</code> 对象来自于 <code>ActivityManagerService</code> 的 <code>mHandlerThread.getLooper()</code>。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">ActivityManagerNative</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TAG <span class="token operator">=</span> <span class="token string">"ActivityManager"</span><span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">ServiceThread</span> mHandlerThread<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">MainHandler</span> mHandler<span class="token punctuation">;</span>
	<span class="token class-name">BroadcastQueue</span> mFgBroadcastQueue<span class="token punctuation">;</span>
	<span class="token class-name">BroadcastQueue</span> mBgBroadcastQueue<span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token class-name">ActivityManagerService</span><span class="token punctuation">(</span><span class="token class-name">Context</span> systemContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		mContext <span class="token operator">=</span> systemContext<span class="token punctuation">;</span>
		mSystemThread <span class="token operator">=</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">.</span><span class="token function">currentActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		mHandlerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceThread</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span>
				<span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Process</span><span class="token punctuation">.</span>THREAD_PRIORITY_FOREGROUND<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/*allowIo*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		mHandlerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MainHandler</span><span class="token punctuation">(</span>mHandlerThread<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		mFgBroadcastQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mHandler<span class="token punctuation">,</span>
				<span class="token string">"foreground"</span><span class="token punctuation">,</span> BROADCAST_FG_TIMEOUT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		mBgBroadcastQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mHandler<span class="token punctuation">,</span>
				<span class="token string">"background"</span><span class="token punctuation">,</span> BROADCAST_BG_TIMEOUT<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>所以，发送消息是在 system_server 进程的主线程，接收消息的地方是在 system_server 进程的子线程里面了。</p> 
<h4><a id="232_BroadcastHandlerhandleMessage__1291"></a>2.3.2 BroadcastHandler.handleMessage() 方法</h4> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">BroadcastHandler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span> looper<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> BROADCAST_INTENT_MSG<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 见[2.3.3]</span>
                <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> BROADCAST_TIMEOUT_MSG<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="233_BroadcastQueueprocessNextBroadcast__1315"></a>2.3.3 BroadcastQueue.processNextBroadcast() 方法</h4> 
<ul><li>boolean fromMsg, true</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastRecord</span><span class="token punctuation">&gt;</span></span> mParallelBroadcasts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastRecord</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BroadcastRecord</span> r<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 重置 mBroadcastsScheduled 标记。</span>
            mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 首先，马上处理普通广播</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 存在并行广播</span>
            r <span class="token operator">=</span> mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            r<span class="token punctuation">.</span>dispatchTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>dispatchClockTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token class-name">N</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token class-name">N</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Object</span> target <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 调用到这里，见[2.3.4]</span>
                <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">BroadcastFilter</span><span class="token punctuation">)</span>target<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">addBroadcastToHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 当正在等待一个进程被拉起来处理下一个广播，mPendingBroadcast 就不为 null。</span>
		<span class="token comment">// 本次分析不涉及跨进程，所以 mPendingBroadcast 为 null。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingBroadcast <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 本次分析不进入此分支</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> looped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        
        <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 本次分析没有有序广播，所以进入此分支。</span>
                mService<span class="token punctuation">.</span><span class="token function">scheduleAppGcsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>looped<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mService<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 结束本方法了。</span>
            <span class="token punctuation">}</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// ... 省略与本次分析无关的代码。</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法的作用：取出广播队列中的元素，传递给注册的广播接收者。</p> 
<h4><a id="234_BroadcastQueuedeliverToRegisteredReceiverLocked__1365"></a>2.3.4 BroadcastQueue.deliverToRegisteredReceiverLocked() 方法</h4> 
<ul><li>BroadcastRecord r, BroadcastRecord 对象</li><li>BroadcastFilter filter, BroadcastFilter 对象，存储了广播接收者的信息</li><li>boolean ordered, false，表示不是有序广播</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span><span class="token class-name">BroadcastRecord</span> r<span class="token punctuation">,</span>
        <span class="token class-name">BroadcastFilter</span> filter<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">boolean</span> skip <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>requiredPermission <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 不进入此分支</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>requiredPermission <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 不进入此分支</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>appOp <span class="token operator">!=</span> <span class="token class-name">AppOpsManager</span><span class="token punctuation">.</span>OP_NONE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 不进入此分支</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        skip <span class="token operator">=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mIntentFirewall<span class="token punctuation">.</span><span class="token function">checkBroadcast</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>callingUid<span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>callingPid<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resolvedType<span class="token punctuation">,</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">.</span>crashing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        skip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 调用到这里，见[2.3.5] </span>
            <span class="token function">performReceiveLocked</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">,</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>receiver<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> r<span class="token punctuation">.</span>initialSticky<span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法的作用：进行必要的权限验证，然后执行广播接收过程。</p> 
<p>这里为了弄清楚 <code>performReceiveLocked</code> 方法的参数，我们再次查看一下类结构图：</p> 
<p><img src="https://images2.imgbox.com/23/18/xfu2cPwi_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="235_BroadcastQueueperformReceiveLocked__1412"></a>2.3.5 BroadcastQueue.performReceiveLocked() 方法</h4> 
<ul><li>ProcessRecord app, filter.receiverList.app = 发起方的进程记录对象</li><li>IIntentReceiver receiver, filter.receiverList.receiver = InnerReceiver.Stub.Proxy对象</li><li>Intent intent, new Intent(r.intent) = 添加了 action 的 Intent 对象</li><li>int resultCode, r.resultCode = Activity.RESULT_OK，值为 -1</li><li>String data, r.resultData = null</li><li>Bundle extras, r.resultExtras = null</li><li>boolean ordered, r.ordered = false</li><li>boolean sticky, r.initialSticky = false</li><li>int sendingUser, r.userId = 0</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">performReceiveLocked</span><span class="token punctuation">(</span><span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token class-name">IIntentReceiver</span> receiver<span class="token punctuation">,</span>
        <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> extras<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// app.thread 是 IApplicationThread 对象，实际上是 ApplicationThreadProxy 对象，是 binder 客户端对象。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 开始向 IApplicationThread binder 服务端对象发起请求服务，见[2.3.6]</span>
            app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleRegisteredReceiver</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span>
                    data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">,</span> app<span class="token punctuation">.</span>repProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="236_ApplicationThreadProxyscheduleRegisteredReceiver__1447"></a>2.3.6 ApplicationThreadProxy.scheduleRegisteredReceiver() 方法</h4> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">ApplicationThreadProxy</span> <span class="token keyword">implements</span> <span class="token class-name">IApplicationThread</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleRegisteredReceiver</span><span class="token punctuation">(</span><span class="token class-name">IIntentReceiver</span> receiver<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span>
			<span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> dataStr<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span>
			<span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">,</span> <span class="token keyword">int</span> processState<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Parcel</span> data <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span><span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		intent<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>resultCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>dataStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeBundle</span><span class="token punctuation">(</span>extras<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>ordered <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>sticky <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>processState<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mRemote<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span>SCHEDULE_REGISTERED_RECEIVER_TRANSACTION<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
				<span class="token class-name">IBinder</span><span class="token punctuation">.</span>FLAG_ONEWAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
		data<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个方法是运行在 system_server 进程的。</p> 
<p><code>mRemote.transact()</code> 是 system_server 进程发起 binder 通信的方法，经过 binder 驱动，最后会到 binder 服务端 <code>ApplicationThreadNative</code>的 <code>onTransact()</code> 方法。</p> 
<h4><a id="237_ApplicationThreadNativeonTransact__1476"></a>2.3.7 ApplicationThreadNative.onTransact() 方法</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationThreadNative</span> <span class="token keyword">extends</span> <span class="token class-name">Binder</span>
        <span class="token keyword">implements</span> <span class="token class-name">IApplicationThread</span> <span class="token punctuation">{<!-- --></span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">Parcel</span> data<span class="token punctuation">,</span> <span class="token class-name">Parcel</span> reply<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> SCHEDULE_REGISTERED_RECEIVER_TRANSACTION<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
			data<span class="token punctuation">.</span><span class="token function">enforceInterface</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span><span class="token punctuation">.</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 这里获取的是 IIntentReceiver.Stub.Proxy 对象，是 binder 客户端对象</span>
			<span class="token class-name">IIntentReceiver</span> receiver <span class="token operator">=</span> <span class="token class-name">IIntentReceiver<span class="token punctuation">.</span>Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>
					data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span>CREATOR<span class="token punctuation">.</span><span class="token function">createFromParcel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> resultCode <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> dataStr <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Bundle</span> extras <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">boolean</span> ordered <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">boolean</span> sticky <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> sendingUser <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> processState <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">scheduleRegisteredReceiver</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
					resultCode<span class="token punctuation">,</span> dataStr<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">,</span> processState<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>	
	<span class="token punctuation">}</span>				
<span class="token punctuation">}</span>
</code></pre> 
<p><code>ApplicationThreadNative</code> 是一个抽象类，<code>scheduleRegisteredReceiver</code> 是它的一个抽象方法，所以要寻找 <code>scheduleRegisteredReceiver</code> 的实现，实现实在 <code>ApplicationThread</code> 类里面。</p> 
<p><code>ApplicationThread</code> 是 <code>ActivityThread</code> 类的私有内部类。</p> 
<h4><a id="238_ApplicationThreadscheduleRegisteredReceiver__1510"></a>2.3.8 ApplicationThread.scheduleRegisteredReceiver() 方法</h4> 
<ul><li>IIntentReceiver receiver, IIntentReceiver.Stub.Proxy 对象，是 binder 客户端对象</li><li>Intent intent, 添加了 action 的 Intent 对象</li><li>int resultCode, Activity.RESULT_OK，值为 -1</li><li>String dataStr, null</li><li>Bundle extras, null</li><li>boolean ordered, false</li><li>boolean sticky, false</li><li>int sendingUser, 0</li><li>int processState</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationThread</span> <span class="token keyword">extends</span> <span class="token class-name">ApplicationThreadNative</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleRegisteredReceiver</span><span class="token punctuation">(</span><span class="token class-name">IIntentReceiver</span> receiver<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span>
				<span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> dataStr<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span>
				<span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">,</span> <span class="token keyword">int</span> processState<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
			receiver<span class="token punctuation">.</span><span class="token function">performReceive</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> dataStr<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span>
					sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>		
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个方法是运行在客户端进程的 binder 线程池里面。</p> 
<p><code>receiver</code> 是 <code>IIntentReceiver.Stub.Proxy</code> 对象，是 binder 客户端对象。</p> 
<p>调用 <code>receiver.performReceive</code> 方法，会经过 binder 驱动，调用到发起方进程的 <code>IIntentReceiver.Stub</code> 对象，即 <code>InnerReceiver</code>对象的 <code>performReceive</code> 方法。可以查看注册过程的 2.1.3 部分，并且在 2.1.3.2 部分绘制了 <code>InnerReceiver</code>，<code>BroadcastReceiver</code>以及<code>ReceiverDispatcher</code>的类结构图。</p> 
<h4><a id="239_InnerReceiverperformReceive__1543"></a>2.3.9 InnerReceiver.performReceive() 方法</h4> 
<ul><li>Intent intent, 添加了 action 的 Intent 对象</li><li>int resultCode, Activity.RESULT_OK，值为 -1</li><li>String data, null</li><li>Bundle extras, null</li><li>boolean ordered, false</li><li>boolean sticky, false</li><li>int sendingUser, 0</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InnerReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">IIntentReceiver<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span><span class="token punctuation">&gt;</span></span> mDispatcher<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span> mStrongRef<span class="token punctuation">;</span>
    <span class="token class-name">InnerReceiver</span><span class="token punctuation">(</span><span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span> rd<span class="token punctuation">,</span> <span class="token keyword">boolean</span> strong<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mDispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>rd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mStrongRef <span class="token operator">=</span> strong <span class="token operator">?</span> rd <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performReceive</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">,</span>
            <span class="token class-name">Bundle</span> extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span> rd <span class="token operator">=</span> mDispatcher<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
            <span class="token comment">// 调用到这里，见[2.3.10]</span>
            rd<span class="token punctuation">.</span><span class="token function">performReceive</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span>
                    ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2310_ReceiverDispatcherperformReceive__1577"></a>2.3.10 ReceiverDispatcher.performReceive() 方法</h4> 
<ul><li>Intent intent, 添加了 action 的 Intent 对象</li><li>int resultCode, Activity.RESULT_OK，值为 -1</li><li>String data, null</li><li>Bundle extras, null</li><li>boolean ordered, false</li><li>boolean sticky, false</li><li>int sendingUser, 0</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">LoadedApk</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ReceiverDispatcher</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performReceive</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">,</span>
				<span class="token class-name">Bundle</span> extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 把一系列参数封装在 Args 对象里面，是一个 Runnable 对象。</span>
			<span class="token class-name">Args</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span>
					sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// mActivityThread 就是 ActivityThread 类的 mH 对象。</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mActivityThread<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>mActivityThread.post</code> 方法把消息在主线程执行。</p> 
<h4><a id="2311_Argsrun__1606"></a>2.3.11 Args.run() 方法</h4> 
<p><code>Args</code> 是 <code>ReceiverDispatcher</code> 的内部类，因此它可以获取到 <code>ReceiverDispatcher</code> 的成员。</p> 
<pre><code class="prism language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ReceiverDispatcher</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">final</span> <span class="token class-name">BroadcastReceiver</span> mReceiver<span class="token punctuation">;</span>

	<span class="token class-name">ReceiverDispatcher</span><span class="token punctuation">(</span><span class="token class-name">BroadcastReceiver</span> receiver<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span>
			<span class="token class-name">Handler</span> activityThread<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">,</span>
			<span class="token keyword">boolean</span> registered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		mReceiver <span class="token operator">=</span> receiver<span class="token punctuation">;</span>
		mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
		mActivityThread <span class="token operator">=</span> activityThread<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver<span class="token punctuation">.</span>PendingResult</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">private</span> <span class="token class-name">Intent</span> mCurIntent<span class="token punctuation">;</span>
		<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> mOrdered<span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> resultData<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> resultExtras<span class="token punctuation">,</span>
				<span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">super</span><span class="token punctuation">(</span>resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span>
					mRegistered <span class="token operator">?</span> TYPE_REGISTERED <span class="token operator">:</span> TYPE_UNREGISTERED<span class="token punctuation">,</span>
					ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> mIIntentReceiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
			mCurIntent <span class="token operator">=</span> intent<span class="token punctuation">;</span>
			mOrdered <span class="token operator">=</span> ordered<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// mReceiver 就是 MyDynamicReceiver 对象</span>
			<span class="token keyword">final</span> <span class="token class-name">BroadcastReceiver</span> receiver <span class="token operator">=</span> mReceiver<span class="token punctuation">;</span>
			<span class="token keyword">final</span> <span class="token keyword">boolean</span> ordered <span class="token operator">=</span> mOrdered<span class="token punctuation">;</span>
			
			<span class="token keyword">final</span> <span class="token class-name">Intent</span> intent <span class="token operator">=</span> mCurIntent<span class="token punctuation">;</span>
			mCurIntent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span>  mReceiver<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
				receiver<span class="token punctuation">.</span><span class="token function">setPendingResult</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 调用 MyDynamicReceiver 对象的 onReceive 方法</span>
				receiver<span class="token punctuation">.</span><span class="token function">onReceive</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token punctuation">}</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2312_MyDynamicReceiveronReceive__1658"></a>2.3.12 MyDynamicReceiver.onReceive() 方法</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDynamicReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TAG <span class="token operator">=</span> <span class="token string">"MyDynamicReceiver"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ACTION_LAUNCH_DYNAMIC <span class="token operator">=</span> <span class="token string">"com.wzc.receiver.LAUNCH_DYNAMIC"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> "onRecei
        ve<span class="token operator">:</span> receive action <span class="token operator">=</span> " <span class="token operator">+</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ACTION_LAUNCH_DYNAMIC<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onReceive: do launch work..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>到这里，就收到了广播了。</p> 
<h2><a id="3_1679"></a>3.最后</h2> 
<p>本文到这里就结束了，希望可以帮助到大家。</p> 
<h2><a id="4__1681"></a>4. 参考</h2> 
<ol><li> <p><a href="http://gityuan.com/2016/06/04/broadcast-receiver/" rel="nofollow">Android Broadcast广播机制分析-袁辉辉</a></p> </li><li> <p><a href="https://www.kancloud.cn/alex_wsc/android_framework/544199" rel="nofollow">观察者模式深入探讨</a></p> <p>Android 里的广播和广播接收者对应于被观察者和观察者角色，是观察者模式的典型应用。</p> </li><li> <p><a href="https://www.jianshu.com/p/c113ad606080" rel="nofollow">Android：多用户的UserHandle的东东记录</a><br> 这篇文章解决了对 UerHandle 类中的 uid，userid，appid 不清楚的问题。</p> </li><li> <p><a href="http://gityuan.com/2017/06/03/broadcast_record/" rel="nofollow">四大组件之BroadcastRecord-袁辉辉</a></p> </li><li> <p><a href="https://youranhongcha.blog.csdn.net/article/details/42322695" rel="nofollow">品茗论道说广播(Broadcast内部机制讲解)(上)</a></p> </li><li> <p><a href="https://youranhongcha.blog.csdn.net/article/details/42323235" rel="nofollow">品茗论道说广播(Broadcast内部机制讲解)(下)</a></p> </li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/145e424ff9468084e250002a2662bb20/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">前端向后端获取数据的三种方法:ajax、axios、fetch</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9cf4146b17537919e6b5e3d05e19de9e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Go性能优化:Go语言如何进行代码检查和性能优化】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>