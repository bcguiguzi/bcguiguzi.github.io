<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>运行caffe识别数字的模型mnist - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="运行caffe识别数字的模型mnist" />
<meta property="og:description" content="&lt;!---title:运行caffe识别数字的模型mnist--&gt;
&lt;!---keywords:填写关键字, 以半角逗号分割--&gt;
原始引用地址: [运行caffe识别数字的模型mnist](http://yangkuncn.cn/caffe_mnist.html) time: 2020.5.17 23:28
## mnist是啥？
mnist是一个运用神经网络识别数字的模型，可以识别数字0到9.
### 获取mnist模块与数据
对于mnist（就是数字识别）例子，参考以下地址，获取数据训练相关数据：
&lt;http://caffe.berkeleyvision.org/gathered/examples/mnist.html&gt;
准备数据：
```
cd $CAFFE_ROOT ./data/mnist/get_mnist.sh ./examples/mnist/create_mnist.sh
```
### 运用多核，加速训练
caffe在纯CPU模式下，使用多核运行
&lt;https://blog.csdn.net/b876144622/article/details/80009877&gt;
1. sudo apt-get install -y libopenblas-dev
2、修改caffe目录下的Makefile.config文件，将BLAS: =atlas修改为BLAS: =open
3、再编译caffe，首先make clean，清除之前的编译结果，再依次执行make all -j16， make test -j16， make runtest -j16，编译caffe。-j16是指用16个核并行编译caffe，可以大大加快编译速度。
4、编译完成后，执行训练前，需要export OPENBLAS_NUM_THREADS=4, 即使用4个核进行训练
### 开始训练
因为编译时，选择使用cpu，使用要更改文件：
examples/mnist/lenet_solver.prototxt
把：solver_mode: GPU 改为：solver_mode: CPU 训练命令：
```
export PYTHONPATH=/home/xy/works/caffe/python/
time ./examples/mnist/train_lenet.sh #vm用时17m36s j1900 42m55
```
### 进行图片识别
#### 用软件手写一个图片" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/1e426710aac72d158f6e32e6839209b3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-21T21:28:27+08:00" />
<meta property="article:modified_time" content="2020-05-21T21:28:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">运行caffe识别数字的模型mnist</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>&lt;!---title:运行caffe识别数字的模型mnist--&gt;<br> &lt;!---keywords:填写关键字, 以半角逗号分割--&gt;<br> 原始引用地址:  [运行caffe识别数字的模型mnist](http://yangkuncn.cn/caffe_mnist.html)  <br> time:  2020.5.17 23:28</p> 
<p>## mnist是啥？</p> 
<p>mnist是一个运用神经网络识别数字的模型，可以识别数字0到9.</p> 
<p>### 获取mnist模块与数据</p> 
<p>对于mnist（就是数字识别）例子，参考以下地址，获取数据训练相关数据：</p> 
<p>&lt;http://caffe.berkeleyvision.org/gathered/examples/mnist.html&gt;</p> 
<p>准备数据：</p> 
<p>```<br> cd $CAFFE_ROOT <br> ./data/mnist/get_mnist.sh <br> ./examples/mnist/create_mnist.sh<br> ```</p> 
<p>### 运用多核，加速训练</p> 
<p>caffe在纯CPU模式下，使用多核运行</p> 
<p>&lt;https://blog.csdn.net/b876144622/article/details/80009877&gt;</p> 
<p>1. sudo apt-get install -y libopenblas-dev</p> 
<p>2、修改caffe目录下的Makefile.config文件，将BLAS: =atlas修改为BLAS: =open</p> 
<p>3、再编译caffe，首先make clean，清除之前的编译结果，再依次执行make all -j16， make test -j16， make runtest -j16，编译caffe。-j16是指用16个核并行编译caffe，可以大大加快编译速度。</p> 
<p>4、编译完成后，执行训练前，需要export OPENBLAS_NUM_THREADS=4, 即使用4个核进行训练</p> 
<p>### 开始训练</p> 
<p>因为编译时，选择使用cpu，使用要更改文件：</p> 
<p>examples/mnist/lenet_solver.prototxt</p> 
<p>把：solver_mode: GPU      改为：solver_mode: CPU </p> 
<p>训练命令：</p> 
<p>```<br> export PYTHONPATH=/home/xy/works/caffe/python/</p> 
<p>time ./examples/mnist/train_lenet.sh   #vm用时17m36s  j1900 42m55</p> 
<p>```</p> 
<p>### 进行图片识别</p> 
<p>#### 用软件手写一个图片</p> 
<p>（注意：识别的图片，**一定要是黑底， 数字用白色写**）</p> 
<p>安装画图软件gimp：</p> 
<p>```<br> sudo apt-get install gimp<br> ```</p> 
<p>gimp 创建27*27的bmp图：</p> 
<p>1. 新建file -&gt; new 选width 27  height27 单位为像素， 底色选黑</p> 
<p>2. 画图：选画笔，左边size ,可以选2，size太大，27*27的画布不够画的。</p> 
<p>3. 导出：file-&gt;export as, 格式先jpg， </p> 
<p>#### 识别手写的图片</p> 
<p>在运行python/calssify前要运行安装 protobuf：</p> 
<p>```sudo  pip install protobuf```</p> 
<p>在识别图片前，需要对classify进行更改：</p> 
<p>```<br> git diff python/classify.py<br> diff --git a/python/classify.py b/python/classify.py<br> index 4544c51..446c55e 100755<br> --- a/python/classify.py<br> +++ b/python/classify.py<br> @@ -105,9 +105,9 @@ def main(argv):<br>  <br>      # Make classifier.<br>      classifier = caffe.Classifier(args.model_def, args.pretrained_model,<br> -            image_dims=image_dims, mean=mean,<br> -            input_scale=args.input_scale, raw_scale=args.raw_scale,<br> -            channel_swap=channel_swap)<br> +            image_dims=None, mean=None,<br> +            input_scale=None, raw_scale=None,<br> +            channel_swap=None)<br>  <br>      # Load numpy array (.npy), directory glob (*.jpg), or image file.<br>      args.input_file = os.path.expanduser(args.input_file)<br> @@ -116,11 +116,11 @@ def main(argv):<br>          inputs = np.load(args.input_file)<br>      elif os.path.isdir(args.input_file):<br>          print("Loading folder: %s" % args.input_file)<br> -        inputs =[caffe.io.load_image(im_f)<br> +        inputs =[caffe.io.load_image(im_f, False)<br>                   for im_f in glob.glob(args.input_file + '/*.' + args.ext)]<br>      else:<br>          print("Loading file: %s" % args.input_file)<br> -        inputs = [caffe.io.load_image(args.input_file)]<br> +        inputs = [caffe.io.load_image(args.input_file, False)]<br>  <br>      print("Classifying %d inputs." % len(inputs))<br>  <br> @@ -131,6 +131,7 @@ def main(argv):<br>  <br>      # Save<br>      print("Saving results into %s" % args.output_file)<br> +    print(predictions)<br>      np.save(args.output_file, predictions)</p> 
<p>git diff  python/caffe/classifier.py<br> diff --git a/python/caffe/classifier.py b/python/caffe/classifier.py<br> index 64d804be..65b0d881 100644<br> --- a/python/caffe/classifier.py<br> +++ b/python/caffe/classifier.py<br> @@ -69,18 +69,18 @@ class Classifier(caffe.Net):<br>          for ix, in_ in enumerate(inputs):<br>              input_[ix] = caffe.io.resize_image(in_, self.image_dims)<br>  <br> -        if oversample:<br> -            # Generate center, corner, and mirrored crops.<br> -            input_ = caffe.io.oversample(input_, self.crop_dims)<br> -        else:<br> -            # Take center crop.<br> -            center = np.array(self.image_dims) / 2.0<br> -            crop = np.tile(center, (1, 2))[0] + np.concatenate([<br> -                -self.crop_dims / 2.0,<br> -                self.crop_dims / 2.0<br> -            ])<br> -            crop = crop.astype(int)<br> -            input_ = input_[:, crop[0]:crop[2], crop[1]:crop[3], :]<br> +        #if oversample:<br> +        #    # Generate center, corner, and mirrored crops.<br> +        #    input_ = caffe.io.oversample(input_, self.crop_dims)<br> +        #else:<br> +        #    # Take center crop.<br> +        #    center = np.array(self.image_dims) / 2.0<br> +        #    crop = np.tile(center, (1, 2))[0] + np.concatenate([<br> +        #        -self.crop_dims / 2.0,<br> +        #        self.crop_dims / 2.0<br> +        #    ])<br> +        #    crop = crop.astype(int)<br> +        #    input_ = input_[:, crop[0]:crop[2], crop[1]:crop[3], :]<br>  <br>          # Classify<br>          caffe_in = np.zeros(np.array(input_.shape)[[0, 3, 1, 2]],<br> @@ -91,8 +91,8 @@ class Classifier(caffe.Net):<br>          predictions = out[self.outputs[0]]<br>  <br>          # For oversampling, average predictions across crops.<br> -        if oversample:<br> -            predictions = predictions.reshape((len(predictions) // 10, 10, -1))<br> -            predictions = predictions.mean(1)<br> +        #if oversample:<br> +        #    predictions = predictions.reshape((len(predictions) // 10, 10, -1))<br> +        #    predictions = predictions.mean(1)<br>  <br>          return predictions<br> ```</p> 
<p>最后，真正到运行命令的时候了：</p> 
<p>```<br> 使用命令计算图片：<br> python python/classify.py    --model_def examples/mnist/lenet.prototxt   --pretrained_model examples/mnist/lenet_iter_10000.caffemodel   --center_only      --images_dim 28,28 /home/user/Desktop/2.jpg  FOO<br> ```</p> 
<p>更改上在py程序后，会输出以下内容 ：</p> 
<p>```<br> Saving results into FOO<br> [[2.63039285e-10 1.69570372e-10 1.00000000e+00 3.37297190e-10<br>   1.04435086e-16 6.86246951e-15 1.50223258e-14 4.68932055e-12<br>   6.54263449e-11 1.28875165e-14]]</p> 
<p>```</p> 
<p>由于输入的是2.jpg，所以第2个位置（从0开始）的概率最大，几乎是1.可以分别手写0到9图片，进行测试。</p> 
<p>我分别在vm(i53230), j1900（真机）, i737**m(真机)进行测试，cpu运行过，识别率还可以，速度感觉都比较慢在1s以上吧。</p> 
<p>[首页](http://yangkuncn.cn/index.html)</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1e01d20f030eea0eb1d4da636974dbf3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">浅谈接到一个别人做一半的项目如何去接手。</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fdf3d6526ecb0a0ff0d4633ab4167447/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">cv2.waitKey的入门级理解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>