<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>深度学习自学记录（2）——Keras迁移学习（升级版）&#43;模型融合实现详解 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="深度学习自学记录（2）——Keras迁移学习（升级版）&#43;模型融合实现详解" />
<meta property="og:description" content="最近时间充裕在学习深度学习，用博客记录一下自己的理解，毕竟好记性不如烂笔头。如果有错误的地方，希望大家指正，一起进步。如果这篇博客对你有帮助，点赞支持一下，码字不易。。。。。
迁移学习是深度学习中常用的一个手段，从头开始训练一个模型需要耗费大量的资源，在训练好的权重（预训练）的基础上训练自己的模型是迁移学习的重要思想。Keras 的应用模块（keras.applications）提供了带有预训练权值的深度学习模型，这些模型可以用来进行预测、特征提取和微调（fine-tuning）。关于keras.applications的详细应用可以参考博客，详细介绍了keras.applications的用法和一些具体的例子。
Keras迁移学习（升级版）实现详解 1、迁移学习用于图像分类（基础版）2、迁移学习高级实现（升级版）2.1 迁移部分模型2.2 实现模型融合（多输入单输出，单输入单输出） 3、总结 1、迁移学习用于图像分类（基础版） 迁移学习通俗来讲就是把预训练权重当作模型的初始化权重，使得模型站在巨人的肩膀上训练。
我们通过一个例子来了解Keras中迁移学习用于图像分类的基础版实现，在预训练模型InceptionV3上微调训练出自己的模型。
首先来介绍一下调用keras.applications中InceptionV3模型时各参数的意义：
keras.applications.inception_v3.InceptionV3(include_top=False, weights=&#39;imagenet&#39;, input_tensor=None, input_shape=None, pooling=None, classes=1000) 各参数的意义：
include_top：是否保留顶层的全连接网络
weights：None代表随机初始化，即不加载预训练权重。&#39;imagenet’代表加载预训练权重
input_tensor：可填入Keras tensor作为模型的图像输出tensor
input_shape：可选，仅当include_top=False有效，应为长为3的tuple，指明输入图片的shape，图片的宽高必须大于197，如(200,200,3)
pooling：当include_top=False时，该参数指定了池化方式。None代表不池化，最后一个卷积层的输出为4D张量。‘avg’代表全局平均池化，‘max’代表全局最大值池化。
classes：可选，图片分类的类别数，仅当include_top=True并且不加载预训练权重时可用。
返回值：Keras 模型对象
更多不同模型加载时的参数意义可参考Keras中文文档
迁移学习实现代码如下，在代码中详细介绍了每一步的实现
#首先导入相关的包，导入applications模块中的InceptionV3预训练模型 from keras.applications.inception_v3 import InceptionV3 from keras.preprocessing import image from keras.models import Model from keras.layers import Dense, GlobalAveragePooling2D from keras import backend as K # # 第二步：构建完整模型 #include_top这个参数可以控制的是，到底要不要最后的这些全连接层。构建不带分类器的预训练模型 base_model = InceptionV3(weights=&#39;imagenet&#39;, include_top=False) x = base_model.output x = GlobalAveragePooling2D()(x)# 添加全局平均池化层 x = Dense(1024, activation=&#39;relu&#39;)(x)# 添加一个全连接层 predictions = Dense(200, activation=&#39;softmax&#39;)(x)# 自定义自己的分类器，这是一个200分类的分类器 model = Model(inputs=base_model." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/dcb8fe4a4ec63eba3ae6537f7e421d79/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-12T20:19:08+08:00" />
<meta property="article:modified_time" content="2020-04-12T20:19:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深度学习自学记录（2）——Keras迁移学习（升级版）&#43;模型融合实现详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>最近时间充裕在学习深度学习，用博客记录一下自己的理解，毕竟好记性不如烂笔头。如果有错误的地方，希望大家指正，一起进步。如果这篇博客对你有帮助，点赞支持一下，码字不易。。。。。<br> 迁移学习是深度学习中常用的一个手段，从头开始训练一个模型需要耗费大量的资源，在训练好的权重（预训练）的基础上训练自己的模型是迁移学习的重要思想。Keras 的应用模块（keras.applications）提供了带有预训练权值的深度学习模型，这些模型可以用来进行预测、特征提取和微调（fine-tuning）。关于keras.applications的详细应用可以参考<a href="https://www.cnblogs.com/LS1314/p/10380662.html" rel="nofollow">博客</a>，详细介绍了keras.applications的用法和一些具体的例子。</p> 
<p></p> 
<div class="toc"> 
 <h4>Keras迁移学习（升级版）实现详解</h4> 
 <ul><li><a href="#1_4" rel="nofollow">1、迁移学习用于图像分类（基础版）</a></li><li><a href="#2_78" rel="nofollow">2、迁移学习高级实现（升级版）</a></li><li><ul><li><a href="#21__80" rel="nofollow">2.1 迁移部分模型</a></li><li><a href="#22__118" rel="nofollow">2.2 实现模型融合（多输入单输出，单输入单输出）</a></li></ul> 
  </li><li><a href="#3_202" rel="nofollow">3、总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1_4"></a>1、迁移学习用于图像分类（基础版）</h2> 
<p><strong>迁移学习通俗来讲就是把预训练权重当作模型的初始化权重，使得模型站在巨人的肩膀上训练。</strong><br> 我们通过一个例子来了解Keras中迁移学习用于图像分类的基础版实现，在预训练模型InceptionV3上微调训练出自己的模型。<br> 首先来介绍一下调用keras.applications中InceptionV3模型时各参数的意义：</p> 
<pre><code class="prism language-python">keras<span class="token punctuation">.</span>applications<span class="token punctuation">.</span>inception_v3<span class="token punctuation">.</span>InceptionV3<span class="token punctuation">(</span>include_top<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                                            weights<span class="token operator">=</span><span class="token string">'imagenet'</span><span class="token punctuation">,</span>
                                            input_tensor<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                                            input_shape<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                                            pooling<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                                            classes<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>各参数的意义：</strong><br> <strong>include_top</strong>：是否保留顶层的全连接网络<br> <strong>weights</strong>：None代表随机初始化，即不加载预训练权重。'imagenet’代表加载预训练权重<br> <strong>input_tensor</strong>：可填入Keras tensor作为模型的图像输出tensor<br> <strong>input_shape</strong>：可选，仅当include_top=False有效，应为长为3的tuple，指明输入图片的shape，图片的宽高必须大于197，如(200,200,3)<br> <strong>pooling</strong>：当include_top=False时，该参数指定了池化方式。None代表不池化，最后一个卷积层的输出为4D张量。‘avg’代表全局平均池化，‘max’代表全局最大值池化。<br> <strong>classes</strong>：可选，图片分类的类别数，仅当include_top=True并且不加载预训练权重时可用。<br> <strong>返回值</strong>：Keras 模型对象<br> <strong>更多不同模型加载时的参数意义可参考<a href="https://keras.io/zh/applications/" rel="nofollow">Keras中文文档</a></strong><br> 迁移学习实现代码如下，在代码中详细介绍了每一步的实现</p> 
<pre><code class="prism language-python"><span class="token comment">#首先导入相关的包，导入applications模块中的InceptionV3预训练模型</span>
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>applications<span class="token punctuation">.</span>inception_v3 <span class="token keyword">import</span> InceptionV3
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> image
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> Model
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Dense<span class="token punctuation">,</span> GlobalAveragePooling2D
<span class="token keyword">from</span> keras <span class="token keyword">import</span> backend <span class="token keyword">as</span> K
<span class="token comment">#</span>
<span class="token comment"># 第二步：构建完整模型</span>
<span class="token comment">#include_top这个参数可以控制的是，到底要不要最后的这些全连接层。构建不带分类器的预训练模型</span>
base_model <span class="token operator">=</span> InceptionV3<span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token string">'imagenet'</span><span class="token punctuation">,</span> include_top<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> 

x <span class="token operator">=</span> base_model<span class="token punctuation">.</span>output
x <span class="token operator">=</span> GlobalAveragePooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token comment"># 添加全局平均池化层</span>
x <span class="token operator">=</span> Dense<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token comment"># 添加一个全连接层</span>
predictions <span class="token operator">=</span> Dense<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'softmax'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token comment"># 自定义自己的分类器，这是一个200分类的分类器</span>
model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>base_model<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">,</span> outputs<span class="token operator">=</span>predictions<span class="token punctuation">)</span><span class="token comment"># 构建我们需要训练的完整模型</span>

<span class="token comment">#第三步：在构建好的完整模型上用预训练权重开始训练，我们对模型进行两个训练</span>

<span class="token comment"># 第一次训练：我们只训练随机初始化的层</span>
<span class="token comment"># 锁住所有 InceptionV3 的卷积层</span>
<span class="token keyword">for</span> layer <span class="token keyword">in</span> base_model<span class="token punctuation">.</span>layers<span class="token punctuation">:</span>
    layer<span class="token punctuation">.</span>trainable <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token comment"># 编译模型（一定要在锁层以后操作）</span>
model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>optimizer<span class="token operator">=</span><span class="token string">'rmsprop'</span><span class="token punctuation">,</span> loss<span class="token operator">=</span><span class="token string">'categorical_crossentropy'</span><span class="token punctuation">)</span>
<span class="token comment"># 在新的数据集上训练几代</span>
model<span class="token punctuation">.</span>fit_generator<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>

<span class="token comment">#第二次训练：开始微调Inception V3的卷积层，我们会锁住 Inception V3 中底下的几层，然后训练其余的顶层。</span>

<span class="token comment"># 让我们看看每一层的名字和层号，看看我们应该锁多少层呢：</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> layer <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>base_model<span class="token punctuation">.</span>layers<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> layer<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token comment"># 我们选择训练最上面的两个 Inception block。也就是说锁住前面249层，然后放开之后的层。</span>
<span class="token keyword">for</span> layer <span class="token keyword">in</span> model<span class="token punctuation">.</span>layers<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">249</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
   layer<span class="token punctuation">.</span>trainable <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token keyword">for</span> layer <span class="token keyword">in</span> model<span class="token punctuation">.</span>layers<span class="token punctuation">[</span><span class="token number">249</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
   layer<span class="token punctuation">.</span>trainable <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 我们需要重新编译模型，才能使上面的修改生效</span>
<span class="token comment"># 让我们设置一个很低的学习率，使用 SGD 来微调</span>
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>optimizers <span class="token keyword">import</span> SGD
model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>optimizer<span class="token operator">=</span>SGD<span class="token punctuation">(</span>lr<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loss<span class="token operator">=</span><span class="token string">'categorical_crossentropy'</span><span class="token punctuation">)</span>

<span class="token comment"># 我们继续训练模型，这次我们训练最后两个 Inception block</span>
<span class="token comment"># 和两个全连接层</span>
model<span class="token punctuation">.</span>fit_generator<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre> 
<p>至此，就可以实现在InceptionV3预训练权重上训练一个符合自己数据特征的200分类的分类模型。</p> 
<h2><a id="2_78"></a>2、迁移学习高级实现（升级版）</h2> 
<p>我们已经实现了迁移学习，将整个InceptionV3的网络用于特征提取网络，但有时根据任务的需要，我们不需要将整个网络用特征提取，只需要迁移部分模型。有的时候还需要进行不同模型的融合。</p> 
<h3><a id="21__80"></a>2.1 迁移部分模型</h3> 
<p>我们已经实现了迁移学习，将整个InceptionV3的网络用于特征提取网络，但有时根据任务的需要，我们不需要将整个网络用特征提取，从网络的任意中间层中抽取特征用于迁移学习；这时候就只需要迁移部分模型。<br> <strong>首先，我们要先了解如何获得指定层的输出</strong>。有两种方法可以获得指定层的输出<br> 第一种：自定义用于输出中间层的model</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> Model

base_model <span class="token operator">=</span> InceptionV3<span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token string">'imagenet'</span><span class="token punctuation">,</span> include_top<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> 
layer_name <span class="token operator">=</span> <span class="token string">'my_layer'</span> <span class="token comment"># 给定待输出的层的名字</span>
<span class="token comment">#自定义用于输出中间层的model</span>
model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>base_model<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">,</span> outputs<span class="token operator">=</span>base_model<span class="token punctuation">.</span>get_layer<span class="token punctuation">(</span>layer_name<span class="token punctuation">)</span><span class="token punctuation">.</span>output<span class="token punctuation">)</span>
<span class="token comment">#获得指定层的输出</span>
layer_name_features <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span>
</code></pre> 
<p>第二中：通过定义Keras函数实现，用于输出指定层的输出</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> keras <span class="token keyword">import</span> backend <span class="token keyword">as</span> K
<span class="token comment"># with a Sequential model</span>
get_3rd_layer_output <span class="token operator">=</span> K<span class="token punctuation">.</span>function<span class="token punctuation">(</span><span class="token punctuation">[</span>model<span class="token punctuation">.</span>layers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  <span class="token punctuation">[</span>model<span class="token punctuation">.</span>layers<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>output<span class="token punctuation">]</span><span class="token punctuation">)</span>
layer_output <span class="token operator">=</span> get_3rd_layer_output<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre> 
<p>了解了如何获得指定层输出，下面看迁移部分模型用来训练的代码：与基础版相比只更改了第二步的代码。</p> 
<pre><code class="prism language-python"><span class="token comment"># 第二步：构建完整模型</span>
<span class="token comment">#include_top这个参数可以控制的是，到底要不要最后的这些全连接层。构建不带分类器的预训练模型</span>
Inp <span class="token operator">=</span> Input<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#定义一个输入层，输入图片尺寸为224x224</span>
base_model <span class="token operator">=</span> InceptionV3<span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token string">'imagenet'</span><span class="token punctuation">,</span> include_top<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> 
intermediate_layer_model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>base_model<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">,</span>outputs<span class="token operator">=</span>base_model<span class="token punctuation">.</span>get_layer<span class="token punctuation">(</span><span class="token string">'Layer_Name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>output<span class="token punctuation">)</span>

x <span class="token operator">=</span> intermediate_layer_model<span class="token punctuation">(</span>Inp<span class="token punctuation">)</span>
x <span class="token operator">=</span> GlobalAveragePooling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token comment"># 添加全局平均池化层</span>
x <span class="token operator">=</span> Dense<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token comment"># 添加一个全连接层</span>
predictions <span class="token operator">=</span> Dense<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'softmax'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token comment"># 自定义自己的分类器，这是一个200分类的分类器</span>
model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>base_model<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">,</span> outputs<span class="token operator">=</span>predictions<span class="token punctuation">)</span><span class="token comment"># 构建我们需要训练的完整模型</span>
</code></pre> 
<p>Layer_Name可以根据自己的需要指定任意中间层，将代码与基础版的第二步换一下，就可以实现模型部分的迁移训练，灵活运用预训练模型。</p> 
<h3><a id="22__118"></a>2.2 实现模型融合（多输入单输出，单输入单输出）</h3> 
<p>不同的模型对同一张图片提取到的特征是不同的，在单独一个模型不能满足任务需求时，不妨试试模型融合，因为迁移训练不会增加太多的训练量，所以多个模型融合的训练量也在可以接受的范围内。<br> 这里一共介绍3中模型融合方式，如下图所示。</p> 
<div class="mermaid"> 
 <svg xmlns="http://www.w3.org/2000/svg" id="mermaid-svg-jqJMQBK1R9UIu546" height="86" width="604.296875" viewbox="0 0 624.296875 106"> 
  <g> 
   <g class="output"> 
    <g class="clusters"></g> 
    <g class="edgePaths"> 
     <g class="edgePath" style="opacity: 1;"> 
      <path class="path" d="M84.484375,43L109.484375,43L134.484375,43" marker-end="url(#arrowhead2942)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead2942" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath" style="opacity: 1;"> 
      <path class="path" d="M275.390625,43L300.390625,43L325.390625,43" marker-end="url(#arrowhead2943)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead2943" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath" style="opacity: 1;"> 
      <path class="path" d="M466.296875,43L491.296875,43L516.296875,43" marker-end="url(#arrowhead2944)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead2944" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
    </g> 
    <g class="edgeLabels"> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="nodes"> 
     <g class="node" id="A" transform="translate(52.2421875,43)" style="opacity: 1;"> 
      <rect rx="0" ry="0" x="-32.2421875" y="-23" width="64.484375" height="46"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-22.2421875,-13)"> 
        <foreignobject width="44.484375" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           Input1 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node" id="B" transform="translate(204.9375,43)" style="opacity: 1;"> 
      <rect rx="0" ry="0" x="-70.453125" y="-23" width="140.90625" height="46"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-60.453125,-13)"> 
        <foreignobject width="120.90625" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           模型1特征提取器 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node" id="C" transform="translate(395.84375,43)" style="opacity: 1;"> 
      <rect rx="0" ry="0" x="-70.453125" y="-23" width="140.90625" height="46"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-60.453125,-13)"> 
        <foreignobject width="120.90625" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           模型2特征提取器 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node" id="D" transform="translate(550.296875,43)" style="opacity: 1;"> 
      <rect rx="0" ry="0" x="-34" y="-23" width="68" height="46"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-24,-13)"> 
        <foreignobject width="48" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           分类器 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
    </g> 
   </g> 
  </g> 
 </svg> 
</div> 
<p><strong>第一种</strong>融合方式的实现和2.1迁移部分模型类似，将平均池化层和全连接层看作模型2特征提取器，最后的一层（Softmax层）看作分类器就可以实现了。</p> 
<div class="mermaid"> 
 <svg xmlns="http://www.w3.org/2000/svg" id="mermaid-svg-0h5P5YZQX6vpAEiV" height="182" width="500.5" viewbox="0 0 520.5 202"> 
  <g> 
   <g class="output"> 
    <g class="clusters"></g> 
    <g class="edgePaths"> 
     <g class="edgePath" style="opacity: 1;"> 
      <path class="path" d="M73.09537760416667,68L100.59375,43L125.59375,43" marker-end="url(#arrowhead2963)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead2963" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath" style="opacity: 1;"> 
      <path class="path" d="M73.09537760416667,114L100.59375,139L125.59375,139" marker-end="url(#arrowhead2964)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead2964" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath" style="opacity: 1;"> 
      <path class="path" d="M266.5,43L291.5,43L323.2365440327094,74.7365440327094" marker-end="url(#arrowhead2965)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead2965" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath" style="opacity: 1;"> 
      <path class="path" d="M266.5,139L291.5,139L323.2365440327094,107.2634559672906" marker-end="url(#arrowhead2966)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead2966" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath" style="opacity: 1;"> 
      <path class="path" d="M362.5,91L387.5,91L412.5,91" marker-end="url(#arrowhead2967)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead2967" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
    </g> 
    <g class="edgeLabels"> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="nodes"> 
     <g class="node" id="A" transform="translate(47.796875,91)" style="opacity: 1;"> 
      <rect rx="0" ry="0" x="-27.796875" y="-23" width="55.59375" height="46"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-17.796875,-13)"> 
        <foreignobject width="35.59375" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           Input 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node" id="B" transform="translate(196.046875,43)" style="opacity: 1;"> 
      <rect rx="0" ry="0" x="-70.453125" y="-23" width="140.90625" height="46"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-60.453125,-13)"> 
        <foreignobject width="120.90625" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           模型1特征提取器 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node" id="C" transform="translate(196.046875,139)" style="opacity: 1;"> 
      <rect rx="5" ry="5" x="-70.453125" y="-23" width="140.90625" height="46"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-60.453125,-13)"> 
        <foreignobject width="120.90625" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           模型2特征提取器 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node" id="E" transform="translate(339.5,91)" style="opacity: 1;"> 
      <circle x="-14" y="-23" r="23"></circle> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-4,-13)"> 
        <foreignobject width="8" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           x 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node" id="D" transform="translate(446.5,91)" style="opacity: 1;"> 
      <rect rx="0" ry="0" x="-34" y="-23" width="68" height="46"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-24,-13)"> 
        <foreignobject width="48" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           分类器 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
    </g> 
   </g> 
  </g> 
 </svg> 
</div> 
<p><strong>第二种</strong>为单输入单输出的模型融合，我们依然使用Keras的applications模块来实现，这里我们将VGG16和Resnet50两个模型的特征提取网络融合。模型1为Resnet50并加载预训练权重。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">model1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    base_model1 <span class="token operator">=</span> choice_model<span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token string">'imagenet'</span><span class="token punctuation">,</span>
                              include_top<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                              input_shape<span class="token operator">=</span><span class="token punctuation">(</span>norm_size<span class="token punctuation">,</span> norm_size<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>base_model1<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">,</span> outputs<span class="token operator">=</span>base_model1<span class="token punctuation">.</span>get_layer<span class="token punctuation">(</span><span class="token string">'activation_43'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>output<span class="token punctuation">)</span>
    <span class="token keyword">return</span> model
</code></pre> 
<p>模型2为VGG16并加载预训练权重。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">model2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    base_model2 <span class="token operator">=</span> VGG16<span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token string">'imagenet'</span><span class="token punctuation">,</span>
                              include_top<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                              input_shape<span class="token operator">=</span><span class="token punctuation">(</span>norm_size<span class="token punctuation">,</span> norm_size<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>base_model2<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">,</span> outputs<span class="token operator">=</span>base_model2<span class="token punctuation">.</span>get_layer<span class="token punctuation">(</span><span class="token string">'block5_pool'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>output<span class="token punctuation">)</span>
    <span class="token keyword">return</span> model
</code></pre> 
<p>将模型1和模型2提取到的特征进行融合，输入为224x224大小的图片，得到的model即为融合后的模型。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">merge_model</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">:</span>
    inp <span class="token operator">=</span> Input<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    model_2 <span class="token operator">=</span> model2<span class="token punctuation">(</span><span class="token punctuation">)</span>
    model_1 <span class="token operator">=</span> model1<span class="token punctuation">(</span><span class="token punctuation">)</span>

    r1 <span class="token operator">=</span> model_1<span class="token punctuation">(</span>inp<span class="token punctuation">)</span>
    r2 <span class="token operator">=</span> model_2<span class="token punctuation">(</span>inp<span class="token punctuation">)</span>

    x <span class="token operator">=</span> concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>r1<span class="token punctuation">,</span>r2<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>inp<span class="token punctuation">,</span> outputs<span class="token operator">=</span>x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> model
</code></pre> 
<p>融合后的特征提取网络结构如图：<br> <img src="https://images2.imgbox.com/94/f3/LrGupytV_o.png" alt="merge_model"></p> 
<div class="mermaid"> 
 <svg xmlns="http://www.w3.org/2000/svg" id="mermaid-svg-KYfuKM2N4BQRELgZ" height="182" width="509.390625" viewbox="0 0 529.390625 202"> 
  <g> 
   <g class="output"> 
    <g class="clusters"></g> 
    <g class="edgePaths"> 
     <g class="edgePath" style="opacity: 1;"> 
      <path class="path" d="M84.484375,43L109.484375,43L134.484375,43" marker-end="url(#arrowhead2986)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead2986" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath" style="opacity: 1;"> 
      <path class="path" d="M275.390625,43L300.390625,43L332.1271690327094,74.7365440327094" marker-end="url(#arrowhead2987)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead2987" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath" style="opacity: 1;"> 
      <path class="path" d="M84.484375,139L109.484375,139L134.484375,139" marker-end="url(#arrowhead2988)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead2988" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath" style="opacity: 1;"> 
      <path class="path" d="M275.390625,139L300.390625,139L332.1271690327094,107.2634559672906" marker-end="url(#arrowhead2989)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead2989" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
     <g class="edgePath" style="opacity: 1;"> 
      <path class="path" d="M371.390625,91L396.390625,91L421.390625,91" marker-end="url(#arrowhead2990)" style="fill:none"></path> 
      <defs> 
       <marker id="arrowhead2990" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
        <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path> 
       </marker> 
      </defs> 
     </g> 
    </g> 
    <g class="edgeLabels"> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
     <g class="edgeLabel" transform="" style="opacity: 1;"> 
      <g transform="translate(0,0)" class="label"> 
       <foreignobject width="0" height="0"> 
        <div style="display: inline-block; white-space: nowrap;"> 
         <span class="edgeLabel"></span> 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="nodes"> 
     <g class="node" id="A" transform="translate(52.2421875,43)" style="opacity: 1;"> 
      <rect rx="0" ry="0" x="-32.2421875" y="-23" width="64.484375" height="46"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-22.2421875,-13)"> 
        <foreignobject width="44.484375" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           Input1 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node" id="B" transform="translate(204.9375,43)" style="opacity: 1;"> 
      <rect rx="0" ry="0" x="-70.453125" y="-23" width="140.90625" height="46"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-60.453125,-13)"> 
        <foreignobject width="120.90625" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           模型1特征提取器 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node" id="F" transform="translate(348.390625,91)" style="opacity: 1;"> 
      <circle x="-14" y="-23" r="23"></circle> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-4,-13)"> 
        <foreignobject width="8" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           x 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node" id="E" transform="translate(52.2421875,139)" style="opacity: 1;"> 
      <rect rx="0" ry="0" x="-32.2421875" y="-23" width="64.484375" height="46"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-22.2421875,-13)"> 
        <foreignobject width="44.484375" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           Input2 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node" id="C" transform="translate(204.9375,139)" style="opacity: 1;"> 
      <rect rx="5" ry="5" x="-70.453125" y="-23" width="140.90625" height="46"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-60.453125,-13)"> 
        <foreignobject width="120.90625" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           模型2特征提取器 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
     <g class="node" id="D" transform="translate(455.390625,91)" style="opacity: 1;"> 
      <rect rx="0" ry="0" x="-34" y="-23" width="68" height="46"></rect> 
      <g class="label" transform="translate(0,0)"> 
       <g transform="translate(-24,-13)"> 
        <foreignobject width="48" height="26"> 
         <div style="display: inline-block; white-space: nowrap;">
           分类器 
         </div> 
        </foreignobject> 
       </g> 
      </g> 
     </g> 
    </g> 
   </g> 
  </g> 
 </svg> 
</div> 
<p><strong>第三种</strong>为多输入单输出的模型融合，首先也是定义两个加载预训练权重的模型，不同的是在merge_model( )函数中定义了两个输入</p> 
<pre><code class="prism language-python"><span class="token comment">##多输入单输出</span>
<span class="token keyword">def</span> <span class="token function">merge_model_2</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">:</span>
    inp1 <span class="token operator">=</span> Input<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    inp2 <span class="token operator">=</span> Input<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    model_2 <span class="token operator">=</span> model2<span class="token punctuation">(</span><span class="token punctuation">)</span>
    model_1 <span class="token operator">=</span> model1<span class="token punctuation">(</span><span class="token punctuation">)</span>

    r1 <span class="token operator">=</span> model_1<span class="token punctuation">(</span>inp1<span class="token punctuation">)</span>
    r2 <span class="token operator">=</span> model_2<span class="token punctuation">(</span>inp2<span class="token punctuation">)</span>

    x <span class="token operator">=</span> concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>r1<span class="token punctuation">,</span>r2<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span><span class="token punctuation">[</span>inp1<span class="token punctuation">,</span>inp2<span class="token punctuation">]</span><span class="token punctuation">,</span> outputs<span class="token operator">=</span>x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> model
</code></pre> 
<p>融合后的特征提取网络结构如图：<br> <img src="https://images2.imgbox.com/37/fe/HGu4Ye60_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3_202"></a>3、总结</h2> 
<p><strong>（1）Keras内置的applications模块可以实现迁移学习，该模块的详细介绍见<a href="https://www.cnblogs.com/LS1314/p/10380662.html" rel="nofollow">博客</a><br> （2）Keras有两种方法可以输出指定层的特征图，<br> 第一种：自定义用于输出中间层的model<br> 第二种：通过定义Keras函数实现，用于输出指定层的输出（我没用过。。。）<br> （3）Keras利用applications模块中自带的权重可以实现模型融合。</strong><br> 如果这篇博客对你有帮助，点赞支持一下，码字不易。。。。。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2164af5f85b4e272bcc7bb8c7dcf5b13/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决servlet404报错</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8f037c9b1f1500cb3b4fa6a966feb5e4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Tushare Pro的安装使用——“抱歉，您没有访问该接口的权限，权限的具体详情访问：https://tushare.pro/document/1?doc_id=108”问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>