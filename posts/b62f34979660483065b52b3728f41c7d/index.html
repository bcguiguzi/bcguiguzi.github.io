<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ArcGIS Engine基础（29）之加载arcgis server切片地图服务 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ArcGIS Engine基础（29）之加载arcgis server切片地图服务" />
<meta property="og:description" content="第一种方法(ArcGIS 地图服务）：
直接调用arcgis server rest服务地址。
以IMapServerRESTLayer接口直接调用arcgis server rest服务，rest形式的切片服务一样可以加载。但如果是通过矢量范围面先进行切片后发布成地图服务，然后把影像切片缓存拷贝到该矢量地图服务的缓存下时，使用该方式无法读取到切片缓存图层，只能获取到矢量范围面图层。
IMapServerRESTLayer pRestLayer = new MapServerRESTLayerClass(); pRestLayer.Connect(&#34;http://localhost:6080/arcgis/rest/services/JX2021Y04IMG/MapServer&#34;); ILayer pLayer = pRestLayer as ILayer; 第二种方法(wmts服务）：
以OGC的wmts标准方式进行加载。
格式url示例：http://localhost:6080/arcgis/rest/services/JX2021Y02IMG/MapServer/WMTS/1.0.0/WMTSCapabilities.xml
private ILayer OpenWMTS(string pURL) { ILayer layer = null; ESRI.ArcGIS.esriSystem.IPropertySet pPropertyset = new ESRI.ArcGIS.esriSystem.PropertySetClass(); pPropertyset.SetProperty(&#34;url&#34;, pURL); IWMTSConnectionFactory pWMTSFac = new WMTSConnectionFactoryClass(); IWMTSConnection pWMTS = pWMTSFac.Open(pPropertyset, 0, null); IWMTSConnectionName pWmtsConnectionName = pWMTS.FullName as IWMTSConnectionName; //下面的也可以 //IWMSConnectionName pWmsConnectionName = new WMSConnectionNameClass(); //pWmsConnectionName.ConnectionProperties = pPropertyset; ILayerFactory pLayerFactory = new WMTSLayerFactoryClass(); if (pLayerFactory." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/b62f34979660483065b52b3728f41c7d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-27T10:49:02+08:00" />
<meta property="article:modified_time" content="2022-11-27T10:49:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ArcGIS Engine基础（29）之加载arcgis server切片地图服务</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>第一种方法(ArcGIS 地图服务）：</strong></p> 
<p>        直接调用arcgis server rest服务地址。</p> 
<p>        以IMapServerRESTLayer接口直接调用arcgis server rest服务，rest形式的切片服务一样可以加载。但如果是通过矢量范围面先进行切片后发布成地图服务，然后把影像切片缓存拷贝到该矢量地图服务的缓存下时，使用该方式无法读取到切片缓存图层，只能获取到矢量范围面图层。</p> 
<p><img alt="" height="79" src="https://images2.imgbox.com/75/5f/VbkZOUgz_o.png" width="258"></p> 
<p></p> 
<pre><code class="language-cs">IMapServerRESTLayer pRestLayer = new MapServerRESTLayerClass();
pRestLayer.Connect("http://localhost:6080/arcgis/rest/services/JX2021Y04IMG/MapServer");
ILayer pLayer = pRestLayer as ILayer;</code></pre> 
<p><strong>第二种方法(wmts服务）：</strong></p> 
<p>        以OGC的wmts标准方式进行加载。</p> 
<p>格式url示例：<a href="http://arcgis.jxpskj.com:6080/arcgis/rest/services/JX2021Y02IMG/MapServer/WMTS/1.0.0/WMTSCapabilities.xml" rel="nofollow" title="http://localhost:6080/arcgis/rest/services/JX2021Y02IMG/MapServer/WMTS/1.0.0/WMTSCapabilities.xml">http://localhost:6080/arcgis/rest/services/JX2021Y02IMG/MapServer/WMTS/1.0.0/WMTSCapabilities.xml</a></p> 
<pre><code class="language-cs">        private ILayer OpenWMTS(string pURL)
        {
            ILayer layer = null;
            ESRI.ArcGIS.esriSystem.IPropertySet pPropertyset = new ESRI.ArcGIS.esriSystem.PropertySetClass();
            pPropertyset.SetProperty("url", pURL);
            IWMTSConnectionFactory pWMTSFac = new WMTSConnectionFactoryClass();
            IWMTSConnection pWMTS = pWMTSFac.Open(pPropertyset, 0, null);
            IWMTSConnectionName pWmtsConnectionName = pWMTS.FullName as IWMTSConnectionName;

            //下面的也可以
            //IWMSConnectionName pWmsConnectionName = new WMSConnectionNameClass();
            //pWmsConnectionName.ConnectionProperties = pPropertyset;
            ILayerFactory pLayerFactory = new WMTSLayerFactoryClass();
            if (pLayerFactory.get_CanCreate(pWmtsConnectionName))
            {
                IEnumLayer pEnumLayer = pLayerFactory.Create(pWmtsConnectionName);
                pEnumLayer.Reset();
                ILayer pLayer = pEnumLayer.Next();
                while (pLayer != null)
                {
                    layer = pLayer;
                    if (pLayer is IWMTSLayer)
                    {
                        //IWMTSLayer pWmsMapLayer = pLayer as IWMTSLayer;
                        layer = pLayer;
                        break;
                    }
                    pLayer = pEnumLayer.Next();
                }
            }
            return layer;
        }</code></pre> 
<p><strong>第三种方法(ArcGIS 地图服务）：</strong></p> 
<p>        使用IAGSServerConnection连接到server目录，获取所有服务，循环遍历，根据服务名称连接到指定的服务图层。</p> 
<p>serverBaseUrl:http://localhost:6080/arcgis/rest/services</p> 
<p>serviceName:JX2021Y02IMG</p> 
<pre><code class="language-cs">        /// &lt;summary&gt;
        /// 加载地图服务
        /// &lt;/summary&gt;
        /// &lt;param name="serverName"&gt;服务器名称&lt;/param&gt;
        /// &lt;param name="serviceName"&gt;地图服务名称&lt;/param&gt;
        /// &lt;param name="pIsLAN"&gt;是否为局域网&lt;/param&gt;
        /// &lt;returns&gt;返回图层&lt;/returns&gt;
        public ILayer LoadMapservice(string serverBaseUrl, string serviceName,bool pIsLAN=false)
        {
            IMapServer m_mapServer = null;
            IMapServerLayer layer = null;

            ESRI.ArcGIS.esriSystem.IPropertySet propertySet = new ESRI.ArcGIS.esriSystem.PropertySet();
            if (pIsLAN)
            {
                propertySet.SetProperty("machine", serverBaseUrl);
            }
            else
            {
                propertySet.SetProperty("url", serverBaseUrl);
            }
            
           
            IAGSServerConnectionFactory agsServerConnectionFactory = new AGSServerConnectionFactory();
            IAGSServerConnection agsServerConnection = agsServerConnectionFactory.Open(propertySet, 0);

            IAGSEnumServerObjectName agsEnumServerObjectName = agsServerConnection.ServerObjectNames;
            agsEnumServerObjectName.Reset();

            ESRI.ArcGIS.esriSystem.IName serverObjectName;
            IAGSServerObject agsServerObject = null;
            IAGSServerObjectName agsServerObjectName = agsEnumServerObjectName.Next();
            while ((agsServerObjectName != null))
            {
                // Search for the MapServer Server Object
                if (agsServerObjectName.Type.ToUpper() == "MAPSERVER" &amp;&amp; agsServerObjectName.Name == serviceName)
                {
                    serverObjectName = agsServerObjectName as ESRI.ArcGIS.esriSystem.IName;
                    agsServerObject = serverObjectName.Open() as IAGSServerObject;
                    if (agsServerObject as IMapServer != null)
                    {
                        m_mapServer = agsServerObject as IMapServer;
                        break;
                    }
                }
                agsServerObjectName = agsEnumServerObjectName.Next();
            }

            // If we got both of them, exit out
            if (m_mapServer != null)
            {
                layer = new MapServerLayerClass();
                layer.ServerConnect(agsServerObjectName, m_mapServer.DefaultMapName);
            }
            if (layer != null)
            {
                return (layer as ILayer);
            }
            else
            {
                return null;
            }
        }</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b52da5378fc8e834f0f811dcdeef57c6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux——【ftp环境搭建】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f28995172d4275c9f0aa3bb19e2be5b5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">git 进阶系列教程--add</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>