<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>关于C&#43;&#43;智能指针 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="关于C&#43;&#43;智能指针" />
<meta property="og:description" content="普通指针到智能指针的转换 int* iPtr = new int(42); shared_ptr&lt;int&gt; p(iPtr); 智能指针到普通指针的转换 int* pI = p.get(); 注意的地方： 那就是不要将智能指针与普通指针混用。如果项目允许，坚持使用智能指针，避免原生指针。 智能指针与普通指针需要特别特别特别的小心翼翼，比如以下的情况。 1. 普通指针到智能指针的问题 void f(shared_ptr&lt;int&gt; ptr) //增加引用计数 { // do something... } //销毁ptr，减少引用计数 我们有如下的代码： int* iPtr = new int(42); f(shared_ptr&lt;int&gt;(iPtr)); int value = *iPtr; // Error! iPtr指针指向的内容已经被释放 因为在这儿，你将普通指针赋予给了一个临时的智能指针，当调用f函数完毕后，此临时智能指针的生命周期结束，然后减少引用计数，归为0，于是，内存释放！ 而这儿的更改方法是一直使用智能指针： auto p = make_shared&lt;int&gt;(42); // 初始化的引用计数为1 f(p); // 拷贝后增加为2，销毁ptr减少1，然后变为1 int value = *p; //引用计数为1 2. 智能指针到普通指针的问题 auto p = make_shared&lt;int&gt;(42); int* iPtr = p.get(); { shared_ptr&lt;int&gt;(iPtr); } int value = *p; // Error!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/d1bb2917c45df981c856c89eb929f48e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-12-12T10:02:32+08:00" />
<meta property="article:modified_time" content="2015-12-12T10:02:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">关于C&#43;&#43;智能指针</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div> 
 <div class="zm-editable-content clearfix">
   普通指针到智能指针的转换 
 </div> 
 <div class="zm-editable-content clearfix"> 
  <pre><code class="language-cpp">int* iPtr = new int(42);
shared_ptr&lt;int&gt; p(iPtr);</code></pre> 
  <br> 
  <br> 智能指针到普通指针的转换 
 </div> 
 <div class="zm-editable-content clearfix"> 
  <pre><code class="language-cpp">int* pI = p.get();</code></pre> 
  <br> 
  <br> 
  <br> 
  <br> 注意的地方： 
  <strong>那就是不要将智能指针与普通指针混用。如果项目允许，坚持使用智能指针，避免原生指针。</strong> 
  <br> 
  <br> 智能指针与普通指针需要特别特别特别的小心翼翼，比如以下的情况。 
  <br> 1. 普通指针到智能指针的问题 
 </div> 
 <div class="zm-editable-content clearfix"> 
  <pre><code class="language-cpp">void f(shared_ptr&lt;int&gt; ptr) //增加引用计数
{
   // do something...
} //销毁ptr，减少引用计数</code></pre> 
  <br> 
  <br> 
  <br> 我们有如下的代码： 
 </div> 
 <div class="zm-editable-content clearfix"> 
  <pre><code class="language-cpp">int* iPtr = new int(42);
f(shared_ptr&lt;int&gt;(iPtr));
int value = *iPtr; // Error! iPtr指针指向的内容已经被释放</code></pre> 
  <br> 
  <br> 
  <br> 因为在这儿，你将普通指针赋予给了一个临时的智能指针，当调用f函数完毕后，此临时智能指针的生命周期结束，然后减少引用计数，归为0，于是，内存释放！ 
  <br> 
  <br> 而这儿的更改方法是一直使用智能指针： 
 </div> 
 <div class="zm-editable-content clearfix"> 
  <pre><code class="language-cpp">auto p = make_shared&lt;int&gt;(42); // 初始化的引用计数为1
f(p); // 拷贝后增加为2，销毁ptr减少1，然后变为1
int value = *p; //引用计数为1</code></pre> 
  <br> 
  <br> 
  <br> 
  <br> 2. 智能指针到普通指针的问题 
 </div> 
 <div class="zm-editable-content clearfix"> 
  <pre><code class="language-cpp">auto p = make_shared&lt;int&gt;(42);
int* iPtr = p.get();
{
   shared_ptr&lt;int&gt;(iPtr);
}

int value = *p; // Error! 内存已经被释放</code></pre> 
  <br> 
  <br> p与iPtr指向了相同的内存，然而通过get方法后，将内存管理权转移给了普通指针。iPtr传递给里面程序块的临时智能指针后，引用计数为1，随后出了作用域，减少为0，释放内存。 
  <br> 
  <br> 
  <br> 额外的注意点：转换 
  <br> 在C++11中，极力推崇完全替代原生指针。而这里面，原生指针使用到了static_cast，dynamic_cast, const_cast的操作，需要用static_pointer_cast, dynamic_pointer_cast, const_pointer_cast对应操作，而并非使用原来的dynamic_cast等。 
 </div> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5de6cf49b2fb51c52165d2cefd3d04ac/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CMMI-DEV_v1.3</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1fe6282e7c0ccfd334c3c8a18d33979a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">对于汇编代码pushl %ebp      movl %esp,%ebp</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>