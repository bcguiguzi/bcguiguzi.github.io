<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Google Gmail Oauth Client ID 认证指南 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Google Gmail Oauth Client ID 认证指南" />
<meta property="og:description" content="官方文档：https://developers.google.com/workspace/guides/configure-oauth-consent
https://developers.google.com/workspace/guides/create-credentials
参考视频：https://www.youtube.com/watch?v=tGDn3V-mIOM
https://www.youtube.com/watch?v=IZ1ZEjuJF8U
OAuth2 client ID and client secret 新建 project project 控制台：https://console.cloud.google.com/cloud-resource-manager
Enable Gmail Api 点击 Gmail Api 并 Enable
新建 app 控制台：https://console.cloud.google.com/apis/credentials/consent
打开控制台，选择 project：
点击菜单 OAuth consent screen，新建 app
注：User type 只能选择 External，Internal 是给 Google Worksapce 用户使用的，是个收费的产品
step1：
step2：Scopes
这一步暂时不选择，直接 ’保存并继续‘
step3： add test users
step4：创建完成
step5: 发布 app，使 app 状态处于 In production 状态，防止 refresh token 失效
新建 OAuth 2.0 Client 控制台地址：https://console.developers.google.com/apis/credentials
点击 Credentials 菜单
保存并下载 ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/04891152e00bb61d406f2b5f58c42821/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-05T14:19:23+08:00" />
<meta property="article:modified_time" content="2022-09-05T14:19:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Google Gmail Oauth Client ID 认证指南</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>官方文档：https://developers.google.com/workspace/guides/configure-oauth-consent</p> 
<p>https://developers.google.com/workspace/guides/create-credentials</p> 
<p>参考视频：https://www.youtube.com/watch?v=tGDn3V-mIOM</p> 
<p>https://www.youtube.com/watch?v=IZ1ZEjuJF8U</p> 
<h3>OAuth2 client ID and client secret</h3> 
<h4>新建 project</h4> 
<p>project 控制台：https://console.cloud.google.com/cloud-resource-manager</p> 
<p><img alt="" height="281" src="https://images2.imgbox.com/b3/03/BFvFURhZ_o.png" width="567"></p> 
<p> </p> 
<p><img alt="" height="360" src="https://images2.imgbox.com/dc/a2/GGhsnYPS_o.png" width="567"></p> 
<p> </p> 
<p></p> 
<h4>Enable Gmail Api</h4> 
<p><img alt="" height="278" src="https://images2.imgbox.com/6b/69/6YnxUKJg_o.png" width="567"> </p> 
<p> <img alt="" height="169" src="https://images2.imgbox.com/6f/e0/ZqAifAkN_o.png" width="567"></p> 
<p> </p> 
<p></p> 
<p></p> 
<p>点击 Gmail Api 并 Enable</p> 
<p><img alt="" height="272" src="https://images2.imgbox.com/df/79/p0f0WbEQ_o.png" width="567"></p> 
<p> </p> 
<p></p> 
<h4>新建 app</h4> 
<p>控制台：https://console.cloud.google.com/apis/credentials/consent</p> 
<p>打开控制台，选择 project：</p> 
<p><img alt="" height="291" src="https://images2.imgbox.com/39/39/3H8nLfnp_o.png" width="567"> </p> 
<p> </p> 
<p></p> 
<p>点击菜单 OAuth consent screen，新建 app</p> 
<p><img alt="" height="327" src="https://images2.imgbox.com/c8/3d/pBi2KqbF_o.png" width="567"> </p> 
<p> </p> 
<p></p> 
<p><strong>注</strong>：User type 只能选择 External，Internal 是给 <a href="https://workspace.google.com/" rel="nofollow" title="Google Worksapce">Google Worksapce</a> 用户使用的，是个收费的产品</p> 
<p>step1：</p> 
<p><img alt="" height="460" src="https://images2.imgbox.com/b4/4f/lMeEvR2u_o.png" width="567"> </p> 
<p><img alt="" height="317" src="https://images2.imgbox.com/97/18/WBp2gUbS_o.png" width="567"> </p> 
<p> </p> 
<p></p> 
<p></p> 
<p>step2：Scopes</p> 
<p>这一步暂时不选择，直接 ’保存并继续‘</p> 
<p>step3： add test users</p> 
<p><img alt="" height="201" src="https://images2.imgbox.com/85/26/V7AUgCt0_o.png" width="567"> </p> 
<p> </p> 
<p></p> 
<p>step4：创建完成</p> 
<p><img alt="" height="507" src="https://images2.imgbox.com/c2/69/VZwZiHvu_o.png" width="567"> </p> 
<p> </p> 
<p></p> 
<p>step5: 发布 app，使 app 状态处于 In production 状态，防止 refresh token 失效</p> 
<p><img alt="" height="525" src="https://images2.imgbox.com/e8/1d/9IHk9vts_o.png" width="567"> </p> 
<p><img alt="" height="398" src="https://images2.imgbox.com/fc/6b/h0KZ8feb_o.png" width="567"> </p> 
<p><img alt="" height="502" src="https://images2.imgbox.com/bd/b0/XnMhgshX_o.png" width="567"> </p> 
<p> </p> 
<p></p> 
<p></p> 
<p></p> 
<h4>新建 OAuth 2.0 Client</h4> 
<p>控制台地址：https://console.developers.google.com/apis/credentials</p> 
<p>点击 Credentials 菜单</p> 
<p><img alt="" height="316" src="https://images2.imgbox.com/12/1c/WLan0f81_o.png" width="567"> </p> 
<p><img alt="" height="320" src="https://images2.imgbox.com/58/5e/mk0WTqYl_o.png" width="567"> </p> 
<p><img alt="" height="327" src="https://images2.imgbox.com/e3/63/gXiAbV4p_o.png" width="567"> </p> 
<p></p> 
<p></p> 
<p></p> 
<p>保存并下载 .json 文件，可以命名为 credentials.json</p> 
<p><img alt="" height="164" src="https://images2.imgbox.com/80/86/rBZUhOL4_o.png" width="567"> </p> 
<p></p> 
<h3>获取 scope 对应的 code</h3> 
<p>浏览器中请求如下 url</p> 
<ul><li> <p>scope 是需要的权限 https://developers.google.com/gmail/api/auth/scopes</p> </li></ul> 
<ul><li> <p>[your_client_id] 是上一步 credentials.json 中的 client_id 参数</p> </li></ul> 
<pre><code class="language-bash">https://accounts.google.com/o/oauth2/v2/auth?
 scope=https://mail.google.com/&amp;
 access_type=offline&amp;
 redirect_uri=http://localhost&amp;
 response_type=code&amp;
 client_id=[your_client_id]</code></pre> 
<p>请求之后，浏览器地址栏会出现如下链接</p> 
<pre><code class="language-bash"> http://localhost/?code=4/0AX4XfWhkQGEQpDSfSwE2vOUDFpoNBLha_KBVYfngcBxnL0qLXQpEQ&amp;scope=https://mail.google.com/</code></pre> 
<p>code 参数即我们需要的值</p> 
<h3>获取 access_token 和 refresh_token</h3> 
<p>Wsl 执行如下 url，code 来自上一步获取的 code，client_id，client_secret 均来自 credentials.json</p> 
<pre><code class="language-bash"> curl \
--request POST \
--data "code=4/0AX4XfWhkQGEQpDSfSwE2vOUDFpoNBVYfngcBxnL0VU1PlqLXQpEQ&amp;client_id=358916748846-epks869ps.googleusercontent.com&amp;client_secret=GOCSPX-ItJ5x6Bou5bTj&amp;redirect_uri=http://localhost&amp;grant_type=authorization_code" \
https://accounts.google.com/o/oauth2/token</code></pre> 
<p>返回：</p> 
<pre><code class="language-bash">{
  "access_token": "ya29.a0ARrdaM_9OV_3KTHol3hDWZnFtuxkFOCxPKBul8YZbSkjjM1L4rfx-iw35R9o4F_K27xFwwt_BJ2lzcZj5nkPyTTj-xNJ038gr9qS_z1ESQ67SJ",
  "expires_in": 3599,
  "refresh_token": "1//0efEzWtmVh6BvCgYIARAAGA4SNwF-L9IrHZNakmKqCBBpMg--p5S4d9PgG2OzQY_26P6sHYrVc",
  "scope": "https://mail.google.com/",
  "token_type": "Bearer"
}</code></pre> 
<h3>认证参考代码1 (java)</h3> 
<pre><code class="language-java">private Gmail gmailService = null;
private GoogleClientSecrets clientSecrets = null;
private static final String CREDENTIALS_FILE_LOCATION = "configuration/gmail/credentials.json";

@PostConstruct
public void init() throws IOException, GeneralSecurityException {
    log.info("init gmailService start ...");
    clientSecrets = GoogleClientSecrets.load(JsonUtils.JSON_FACTORY,
            new InputStreamReader(GmailUtils.class.getClassLoader().getResourceAsStream(CREDENTIALS_FILE_LOCATION)));
    Credential authorize = new GoogleCredential.Builder().setTransport(GoogleNetHttpTransport.newTrustedTransport())
            .setJsonFactory(JsonUtils.JSON_FACTORY)
            .setClientSecrets(clientSecrets.getDetails().getClientId(),
                    clientSecrets.getDetails().getClientSecret())
            .build().setAccessToken(getAccessToken(gmailConfig.getGmailSettings().getRefreshToken(), gmailConfig.getGmailSettings().getTokenUrl()))
            .setRefreshToken(gmailConfig.getGmailSettings().getRefreshToken());
    final NetHttpTransport HTTP_TRANSPORT = GoogleNetHttpTransport.newTrustedTransport();
    gmailService = new Gmail.Builder(HTTP_TRANSPORT, JsonUtils.JSON_FACTORY, authorize)
            .setApplicationName(gmailConfig.getGmailSettings().getApplicationName()).build();
    log.info("init gmailService completed ...");
}

private String getAccessToken(String refreshToken, String tokenUrl) {
    Map&lt;String, Object&gt; params = new LinkedHashMap&lt;&gt;();
    params.put("grant_type", "refresh_token");
    params.put("client_id", clientSecrets.getDetails().getClientId());
    params.put("client_secret", clientSecrets.getDetails().getClientSecret());
    params.put("refresh_token", refreshToken);

    RequestBody authRequestBody = RequestBody.create(MediaType.parse("application/json;charset=UTF-8"), JsonUtils.toString(params));
    Request request = new Request.Builder()
            .url(tokenUrl)
            .method("POST", authRequestBody)
            .build();
    String response = netUtils.executeRequest(request);
    JSONObject json = new JSONObject(response);
    return json.getString("access_token");
}</code></pre> 
<h3> 认证参考代码2 (java)</h3> 
<pre><code class="language-java">public static Adsense createAdsense(AdsenseAccount account) throws IOException {
        HttpTransport HTTP_TRANSPORT = new NetHttpTransport();

        GoogleRefreshTokenRequest request = new GoogleRefreshTokenRequest(HTTP_TRANSPORT, JsonUtils.JSON_FACTORY,
                account.getRefreshToken(), account.getClientId(), account.getClientSecret())
                .setScopes(Collections.singleton(AdsenseScopes.ADSENSE_READONLY));

        Credential credential = new Credential.Builder(BearerToken.authorizationHeaderAccessMethod())
                .setTransport(HTTP_TRANSPORT)
                .setJsonFactory(JsonUtils.JSON_FACTORY)
                .setTokenServerUrl(new GenericUrl(GoogleOAuthConstants.TOKEN_SERVER_URL))
                .build()
                .setFromTokenResponse(request.execute());

        return new Adsense.Builder(HTTP_TRANSPORT, JsonUtils.JSON_FACTORY, setHttpTimeout(credential)).setApplicationName("ad-data-scraper").build();
    }</code></pre> 
<pre></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6d8f8b97f5a8f92e0b713186a734de79/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【微信小程序】自定义组件(一)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c5e71f49eaad642b0bfa0ea285acffa9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Google Analytics Service account 认证指南</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>