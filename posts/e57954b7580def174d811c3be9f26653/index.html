<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>一键式 new 多个相同的实例（通过界面按钮 来控制 应用的创建、修改、删除，使用Docker Compose 编排应用所需环境） - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="一键式 new 多个相同的实例（通过界面按钮 来控制 应用的创建、修改、删除，使用Docker Compose 编排应用所需环境）" />
<meta property="og:description" content="一、简单介绍 需求：通过界面按钮 来控制 实例的创建、修改、删除。
由于Web应用采用多服务方式开发，每个服务都可以单独访问（单独占用一个端口）。以前部署服务器，采用的Nginx监听端口 转发。但是这样就会在new整个应用的时候，就需要暴露很多端口（每个服务都可以单独访问）、很多容器（每个服务一个容器）管理起来不方便。
对部署进行调整：所有服务打成war包形式，统一部署到tomcat上，对外只需暴露出tomcat端口&#43;服务名就可访问对应服务。
二、环境准备：Docker镜像 Tomcat:8Mysql:5.7.30webcenter/activemq:latestredis:5.0.7elasticsearch:7.7.0 注意：因elasticsearch 占用内存较大，这里所有的应用共享一个elasticsearch。其他中间件则每次new新实例，都会进行重新创建
三、安装 Docker 在创建容器时，为每个容器分配一个ip，如果不指定network则默认容器连接到docker0的虚拟网桥。
由于elasticsearch 是所有容器共享的，但是在使用Docker Compose编排时，每个Compose Docker 都会分配一个network，导致 Compose内容器与elasticsearch 不在一个网段中，Tomcat会连接不上elasticsearch 。
解决方案： 在创建elasticsearch 时，为elasticsearch 单独创建一个network（如果不单独创建，采用默认的network，Compose中容器会连接不上 Docker默认的network），因所有服务打成war包，部署在Tomcat上，所以Tomcat容器需连接 。也可不创建 但是 每次new完新实例就需单独使用命令(使不同网段容器间互联)
docker network connect 0f7725a561c1(elasticsearch 所在networkID) 7fcc20626a4e`(Tomcat容器ID) Docker Compose 一个service下 容器访问可直接使用服务名称（jdbc:mysql://mysql:3306）,如果容器是Compose 外部，则需容器互连之后，也可以采用容器名称访问。
1、elasticsearch 为elasticsearch 创建network
docker network create -d bridge elasticsearch Docker创建elasticsearch 容器 docker run --name elasticsearch --network elasticsearch -d -e ES_JAVA_OPTS=&#34;-Xms512m -Xmx512m&#34; -e &#34;discovery.type=single-node&#34; -p 9200:9200 -p 9300:9300 3ff142212faf(imgeId) 这里采用初始elasticsearch 即可，线上使用自定义elasticsearch 镜像（设置访问密码等操作）" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/e57954b7580def174d811c3be9f26653/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-01T13:07:51+08:00" />
<meta property="article:modified_time" content="2022-12-01T13:07:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">一键式 new 多个相同的实例（通过界面按钮 来控制 应用的创建、修改、删除，使用Docker Compose 编排应用所需环境）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>一、简单介绍</h3> 
<p>需求：通过界面按钮 来控制 实例的创建、修改、删除。</p> 
<p>由于Web应用采用多服务方式开发，每个服务都可以单独访问（单独占用一个端口）。以前部署服务器，采用的Nginx监听端口 转发。但是这样就会在new整个应用的时候，就需要暴露很多端口（每个服务都可以单独访问）、很多容器（每个服务一个容器）管理起来不方便。<br> 对部署进行调整：所有服务打成war包形式，统一部署到tomcat上，对外只需暴露出tomcat端口+服务名就可访问对应服务。</p> 
<h3><a id="Docker_6"></a>二、环境准备：Docker镜像</h3> 
<ol><li>Tomcat:8</li><li>Mysql:5.7.30</li><li>webcenter/activemq:latest</li><li>redis:5.0.7</li><li>elasticsearch:7.7.0</li></ol> 
<p><strong>注意：因elasticsearch 占用内存较大，这里所有的应用共享一个elasticsearch。其他中间件则每次new新实例，都会进行重新创建</strong></p> 
<h4><a id="_15"></a>三、安装</h4> 
<p>Docker 在创建容器时，为每个容器分配一个ip，如果不指定network则默认容器连接到docker0的虚拟网桥。<br> 由于elasticsearch 是所有容器共享的，但是在使用Docker Compose编排时，每个Compose Docker 都会分配一个network，导致 Compose内容器与elasticsearch 不在一个网段中，<strong>Tomcat会连接不上elasticsearch</strong> 。<br> <strong>解决方案</strong>： 在创建elasticsearch 时，为elasticsearch 单独创建一个network（如果不单独创建，采用默认的network，Compose中容器会连接不上 Docker默认的network），因所有服务打成war包，部署在Tomcat上，所以Tomcat容器需连接 。也可不创建 但是 每次new完新实例就需单独使用命令(使不同网段容器间互联)</p> 
<pre><code>docker network connect 
0f7725a561c1(elasticsearch 所在networkID) 
7fcc20626a4e`(Tomcat容器ID)
</code></pre> 
<p>Docker Compose 一个service下 容器访问可直接使用服务名称（jdbc:mysql://mysql:3306）,<strong>如果容器是Compose 外部，则需容器互连之后，也可以采用容器名称访问</strong>。</p> 
<h4><a id="1elasticsearch_28"></a>1、elasticsearch</h4> 
<p>为elasticsearch 创建network</p> 
<pre><code>docker network create -d bridge elasticsearch
</code></pre> 
<ol><li>Docker创建elasticsearch 容器</li></ol> 
<pre><code>docker run --name elasticsearch --network elasticsearch -d -e ES_JAVA_OPTS="-Xms512m -Xmx512m" -e "discovery.type=single-node" -p 9200:9200 -p 9300:9300 3ff142212faf(imgeId)
</code></pre> 
<p>这里采用初始elasticsearch 即可，线上使用自定义elasticsearch 镜像（设置访问密码等操作）</p> 
<h4><a id="2_Docker_Compose__42"></a>2、其他环境 采用Docker Compose 进行编排即可</h4> 
<p><img src="https://images2.imgbox.com/03/15/bKRDjmLg_o.png" alt="在这里插入图片描述"></p> 
<p>目前没有对Mysql、Activemq、Redis 进行暴露端口，因为 都是容器内部访问，不需要外部访问。<br> Tomcat 对外暴露端口、及挂载路径是动态的，所以每次new 新实例 需针对这两部分进行单独替换。</p> 
<h4><a id="3_48"></a>3、单独安装环境</h4> 
<ol><li>activemq</li></ol> 
<pre><code>docker run --name=activemq \
-itd \
-p 8161:8161 \
-p 61616:61616 \
-e ACTIVEMQ_ADMIN_LOGIN=admin \
-e ACTIVEMQ_ADMIN_PASSWORD=123456 \
--restart=always \
-v /usr/local/activemq-docker:/data/activemq \
-v /usr/local/activemq-docker/log:/var/log/activemq \
webcenter/activemq:latest
</code></pre> 
<ol start="2"><li>redis</li></ol> 
<pre><code>docker run -d --name redis -p 6389:6379 \
7eed8df88d3b redis-server --appendonly yes \
--requirepass 123456 --bind 0.0.0.0 \
--protected-mode no --daemonize no
</code></pre> 
<ol start="3"><li>Mysql</li></ol> 
<pre><code>docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 \
 --name  mysql 9cfcce23593a
</code></pre> 
<h3><a id="_78"></a>四、测试</h3> 
<h4><a id="1Docker_Compose_79"></a>1、执行Docker Compose</h4> 
<p>当使用 Compose 创建多个实例的时候，service名称都会相同，所以在启动的时候 需要指定每个Compose的项目名称 进行隔离</p> 
<pre><code>docker-compose -f compose.yml -p 项目名称 up -d
</code></pre> 
<p><img src="https://images2.imgbox.com/11/13/gQqFPyJK_o.png" alt="在这里插入图片描述"><br> elasticsearch 为 单独启动的容器</p> 
<h4><a id="2wartomcat_87"></a>2、把war包放入tomcat挂载目录</h4> 
<h4><a id="3IPtomcat_88"></a>3、访问IP+tomcat端口+服务名称</h4> 
<p><img src="https://images2.imgbox.com/d5/7c/lIooJifT_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Java__91"></a>五、通过Java代码执行命令 修改配置文件以及控制创建新实例</h3> 
<p><a href="https://blog.csdn.net/qinwuxian19891211/article/details/123809107">代码案例</a></p> 
<h3><a id="_95"></a>五、其他常用命令及问题</h3> 
<h4><a id="1_96"></a>1、命令</h4> 
<ol><li>进入容器内部</li></ol> 
<pre><code>docker exec -it 容器ID /bin/bash
</code></pre> 
<ol start="2"><li>停止所有容器</li></ol> 
<pre><code>docker stop $(docker ps -a -q)
</code></pre> 
<ol start="3"><li>删除所有容器</li></ol> 
<pre><code>docker rm $(docker ps -a -q)
</code></pre> 
<ol start="4"><li>查看容器详细信息</li></ol> 
<pre><code>docker inspect 容器ID
</code></pre> 
<ol start="5"><li>查看容器日志</li></ol> 
<pre><code>docker logs -f 容器ID
</code></pre> 
<ol start="6"><li>容器提交镜像</li></ol> 
<pre><code>docker commit -a  创建者 -m 介绍 容器ID 镜像名:版本
</code></pre> 
<ol start="7"><li>镜像下载到本地</li></ol> 
<pre><code>docker save -o xxx.tar 镜像ID
</code></pre> 
<ol start="8"><li>加载镜像到docker中</li></ol> 
<pre><code>docker load -i xxx.tar
</code></pre> 
<h4><a id="2_136"></a>2、问题解决</h4> 
<ol><li>进入容器内部时，经常找不到vim、ping、telnet等命令 需使用apt-get install下载，但是 下载的特别慢：</li></ol> 
<pre><code># 1. 清空/etc/apt/sources.list文件
 echo &gt; /etc/apt/sources.list

# 2. 重新输出到文件
echo -e "deb http://mirrors.aliyun.com/debian/ stretch main non-free contrib \
ndeb-src http://mirrors.aliyun.com/debian/ stretch main non-free contrib \
ndeb http://mirrors.aliyun.com/debian-security stretch/updates main \ndeb-src http://mirrors.aliyun.com/debian-security stretch/updates main \
ndeb http://mirrors.aliyun.com/debian/ stretch-updates main non-free contrib \
ndeb-src http://mirrors.aliyun.com/debian/ stretch-updates main non-free contrib \
ndeb http://mirrors.aliyun.com/debian/ stretch-backports main non-free contrib \
ndeb-src http://mirrors.aliyun.com/debian/ stretch-backports main non-free contrib" &gt; /etc/apt/sources.list

# 3. 更新
apt-get update

# 4. 下载对应依赖即可
# 下载vim时可能会报错 依赖库版本过低导致，先安装依赖
apt-get install -y libtinfo5 --allow-remove-essential
apt-get install -y vim

# 安装telnet
apt-get install telnet
</code></pre> 
<ol start="2"><li>Mysql容器打成镜像<br> 应用初始化时，Mysql中会有一些初始化数据。需要针对Mysql容器打包为镜像。在打包后重新启动容器时，发现数据都没有了。</li></ol> 
<pre><code>需要进入Mysql容器内部，修改 /etc/mysql/mysql.conf.d/mysqld.cnf 把Mysql存储数据的路径 改为自定义路径。
datadir=自定义路径

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/12c0103806863455f373f87bbc7d520c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决element-ui组件库中dialog组件只显示遮罩层，未显示弹框的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/01c084a485a0b9f670b9ef8ef56f2459/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Hololens低版本不支持多通道或者单眼左眼显示问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>