<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux第76步_“gpio子系统”下的LED驱动 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux第76步_“gpio子系统”下的LED驱动" />
<meta property="og:description" content="使用新字符设备驱动的一般模板和“gpio子系统”，以及设备树，驱动LED。
1、添加“gpio_led”节点
打开虚拟机上“VSCode”，点击“文件”，点击“打开文件夹”，点击“zgq”，点击“linux”，点击“atk-mp1”，点击“linux”，点击“my_linux”，点击“stm32mp157d-atk.dts”。
stm32mp157d-atk.dts文件如下：
/dts-v1/;
#include &#34;stm32mp157.dtsi&#34;
#include &#34;stm32mp15xd.dtsi&#34;
#include &#34;stm32mp15-pinctrl.dtsi&#34;
#include &#34;stm32mp15xxaa-pinctrl.dtsi&#34;
#include &#34;stm32mp157-m4-srm.dtsi&#34;
#include &#34;stm32mp157-m4-srm-pinctrl.dtsi&#34;
#include &#34;stm32mp157d-atk.dtsi&#34;
/ {
model = &#34;STMicroelectronics STM32MP157D eval daughter&#34;;
/*model属性用于描述开发板的名字或设备模块的信息*/
compatible = &#34;st,stm32mp157d-ed1&#34;, &#34;st,stm32mp157&#34;;
/*compatible属性用于将设备和驱动绑定起来*/
chosen { /*chosen子节点*/
stdout-path = &#34;serial0:115200n8&#34;;
};
aliases { /*aliases子节点*/
serial0 = &amp;uart4;
/*给&amp;uart4起个别名叫“serial0”*/
};
reserved-memory {
gpu_reserved: gpu@f6000000 { /*gpu节点标签为gpu_reserved*/
reg = &lt;0xf6000000 0x8000000&gt;;
no-map;
};
optee_memory: optee@fe000000 {
reg = &lt;0xfe000000 0x02000000&gt;;
no-map;
};" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/521f8ee1de1287655ee0e1dfc69b33f9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-11T20:29:00+08:00" />
<meta property="article:modified_time" content="2024-03-11T20:29:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux第76步_“gpio子系统”下的LED驱动</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:.0001pt;text-align:justify;">使用新字符设备驱动的一般模板和“gpio子系统”，以及设备树，驱动LED。</p> 
<p style="margin-left:.0001pt;text-align:justify;">1、添加“<span style="color:#00b0f0;">gpio_</span><span style="color:#00b0f0;">led</span>”节点</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">打开虚拟机上“</span><span style="color:#ff0000;">VSCode</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">文件</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">打开文件夹</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">zgq</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">linux</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">atk-mp1</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">linux</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">my_linux</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">stm32mp157d-atk.dts</span><span style="color:#000000;">”。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">stm32mp157d-atk.dts</span><span style="color:#000000;">文件如下：</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">/dts-v1/;</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp157.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp15xd.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp15-pinctrl.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp15xxaa-pinctrl.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp157-m4-srm.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp157-m4-srm-pinctrl.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp157d-atk.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">/</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">model = "STMicroelectronics STM32MP157D eval daughter";</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">model属性用于描述开发板的名字或设备模块的信息</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">compatible = "st,stm32mp157d-ed1", "st,stm32mp157";</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*compatible属性用于将设备和驱动绑定起来*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#7030a0;">chosen</span> {  <span style="color:#00b050;">/*</span><span style="color:#00b050;">chosen</span><span style="color:#00b050;">子节点</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">stdout-path = "serial0:115200n8";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#7030a0;">aliases</span> {    <span style="color:#00b050;">/*</span><span style="color:#00b050;">aliases子节点</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">serial0 = <span style="color:#00b0f0;">&amp;uart4</span>;</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b050;">/*给</span><span style="color:#00b050;">&amp;uart4</span><span style="color:#00b050;">起个别名叫“</span><span style="color:#00b050;">seria</span><span style="color:#00b050;">l</span><span style="color:#00b050;">0”</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#7030a0;">reserved-memory</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpu_reserved: gpu@f6000000 {  <span style="color:#00b050;">/*</span><span style="color:#00b050;">gpu</span><span style="color:#00b050;">节点标签为</span><span style="color:#00b050;">gpu_reserved</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0xf6000000 0x8000000&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">no-map;</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">optee_memory: optee@fe000000 {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0xfe000000 0x02000000&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">no-map;</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#7030a0;">stm32mp1_led</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">compatible = "atkstm32mp1-led";</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*compatible属性用于将设备</span><span style="color:#7030a0;">stm32mp1_led</span><span style="color:#00b050;">和驱动“.ko”绑定起来*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "<span style="color:#984806;">okay</span>";</p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0X50000A28 0X04 <span style="color:#00b050;">/* RCC_MP_AHB4ENSETR */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">0X5000A000 0X04 <span style="color:#00b050;">/* GPIOI_MODER */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">0X5000A004 0X04 <span style="color:#00b050;">/* GPIOI_OTYPER */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">0X5000A008 0X04 <span style="color:#00b050;">/* GPIOI_OSPEEDR */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">0X5000A00C 0X04 <span style="color:#00b050;">/* GPIOI_PUPDR */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">0X5000A018 0X04 &gt;; <span style="color:#00b050;">/* GPIOI_BSRR */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">&amp;cpu1</span>{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">cpu-supply = &lt;<span style="color:#00b0f0;">&amp;vddcore</span>&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">&amp;gpu</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">contiguous-area = &lt;<span style="color:#00b0f0;">&amp;gpu_reserved</span>&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "<span style="color:#984806;">okay</span>";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">&amp;optee</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "<span style="color:#984806;">okay</span>";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">修改后的</span><span style="color:#ff0000;">stm32mp157d-atk.dts</span><span style="color:#000000;">文件如下：</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">/dts-v1/;</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp157.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp15xd.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp15-pinctrl.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp15xxaa-pinctrl.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp157-m4-srm.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp157-m4-srm-pinctrl.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stm32mp157d-atk.dtsi"</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">/</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">model = "STMicroelectronics STM32MP157D eval daughter";</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span><span style="color:#00b050;">model属性用于描述开发板的名字或设备模块的信息</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">compatible = "st,stm32mp157d-ed1", "st,stm32mp157";</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*compatible属性用于将设备和驱动绑定起来*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#7030a0;">chosen</span> {  <span style="color:#00b050;">/*</span><span style="color:#00b050;">chosen</span><span style="color:#00b050;">子节点</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">stdout-path = "serial0:115200n8";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#7030a0;">aliases</span> {    <span style="color:#00b050;">/*</span><span style="color:#00b050;">aliases子节点</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">serial0 = <span style="color:#00b0f0;">&amp;uart4</span>;</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b050;">/*给</span><span style="color:#00b050;">&amp;uart4</span><span style="color:#00b050;">起个别名叫“</span><span style="color:#00b050;">seria</span><span style="color:#00b050;">l</span><span style="color:#00b050;">0”</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#7030a0;">reserved-memory</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpu_reserved: gpu@f6000000 {  <span style="color:#00b050;">/*</span><span style="color:#00b050;">gpu</span><span style="color:#00b050;">节点标签为</span><span style="color:#00b050;">gpu_reserved</span><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0xf6000000 0x8000000&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">no-map;</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">optee_memory: optee@fe000000 {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0xfe000000 0x02000000&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">no-map;</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#7030a0;">stm32mp1_led</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">compatible = "atkstm32mp1-led";</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*compatible属性用于将设备</span><span style="color:#7030a0;">stm32mp1_led</span><span style="color:#00b050;">和驱动“.ko”绑定起来*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "<span style="color:#984806;">okay</span>";</p> 
<p style="margin-left:.0001pt;text-align:justify;">reg = &lt;0X50000A28 0X04 <span style="color:#00b050;">/* RCC_MP_AHB4ENSETR */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">0X5000A000 0X04 <span style="color:#00b050;">/* GPIOI_MODER */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">0X5000A004 0X04 <span style="color:#00b050;">/* GPIOI_OTYPER */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">0X5000A008 0X04 <span style="color:#00b050;">/* GPIOI_OSPEEDR */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">0X5000A00C 0X04 <span style="color:#00b050;">/* GPIOI_PUPDR */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">0X5000A018 0X04 &gt;; <span style="color:#00b050;">/* GPIOI_BSRR */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">gpio_led {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">compatible = "<span style="color:#984806;">zgq</span><span style="color:#984806;">,led</span>";</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "<span style="color:#984806;">okay</span>";</p> 
<p style="margin-left:.0001pt;text-align:justify;">led-gpio = &lt;<span style="color:#00b0f0;">&amp;gpioi</span> 0 GPIO_ACTIVE_LOW&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">&amp;cpu1</span>{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">cpu-supply = &lt;<span style="color:#00b0f0;">&amp;vddcore</span>&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">&amp;gpu</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">contiguous-area = &lt;<span style="color:#00b0f0;">&amp;gpu_reserved</span>&gt;;</p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "<span style="color:#984806;">okay</span>";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">&amp;optee</span> {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">status = "<span style="color:#984806;">okay</span>";</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="987" src="https://images2.imgbox.com/4c/95/TRvhcu4P_o.png" width="1073"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">2、编译设备树</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">1)、在VSCode终端，输入“</span><span style="color:#ff0000;">make dtbs回车</span><span style="color:#000000;">”，执行编译设备树</span></p> 
<p style="margin-left:.0001pt;text-align:left;">2)、输入“<span style="color:#ff0000;">ls </span><span style="color:#0070c0;">arch/arm/boot/uImage</span> <span style="color:#ff0000;">-l</span>”</p> 
<p style="margin-left:.0001pt;text-align:left;">查看是否生成了新的“<span style="color:#0070c0;">uImage</span>”文件</p> 
<p style="margin-left:.0001pt;text-align:left;">3)、输入“<span style="color:#ff0000;">ls </span><span style="color:#0070c0;">arch/arm/boot/dts/stm32mp157d-atk.dtb</span> <span style="color:#ff0000;">-l</span>”</p> 
<p style="margin-left:.0001pt;text-align:left;">查看是否生成了新的“<span style="color:#0070c0;">stm32mp157d-atk.dtb</span>”文件</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;">拷贝输出的文件：</p> 
<p style="margin-left:.0001pt;text-align:justify;">4)、输入“<span style="color:#ff0000;">cp arch/arm/boot/uImage /home/zgq/linux/atk-mp1/linux/bootfs/ -f回车</span>”，执行文件拷贝，准备烧录到EMMC；</p> 
<p style="margin-left:.0001pt;text-align:left;">5)、输入“<span style="color:#ff0000;">cp arch/arm/boot/dts/stm32mp157d-atk.dtb</span> <span style="color:#ff0000;">/home/zgq/linux/atk-mp1/linux/bootfs/ -f回车</span>”，执行文件拷贝，准备烧录到EMMC</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">6)、输入“<span style="color:#ff0000;">cp arch/arm/boot/uImage /home/zgq/linux/tftpboot/ -f回车</span>”，执行文件拷贝，准备从tftp下载；</p> 
<p style="margin-left:.0001pt;text-align:left;">7)、输入“<span style="color:#ff0000;">cp arch/arm/boot/dts/stm32mp157d-atk.dtb</span> <span style="color:#ff0000;">/home/zgq/linux/tftpboot/ -f回车</span>”，执行文件拷贝，准备从tftp下载；</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;">8)、输入“<span style="color:#ff0000;">ls -l /home/zgq/linux/atk-mp1/linux/bootfs/回车</span>”，查看“<span style="color:#00b050;">/home/zgq/linux/atk-mp1/linux/bootfs/</span>”目录下的所有文件和文件夹</p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;">9)、输入“<span style="color:#ff0000;">ls -l /home/zgq/linux/tftpboot/回车</span>”，查看“<span style="color:#00b050;">/home/zgq/linux/tftpboot/</span>”目录下的所有文件和文件夹</p> 
<p style="margin-left:.0001pt;text-align:left;">输入“<span style="color:#ff0000;">chmod 777 /home/zgq/linux/tftpboot/stm32mp157d-atk.dtb回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#000000;">给“</span><span style="color:#00b050;">stm32mp157d-atk.dtb</span><span style="color:#000000;">”文件赋予可执行权限</span></p> 
<p style="margin-left:.0001pt;text-align:left;">输入“<span style="color:#ff0000;">chmod 777 /home/zgq/linux/tftpboot/uImage回车</span>”<span style="color:#000000;"> ,给“</span><span style="color:#ff0000;">uImage</span><span style="color:#000000;">”文件赋予可执行权限</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">ls /home/zgq/linux/tftpboot/回车</span>”，查看“<span style="color:#00b050;">/home/zgq/linux/tftpboot/</span>”目录下的所有文件和文件夹</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="991" src="https://images2.imgbox.com/77/18/sNvnKWax_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">3、查看“<span style="color:#7030a0;">gpio_led</span><span style="color:#000000;">”</span>节点</p> 
<p style="margin-left:.0001pt;text-align:justify;">启动开发板，从网络下载程序</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">root</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">cd /proc/device-tree/回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">切换到“<span style="color:#00b050;">/sys/firmware/devicetree/base</span>”目录</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">ls</span>”查看“<span style="color:#00b050;">gpio_led</span>”是否存在</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">cd </span><span style="color:#00b050;">gpio</span><span style="color:#ff0000;">_led/回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">ls</span>”查看“<span style="color:#00b050;">/sys/firmware/devicetree/base/gpio_led</span>”目录下的文件和文件夹</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">cat compatible回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">cat led-gpio回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">cat name回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">cat status回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="1200" src="https://images2.imgbox.com/c7/0d/XFXkz1RQ_o.png" width="1148"></p> 
<p style="margin-left:.0001pt;text-align:justify;">4、创建<span style="color:#ff0000;">MyGpio</span><span style="color:#ff0000;">LED</span>目录</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">cd /home/zgq/linux/Linux_Drivers/回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">切换到“<span style="color:#00b050;">/home/zgq/linux/Linux_Drivers/</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">ls回车</span>”，查看“<span style="color:#00b050;">/home/zgq/linux/Linux_Drivers/</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">mkdir </span><span style="color:#ff0000;">MyGpio</span><span style="color:#ff0000;">LED</span><span style="color:#ff0000;">回车</span>”，创建“<span style="color:#ff0000;">MyGpio</span><span style="color:#ff0000;">LED</span>”目录</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">ls回车</span>”，查看“<span style="color:#00b050;">/home/zgq/linux/Linux_Drivers/</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="491" src="https://images2.imgbox.com/ff/86/tU3wOs11_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">5、LED.c文件如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#include</span> "LED.h"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#include</span> &lt;linux/gpio.h&gt;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//使能gpio_request(),gpio_free(),gpio_direction_input(),</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//使能gpio_direction_output(),gpio_get_value(),gpio_set_value()</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#include</span> &lt;linux/of_gpio.h&gt;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//使能of_gpio_named_count(),of_gpio_count(),of_get_named_gpio()</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">struct</span> MyGpioLED_dev strMyGpioLED;</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">int</span> Get_gpio_num(<span style="color:#00b0f0;">void</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">int</span> led_GPIO_request(<span style="color:#00b0f0;">void</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">void</span> led_switch(u8 sta,<span style="color:#00b0f0;">struct</span> MyGpioLED_dev *dev);</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">int</span> Get_gpio_num(<span style="color:#00b0f0;">void</span>)</p> 
<p style="margin-left:.0001pt;text-align:justify;">{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> ret = 0;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">const char</span> *str;</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  /* 设置LED所使用的GPIO */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  /* 1、获取设备节点：strMyGpioLED */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  strMyGpioLED.nd = of_find_node_by_path("<span style="color:#984806;">/gpio_led</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //path="/gpio_led，使用“全路径的节点名“在“</span><span style="color:#ff0000;">stm32mp157d-atk.dts</span><span style="color:#00b050;">“中查找节点“gpio_led”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值:返回找到的节点，如果为NULL，表示查找失败。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span>(strMyGpioLED.nd == NULL) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk("<span style="color:#984806;">gpio_led node not find!\r\n</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">return</span> -EINVAL;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  /* 2.读取status属性 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  ret = of_property_read_string(strMyGpioLED.nd, "<span style="color:#984806;">status</span>", &amp;str);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //在gpio_led节点中，status = "okay";</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //指定的设备节点strMyGpioLED.nd</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //proname="status"，给定要读取的属性名字</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //out_string=str:返回读取到的属性值</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值:0，读取成功，负值，读取失败。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span>(ret &lt; 0) <span style="color:#00b0f0;">return</span> -EINVAL;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span> (strcmp(str, "<span style="color:#984806;">okay</span>")) <span style="color:#00b0f0;">return</span> -EINVAL;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //strcmp(s1,s2),当s1&lt;s2时，返回值为负数</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //strcmp(s1,s2),当s1&gt;2时，返回值为正数</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //strcmp(s1,s2),当s1=s2时，返回值为0</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  /* 3、获取compatible属性值并进行匹配 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  ret = of_property_read_string(strMyGpioLED.nd, "<span style="color:#984806;">compatible</span>", &amp;str);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //在gpio_led节点中，compatible = "zgq,led";</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //指定的设备节点strMyGpioLED.nd</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //proname="compatible"，给定要读取的属性名字</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //out_string=str:返回读取到的属性值</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值:0，读取成功，负值，读取失败。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span>(ret &lt; 0) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk("<span style="color:#984806;">gpio_led node: Failed to get compatible property\n</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">return</span> -EINVAL;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span> (strcmp(str, "zgq,led")) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk("<span style="color:#984806;">gpio_led node: Compatible match failed\n</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">return</span> -EINVAL;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"> <span style="color:#00b050;"> /* 4、 获取设备树中的gpio属性，得到LED所使用的LED编号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  strMyGpioLED.led_gpio = of_get_named_gpio(strMyGpioLED.nd, "led-gpio", 0);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //在gpio_led节点中，led-gpio = &lt;&amp;gpioi 0 GPIO_ACTIVE_LOW&gt;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //np=strMyGpioLED.nd,指定的“设备节点”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //propname="led-gpio"，给定要读取的属性名字</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //Index=0,给定的GPIO索引为0</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值：正值，获取到的GPIO编号；负值，失败。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span>(strMyGpioLED.led_gpio &lt; 0) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk("<span style="color:#984806;">can't get led-gpio</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">return</span> -EINVAL;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;">  printk("<span style="color:#984806;">led-gpio num = %d\r\n</span>", strMyGpioLED.led_gpio);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //打印结果为：“led-gpio num = 128“</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //因为GPIO编号是从0开始的，GPIOI端口的序号是8，每个端口有16个IO口，因此GPIOI0的编号为8*16=128</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">return</span> 0;</p> 
<p style="margin-left:.0001pt;text-align:justify;">}</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">int</span> led_GPIO_request(<span style="color:#00b0f0;">void</span>)</p> 
<p style="margin-left:.0001pt;text-align:justify;">{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> ret = 0;</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b050;">/* 5.向gpio子系统申请使用“gpio编号” */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  ret = gpio_request(strMyGpioLED.led_gpio, "LED-GPIO");</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //gpio=strMyGpioLED.led_gpio，指定要申请的“gpio编号”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //Iabel="LED-GPIO"，给这个gpio引脚设置个名字为"LED-GPIO"</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值：0，申请“gpio编号”成功;其他值，申请“gpio编号”失败；</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span> (ret) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk(KERN_ERR "<span style="color:#984806;">strMyGpioLED: Failed to request led-gpio\n</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">return</span> ret;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b050;">/* 6、设置PI0为输出，并且输出高电平，默认关闭LED灯 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  ret = gpio_direction_output(strMyGpioLED.led_gpio, 1);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //gpio=strMyGpioLED.led_gpio,指定的“gpio编号”，这里是128，对应的是GI0引脚</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //value=1，设置引脚输出高电平</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值：0，设置“引脚输出为vakued的值”成功;负值，设置“引脚输出为vakued的值”失败。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span>(ret &lt; 0) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk("can't set gpio!\r\n");</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">return</span> 0;</p> 
<p style="margin-left:.0001pt;text-align:justify;">}</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">void</span> led_switch(u8 sta,<span style="color:#00b0f0;">struct</span> MyGpioLED_dev *dev)</p> 
<p style="margin-left:.0001pt;text-align:justify;">{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">if</span>(sta == LEDON) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    gpio_set_value(dev-&gt;led_gpio, 0); <span style="color:#00b050;">/* 打开LED灯 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">}</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">else if</span>(sta == LEDOFF) {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    gpio_set_value(dev-&gt;led_gpio, 1); <span style="color:#00b050;">/* 关闭LED灯 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">}</p> 
<p style="margin-left:.0001pt;text-align:justify;">}</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">6、LED.h程序如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">#ifndef</span> __LED_H</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#define</span> __LED_H</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#include</span> &lt;linux/types.h&gt;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">数据类型重命名</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">使能bool,u8,u16,u32,u64, uint8_t, uint16_t, uint32_t, uint64_t</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">使能s8,s16,s32,s64,int8_t,int16_t,int32_t,int64_t</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#include</span> &lt;linux/cdev.h&gt; <span style="color:#00b050;">//使能cdev结构</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#include</span> &lt;linux/cdev.h&gt; <span style="color:#00b050;">//使能class结构和device结构</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#include</span> &lt;linux/of.h&gt;   <span style="color:#00b050;">//使能device_node结构</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#define</span> LEDOFF 0 <span style="color:#00b050;">/* 关灯 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#define</span> LEDON 1 <span style="color:#00b050;">/* 开灯 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">struct</span> MyGpioLED_dev{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">  dev_t devid; <span style="color:#00b050;">/*声明32位变量devid用来给保存设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> major; <span style="color:#00b050;">/* 主设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> minor; <span style="color:#00b050;">/* 次设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> cdev  cdev; <span style="color:#00b050;">/*字符设备结构变量cdev */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> class *class;<span style="color:#00b050;"> /* 类 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> device *device;<span style="color:#00b050;">/*设备*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">struct</span> device_node *nd;<span style="color:#00b050;">/* 设备节点 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span> led_gpio; <span style="color:#00b050;">/* led所使用的GPIO编号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">extern struct</span> MyGpioLED_dev strMyGpioLED;</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">extern int</span> Get_gpio_num(<span style="color:#00b0f0;">void</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">extern int</span> led_GPIO_request(<span style="color:#00b0f0;">void</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">extern void</span> led_switch(u8 sta,<span style="color:#00b0f0;">struct</span> MyGpioLED_dev *dev);</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">#endif</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">7、LEDInterface.c程序如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#include</span><span style="color:#000000;"> "LED.h"</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#include</span><span style="color:#000000;"> &lt;linux/types.h&gt;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//数据类型重命名</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//使能bool,u8,u16,u32,u64, uint8_t, uint16_t, uint32_t, uint64_t</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//使能s8,s16,s32,s64,int8_t,int16_t,int32_t,int64_t</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#include</span><span style="color:#000000;"> &lt;linux/ide.h&gt;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//使能copy_from_user(),copy_to_user()</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#include</span><span style="color:#000000;"> &lt;linux/module.h&gt;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//使能MyGpioLED_init(),MyGpioLED_exit()</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#include</span><span style="color:#000000;"> &lt;linux/gpio.h&gt;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//使能gpio_request(),gpio_free(),gpio_direction_input(),</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//gpio_direction_output(),gpio_get_value(),gpio_set_value()</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#define</span><span style="color:#000000;"> MyGpioLED_CNT    1   </span><span style="color:#00b050;">//定义设备数量为1</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">#define</span><span style="color:#000000;"> MyGpioLED_NAME  "MyGpioLEDName"</span><span style="color:#00b050;">//定义设备的名字</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/* 打开设备 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">static int</span><span style="color:#000000;"> MyGpioLED_open(</span><span style="color:#00b0f0;">struct</span><span style="color:#000000;"> inode *inode, </span><span style="color:#00b0f0;">struct</span><span style="color:#000000;"> file *filp)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">{<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  filp-&gt;private_data = &amp;strMyGpioLED; </span><span style="color:#00b050;">/* 设置私有数据 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  printk("MyGpioLED_open!\r\n");</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">return</span><span style="color:#000000;"> 0;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/* 从设备读取数据，保存到首地址为buf的数据块中，长度为cnt个字节 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//file结构指针变量flip表示要打开的设备文件</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//buf表示用户数据块的首地址</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//cnt表示用户数据的长度，单位为字节</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//loff_t结构指针变量offt表示“相对于文件首地址的偏移”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">static</span><span style="color:#000000;"> ssize_t MyGpioLED_read(</span><span style="color:#00b0f0;">struct</span><span style="color:#000000;"> file *filp, </span><span style="color:#00b0f0;">char</span><span style="color:#000000;"> __user *buf, size_t cnt, loff_t *offt)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">{<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">return</span><span style="color:#000000;"> 0;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/* 向设备写数据，将数据块首地址为buf的数据，长度为cnt个字节，发送给用户 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//file结构指针变量flip表示要打开的设备文件</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//buf表示用户数据块的首地址</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//cnt表示用户数据的长度，单位为字节</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//loff_t结构指针变量offt表示“相对于文件首地址的偏移”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">static</span><span style="color:#000000;"> ssize_t MyGpioLED_write(</span><span style="color:#00b0f0;">struct</span><span style="color:#000000;"> file *filp, const </span><span style="color:#00b0f0;">char</span><span style="color:#000000;"> __user *buf, size_t cnt, loff_t *offt)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">{<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">int</span><span style="color:#000000;"> ret = 0;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">unsigned char</span><span style="color:#000000;"> databuf[1];</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">unsigned char</span><span style="color:#000000;"> ledstat;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  ret = copy_from_user(databuf, buf, cnt);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span><span style="color:#000000;">(ret &lt;0){<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">    printk("</span><span style="color:#984806;">kernel write failed!\r\n</span><span style="color:#000000;">");</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">    ret = -EFAULT;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  }</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  ledstat = databuf[0];</span><span style="color:#00b050;">/*获取到应用传递进来的开关灯状态*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  led_switch(ledstat,filp-&gt;private_data);</span><span style="color:#00b050;">/*执行开灯或执行关灯*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">return</span><span style="color:#000000;"> ret;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/* 关闭/释放设备 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">static int</span><span style="color:#000000;"> MyGpioLED_release(</span><span style="color:#00b0f0;">struct</span><span style="color:#000000;"> inode *inode, </span><span style="color:#00b0f0;">struct</span><span style="color:#000000;"> file *filp)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">{<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b050;">/* 用户实现具体功能 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  printk("</span><span style="color:#984806;">MyGpioLED_release!\r\n</span><span style="color:#000000;">");</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">return</span><span style="color:#000000;"> 0;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*声明file_operations结构变量MyCharDevice_fops*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*它是指向设备的操作函数集合变量*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">const struct</span><span style="color:#000000;"> file_operations MyGpioLED_fops = {<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  .owner = THIS_MODULE,</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  .open = MyGpioLED_open,</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  .read = MyGpioLED_read,</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  .write = MyGpioLED_write,</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  .release = MyGpioLED_release,</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">};</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*驱动入口函数 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">static int</span><span style="color:#000000;">  __init MyGpioLED_init(void)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">{<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  int ret;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  ret=Get_gpio_num();</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span><span style="color:#000000;">(ret &lt; 0) </span><span style="color:#00b0f0;">return</span><span style="color:#000000;"> ret;</span><span style="color:#00b050;">//读引脚编号</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/* 1、申请“gpio编号”*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  ret=led_GPIO_request();</span><span style="color:#00b050;">//申请“gpio编号”</span> </p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span><span style="color:#000000;">(ret &lt; 0) </span><span style="color:#00b0f0;">return</span><span style="color:#000000;"> ret;</span><span style="color:#00b050;">//向gpio子系统申请使用“gpio编号” 失败</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b050;">/*2、申请设备号*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  strMyGpioLED.major=0;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span><span style="color:#000000;">(strMyGpioLED.major)</span><span style="color:#00b050;">/*如果指定了主设备号*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  {<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">    strMyGpioLED.devid = MKDEV(strMyGpioLED.major, 0);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //输入参数strMyGpioLED.major为“主设备号”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //输入参数0为“次设备号”，大部分驱动次设备号都选择0</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //将strMyGpioLED.major左移20位，再与0相或，就得到“Linux设备号”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">    ret=register_chrdev_region(strMyGpioLED.devid, MyGpioLED_CNT, MyGpioLED_NAME);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //strMyGpioLED.devid表示起始设备号</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //MyGpioLED_CNT表示次设备号的数量</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //MyGpioLED_NAME表示设备名</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">if</span><span style="color:#000000;">(ret &lt; 0)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">      <span style="color:#00b0f0;">goto</span><span style="color:#000000;"> free_gpio;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  }</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">else</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  {<!-- --></span><span style="color:#00b050;"> /* 没有定义设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">    ret=alloc_chrdev_region(&amp;strMyGpioLED.devid, 0, MyGpioLED_CNT,MyGpioLED_NAME);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">   <span style="color:#00b050;"> /* 申请设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">   <span style="color:#00b050;"> //strMyGpioLED.devid：保存申请到的设备号</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //0：次设备号的起始地址</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //MyGpioLED_CNT：要申请的次设备号数量；</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //MyGpioLED_NAME：表示“设备名字”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">if</span><span style="color:#000000;">(ret &lt; 0)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">      <span style="color:#00b0f0;">goto</span><span style="color:#000000;"> free_gpio;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">    strMyGpioLED.major = MAJOR(strMyGpioLED.devid);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    /* 获取分配号的主设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //输入参数strMyGpioLED.devid为“Linux设备号”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //将strMyGpioLED.devid右移20位得到“主设备号”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">    strMyGpioLED.minor = MINOR(strMyGpioLED.devid);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    /* 获取分配号的次设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //输入参数strMyGpioLED.devid为“Linux设备号”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //将strMyGpioLED.devid与0xFFFFF相与后得到“次设备号”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  }</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b050;">/*3、注册字符设备*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  strMyGpioLED.cdev.owner = THIS_MODULE;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //使用THIS_MODULE将owner指针指向当前这个模块</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  cdev_init(&amp;strMyGpioLED.cdev,&amp;MyGpioLED_fops);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //注册字符设备，初始化“字符设备结构变量strMyGpioLED.cdev”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //strMyGpioLED.cdev是等待初始化的结构体变量</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //MyGpioLED_fops就是字符设备文件操作函数集合</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  /*4、添加字符设备*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  ret=cdev_add(&amp;strMyGpioLED.cdev,strMyGpioLED.devid,MyGpioLED_CNT);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //添加字符设备</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  /*&amp;strMyGpioLED.cdev表示指向要添加的字符设备，即字符设备结构strMyGpioLED.cdev变量*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //strMyGpioLED.devid表示设备号</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //MyGpioLED_CNT表示需要添加的设备数量</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span><span style="color:#000000;">(ret &lt; 0 ) </span><span style="color:#00b050;">//添加字符设备失败</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">goto</span><span style="color:#000000;"> del_register;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  printk("</span><span style="color:#984806;">dev id major = %d,minor = %d\r\n</span><span style="color:#000000;">", strMyGpioLED.major, strMyGpioLED.minor);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  printk("</span><span style="color:#984806;">MyGpioLED_init is ok!!!\r\n</span><span style="color:#000000;">");</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b050;">/*5、自动创建设备节点 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  strMyGpioLED.class =class_create(THIS_MODULE, MyGpioLED_NAME);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if </span><span style="color:#000000;">(IS_ERR(strMyGpioLED.class)){<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">goto </span><span style="color:#000000;">del_cdev;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  }</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b050;">/*6、创建设备 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  strMyGpioLED.device = device_create(strMyGpioLED.class, NULL, strMyGpioLED.devid, NULL, MyGpioLED_NAME);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //创建设备</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //设备要创建在strMyGpioLED.class类下面</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //NULL表示没有父设备</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //strMyGpioLED.devid是设备号;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //参数drvdata=NULL，设备没有使用数据</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //MyGpioLED_NAME是设备名字</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //如果设置fmt=MyGpioLED_NAME 的话，就会生成/dev/MyGpioLED_NAME设备文件。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值就是创建好的设备。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">if</span><span style="color:#000000;"> (IS_ERR(strMyGpioLED.device)){<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#00b0f0;">goto</span><span style="color:#000000;"> destroy_class;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  }</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">return</span><span style="color:#000000;"> 0;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">destroy_class:</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  class_destroy(strMyGpioLED.class);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //删除类</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //strMyGpioLED.class就是要删除的类</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">del_cdev:</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">   cdev_del(&amp;strMyGpioLED.cdev);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">   //删除字符设备</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">   //&amp;strMyGpioLED.cdev表示指向需要删除的字符设备，即字符设备结构strMyGpioLED.cdev变量</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">del_register:</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  unregister_chrdev_region(strMyGpioLED.devid, MyGpioLED_CNT);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  /* 释放设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //strMyGpioLED.devid：需要释放的起始设备号</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //MyGpioLED_CNT：需要释放的次设备号数量；</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">free_gpio:</span><span style="color:#00b050;">//申请设备号失败</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  /*释放gpio编号*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  gpio_free(strMyGpioLED.led_gpio);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b0f0;">return</span><span style="color:#000000;"> -EIO;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*驱动出口函数 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b0f0;">static void</span><span style="color:#000000;"> __exit MyGpioLED_exit(</span><span style="color:#00b0f0;">void</span><span style="color:#000000;">)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">{<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"> <span style="color:#00b050;"> /*1、删除字符设备*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  cdev_del(&amp;strMyGpioLED.cdev);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  /*删除字符设备*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  /*&amp;strMyGpioLED.cdev表示指向需要删除的字符设备，即字符设备结构&amp;strMyGpioLED.cdev变量*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b050;">/*2、 释放设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  unregister_chrdev_region(strMyGpioLED.devid, MyGpioLED_CNT);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  /*释放设备号 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //strMyGpioLED.devid：需要释放的起始设备号</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //MyGpioLED_CNT：需要释放的次设备号数;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"> <span style="color:#00b050;"> /*3、 删除设备 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  device_destroy(strMyGpioLED.class, strMyGpioLED.devid);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //删除创建的设备</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //strMyGpioLED.class是要删除的设备所处的类</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //strMyGpioLED.devid是要删除的设备号</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  </p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b050;">/*4、删除类*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  class_destroy(strMyGpioLED.class);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //删除类</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //strMyGpioLED.class就是要删除的类</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"> <span style="color:#00b050;"> /*5、释放gpio编号*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">  gpio_free(strMyGpioLED.led_gpio);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">module_init(MyGpioLED_init);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//指定MyGpioLED_init()为驱动入口函数</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">module_exit(MyGpioLED_exit); </span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//指定MyGpioLED_exit()为驱动出口函数</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">MODULE_AUTHOR("</span><span style="color:#984806;">Zhanggong</span><span style="color:#000000;">");</span><span style="color:#00b050;">//添加作者名字</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">MODULE_LICENSE("</span><span style="color:#984806;">GPL</span><span style="color:#000000;">");</span><span style="color:#00b050;">//LICENSE采用“GPL协议”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">MODULE_INFO(intree,"</span><span style="color:#984806;">Y</span><span style="color:#000000;">");</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//去除显示“loading out-of-tree module taints kernel.”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">8、LED_APP.c文件如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stdio.h"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "unistd.h"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "sys/types.h"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "sys/stat.h"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "fcntl.h"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "stdlib.h"</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#include</span> "string.h"</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//APP运行命令:./LED_APP filename &lt;1&gt;|&lt;0&gt;如果是1表示打开LED，如果是0表示关闭LED</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#define</span> LEDOFF 0 <span style="color:#00b050;">/* 关灯 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">#define</span> LEDON 1 <span style="color:#00b050;">/* 开灯 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">参数argc: argv[]数组元素个数</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">参数argv[]:是一个指针数组</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">返回值: 0 成功;其他 失败</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> main(<span style="color:#0000ff;">int</span> argc, <span style="color:#0000ff;">char</span> *argv[])</p> 
<p style="margin-left:.0001pt;text-align:justify;">{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#0000ff;">int</span> fd, retvalue;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#0000ff;">char</span> *filename;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#0000ff;">unsigned char</span> databuf[1];</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#0000ff;">if</span>(argc != 3)</p> 
<p style="margin-left:.0001pt;text-align:justify;">  {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printf("<span style="color:#984806;">Error Usage!\r\n</span>");</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#0000ff;">return</span> -1;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b050;">//argv[]是指向输入参数“./LED_App” “/dev/LMyNewLEDName” “1”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  filename = argv[1];</p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b050;">//argv[1]指向字符串“/dev/MyNewLEDName”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  fd = open(filename, O_RDWR);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //如果打开“/dev/MyNewLEDName”文件成功，则fd为“文件描述符”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //fd=0表示关灯； fd=1表示开灯；</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#0000ff;">if</span>(fd &lt; 0)</p> 
<p style="margin-left:.0001pt;text-align:justify;">  {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printf("<span style="color:#984806;">Can't open file %s\r\n</span>", filename);</p> 
<p style="margin-left:.0001pt;text-align:justify;">    return -1;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  databuf[0]= atoi(argv[2]); <span style="color:#00b050;">/* 写入的数据，是数字的，表示打开或关闭 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  retvalue = write(fd, databuf, 1);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //将databuf[]中前1个字节发送给用户</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值大于0表示写入的字节数；</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值等于0表示没有写入任何数据；</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值小于0表示写入失败</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#0000ff;">if</span>(retvalue &lt; 0)</p> 
<p style="margin-left:.0001pt;text-align:justify;">  {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printf("<span style="color:#984806;">write file %s failed!\r\n</span>", filename);</p> 
<p style="margin-left:.0001pt;text-align:justify;">    close(fd);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //fd表示要关闭的“文件描述符”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //返回值等于0表示关闭成功</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">    //返回值小于0表示关闭失败</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#0000ff;">return</span> -1;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"> <span style="color:#00b050;"> /* 关闭设备 */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  retvalue = close(fd);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //fd表示要关闭的“文件描述符”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">  //返回值等于0表示关闭成功</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#00b050;">//返回值小于0表示关闭失败</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#0000ff;">if</span>(retvalue &lt; 0)</p> 
<p style="margin-left:.0001pt;text-align:justify;">  {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printf("<span style="color:#984806;">Can't close file %s\r\n</span>", filename);</p> 
<p style="margin-left:.0001pt;text-align:justify;">    <span style="color:#0000ff;">return</span> -1;</p> 
<p style="margin-left:.0001pt;text-align:justify;">  }</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">  <span style="color:#0000ff;">return</span> 0;</p> 
<p style="margin-left:.0001pt;text-align:justify;">}</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">9、Makefile文件如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">KERNELDIR := /home/zgq/linux/atk-mp1/linux/my_linux/linux-5.4.31</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#使用“:=”将其后面的字符串赋值给KERNELDIR</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">CURRENT_PATH := $(shell pwd)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#采用“shell pwd”获取当前打开的路径</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#使用“$(变量名)”引用“变量的值”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">MyAPP := LED_APP</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">My</span><span style="color:#0000ff;">Gpio</span><span style="color:#0000ff;">LED_Module-objs = LEDInterface.o LED.o</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">obj-m := My</span><span style="color:#0000ff;">Gpio</span><span style="color:#0000ff;">LED_Module.o</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">CC := arm-none-linux-gnueabihf-gcc</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">drv</span>:</p> 
<p style="margin-left:.0001pt;text-align:justify;">$(MAKE) -C $(KERNELDIR) M=$(CURRENT_PATH) modules</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">app</span>:</p> 
<p style="margin-left:.0001pt;text-align:justify;">$(CC)  $(MyAPP).c  -o $(MyAPP)</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">clean</span>:</p> 
<p style="margin-left:.0001pt;text-align:justify;">$(MAKE) -C $(KERNELDIR) M=$(CURRENT_PATH) clean</p> 
<p style="margin-left:.0001pt;text-align:justify;">rm $(MyAPP)</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">install</span>:</p> 
<p style="margin-left:.0001pt;text-align:justify;">sudo cp *.ko $(MyAPP) /home/zgq/linux/nfs/rootfs/lib/modules/5.4.31/ -f</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">10、<span style="color:#000000;">添加“</span><span style="color:#0070c0;">c_cpp_properties.json</span><span style="color:#000000;">”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">按下“Ctrl+Shift+P”,打开VSCode控制台，然后输入“<span style="color:#ff0000;">C/C++:Edit Configurations(JSON)</span>”,打开以后会自动在“<span style="color:#0070c0;">.vscode </span>”目录下生成一个名为“<span style="color:#0070c0;">c_cpp_properties.json</span>” 的文件。</p> 
<p style="margin-left:.0001pt;text-align:justify;">修改<span style="color:#0070c0;">c_cpp_properties.json</span>内容如下所示:</p> 
<p style="margin-left:.0001pt;text-align:justify;">{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    "configurations": [</p> 
<p style="margin-left:.0001pt;text-align:justify;">        {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">            "name": "Linux",</p> 
<p style="margin-left:.0001pt;text-align:justify;">            "includePath": [</p> 
<p style="margin-left:.0001pt;text-align:justify;">                "${workspaceFolder}/**",</p> 
<p style="margin-left:.0001pt;text-align:justify;">                <span style="color:#984806;">"/home/zgq/linux/atk-mp1/linux/my_linux/linux-5.4.31",</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">                "/home/zgq/linux/Linux_Drivers/My</span><span style="color:#984806;">Gpio</span><span style="color:#984806;">LED", </span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">                "/home/zgq/linux/atk-mp1/linux/my_linux/linux-5.4.31/arch/arm/include",</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">                "/home/zgq/linux/atk-mp1/linux/my_linux/linux-5.4.31/include",</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#984806;">                "/home/zgq/linux/atk-mp1/linux/my_linux/linux-5.4.31/arch/arm/include/generated"</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">            ],</p> 
<p style="margin-left:.0001pt;text-align:justify;">            "defines": [],</p> 
<p style="margin-left:.0001pt;text-align:justify;">            "compilerPath": "/usr/bin/gcc",</p> 
<p style="margin-left:.0001pt;text-align:justify;">            "cStandard": "gnu11",</p> 
<p style="margin-left:.0001pt;text-align:justify;">            "cppStandard": "gnu++14",</p> 
<p style="margin-left:.0001pt;text-align:justify;">            "intelliSenseMode": "gcc-x64"</p> 
<p style="margin-left:.0001pt;text-align:justify;">        }</p> 
<p style="margin-left:.0001pt;text-align:justify;">    ],</p> 
<p style="margin-left:.0001pt;text-align:justify;">    "version": 4</p> 
<p style="margin-left:.0001pt;text-align:justify;">}</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">11、编译</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">make clean回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">make drv回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">make app回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">make install回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">ls /home/zgq/linux/nfs/rootfs/lib/modules/5.4.31/ -l回车</span>”产看是存在“<span style="color:#ff0000;">LED_APP和MyDtsLED_Module.ko</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="1086" src="https://images2.imgbox.com/06/08/2TypjgLZ_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">12、测试</p> 
<p style="margin-left:.0001pt;text-align:justify;">启动开发板，从网络下载程序</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">root</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">cd /lib/modules/5.4.31/回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">切换到“/<span style="color:#0070c0;">lib/modules/5.4.31/</span>”目录</p> 
<p style="margin-left:.0001pt;text-align:justify;">注意：“<span style="color:#0070c0;">lib/modules/5.4.31/</span>”<span style="color:#ff0000;">在虚拟机中是位于“/home/zgq/linux/nfs/rootfs/”目录下，但在开发板中，却是位于根目录中</span>。</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">ls -l</span>”查看“MyGpioLED_Module<span style="color:#00b0f0;">.ko和LED_APP</span>”是否存在</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">depmod</span>”,驱动在第一次执行时，需要运行“depmod”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">modprobe MyGpioLED_Module.ko</span>”，加载“<span style="color:#ff0000;">MyGpioLED_Module.ko</span>”模块</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">输入“</span><span style="color:#ff0000;">lsmod</span><span style="color:#000000;">”查看有哪些驱动在工作</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">ls </span><span style="color:#00b0f0;">/dev/</span><span style="color:#ff0000;">MyGpioLEDName -l回车</span>”，发现节点文件“<span style="color:#00b0f0;">/dev/</span><span style="color:#ff0000;">MyGpioLEDName</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">./</span><span style="color:#00b0f0;">LED_APP</span><span style="color:#ff0000;"> /dev/MyGpioLEDName 1回车</span>”执行开灯</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">./</span><span style="color:#00b0f0;">LED_APP</span><span style="color:#ff0000;"> /dev/MyGpioLEDName 0回车</span>”执行关灯</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#7030a0;">rmmod MyGpioLED_Module</span><span style="color:#00b050;">.ko</span>”，卸载“MyGpioLED_Module<span style="color:#00b050;">.ko</span>”模块</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">注意:输入“rmmod MyGpioLED_Module”也可以卸载“MyGpioLED_Module.ko”模块</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">输入“</span><span style="color:#ff0000;">lsmod</span><span style="color:#000000;">”查看有哪些驱动在工作。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">ls </span><span style="color:#00b0f0;">/dev/</span><span style="color:#ff0000;">MyGpioLEDName -l回车</span>”，查询节点文件“<span style="color:#00b0f0;">/dev/</span><span style="color:#ff0000;">MyGpioLEDName</span>”是否存在</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="1200" src="https://images2.imgbox.com/28/ba/9GBHp5Og_o.png" width="1063"></p> 
<p style="margin-left:.0001pt;text-align:justify;">LED点灯的四种方法测试小结：</p> 
<p style="margin-left:.0001pt;text-align:justify;">1、旧字符设备下的点灯，采用的是静态设备号，可以理解教学的用心。</p> 
<p style="margin-left:.0001pt;text-align:justify;">2、新字符设备下的点灯，采用的动态设备号，是一种进步。</p> 
<p style="margin-left:.0001pt;text-align:justify;">3、设备树下的点灯，新意有一点，意义不太大。</p> 
<p style="margin-left:.0001pt;text-align:justify;">4、gpio子系统下的点灯，才是我们要掌握的字符驱动开发方法。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b6b3c0c2241eed4c01bcdf93a1754179/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C#请假加班案例（二）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/39f6c7c404f85aa6a21af9fca6456e1d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux第75步_pinctrl子系统驱动和gpio子系统的常用函数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>