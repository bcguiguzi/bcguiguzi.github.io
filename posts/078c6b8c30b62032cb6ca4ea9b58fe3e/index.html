<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android P适配以太网功能开发指南 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android P适配以太网功能开发指南" />
<meta property="og:description" content="Android P适配以太网功能开发指南 Android网络框架分析系列文章目录：
Android P适配以太网功能开发指南
Android以太网框架情景分析之启动简介
Android以太网框架情景分析之EthernetServiceImpl和NetworkManagementService交互深入分析
Android以太网框架情景分析之NetworkManagementService和netd交互深入分析二
Android以太网框架情景分析之NetworkManagementService和netd交互深入分析一
Android以太网框架情景分析之NetworkFactory与NetworkAgent深入分析
AsyncChannel原理分析以及实操演练
引言 此时的我吃着火锅唱着歌，进行着Android P(此P非彼P，Android 9)的适配工作。我真的只能说每次Android版本的迭代更新，都是对我们的一次炼狱般的摧残啊，各种适配啊，我真的想说fuck the coding。但是吐槽归吐槽，为了我热爱的coding事业，让我们愉快的适配起来。
注意：本文演示的代码是Android P高通msm8953平台。
一.具体需求和成果展示 1.1 具体需求 具体需求说多不多，说少不少就三个如下：
设置中增加以太网开/关设置设置中增加以太网静态设置设置中增加代理设置 1.2 成果展示 好了需求前面明确了，在正式开始Android P以太网适配的开发指南前，得先让大伙看看最终的成果演示这样大伙才有动力和我一起干不是。
二.需求实施 好了前面说了一大把了，也该正式开干了，不然大伙就要说我是光说不干的花架子了。先放上Android O和Android P的以太网逻辑架构图，有了这个读者心里因该就大概有谱了。不会迷路瞎逛了。
2.1 Android P以太网部分变动 2.1.1 源码文件的增添 在正式开发前，我们一般都应该了解Android新版本对当前实施的需求的改动，Android原生已经对以太网部分有很好的支持了，具体的源码路径在frameworks/opt/net/ethernet/java/com/android/server/ethernet，下面让我们看看Android O和Android P该目录下文件的变化！
Android O(Android 8)此目录下的文件为： [arm-msm8909-user] xxx@pd:~/ssd/xxx/ap/idh.code/frameworks/opt/net/ethernet/java/com/android/server/ethernet$ ls EthernetConfigStore.java EthernetNetworkFactory.java EthernetServiceImpl.java EthernetService.java Android P(Android 9)此目录下的文件为： xxx@Ubuntu16-Model:~/ssd/qcom_64/msm8953-9/frameworks/opt/net/ethernet/java/com/android/server/ethernet$ ls EthernetConfigStore.java EthernetNetworkFactory.java EthernetServiceImpl.java EthernetService.java EthernetTracker.java 这里发现Android P(Android 9)多了EthernetTracker.java区别其他版本，Google新增的类，这个是比较大的改动。
2.1.1 接口参数的变动 有过Android 6/7/8版本开发经验的老司机都知道，Android对以太网的操作主要是依靠EthernetManager这个类来执行，而这个类中最重要的设置以太网信息的方法就是setConfiguration了，让我们来分别看看Android不同版本对这个方法定义的差别！
Android O(Android 8)此方法定义如下： /** * Set Ethernet configuration." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/078c6b8c30b62032cb6ca4ea9b58fe3e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-03T21:36:47+08:00" />
<meta property="article:modified_time" content="2020-07-03T21:36:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android P适配以太网功能开发指南</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="font_faceCourier_NewemspemspemspemspemspemspemspemspAndroid_P_0"></a><font face="Courier New">        Android P适配以太网功能开发指南</font></h2> 
<br> 
<p><font face="Courier New">Android网络框架分析系列文章目录：</font></p> 
<blockquote> 
 <p><a href="https://editor.csdn.net/md/?articleId=105725133" rel="nofollow"><font size="3" face="Courier New">Android P适配以太网功能开发指南</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/107209641"><font size="3" face="Courier New">Android以太网框架情景分析之启动简介</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/107836221"><font size="3" face="Courier New">Android以太网框架情景分析之EthernetServiceImpl和NetworkManagementService交互深入分析</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/107814419"><font size="3" face="Courier New">Android以太网框架情景分析之NetworkManagementService和netd交互深入分析二</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/107762121"><font size="3" face="Courier New">Android以太网框架情景分析之NetworkManagementService和netd交互深入分析一</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/107363504"><font size="3" face="Courier New">Android以太网框架情景分析之NetworkFactory与NetworkAgent深入分析</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/107426006"><font size="3" face="Courier New">AsyncChannel原理分析以及实操演练</font></a></p> 
</blockquote> 
<hr> 
<br> 
<h3><a id="font_faceCourier_New_19"></a><font face="Courier New">引言</font></h3> 
<p><font face="Courier New">  此时的我吃着火锅唱着歌，进行着Android P(此P非彼P，Android 9)的适配工作。我真的只能说每次Android版本的迭代更新，都是对我们的一次炼狱般的摧残啊，各种适配啊，我真的想说fuck the coding。但是吐槽归吐槽，为了我热爱的coding事业，让我们愉快的适配起来。</font></p> 
<p><font face="Courier New"><strong>注意</strong>：本文演示的代码是Android P高通msm8953平台。</font></p> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_New_32"></a><font face="Courier New">一.具体需求和成果展示</font></h3> 
<br> 
<h4><a id="font_faceCourier_New_11__35"></a><font face="Courier New"> 1.1 具体需求</font></h4> 
<p><font face="Courier New">具体需求说多不多，说少不少就三个如下：</font></p> 
<ul><li><font face="Courier New">设置中增加以太网开/关设置</font></li><li><font face="Courier New">设置中增加以太网静态设置</font></li><li><font face="Courier New">设置中增加代理设置</font></li></ul> 
<br> 
<h4><a id="font_faceCourier_New_12__46"></a><font face="Courier New"> 1.2 成果展示</font></h4> 
<p><font face="Courier New">好了需求前面明确了，在正式开始Android P以太网适配的开发指南前，得先让大伙看看最终的成果演示这样大伙才有动力和我一起干不是。<br> <img src="https://images2.imgbox.com/a5/31/5HI6evQh_o.gif" alt="在这里插入图片描述"></font></p> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_New_60"></a><font face="Courier New">二.需求实施</font></h3> 
<p><font face="Courier New">好了前面说了一大把了，也该正式开干了，不然大伙就要说我是光说不干的花架子了。先放上Android O和Android P的以太网逻辑架构图，有了这个读者心里因该就大概有谱了。不会迷路瞎逛了。<br> <img src="https://images2.imgbox.com/e8/02/eakbfI8B_o.png" alt="在这里插入图片描述"></font></p> 
<br> 
<h4><a id="font_faceCourier_New21_Android_P_67"></a><font face="Courier New">2.1 Android P以太网部分变动</font></h4> 
<h5><a id="font_faceCourier_New211__68"></a><font face="Courier New">2.1.1 源码文件的增添</font></h5> 
<p><font face="Courier New">在正式开发前，我们一般都应该了解Android新版本对当前实施的需求的改动，Android原生已经对以太网部分有很好的支持了，具体的源码路径在frameworks/opt/net/ethernet/java/com/android/server/ethernet，下面让我们看看Android O和Android P该目录下文件的变化！</font></p> 
<ul><li><font face="Courier New">Android O(Android 8)此目录下的文件为：</font></li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>arm-msm8909-user<span class="token punctuation">]</span> xxx@pd:~/ssd/xxx/ap/idh.code/frameworks/opt/net/ethernet/java/com/android/server/ethernet$ <span class="token function">ls</span> 
EthernetConfigStore.java  EthernetNetworkFactory.java  EthernetServiceImpl.java  EthernetService.java
</code></pre> 
<ul><li><font face="Courier New">Android P(Android 9)此目录下的文件为：</font></li></ul> 
<pre><code class="prism language-bash">xxx@Ubuntu16-Model:~/ssd/qcom_64/msm8953-9/frameworks/opt/net/ethernet/java/com/android/server/ethernet$ <span class="token function">ls</span>
EthernetConfigStore.java  EthernetNetworkFactory.java  EthernetServiceImpl.java  EthernetService.java  EthernetTracker.java
</code></pre> 
<p><font face="Courier New">这里发现Android P(Android 9)多了EthernetTracker.java区别其他版本，Google新增的类，这个是比较大的改动。</font></p> 
<h5><a id="font_faceCourier_New211__88"></a><font face="Courier New">2.1.1 接口参数的变动</font></h5> 
<p><font face="Courier New">有过Android 6/7/8版本开发经验的老司机都知道，Android对以太网的操作主要是依靠EthernetManager这个类来执行，而这个类中最重要的设置以太网信息的方法就是setConfiguration了，让我们来分别看看Android不同版本对这个方法定义的差别！</font></p> 
<ul><li><font face="Courier New">Android O(Android 8)此方法定义如下：</font></li></ul> 
<pre><code class="prism language-java">    <span class="token comment">/** 
     * Set Ethernet configuration.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setConfiguration</span><span class="token punctuation">(</span>IpConfiguration config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            mService<span class="token punctuation">.</span><span class="token function">setConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span> 
</code></pre> 
<ul><li><font face="Courier New">Android P(Android 9)此方法定义如下：</font></li></ul> 
<pre><code class="prism language-java">```java
    <span class="token comment">/** 
     * Set Ethernet configuration.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setConfiguration</span><span class="token punctuation">(</span>String iface<span class="token punctuation">,</span> IpConfiguration config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            mService<span class="token punctuation">.</span><span class="token function">setConfiguration</span><span class="token punctuation">(</span>iface<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span>  
</code></pre> 
<p><font face="Courier New"> 对比发现了什么，多了一个参数String iface，这个参数的意思是什么呢，即我们通常看到的设备网口名称，譬如eth0，我们可以通过命令 ifconfig 可以看到你设备下的所有网口名称，这个eth0怎么来的我们后续会讲解。</font></p> 
<pre><code class="prism language-bash">130<span class="token operator">|</span>console:/ <span class="token comment"># ifconfig</span>
dummy0    Link encap:Ethernet  HWaddr 62:df:e7:bb:49:0f
          inet6 addr: fe80::60df:e7ff:febb:490f/64 Scope: Link
          UP BROADCAST RUNNING NOARP  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0 
          TX packets:8 errors:0 dropped:0 overruns:0 carrier:0 
          collisions:0 txqueuelen:1000 
          RX bytes:0 TX bytes:560 

rmnet_ipa0 Link encap:UNSPEC  
          UP RUNNING  MTU:2000  Metric:1
          RX packets:8 errors:0 dropped:0 overruns:0 frame:0 
          TX packets:17 errors:0 dropped:0 overruns:0 carrier:0 
          collisions:0 txqueuelen:1000 
          RX bytes:3196 TX bytes:1268 

rmnet_data0 Link encap:UNSPEC  
          inet6 addr: fe80::f265:e5b9:fecd:242c/64 Scope: Link
          UP RUNNING  MTU:2000  Metric:1
          RX packets:19 errors:0 dropped:0 overruns:0 frame:0 
          TX packets:17 errors:0 dropped:0 overruns:0 carrier:0 
          collisions:0 txqueuelen:1000 
          RX bytes:2968 TX bytes:1132 

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0 
          inet6 addr: ::1/128 Scope: Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0 
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 
          collisions:0 txqueuelen:1 
          RX bytes:0 TX bytes:0 

eth0      Link encap:Ethernet  HWaddr 00:80:0f:11:70:00  Driver smsc9500
          inet addr:172.16.151.22  Bcast:172.16.151.255  Mask:255.255.255.0 
          inet6 addr: fe80::56e0:5755:28c3:6270/64 Scope: Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:7812 errors:0 dropped:0 overruns:0 frame:0 
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 
          collisions:0 txqueuelen:1000 
          RX bytes:507092 TX bytes:0 
</code></pre> 
<br> 
<h4><a id="font_faceCourier_New22_AppSettings_175"></a><font face="Courier New">2.2 App层Settings修改</font></h4> 
<p><font face="Courier New">Settings中的修改不是本文的重点，这个和以前的逻辑Android版本的添加几乎可以保持不变，只是对所有的相关接口多添加一个String iface参数即可，可以参见如下代码，实际UI效果如下 :<br> <img src="https://images2.imgbox.com/54/ba/fTnqKDlT_o.png" alt="在这里插入图片描述"></font></p> 
<br> 
<h4><a id="font_faceCourier_New23_Framework_181"></a><font face="Courier New">2.3 Framework的适配</font></h4> 
<p><font face="Courier New">这个是本文的重点，当然前提得驱动的同事已经将有线网络的驱动加载OK了。怎么判断驱动OK了呢，一般就是插上网线然后状态栏上会有如下截图一个小角图标显示，并且在终端下面能发现/sys/class/net/eth0的节点。</font></p> 
<p><img src="https://images2.imgbox.com/a1/e0/qkmyFRWe_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="font_faceCourier_New231_EthernetServiceSystemServiceManager_186"></a><font face="Courier New">2.3.1 EthernetService加入SystemServiceManager并启动</font></h5> 
<p><font face="Courier New">参见framework/base/services/java/com/android/server/SystemServer.java的代码，将EthernetService加入SystemServiceManager管理，并启动。这里不做过多介绍，因为这个篇章的重点不是这个。</font></p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String ETHERNET_SERVICE_CLASS <span class="token operator">=</span>
            <span class="token string">"com.android.server.ethernet.EthernetService"</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPackageManager<span class="token punctuation">.</span><span class="token function">hasSystemFeature</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>FEATURE_ETHERNET<span class="token punctuation">)</span> <span class="token operator">||</span>
                mPackageManager<span class="token punctuation">.</span><span class="token function">hasSystemFeature</span><span class="token punctuation">(</span>PackageManager<span class="token punctuation">.</span>FEATURE_USB_HOST<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">traceBeginAndSlog</span><span class="token punctuation">(</span><span class="token string">"StartEthernet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mSystemServiceManager<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>ETHERNET_SERVICE_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

</code></pre> 
<h5><a id="font_faceCourier_New232_EthernetService_203"></a><font face="Courier New">2.3.2 EthernetService介绍</font></h5> 
<p><font face="Courier New">先来看下核心服务frameworks\opt\net\ethernet\java\com\android\server\ethernet\EthernetService.java，代码如下所示：</font></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">EthernetService</span> <span class="token keyword">extends</span> <span class="token class-name">SystemService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"EthernetService"</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> EthernetServiceImpl mImpl<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">EthernetService</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EthernetServiceImpl</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Registering service "</span> <span class="token operator">+</span> Context<span class="token punctuation">.</span>ETHERNET_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">publishBinderService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>ETHERNET_SERVICE<span class="token punctuation">,</span> mImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onBootPhase</span><span class="token punctuation">(</span><span class="token keyword">int</span> phase<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>phase <span class="token operator">==</span> SystemService<span class="token punctuation">.</span>PHASE_SYSTEM_SERVICES_READY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mImpl<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span>   
<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">这段代码非常简单，EthernetService 继承了系统服务，那自然也就是系统服务，这个会加载在system_server中启动，在该类中调用 EthernetServiceImpl 的 start()，我们继续接着看看。</font></p> 
<h5><a id="font_faceCourier_New233_EthernetServiceImpl__233"></a><font face="Courier New">2.3.3 EthernetServiceImpl 介绍</font></h5> 
<p><font face="Courier New">该文件所在源码目录为frameworks/opt/net/ethernet/java/com/android/server/ethernet/EthernetServiceImpl.java，让我们看看主要做了些啥。</font></p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Starting Ethernet service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        HandlerThread handlerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HandlerThread</span><span class="token punctuation">(</span><span class="token string">"EthernetServiceThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handlerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>handlerThread<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mTracker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EthernetTracker</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> mHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mTracker<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mStarted<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
</code></pre> 
<p><font face="Courier New">主要创建了 EthernetTracker，这个类是 9.0 中新增出来的，用于监听以太网的切换、以太网判断当前网络是否可用等一系列操作。之前 8.1 中都集成在 <strong>EthernetNetworkFactory</strong> 中，这个是Android P的主要差别，继续跟进。</font></p> 
<h5><a id="font_faceCourier_New233_EthernetTracker_253"></a><font face="Courier New">2.3.3 EthernetTracker介绍</font></h5> 
<p><font face="Courier New">关于以太网初始化和基本操作基本集中在这个类里面了，取代了Android P之前EthernetNetworkFactory的部分功能。该文件的源码位置为frameworks\opt\net\ethernet\java\com\android\server\ethernet\EthernetTracker.java。</font></p> 
<pre><code class="prism language-java">    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mConfigStore<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Default interface is just the first one we want to track.</span>
        mIpConfigForDefaultInterface <span class="token operator">=</span> mConfigStore<span class="token punctuation">.</span><span class="token function">getIpConfigurationForDefaultInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ArrayMap<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> IpConfiguration<span class="token punctuation">&gt;</span></span> configs <span class="token operator">=</span> mConfigStore<span class="token punctuation">.</span><span class="token function">getIpConfigurations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> configs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mIpConfigurations<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>configs<span class="token punctuation">.</span><span class="token function">keyAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> configs<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>   

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            mNMService<span class="token punctuation">.</span><span class="token function">registerObserver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InterfaceObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Could not register InterfaceObserver "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>   

        mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span><span class="token operator">:</span>trackAvailableInterfaces<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
</code></pre> 
<p><font face="Courier New">在EthernetTracker通过ConcurrentHashMap&lt;String, IpConfiguration&gt; mIpConfigurations这个表来管理保存的 IpConfigStore 信息，那么这个Map的初识值从那里来的呢，主要如下两个地方：</font></p> 
<ul><li><font face="Courier New">EthernetConfigStore 中存储的信息，EthernetConfigStore 中通过读取 /misc/ethernet/ipconfig.txt</font></li><li><font face="Courier New"> 获取interfaceConfigs 的信息，在 EthernetTracker 的构造方法中通过解析 config_ethernet_interfaces 字符串也可向 Map 中添加初始信息。</font></li></ul> 
<pre><code class="prism language-java">    <span class="token function">EthernetTracker</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Handler handler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mHandler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
        <span class="token comment">// The services we use.</span>
        IBinder b <span class="token operator">=</span> ServiceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>NETWORKMANAGEMENT_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mNMService <span class="token operator">=</span> INetworkManagementService<span class="token punctuation">.</span>Stub<span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Interface match regex.</span>
        mIfaceMatch <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>config_ethernet_iface_regex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Read default Ethernet interface configuration from resources</span>
        <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> interfaceConfigs <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span>
                com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>R<span class="token punctuation">.</span>array<span class="token punctuation">.</span>config_ethernet_interfaces<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String strConfig <span class="token operator">:</span> interfaceConfigs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">parseEthernetConfig</span><span class="token punctuation">(</span>strConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mConfigStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EthernetConfigStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        NetworkCapabilities nc <span class="token operator">=</span> <span class="token function">createNetworkCapabilities</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment">/* clear default capabilities */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EthernetNetworkFactory</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> context<span class="token punctuation">,</span> nc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mFactory<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseEthernetConfig</span><span class="token punctuation">(</span>String configString<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> tokens <span class="token operator">=</span> configString<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String name <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        String capabilities <span class="token operator">=</span> tokens<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> tokens<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
        NetworkCapabilities nc <span class="token operator">=</span> <span class="token function">createNetworkCapabilities</span><span class="token punctuation">(</span>
                <span class="token operator">!</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>capabilities<span class="token punctuation">)</span>  <span class="token comment">/* clear default capabilities */</span><span class="token punctuation">,</span> capabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mNetworkCapabilities<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> nc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tokens<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>tokens<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            IpConfiguration ipConfig <span class="token operator">=</span> <span class="token function">parseStaticIpConfiguration</span><span class="token punctuation">(</span>tokens<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mIpConfigurations<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> ipConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 

</code></pre> 
<p><font face="Courier New">让我们看看config_ethernet_interfaces的取值从哪里看，具体位置如下frameworks/base/core/res/res/values/config.xml具体代码如下：</font></p> 
<pre><code class="prism language-java">    <span class="token operator">&lt;</span>string<span class="token operator">-</span>array translatable<span class="token operator">=</span><span class="token string">"false"</span> name<span class="token operator">=</span><span class="token string">"config_ethernet_interfaces"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 
        <span class="token generics function"><span class="token punctuation">&lt;</span>item<span class="token punctuation">&gt;</span></span>eth1<span class="token punctuation">;</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">;</span>ip<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.10</span><span class="token operator">/</span><span class="token number">24</span> gateway<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span> dns<span class="token operator">=</span><span class="token number">4.4</span><span class="token number">.4</span><span class="token number">.4</span><span class="token punctuation">,</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span><span class="token operator">&lt;</span><span class="token operator">/</span>item<span class="token operator">&gt;</span>
        <span class="token generics function"><span class="token punctuation">&lt;</span>item<span class="token punctuation">&gt;</span></span>eth2<span class="token punctuation">;</span><span class="token punctuation">;</span>ip<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.11</span><span class="token operator">/</span><span class="token number">24</span><span class="token operator">&lt;</span><span class="token operator">/</span>item<span class="token operator">&gt;</span>
        <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>string<span class="token operator">-</span>array<span class="token operator">&gt;</span>

</code></pre> 
<p><font face="Courier New">这里就给各位解释了iface这个参数的由来了。</font></p> 
<h5><a id="font_faceCourier_New234__337"></a><font face="Courier New">2.3.4 增加以太网打开/关闭接口</font></h5> 
<p><font face="Courier New">在EthernetTracker.文件中添加如下两个接口如下所示，即打开和关闭以太网接口，至于怎么从EthernetManager调用到EthernetTracker的逻辑就不细说了，各位可以看我最后上传的patch包即可。</font></p> 
<pre><code class="prism language-java"><span class="token comment">/**
	state
	true 开启以太网
	false 关闭以太网
**/</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">setInterfaceStatus</span><span class="token punctuation">(</span>String iface<span class="token punctuation">,</span> <span class="token keyword">boolean</span> state<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
         <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>iface<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">)</span>
                    mNMService<span class="token punctuation">.</span><span class="token function">setInterfaceDown</span><span class="token punctuation">(</span>iface<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> 
                    mNMService<span class="token punctuation">.</span><span class="token function">setInterfaceUp</span><span class="token punctuation">(</span>iface<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"iface is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>   
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Error setInterfaceStatus : "</span> <span class="token operator">+</span> iface <span class="token operator">+</span> <span class="token string">" state : "</span> <span class="token operator">+</span> state <span class="token operator">+</span> <span class="token string">" exception : "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>   
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>  
</code></pre> 
<h5><a id="font_faceCourier_New235_Mac_366"></a><font face="Courier New">2.3.5 增加以太网状态判断和Mac接口</font></h5> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> String <span class="token function">getEthMacAddress</span><span class="token punctuation">(</span>String iface<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        InterfaceConfiguration config <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment">// Bring up the interface so we get link status indications.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            config <span class="token operator">=</span> mNMService<span class="token punctuation">.</span><span class="token function">getInterfaceConfig</span><span class="token punctuation">(</span>iface<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> <span class="token operator">|</span> IllegalStateException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Either the system is crashing or the interface has disappeared. Just ignore the</span>
            <span class="token comment">// error; we haven't modified any state because we only do that if our calls succeed.</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Error upping interface "</span> <span class="token operator">+</span> iface<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Null interface config for "</span> <span class="token operator">+</span> iface <span class="token operator">+</span> <span class="token string">". Bailing out."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> String hwAddress <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getHardwareAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> hwAddress<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getEthIfaceState</span><span class="token punctuation">(</span>String mIface<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//return mTracker.getEthIfaceState(iface);</span>
        <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
            File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"/sys/class/net/"</span><span class="token operator">+</span>mIface<span class="token operator">+</span><span class="token string">"/flags"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> EthernetManager<span class="token punctuation">.</span>ETH_IFACE_STATE_DOWN<span class="token punctuation">;</span>
            FileInputStream fin<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            BufferedReader reader<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>fin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String flag <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"mIface : "</span> <span class="token operator">+</span> mIface<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fin<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            flag <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> flag_int <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flag_int <span class="token operator">&amp;</span> <span class="token number">0x1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> EthernetManager<span class="token punctuation">.</span>ETH_IFACE_STATE_UP<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> EthernetManager<span class="token punctuation">.</span>ETH_IFACE_STATE_DOWN<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> EthernetManager<span class="token punctuation">.</span>ETH_IFACE_STATE_DOWN<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="font_faceCourier_New235_IPip_415"></a><font face="Courier New">2.3.5 增加以太网静态IP设置接口，并解决拔插后才能更改ip地址</font></h5> 
<p><font face="Courier New">以太网静态接口设置，主要是调用EthernetManager类里面的setConfiguration方法进行参数配置。我们看一下这个方法具体做了什么操作。</font></p> 
<pre><code class="prism language-java"> <span class="token comment">/**
     * Set Ethernet configuration.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setConfiguration</span><span class="token punctuation">(</span>String iface<span class="token punctuation">,</span> IpConfiguration config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            mService<span class="token punctuation">.</span><span class="token function">setConfiguration</span><span class="token punctuation">(</span>iface<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">发现是通过mService.setConfiguration（）方法。那么这个mService是哪里传来的呢，都是老司机就不买弄了，这里的mService是EthernetServiceImpl ，让我们看看该代码：</font></p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setConfiguration</span><span class="token punctuation">(</span>String iface<span class="token punctuation">,</span> IpConfiguration config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mStarted<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"System isn't ready enough to change ethernet configuration"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>   

        <span class="token function">enforceConnectivityInternalPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mTracker<span class="token punctuation">.</span><span class="token function">isRestrictedInterface</span><span class="token punctuation">(</span>iface<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">enforceUseRestrictedNetworksPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>   

        <span class="token comment">// TODO: this does not check proxy settings, gateways, etc.</span>
        <span class="token comment">// Fix this by making IpConfiguration a complete representation of static configuration.</span>
        mTracker<span class="token punctuation">.</span><span class="token function">updateIpConfiguration</span><span class="token punctuation">(</span>iface<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IpConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">上面是Android 9.0中的方法实现。这里就是我花了一段时间解决的为什么Android P设置了静态IP不立即生效的地方。我们看一下Android 8.0之前的版本是这个方法是怎么写的，这个地方是关键。</font></p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setConfiguration</span><span class="token punctuation">(</span>IpConfiguration config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mStarted<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"System isn't ready enough to change ethernet configuration"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>   

        <span class="token function">enforceConnectivityInternalPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mIpConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mEthernetConfigStore<span class="token punctuation">.</span><span class="token function">writeIpAndProxyConfigurations</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// TODO: this does not check proxy settings, gateways, etc.</span>
            <span class="token comment">// Fix this by making IpConfiguration a complete representation of static configuration.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mIpConfiguration<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mIpConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IpConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mTracker<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mTracker<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> mHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>   
        <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span>  
</code></pre> 
<p><font face="Courier New">我们也是看着都是mTracker对象调用方法进行设置。其实这两个mTracker是不同的对象。在Android 9.0之前的版本，这个mTracker对象都是EthernetNetworkFactory的实例对象。因为后续的设置参数进行连接网络判断端口等一系列操作都在这个EthernetNetworkFactory类中完成。而在Android9.0及以后后，Google将他们抽离出来了，对于监听以太网切换、以太网判断当前网络是否可用等一些列操作抽离到一个EthernetTracker类中。那么9.0的EthernetNetworkFactory只需要关心拿到参数进行连接上网操作就可以了。</font></p> 
<p><font face="Courier New">我们现在只关心9.0是怎么走的。找到EthernetTracker类的具体实现，可以看到调用了EthernetNetworkFactory中的方法</font></p> 
<pre><code class="prism language-java">    <span class="token keyword">void</span> <span class="token function">updateIpConfiguration</span><span class="token punctuation">(</span>String iface<span class="token punctuation">,</span> IpConfiguration ipConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DBG<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"updateIpConfiguration, iface: "</span> <span class="token operator">+</span> iface <span class="token operator">+</span> <span class="token string">", cfg: "</span> <span class="token operator">+</span> ipConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>   
            
        mConfigStore<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>iface<span class="token punctuation">,</span> ipConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mIpConfigurations<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>iface<span class="token punctuation">,</span> ipConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
        mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> mFactory<span class="token punctuation">.</span><span class="token function">updateIpConfiguration</span><span class="token punctuation">(</span>iface<span class="token punctuation">,</span> ipConfiguration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
</code></pre> 
<p><font face="Courier New">而其实这个方法并没有做任何上网的操作，这就是为什么设置静态IP后，没有变动的原因。</font></p> 
<pre><code class="prism language-java">    <span class="token keyword">void</span> <span class="token function">updateIpConfiguration</span><span class="token punctuation">(</span>String iface<span class="token punctuation">,</span> IpConfiguration ipConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        NetworkInterfaceState network <span class="token operator">=</span> mTrackingInterfaces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>iface<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>network <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            network<span class="token punctuation">.</span><span class="token function">setIpConfig</span><span class="token punctuation">(</span>ipConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//仅仅是将ip地址等以太网参数保存下来。</span>
        <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">这里设置下去仅仅是将参数保存下来，显示是不符合我们的需求的。此时已经可以通过拔插网线实现设置静态ip上网。那么接下来，我们看看正常流程怎么走。</font></p> 
<p><font face="Courier New">还是继续看EthernetTracker类。因为判断能不能连接网络的条件都在这里实现。这里要怎么才能做到设置静态IP后能动态的上网呢，这个可以参见EthernetTracker类，因为一般的正常上网都是从这个类开始的。这里我也不过多讲述其中的过程了，可以参见这篇博客<a href="https://blog.csdn.net/qq_33796069/article/details/101307453">Android 9.0 以太网上网设置静态ip，解决拔插后才能更改ip地址的问题</a><br> 有比较详细的讲解，最后我们的解决方法是EthernetServiceImpl中添加如下逻辑即可代码如下所示：</font></p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setConfiguration</span><span class="token punctuation">(</span>String iface<span class="token punctuation">,</span> IpConfiguration config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mStarted<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"System isn't ready enough to change ethernet configuration"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>   

        <span class="token function">enforceConnectivityInternalPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mTracker<span class="token punctuation">.</span><span class="token function">isRestrictedInterface</span><span class="token punctuation">(</span>iface<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">enforceUseRestrictedNetworksPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>   

        <span class="token comment">// TODO: this does not check proxy settings, gateways, etc.</span>
        <span class="token comment">// Fix this by making IpConfiguration a complete representation of static configuration.</span>
        mTracker<span class="token punctuation">.</span><span class="token function">updateIpConfiguration</span><span class="token punctuation">(</span>iface<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IpConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Add by xxxsz 2020.04.23</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mTracker<span class="token punctuation">.</span><span class="token function">isRestrictedInterface</span><span class="token punctuation">(</span>iface<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">enforceUseRestrictedNetworksPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>   
 
        <span class="token comment">// TODO: this does not check proxy settings, gateways, etc.</span>
        <span class="token comment">// Fix this by making IpConfiguration a complete representation of static configuration.</span>
     
        mTracker<span class="token punctuation">.</span><span class="token function">updateIpConfiguration</span><span class="token punctuation">(</span>iface<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IpConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mTracker<span class="token punctuation">.</span><span class="token function">removeInterface</span><span class="token punctuation">(</span>iface<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清除当前端口</span>
        mTracker<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>  
</code></pre> 
<p><font face="Courier New">收工，over！</font></p> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_New_543"></a><font face="Courier New">结语</font></h3> 
<p><font face="Courier New">各位乡亲们，Android 9的适配以太网就结束了，整的我腰酸背痛啊。Android版本升级之时就是我等受苦之时啊。</font></p> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_New_554"></a><font face="Courier New">写在最后</font></h3> 
<p><font face="Courier New">  <font face="Courier New">好了如上就是<a href="https://editor.csdn.net/md/?articleId=105725133" rel="nofollow">Android P适配以太网功能开发指南</a>的所有，如有问题或者有任何疑问请及时沟通或者交流，也可点个赞或者吐槽一番也是可以的。so goodbye。</font></font></p> 
<p><font face="Courier New"><strong>当然得最后附上终极patch包不是，不然你们又得在背后diss我了</strong>。<br> <a href="https://download.csdn.net/download/tkwxty/12358757">Android P Settings Framework以太网适配path包</a></font></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1ef84c141892d37503f23b7dcdeb7a3f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Codeforces Round #653 (Div. 3) E1. Reading Books (easy version) 题解（模拟）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/93a1cb11b3a8f454498a3d546ffb274f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">计算机网络（三十二）：习题解析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>