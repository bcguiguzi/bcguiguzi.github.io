<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>6.S081的Lab学习——Lab1: Xv6 and Unix utilities - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="6.S081的Lab学习——Lab1: Xv6 and Unix utilities" />
<meta property="og:description" content="文章目录 前言一、启动xv6(难度：Easy)解析： 二、sleep(难度：Easy)解析： 三、pingpong（难度：Easy）解析： 四、Primes(素数，难度：Moderate/Hard)解析： 五、find（难度：Moderate）解析： 六、xargs（难度：Moderate）解析： 总结 前言 一个本硕双非的小菜鸡，备战24年秋招。打算尝试6.S081，将它的Lab逐一实现，并记录期间心酸历程。
代码下载
官方网站：6.S081官方网站
安装方式：
通过 APT 安装 （Debian/Ubuntu）
确保你的 debian 版本运行的是 “bullseye” 或 “sid”（在 ubuntu 上，这可以通过运行 cat /etc/debian_version 来检查），然后运行：
sudo apt-get install git build-essential gdb-multiarch qemu-system-misc gcc-riscv64-linux-gnu binutils-riscv64-linux-gnu （“buster”上的 QEMU 版本太旧了，所以你必须单独获取。
qemu-system-misc 修复
此时此刻，似乎软件包 qemu-system-misc 收到了一个更新，该更新破坏了它与我们内核的兼容性。如果运行 make qemu 并且脚本在 qemu-system-riscv64 -machine virt -bios none -kernel/kernel -m 128M -smp 3 -nographic -drive file=fs.img，if=none，format=raw，id=x0 -device virtio-blk-device，drive=x0，bus=virtio-mmio-bus.0 之后出现挂起
，
则需要卸载该软件包并安装旧版本：
$ sudo apt-get remove qemu-system-misc $ sudo apt-get install qemu-system-misc=1:4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/6f2ba33f84fb809a1b82e7983c8f93ee/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-11T10:32:02+08:00" />
<meta property="article:modified_time" content="2024-03-11T10:32:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">6.S081的Lab学习——Lab1: Xv6 and Unix utilities</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_6" rel="nofollow">前言</a></li><li><a href="#xv6Easy_61" rel="nofollow">一、启动xv6(难度：Easy)</a></li><li><ul><li><a href="#_149" rel="nofollow">解析：</a></li></ul> 
  </li><li><a href="#sleepEasy_163" rel="nofollow">二、sleep(难度：Easy)</a></li><li><ul><li><a href="#_213" rel="nofollow">解析：</a></li></ul> 
  </li><li><a href="#pingpongEasy_254" rel="nofollow">三、pingpong（难度：Easy）</a></li><li><ul><li><a href="#_286" rel="nofollow">解析：</a></li></ul> 
  </li><li><a href="#PrimesModerateHard_359" rel="nofollow">四、Primes(素数，难度：Moderate/Hard)</a></li><li><ul><li><a href="#_400" rel="nofollow">解析：</a></li></ul> 
  </li><li><a href="#findModerate_495" rel="nofollow">五、find（难度：Moderate）</a></li><li><ul><li><a href="#_523" rel="nofollow">解析：</a></li></ul> 
  </li><li><a href="#xargsModerate_599" rel="nofollow">六、xargs（难度：Moderate）</a></li><li><ul><li><a href="#_654" rel="nofollow">解析：</a></li></ul> 
  </li><li><a href="#_741" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_6"></a>前言</h2> 
<p>一个本硕双非的小菜鸡，备战24年秋招。打算尝试6.S081，将它的Lab逐一实现，并记录期间心酸历程。<br> <a href="https://gitee.com/deepseawhale/6.---s081s---lab-learning/tree/master" rel="nofollow">代码下载</a></p> 
<p>官方网站：<a href="https://pdos.csail.mit.edu/6.S081/2020/schedule.html" rel="nofollow">6.S081官方网站</a></p> 
<p>安装方式：<br> 通过 APT 安装 （Debian/Ubuntu）<br> 确保你的 debian 版本运行的是 “bullseye” 或 “sid”（在 ubuntu 上，这可以通过运行 cat /etc/debian_version 来检查），然后运行：</p> 
<pre><code class="prism language-c">sudo apt<span class="token operator">-</span>get install git build<span class="token operator">-</span>essential gdb<span class="token operator">-</span>multiarch qemu<span class="token operator">-</span>system<span class="token operator">-</span>misc gcc<span class="token operator">-</span>riscv64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu binutils<span class="token operator">-</span>riscv64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu 
</code></pre> 
<p>（“buster”上的 QEMU 版本太旧了，所以你必须单独获取。</p> 
<p>qemu-system-misc 修复<br> 此时此刻，似乎软件包 qemu-system-misc 收到了一个更新，该更新破坏了它与我们内核的兼容性。如果运行 make qemu 并且脚本在 qemu-system-riscv64 -machine virt -bios none -kernel/kernel -m 128M -smp 3 -nographic -drive file=fs.img，if=none，format=raw，id=x0 -device virtio-blk-device，drive=x0，bus=virtio-mmio-bus.0 之后出现挂起<br> ，<br> 则需要卸载该软件包并安装旧版本：</p> 
<pre><code class="prism language-c">  $ sudo apt<span class="token operator">-</span>get remove qemu<span class="token operator">-</span>system<span class="token operator">-</span>misc
  $ sudo apt<span class="token operator">-</span>get install qemu<span class="token operator">-</span>system<span class="token operator">-</span>misc<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">4.2</span><span class="token operator">-</span><span class="token number">3u</span>buntu6
</code></pre> 
<p>在 Arch 上安装</p> 
<pre><code class="prism language-c">sudo pacman <span class="token operator">-</span>S riscv64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">-</span>binutils riscv64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">-</span>gcc riscv64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">-</span>gdb qemu<span class="token operator">-</span>arch<span class="token operator">-</span>extra
</code></pre> 
<p>测试您的安装<br> 若要测试安装，应能够检查以下内容：</p> 
<pre><code class="prism language-c">$ riscv64<span class="token operator">-</span>unknown<span class="token operator">-</span>elf<span class="token operator">-</span>gcc <span class="token operator">--</span>version
riscv64<span class="token operator">-</span>unknown<span class="token operator">-</span>elf<span class="token operator">-</span><span class="token function">gcc</span> <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span> <span class="token number">10.1</span><span class="token number">.0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

$ qemu<span class="token operator">-</span>system<span class="token operator">-</span>riscv64 <span class="token operator">--</span>version
QEMU emulator version <span class="token number">5.1</span><span class="token number">.0</span>
</code></pre> 
<p>您还应该能够编译并运行 xv6： 要退出 qemu，请键入：Ctrl-a x。</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">in</span> <span class="token expression">the xv6 directory</span></span>
$ make qemu
# <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> lots of output <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
init<span class="token operator">:</span> starting sh
$
</code></pre> 
<hr> 
<h2><a id="xv6Easy_61"></a>一、启动xv6(难度：Easy)</h2> 
<p>获取实验室的xv6源代码并切换到util分支</p> 
<pre><code class="prism language-cpp">$ git clone git<span class="token operator">:</span><span class="token comment">//g.csail.mit.edu/xv6-labs-2020</span>
Cloning into <span class="token char">'xv6-labs-2020'</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
$ cd xv6<span class="token operator">-</span>labs<span class="token operator">-</span><span class="token number">2020</span>
$ git checkout util
Branch <span class="token char">'util'</span> set up to track remote branch <span class="token char">'util'</span> from <span class="token char">'origin'</span><span class="token punctuation">.</span>
Switched to a <span class="token keyword">new</span> branch <span class="token char">'util'</span>

</code></pre> 
<p>Xv6-labs-2020存储库与本书的xv6-riscv稍有不同;它主要添加一些文件。如果你好奇的话，可以执行git log:</p> 
<pre><code class="prism language-c">$ git log
</code></pre> 
<p>您将需要使用Git版本控制系统管理和提交文件以及后续的实验室作业。接下来，切换到一个分支(执行git checkout util)，其中包含针对该实验室定制的xv6版本。要了解关于Git的更多信息，请查看Git用户手册。Git允许您跟踪对代码所做的更改。例如，如果你完成了其中一个练习，并且想检查你的进度，你可以通过运行以下命令来提交你的变化:</p> 
<pre><code class="prism language-c">$ git commit <span class="token operator">-</span>am 'my solution <span class="token keyword">for</span> util lab exercise <span class="token number">1</span>'
Created commit <span class="token number">60</span>d2135<span class="token operator">:</span> my solution <span class="token keyword">for</span> util lab exercise <span class="token number">1</span>
 <span class="token number">1</span> files changed<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token function">insertions</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token function">deletions</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">)</span>
$

</code></pre> 
<p>您可以使用git diff命令跟踪您的更改。运行git diff将显示自上次提交以来对代码的更改，git diff origin/util将显示相对于初始xv6-labs-2020代码的更改。这里，origin/xv6-labs-2020是git分支的名称，它是包含您下载的初始代码分支。</p> 
<p>构建并运行xv6</p> 
<pre><code class="prism language-c">$ make qemu
riscv64<span class="token operator">-</span>unknown<span class="token operator">-</span>elf<span class="token operator">-</span>gcc    <span class="token operator">-</span>c <span class="token operator">-</span>o kernel<span class="token operator">/</span>entry<span class="token punctuation">.</span>o kernel<span class="token operator">/</span>entry<span class="token punctuation">.</span>S
riscv64<span class="token operator">-</span>unknown<span class="token operator">-</span>elf<span class="token operator">-</span>gcc <span class="token operator">-</span>Wall <span class="token operator">-</span>Werror <span class="token operator">-</span>O <span class="token operator">-</span>fno<span class="token operator">-</span>omit<span class="token operator">-</span>frame<span class="token operator">-</span>pointer <span class="token operator">-</span>ggdb <span class="token operator">-</span>DSOL_UTIL <span class="token operator">-</span>MD <span class="token operator">-</span>mcmodel<span class="token operator">=</span>medany <span class="token operator">-</span>ffreestanding <span class="token operator">-</span>fno<span class="token operator">-</span>common <span class="token operator">-</span>nostdlib <span class="token operator">-</span>mno<span class="token operator">-</span>relax <span class="token operator">-</span>I<span class="token punctuation">.</span> <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>fno<span class="token operator">-</span>pie <span class="token operator">-</span>no<span class="token operator">-</span>pie   <span class="token operator">-</span>c <span class="token operator">-</span>o kernel<span class="token operator">/</span>start<span class="token punctuation">.</span>o kernel<span class="token operator">/</span>start<span class="token punctuation">.</span>c
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  
riscv64<span class="token operator">-</span>unknown<span class="token operator">-</span>elf<span class="token operator">-</span>ld <span class="token operator">-</span>z max<span class="token operator">-</span>page<span class="token operator">-</span>size<span class="token operator">=</span><span class="token number">4096</span> <span class="token operator">-</span>N <span class="token operator">-</span>e main <span class="token operator">-</span>Ttext <span class="token number">0</span> <span class="token operator">-</span>o user<span class="token operator">/</span>_zombie user<span class="token operator">/</span>zombie<span class="token punctuation">.</span>o user<span class="token operator">/</span>ulib<span class="token punctuation">.</span>o user<span class="token operator">/</span>usys<span class="token punctuation">.</span>o user<span class="token operator">/</span>printf<span class="token punctuation">.</span>o user<span class="token operator">/</span>umalloc<span class="token punctuation">.</span>o
riscv64<span class="token operator">-</span>unknown<span class="token operator">-</span>elf<span class="token operator">-</span>objdump <span class="token operator">-</span>S user<span class="token operator">/</span>_zombie <span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> user<span class="token operator">/</span>zombie<span class="token punctuation">.</span><span class="token keyword">asm</span>
riscv64<span class="token operator">-</span>unknown<span class="token operator">-</span>elf<span class="token operator">-</span>objdump <span class="token operator">-</span>t user<span class="token operator">/</span>_zombie <span class="token operator">|</span> sed '<span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">/</span>SYMBOL TABLE<span class="token operator">/</span>d<span class="token punctuation">;</span> s<span class="token operator">/</span> <span class="token punctuation">.</span><span class="token operator">*</span> <span class="token operator">/</span> <span class="token operator">/</span><span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">^</span>$<span class="token operator">/</span>d' <span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> user<span class="token operator">/</span>zombie<span class="token punctuation">.</span>sym
mkfs<span class="token operator">/</span>mkfs fs<span class="token punctuation">.</span>img README  user<span class="token operator">/</span>xargstest<span class="token punctuation">.</span>sh user<span class="token operator">/</span>_cat user<span class="token operator">/</span>_echo user<span class="token operator">/</span>_forktest user<span class="token operator">/</span>_grep user<span class="token operator">/</span>_init user<span class="token operator">/</span>_kill user<span class="token operator">/</span>_ln user<span class="token operator">/</span>_ls user<span class="token operator">/</span>_mkdir user<span class="token operator">/</span>_rm user<span class="token operator">/</span>_sh user<span class="token operator">/</span>_stressfs user<span class="token operator">/</span>_usertests user<span class="token operator">/</span>_grind user<span class="token operator">/</span>_wc user<span class="token operator">/</span>_zombie 
nmeta <span class="token number">46</span> <span class="token punctuation">(</span>boot<span class="token punctuation">,</span> super<span class="token punctuation">,</span> log blocks <span class="token number">30</span> inode blocks <span class="token number">13</span><span class="token punctuation">,</span> bitmap blocks <span class="token number">1</span><span class="token punctuation">)</span> blocks <span class="token number">954</span> total <span class="token number">1000</span>
balloc<span class="token operator">:</span> first <span class="token number">591</span> blocks have been allocated
balloc<span class="token operator">:</span> write bitmap block at sector <span class="token number">45</span>
qemu<span class="token operator">-</span>system<span class="token operator">-</span>riscv64 <span class="token operator">-</span>machine virt <span class="token operator">-</span>bios none <span class="token operator">-</span>kernel kernel<span class="token operator">/</span>kernel <span class="token operator">-</span>m <span class="token number">128</span>M <span class="token operator">-</span>smp <span class="token number">3</span> <span class="token operator">-</span>nographic <span class="token operator">-</span>drive file<span class="token operator">=</span>fs<span class="token punctuation">.</span>img<span class="token punctuation">,</span><span class="token keyword">if</span><span class="token operator">=</span>none<span class="token punctuation">,</span>format<span class="token operator">=</span>raw<span class="token punctuation">,</span>id<span class="token operator">=</span>x0 <span class="token operator">-</span>device virtio<span class="token operator">-</span>blk<span class="token operator">-</span>device<span class="token punctuation">,</span>drive<span class="token operator">=</span>x0<span class="token punctuation">,</span>bus<span class="token operator">=</span>virtio<span class="token operator">-</span>mmio<span class="token operator">-</span>bus<span class="token punctuation">.</span><span class="token number">0</span>

xv6 kernel is booting

hart <span class="token number">2</span> starting
hart <span class="token number">1</span> starting
init<span class="token operator">:</span> starting sh
$

</code></pre> 
<p>如果你在提示符下输入 ls，你会看到类似如下的输出:</p> 
<pre><code class="prism language-cpp">$ ls
<span class="token punctuation">.</span>              <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1024</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1024</span>
README         <span class="token number">2</span> <span class="token number">2</span> <span class="token number">2059</span>
xargstest<span class="token punctuation">.</span>sh   <span class="token number">2</span> <span class="token number">3</span> <span class="token number">93</span>
cat            <span class="token number">2</span> <span class="token number">4</span> <span class="token number">24256</span>
echo           <span class="token number">2</span> <span class="token number">5</span> <span class="token number">23080</span>
forktest       <span class="token number">2</span> <span class="token number">6</span> <span class="token number">13272</span>
grep           <span class="token number">2</span> <span class="token number">7</span> <span class="token number">27560</span>
init           <span class="token number">2</span> <span class="token number">8</span> <span class="token number">23816</span>
kill           <span class="token number">2</span> <span class="token number">9</span> <span class="token number">23024</span>
ln             <span class="token number">2</span> <span class="token number">10</span> <span class="token number">22880</span>
ls             <span class="token number">2</span> <span class="token number">11</span> <span class="token number">26448</span>
mkdir          <span class="token number">2</span> <span class="token number">12</span> <span class="token number">23176</span>
rm             <span class="token number">2</span> <span class="token number">13</span> <span class="token number">23160</span>
sh             <span class="token number">2</span> <span class="token number">14</span> <span class="token number">41976</span>
stressfs       <span class="token number">2</span> <span class="token number">15</span> <span class="token number">24016</span>
usertests      <span class="token number">2</span> <span class="token number">16</span> <span class="token number">148456</span>
grind          <span class="token number">2</span> <span class="token number">17</span> <span class="token number">38144</span>
wc             <span class="token number">2</span> <span class="token number">18</span> <span class="token number">25344</span>
zombie         <span class="token number">2</span> <span class="token number">19</span> <span class="token number">22408</span>
console        <span class="token number">3</span> <span class="token number">20</span> <span class="token number">0</span>

</code></pre> 
<p>这些是mkfs在初始文件系统中包含的文件；大多数是可以运行的程序。你刚刚跑了其中一个：ls。</p> 
<p>xv6没有ps命令，但是如果您键入Ctrl-p，内核将打印每个进程的信息。如果现在尝试，您将看到两行：一行用于init，另一行用于sh。</p> 
<p>退出 qemu : Ctrl-a x。</p> 
<h3><a id="_149"></a>解析：</h3> 
<p>没啥好说的，配置环境是个大关。<br> 按着官方文档来就好了，<a href="https://pdos.csail.mit.edu/6.S081/2020/tools.html" rel="nofollow">6.S081官方环境配置链接</a><br> 唯一问题是：<strong>安装RISC-V交叉编译工具</strong> 超级无敌巨坑！！！估计其他环境搭建文章肯定也提到这事了。<br> 以下这句官方配置代码，<strong>仅限于ubuntu 20.04</strong>，我之前使用 ubuntu 16.04报了个镜像源链接错误，害得我换了个遍也没解决，最后无奈下载ubuntu 20.04。</p> 
<pre><code class="prism language-c">sudo apt<span class="token operator">-</span>get install git build<span class="token operator">-</span>essential gdb<span class="token operator">-</span>multiarch qemu<span class="token operator">-</span>system<span class="token operator">-</span>misc gcc<span class="token operator">-</span>riscv64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu binutils<span class="token operator">-</span>riscv64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu 
</code></pre> 
<p>剩下什么安装QEMU，下载源码都没啥，一步步按着官方操作就行。</p> 
<p>最后make qemu一下，ls出结果，Ctrl-a按完松手再按x退出。<br> <img src="https://images2.imgbox.com/67/97/U79zrDI6_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="sleepEasy_163"></a>二、sleep(难度：Easy)</h2> 
<p>实现xv6的UNIX程序sleep：您的sleep应该暂停到用户指定的计时数。一个滴答(tick)是由xv6内核定义的时间概念，即来自定时器芯片的两个中断之间的时间。您的解决方案应该在文件user/sleep.c中</p> 
<p>提示：</p> 
<p>在你开始编码之前，请阅读《book-riscv-rev1》的第一章</p> 
<p>看看其他的一些程序（如/user/echo.c, /user/grep.c, /user/rm.c）查看如何获取传递给程序的命令行参数</p> 
<p>如果用户忘记传递参数，sleep应该打印一条错误信息</p> 
<p>命令行参数作为字符串传递; 您可以使用atoi将其转换为数字（详见/user/ulib.c）</p> 
<p>使用系统调用sleep</p> 
<p>请参阅kernel/sysproc.c以获取实现sleep系统调用的xv6内核代码（查找sys_sleep），user/user.h提供了sleep的声明以便其他程序调用，用汇编程序编写的user/usys.S可以帮助sleep从用户区跳转到内核区。</p> 
<p>确保main函数调用exit()以退出程序。</p> 
<p>将你的sleep程序添加到Makefile中的UPROGS中；完成之后，make qemu将编译您的程序，并且您可以从xv6的shell运行它。</p> 
<p>看看Kernighan和Ritchie编著的《C程序设计语言》（第二版）来了解C语言。</p> 
<p>从xv6 shell运行程序：</p> 
<pre><code class="prism language-cpp">$ make qemu
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
init<span class="token operator">:</span> starting sh
$ sleep <span class="token number">10</span>
<span class="token punctuation">(</span>nothing happens <span class="token keyword">for</span> a little <span class="token keyword">while</span><span class="token punctuation">)</span>
$

</code></pre> 
<p>如果程序在如上所示运行时暂停，则解决方案是正确的。运行make grade看看你是否真的通过了睡眠测试。</p> 
<p>请注意，make grade运行所有测试，包括下面作业的测试。如果要对一项作业运行成绩测试，请键入（不要启动XV6，在外部终端下使用）：</p> 
<pre><code class="prism language-c">$ <span class="token punctuation">.</span><span class="token operator">/</span>grade<span class="token operator">-</span>lab<span class="token operator">-</span>util sleep

</code></pre> 
<p>这将运行与sleep匹配的成绩测试。或者，您可以键入：</p> 
<pre><code class="prism language-c">$ make GRADEFLAGS<span class="token operator">=</span>sleep grade

</code></pre> 
<p>效果是一样的。</p> 
<h3><a id="_213"></a>解析：</h3> 
<p>这题练手题，明白int argc, char *argv[]都是啥，会调sleep函数就ok。<br> argc是命令行总的参数个数 。<br> argv[]为保存命令行参数的字符串指针。其中第0个参数是程序的全名，以后的参数为命令行后面跟的用户输入的参数。</p> 
<p>就比如说该命令sleep 10。其中argc就应该是1，argv[1]就是输入的10。</p> 
<p>答案：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/types.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/stat.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"user/user.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"usage: sleep pattern [file ...]\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>记得修改makefile文件，在152行那里添加</p> 
<pre><code class="prism language-c">$U<span class="token operator">/</span>_sleep\
</code></pre> 
<p>如果出现/usr/bin/env: “python”: 没有那个文件或目录，这个错误。把grade-lab-util中第一句改成：</p> 
<pre><code class="prism language-c">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env python3
</code></pre> 
<p>就好了</p> 
<p><img src="https://images2.imgbox.com/4e/21/oVtvb7U3_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="pingpongEasy_254"></a>三、pingpong（难度：Easy）</h2> 
<p>使用管道编写prime sieve(筛选素数)的并发版本。这个想法是由Unix管道的发明者Doug McIlroy提出的。请查看这个网站(翻译在下面)，该网页中间的图片和周围的文字解释了如何做到这一点。您的解决方案应该在user/primes.c文件中。</p> 
<p>提示：</p> 
<p>使用pipe来创造管道</p> 
<p>使用fork创建子进程</p> 
<p>使用read从管道中读取数据，并且使用write向管道中写入数据</p> 
<p>使用getpid获取调用进程的pid</p> 
<p>将程序加入到Makefile的UPROGS</p> 
<p>xv6上的用户程序有一组有限的可用库函数。您可以在user/user.h中看到可调用的程序列表；源代码（系统调用除外）位于user/ulib.c、user/printf.c和user/umalloc.c中。</p> 
<p>运行程序应得到下面的输出</p> 
<pre><code class="prism language-c">$ make qemu
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
init<span class="token operator">:</span> starting sh
$ pingpong
<span class="token number">4</span><span class="token operator">:</span> received ping
<span class="token number">3</span><span class="token operator">:</span> received pong
$

</code></pre> 
<p>如果您的程序在两个进程之间交换一个字节并产生如上所示的输出，那么您的解决方案是正确的。</p> 
<h3><a id="_286"></a>解析：</h3> 
<p>通过管道，记得多做异常判断和使用完了就要关闭读写。</p> 
<p>答案：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/types.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/stat.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/fcntl.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"user/user.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/param.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> p1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">pipe</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//子进程-&gt;父进程</span>
	<span class="token function">pipe</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//父进程-&gt;子进程</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Parameter missing\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">char</span> <span class="token operator">*</span>buf <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">close</span><span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" father write error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" father read error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d: received pong \n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">close</span><span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" child read error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" child write error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d: received ping \n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" fork error!\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/12/74/ZCmx19iH_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="PrimesModerateHard_359"></a>四、Primes(素数，难度：Moderate/Hard)</h2> 
<p>使用管道编写prime sieve(筛选素数)的并发版本。这个想法是由Unix管道的发明者Doug McIlroy提出的。请查看这个网站(翻译在下面)，该网页中间的图片和周围的文字解释了如何做到这一点。您的解决方案应该在user/primes.c文件中。</p> 
<p>您的目标是使用pipe和fork来设置管道。第一个进程将数字2到35输入管道。对于每个素数，您将安排创建一个进程，该进程通过一个管道从其左邻居读取数据，并通过另一个管道向其右邻居写入数据。由于xv6的文件描述符和进程数量有限，因此第一个进程可以在35处停止。</p> 
<p>提示：</p> 
<p>请仔细关闭进程不需要的文件描述符，否则您的程序将在第一个进程达到35之前就会导致xv6系统资源不足。</p> 
<p>一旦第一个进程达到35，它应该使用wait等待整个管道终止，包括所有子孙进程等等。因此，主primes进程应该只在打印完所有输出之后，并且在所有其他primes进程退出之后退出。</p> 
<p>提示：当管道的write端关闭时，read返回零。</p> 
<p>最简单的方法是直接将32位（4字节）int写入管道，而不是使用格式化的ASCII I/O。</p> 
<p>您应该仅在需要时在管线中创建进程。</p> 
<p>将程序添加到Makefile中的UPROGS</p> 
<p>如果您的解决方案实现了基于管道的筛选并产生以下输出，则是正确的：</p> 
<pre><code class="prism language-cpp">$ make qemu
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
init<span class="token operator">:</span> starting sh
$ primes
prime <span class="token number">2</span>
prime <span class="token number">3</span>
prime <span class="token number">5</span>
prime <span class="token number">7</span>
prime <span class="token number">11</span>
prime <span class="token number">13</span>
prime <span class="token number">17</span>
prime <span class="token number">19</span>
prime <span class="token number">23</span>
prime <span class="token number">29</span>
prime <span class="token number">31</span>
$

</code></pre> 
<h3><a id="_400"></a>解析：</h3> 
<p>难点在于看懂那个文章和递归遍历<br> 参考：</p> 
<pre><code class="prism language-c">p <span class="token operator">=</span> get a number from left neighbor
print p
loop<span class="token operator">:</span>
    n <span class="token operator">=</span> get a number from left neighbor
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p does not divide n<span class="token punctuation">)</span>
        send n to right neighbor
p <span class="token operator">=</span> 从左邻居中获取一个数
print p
loop<span class="token operator">:</span>
    n <span class="token operator">=</span> 从左邻居中获取一个数
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n不能被p整除<span class="token punctuation">)</span>
        将n发送给右邻居

</code></pre> 
<p>生成进程可以将数字2、3、4、…、1000输入管道的左端：行中的第一个进程消除2的倍数，第二个进程消除3的倍数，第三个进程消除5的倍数，依此类推。</p> 
<p>答案：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/types.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/stat.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/fcntl.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"user/user.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/param.h"</span></span>

<span class="token keyword">int</span> <span class="token function">lpipe_first_data</span><span class="token punctuation">(</span><span class="token keyword">int</span> lpipe<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>dst<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>lpipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dst<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"prime %d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">traversal</span><span class="token punctuation">(</span><span class="token keyword">int</span> lpipe<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">close</span><span class="token punctuation">(</span>lpipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> first<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lpipe_first_data</span><span class="token punctuation">(</span>lpipe<span class="token punctuation">,</span> <span class="token operator">&amp;</span>first<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token function">pipe</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token keyword">int</span> data<span class="token punctuation">;</span>

		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>lpipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">%</span> first<span class="token punctuation">)</span>
				<span class="token function">write</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>lpipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token function">traversal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">close</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Parameter missing\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> nums <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">pipe</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> nums<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">write</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">traversal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">close</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8e/ab/blMtWRhN_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="findModerate_495"></a>五、find（难度：Moderate）</h2> 
<p>写一个简化版本的UNIX的find程序：查找目录树中具有特定名称的所有文件，你的解决方案应该放在user/find.c</p> 
<p>提示：</p> 
<p>查看user/ls.c文件学习如何读取目录<br> 使用递归允许find下降到子目录中<br> 不要在“.”和“…”目录中递归<br> 对文件系统的更改会在qemu的运行过程中一直保持；要获得一个干净的文件系统，请运行make clean，然后make qemu<br> 你将会使用到C语言的字符串，要学习它请看《C程序设计语言》（K&amp;R）,例如第5.5节<br> 注意在C语言中不能像python一样使用“==”对字符串进行比较，而应当使用strcmp()<br> 将程序加入到Makefile的UPROGS<br> 如果你的程序输出下面的内容，那么它是正确的（当文件系统中包含文件b和a/b的时候）</p> 
<pre><code class="prism language-cpp">$ make qemu
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
init<span class="token operator">:</span> starting sh
$ echo <span class="token operator">&gt;</span> b
$ mkdir a
$ echo <span class="token operator">&gt;</span> a<span class="token operator">/</span>b
$ find <span class="token punctuation">.</span> b
<span class="token punctuation">.</span><span class="token operator">/</span>b
<span class="token punctuation">.</span><span class="token operator">/</span>a<span class="token operator">/</span>b
$

</code></pre> 
<h3><a id="_523"></a>解析：</h3> 
<p>确实没啥说的，代码基本上都是ls.c中的内容。</p> 
<p>答案：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/types.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/stat.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"user/user.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/fs.h"</span></span>

<span class="token keyword">void</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> path<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
	<span class="token keyword">int</span> fd<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">dirent</span> de<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"find: cannot open %s\n"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//fstat() 用来将参数filedes 所指向的文件状态复制到参数buf 所指向的结构</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>	<span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"find: cannot stat %s\n"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token keyword">return</span><span class="token punctuation">;</span>
  	<span class="token punctuation">}</span>

	<span class="token comment">//参数错误，find的第一个参数必须是目录</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>type <span class="token operator">!=</span> T_DIR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"usage: find &lt;DIRECTORY&gt; &lt;filename&gt;\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//检查路径长度是否适合存储在buf中</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> DIRSIZ <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"find: path too long\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p <span class="token operator">=</span> buf<span class="token operator">+</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token char">'/'</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>de<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>de<span class="token punctuation">.</span>inum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
	<span class="token function">memmove</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> de<span class="token punctuation">.</span>name<span class="token punctuation">,</span> DIRSIZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">[</span>DIRSIZ<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"find: cannot stat %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
	<span class="token comment">//不要在“.”和“..”目录中递归</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>type <span class="token operator">==</span> T_DIR <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">find</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Parameter missing\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">find</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/cc/48/7U2CaUBS_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="xargsModerate_599"></a>六、xargs（难度：Moderate）</h2> 
<p>编写一个简化版UNIX的xargs程序：它从标准输入中按行读取，并且为每一行执行一个命令，将行作为参数提供给命令。你的解决方案应该在user/xargs.c</p> 
<p>下面的例子解释了xargs的行为</p> 
<pre><code class="prism language-cpp">$ echo hello too <span class="token operator">|</span> xargs echo bye
bye hello too
$

</code></pre> 
<p>注意，这里的命令是echo bye，额外的参数是hello too，这样就组成了命令echo bye hello too，此命令输出bye hello too</p> 
<p>请注意，UNIX上的xargs进行了优化，一次可以向该命令提供更多的参数。 我们不需要您进行此优化。 要使UNIX上的xargs表现出本实验所实现的方式，请将-n选项设置为1。例如</p> 
<pre><code class="prism language-c">$ echo <span class="token string">"1\n2"</span> <span class="token operator">|</span> xargs <span class="token operator">-</span>n <span class="token number">1</span> echo line
line <span class="token number">1</span>
line <span class="token number">2</span>
$

</code></pre> 
<p>提示：</p> 
<p>使用fork和exec对每行输入调用命令，在父进程中使用wait等待子进程完成命令。<br> 要读取单个输入行，请一次读取一个字符，直到出现换行符（‘\n’）。<br> kernel/param.h声明MAXARG，如果需要声明argv数组，这可能很有用。<br> 将程序添加到Makefile中的UPROGS。<br> 对文件系统的更改会在qemu的运行过程中保持不变；要获得一个干净的文件系统，请运行make clean，然后make qemu<br> xargs、find和grep结合得很好</p> 
<pre><code class="prism language-c">$ find <span class="token punctuation">.</span> b <span class="token operator">|</span> xargs grep hello

</code></pre> 
<p>将对“.”下面的目录中名为b的每个文件运行grep hello。</p> 
<p>要测试您的xargs方案是否正确，请运行shell脚本xargstest.sh。如果您的解决方案产生以下输出，则是正确的：</p> 
<pre><code class="prism language-c">$ make qemu
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
init<span class="token operator">:</span> starting sh
$ sh <span class="token operator">&lt;</span> xargstest<span class="token punctuation">.</span>sh
$ $ $ $ $ $ hello
hello
hello
$ $

</code></pre> 
<p>你可能不得不回去修复你的find程序中的bug。输出有许多$ ，因为xv6 shell没有意识到它正在处理来自文件而不是控制台的命令，并为文件中的每个命令打印$。</p> 
<h3><a id="_654"></a>解析：</h3> 
<p>这题我感觉是第一节中最难的，主要是没有换行符判断很难受。<br> 听从大佬解法使用滑动窗口解决。<br> <a href="https://zhuanlan.zhihu.com/p/624091268" rel="nofollow">大佬解法链接</a><br> 具体解释看代码注释。<br> 答案：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/types.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/stat.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"user/user.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kernel/param.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//滑动窗口</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>xargv<span class="token punctuation">[</span>MAXARG<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	uint size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//字节大小</span>
	<span class="token keyword">int</span> endIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//字段末尾标识符</span>
	
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		xargv<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  	<span class="token punctuation">}</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>endIndex <span class="token operator">&amp;&amp;</span> size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>endIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span> readBytes <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf <span class="token operator">+</span> size<span class="token punctuation">,</span> <span class="token number">512</span> <span class="token operator">-</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>readBytes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" read error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">/*如果读取到 0 字节（即已到达标准输入的末尾），则关闭标准输入并设置为真*/</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>readBytes <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">close</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				endIndex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			size <span class="token operator">+=</span> readBytes<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">/*处理读取的行*/</span>
		<span class="token keyword">char</span><span class="token operator">*</span> lineEnd <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//每一行的结束</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>lineEnd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">char</span> xbuf<span class="token punctuation">[</span><span class="token number">513</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token function">memcpy</span><span class="token punctuation">(</span>xbuf<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> lineEnd <span class="token operator">-</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			xargv<span class="token punctuation">[</span>argc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> xbuf<span class="token punctuation">;</span>
			<span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">/*子进程使用 exec 执行由 argv[1] 指定的程序，并将 xargv 作为参数传递*/</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>endIndex<span class="token punctuation">)</span> 
					<span class="token function">close</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">exec</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> xargv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"xargv: exec fails [file ...]\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">/*父进程从滑动窗口中移除已处理的行*/</span>
				<span class="token function">memmove</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> lineEnd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token punctuation">(</span>lineEnd <span class="token operator">-</span> buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				size <span class="token operator">-=</span> lineEnd <span class="token operator">-</span> buf <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token function">memset</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">512</span> <span class="token operator">-</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
				
				<span class="token comment">/*回收僵尸*/</span>
				<span class="token keyword">int</span> status<span class="token punctuation">;</span>
				<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//成功返回0 失败返回-1</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span> ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wait error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">/*继续查找和处理下一行*/</span>
				lineEnd <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d: received ping \n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其实还是有点小毛病，使用给出的sh &lt; xargstest.sh，输出有点问题<br> <img src="https://images2.imgbox.com/8e/9f/WIIuqDyz_o.png" alt="在这里插入图片描述"><br> 其他是对的<br> <img src="https://images2.imgbox.com/e1/8a/lE9mMVFQ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/88/0b/HakIULrD_o.png" alt="在这里插入图片描述"><br> 之后再仔细瞅瞅。</p> 
<hr> 
<h2><a id="_741"></a>总结</h2> 
<p>我稍微有些操作系统的学习知识，做的不算太卡。哈工大的我感觉底层东西介绍的多，但是有些其他知识覆盖面少，就比如进程通信、锁、管道之类的就没咋说。<br> 个人感觉比起csapp的lab容易。<br> 现在据说这个实验也没那么新颖了，可以根据自己理解整点新东西。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4a4e5206da3d5c9cfe2eee3802da6595/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">深入理解Java中的线程安全List：CopyOnWriteArrayList原理和应用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b4426d9bd81ff104a246f47036746f5f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">路由算法与路由协议</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>