<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>COCO标签转VOC - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="COCO标签转VOC" />
<meta property="og:description" content="转换的代码
&#39;&#39;&#39; 把coco数据集合的所有标注转换到voc格式，不改变图片命名方式， 注意，原来有一些图片是黑白照片，检测出不是 RGB 图像，这样的图像不会被放到新的文件夹中 &#39;&#39;&#39; from pycocotools.coco import COCO import os, cv2, shutil from lxml import etree, objectify from tqdm import tqdm from PIL import Image # 生成图片保存的路径 CKimg_dir = &#39;./dataset/voc/images&#39; # 生成标注文件保存的路径 CKanno_dir = &#39;./dataset/voc/annotations&#39; # 若模型保存文件夹不存在，创建模型保存文件夹，若存在，删除重建 def mkr(path): if os.path.exists(path): shutil.rmtree(path) os.mkdir(path) else: os.mkdir(path) def save_annotations(filename, objs, filepath): annopath = CKanno_dir &#43; &#34;/&#34; &#43; filename[:-3] &#43; &#34;xml&#34; # 生成的xml文件保存路径 dst_path = CKimg_dir &#43; &#34;/&#34; &#43; filename img_path = filepath img = cv2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/bd9c3cabf101829989c55d76a6556f50/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-20T20:56:30+08:00" />
<meta property="article:modified_time" content="2023-09-20T20:56:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">COCO标签转VOC</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>转换的代码</p> 
<pre><code>'''
把coco数据集合的所有标注转换到voc格式，不改变图片命名方式，
注意，原来有一些图片是黑白照片，检测出不是 RGB 图像，这样的图像不会被放到新的文件夹中
'''
from pycocotools.coco import COCO
import os, cv2, shutil
from lxml import etree, objectify
from tqdm import tqdm
from PIL import Image

# 生成图片保存的路径
CKimg_dir = './dataset/voc/images'
# 生成标注文件保存的路径
CKanno_dir = './dataset/voc/annotations'


# 若模型保存文件夹不存在，创建模型保存文件夹，若存在，删除重建
def mkr(path):
    if os.path.exists(path):
        shutil.rmtree(path)
        os.mkdir(path)
    else:
        os.mkdir(path)


def save_annotations(filename, objs, filepath):
    annopath = CKanno_dir + "/" + filename[:-3] + "xml"  # 生成的xml文件保存路径
    dst_path = CKimg_dir + "/" + filename
    img_path = filepath
    img = cv2.imread(img_path)
    im = Image.open(img_path)
    if im.mode != "RGB":
        print(filename + " not a RGB image")
        im.close()
        return
    im.close()
    shutil.copy(img_path, dst_path)  # 把原始图像复制到目标文件夹
    E = objectify.ElementMaker(annotate=False)
    anno_tree = E.annotation(
        E.folder('1'),
        E.filename(filename),
        E.source(
            E.database('CKdemo'),
            E.annotation('VOC'),
            E.image('CK')
        ),
        E.size(
            E.width(img.shape[1]),
            E.height(img.shape[0]),
            E.depth(img.shape[2])
        ),
        E.segmented(0)
    )
    for obj in objs:
        E2 = objectify.ElementMaker(annotate=False)
        anno_tree2 = E2.object(
            E.name(obj[0]),
            E.pose(),
            E.truncated("0"),
            E.difficult(0),
            E.bndbox(
                E.xmin(obj[2]),
                E.ymin(obj[3]),
                E.xmax(obj[4]),
                E.ymax(obj[5])
            )
        )
        anno_tree.append(anno_tree2)
    etree.ElementTree(anno_tree).write(annopath, pretty_print=True)


def showbycv(coco, dataType, img, classes, origin_image_dir, verbose=False):
    filename = img['file_name'].split("\\")[1]
    filepath = os.path.join(origin_image_dir, dataType, filename)
    I = cv2.imread(filepath)
    annIds = coco.getAnnIds(imgIds=img['id'], iscrowd=None)
    anns = coco.loadAnns(annIds)
    objs = []
    for ann in anns:
        name = classes[ann['category_id']]
        if 'bbox' in ann:
            bbox = ann['bbox']
            xmin = (int)(bbox[0])
            ymin = (int)(bbox[1])
            xmax = (int)(bbox[2] + bbox[0])
            ymax = (int)(bbox[3] + bbox[1])
            obj = [name, 1.0, xmin, ymin, xmax, ymax]
            objs.append(obj)
            if verbose:
                cv2.rectangle(I, (xmin, ymin), (xmax, ymax), (255, 0, 0))
                cv2.putText(I, name, (xmin, ymin), 3, 1, (0, 0, 255))
    save_annotations(filename, objs, filepath)
    if verbose:
        cv2.imshow("img", I)
        cv2.waitKey(0)


def catid2name(coco):  # 将名字和id号建立一个字典
    classes = dict()
    for cat in coco.dataset['categories']:
        classes[cat['id']] = cat['name']
        # print(str(cat['id'])+":"+cat['name'])
    return classes


def get_CK5(origin_anno_dir, origin_image_dir, verbose=False):
    dataTypes = ['val2017', 'train2017', 'test2017']
    for dataType in dataTypes:
        annFile = 'instances_{}.json'.format(dataType)
        annpath = os.path.join(origin_anno_dir, annFile)
        coco = COCO(annpath)
        classes = catid2name(coco)
        imgIds = coco.getImgIds()
        # imgIds=imgIds[0:1000]#测试用，抽取10张图片，看下存储效果
        with open('./dataset/voc/%s.txt'%(dataType),'w') as f1:
            

            for imgId in tqdm(imgIds):
                img = coco.loadImgs(imgId)[0]
                showbycv(coco, dataType, img, classes, origin_image_dir, verbose=False)
                filename = img['file_name'].split("\\")[1]
                f1.write(filename+'\n')



def main():
    base_dir = './dataset/voc'  # step1 这里是一个新的文件夹，存放转换后的图片和标注
    image_dir = os.path.join(base_dir, 'images')  # 在上述文件夹中生成images，annotations两个子文件夹
    anno_dir = os.path.join(base_dir, 'annotations')
    mkr(image_dir)
    mkr(anno_dir)
    origin_image_dir = './dataset/coco'  # step 2原始的coco的图像存放位置
    origin_anno_dir = './dataset/coco/annotations'  # step 3 原始的coco的标注存放位置
    print(origin_anno_dir)
    verbose = False  # 是否需要看下标记是否正确的开关标记，若是true,就会把标记展示到图片上
    get_CK5(origin_anno_dir, origin_image_dir, verbose)


if __name__ == "__main__":
    main()

</code></pre> 
<p>可视化的代码</p> 
<pre><code>
import os
from xml.dom import minidom  # python自带的xml.dom.minidom包
from PIL import ImageDraw, ImageFont, Image  # PIL绘制图形、文本
 
# 定义函数draw_rectangle画矩形框**********************************
def draw_rectangle(name):
    doc = minidom.parse("dataset/voc/annotations/" + name)  # 打开xml文件，注意文件名格式
    imageName = name.replace(".xml", ".jpg")  # 替换文件名后缀
    image = Image.open("dataset/voc/images/" + imageName)  # 打开相应的jpg文件
 
    objects = doc.getElementsByTagName("object")  # 定义objects
    for object in objects:  # 遍历标签中所有的物体
        name = object.getElementsByTagName("name")[0]
        xmin = object.getElementsByTagName("xmin")[0]
        ymin = object.getElementsByTagName("ymin")[0]
        xmax = object.getElementsByTagName("xmax")[0]
        ymax = object.getElementsByTagName("ymax")[0]
        # type(xmin) = xml.dom.minidom.Element
 
        x_min = int("".join([str(x1) for x1 in xmin.firstChild.data]))
        y_min = int("".join([str(y1) for y1 in ymin.firstChild.data]))
        x_max = int("".join([str(x2) for x2 in xmax.firstChild.data]))
        y_max = int("".join([str(y2) for y2 in ymax.firstChild.data]))
        # type(xmin.firstChild.data) = str      type(x_min) = int
        # str转int: int("".join([str(x) for x in str]))
 
        draw = ImageDraw.Draw(image)  # 加载画图命令
        if name.firstChild.data == "pothole":
            draw.rectangle([x_min, y_min, x_max, y_max], outline=color[1], width=3)
            draw.text((x_min, y_min - 30), "pothole", fill=color[1])
        else:
            print("Unknow!!!")

 
    image.save("./dataset/Image/" + imageName)  # 保存图像，C盘根目录无权限
# 定义函数draw_rectangle画矩形框**********************************
 
file_dir = "dataset/voc/annotations"  # path
file_name = os.listdir(file_dir)  # 遍历文件获取全部文件名
color = [(102, 128, 102), (255, 0, 0), (0, 255, 0), (0, 0, 255), (255, 255, 0), (255, 0, 255), (0, 255, 255),
             (0, 128, 0), (0, 0, 0)]  # 控制矩形框颜色

for name in file_name:  # 循环语句（注意:）
    if name.find(".xml") &gt;= 0:  # 仅读取xml文件
       draw_rectangle(name)
 
 
 
 
 
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ba3a0ea88b59e255a69e99f408743a96/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【BeanTrimUtil】通过反射去除JavaBean中String类型数据的空格：一行代码搞定整个Bean的字符串去空！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/40fbe7cbfd80d80ad9fc1452d5b1840e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【笔试真题记录】2023华为9.20机试第二题（DFS和BFS）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>