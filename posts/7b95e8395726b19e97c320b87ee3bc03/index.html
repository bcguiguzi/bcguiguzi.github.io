<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Java-ThreadPoolExecutor使用 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Java-ThreadPoolExecutor使用" />
<meta property="og:description" content="Java-ThreadPoolExecutor使用 线程池主要由以下4个核心组件组成。
线程池管理器：用于创建并管理线程池工作线程：线程池中执行具体任务的线程任务接口：用于定义工作线程的调度和执行策略，只有线程实现了该接口，线程中的任务才能被线程池调度任务队列：存放待处理的任务，新的任务将会不断被加入队列中，执行完成的任务将从队列中移除 ThreadPoolExecutor 如下是线程池的构造方法
public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) { if (corePoolSize &lt; 0 || maximumPoolSize &lt;= 0 || maximumPoolSize &lt; corePoolSize || keepAliveTime &lt; 0) throw new IllegalArgumentException(); if (workQueue == null || threadFactory == null || handler == null) throw new NullPointerException(); this.acc = System.getSecurityManager() == null ? null : AccessController.getContext(); this.corePoolSize = corePoolSize; this.maximumPoolSize = maximumPoolSize; this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/7b95e8395726b19e97c320b87ee3bc03/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-12T20:36:35+08:00" />
<meta property="article:modified_time" content="2021-05-12T20:36:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Java-ThreadPoolExecutor使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="JavaThreadPoolExecutor_0"></a>Java-ThreadPoolExecutor使用</h2> 
<p>线程池主要由以下4个核心组件组成。</p> 
<ul><li>线程池管理器：用于创建并管理线程池</li><li>工作线程：线程池中执行具体任务的线程</li><li>任务接口：用于定义工作线程的调度和执行策略，只有线程实现了该接口，线程中的任务才能被线程池调度</li><li>任务队列：存放待处理的任务，新的任务将会不断被加入队列中，执行完成的任务将从队列中移除</li></ul> 
<p><img src="https://images2.imgbox.com/8e/9f/qpRsb4Sq_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="ThreadPoolExecutor_12"></a>ThreadPoolExecutor</h3> 
<p>如下是线程池的构造方法</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token function">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                              TimeUnit unit<span class="token punctuation">,</span>
                              BlockingQueue<span class="token generics function"><span class="token punctuation">&lt;</span>Runnable<span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span>
                              ThreadFactory threadFactory<span class="token punctuation">,</span>
                              RejectedExecutionHandler handler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>corePoolSize <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
            maximumPoolSize <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span>
            maximumPoolSize <span class="token operator">&lt;</span> corePoolSize <span class="token operator">||</span>
            keepAliveTime <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workQueue <span class="token operator">==</span> null <span class="token operator">||</span> threadFactory <span class="token operator">==</span> null <span class="token operator">||</span> handler <span class="token operator">==</span> null<span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>acc <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">?</span>
                null <span class="token operator">:</span>
                AccessController<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize <span class="token operator">=</span> corePoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maximumPoolSize <span class="token operator">=</span> maximumPoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>workQueue <span class="token operator">=</span> workQueue<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>threadFactory <span class="token operator">=</span> threadFactory<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中具体参数含义为：</p> 
<ol><li><code>corePoolSize</code>：线程池中核心线程的数量</li><li><code>maximumPoolSize</code>：线程池中最大线程的数量</li><li><code>keepAliveTime</code>：当线程数量超过corePoolSize时，空闲线程的存活时间</li><li><code>unit</code>：keepAliveTime的时间单位</li><li><code>workQueue</code>：任务队列，被提交但尚未被执行的任务存放的地方</li><li><code>threadFactory</code>：线程工厂，用于创建线程，可使用默认的线程工厂或自定义线程工厂</li><li><code>handler</code>：由于任务过多或其他原因导致线程池无法处理时的任务拒绝策略</li></ol> 
<h4><a id="_53"></a>构造函数参数解析</h4> 
<p>编写测试类如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolSerialTest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//核心线程数</span>
        <span class="token keyword">int</span> corePoolSize <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token comment">//最大线程数</span>
        <span class="token keyword">int</span> maximumPoolSize <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token comment">//超过corePoolSize线程数量的线程最大空闲时间</span>
        <span class="token keyword">long</span> keepAliveTime <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token comment">//以秒为时间单位</span>
        TimeUnit unit <span class="token operator">=</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">;</span>
        <span class="token comment">//创建工作队列，用于存放提交的等待执行任务</span>
        BlockingQueue<span class="token generics function"><span class="token punctuation">&lt;</span>Runnable<span class="token punctuation">&gt;</span></span> workQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ThreadPoolExecutor threadPoolExecutor <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 1.创建线程池</span>
            threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span>
                    maximumPoolSize<span class="token punctuation">,</span>
                    keepAliveTime<span class="token punctuation">,</span>
                    unit<span class="token punctuation">,</span>
                    workQueue<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2.循环提交任务</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//提交任务的索引</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                threadPoolExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//线程打印输出</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"大家好，我是线程："</span><span class="token operator">+</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//模拟线程执行时间，10s</span>
                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程："</span><span class="token operator">+</span>index<span class="token operator">+</span><span class="token string">"运行完毕"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//每个任务提交后休眠500ms再提交下一个任务，用于保证提交顺序</span>
                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 3.关闭线程池</span>
            threadPoolExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中循环了6次，让线程池执行了6次任务，恰好满足<code>maximumPoolSize</code>+<code>workQueue容量</code>=<code>并发执行任务数</code>。输出结果如下：</p> 
<pre><code class="prism language-java">大家好，我是线程：<span class="token number">1</span>
大家好，我是线程：<span class="token number">2</span>
大家好，我是线程：<span class="token number">5</span>
大家好，我是线程：<span class="token number">6</span>
线程：<span class="token number">1</span>运行完毕
大家好，我是线程：<span class="token number">3</span>
线程：<span class="token number">2</span>运行完毕
大家好，我是线程：<span class="token number">4</span>
线程：<span class="token number">5</span>运行完毕
线程：<span class="token number">6</span>运行完毕
线程：<span class="token number">3</span>运行完毕
线程：<span class="token number">4</span>运行完毕
</code></pre> 
<p>这段输出看似没有规律，其实这里输出完全是由线程池控制的；下面就来分行解析输出：</p> 
<pre><code>大家好，我是线程：1 
大家好，我是线程：2
大家好，我是线程：5
大家好，我是线程：6
</code></pre> 
<ol><li>全新线程池被创建后，有Runnable或CallBack接口的实现被提交给线程池执行；线程池的<code>corePoolSize=2</code>，此时前两个任务提交后就立即执行，便输出了<code>线程1 线程2</code>；</li><li>此时仍继续向线程池提交任务，线程池中<code>workQueue容量=2</code>，被加入的任务存放到任务队列中，即把<code>线程3 线程4</code>存放到了任务队列中；</li><li>任务队列充满后，仍继续向线程池提交任务，线程池的<code>maximumPoolSize=4</code>，除开核心线程数2个外还允许创建<code>4-2</code>个线程来执行任务，便输出了<code>线程5 线程6</code></li></ol> 
<pre><code class="prism language-java">线程：<span class="token number">1</span>运行完毕
大家好，我是线程：<span class="token number">3</span>
线程：<span class="token number">2</span>运行完毕
大家好，我是线程：<span class="token number">4</span>
</code></pre> 
<ol><li><code>线程：1运行完毕</code>：表示第一个线程任务执行完毕了</li><li><code>大家好，我是线程：3</code>：线程1运行完毕后，此时线程池中有一个空闲的线程，第一个进入任务队列中的任务第一个交给线程处理</li><li><code>线程：2运行完毕 大家好，我是线程：4</code> ：和上面线程执行完毕，任务对列中任务执行一致</li></ol> 
<pre><code class="prism language-java">线程：<span class="token number">5</span>运行完毕
线程：<span class="token number">6</span>运行完毕
线程：<span class="token number">3</span>运行完毕
线程：<span class="token number">4</span>运行完毕
</code></pre> 
<p>因为每一个任务的执行时间控制的是一样的，此时输出的内容便是先被线程池执行的任务先执行完毕。</p> 
<h4><a id="_158"></a>总结</h4> 
<p>线程池刚被创建时，只是向系统申请一个用于执行线程队列和管理线程池的资源。在调用execute()添加一个任务时，线程池会按照以下流程执行任务：</p> 
<ul><li>正在运行的线程数量a:<code>a&lt;corePoolSize</code>，线程池立即创建线程并执行任务；若此时<code>a=corePoolSize</code>，则任务被存放到workQueue任务队列中，直到任务队列被充满</li><li>任务队列workQueue已充满且正在运行的线程数a:<code>a&lt;maximumPoolSize</code>，线程池立即创建非核心线程并执行任务；若有任务执行完毕，该任务将被线程池队列中移除，线程池从队列中取先入队的任务执行；当线程处于空闲状态的时间超过keepAliveTime时间时，正在运行的线程数a<code>corePoolSize&lt;a</code>，线程池停止空闲的线程。线程池将任务执行完毕后，线程池会收缩到<code>corePoolSize</code>大小</li><li>任务队列workQueue已充满且正在运行的线程数a:<code>a=maximumPoolSize</code>，线程池拒绝执行该任务并抛出RejectExecutionException异常</li></ul> 
<p><img src="https://images2.imgbox.com/f0/f1/C9sR5Qqt_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a0de6a42405883b36f615ba9b24c485d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Unet相关介绍</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9214d8a86ef932c1e0f05ea6456037e9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">第 45 届国际大学生程序设计竞赛（ICPC）亚洲区域赛（上海）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>