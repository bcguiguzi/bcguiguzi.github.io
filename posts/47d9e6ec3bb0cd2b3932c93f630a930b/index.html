<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux系统---Haproxy高性能负载均衡软件 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux系统---Haproxy高性能负载均衡软件" />
<meta property="og:description" content="目录
一、Haproxy介绍
1.Haproxy定义
2.Haproxy主要特性
3.Haproxy调度算法原理
3.1RR（Round Robin）
3.2LC（Least Connections）
3.3SH（Source Hashing）
二、安装Haproxy
1.yum安装
2.第三方rpm包安装
3.编译安装
3.1解决Lua环境
3.2编译安装Haproxy
三、配置文件详解
1.状态页
2.日志管理
2.1定义日志到其他主机站点
3.指定进程线程个数
4.cpu亲缘性
5.多进程和线程
四、Proxies配置
1.Proxies配置——defaults
2.Proxies配置——listen
2.1举例——默认无后端健康性检测
2.2加入健康性检测——Check
3.Proxies配置——frontend
3.1配置参数
3.2举例
4.Proxies配置——backend
4.1server配置 五、实际操作
1.搭建实验环境
2.配置haproxy
3.前后端配置
一、Haproxy介绍 四层代理
LVS：Linux Virtual ServerNginxHAProxy：High Availability Proxy 七层代理
HAProxyNginx 硬件
F5 https://f5.com/zhNetscaler https://www.citrix.com.cn/products/citrix-adc/Array https://www.arraynetworks.com.cn/深信服 http://www.sangfor.com.cn/北京灵州 http://www.lingzhou.com.cn/cpzx/llfzjh/ 1.Haproxy定义 HAProxy是法国开发者威利塔罗(Willy Tarreau)在2000年使用C语言开发的一个开源软件，是一款具备高并发(一万以上)、高性能的TCP和HTTP负载均衡器，支持基于cookie的持久性，自动故障切换，支持正则表达式及web状态统计，目前最新TLS版本为2.2。
HAProxy是可提供高可用性、负载均衡以及基于TcP和HTTP应用的代理，是免费、快速并且可靠的一种解决方案。HProxy非常适用于并发大(并发达1w以上) web站点，这些站点通常又需要会话保持或七层处理。HAProxy的运行模式使得它可以很简单安全的整合至当前的架构中，同时可以保护web服务器不被暴露到网络上。
支持功能
TCP 和 HTTP反向代理SSL/TSL服务器可以针对HTTP请求添加cookie，进行路由后端服务器可平衡负载至后端服务器，并支持持久连接支持所有主服务器故障切换至备用服务器 keepalive支持专用端口实现监控服务支持停止接受新连接请求，而不影响现有连接可以在双向添加，修改或删除HTTP报文首部字段响应报文压缩支持基于pattern实现连接请求的访问控制通过特定的URI（url）为授权用户提供详细的状态信息 2.Haproxy主要特性 可靠性和稳定性非常好，可以与硬件级的F5负载均衡设备相媲美;最高可以同时维护40000-50000个并发连接，单位时间内处理的最大请求数为20000个，最大处理能力可达10Git/s;支持多达8种负载均衡算法,同时也支持会话保持;支持虚拟机主机功能，从而实现web负载均衡更加灵活;支持连接拒绝、全透明代理等独特的功能;拥有强大的ACL支持,用于访问控制; sendfile其独特的弹性二x树数据结构，使数据结构的复杂性上升到了0(1)，即数据的查寻速度不会随着数据条日的增加而速度有所下降;·支持客户端的keepalive功能，减少客户端与haproxy的多次三次握手导致资源浪费，让多个请求在一个tcp连接中完成;支持TCP加速,零复制功能,类似于mmap机制;支持响应池(response buffering) ;支持RDP协议;基于源的粘性，类似nginx的ip hash功能，把来自同一客户端的请求在一定时间内始终调度到上游的同一服务器;·更好统计数据接口，其web接口显示后端集群中各个服务器的接收、发送、拒绝、错误等数据的统计信息;详细的健康状态检测，web接口中有关于对上游服务器的健康检测状态，并提供了一定的管理功能;基于流量的健康评估机制;基于http认证;基于命令行的管理接口;日志分析器,可对日志进行分析 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/47d9e6ec3bb0cd2b3932c93f630a930b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-13T12:16:06+08:00" />
<meta property="article:modified_time" content="2024-03-13T12:16:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux系统---Haproxy高性能负载均衡软件</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:40px;"></p> 
<p id="%E4%B8%80%E3%80%81Haproxy%E4%BB%8B%E7%BB%8D-toc" style="margin-left:40px;"><a href="#%E4%B8%80%E3%80%81Haproxy%E4%BB%8B%E7%BB%8D" rel="nofollow">一、Haproxy介绍</a></p> 
<p id="1.Haproxy%E5%AE%9A%E4%B9%89-toc" style="margin-left:80px;"><a href="#1.Haproxy%E5%AE%9A%E4%B9%89" rel="nofollow">1.Haproxy定义</a></p> 
<p id="2.Haproxy%E4%B8%BB%E8%A6%81%E7%89%B9%E6%80%A7-toc" style="margin-left:80px;"><a href="#2.Haproxy%E4%B8%BB%E8%A6%81%E7%89%B9%E6%80%A7" rel="nofollow">2.Haproxy主要特性</a></p> 
<p id="3.Haproxy%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86-toc" style="margin-left:80px;"><a href="#3.Haproxy%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86" rel="nofollow">3.Haproxy调度算法原理</a></p> 
<p id="3.1RR%EF%BC%88Round%20Robin%EF%BC%89-toc" style="margin-left:120px;"><a href="#3.1RR%EF%BC%88Round%20Robin%EF%BC%89" rel="nofollow">3.1RR（Round Robin）</a></p> 
<p id="3.2LC%EF%BC%88Least%20Connections%EF%BC%89-toc" style="margin-left:120px;"><a href="#3.2LC%EF%BC%88Least%20Connections%EF%BC%89" rel="nofollow">3.2LC（Least Connections）</a></p> 
<p id="3.3SH%EF%BC%88Source%20Hashing%EF%BC%89-toc" style="margin-left:120px;"><a href="#3.3SH%EF%BC%88Source%20Hashing%EF%BC%89" rel="nofollow">3.3SH（Source Hashing）</a></p> 
<p id="%E4%BA%8C%E3%80%81%E5%AE%89%E8%A3%85Haproxy-toc" style="margin-left:40px;"><a href="#%E4%BA%8C%E3%80%81%E5%AE%89%E8%A3%85Haproxy" rel="nofollow">二、安装Haproxy</a></p> 
<p id="1.yum%E5%AE%89%E8%A3%85-toc" style="margin-left:80px;"><a href="#1.yum%E5%AE%89%E8%A3%85" rel="nofollow">1.yum安装</a></p> 
<p id="2.%E7%AC%AC%E4%B8%89%E6%96%B9rpm%E5%8C%85%E5%AE%89%E8%A3%85-toc" style="margin-left:80px;"><a href="#2.%E7%AC%AC%E4%B8%89%E6%96%B9rpm%E5%8C%85%E5%AE%89%E8%A3%85" rel="nofollow">2.第三方rpm包安装</a></p> 
<p id="3.%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-toc" style="margin-left:80px;"><a href="#3.%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85" rel="nofollow">3.编译安装</a></p> 
<p id="3.1%E8%A7%A3%E5%86%B3Lua%E7%8E%AF%E5%A2%83-toc" style="margin-left:120px;"><a href="#3.1%E8%A7%A3%E5%86%B3Lua%E7%8E%AF%E5%A2%83" rel="nofollow">3.1解决Lua环境</a></p> 
<p id="%C2%A03.2%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85Haproxy-toc" style="margin-left:120px;"><a href="#%C2%A03.2%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85Haproxy" rel="nofollow">3.2编译安装Haproxy</a></p> 
<p id="%E4%B8%89%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3-toc" style="margin-left:40px;"><a href="#%E4%B8%89%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3" rel="nofollow">三、配置文件详解</a></p> 
<p id="1.%E7%8A%B6%E6%80%81%E9%A1%B5-toc" style="margin-left:80px;"><a href="#1.%E7%8A%B6%E6%80%81%E9%A1%B5" rel="nofollow">1.状态页</a></p> 
<p id="2.%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-toc" style="margin-left:80px;"><a href="#2.%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86" rel="nofollow">2.日志管理</a></p> 
<p id="2.1%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E5%88%B0%E5%85%B6%E4%BB%96%E4%B8%BB%E6%9C%BA%E7%AB%99%E7%82%B9-toc" style="margin-left:120px;"><a href="#2.1%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E5%88%B0%E5%85%B6%E4%BB%96%E4%B8%BB%E6%9C%BA%E7%AB%99%E7%82%B9" rel="nofollow">2.1定义日志到其他主机站点</a></p> 
<p id="3.%E6%8C%87%E5%AE%9A%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B%E4%B8%AA%E6%95%B0-toc" style="margin-left:80px;"><a href="#3.%E6%8C%87%E5%AE%9A%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B%E4%B8%AA%E6%95%B0" rel="nofollow">3.指定进程线程个数</a></p> 
<p id="4.cpu%E4%BA%B2%E7%BC%98%E6%80%A7-toc" style="margin-left:80px;"><a href="#4.cpu%E4%BA%B2%E7%BC%98%E6%80%A7" rel="nofollow">4.cpu亲缘性</a></p> 
<p id="5.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B-toc" style="margin-left:80px;"><a href="#5.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B" rel="nofollow">5.多进程和线程</a></p> 
<p id="%E5%9B%9B%E3%80%81Proxies%E9%85%8D%E7%BD%AE-toc" style="margin-left:40px;"><a href="#%E5%9B%9B%E3%80%81Proxies%E9%85%8D%E7%BD%AE" rel="nofollow">四、Proxies配置</a></p> 
<p id="1.Proxies%E9%85%8D%E7%BD%AE%E2%80%94%E2%80%94defaults-toc" style="margin-left:80px;"><a href="#1.Proxies%E9%85%8D%E7%BD%AE%E2%80%94%E2%80%94defaults" rel="nofollow">1.Proxies配置——defaults</a></p> 
<p id="2.Proxies%E9%85%8D%E7%BD%AE%E2%80%94%E2%80%94listen-toc" style="margin-left:80px;"><a href="#2.Proxies%E9%85%8D%E7%BD%AE%E2%80%94%E2%80%94listen" rel="nofollow">2.Proxies配置——listen</a></p> 
<p id="2.1%E4%B8%BE%E4%BE%8B%E2%80%94%E2%80%94%E9%BB%98%E8%AE%A4%E6%97%A0%E5%90%8E%E7%AB%AF%E5%81%A5%E5%BA%B7%E6%80%A7%E6%A3%80%E6%B5%8B-toc" style="margin-left:120px;"><a href="#2.1%E4%B8%BE%E4%BE%8B%E2%80%94%E2%80%94%E9%BB%98%E8%AE%A4%E6%97%A0%E5%90%8E%E7%AB%AF%E5%81%A5%E5%BA%B7%E6%80%A7%E6%A3%80%E6%B5%8B" rel="nofollow">2.1举例——默认无后端健康性检测</a></p> 
<p id="2.2%E5%8A%A0%E5%85%A5%E5%81%A5%E5%BA%B7%E6%80%A7%E6%A3%80%E6%B5%8B%E2%80%94%E2%80%94Check-toc" style="margin-left:120px;"><a href="#2.2%E5%8A%A0%E5%85%A5%E5%81%A5%E5%BA%B7%E6%80%A7%E6%A3%80%E6%B5%8B%E2%80%94%E2%80%94Check" rel="nofollow">2.2加入健康性检测——Check</a></p> 
<p id="3.Proxies%E9%85%8D%E7%BD%AE%E2%80%94%E2%80%94frontend-toc" style="margin-left:80px;"><a href="#3.Proxies%E9%85%8D%E7%BD%AE%E2%80%94%E2%80%94frontend" rel="nofollow">3.Proxies配置——frontend</a></p> 
<p id="3.1%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0-toc" style="margin-left:120px;"><a href="#3.1%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0" rel="nofollow">3.1配置参数</a></p> 
<p id="3.2%E4%B8%BE%E4%BE%8B-toc" style="margin-left:120px;"><a href="#3.2%E4%B8%BE%E4%BE%8B" rel="nofollow">3.2举例</a></p> 
<p id="4.Proxies%E9%85%8D%E7%BD%AE%E2%80%94%E2%80%94backend-toc" style="margin-left:80px;"><a href="#4.Proxies%E9%85%8D%E7%BD%AE%E2%80%94%E2%80%94backend" rel="nofollow">4.Proxies配置——backend</a></p> 
<p id="4.1server%E9%85%8D%E7%BD%AE%C2%A0-toc" style="margin-left:120px;"><a href="#4.1server%E9%85%8D%E7%BD%AE%C2%A0" rel="nofollow">4.1server配置 </a></p> 
<p id="%E4%BA%94%E3%80%81%E5%AE%9E%E9%99%85%E6%93%8D%E4%BD%9C-toc" style="margin-left:40px;"><a href="#%E4%BA%94%E3%80%81%E5%AE%9E%E9%99%85%E6%93%8D%E4%BD%9C" rel="nofollow">五、实际操作</a></p> 
<p id="1.%E6%90%AD%E5%BB%BA%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83-toc" style="margin-left:80px;"><a href="#1.%E6%90%AD%E5%BB%BA%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83" rel="nofollow">1.搭建实验环境</a></p> 
<p id="2.%E9%85%8D%E7%BD%AEhaproxy-toc" style="margin-left:80px;"><a href="#2.%E9%85%8D%E7%BD%AEhaproxy" rel="nofollow">2.配置haproxy</a></p> 
<p id="%C2%A03.%E5%89%8D%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE-toc" style="margin-left:80px;"><a href="#%C2%A03.%E5%89%8D%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE" rel="nofollow"> 3.前后端配置</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h3 id="%E4%B8%80%E3%80%81Haproxy%E4%BB%8B%E7%BB%8D">一、Haproxy介绍</h3> 
<p>四层代理</p> 
<ul><li>LVS：Linux Virtual Server</li><li>Nginx</li><li>HAProxy：High Availability Proxy</li></ul> 
<p>七层代理</p> 
<ul><li>HAProxy</li><li>Nginx</li></ul> 
<p>硬件</p> 
<ul><li>F5 https://f5.com/zh</li><li>Netscaler https://www.citrix.com.cn/products/citrix-adc/</li><li>Array https://www.arraynetworks.com.cn/</li><li>深信服 http://www.sangfor.com.cn/</li><li>北京灵州 http://www.lingzhou.com.cn/cpzx/llfzjh/</li></ul> 
<h4 id="1.Haproxy%E5%AE%9A%E4%B9%89">1.Haproxy定义</h4> 
<p>HAProxy是法国开发者威利塔罗(Willy Tarreau)在2000年使用C语言开发的一个开源软件，是一款具备高并发(一万以上)、高性能的TCP和HTTP负载均衡器，支持基于cookie的持久性，自动故障切换，支持正则表达式及web状态统计，目前最新TLS版本为2.2。</p> 
<p>HAProxy是可提供高可用性、负载均衡以及基于TcP和HTTP应用的代理，是免费、快速并且可靠的一种解决方案。HProxy非常适用于并发大(并发达1w以上) web站点，这些站点通常又需要会话保持或七层处理。HAProxy的运行模式使得它可以很简单安全的整合至当前的架构中，同时可以保护web服务器不被暴露到网络上。<br><strong>支持功能</strong></p> 
<ul><li>TCP 和 HTTP反向代理</li><li>SSL/TSL服务器</li><li>可以针对HTTP请求添加cookie，进行路由后端服务器</li><li>可平衡负载至后端服务器，并支持持久连接</li><li>支持所有主服务器故障切换至备用服务器 keepalive</li><li>支持专用端口实现监控服务</li><li>支持停止接受新连接请求，而不影响现有连接</li><li>可以在双向添加，修改或删除HTTP报文首部字段</li><li>响应报文压缩</li><li>支持基于pattern实现连接请求的访问控制</li><li>通过特定的URI（url）为授权用户提供详细的状态信息</li></ul> 
<h4 id="2.Haproxy%E4%B8%BB%E8%A6%81%E7%89%B9%E6%80%A7">2.Haproxy主要特性</h4> 
<ol><li>可靠性和稳定性非常好，可以与硬件级的F5负载均衡设备相媲美;</li><li>最高可以同时维护40000-50000个并发连接，单位时间内处理的最大请求数为20000个，最大处理能力可达10Git/s;</li><li>支持多达8种负载均衡算法,同时也支持会话保持;</li><li>支持虚拟机主机功能，从而实现web负载均衡更加灵活;</li><li>支持连接拒绝、全透明代理等独特的功能;</li><li>拥有强大的ACL支持,用于访问控制; sendfile</li><li>其独特的弹性二x树数据结构，使数据结构的复杂性上升到了0(1)，即数据的查寻速度不会随着数据条日的增加而速度有所下降;·支持客户端的keepalive功能，减少客户端与haproxy的多次三次握手导致资源浪费，让多个请求在一个tcp连接中完成;</li><li>支持TCP加速,零复制功能,类似于mmap机制;</li><li>支持响应池(response buffering) ;</li><li>支持RDP协议;</li><li>基于源的粘性，类似nginx的ip hash功能，把来自同一客户端的请求在一定时间内始终调度到上游的同一服务器;·更好统计数据接口，其web接口显示后端集群中各个服务器的接收、发送、拒绝、错误等数据的统计信息;</li><li>详细的健康状态检测，web接口中有关于对上游服务器的健康检测状态，并提供了一定的管理功能;</li><li>基于流量的健康评估机制;</li><li>基于http认证;</li><li>基于命令行的管理接口;</li><li>日志分析器,可对日志进行分析</li></ol> 
<h4 id="3.Haproxy%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86">3.Haproxy调度算法原理</h4> 
<h5 id="3.1RR%EF%BC%88Round%20Robin%EF%BC%89"><a name="t4"></a>3.1RR（Round Robin）</h5> 
<p>RR算法是最简单最常用的一种算法，即轮询调度 </p> 
<h5 id="3.2LC%EF%BC%88Least%20Connections%EF%BC%89">3.2LC（Least Connections）</h5> 
<p>最小连接数算法，根据后端的节点连接数大小动态分配前端请求</p> 
<h5 id="3.3SH%EF%BC%88Source%20Hashing%EF%BC%89"><a name="t6"></a>3.3SH（Source Hashing）</h5> 
<p>基于来源访问调度算法，用于一些有Session会话记录在服务器前端的场景，可以基于来源的IP、Cookie等做集群调度</p> 
<h3 id="%E4%BA%8C%E3%80%81%E5%AE%89%E8%A3%85Haproxy">二、安装Haproxy</h3> 
<h4 id="1.yum%E5%AE%89%E8%A3%85"><a name="t8"></a>1.yum安装</h4> 
<p>CentOS 7 的默认的base仓库中包含haproxy的安装包文件，但是版本比较旧，是1.5.18的版本，距离当前版本已经有较长时间没有更新，由于版本比较旧所以有很多功能不支持，如果对功能和性能没有要求可以使用此版本，否则推荐使用新版本。</p> 
<pre><code class="language-bash">[root@localhost ~]#yum install centos-release-scl-rh -y
#安装额外源
[root@localhost ~]#yum install rh-haproxy18-haproxy -y
[root@localhost ~]#yum install haproxy -y
[root@localhost ~]#rpm -q haproxy 
haproxy-1.5.18-9.el7_9.1.x86_64
[root@localhost ~]#haproxy -v
HA-Proxy version 1.5.18 2016/05/10
Copyright 2000-2016 Willy Tarreau &lt;willy@haproxy.org&gt;</code></pre> 
<h4 id="2.%E7%AC%AC%E4%B8%89%E6%96%B9rpm%E5%8C%85%E5%AE%89%E8%A3%85">2.第三方rpm包安装</h4> 
<p>官方没有提供rpm相关的包,可以通过第三方仓库的rpm包</p> 
<p>从第三方网站下载rpm包：<a href="https://pkgs.org/download/haproxy" rel="nofollow" title="https://pkgs.org/download/haproxy">https://pkgs.org/download/haproxy</a></p> 
<p>基于互联网第三方仓库在线安装</p> 
<pre><code class="language-bash">[root@localhost opt]#rz -E
rz waiting to receive.
[root@localhost opt]#rz -E
rz waiting to receive.
[root@localhost opt]#ls
rh-haproxy18-haproxy-1.8.24-3.el7.x86_64.rpm
rh-haproxy18-runtime-3.1-2.el7.x86_64.rpm
[root@localhost opt]#yum install rh-haproxy18-runtime-3.1-2.el7.x86_64.rpm -y
[root@localhost opt]#yum install rh-haproxy18-haproxy-1.8.24-3.el7.x86_64.rpm -y
[root@localhost opt]#systemctl start rh-haproxy18-haproxy.service 
[root@localhost opt]#systemctl status rh-haproxy18-haproxy.service 
● rh-haproxy18-haproxy.service - HAProxy Load Balancer
   Loaded: loaded (/usr/lib/systemd/system/rh-haproxy18-haproxy.service; disabled; vendor preset: disabled)
   Active: active (running) since 五 2024-03-08 12:14:13 CST; 4s ago
  Process: 3109 ExecStartPre=/opt/rh/rh-haproxy18/root/usr/sbin/haproxy -f $CONFIG -c -q $OPTIONS (code=exited, status=0/SUCCESS)
 Main PID: 3113 (haproxy)
   CGroup: /system.slice/rh-haproxy18-haproxy.service
           ├─3113 /opt/rh/rh-haproxy18/root/usr/sbin/haproxy -Ws -f /etc/o...
           └─3114 /opt/rh/rh-haproxy18/root/usr/sbin/haproxy -Ws -f /etc/o...
 
3月 08 12:14:13 localhost.localdomain systemd[1]: Starting HAProxy Load B...
3月 08 12:14:13 localhost.localdomain systemd[1]: Started HAProxy Load Ba...
Hint: Some lines were ellipsized, use -l to show in full.
[root@localhost data]#/opt/rh/rh-haproxy18/root/usr/sbin/haproxy -v
HA-Proxy version 1.8.24 2020/02/15
Copyright 2000-2020 Willy Tarreau &lt;willy@haproxy.org&gt;</code></pre> 
<h4 id="3.%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85">3.编译安装</h4> 
<p>编译安装HAProxy 2.0 LTS版本，更多源码包下载地址：<a href="http://www.haproxy.org/download/" rel="nofollow" title="http://www.haproxy.org/download/">http://www.haproxy.org/download/</a></p> 
<h5 id="3.1%E8%A7%A3%E5%86%B3Lua%E7%8E%AF%E5%A2%83">3.1解决Lua环境</h5> 
<p>HAProxy 支持基于lua实现功能扩展，lua是一种小巧的脚本语言，于1993年由巴西里约热内卢天主教大学（Pontifical Catholic University of Rio de Janeiro）里的一个研究小组开发，其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p> 
<blockquote> 
 <p>Lua 官网：<a href="https://blog.csdn.net/G_D0120/article/details/www.lua.org" title="www.lua.org">www.lua.org</a></p> 
</blockquote> 
<p>Lua 应用场景</p> 
<ul><li>游戏开发</li><li>独立应用脚本</li><li>Web 应用脚本</li><li>扩展和数据库插件，如MySQL Proxy</li><li>安全系统，如入侵检测系统</li></ul> 
<h5 id="%C2%A03.2%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85Haproxy">3.2编译安装Haproxy</h5> 
<p>由于CentOS7 之前版本自带的lua版本比较低并不符合HAProxy要求的lua最低版本(5.3)的要求，因此需要编译安装较新版本的lua环境，然后才能编译安装HAProxy</p> 
<pre><code class="language-bash">[root@localhost ~]#lua -v
Lua 5.1.4  Copyright (C) 1994-2008 Lua.org, PUC-Rio
[root@localhost opt]#curl -R -O http://www.lua.org/ftp/lua-5.4.6.tar.gz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--       0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--       0     0    0     0    0     0      0      0 --:--:--  0:00:02 --:--:--       0     0    0     0    0     0      0      0 --:--:--  0:00:03 --:--:--       0     0    0     0    0     0      0      0 --:--:--  0:00:03 --:--:--     100   169  100   169    0     0     40      0  0:00:04  0:00:04 --:--:--    40
[root@localhost opt]#ls
lua-5.4.6.tar.gz
[root@localhost opt]#tar zxf lua-5.4.6.tar.gz
[root@localhost opt]#cd lua-5.4.4/
[root@localhost lua-5.4.4]#make all
[root@localhost lua-5.4.4]#cd ..
[root@localhost opt]#ls
lua-5.4.4  lua-5.4.4.tar.gz
[root@localhost opt]#ln -s lua-5.4.4 lua
[root@localhost opt]#ls
lua  lua-5.4.4  lua-5.4.4.tar.gz
[root@localhost opt]#rz -E
rz waiting to receive.
[root@localhost opt]#ls
haproxy-2.4.25.tar.gz  lua  lua-5.4.4  lua-5.4.4.tar.gz
[root@localhost opt]#tar xf haproxy-2.4.25.tar.gz 
[root@localhost opt]#cd haproxy-2.4.25/
[root@localhost haproxy-2.4.25]#ls
addons     CONTRIBUTING  include      Makefile   scripts  VERDATE
admin      dev           INSTALL      README     src      VERSION
BRANCHES   doc           LICENSE      reg-tests  SUBVERS
CHANGELOG  examples      MAINTAINERS  ROADMAP    tests
[root@localhost haproxy-2.4.25]#vim INSTALL
#可以查看如何编译安装
[root@localhost haproxy-2.4.25]#yum -y install gcc openssl-devel pcre-devel systemd-devel
#安装依赖环境
[root@localhost haproxy-2.4.25]#make ARCH=x86_64 TARGET=linux-glibc USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 USE_SYSTEMD=1 USE_LUA=1 LUA_INC=/opt/lua/src/  LUA_LIB=/opt/lua/src/
[root@localhost haproxy-2.4.25]#make install PREFIX=/apps/haproxy
[root@localhost haproxy-2.4.25]#ls /apps/haproxy/
doc  sbin  share
[root@localhost haproxy]#ln -s /apps/haproxy/sbin/haproxy /usr/sbin/
[root@localhost haproxy]#haproxy -v
HAProxy version 2.4.25-6cfe787 2023/12/14 - https://haproxy.org/
Status: long-term supported branch - will stop receiving fixes around Q2 2026.
Known bugs: http://www.haproxy.org/bugs/bugs-2.4.25.html
Running on: Linux 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64
[root@localhost haproxy]#tee /usr/lib/systemd/system/haproxy.service  &lt;&lt;eof
&gt; 
&gt; [Unit]
&gt; Description=HAProxy Load Balancer
&gt; After=syslog.target network.target
&gt; 
&gt; [Service]
&gt; ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg  -c -q
&gt; ExecStart=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /var/lib/haproxy/haproxy.pid
&gt; ExecReload=/bin/kill -USR2 $MAINPID
&gt; LimitNOFILE=100000
&gt; 
&gt; [Install]
&gt; WantedBy=multi-user.target
&gt; 
&gt; 
&gt; eof
[root@localhost haproxy]#cat /usr/lib/systemd/system/haproxy.service 
 
[Unit]
Description=HAProxy Load Balancer
After=syslog.target network.target
 
[Service]
ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg  -c -q
ExecStart=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /var/lib/haproxy/haproxy.pid
ExecReload=/bin/kill -USR2 
LimitNOFILE=100000
 
[Install]
WantedBy=multi-user.target
 
[root@localhost haproxy]#mkdir /etc/haproxy
[root@localhost haproxy]#vim /etc/haproxy/haproxy.cfg
[root@localhost haproxy]#mkdir /var/lib/haproxy
[root@localhost haproxy]#useradd -r -s /sbin/nologin haproxy
[root@localhost haproxy]#id haproxy
uid=990(haproxy) gid=985(haproxy) 组=985(haproxy)
[root@localhost haproxy]#systemctl enable --now haproxy.service
Created symlink from /etc/systemd/system/multi-user.target.wants/haproxy.service to /usr/lib/systemd/system/haproxy.service.
[root@localhost haproxy]#systemctl status haproxy.service 
● haproxy.service - HAProxy Load Balancer
   Loaded: loaded (/usr/lib/systemd/system/haproxy.service; enabled; vendor preset: disabled)
   Active: active (running) since 五 2024-03-08 13:18:01 CST; 6s ago
  Process: 5041 ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -c -q (code=exited, status=0/SUCCESS)
 Main PID: 5044 (haproxy)
   CGroup: /system.slice/haproxy.service
           ├─5044 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /va...
           └─5049 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /va...
 
3月 08 13:18:01 localhost.localdomain systemd[1]: Starting HAProxy Load B...
3月 08 13:18:01 localhost.localdomain systemd[1]: Started HAProxy Load Ba...
3月 08 13:18:01 localhost.localdomain haproxy[5044]: [NOTICE]   (5044) : ...
3月 08 13:18:01 localhost.localdomain haproxy[5044]: [WARNING]  (5049) : ...
3月 08 13:18:01 localhost.localdomain haproxy[5044]: [NOTICE]   (5049) : ...
3月 08 13:18:01 localhost.localdomain haproxy[5044]: [NOTICE]   (5049) : ...
3月 08 13:18:01 localhost.localdomain haproxy[5044]: [ALERT]    (5049) : ...
Hint: Some lines were ellipsized, use -l to show in full.
[root@localhost haproxy]#pstree|grep haproxy
        |-haproxy---haproxy---{haproxy}</code></pre> 
<h3 id="%E4%B8%89%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3">三、配置文件详解</h3> 
<blockquote> 
 <p>官方地址配置文件官方帮助文档</p> 
 <p>http://cbonte.github.io/haproxy-dconv/<br> http://cbonte.github.io/haproxy-dconv/2.4/configuration.html<br> https://www.haproxy.org/download/2.5/doc/configuration.txt</p> 
</blockquote> 
<p> HAProxy 的配置文件haproxy.cfg由两大部分组成，分别是global和proxies部分</p> 
<ol><li>global：全局配置段     进程及安全配置相关的参数；性能调整相关参数；Debug参数</li><li>proxies：代理配置段</li></ol> 
<ul><li>defaults：为frontend, backend, listen提供默认配置</li><li>frontend：前端，相当于nginx中的server {}</li><li>backend：后端，相当于nginx中的upstream {}</li><li>listen：同时拥有前端和后端配置,配置简单,生产推荐使用 </li></ul> 
<pre><code class="language-bash">global
#全局配置
maxconn 100000
#最大连接数
chroot /apps/haproxy
#锁定运行目录，类似于ftp中的禁锢
stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin
#Socket文件 进程间通信
uid 99
#运行haproxy用户身份
gid 99
#运行haproxy用户身份
daemon
#后台运行
#nbproc 4
#开启的haproxy work 进程数，默认进程数是一个
#nbthread  1    #和多进程 nbproc配置互斥（版本有关,CentOS8的haproxy1.8无此问题）,指定每个haproxy进程开启的线程数，默认为每个进程一个线程
#如果同时启用nbproc和nbthread 会出现以下日志的错误，无法启动服务Apr  714:46:23 haproxy haproxy: [ALERT] 097/144623 (1454) : config : cannot enable multiple processes if multiple threads are configured. Please use either nbproc or nbthread but not both.
#cpu-map 1 0
#绑定haproxy worker 进程至指定CPU，将第1个work进程绑定至0号CPU
#cpu-map 2 1
##绑定haproxy worker 进程至指定CPU，将第2个work进程绑定至1号CPU
#cpu-map 3 2
#cpu-map 4 3
#CPU的亲缘性  绑定cpu   可以通过ps axo  pid,cmd,psr,pid |grep haproxy查看cpu亲缘性状态
#maxsslconn  n
#每个haproxy进程ssl最大连接数,用于haproxy配置了证书的场景下
#maxconnrate n
#每个进程每秒创建的最大连接数量
#spread-checks n
#后端server状态check随机提前或延迟百分比时间，建议2-5(20%-50%)之间，默认值0
pidfile /var/lib/haproxy/haproxy.pid
#pid运行路径
log 127.0.0.1 local3 info
#日志级别
 
defaults
#默认模块
option http-keep-alive
#可以和http  Keepalive进行搭配使用   模式为http（7层代理http，4层代理tcp）
option  forwardfor
#可以IP透传
#option  httplog	   	#日志类别为http日志格式		 	
#option  dontlognull	#不记录健康检查日志信息
#retries 3           #检查节点服务器失败次数，连续达到3次，则反馈不可用 
#redispatch			#当服务器负载很高时，自动结束当前队列处理比较久的连接
maxconn 100000
#最大连接数，此处的数值不能大于全局里的数值
mode http
#模式 http
timeout connect 300000ms
#设置连接超时时间，默认单位是毫秒
timeout client  300000ms
#设置客户端超时时间，默认单位是毫秒
timeout server  300000ms
#设置服务器超时时间，默认单位是毫秒
 
listen stats
 #状态页
 mode http
 #模式http
 bind 0.0.0.0:9999
 #绑定任意地址的9999端口
 stats enable
 #开启
 log global
 #引入global定义的日志格式
 stats uri     /haproxy-status
 #状态页位置
 stats auth    haadmin:123456
 #用户为haadmin 密码为123456
 
listen  web_port
 bind 0.0.0.0:8899
 mode http
 log global
 server web1  127.0.0.1:8080  check inter 3000 fall 2 rise 5
 #后端真实服务器            检查健康性       延迟等待3000毫秒  失败两次  五次之后重连
 
 
 
defaults [&lt;name&gt;]
#默认配置项，针对以下的frontend、backend和listen生效，可以多个name也可以没有name
frontend &lt;name&gt;
#前端servername，类似于Nginx的一个虚拟主机 server和LVS服务集群。
backend &lt;name&gt;
#后端服务器组，等于nginx的upstream和LVS中的RS服务器
listen   &lt;name&gt;
#将frontend和backend合并在一起配置，相对于frontend和backend配置更简洁，生产常用
 
 
 
 
使用listen替换 frontend和backend的配置方式，可以简化设置，通常只用于TCP协议的应用
#官网业务访问入口
listen  webcluster 0.0.0.0:80
        option httpchk GET /test.html
        balance roundrobin
        server  inst1 192.168.241.22:80 check inter 2000 fall 3
        server  inst2 192.168.241.23:80 check inter 2000 fall 3</code></pre> 
<h4 id="1.%E7%8A%B6%E6%80%81%E9%A1%B5">1.状态页</h4> 
<pre><code class="language-bash">[root@localhost ~]#vim /etc/haproxy/haproxy.cfg 
 
 
 
listen stats
#状态页
 mode http
#模式为http
 bind 192.168.241.11:9999
#绑定在192.168.241.11 端口为9999上
 stats enable
#状态开启
 log global
 stats uri     /haproxy-status
#状态页位置
 stats auth    haadmin:123456
#状态页登录用户名为haadmin 密码为123456</code></pre> 
<pre><code class="language-bash">[root@localhost ~]#systemctl restart haproxy.service</code></pre> 
<p><img alt="" height="317" src="https://images2.imgbox.com/f6/d6/rBt2AbdZ_o.png" width="1057"></p> 
<p><img alt="" height="492" src="https://images2.imgbox.com/52/0e/kOJIJJ2W_o.png" width="1002"></p> 
<p><img alt="" height="351" src="https://images2.imgbox.com/7f/b3/ISVLuGEX_o.png" width="1050"></p> 
<h4 id="2.%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86">2.日志管理</h4> 
<p>HAproxy本身不记录客户端的访问日志.此外为减少服务器负载,一般生产中HAProxy不记录日志.也可以配置HAProxy利用rsyslog服务记录日志到指定日志服务器文件中  </p> 
<pre><code class="language-bash">[root@localhost ~]#vim /etc/haproxy/haproxy.cfg 
</code></pre> 
<p><img alt="" height="459" src="https://images2.imgbox.com/15/20/4nTwPmrs_o.png" width="1090"></p> 
<pre><code class="language-bash">[root@localhost ~]#vim /etc/rsyslog.conf </code></pre> 
<p><img alt="" height="305" src="https://images2.imgbox.com/ae/fd/FX5rfkgg_o.png" width="1163"></p> 
<blockquote> 
 <p>定义haproxy的日志站点为/var/log/haproxy.log</p> 
</blockquote> 
<pre><code class="language-bash">[root@localhost ~]#systemctl restart haproxy.service rsyslog.service 
[root@localhost ~]#tail -f /var/log/haproxy.log
Mar  8 14:04:51 localhost haproxy[10999]: Connect from 192.168.241.1:51168 to 192.168.241.11:9999 (stats/HTTP)
Mar  8 14:04:52 localhost haproxy[10999]: Connect from 192.168.241.1:51168 to 192.168.241.11:9999 (stats/HTTP)</code></pre> 
<h5 id="2.1%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E5%88%B0%E5%85%B6%E4%BB%96%E4%B8%BB%E6%9C%BA%E7%AB%99%E7%82%B9">2.1定义日志到其他主机站点</h5> 
<pre><code class="language-bash">[root@localhost ~]#vim /etc/haproxy/haproxy.cfg </code></pre> 
<p><img alt="" height="472" src="https://images2.imgbox.com/b1/ef/ysAiDxIT_o.png" width="1166"></p> 
<pre><code class="language-bash">[root@node2 ~]#vim /etc/rsyslog.conf </code></pre> 
<p><img alt="" height="135" src="https://images2.imgbox.com/28/c3/1M7FOZ84_o.png" width="769"></p> 
<p><img alt="" height="88" src="https://images2.imgbox.com/22/24/xZ6yav5p_o.png" width="1169"></p> 
<pre><code class="language-bash">[root@node2 ~]#systemctl restart rsyslog.service </code></pre> 
<pre><code class="language-bash">[root@localhost ~]#systemctl restart haproxy.service 
</code></pre> 
<blockquote> 
 <p>不建议在本机开启日志功能</p> 
</blockquote> 
<pre><code class="language-bash">[root@node2 ~]#tail -f /var/log/haproxy.log
Mar  8 14:09:10 192.168.241.11 haproxy[11100]: Server web_port/web1 is DOWN, reason: Layer4 connection problem, info: "Connection refused", check duration: 0ms. 0 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue.
Mar  8 14:09:10 192.168.241.11 haproxy[11100]: proxy web_port has no server available!</code></pre> 
<h4 id="3.%E6%8C%87%E5%AE%9A%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B%E4%B8%AA%E6%95%B0">3.指定进程线程个数</h4> 
<p>进程与线程会有冲突</p> 
<pre><code class="language-bash">nbproc    n     #开启的haproxy work 进程数，默认进程数是一个
#nbthread  1    #和多进程 nbproc配置互斥（版本有关,CentOS8的haproxy1.8无此问题）,指定每个haproxy进程开启的线程数，默认为每个进程一个线程
#如果同时启用nbproc和nbthread 会出现以下日志的错误，无法启动服务Apr  714:46:23 haproxy haproxy: [ALERT] 097/144623 (1454) : config : cannot enable multiple processes if multiple threads are configured. Please use either nbproc or nbthread but not both.</code></pre> 
<pre><code class="language-bash">[root@localhost ~]#vim /etc/haproxy/haproxy.cfg 
[root@localhost ~]#pstree |grep haproxy
        |-haproxy---haproxy---{haproxy}
[root@localhost ~]#vim /etc/haproxy/haproxy.cfg 
[root@localhost ~]#systemctl restart haproxy.service
[root@localhost ~]#pstree |grep haproxy
        |-haproxy---4*[haproxy]</code></pre> 
<h4 id="4.cpu%E4%BA%B2%E7%BC%98%E6%80%A7">4.cpu亲缘性</h4> 
<pre><code class="language-bash">nbproc  2
cpu-map 1  0     #绑定haproxy worker 进程至指定CPU，将第1个work进程绑定至0号CPU
cpu-map 2  1     #绑定haproxy worker 进程至指定CPU，将第2个work进程绑定至1  号CPU
                
ps axo  pid,cmd,psr,pid  |grep haproxy</code></pre> 
<pre><code class="language-bash">[root@localhost ~]#vim /etc/haproxy/haproxy.cfg 
 
cpu-map 1 0
cpu-map 2 1
cpu-map 3 2
cpu-map 4 3
 
[root@localhost ~]#ps axo pid,cmd,psr|grep haproxy
 11270 /usr/sbin/haproxy -Ws -f /e   1
 11274 /usr/sbin/haproxy -Ws -f /e   0
 11275 /usr/sbin/haproxy -Ws -f /e   1
 11276 /usr/sbin/haproxy -Ws -f /e   0
 11277 /usr/sbin/haproxy -Ws -f /e   0
 11303 grep --color=auto haproxy     1
[root@localhost ~]#vim /etc/haproxy/haproxy.cfg 
 
#cpu-map 1 0
#cpu-map 2 1
#cpu-map 3 2
#cpu-map 4 3
 
[root@localhost ~]#systemctl restart haproxy
[root@localhost ~]#ps axo pid,cmd,psr|grep haproxy
 11319 /usr/sbin/haproxy -Ws -f /e   1
 11324 /usr/sbin/haproxy -Ws -f /e   1
 11325 /usr/sbin/haproxy -Ws -f /e   0
 11326 /usr/sbin/haproxy -Ws -f /e   1
 11327 /usr/sbin/haproxy -Ws -f /e   0
 11329 grep --color=auto haproxy     1</code></pre> 
<h4 id="5.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B">5.<strong>多进程和线程</strong></h4> 
<pre><code class="language-bash">[root@localhost ~]#vim /etc/haproxy/haproxy.cfg 
 
stats socket /var/lib/haproxy/haproxy.sock1 mode 600 level admin process 1       
stats socket /var/lib/haproxy/haproxy.sock2 mode 600 level admin process 2
 
[root@localhost ~]#systemctl restart haproxy.service 
[root@localhost ~]#pstree -p|grep haproxy
           |-haproxy(11416)-+-haproxy(11420)
           |                |-haproxy(11421)
           |                |-haproxy(11422)
           |                `-haproxy(11423)
[root@localhost ~]#ll /var/lib/haproxy/
总用量 4
-rw-r--r-- 1 root root 6 3月   8 14:24 haproxy.pid
srw------- 1 root root 0 3月   8 14:21 haproxy.sock
srw------- 1 root root 0 3月   8 14:24 haproxy.sock1
srw------- 1 root root 0 3月   8 14:24 haproxy.sock2</code></pre> 
<h3 id="%E5%9B%9B%E3%80%81Proxies%E9%85%8D%E7%BD%AE">四、Proxies配置</h3> 
<blockquote> 
 <p>官方文档：<a href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4" rel="nofollow" title="HAProxy version 2.1.12 - Configuration Manual">HAProxy version 2.1.12 - Configuration Manual</a></p> 
</blockquote> 
<pre><code class="language-bash">defaults [&lt;name&gt;] #默认配置项，针对以下的frontend、backend和listen生效，可以多个name也可以没有name
frontend &lt;name&gt;   #前端servername，类似于Nginx的一个虚拟主机 server和LVS服务集群。
backend &lt;name&gt;   #后端服务器组，等于nginx的upstream和LVS中的RS服务器
listen  &lt;name&gt;   #将frontend和backend合并在一起配置，相对于frontend和backend配置更简洁，生产常用</code></pre> 
<blockquote> 
 <p><strong>注意</strong>：name字段只能使用大小写字母，数字，‘-’(dash)，'_‘(underscore)，'.' (dot)和 ':'(colon)，并且严格区分大小写  </p> 
</blockquote> 
<h4 id="1.Proxies%E9%85%8D%E7%BD%AE%E2%80%94%E2%80%94defaults">1.Proxies配置——defaults</h4> 
<pre><code class="language-bash">option redispatch
#当server Id对应的服务器挂掉后，强制定向到其他健康的服务器，重新派发
option abortonclose
#当服务器负载很高时，自动结束掉当前队列处理比较久的连接，针对业务情况选择开启
option http-keep-alive
#开启与客户端的会话保持
option forwardfor
#透传客户端真实IP至后端web服务器
mode http|tcp
#设置默认工作类型,使用TCP服务器性能更好，减少压力
timeout http-keep-alive 120s
#session 会话保持超时时间，此时间段内会转发到相同的后端服务器
timeout connect 120s
#客户端请求从haproxy到后端server最长连接等待时间(TCP连接之前)，默认单位ms
timeout server 600s
#客户端请求从haproxy到后端服务端的请求处理超时时长(TCP连接之后)，默认单位ms，如果超时，会出现502错误，此值建议设置较大些，防止502错误
timeout client 600s
#设置haproxy与客户端的最长非活动时间，默认单位ms，建议和timeout server相同
timeout check   5s
#对后端服务器的默认检测超时时间
default-server inter 1000 weight 3
#指定后端服务器的默认设置</code></pre> 
<h4 id="2.Proxies%E9%85%8D%E7%BD%AE%E2%80%94%E2%80%94listen">2.Proxies配置——listen</h4> 
<p>使用listen替换 frontend和backend的配置方式，可以简化设置，通常只用于TCP协议的应用</p> 
<pre><code class="language-bash">#官网业务访问入口
listen WEB_PORT_80    #业务名称 支持自定义
   bind 10.0.0.7:80   #ip加端口
   mode http          #默认 可以不写
   option forwardfor  #透传客户端真实IP至后端web服务器
   server web1   10.0.0.17:8080   check inter 3000 fall 3 rise 5
   server web2   10.0.0.27:8080   check inter 3000 fall 3 rise 5</code></pre> 
<h5 id="2.1%E4%B8%BE%E4%BE%8B%E2%80%94%E2%80%94%E9%BB%98%E8%AE%A4%E6%97%A0%E5%90%8E%E7%AB%AF%E5%81%A5%E5%BA%B7%E6%80%A7%E6%A3%80%E6%B5%8B">2.1举例——默认无后端健康性检测</h5> 
<pre><code class="language-bash">listen  Web_port_80
 bind 192.168.241.11:80
 mode http
 log global
 server rs1  192.168.241.22:80
 server rs2  192.168.241.23:80</code></pre> 
<h5 id="2.2%E5%8A%A0%E5%85%A5%E5%81%A5%E5%BA%B7%E6%80%A7%E6%A3%80%E6%B5%8B%E2%80%94%E2%80%94Check">2.2加入健康性检测——Check</h5> 
<pre><code class="language-bash">listen  WEb_port_80
 bind 192.168.241.11:80
 mode http
 log global
 server rs1  192.168.241.22:80  check
 server rs2  192.168.241.23:80  check</code></pre> 
<h4 id="3.Proxies%E9%85%8D%E7%BD%AE%E2%80%94%E2%80%94frontend">3.Proxies配置——frontend</h4> 
<h5 id="3.1%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><a name="t26"></a>3.1配置参数</h5> 
<pre><code class="language-bash">bind：
#指定HAProxy的监听地址，可以是IPV4或IPV6，可以同时监听多个IP或端口，可同时用于
listen字段中
 
#格式：
bind [&lt;address&gt;]:&lt;port_range&gt; [, ...] [param*]
#注意：如果需要绑定在非本机的IP，需要开启内核参数：net.ipv4.ip_nonlocal_bind=1
 
backlog &lt;backlog&gt; #针对所有server配置,当前端服务器的连接数达到上限后的后援队列长度，注
意：不支持backend</code></pre> 
<h5 id="3.2%E4%B8%BE%E4%BE%8B">3.2举例</h5> 
<pre><code class="language-bash">listen http_proxy #监听http的多个IP的多个端口和sock文件
   bind :80,:443,:8801-8810
   bind 10.0.0.1:10080,10.0.0.1:10443
   bind /var/run/ssl-frontend.sock user root mode 600 accept-proxy
 
 
listen http_https_proxy #https监听
   bind :80
   bind :443 ssl crt /etc/haproxy/site.pem #公钥和私钥公共文件
 
 
listen http_https_proxy_explicit #监听ipv6、ipv4和unix sock文件
   bind ipv6@:80
   bind ipv4@public_ssl:443 ssl crt /etc/haproxy/site.pem
   bind unix@ssl-frontend.sock user root mode 600 accept-proxy
 
 
 
listen external_bind_app1 #监听file descriptor
   bind "fd@${FD_APP1}"</code></pre> 
<p></p> 
<pre><code class="language-bash">frontend sport_web_port
#可以采用后面形式命名：业务-服务-端口号
   bind :80,:8080
#指定监听地址80和8080
   bind 10.0.0.7:10080,:8801-8810,10.0.0.17:9001-9010
   mode http|tcp     #指定负载协议类型
   use_backend &lt;backend_name&gt;  #调用的后端服务器组名称</code></pre> 
<h4 id="4.Proxies%E9%85%8D%E7%BD%AE%E2%80%94%E2%80%94backend">4.Proxies配置——backend</h4> 
<p>定义一组后端服务器，backend服务器将被frontend进行调用。</p> 
<blockquote> 
 <p><strong>注意</strong>: backend 的名称必须唯一,并且必须在listen或frontend中事先定义才可以使用,否则服务无法启动</p> 
</blockquote> 
<pre><code class="language-bash">mode http|tcp
#指定负载协议类型,和对应的frontend必须一致
option
#配置选项
server
定义后端real server,必须指定IP和端口</code></pre> 
<h5 id="4.1server%E9%85%8D%E7%BD%AE%C2%A0">4.1server配置 </h5> 
<pre><code class="language-bash">#针对一个RS（real server后端真实服务器）配置
check
#对指定real进行健康状态检查，如果不加此设置，默认不开启检查,只有check后面没有其它配置也可以启用检查功能
#默认对相应的后端服务器IP和端口,利用TCP连接进行周期性健康性检查,注意必须指定端口才能实现健康性检查
 addr &lt;IP&gt;   #可指定的健康状态监测IP，可以是专门的数据网段，减少业务网络的流量
 port &lt;num&gt; #指定的健康状态监测端口
 inter &lt;num&gt; #健康状态检查间隔时间，默认2000 ms
 fall &lt;num&gt;   #后端服务器从线上转为线下的检查的连续失效次数，默认为3
 rise &lt;num&gt;   #后端服务器从下线恢复上线的检查的连续有效次数，默认为2
weight &lt;weight&gt; #默认为1，最大值为256，0(状态为蓝色)表示不参与负载均衡，但仍接受持久连
接
backup
#将后端服务器标记为备份状态,只在所有非备份主机down机时提供服务，类似
Sorry Server
disabled
#将后端服务器标记为不可用状态，即维护状态，除了持久模式，将不再接受连接,状态为深黄色,优雅下线,不再接受新用户的请求
redirect prefix http://www.baidu.com/
#将请求临时(302)重定向至其它URL，只适用于http模式
redir http://www.baidu.com
#将请求临时(302)重定向至其它URL，只适用于http模式
maxconn &lt;maxconn&gt;
#当前后端server的最大并发连接数</code></pre> 
<h3 id="%E4%BA%94%E3%80%81%E5%AE%9E%E9%99%85%E6%93%8D%E4%BD%9C">五、实际操作</h3> 
<h4 id="1.%E6%90%AD%E5%BB%BA%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><a name="t31"></a>1.搭建实验环境</h4> 
<p>Centos7-1作为haproxy服务器；Centos7-2作为提供Web服务器的后端真实服务器1；Centos7-3作为提供Web服务的后端真实服务器2。</p> 
<pre><code class="language-bash">[root@localhost ~]#systemctl stop firewalld
[root@localhost ~]#setenforce 0
setenforce: SELinux is disabled</code></pre> 
<pre><code class="language-bash">[root@node2 ~]#systemctl stop firewalld
[root@node2 ~]#setenforce 0
[root@node2 ~]#yum install httpd -y
[root@node2 ~]#systemctl start httpd
[root@node2 ~]#systemctl status httpd
[root@node2 ~]#echo cxk &gt; /var/www/html/index.html
[root@node2 ~]#cat /var/www/html/index.html
cxk</code></pre> 
<pre><code class="language-bash">[root@node3 ~]#systemctl stop firewalld
[root@node3 ~]#setenforce 0
[root@node3 ~]#yum install httpd -y
[root@node3 ~]#systemctl start httpd
[root@node3 ~]#systemctl status httpd
[root@node3 ~]#echo wyb &gt; /var/www/html/index.html
[root@node3 ~]#cat /var/www/html/index.html 
wyb</code></pre> 
<h4 id="2.%E9%85%8D%E7%BD%AEhaproxy">2.配置haproxy</h4> 
<pre><code class="language-bash">[root@localhost ~]#vim /etc/haproxy/haproxy.cfg </code></pre> 
<pre><code class="language-bash">[root@localhost ~]#curl 192.168.241.11
wyb
[root@localhost ~]#curl 192.168.241.11
&lt;html&gt;&lt;body&gt;&lt;h1&gt;503 Service Unavailable&lt;/h1&gt;
No server is available to handle this request.
&lt;/body&gt;&lt;/html&gt;</code></pre> 
<pre><code class="language-bash">[root@localhost ~]#systemctl restart haproxy.service </code></pre> 
<p><img alt="" height="335" src="https://images2.imgbox.com/f5/f0/iByJIIhF_o.png" width="645"> </p> 
<blockquote> 
 <p>如果将其中一台后端真实服务器Web服务停止的话，会报错 </p> 
</blockquote> 
<pre><code class="language-bash">[root@node2 ~]#systemctl stop httpd</code></pre> 
<pre><code class="language-bash">[root@localhost ~]#curl 192.168.241.11
wyb
[root@localhost ~]#curl 192.168.241.11
&lt;html&gt;&lt;body&gt;&lt;h1&gt;503 Service Unavailable&lt;/h1&gt;
No server is available to handle this request.
&lt;/body&gt;&lt;/html&gt;</code></pre> 
<blockquote> 
 <p>开启haproxy的健康性检测 </p> 
</blockquote> 
<pre><code class="language-bash">[root@localhost ~]#vim /etc/haproxy/haproxy.cfg </code></pre> 
<p><img alt="" height="209" src="https://images2.imgbox.com/ce/49/QCbmbSFB_o.png" width="839"> </p> 
<pre><code class="language-bash">[root@localhost ~]#systemctl restart haproxy.service</code></pre> 
<p></p> 
<blockquote> 
 <p>可以通过抓包看到实际上是haproxy三次握手没有成功 </p> 
</blockquote> 
<pre><code class="language-bash">[root@localhost ~]#tcpdump -i ens33 -nn src host 192.168.241.22 and dst host 192.168.241.11
</code></pre> 
<p><img alt="" height="509" src="https://images2.imgbox.com/cb/ca/2CFy2p6g_o.png" width="1156"></p> 
<blockquote> 
 <p>明显看到是丢包，所以haproxy是通过三次握手进行健康性检测 </p> 
</blockquote> 
<pre><code class="language-bash">[root@localhost ~]#ss -natp |grep 80
LISTEN     0      128    192.168.241.11:80                       *:*                   users:(("haproxy",pid=11941,fd=13),("haproxy",pid=11940,fd=13),("haproxy",pid=11939,fd=13),("haproxy",pid=11938,fd=13))</code></pre> 
<blockquote> 
 <p>80端口是haproxy代为监听，如果有Web服务的请求将转到后端真实服务器 </p> 
</blockquote> 
<h4 id="%C2%A03.%E5%89%8D%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE"> 3.前后端配置</h4> 
<pre><code class="language-bash">[root@localhost ~]#vim /etc/haproxy/haproxy.cfg 
</code></pre> 
<p><img alt="" height="200" src="https://images2.imgbox.com/1d/1a/Q9TnzGAv_o.png" width="570"> </p> 
<pre><code class="language-bash">[root@localhost ~]#systemctl restart haproxy.service 
</code></pre> 
<pre><code class="language-bash">[root@node2 ~]#systemctl start httpd
</code></pre> 
<p><img alt="" height="416" src="https://images2.imgbox.com/87/bf/bFSNeAuZ_o.png" width="655"> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c08e31fa52979ae8ae191dd00a4044b9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数组与指针</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a645cbfd760ae68afe23b71bb1da174f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Copilot如何将word文稿一键转为PPT</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>