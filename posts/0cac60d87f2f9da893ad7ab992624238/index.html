<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>node&#43;koa&#43;jsonwebtoken鉴权jwt实战 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="node&#43;koa&#43;jsonwebtoken鉴权jwt实战" />
<meta property="og:description" content="涉及到的库: 如果对jwt不熟悉的话可以去了解一下前置知识:node实现jwt
主要是依靠jsonwebtoken的两个api:
生成token: sign()
校验token: verify()
这是我封装后的jwtUtils:
import jwt from &#39;jsonwebtoken&#39;; import { sha256 } from &#34;./cryptoUtils&#34;; import { Context } from &#34;koa&#34;; import logger from &#39;./logger&#39;; import emitter from &#39;./emitter&#39;; import { HttpStatus } from &#39;../middlewares/responseHandler&#39;; export interface JwtOptions { secret: string; expiresIn: number; excludePath: Array&lt;RegExp&gt;; } export enum TokenErrorType { TOKEN_EXPIRED_ERROR = &#39;TokenExpiredError&#39;, JSON_WEB_TOKEN_ERROR = &#39;JsonWebTokenError&#39; } class JwtUtils { public secret: string; public expiresIn: number; public excludePath: Array&lt;RegExp&gt;; private static instance: JwtUtils = null; public constructor(options: JwtOptions) { const { secret, expiresIn, excludePath } = options; logger." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/0cac60d87f2f9da893ad7ab992624238/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-12T20:25:39+08:00" />
<meta property="article:modified_time" content="2021-11-12T20:25:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">node&#43;koa&#43;jsonwebtoken鉴权jwt实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>涉及到的库: </p> 
<p><img alt="" height="38" src="https://images2.imgbox.com/03/39/fDoE5gES_o.png" width="344"></p> 
<p> <img alt="" height="36" src="https://images2.imgbox.com/77/77/Eo77xZVl_o.png" width="404"></p> 
<p>如果对jwt不熟悉的话可以去了解一下前置知识:<a class="link-info" href="https://juejin.cn/post/6873700061000237069" rel="nofollow" title="node实现jwt">node实现jwt</a></p> 
<p>主要是依靠jsonwebtoken的两个api:</p> 
<p>生成token: sign()</p> 
<p>校验token: verify()</p> 
<p>这是我封装后的jwtUtils:</p> 
<pre><code class="language-javascript">import jwt from 'jsonwebtoken';
import { sha256 } from "./cryptoUtils";
import { Context } from "koa";
import logger from './logger';
import emitter from './emitter';
import { HttpStatus } from '../middlewares/responseHandler';
export interface JwtOptions {
    secret: string;
    expiresIn: number;
    excludePath: Array&lt;RegExp&gt;;
}
export enum TokenErrorType {
    TOKEN_EXPIRED_ERROR = 'TokenExpiredError',
    JSON_WEB_TOKEN_ERROR = 'JsonWebTokenError'
}
class JwtUtils {
    public secret: string;
    public expiresIn: number;
    public excludePath: Array&lt;RegExp&gt;;
    private static instance: JwtUtils = null;
    public constructor(options: JwtOptions) {
        const { secret, expiresIn, excludePath } = options;
        logger.info(options)
        this.secret = sha256(secret);
        this.excludePath = excludePath
        this.expiresIn = expiresIn;
    }
    public async validateToken(ctx: Context, next): Promise&lt;void&gt; {
        const path = ctx.request.path;
        // 校验是否为请求白名单
        const isExcludePath = this.excludePath.some(function (e: RegExp) {
            return e.test(path);
        })
        if (isExcludePath) {
            return await next();
        }
        const token = (ctx.get('Authorization') || '').split(' ').pop();
        if (!token) {
            emitter.emit('errorResponse', ctx, HttpStatus.UNAUTHORIZED, '请求未携带token,请检查请求头');
            return;
        }
        try {
            const { id } = jwt.verify(token, this.secret) as { id: number } // 校验不通过会抛出错误
        } catch (error) {
            const { name } = error;
            switch (name) {
                case TokenErrorType.TOKEN_EXPIRED_ERROR: {
                    emitter.emit('errorResponse', ctx, HttpStatus.UNAUTHORIZED, 'token已过期');
                    break;
                }
                case TokenErrorType.JSON_WEB_TOKEN_ERROR: {
                    emitter.emit('errorResponse', ctx, HttpStatus.UNAUTHORIZED, '非法token');
                    break;
                }
                default:
                    break;
            }
            return;
        }
        await next()
    }
    public auth(ctx: Context, payload) {
        const token = jwt.sign(payload, this.secret, { expiresIn: this.expiresIn })
        return token;
    }
    public static getInstance() {
        if (!JwtUtils.instance) {
            JwtUtils.instance = new JwtUtils({
                excludePath: [
                    /\/user\/login/,
                    /\/swagger-html/,
                    /\/swagger-json/,
                    /\/uploads\/\w+/,
                    /\/captcha/,
                ],
                secret: 'Suk5201314lover',
                expiresIn: 60 * 60 * 24
            });
        }
        return JwtUtils.instance;
    }
}
const jwtUtils = Object.freeze(JwtUtils.getInstance());
export default jwtUtils;</code></pre> 
<p>首先生成token的api我们在用户授权也就是登录接口那里如果登录成功就要生成token和用户信息一起返回:</p> 
<p><img alt="" height="432" src="https://images2.imgbox.com/93/ab/4zbf4QBZ_o.png" width="534"></p> 
<p>核心API说明:</p> 
<p>sign方法传入的第一个参数就是用户载荷,也就是要加密的用户信息,可以传入用户id或者其他,第二个koa的上下文对象,第二个参数就是token加密的秘钥,这里博主用的sha256加密的秘钥,第三个options选项可以传入token过期时间,单位是秒</p> 
<p>verify方法传入的第一个参数就是token,token来自用户请求的请求头信息,Bearer [token],把token截取出来就行了,第二个参数就是加密时的秘钥,这里传入用于解密token,返回值是sign方法传入的用户信息载荷,方法执行校验token如果失败就会抛出错误,就是利用这点来判断token是否有效</p> 
<p>因为是通过koa中间件实现的,所以这里传入校验方法时是做为回调给koa去调用的,封装的this指向会错,所以手动指回来,这里是个细节划重点容易错</p> 
<p><img alt="" height="78" src="https://images2.imgbox.com/a7/04/HQzWpwNv_o.png" width="652"></p> 
<p>然后要注意的就是白名单要放行,不能拦截授权的接口,比如login,反正不用授权的都可以加入白名单</p> 
<p>基本原理就是这样了,up主因为时间关系(懒)代码只贴了核心部分,主要是实现原理讲解,有不懂的地方可以留言或者私信up</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7fbe321feb56512932746d70d39c82db/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">购物系统-网上书店 javaweb jsp&#43;Servelt&#43;JDBC连接数据库(源码分享)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4665c2ed840736272334c582e07223da/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">约瑟夫环问题求解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>