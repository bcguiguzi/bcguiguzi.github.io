<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>pyhon防反编译之用pyinstaller加pyarmor实现双重安全 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="pyhon防反编译之用pyinstaller加pyarmor实现双重安全" />
<meta property="og:description" content="pyhon防反编译之用pyinstaller加pyarmor实现双重安全 最近有个项目由于是做的桌面客户端需要分发，所有有了代码安全需求， 关于安全没有绝对的，只是提高下代码的安全，增加些反编译的难度
经过调研最终决定使用方案： pyinstaller打包&#43;pyarmore代码加密方案
PyArmor Pyarmor 是一个用于加密和保护 Python 脚本的工具。它能够在运行时刻保护 Python 脚本代码不被泄露，设置加密后脚本的使用期限，绑定加密脚本到硬盘、网卡等硬件设备。
以下是PyArmor的一些主要特点和功能：
无缝替换: 加密后的脚本依然是一个有效的 .py 文件，在大多数情况下可以直接替换原来的 .py 脚本，而不影响脚本的使用。均衡加密: 提供了丰富的加密选项来平衡安全性和性能，能够满足大多数应用对安全性和性能的要求。不可逆加密: 能够直接重命名源代码中的函数，类，方法，变量和参数。转换成为 C 代码: 能够把模块中部分函数转换成为 C 代码，然后使用高优化选项直接编译 C 代码为机器指令来保护 Python 函数限制加密脚本的使用范围: 可以绑定加密脚本到指定的设备或者设置加密脚本的有效期Themida 保护: 使用 Themida 保护加密脚本（仅 Windows 平台可用） PyArmor文档
PyInstaller PyInstaller是一个用于将Python应用程序打包成可执行文件的工具。它可以将Python代码和其依赖项打包成一个独立的可执行文件，使得你可以在没有安装Python解释器的环境中运行你的应用程序
PyInstaller文档
运行环境 python3.12pyinstaller 6.2.0pyarmor 8.4.4 代码加密 因为项目是有很多文件与包组成的，当时我按教程中命令去加密文件
pyarmor gen -O build/srv -r 代码目录 加密后去运行一直报这个错误，
from .pyarmor_runtime_000000 import __pyarmor__ ImportError: attempted relative import with no known parent package 因为这个路径from .pyarmor_runtime_000000中的引用包问题，这个.去掉就好了，但我试了很多方式，命令都没有去掉这个. 当时总想用一条命令搞定，呵呵" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/c71ffeacdcd0420e429e83b77b41eae9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-09T18:46:50+08:00" />
<meta property="article:modified_time" content="2023-12-09T18:46:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">pyhon防反编译之用pyinstaller加pyarmor实现双重安全</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="pyhonpyinstallerpyarmor_0"></a>pyhon防反编译之用pyinstaller加pyarmor实现双重安全</h2> 
<p>最近有个项目由于是做的桌面客户端需要分发，所有有了代码安全需求， 关于安全没有绝对的，只是提高下代码的安全，增加些反编译的难度</p> 
<p>经过调研最终决定使用方案： pyinstaller打包+pyarmore代码加密方案</p> 
<h3><a id="PyArmor_6"></a>PyArmor</h3> 
<p>Pyarmor 是一个用于加密和保护 Python 脚本的工具。它能够在运行时刻保护 Python 脚本代码不被泄露，设置加密后脚本的使用期限，绑定加密脚本到硬盘、网卡等硬件设备。<br> 以下是PyArmor的一些主要特点和功能：</p> 
<ul><li>无缝替换: 加密后的脚本依然是一个有效的 .py 文件，在大多数情况下可以直接替换原来的 .py 脚本，而不影响脚本的使用。</li><li>均衡加密: 提供了丰富的加密选项来平衡安全性和性能，能够满足大多数应用对安全性和性能的要求。</li><li>不可逆加密: 能够直接重命名源代码中的函数，类，方法，变量和参数。</li><li>转换成为 C 代码: 能够把模块中部分函数转换成为 C 代码，然后使用高优化选项直接编译 C 代码为机器指令来保护 Python 函数</li><li>限制加密脚本的使用范围: 可以绑定加密脚本到指定的设备或者设置加密脚本的有效期</li><li>Themida 保护: 使用 Themida 保护加密脚本（仅 Windows 平台可用）</li></ul> 
<p><a href="https://pyarmor.readthedocs.io/zh/stable/tutorial/getting-started.html" rel="nofollow">PyArmor文档</a></p> 
<h3><a id="PyInstaller_20"></a>PyInstaller</h3> 
<p>PyInstaller是一个用于将Python应用程序打包成可执行文件的工具。它可以将Python代码和其依赖项打包成一个独立的可执行文件，使得你可以在没有安装Python解释器的环境中运行你的应用程序</p> 
<p><a href="https://pyinstaller.org/en/stable/" rel="nofollow">PyInstaller文档</a></p> 
<h3><a id="_26"></a>运行环境</h3> 
<ol><li>python3.12</li><li>pyinstaller 6.2.0</li><li>pyarmor 8.4.4</li></ol> 
<h3><a id="_31"></a>代码加密</h3> 
<p>因为项目是有很多文件与包组成的，当时我按教程中命令去加密文件</p> 
<pre><code class="prism language-sh">pyarmor gen <span class="token parameter variable">-O</span> build/srv <span class="token parameter variable">-r</span> 代码目录

</code></pre> 
<p>加密后去运行一直报这个错误，</p> 
<pre><code class="prism language-sh">from .pyarmor_runtime_000000 <span class="token function">import</span> __pyarmor__
ImportError: attempted relative <span class="token function">import</span> with no known parent package
</code></pre> 
<p>因为这个路径from .pyarmor_runtime_000000中的引用包问题，这个.去掉就好了，但我试了很多方式，命令都没有去掉这个. 当时总想用一条命令搞定，呵呵</p> 
<p>我的解决方案是改成多条命令，最终加密脚本如下：</p> 
<pre><code class="prism language-sh">pyarmor gen <span class="token parameter variable">-O</span> build/srv <span class="token parameter variable">-r</span> ./srv/main.py
pyarmor gen <span class="token parameter variable">-O</span> build/srv <span class="token parameter variable">-r</span> ./srv/config.py
pyarmor gen <span class="token parameter variable">-O</span> build/srv <span class="token parameter variable">-r</span> ./srv/utils
pyarmor gen <span class="token parameter variable">-O</span> build/srv <span class="token parameter variable">-r</span> ./srv/模块1
pyarmor gen <span class="token parameter variable">-O</span> build/srv <span class="token parameter variable">-r</span> ./srv/模块2
<span class="token punctuation">..</span>.

</code></pre> 
<p>执行完这个加密码脚本后，项目终于可以正常启动了</p> 
<h3><a id="PyInstaller_60"></a>PyInstaller打包</h3> 
<p>这块PyArmor文档中有些教程，需要先<a href="https://pyarmor.readthedocs.io/zh/stable/topic/repack.html" rel="nofollow">看下</a></p> 
<p>它介绍了两种方法</p> 
<ol><li>pack方式</li><li>手动打包</li></ol> 
<p>pack方式流程略有复杂，还要做平台兼容性处理，果断放弃了，我选择了使用手动打包</p> 
<p>若是看到下面的错误，恭喜你现在路都走对了</p> 
<pre><code class="prism language-sh">ModuleNotFoundError: No module named <span class="token string">'xxx'</span>
</code></pre> 
<p>只是手动打包加密后脚本有个坑，就是系统包和自己包都不能自动导入了， 需要通过pyinstaller --hidden-import,来手动填加隐藏导入</p> 
<p>另外你是用pyinstall **.spec文件打包的话,直接更新这里</p> 
<pre><code class="prism language-sh">a <span class="token operator">=</span> Analysis<span class="token punctuation">(</span>
    <span class="token punctuation">..</span>.
    <span class="token assign-left variable">hiddenimports</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'xxx'</span><span class="token punctuation">]</span>,
    <span class="token punctuation">..</span>.
<span class="token punctuation">)</span>
</code></pre> 
<p>若是你引入的包较少， 可以手动写; 若是你引入包或模块较多，用下面的脚本可以生成要导入的包</p> 
<pre><code class="prism language-python">
<span class="token keyword">import</span> os
<span class="token keyword">import</span> re

<span class="token keyword">def</span> <span class="token function">search_files</span><span class="token punctuation">(</span>directory<span class="token punctuation">,</span> pattern<span class="token punctuation">)</span><span class="token punctuation">:</span>
    matched_files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> root<span class="token punctuation">,</span> dirs<span class="token punctuation">,</span> files <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".py"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span>
                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                    lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">for</span> line_num<span class="token punctuation">,</span> line <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>lines<span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> line<span class="token punctuation">)</span>
                        <span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span>
                            matched_files<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> line_num<span class="token punctuation">,</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> matched_files

<span class="token comment"># 指定目录和正则表达式模式</span>
directory <span class="token operator">=</span> <span class="token string">"."</span>
pattern <span class="token operator">=</span> <span class="token string">r"from\s+([\w\.]+)\s+import"</span>

<span class="token comment"># 调用函数搜索匹配的文件和行</span>
matched_files <span class="token operator">=</span> search_files<span class="token punctuation">(</span>directory<span class="token punctuation">,</span> pattern<span class="token punctuation">)</span>

imports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># 打印匹配的文件路径、行号和匹配的数据</span>
<span class="token keyword">for</span> file_path<span class="token punctuation">,</span> line_num<span class="token punctuation">,</span> data <span class="token keyword">in</span> matched_files<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"File: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>file_path<span class="token punctuation">}</span></span><span class="token string">, Line: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>line_num<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> data <span class="token keyword">not</span> <span class="token keyword">in</span> imports<span class="token punctuation">:</span>
        imports<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    
    
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--hidden-import"</span><span class="token punctuation">,</span> <span class="token string">" --hidden-import "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>imports<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<p>提示： 如果通过以上脚本获取导入包列表后，还有未导入的包，就手动加下就行了</p> 
<p>我最终的打包命令如下：</p> 
<pre><code class="prism language-sh"> pyinstaller <span class="token parameter variable">--paths</span><span class="token operator">=</span>./build/srv/ --hidden-import datetime --hidden-import wsgiref.simple_server --hidden-import loguru --hidden-import xxx --hidden-import xxx --hidden-import xxx --hidden-import xxx --hidden-import xxx  <span class="token parameter variable">--onefile</span> ./build/srv/main.py <span class="token parameter variable">--clean</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>app_srv <span class="token parameter variable">--distpath</span> ./resources
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2535ba5d1261dc9578246cc352e41ca1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于hadoop&#43;hive的全国天气大数据可视化平台</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8e43394b9f3c98d91f797a5171f5a226/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">1 函数列的一致收敛性</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>