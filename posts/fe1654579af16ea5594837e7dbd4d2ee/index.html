<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>docker 安装 rocketmq-mqtt - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="docker 安装 rocketmq-mqtt" />
<meta property="og:description" content="rocketmq版本4.9.3 以上rocketmq-mqtt版本：latest rocketmq安装 1.下载镜像
# rocketmq镜像 docker pull apache/rocketmq:5.1.4 # rocketmq dashboard 镜像 docker pull apacherocketmq/rocketmq-dashboard:latest 2.为RocketMQ容器创建一个网络，以便容器之间可以相互通信。
docker network create rocketmq-net 3.创建nameserver挂载目录
mkdir -p /app/rocketmq/namesrv/logs /app/rocketmq/namesrv/store 4.创建broker挂载目录
mkdir -p /app/rocketmq/broker/logs /app/rocketmq/broker/store 5.创建borke配置文件目录
mkdir -p /app/rocketmq/conf 6.编辑配置文件 vim /app/rocketmq/conf/broker.conf # 集群名称 brokerClusterName = DefaultCluster # 节点名称 brokerName = broker-a # broker id节点ID， 0 表示 master, 其他的正整数表示 slave，不能小于0 brokerId = 0 # Broker服务地址	内部使用填内网ip，如果是需要给外部使用填公网ip brokerIP1 = 192.168.19.91 # Broker角色 brokerRole = ASYNC_MASTER # 刷盘方式 flushDiskType = ASYNC_FLUSH # 在每天的什么时间删除已经超过文件保留时间的 commit log，默认值04 deleteWhen = 04 # 以小时计算的文件保留时间 默认值72小时 fileReservedTime = 72 # 是否允许Broker 自动创建Topic，建议线下开启，线上关闭 autoCreateTopicEnable=true # 是否允许Broker自动创建订阅组，建议线下开启，线上关闭 autoCreateSubscriptionGroup=true 7." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/fe1654579af16ea5594837e7dbd4d2ee/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-20T13:11:03+08:00" />
<meta property="article:modified_time" content="2023-12-20T13:11:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">docker 安装 rocketmq-mqtt</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <ul><li>rocketmq版本4.9.3 以上</li><li>rocketmq-mqtt版本：latest</li></ul> 
</blockquote> 
<h4>rocketmq安装 </h4> 
<p>1.下载镜像</p> 
<pre><code># rocketmq镜像
docker pull apache/rocketmq:5.1.4
# rocketmq dashboard 镜像
docker pull apacherocketmq/rocketmq-dashboard:latest
</code></pre> 
<p>2.为RocketMQ容器创建一个网络，以便容器之间可以相互通信。</p> 
<pre><code>docker network create rocketmq-net</code></pre> 
<p>3.创建nameserver挂载目录</p> 
<pre><code>mkdir -p /app/rocketmq/namesrv/logs /app/rocketmq/namesrv/store</code></pre> 
<p>4.创建broker挂载目录</p> 
<pre><code>mkdir -p /app/rocketmq/broker/logs /app/rocketmq/broker/store</code></pre> 
<p>5.创建borke配置文件目录</p> 
<pre><code>mkdir -p /app/rocketmq/conf</code></pre> 
<p> 6.编辑配置文件 </p> 
<pre><code>vim /app/rocketmq/conf/broker.conf</code></pre> 
<pre><code># 集群名称
brokerClusterName = DefaultCluster
# 节点名称
brokerName = broker-a
# broker id节点ID， 0 表示 master, 其他的正整数表示 slave，不能小于0 
brokerId = 0
# Broker服务地址	内部使用填内网ip，如果是需要给外部使用填公网ip
brokerIP1 = 192.168.19.91
# Broker角色
brokerRole = ASYNC_MASTER
# 刷盘方式
flushDiskType = ASYNC_FLUSH
# 在每天的什么时间删除已经超过文件保留时间的 commit log，默认值04
deleteWhen = 04
# 以小时计算的文件保留时间 默认值72小时
fileReservedTime = 72
# 是否允许Broker 自动创建Topic，建议线下开启，线上关闭
autoCreateTopicEnable=true
# 是否允许Broker自动创建订阅组，建议线下开启，线上关闭
autoCreateSubscriptionGroup=true</code></pre> 
<p>7.运行nameserver 容器</p> 
<pre><code>docker run -d  --privileged=true \
--restart=always --name rocketmq-namesrv --network rocketmq-net  -p 9876:9876 \
-v /app/rocketmq/namesrv/logs:/root/logs \
-v /app/rocketmq/namesrv/store:/root/store \
-e "MAX_POSSIBLE_HEAP=100000000" apache/rocketmq:5.1.4 sh mqnamesrv</code></pre> 
<blockquote> 
 <p>注：sh mqnamesrv: 这是在容器中要运行的命令。它启动了RocketMQ的NameServer组件</p> 
</blockquote> 
<p>8.创建borker 容器</p> 
<pre><code> docker run -d --restart=always \
--privileged=true \
--network rocketmq-net \
--name rocketmq-broker \
-p 10911:10911 -p 10909:10909 \
-v /app/rocketmq/broker/logs:/root/logs \
-v /app/rocketmq/broker/store:/root/store \
-v /app/rocketmq/conf/broker.conf:/home/rocketmq/rocketmq-5.1.4/conf/broker.conf \
 apache/rocketmq:5.1.4 sh mqbroker  \
-c /home/rocketmq/rocketmq-5.1.4/conf/broker.conf \
-n rocketmq-namesrv:9876</code></pre> 
<blockquote> 
 <ul><li><code>-d</code>: 表示以守护进程方式运行容器。</li><li><code>--restart=always</code>: 设置容器在异常退出时自动重启。</li><li><code>--network rocketmq-net</code>: 将容器连接到名为 <code>rocketmq-net</code> 的网络。</li><li><code>--name rocketmq_broker</code>: 指定容器的名称为 <code>rocketmq_broker</code>。</li><li><code>-p 10911:10911 -p 10909:10909</code>: 将容器内部的 10911 和 10909 端口映射到宿主机的相同端口，用于与其他组件通信。</li><li><code>apache/rocketmq:5.1.4 sh mqbroker</code>: 使用 <code>apache/rocketmq:5.1.4</code> 镜像中的命令行工具 <code>sh</code> 来执行 <code>mqbroker</code> 命令。</li><li><code>-c /opt/rocketmqinc/rocketmq/conf</code>: 指定配置文件的路径为 <code>/opt/rocketmqinc/rocketmq/conf</code>。</li><li><code>-n rocketmq-namesrv:9876</code>: 指定 NameServer 的地址和端口为 <code>rocketmq-namesrv:9876</code>。</li></ul> 
 <p></p> 
</blockquote> 
<p> 9.运行dashboard 容器实例</p> 
<pre><code>docker run -d \
--privileged=true \
--restart=always \
--name rocketmq-dashboard \
--network rocketmq-net \
-e "JAVA_OPTS=-Drocketmq.namesrv.addr=rocketmq-namesrv:9876" \
-p 8080:8080 \
-t apacherocketmq/rocketmq-dashboard:latest</code></pre> 
<p>10.检查容器是否启动</p> 
<pre><code>docker ps --filter "name=rock*" --format "{<!-- -->{.ID}}\t{<!-- -->{.Names}}\t{<!-- -->{.Status}}"</code></pre> 
<p>11.访问 dashboard  ip:8080</p> 
<p><img alt="" height="606" src="https://images2.imgbox.com/e3/04/RzIySzaL_o.png" width="1200"></p> 
<p></p> 
<hr> 
<h4>部署说明</h4> 
<p>由于RocketMQ-MQTT项目依赖RocketMQ底层的多队列分发，RocketMQ从4.9.3版本开始支持这一特性，因此您需要确认RocketMQ的版本升级到4.9.3或更高版本，并且确保以下配置项已开启：</p> 
<pre><code>enableLmq = true 
enableMultiDispatch = true</code></pre> 
<p>修改配置后需重启broker。 </p> 
<p>官网下载 rocketmq-mqtt 进行源码构建 </p> 
<pre><code># 1. git 下载
git clone https://github.com/apache/rocketmq-mqtt

# 2.编译
cd rocketmq-mqtt
mvn -Prelease-all -DskipTests clean install -U </code></pre> 
<p><a class="link-info has-card" href="https://pan.baidu.com/s/1UDfIu5e13ewnqaxOc0ubUA?pwd=zlyh" rel="nofollow" title="rocketmq-mqtt 提取码 zlyh"><span class="link-card-box"><span class="link-title">rocketmq-mqtt 提取码 zlyh</span><span class="link-link"><img class="link-link-icon" src="https://images2.imgbox.com/c1/51/N7tdo8sM_o.png" alt="icon-default.png?t=N7T8">https://pan.baidu.com/s/1UDfIu5e13ewnqaxOc0ubUA?pwd=zlyh</span></span></a></p> 
<h4><strong>配置rocketmq-mqtt</strong></h4> 
<p>1.编译后的文件复制到任意目录下并解压</p> 
<pre><code># 创建rocketmq-mqtt 工作目录 
mkdir -p /app/rocketmq/rocketmq-mqtt
# 解压
unzip xxx.zip 
# 查看配置文件
cd xxx/conf
</code></pre> 
<p><img alt="" height="138" src="https://images2.imgbox.com/e0/5c/vG7rufNo_o.png" width="907"></p> 
<p>2.修改rocketmq-mqtt中 connect.conf, meta.conf , service.conf</p> 
<pre><code># 1.修改 connect.conf
mqttPort=1884 # 默认1883
enablePrometheus=true

# 2.修改meta.conf
# 当前节点所运行的服务器ip
selfAddress=192.168.19.91:25000
#所有成员节点地址
membersAddress=192.168.19.91:25000

# 修改service.conf
# 用户名
username=test
# 密钥
secretKey=test
#NameServer 服务地址
NAMESRV_ADDR=192.168.19.91:9876
# 通知事件重试主题
eventNotifyRetryTopic=eventNotifyRetryTopic
# 通知事件重试主题
clientRetryTopic=clientRetryTopic
#元地址  meta所有节点ip：port。与meta.config中的membersAddress相同
metaAddr=192.168.19.91:25000

</code></pre> 
<p> 3.进入rocketmq-broker 伪终端配置主题等信息</p> 
<pre><code># 进入broker伪终端
docker exec -it rocketmq-broker /bin/bash
</code></pre> 
<p>  4 创建主题：包括 <strong>eventNotifyRetryTopic</strong> 和 <strong>clientRetryTopic</strong>。 </p> 
<blockquote> 
 <p>语法： sh mqadmin updatetopic -c {cluster} -t {topic} -n {namesrv}</p> 
</blockquote> 
<pre><code># 示例
sh mqadmin updatetopic -c DefaultCluster -t eventNotifyRetryTopic -n 192.168.19.91:9876
sh mqadmin updatetopic -c DefaultCluster -t clientRetryTopic -n 192.168.19.91:9876
sh mqadmin updatetopic -c DefaultCluster -t test-topic -n 192.168.19.91:9876</code></pre> 
<p>5 初始化元</p> 
<ul><li>配置网关节点列表</li></ul> 
<blockquote> 
 <p>sh mqadmin updateKvConfig -s LMQ -k LMQ_CONNECT_NODES -v {ip1,ip2} -n {namesrv}</p> 
</blockquote> 
<pre><code>sh mqadmin updateKvConfig -s LMQ -k LMQ_CONNECT_NODES -v 192.168.19.91 -n 192.168.19.91:9876</code></pre> 
<ul><li>配置一级主题列表</li></ul> 
<blockquote> 
 <p>sh mqadmin updateKvConfig -s LMQ -k ALL_FIRST_TOPICS -v {topic1,topic2} -n {namesrv}</p> 
</blockquote> 
<pre><code>sh mqadmin updateKvConfig -s LMQ -k ALL_FIRST_TOPICS -v eventNotifyRetryTopic,clientRetryTopic,test-topic -n 192.168.19.91:9876</code></pre> 
<ul><li>在每个一级主题下配置通配符列表</li></ul> 
<blockquote> 
 <p>sh mqadmin updateKvConfig  -s LMQ -k {topic} -v {topic/+}  -n {namesrv}</p> 
</blockquote> 
<pre><code>sh mqadmin updateKvConfig  -s LMQ -k eventNotifyRetryTopic -v eventNotifyRetryTopic/+ -n 192.168.19.91:9876

sh mqadmin updateKvConfig  -s LMQ -k clientRetryTopic -v clientRetryTopic/+ -n 192.168.19.91:9876

sh mqadmin updateKvConfig  -s LMQ -k test-topic -v test-topic/+ -n 192.168.19.91:9876</code></pre> 
<p>6.启动进程</p> 
<pre><code>cd bin
sh meta.sh start
sh mqtt.sh start
</code></pre> 
<p>检查是否启动成功：</p> 
<pre><code> netstat -tunlp | grep 1884
 netstat -tunlp | grep 25000</code></pre> 
<p><img alt="" height="97" src="https://images2.imgbox.com/3f/51/pqVpktci_o.png" width="999"></p> 
<p>日志目录：</p> 
<pre><code>cd $HOME/logs </code></pre> 
<p><img alt="" height="117" src="https://images2.imgbox.com/92/fd/d9xqc4D8_o.png" width="690"></p> 
<p>7.客户端测试及结果</p> 
<p><img alt="" height="342" src="https://images2.imgbox.com/f1/70/T30dzJVd_o.png" width="1093"></p> 
<p><a class="has-card" href="https://rocketmq.apache.org/zh/docs/quickStart/01quickstart" rel="nofollow" title="rocketmq官方文档"><span class="link-card-box"><span class="link-title">rocketmq官方文档</span><span class="link-link"><img class="link-link-icon" src="https://images2.imgbox.com/a8/56/h9jDtLZb_o.png" alt="icon-default.png?t=N7T8">https://rocketmq.apache.org/zh/docs/quickStart/01quickstart</span></span></a></p> 
<hr> 
<h4>客户端工具连接 rocketmq-mqtt</h4> 
<p><a class="link-info has-card" href="https://pan.baidu.com/s/1WEQVRa4J55F5ZX_Jh7C2Pw?pwd=zlyh" rel="nofollow" title="Mqttx安装包"><span class="link-card-box"><span class="link-title">Mqttx安装包</span><span class="link-link"><img class="link-link-icon" src="https://images2.imgbox.com/be/c0/iZ0YQNNA_o.png" alt="icon-default.png?t=N7T8">https://pan.baidu.com/s/1WEQVRa4J55F5ZX_Jh7C2Pw?pwd=zlyh</span></span></a></p> 
<p><img alt="" height="988" src="https://images2.imgbox.com/c0/2d/y8cqPioa_o.png" width="1200"></p> 
<p><img alt="" height="565" src="https://images2.imgbox.com/76/13/6elTwaZ7_o.png" width="1200"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/69abe31ae0cab0200b4dd453377509d5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">通达信指标源码，一键自动改写成选股器</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b1db015b68fa4d10270f28803bfddf48/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">简述相机镜头变焦与对焦、成像的原理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>