<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C筑基——深入理解内存对齐 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C筑基——深入理解内存对齐" />
<meta property="og:description" content="目录 1 前言2 正文2.1 为什么要有内存对齐？2.2 内存对齐原则2.2.1 基本数据类型是自然对齐的2.2.2 包含基本数据类型成员的结构体套用结构体内存对齐原则来分析使用 gdb 查看这两个结构体的成员内存位置结构体类型变量是自然对齐的吗？ 2.2.3 数组类型 2.3 修改编译器的默认对齐方式（系数）编译器的默认对齐方式（系数）为什么要修改编译器的默认对齐系数？如何修改编译器的默认对齐系数？为什么修改了对齐系数会影响结构体的长度？发送方和接收方对同一个结构体使用不同的对齐系数例子 3 最后参考 1 前言 11月份的时候，同事维护的项目出现了内存对齐问题：传递数据的一方使用了 #pragma pack(4) 修改了结构体的对齐方式，而接收方数据的一方并没有对这个结构体使用同样的对齐方式，造成了获取数据时失败的问题。
本文主要说明：
为什么要有内存对齐？内存对齐原则如何修改默认对齐方式？ 2 正文 2.1 为什么要有内存对齐？ 单字或者双字操作数的存储跨越了 4 字节边界，或者一个四字节操作数的存储跨越了 8 字节边界，被认为是未对齐的。为了访问未对齐的内存，处理器需要作两次内存；而如果内存是对齐的，处理器仅需要一次内存访问。
处理器在访问内存时，每次读取一定的长度（这个长度就是处理器的默认对齐系数，或者是默认对齐系数的整数倍）。这个长度就是指上段中描述的 4 字节边界或者 8 字节边界。
需要说明的是，开发者并不需要直接负责如何进行内存对齐，编译器默认会对标准数据类型，结构中的成员数据进行内存对齐。开发者需要学习编译器进行内存对齐的原则，以便解决实际开发中的问题。
2.2 内存对齐原则 2.2.1 基本数据类型是自然对齐的 如果一个变量的内存地址正好是这个变量的长度的整数倍，那么这个变量就是自然对齐的。
这里通过代码来说明 char，short，int，double 类型变量是自然对齐的：
#include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #define mark(num) (num) == 0 ? &#34;√&#34; : &#34;×&#34; int main(void) { printf(&#34;sizeof(char): %zd, sizeof(short): %zd, sizeof(int): %zd, sizeof(double): %zd\n&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/8210e8b2aa42b8aa490972d58bf95fad/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-28T14:11:13+08:00" />
<meta property="article:modified_time" content="2023-02-28T14:11:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C筑基——深入理解内存对齐</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#1__1" rel="nofollow">1 前言</a></li><li><a href="#2__9" rel="nofollow">2 正文</a></li><li><ul><li><a href="#21__10" rel="nofollow">2.1 为什么要有内存对齐？</a></li><li><a href="#22__17" rel="nofollow">2.2 内存对齐原则</a></li><li><ul><li><a href="#221__18" rel="nofollow">2.2.1 基本数据类型是自然对齐的</a></li><li><a href="#222__70" rel="nofollow">2.2.2 包含基本数据类型成员的结构体</a></li><li><ul><li><a href="#_107" rel="nofollow">套用结构体内存对齐原则来分析</a></li><li><a href="#_gdb__145" rel="nofollow">使用 gdb 查看这两个结构体的成员内存位置</a></li><li><a href="#_221" rel="nofollow">结构体类型变量是自然对齐的吗？</a></li></ul> 
    </li><li><a href="#223__251" rel="nofollow">2.2.3 数组类型</a></li></ul> 
   </li><li><a href="#23__258" rel="nofollow">2.3 修改编译器的默认对齐方式（系数）</a></li><li><ul><li><a href="#_259" rel="nofollow">编译器的默认对齐方式（系数）</a></li><li><a href="#_274" rel="nofollow">为什么要修改编译器的默认对齐系数？</a></li><li><a href="#_277" rel="nofollow">如何修改编译器的默认对齐系数？</a></li><li><a href="#_328" rel="nofollow">为什么修改了对齐系数会影响结构体的长度？</a></li><li><a href="#_348" rel="nofollow">发送方和接收方对同一个结构体使用不同的对齐系数例子</a></li></ul> 
  </li></ul> 
  </li><li><a href="#3__447" rel="nofollow">3 最后</a></li><li><a href="#_450" rel="nofollow">参考</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__1"></a>1 前言</h2> 
<p>11月份的时候，同事维护的项目出现了内存对齐问题：传递数据的一方使用了 <code>#pragma pack(4)</code> 修改了结构体的对齐方式，而接收方数据的一方并没有对这个结构体使用同样的对齐方式，造成了获取数据时失败的问题。</p> 
<p>本文主要说明：</p> 
<ul><li>为什么要有内存对齐？</li><li>内存对齐原则</li><li>如何修改默认对齐方式？</li></ul> 
<h2><a id="2__9"></a>2 正文</h2> 
<h3><a id="21__10"></a>2.1 为什么要有内存对齐？</h3> 
<p>单字或者双字操作数的存储跨越了 4 字节边界，或者一个四字节操作数的存储跨越了 8 字节边界，被认为是未对齐的。为了访问未对齐的内存，处理器需要作两次内存；而如果内存是对齐的，处理器仅需要一次内存访问。</p> 
<p>处理器在访问内存时，每次读取一定的长度（这个长度就是处理器的默认对齐系数，或者是默认对齐系数的整数倍）。这个长度就是指上段中描述的 4 字节边界或者 8 字节边界。</p> 
<p>需要说明的是，开发者并不需要直接负责如何进行内存对齐，编译器默认会对标准数据类型，结构中的成员数据进行内存对齐。开发者需要学习编译器进行内存对齐的原则，以便解决实际开发中的问题。</p> 
<h3><a id="22__17"></a>2.2 内存对齐原则</h3> 
<h4><a id="221__18"></a>2.2.1 基本数据类型是自然对齐的</h4> 
<p>如果一个变量的内存地址正好是这个变量的长度的整数倍，那么这个变量就是自然对齐的。</p> 
<p>这里通过代码来说明 <code>char</code>，<code>short</code>，<code>int</code>，<code>double</code> 类型变量是自然对齐的：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">mark</span><span class="token expression"><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> </span><span class="token string">"√"</span> <span class="token expression"><span class="token operator">:</span> </span><span class="token string">"×"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sizeof(char): %zd, sizeof(short): %zd, sizeof(int): %zd, sizeof(double): %zd\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> a <span class="token operator">=</span> <span class="token char">'a'</span><span class="token punctuation">;</span>
    <span class="token keyword">short</span> b <span class="token operator">=</span> <span class="token number">10086</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">1008611</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> d <span class="token operator">=</span> <span class="token number">3.1415926</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> aAddr <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> bAddr <span class="token operator">=</span> <span class="token operator">&amp;</span>b<span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> cAddr <span class="token operator">=</span> <span class="token operator">&amp;</span>c<span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> dAddr <span class="token operator">=</span> <span class="token operator">&amp;</span>d<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"类型\t\t被 sizeof(char) 整除\t被 sizeof(short) 整除\t被 sizeof(int) 整除\t被 sizeof(double) 整除\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"char 地址\t\t%s\t\t\t%s\t\t\t%s\t\t\t%s\n"</span><span class="token punctuation">,</span>
    <span class="token function">mark</span><span class="token punctuation">(</span>aAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark</span><span class="token punctuation">(</span>aAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark</span><span class="token punctuation">(</span>aAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark</span><span class="token punctuation">(</span>aAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"short 地址\t\t%s\t\t\t%s\t\t\t%s\t\t\t%s\n"</span><span class="token punctuation">,</span>
    <span class="token function">mark</span><span class="token punctuation">(</span>bAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark</span><span class="token punctuation">(</span>bAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark</span><span class="token punctuation">(</span>bAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark</span><span class="token punctuation">(</span>bAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"int 地址\t\t%s\t\t\t%s\t\t\t%s\t\t\t%s\n"</span><span class="token punctuation">,</span>
    <span class="token function">mark</span><span class="token punctuation">(</span>cAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark</span><span class="token punctuation">(</span>cAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark</span><span class="token punctuation">(</span>cAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark</span><span class="token punctuation">(</span>cAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"double 地址\t\t%s\t\t\t%s\t\t\t%s\t\t\t%s\n\n"</span><span class="token punctuation">,</span>
    <span class="token function">mark</span><span class="token punctuation">(</span>dAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark</span><span class="token punctuation">(</span>dAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark</span><span class="token punctuation">(</span>dAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark</span><span class="token punctuation">(</span>dAddr <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先使用 sizeof 运算符获取<code>char</code>，<code>short</code>，<code>int</code>，<code>double</code> 类型的长度，并打印出来；然后声明了<code>char</code>，<code>short</code>，<code>int</code>，<code>double</code> 类型的变量，并打印各自地址被类型长度整除的情况。</p> 
<p>打印结果：</p> 
<pre><code class="prism language-text">sizeof(char): 1, sizeof(short): 2, sizeof(int): 4, sizeof(double): 8
类型            被 sizeof(char) 整除    被 sizeof(short) 整除   被 sizeof(int) 整除     被 sizeof(double) 整除
char 地址               √                       ×                       ×                       ×
short 地址              √                       √                       ×                       ×
int 地址                √                       √                       √                       ×
double 地址             √                       √                       √                       √
</code></pre> 
<p>从打印结果可以看到，<br> <code>char</code> 类型变量的地址可以被 <code>sizeof(char)</code>，即 1 所整除；<br> <code>short</code> 类型变量的地址可以被 <code>sizeof(short)</code>，即 2 所整除；<br> <code>int</code> 类型变量的地址可以被 <code>sizeof(int)</code>，即 4 所整除；<br> <code>double</code> 类型变量的地址可以被 <code>sizeof(char)</code>，即 8 所整除。</p> 
<p>对于这些自然对齐的变量，一次读取 8 个字节长度的处理器，只需要一次内存访问就可以取出变量的值。</p> 
<h4><a id="222__70"></a>2.2.2 包含基本数据类型成员的结构体</h4> 
<p>对于包含基本数据类型成员的结构体，内存对齐原则是：</p> 
<ul><li>成员只能存储在这个成员的长度的整数倍的地址上；</li><li>结构体的长度是它的最大成员长度的整数倍。</li></ul> 
<p>为了更好地理解，我们通过两个结构体来进一步说明：</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>  
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> a<span class="token punctuation">;</span>
    <span class="token keyword">short</span> b<span class="token punctuation">;</span>
    <span class="token keyword">int</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span> TestStruct1<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>  
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> a<span class="token punctuation">;</span>
    <span class="token keyword">int</span> c<span class="token punctuation">;</span>
    <span class="token keyword">short</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span> TestStruct2<span class="token punctuation">;</span>
</code></pre> 
<p>问：<code>TestStruct1</code> 和 <code>TestStruct2</code> 的长度是否一样？分别是多少？为什么？</p> 
<p>我们先来看一下这两个结构体，区别只是 <code>short b;</code> 和 <code>int c;</code> 这两行语句的次序不一样而已。按照直观的理解，<code>TestStruct1</code> 和 <code>TestStruct2</code> 的长度应该是一样的。</p> 
<p>我们打印一下二者的长度：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sizeof(TestStruct1) = %zd, sizeof(TestStruct2) = %zd\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TestStruct1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TestStruct2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>打印结果：</p> 
<pre><code class="prism language-text">sizeof(TestStruct1) = 8, sizeof(TestStruct2) = 12
</code></pre> 
<h5><a id="_107"></a>套用结构体内存对齐原则来分析</h5> 
<p>对于结构体 <code>TestStruct1</code></p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>  
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> a<span class="token punctuation">;</span> <span class="token comment">// 成员长度为 1</span>
    <span class="token keyword">short</span> b<span class="token punctuation">;</span> <span class="token comment">// 成员长度为 2</span>
    <span class="token keyword">int</span> c<span class="token punctuation">;</span> <span class="token comment">// 成员长度为 4</span>
<span class="token punctuation">}</span> TestStruct1<span class="token punctuation">;</span>
</code></pre> 
<p>结构体的最大成员长度是 4 个字节，所以结构体的长度一定是 4 的整数倍。<br> <code>char a</code> 占据 1 个字节，需要存储在可以被 1 整除的地址上，所以它相对于结构体起始地址的偏移量为 0；<br> <code>short b</code> 占据 2 个字节，需要存储在可以被 2 整除的地址上，所以它相对于结构体起始地址的偏移量为 2；<br> <code>int c</code> 占据 4 个字节，需要存储在可以被 4 整除的地址上，所以它相对于结构体起始地址的偏移量为 4。<br> 使用表格表示如下：<br> <img src="https://images2.imgbox.com/45/d3/mLO9xQsl_o.png" alt="在这里插入图片描述"><br> 所以，<code>TestStruct1</code> 的长度是 8 个字节。</p> 
<p><strong>对于结构体 <code>TestStruct2</code></strong></p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>  
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> a<span class="token punctuation">;</span>
    <span class="token keyword">int</span> c<span class="token punctuation">;</span>
    <span class="token keyword">short</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span> TestStruct2<span class="token punctuation">;</span>
</code></pre> 
<p>结构体的最大成员长度是 4 个字节，所以结构体的长度一定是 4 的整数倍。<br> <code>char a</code> 占据 1 个字节，需要存储在可以被 1 整除的地址上，所以它相对于结构体起始地址的偏移量为 0；<br> <code>int c</code> 占据 4 个字节，需要存储在可以被 4 整除的地址上，所以它相对于结构体起始地址的偏移量为 4；<br> <code>short b</code> 占据 2 个字节，需要存储在可以被 2 整除的地址上，所以它相对于结构体起始地址的偏移量为 8。<br> 使用表格表示如下：<br> <img src="https://images2.imgbox.com/f5/ed/xtNdCyOU_o.png" alt="在这里插入图片描述"><br> 所以，<code>TestStruct2</code> 的长度是 12 个字节。</p> 
<p>分析结果与打印结果是一致的。</p> 
<h5><a id="_gdb__145"></a>使用 gdb 查看这两个结构体的成员内存位置</h5> 
<p>为了更深入地理解这两个结构体的成员内存位置，我们再使用 来分析一下：</p> 
<p>先对 <code>memory_alignment.c</code> 程序进行修改如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    TestStruct1 ts1<span class="token punctuation">;</span>
    ts1<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">0x11</span><span class="token punctuation">;</span>
    ts1<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">0x2222</span><span class="token punctuation">;</span>
    ts1<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">0x33333333</span><span class="token punctuation">;</span>
    TestStruct2 ts2<span class="token punctuation">;</span>
    ts2<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">0x11</span><span class="token punctuation">;</span>
    ts2<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">0x33333333</span><span class="token punctuation">;</span>
    ts2<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">0x2222</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>分别对各自的成员，使用相应的 16 进制整数进行赋值。这是为了更方便地在内存中查看成员占据的字节数。</p> 
<p>使用 gcc 以调试模式编译程序：</p> 
<pre><code class="prism language-shell">$ gcc <span class="token parameter variable">-g</span> memory_alignment.c
</code></pre> 
<p>生成的可执行程序是 a.out。</p> 
<p>使用 gdb 调试 a.out，在 <code>return 0;</code> 这行打断点，并 <code>run</code>：</p> 
<pre><code class="prism language-shell">$ gdb a.out
GNU gdb <span class="token punctuation">(</span>Ubuntu <span class="token number">8.1</span>.1-0ubuntu1<span class="token punctuation">)</span> <span class="token number">8.1</span>.1
Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2018</span> Free Software Foundation, Inc.
License GPLv3+: GNU GPL version <span class="token number">3</span> or later <span class="token operator">&lt;</span>http://gnu.org/licenses/gpl.html<span class="token operator">&gt;</span>
This is <span class="token function">free</span> software: you are <span class="token function">free</span> to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type <span class="token string">"show copying"</span>
and <span class="token string">"show warranty"</span> <span class="token keyword">for</span> details.
This GDB was configured as <span class="token string">"x86_64-linux-gnu"</span><span class="token builtin class-name">.</span>
Type <span class="token string">"show configuration"</span> <span class="token keyword">for</span> configuration details.
For bug reporting instructions, please see:
---Type <span class="token operator">&lt;</span>return<span class="token operator">&gt;</span> to continue, or q <span class="token operator">&lt;</span>return<span class="token operator">&gt;</span> to quit---
<span class="token operator">&lt;</span>http://www.gnu.org/software/gdb/bugs/<span class="token operator">&gt;</span>.
Find the GDB manual and other documentation resources online at:
<span class="token operator">&lt;</span>http://www.gnu.org/software/gdb/documentation/<span class="token operator">&gt;</span>.
For help, <span class="token builtin class-name">type</span> <span class="token string">"help"</span><span class="token builtin class-name">.</span>
Type <span class="token string">"apropos word"</span> to search <span class="token keyword">for</span> commands related to <span class="token string">"word"</span><span class="token punctuation">..</span>.
Reading symbols from a.out<span class="token punctuation">..</span>.done.
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> <span class="token builtin class-name">break</span> <span class="token number">29</span>
Breakpoint <span class="token number">1</span> at 0x68f: <span class="token function">file</span> memory_alignment.c, line <span class="token number">29</span>.
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> run
Starting program: /home/wangzhichao/c-examples/_11_memory_management/a.out 
sizeof<span class="token punctuation">(</span>TestStruct1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">8</span>, sizeof<span class="token punctuation">(</span>TestStruct2<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">12</span>

Breakpoint <span class="token number">1</span>, main <span class="token punctuation">(</span><span class="token punctuation">)</span> at memory_alignment.c:29
<span class="token number">29</span>          <span class="token builtin class-name">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> 
</code></pre> 
<p>显示 <code>ts1</code> 和 <code>ts2</code> 的地址，并用 <code>x</code> 命令查看对应地址的内存（关于 <code>x</code> 命令的使用，可以查看<a href="https://www.cnblogs.com/rsapaper/p/11853349.html" rel="nofollow">GDB查看内存命令（x命令） 用gdb查看指定地址的内存内容</a>）：</p> 
<pre><code class="prism language-c"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> display <span class="token operator">&amp;</span>ts1
<span class="token number">1</span><span class="token operator">:</span> <span class="token operator">&amp;</span>ts1 <span class="token operator">=</span> <span class="token punctuation">(</span>TestStruct1 <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x7fffffffde9c</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> x<span class="token operator">/</span><span class="token number">8</span>xb <span class="token number">0x7fffffffde9c</span>
<span class="token number">0x7fffffffde9c</span><span class="token operator">:</span> <span class="token number">0x11</span>    <span class="token number">0x55</span>    <span class="token number">0x22</span>    <span class="token number">0x22</span>    <span class="token number">0x33</span>    <span class="token number">0x33</span>    <span class="token number">0x33</span>    <span class="token number">0x33</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> display <span class="token operator">&amp;</span>ts2
<span class="token number">2</span><span class="token operator">:</span> <span class="token operator">&amp;</span>ts2 <span class="token operator">=</span> <span class="token punctuation">(</span>TestStruct2 <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x7fffffffdea4</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> x<span class="token operator">/</span><span class="token number">12</span>xb <span class="token number">0x7fffffffdea4</span>
<span class="token number">0x7fffffffdea4</span><span class="token operator">:</span> <span class="token number">0x11</span>    <span class="token number">0x7f</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>    <span class="token number">0x33</span>    <span class="token number">0x33</span>    <span class="token number">0x33</span>    <span class="token number">0x33</span>
<span class="token number">0x7fffffffdeac</span><span class="token operator">:</span> <span class="token number">0x22</span>    <span class="token number">0x22</span>    <span class="token number">0x00</span>    <span class="token number">0x00</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> 
</code></pre> 
<p><code>x/8xb 0x7fffffffdea0</code> 表示以 16 进制格式输出从 <code>0x7fffffffdea0</code> 向后的 8 个字节上的内容；<br> <code>x/12xb 0x7fffffffdea8</code> 表示以 16 进制格式输出从 <code>0x7fffffffdea8</code> 向后的 12 个字节上的内容。</p> 
<p>这些与表格表示出的内存位置是一致的：<br> 对于 ts1：<br> <img src="https://images2.imgbox.com/b4/e9/49sEMzCK_o.png" alt="在这里插入图片描述"><br> 对于 ts2：<br> <img src="https://images2.imgbox.com/b9/e9/Xg152gL2_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_221"></a>结构体类型变量是自然对齐的吗？</h5> 
<p>在 2.2.1 小节中说过，如果一个变量的内存地址正好是这个变量的长度的整数倍，那么这个变量就是自然对齐的。</p> 
<p>那么，结构体类型变量的内存地址是不是这个结构体类型长度的整数倍呢？</p> 
<p>我们直接通过程序来验证吧：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    TestStruct1 ts1<span class="token punctuation">;</span>
    TestStruct2 ts2<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TestStruct1 ts1 的地址是否可以被其长度整数：%lld\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ts1 <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TestStruct1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TestStruct1 ts2 的地址是否可以被其长度整数：%lld\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ts2 <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TestStruct2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>多次运行程序，打印如下：</p> 
<pre><code class="prism language-shell">$ ./a.out 
TestStruct1 ts1 的地址是否可以被其长度整数：4
TestStruct1 ts2 的地址是否可以被其长度整数：8
$ ./a.out 
TestStruct1 ts1 的地址是否可以被其长度整数：4
TestStruct1 ts2 的地址是否可以被其长度整数：0
$ ./a.out 
TestStruct1 ts1 的地址是否可以被其长度整数：4
TestStruct1 ts2 的地址是否可以被其长度整数：4
</code></pre> 
<p>所以，可以知道：结构体变量不是自然对齐的。</p> 
<h4><a id="223__251"></a>2.2.3 数组类型</h4> 
<p>数组类型是依据其元素类型对齐：如果第一个元素可以对齐，那么后面的元素自然也可以对齐；如果第一个元素不可以对齐，那么后面的元素无法保证对齐。</p> 
<p>如果数组元素是基本类型，那么这个数组后面的元素是可以对齐的；<br> 如果数组元素是构造类型，那么这个数组的元素就不保证对齐了。</p> 
<h3><a id="23__258"></a>2.3 修改编译器的默认对齐方式（系数）</h3> 
<h4><a id="_259"></a>编译器的默认对齐方式（系数）</h4> 
<p>使用 <code>#pragma pack(show)</code> 指令，在 warning 信息里面会打印默认对齐方式（系数）。<br> 遗憾的是，在 Linux gcc 环境下，这条指令并不生效：</p> 
<pre><code class="prism language-sh">$ gcc <span class="token parameter variable">-g</span> memory_alignment.c 
memory_alignment.c:4:9: warning: unknown action ‘show’ <span class="token keyword">for</span> ‘<span class="token comment">#pragma pack’ - ignored [-Wpragmas]</span>
 <span class="token comment">#pragma pack(show)</span>
         ^~~~
</code></pre> 
<p>在 Android Studio 或者 CLion中，把鼠标放在 <code>pack</code> 上，可以显示出来默认对齐方式（系数）：<br> <img src="https://images2.imgbox.com/26/fe/PFj8XSCF_o.png" alt="在这里插入图片描述"><br> 另外，使用 clang 环境的在线编辑器，也可以显示出来默认对齐方式（系数）。</p> 
<p>需要说明的是，不同的编译器的默认对齐系数可能是不一样的。</p> 
<h4><a id="_274"></a>为什么要修改编译器的默认对齐系数？</h4> 
<p>一般情况下，不建议修改编译器的默认对齐系数；但是，当我们开发好的结构作为 API 的一部分提供给第三方使用的时候，第三方开发者可能将编译器的默认对齐系数改变或者第三方开发者的编译器默认对齐系数与我们的不同，这就会造成重大的数据问题。解决办法是：和第三方开发者约定使用一样的对齐系数。</p> 
<h4><a id="_277"></a>如何修改编译器的默认对齐系数？</h4> 
<p>使用 <code>#pragma pack(n)</code> 指令，其中 <code>n</code> 就是设置的对齐系数。</p> 
<p>需要注意的是，对齐系数的取值可以是 0，1，2，4，8，16 中的一个。当取 0 时，表示恢复默认对齐系数。</p> 
<p>示例代码如下：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">pack</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> </span><span class="token comment">// 设置对齐系数为 4</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>  
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> a<span class="token punctuation">;</span>
    <span class="token keyword">short</span> b<span class="token punctuation">;</span>
    <span class="token keyword">int</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span> TestStruct1<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>  
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> a<span class="token punctuation">;</span>
    <span class="token keyword">int</span> c<span class="token punctuation">;</span>
    <span class="token keyword">short</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span> TestStruct2<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sizeof(TestStruct1) = %zd, sizeof(TestStruct2) = %zd\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TestStruct1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TestStruct2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    TestStruct1 ts1<span class="token punctuation">;</span>
    ts1<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">0x11</span><span class="token punctuation">;</span>
    ts1<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">0x2222</span><span class="token punctuation">;</span>
    ts1<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">0x33333333</span><span class="token punctuation">;</span>
    TestStruct2 ts2<span class="token punctuation">;</span>
    ts2<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">0x11</span><span class="token punctuation">;</span>
    ts2<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">0x33333333</span><span class="token punctuation">;</span>
    ts2<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">0x2222</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>设置不同的对齐系数，打印信息如下：</p> 
<table><thead><tr><th>对齐系数</th><th>打印信息</th></tr></thead><tbody><tr><td>1</td><td>sizeof(TestStruct1) = 7, sizeof(TestStruct2) = 7</td></tr><tr><td>2</td><td>sizeof(TestStruct1) = 8, sizeof(TestStruct2) = 8</td></tr><tr><td>4</td><td>sizeof(TestStruct1) = 8, sizeof(TestStruct2) = 12</td></tr><tr><td>8</td><td>sizeof(TestStruct1) = 8, sizeof(TestStruct2) = 12</td></tr><tr><td>16</td><td>sizeof(TestStruct1) = 8, sizeof(TestStruct2) = 12</td></tr></tbody></table> 
<p>从表格中，可以看到：当对齐系数小于 4 时，结构体的长度与默认对齐系数下的结构体长度不同。这是为什么呢？</p> 
<h4><a id="_328"></a>为什么修改了对齐系数会影响结构体的长度？</h4> 
<p>这是因为对齐系数的修改，影响内存对齐原则。</p> 
<p>具体来说，考虑到对齐系数的内存对齐原则是：</p> 
<ul><li>成员只能存储在 min(这个成员的长度, 对齐系数) 的整数倍的地址上；</li><li>结构体的长度是 min(它的最大成员长度, 对齐系数) 的整数倍。</li></ul> 
<p>在 2.2.2 中，我们没有考虑对齐系数的影响，是因为默认的对齐系数不小于基本数据类型的长度，也就是说，默认情况下，对齐系数不会对包含基本数据类型成员的结构体的内存对齐原则产生作用。</p> 
<p>套用完整的内存对齐原则，以及配合使用 gdb 查看内存位置来分析，得到表格如下：</p> 
<p>TestStruct1：<br> <img src="https://images2.imgbox.com/2b/1c/u0Vy1Rae_o.png" alt="在这里插入图片描述"><br> TestStruct2：<br> <img src="https://images2.imgbox.com/00/3b/qmHR9vx9_o.png" alt="在这里插入图片描述"><br> 可以看到：</p> 
<ul><li>表格中得到的结构体长度与代码打印的结构体长度是一致的；</li><li>较小的对齐系数可以产生更加紧凑的结构体，更加小的结构体长度；</li><li>较小的对齐系数使得基本数据类型成员不再是自然对齐的了，这会增加一定的内存访问，降低性能。</li></ul> 
<h4><a id="_348"></a>发送方和接收方对同一个结构体使用不同的对齐系数例子</h4> 
<p>发送方，<code>send_data.c</code>：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">pack</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> </span><span class="token comment">// 对齐系数是 1</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>  
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> a<span class="token punctuation">;</span>
    <span class="token keyword">int</span> c<span class="token punctuation">;</span>
    <span class="token keyword">short</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span> TestStruct2<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FILE <span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    TestStruct2 ts2<span class="token punctuation">;</span>
    ts2<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">0x11</span><span class="token punctuation">;</span>
    ts2<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">0x2222</span><span class="token punctuation">;</span>
    ts2<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">0x33333333</span><span class="token punctuation">;</span>
    <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ts2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TestStruct2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"send success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接收方 <code>receive_data.c</code>：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">pack</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> </span><span class="token comment">// 对齐系数也是1</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>  
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> a<span class="token punctuation">;</span>
    <span class="token keyword">int</span> c<span class="token punctuation">;</span>
    <span class="token keyword">short</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span> TestStruct2<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FILE <span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    TestStruct2 ts2<span class="token punctuation">;</span>
    <span class="token function">fread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ts2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TestStruct2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"receive: a = %#x, b = %#x, c = %#x\n"</span><span class="token punctuation">,</span> ts2<span class="token punctuation">.</span>a<span class="token punctuation">,</span> ts2<span class="token punctuation">.</span>b<span class="token punctuation">,</span> ts2<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>发送方和接收方的对齐系数都是 1。<br> 先运行发送方，将结构体数据写入到文件中；再运行接收方，从文件中读取结构体数据到结构体中。<br> 运行打印如下：</p> 
<pre><code class="prism language-text">$ gcc send_data.c 
$ ./a.out 
send success
$ gcc receive_data.c 
$ ./a.out 
receive: a = 0x11, b = 0x2222, c = 0x33333333
$ 
</code></pre> 
<p>可以看到，当发送方和接收方的对齐系数相同时，接收方可以正常获取数据。</p> 
<p>现在把接收方程序的对齐系数改为 4，再次运行接收方程序，打印如下：</p> 
<pre><code class="prism language-text">$ gcc receive_data.c 
$ ./a.out 
receive: a = 0x11, b = 0x7fff, c = 0xff222233
</code></pre> 
<p>可以看到，当发送方和接收方的对齐系数不相同时，接收方获取了错误的数据。</p> 
<p>为了找到数据出错的原因，我们使用 gdb 查看发送方和接收方的内存：<br> 发送方内存：</p> 
<pre><code class="prism language-sh"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> display <span class="token operator">&amp;</span>ts2
<span class="token number">1</span>: <span class="token operator">&amp;</span>ts2 <span class="token operator">=</span> <span class="token punctuation">(</span>TestStruct2 *<span class="token punctuation">)</span> 0x7fffffffdea9
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> x/7xb 0x7fffffffdea9
0x7fffffffdea9: 0x11    0x33    0x33    0x33    0x33    0x22    0x22
</code></pre> 
<p>接收方内存：</p> 
<pre><code class="prism language-sh"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> display <span class="token operator">&amp;</span>ts2
<span class="token number">1</span>: <span class="token operator">&amp;</span>ts2 <span class="token operator">=</span> <span class="token punctuation">(</span>TestStruct2 *<span class="token punctuation">)</span> 0x7fffffffde9c
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> x/12xb 0x7fffffffde9c
0x7fffffffde9c: 0x11    0x33    0x33    0x33    0x33    0x22       0x22    0xff
0x7fffffffdea4: 0xff    0x7f    0x00    0x00
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span>
</code></pre> 
<p>把这些信息放在表格里面：<br> <img src="https://images2.imgbox.com/76/49/QfdnK784_o.png" alt="在这里插入图片描述"><br> 可以看到，接收方可以完成获取发送方发送的 7 个字节的数据，但是，接收方获取成员数据的偏移量与发送方写入成员数据的偏移量不同，造成了 <code>int</code> 和 <code>short</code> 这两个类型的数据读取了一部分垃圾值。</p> 
<h2><a id="3__447"></a>3 最后</h2> 
<p>本文到这里就草草结束了，虽然有些啰嗦，但是还是希望可以帮助到大家。</p> 
<h2><a id="_450"></a>参考</h2> 
<ol><li><a href="https://www.bilibili.com/video/BV1VS4y1p7UE/?spm_id_from=333.788" rel="nofollow">字节对齐专题</a></li><li><a href="https://www.cnblogs.com/rsapaper/p/11853349.html" rel="nofollow">GDB查看内存命令（x命令） 用gdb查看指定地址的内存内容</a></li><li><a href="" rel="nofollow">C语言深度解剖 3.6.8 #pragma pack</a></li><li><a href="https://blog.csdn.net/weixin_45897952/article/details/123727425">深度刨析为何要内存对齐</a></li><li><a href="https://www.jb51.net/article/44221.htm" rel="nofollow">深入理解C语言内存对齐</a></li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fde77ea550b5bf1a227b40ad0d9b2f85/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">领导叫你带徒弟怎么办？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3ef89a1bbcd385b02d3c182480e63be3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【算法练习】字符串重新排序</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>