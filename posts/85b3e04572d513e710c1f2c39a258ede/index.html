<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用 .gitlab-ci.yml 配置作业 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用 .gitlab-ci.yml 配置作业" />
<meta property="og:description" content="整理一下 .gitlab-ci.yml 文件的配置
原文档地址
job job 是一组具有约束的作业，可以指定无限数量的 job 。
job 被定义为具有任意名称的顶级元素，并且始终必须至少包含该 script 子句。
job 必须具有唯一的名称，下面是一些保留的关键字不可以作为 job 的名称。
image services stages types before_script after_script variables cache 作业由定义作业行为的参数列表定义
关键词是否必须描述scriptyes定义由Runner执行的shell脚本extendsno定义此 job 将继承的配置条目imageno使用 Docker 镜像servicesno使用 Docker 服务stageno定义 job 阶段（默认：test）typenostage 的别名variablesno在 job 级别定义 job 变量onlyno定义为其创建 job 的 git refs 列表exceptno定义未创建 job 的 git refs 列表tagsno定义用于选择Runner的标记列表allow_failureno允许 job 失败，失败的 job 不会贡献 commit statuswhenno定义何时运行 job 。可以是 on_success，on_failure，always 或 manualdependenciesno定义 job 所依赖的其他 job ，以便您可以在它们之间传递 artifactsextendsnojob artifacts 依赖列表cacheno定义后续运行之间应缓存的文件列表before_scriptno覆盖 job 前执行的一组命令after_scriptno覆盖 job 后执行的一组命令environmentno定义此 job 完成部署的环境名称coverageno定义给定 job 的代码覆盖率设置retryno定义在发生故障时可以自动重试 job 的次数 extends 在 GitLab 11." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/85b3e04572d513e710c1f2c39a258ede/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-09-13T17:03:14+08:00" />
<meta property="article:modified_time" content="2018-09-13T17:03:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用 .gitlab-ci.yml 配置作业</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>整理一下 .gitlab-ci.yml 文件的配置</p> 
<p><a href="https://docs.gitlab.com/ee/ci/yaml/" rel="nofollow">原文档地址</a></p> 
<h3 id="job"><strong>job</strong></h3> 
<p>job 是一组具有约束的作业，可以指定无限数量的 job 。</p> 
<p>job 被定义为具有任意名称的顶级元素，并且始终必须至少包含该 script 子句。</p> 
<p>job 必须具有唯一的名称，下面是一些保留的关键字不可以作为 job 的名称。</p> 
<pre class="prettyprint"><code class=" hljs mel"><span class="hljs-keyword">image</span>
services
stages
types
before_script
after_script
variables
cache</code></pre> 
<p>作业由定义作业行为的参数列表定义</p> 
<table><thead><tr><th>关键词</th><th>是否必须</th><th>描述</th></tr></thead><tbody><tr><td>script</td><td>yes</td><td>定义由Runner执行的shell脚本</td></tr><tr><td>extends</td><td>no</td><td>定义此 job 将继承的配置条目</td></tr><tr><td>image</td><td>no</td><td><a href="https://docs.gitlab.com/ee/ci/docker/using_docker_images.html#define-image-and-services-from-gitlab-ciyml" rel="nofollow">使用 Docker 镜像</a></td></tr><tr><td>services</td><td>no</td><td><a href="https://docs.gitlab.com/ee/ci/docker/using_docker_images.html#define-image-and-services-from-gitlab-ciyml" rel="nofollow">使用 Docker 服务</a></td></tr><tr><td>stage</td><td>no</td><td>定义 job 阶段（默认：test）</td></tr><tr><td>type</td><td>no</td><td>stage 的别名</td></tr><tr><td>variables</td><td>no</td><td>在 job 级别定义 job 变量</td></tr><tr><td>only</td><td>no</td><td>定义为其创建 job 的 git refs 列表</td></tr><tr><td>except</td><td>no</td><td>定义未创建 job 的 git refs 列表</td></tr><tr><td>tags</td><td>no</td><td>定义用于选择Runner的标记列表</td></tr><tr><td>allow_failure</td><td>no</td><td>允许 job 失败，失败的 job 不会贡献 commit status</td></tr><tr><td>when</td><td>no</td><td>定义何时运行 job 。可以是 on_success，on_failure，always 或 manual</td></tr><tr><td>dependencies</td><td>no</td><td>定义 job 所依赖的其他 job ，以便您可以在它们之间传递 artifacts</td></tr><tr><td>extends</td><td>no</td><td><a href="https://docs.gitlab.com/ee/ci/yaml/README.html#artifacts" rel="nofollow">job artifacts 依赖列表</a></td></tr><tr><td>cache</td><td>no</td><td>定义后续运行之间应缓存的文件列表</td></tr><tr><td>before_script</td><td>no</td><td>覆盖 job 前执行的一组命令</td></tr><tr><td>after_script</td><td>no</td><td>覆盖 job 后执行的一组命令</td></tr><tr><td>environment</td><td>no</td><td>定义此 job 完成部署的环境名称</td></tr><tr><td>coverage</td><td>no</td><td>定义给定 job 的代码覆盖率设置</td></tr><tr><td>retry</td><td>no</td><td>定义在发生故障时可以自动重试 job 的次数</td></tr></tbody></table> 
<p><br></p> 
<ul><li>extends</li></ul> 
<blockquote> 
 <p>在 GitLab 11.3 中引入</p> 
</blockquote> 
<p>extends 定义要使用的 job extends 将继承的条目名称。</p> 
<p>extends 替代使用更灵活和可读的 <a href="https://docs.gitlab.com/ee/ci/yaml/#anchors" rel="nofollow">YAML</a> 锚点。</p> 
<p>例如下面两段代码</p> 
<pre class="prettyprint"><code class=" hljs haml">.tests:
  only:
    refs:
      -<span class="ruby"> branches
</span>
rspec:
  extends: .tests
  script: rake rspec
  stage: test
  only:
    variables:
      -<span class="ruby"> <span class="hljs-variable">$RSPEC</span></span></code></pre> 
<p>在上面的示例中，rspec作业将从 .tests 模板继承。GitLab 将执行反向深度合并，这意味着它将以递归方式合并 rspec 内容 </p> 
<p>.tests，并且将导致以下配置 rspec 作业：</p> 
<pre class="prettyprint"><code class=" hljs haml">rspec:
  script: rake rspec
  stage: test
  only:
    refs:
      -<span class="ruby"> branches
</span>    variables:
      -<span class="ruby"> <span class="hljs-variable">$RSPEC</span></span></code></pre> 
<p>.tests在此示例中是<strong>隐藏密钥</strong>，但也可以从常规作业继承。</p> 
<p><strong>隐藏密钥：</strong></p> 
<blockquote> 
 <p>在 GitLab 8.6 和 GitLab Runner v1.1.1 中引入。</p> 
</blockquote> 
<p>如果要暂时“禁用”作业，而不是注释掉定义作业的所有行，可以像下面这样</p> 
<p>你可以用点（.）开始它的名字，它不会被 GitLab CI 处理。在以下示例中，.hidden_job 将被忽略：</p> 
<pre class="prettyprint"><code class=" hljs vala"><span class="hljs-comment">// 注释</span>
<span class="hljs-preprocessor">#hidden_job:</span>
<span class="hljs-preprocessor">#  script:</span>
<span class="hljs-preprocessor">#    - run test</span>

<span class="hljs-comment">// 隐藏密钥</span>
.hidden_job:
  script:
    - run test</code></pre> 
<p>extends支持多级继承，但不建议使用三级以上的继承。支持的最大嵌套级别为10级。</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-label">.tests:</span>
  only:
    - pushes

<span class="hljs-label">.rspec:</span>
  extends: <span class="hljs-preprocessor">.tests</span>
  script: rake rspec

rspec <span class="hljs-number">1</span>:
  variables:
    RSPEC_SUITE: <span class="hljs-string">'1'</span>
  extends: <span class="hljs-preprocessor">.rspec</span>

rspec <span class="hljs-number">2</span>:
  variables:
    RSPEC_SUITE: <span class="hljs-string">'2'</span>
  extends: <span class="hljs-preprocessor">.rspec</span>

<span class="hljs-label">spinach:</span>
  extends: <span class="hljs-preprocessor">.tests</span>
  script: rake spinach</code></pre> 
<p>extends 跨配置文件结合使用 include 。</p> 
<p><strong>YAML：</strong></p> 
<p>YAML有一个名为“anchors”的便捷功能，可让您轻松复制文档中的内容。Anchor可用于复制/继承属性，是与隐藏键 一起使 <br> 用以提供作业模板的完美示例。</p> 
<p>以下示例使用锚点和映射合并。它将创建两个作业， test1并且test2将继承参数.job_template，每个作业都有自己定义的自 <br> script定义：</p> 
<pre class="prettyprint"><code class=" hljs haml">.job_template: &amp;job_definition  # Hidden key that defines an anchor named 'job_definition'
  image: ruby:2.1
  services:
    -<span class="ruby"> postgres
</span>    -<span class="ruby"> redis
</span>
test1:
  &lt;&lt;: *job_definition           # Merge the contents of the 'job_definition' alias
  script:
    -<span class="ruby"> test1 project
</span>
test2:
  &lt;&lt;: *job_definition           # Merge the contents of the 'job_definition' alias
  script:
    -<span class="ruby"> test2 project</span></code></pre> 
<p>&amp; 设置 anchor（job_definition）的名称，&lt;&lt; 意味着“将给定的哈希合并到当前的哈希”，并 * 包括命名锚（ job_definition ）。扩展版本如下所示：</p> 
<pre class="prettyprint"><code class=" hljs haml">.job_template:
  image: ruby:2.1
  services:
    -<span class="ruby"> postgres
</span>    -<span class="ruby"> redis
</span>
test1:
  image: ruby:2.1
  services:
    -<span class="ruby"> postgres
</span>    -<span class="ruby"> redis
</span>  script:
    -<span class="ruby"> test1 project
</span>
test2:
  image: ruby:2.1
  services:
    -<span class="ruby"> postgres
</span>    -<span class="ruby"> redis
</span>  script:
    -<span class="ruby"> test2 project</span></code></pre> 
<p>让我们看另一个例子。这次我们将使用锚来定义两组服务。这将创建两个作业，test:postgres 并且 test:mysql，将共享 script 中定义的指令 .job_template，并 services 指令定义 .postgres_services 和 .mysql_services 分别为：</p> 
<pre class="prettyprint"><code class=" hljs haml">.job_template: &amp;job_definition
  script:
    -<span class="ruby"> test project
</span>
.postgres_services:
  services: &amp;postgres_definition
    -<span class="ruby"> postgres
</span>    -<span class="ruby"> ruby
</span>
.mysql_services:
  services: &amp;mysql_definition
    -<span class="ruby"> mysql
</span>    -<span class="ruby"> ruby
</span>
test:postgres:
  &lt;&lt;: *job_definition
  services: *postgres_definition

test:mysql:
  &lt;&lt;: *job_definition
  services: *mysql_definition</code></pre> 
<p>扩展版本如下所示：</p> 
<pre class="prettyprint"><code class=" hljs haml">.job_template:
  script:
    -<span class="ruby"> test project
</span>
.postgres_services:
  services:
    -<span class="ruby"> postgres
</span>    -<span class="ruby"> ruby
</span>
.mysql_services:
  services:
    -<span class="ruby"> mysql
</span>    -<span class="ruby"> ruby
</span>
test:postgres:
  script:
    -<span class="ruby"> test project
</span>  services:
    -<span class="ruby"> postgres
</span>    -<span class="ruby"> ruby
</span>
test:mysql:
  script:
    -<span class="ruby"> test project
</span>  services:
    -<span class="ruby"> mysql
</span>    -<span class="ruby"> ruby</span></code></pre> 
<ul><li><p><strong>pages</strong></p> <p>pages 是一项特殊工作，用于将静态内容上传到 GitLab，可用于为您的网站提供服务。它有一个特殊的语法，因此必须满足以下两个要求：</p> 
  <ul><li>任何静态内容都必须放在 public/ 目录下</li><li>artifactspublic/ 必须定义目录的路径</li></ul> <p>下面的示例只是将项目根目录中的所有文件移动到 public/ 目录中。该 .public 解决方法是这样 cp 不也复制 public/ 到自身无限循环：</p></li></ul> 
<pre class="prettyprint"><code class=" hljs haml">pages:
  stage: deploy
  script:
    -<span class="ruby"> mkdir .public
</span>    -<span class="ruby"> cp -r * .public
</span>    -<span class="ruby"> mv .public public
</span>  artifacts:
    paths:
      -<span class="ruby"> public
</span>  only:
    -<span class="ruby"> master</span></code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e52b9ad44a91be6930c6b6681fb62e1c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">OMNI协议介绍</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c0455e979c45aa10ced6d8eb7a961d6a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">工具网站收藏(持续更新)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>