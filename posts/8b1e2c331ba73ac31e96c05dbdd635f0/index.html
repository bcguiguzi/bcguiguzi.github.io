<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>pytorch: num_workers ＞1 的时候 Unable to open object (bad object header version number) - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="pytorch: num_workers ＞1 的时候 Unable to open object (bad object header version number)" />
<meta property="og:description" content="问题描述：
KeyError: &#39;Unable to open object (bad object header version number)&#39;
原因：
模型的num_workers &gt;1 且使用了h5py 文件，但是h5py文件不支持多线程读取（其实不是）
解决：
This issue could be solved and the solution is simple:【两个方案】
Do not open hdf5 inside __init__ （不要再init里面初始化h5py文件）
Open the hdf5 at the first data iteration. （在第一个getitem的时候初始化）
解决示例：
class LXRTDataLoader(torch.utils.data.Dataset): def __init__(self): &#34;&#34;&#34;do not open hdf5 here!!&#34;&#34;&#34; def open_hdf5(self): self.img_hdf5 = h5py.File(&#39;img.hdf5&#39;, &#39;r&#39;) self.dataset = self.img_hdf5[&#39;dataset&#39;] # if you want dataset. def __getitem__(self, item: int): if not hasattr(self, &#39;img_hdf5&#39;): self." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/8b1e2c331ba73ac31e96c05dbdd635f0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-04T16:07:28+08:00" />
<meta property="article:modified_time" content="2021-04-04T16:07:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">pytorch: num_workers ＞1 的时候 Unable to open object (bad object header version number)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>问题描述：</p> 
<blockquote> 
 <p>KeyError: 'Unable to open object (bad object header version number)'</p> 
</blockquote> 
<p>原因：</p> 
<p>模型的num_workers &gt;1 且使用了h5py 文件，但是h5py文件不支持多线程读取（其实不是）</p> 
<p>解决：</p> 
<p>This issue could be solved and the solution is simple:【两个方案】</p> 
<ol><li> <p>Do not open hdf5 inside __init__ （不要再init里面初始化h5py文件）</p> </li><li> <p>Open the hdf5 at the first data iteration. （在第一个getitem的时候初始化）</p> </li></ol> 
<p>解决示例：</p> 
<pre><code class="language-python">class LXRTDataLoader(torch.utils.data.Dataset):
    def __init__(self):
        """do not open hdf5 here!!"""

    def open_hdf5(self):
        self.img_hdf5 = h5py.File('img.hdf5', 'r')
        self.dataset = self.img_hdf5['dataset'] # if you want dataset.

    def __getitem__(self, item: int):
        if not hasattr(self, 'img_hdf5'):
            self.open_hdf5()
        img0 = self.img_hdf5['dataset'][0] # Do loading here
        img1 = self.dataset[1]
        return img0, img1</code></pre> 
<pre> </pre> 
<p>解释</p> 
<p>The multi-processing actually happens when you create the data iterator (e.g., when callingfor datum in dataloader:):</p> 
<p>In short, it would create multiple processes which "copy" the state of the current process. Thus the opened hdf5 file object would be dedicated to each subprocess if we open it at the first data iteration.</p> 
<p>（翻译：简而言之，它将创建多个进程，这些进程“复制”当前进程的状态。因此，如果我们在第一次数据迭代时打开hdf5文件对象，那么它将专用于每个子进程。）</p> 
<hr> 
<p>If you somehow create an hdfs file in __init__ and set up the `num_workers' &gt; 0, it might cause two issues:（如果在主进程创建 hdfs文件且`num_workers' &gt; 0 会导致两个问题：）</p> 
<ol><li> <p>The writing behavior is non-determistic. (We do not need to write to hdf5, thus this issue is ignored.)</p> </li><li> <p>The state of the hdfs is copied, which might not faithfully indicate the current state.</p> </li></ol> 
<p>In the previous way, we bypass this two issues.（现在我们避免了这两个问题）</p> 
<p> </p> 
<p>参考：</p> 
<p><a href="https://github.com/pytorch/pytorch/issues/11929">https://github.com/pytorch/pytorch/issues/11929</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/31a88d9e8027d72e397f5ff94c8d599a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">(图像/视频/实时网络摄像头)动作位点预测（human-pose-estimation）手把手教程:Anaconda&#43;Jupyter&#43;Opencv</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f9b90ae30b515ef2732c8d0153bf7e0a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">开发自己的dashboard</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>