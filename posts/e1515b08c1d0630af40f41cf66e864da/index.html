<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux内核-I/O多路复用[select]和I/O事件就绪通知源码分析 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux内核-I/O多路复用[select]和I/O事件就绪通知源码分析" />
<meta property="og:description" content="文章目录 概要一、了解 Linux1.1、Linux下OSI五层模型1.2、Linux的进程状态转换模型1.3、Linux下的中断之时钟中断 二、select源码解析2.1、select使用案例2.2、select源码2.2.1、相关结构体2.2.2、core_sys_select2.2.3、do_select 三、I/O事件就绪通知源码解析3.1、相关结构体3.2、tcp与socket关联源码分析3.3、TCP收到数据时回调唤醒进程 四、socket等待队列4.1、虚拟文件系统sockfs4.2、socket等待队列初始化 五、select超时源码解析六、参考 概要 在select、poll和epoll的区别一文中不断地提到Linux内核I/O事件就绪通知相关字眼，可以说其是多路复用I/O模型的绝对核心，是比阻塞I/O,非阻塞I/O模型高性能的一大关键点。
本文就基于select源码一探究竟，在I/O事件就绪通知源码上poll和epoll是适用的。
PS:基于linux内核V6.7。
一、了解 Linux 1.1、Linux下OSI五层模型 如图所示，当我们创建一个TCP socket后，然后通过select API阻塞进程，此时有个客户端要建立连接，数据包通往网络抵达当前服务器，就会：
先到网卡，网卡收到的数据是光信号或电信号，然后将其还原成数字信息(由1和0组成)，数据通过过滤校验后，会通过DMA的方式写入到指定的内存地址（这块地址也叫网卡缓冲区，是操作系统启动时，加载网卡驱动代码的时候，网卡驱动代码申请的），最后给CPU发送中断信号，这一阶段不需要CPU参与；CPU收到中断信号，就调用网卡对应的网卡驱动代码（网卡驱动程序每个网卡制造商都要集成到Linux内核中，如华为以太网驱动），驱动代码会将网卡缓冲区的数据包转换成Linux内核网络模块能识别的skb格式(网卡缓冲区的数据包格式只有网卡驱动知道)，然后调用IP 层的入口函数上传给Linux内核网络模块的IP层;IP 层的入口函数是 ip_rcv函数，将skb格式的数据包进行校验处理，继续调TCP层入口函数，上传给Linux内核网络模块的TCP层;TCP层的入口函数是tcp_v4_rcv 函数，将skb格式的数据包进行校验处理，放进 socket 的 receive queue中，通过 socket 唤醒进程;进程被唤醒后，就通过Glibc scoket API进行I/O操作，即可通过accept API与客户端建立连接。 1.2、Linux的进程状态转换模型 通过Linux任务状态常量可以看到进程状态有很多：
/* Used in tsk-&gt;__state: */ #define TASK_RUNNING	0x00000000 #define TASK_INTERRUPTIBLE	0x00000001 #define TASK_UNINTERRUPTIBLE	0x00000002 #define __TASK_STOPPED	0x00000004 #define __TASK_TRACED	0x00000008 /* Used in tsk-&gt;exit_state: */ #define EXIT_DEAD	0x00000010 #define EXIT_ZOMBIE	0x00000020 #define EXIT_TRACE	(EXIT_ZOMBIE | EXIT_DEAD) /* Used in tsk-&gt;__state again: */ #define TASK_PARKED	0x00000040 #define TASK_DEAD	0x00000080 #define TASK_WAKEKILL	0x00000100 #define TASK_WAKING	0x00000200 #define TASK_NOLOAD	0x00000400 #define TASK_NEW	0x00000800 #define TASK_RTLOCK_WAIT	0x00001000 #define TASK_FREEZABLE	0x00002000 #define __TASK_FREEZABLE_UNSAFE	(0x00004000 * IS_ENABLED(CONFIG_LOCKDEP)) #define TASK_FROZEN	0x00008000 #define TASK_STATE_MAX	0x00010000 #define TASK_ANY	(TASK_STATE_MAX-1) /* * DO NOT ADD ANY NEW USERS !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/e1515b08c1d0630af40f41cf66e864da/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-13T23:56:49+08:00" />
<meta property="article:modified_time" content="2024-02-13T23:56:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux内核-I/O多路复用[select]和I/O事件就绪通知源码分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">概要</a></li><li><a href="#_Linux_6" rel="nofollow">一、了解 Linux</a></li><li><ul><li><ul><li><a href="#11LinuxOSI_7" rel="nofollow">1.1、Linux下OSI五层模型</a></li><li><a href="#12Linux_16" rel="nofollow">1.2、Linux的进程状态转换模型</a></li><li><a href="#13Linux_74" rel="nofollow">1.3、Linux下的中断之时钟中断</a></li></ul> 
   </li></ul> 
   </li><li><a href="#select_98" rel="nofollow">二、select源码解析</a></li><li><ul><li><ul><li><a href="#21select_101" rel="nofollow">2.1、select使用案例</a></li><li><a href="#22select_243" rel="nofollow">2.2、select源码</a></li><li><ul><li><ul><li><a href="#221_254" rel="nofollow">2.2.1、相关结构体</a></li><li><a href="#222core_sys_select_281" rel="nofollow">2.2.2、core_sys_select</a></li><li><a href="#223do_select_322" rel="nofollow">2.2.3、do_select</a></li></ul> 
     </li></ul> 
    </li></ul> 
   </li></ul> 
   </li><li><a href="#IO_472" rel="nofollow">三、I/O事件就绪通知源码解析</a></li><li><ul><li><ul><li><a href="#31_499" rel="nofollow">3.1、相关结构体</a></li><li><a href="#32tcpsocket_580" rel="nofollow">3.2、tcp与socket关联源码分析</a></li><li><a href="#33TCP_778" rel="nofollow">3.3、TCP收到数据时回调唤醒进程</a></li></ul> 
   </li></ul> 
   </li><li><a href="#socket_1002" rel="nofollow">四、socket等待队列</a></li><li><ul><li><ul><li><a href="#41sockfs_1023" rel="nofollow">4.1、虚拟文件系统sockfs</a></li><li><a href="#42socket_1100" rel="nofollow">4.2、socket等待队列初始化</a></li></ul> 
   </li></ul> 
   </li><li><a href="#select_1174" rel="nofollow">五、select超时源码解析</a></li><li><a href="#_1304" rel="nofollow">六、参考</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>概要</h3> 
<p>在<a href="https://blog.csdn.net/weixin_38597669/article/details/136048862">select、poll和epoll的区别</a>一文中不断地提到<code>Linux内核I/O事件就绪通知</code>相关字眼，可以说其是多路复用I/O模型的绝对核心，是比阻塞I/O,非阻塞I/O模型高性能的一大关键点。<br> 本文就基于select源码一探究竟，在I/O事件就绪通知源码上poll和epoll是适用的。</p> 
<p>PS:基于<a href="https://github.com/torvalds/linux/tree/v6.7">linux内核V6.7</a>。</p> 
<h3><a id="_Linux_6"></a>一、了解 Linux</h3> 
<h5><a id="11LinuxOSI_7"></a>1.1、Linux下OSI五层模型</h5> 
<p><img src="https://images2.imgbox.com/3e/e0/OxMBF8xH_o.png" alt="Linux OSI五层模型"><br> 如图所示，当我们创建一个TCP socket后，然后通过select API阻塞进程，此时有个<code>客户端</code>要建立连接，数据包通往网络抵达当前服务器，就会：</p> 
<ol><li>先到网卡，网卡收到的数据是光信号或电信号，然后将其还原成数字信息(由1和0组成)，数据通过过滤校验后，会通过DMA的方式写入到指定的内存地址（这块地址也叫网卡缓冲区，是操作系统启动时，加载网卡驱动代码的时候，网卡驱动代码申请的），最后给CPU发送中断信号，这一阶段不需要CPU参与；</li><li>CPU收到中断信号，就调用网卡对应的网卡驱动代码（网卡驱动程序每个网卡制造商都要集成到Linux内核中，如<a href="https://github.com/torvalds/linux/tree/v6.7/drivers/net/ethernet/huawei/hinic">华为以太网驱动</a>），驱动代码会将网卡缓冲区的数据包转换成Linux内核网络模块能识别的skb格式(网卡缓冲区的数据包格式只有网卡驱动知道)，然后调用IP 层的入口函数上传给Linux内核网络模块的<code>IP层</code>;</li><li>IP 层的入口函数是 <a href="https://github.com/torvalds/linux/blob/v6.7/net/ipv4/ip_input.c#L560">ip_rcv函数</a>，将skb格式的数据包进行校验处理，继续调TCP层入口函数，上传给Linux内核网络模块的<code>TCP层</code>;</li><li>TCP层的入口函数是<a href="https://github.com/torvalds/linux/blob/v6.7/net/ipv4/tcp_ipv4.c#L2161">tcp_v4_rcv 函数</a>，将skb格式的数据包进行校验处理，放进 socket 的 receive queue中，通过 socket 唤醒进程;</li><li>进程被唤醒后，就通过Glibc scoket API进行I/O操作，即可通过accept API与<code>客户端</code>建立连接。</li></ol> 
<h5><a id="12Linux_16"></a>1.2、Linux的进程状态转换模型</h5> 
<p>通过<a href="https://github.com/torvalds/linux/blob/v6.7/include/linux/sched.h#L85">Linux任务状态常量</a>可以看到进程状态有很多：</p> 
<pre><code class="prism language-c"><span class="token comment">/* Used in tsk-&gt;__state: */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_RUNNING</span>			<span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_INTERRUPTIBLE</span>		<span class="token expression"><span class="token number">0x00000001</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_UNINTERRUPTIBLE</span>		<span class="token expression"><span class="token number">0x00000002</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TASK_STOPPED</span>			<span class="token expression"><span class="token number">0x00000004</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TASK_TRACED</span>			<span class="token expression"><span class="token number">0x00000008</span></span></span>
<span class="token comment">/* Used in tsk-&gt;exit_state: */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EXIT_DEAD</span>			<span class="token expression"><span class="token number">0x00000010</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EXIT_ZOMBIE</span>			<span class="token expression"><span class="token number">0x00000020</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EXIT_TRACE</span>			<span class="token expression"><span class="token punctuation">(</span>EXIT_ZOMBIE <span class="token operator">|</span> EXIT_DEAD<span class="token punctuation">)</span></span></span>
<span class="token comment">/* Used in tsk-&gt;__state again: */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_PARKED</span>			<span class="token expression"><span class="token number">0x00000040</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_DEAD</span>			<span class="token expression"><span class="token number">0x00000080</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_WAKEKILL</span>			<span class="token expression"><span class="token number">0x00000100</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_WAKING</span>			<span class="token expression"><span class="token number">0x00000200</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_NOLOAD</span>			<span class="token expression"><span class="token number">0x00000400</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_NEW</span>			<span class="token expression"><span class="token number">0x00000800</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_RTLOCK_WAIT</span>		<span class="token expression"><span class="token number">0x00001000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_FREEZABLE</span>			<span class="token expression"><span class="token number">0x00002000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TASK_FREEZABLE_UNSAFE</span>	       <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x00004000</span> <span class="token operator">*</span> <span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_LOCKDEP<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_FROZEN</span>			<span class="token expression"><span class="token number">0x00008000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_STATE_MAX</span>			<span class="token expression"><span class="token number">0x00010000</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_ANY</span>			<span class="token expression"><span class="token punctuation">(</span>TASK_STATE_MAX<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/*
 * DO NOT ADD ANY NEW USERS !
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_FREEZABLE_UNSAFE</span>		<span class="token expression"><span class="token punctuation">(</span>TASK_FREEZABLE <span class="token operator">|</span> __TASK_FREEZABLE_UNSAFE<span class="token punctuation">)</span></span></span>

<span class="token comment">/* Convenience macros for the sake of set_current_state: */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_KILLABLE</span>			<span class="token expression"><span class="token punctuation">(</span>TASK_WAKEKILL <span class="token operator">|</span> TASK_UNINTERRUPTIBLE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_STOPPED</span>			<span class="token expression"><span class="token punctuation">(</span>TASK_WAKEKILL <span class="token operator">|</span> __TASK_STOPPED<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_TRACED</span>			<span class="token expression">__TASK_TRACED</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_IDLE</span>			<span class="token expression"><span class="token punctuation">(</span>TASK_UNINTERRUPTIBLE <span class="token operator">|</span> TASK_NOLOAD<span class="token punctuation">)</span></span></span>

<span class="token comment">/* Convenience macros for the sake of wake_up(): */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_NORMAL</span>			<span class="token expression"><span class="token punctuation">(</span>TASK_INTERRUPTIBLE <span class="token operator">|</span> TASK_UNINTERRUPTIBLE<span class="token punctuation">)</span></span></span>

<span class="token comment">/* get_task_state(): */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TASK_REPORT</span>			<span class="token expression"><span class="token punctuation">(</span>TASK_RUNNING <span class="token operator">|</span> TASK_INTERRUPTIBLE <span class="token operator">|</span> TASK_UNINTERRUPTIBLE <span class="token operator">|</span> __TASK_STOPPED <span class="token operator">|</span> </span></span>
					 __TASK_TRACED <span class="token operator">|</span> EXIT_DEAD <span class="token operator">|</span> EXIT_ZOMBIE <span class="token operator">|</span> TASK_PARKED<span class="token punctuation">)</span>
</code></pre> 
<p>不过核心的就6个：</p> 
<ul><li>TASK_RUNNING【R】：就绪或运行状态；</li><li>TASK_INTERRUPTIBLE【S】：可中断等待状态。此进程排入任务等待队列中，一旦资源可用时就会被唤醒，<code>也可</code>由其他进程通过中断或信号唤醒；</li><li>TASK_UNINTERRUPTIBLE【D】：不可中断等待状态。一旦资源可用时就会被唤醒，<code>不可</code>由其他进程通过中断或信号唤醒，通常用于进程必须等待某件工作完成，如进程打开设备文件时就会处于该状态，不能被 kill。</li><li>TASK_STOPPED【T】：暂停状态。此状态用于调试，因收到暂停信号（SIGSTOP）而暂停执行，也可能受其他进程的跟踪和调用而暂时让出处理器；</li><li>EXIT_ZOMBIE【Z】：僵尸状态。进程运行完成，已释放了所占用的大部分资源，尚未释放<code>task_struct结构体</code>；</li><li>EXIT_DEAD【X】：退出状态。进程即将被销毁，非常短暂，几乎不会被ps命令捕捉到。<br> <img src="https://images2.imgbox.com/db/46/epHinFcZ_o.png" alt="Linux进程状态变化示意图"></li></ul> 
<h5><a id="13Linux_74"></a>1.3、Linux下的中断之时钟中断</h5> 
<p>中断机制是计算机系统的重要组成部分，在Linux中也不例外，中断按照来源分为硬中断和软中断，而硬中断根据硬件范围分为外中断和内中断。时钟中断就是内中断的一种。</p> 
<blockquote> 
 <p>之所以要提到时钟中断，是因为时钟是操作系统进行调度工作的重要工具，如维护系统的绝对日期和时间、让分时进程按时间片轮转、让实时进程定时发送换接收控制信号、系统定时唤醒或阻塞进程、对用户进程记账、测量系统性能等，利用定时器能够确保操作系统在必要的时候获得控制权，陷入死循环的进程最终会因时间片耗尽而被迫让出CPU。<br> 计算机里面主要有三类硬件时钟芯片，分别是实时时钟RTC(Real Time Clock)、定时器Timer、计时器Counter。RTC相当于是手表、座钟。定时器相当于是闹钟。计时器相当于是运动会中的计时器。注意是三类硬件时钟芯片，而不是三个，某一类时钟可能基于多个不同的硬件时钟芯片，某一个硬件时钟芯片也可能被用于实现多种时钟类型。当然还有其它的时钟类型，比如晶振时钟，是驱动CPU运行的周期信号，用来触发和同步CPU内部的操作，我们常说某CPU是多少GHz，就是说这个时钟晶振每秒向CPU发送多少信号。</p> 
</blockquote> 
<p>时钟中断是基于硬件时钟芯片，Linux操作启动时：</p> 
<ol><li>会加载硬件时钟芯片的驱动（参考<a href="https://github.com/torvalds/linux/blob/v6.7/drivers/rtc/rtc-stm32.c#L939">实时时钟RTC stm32驱动</a>）；</li><li>此时会注册时钟中断回调函数(参考<a href="https://github.com/torvalds/linux/blob/v6.7/drivers/rtc/class.c#L476">RTC驱动框架</a>)；</li><li>等硬件时钟芯片到时是就会向CPU发送特定的中断信号，触发时钟中断回调函数，唤醒阻塞进程(参考<a href="https://github.com/torvalds/linux/blob/v6.7/drivers/rtc/interface.c#L617">RTC驱动框架最终回调</a>，会调用wake_up_interruptible函数唤醒进程)。</li></ol> 
<p>请充分理解<a href="https://www.cnblogs.com/zyly/p/17208082.html" rel="nofollow">Linux RTC驱动</a>这篇博客，将对你理解Linux时钟中断起到事半功倍的效果。</p> 
<p>那么Linux 时钟中断架构归纳如下图：<br> <img src="https://images2.imgbox.com/eb/f2/VIo8nkGK_o.png" alt="Linux 时钟中断架构图"></p> 
<blockquote> 
 <p>Linux的时钟中断来源于硬件时钟芯片，通过【硬件时钟芯片驱动】作为中间层联通硬件与操作系统任务（进程，线程等）。当我们我们通过<code>hitmer</code>启动定时任务挂起进程时，进程状态由TASK_RUNNING变为TASK_INTERRUPTIBLE，当定时任务到期时就会唤醒进程，使其状态由TASK_INTERRUPTIBLE变为TASK_RUNNING。</p> 
</blockquote> 
<p>这个时候肯呢个有小伙伴问了，<code>Linux下一个硬件时钟芯片触发时钟中断，回调时钟中断函数，如何实现管理多个定时器呢？</code></p> 
<blockquote> 
 <p>简单来说就是用特定的数据结构（时间轮、最小堆、红黑树等，比如低精度定时器timer采用时间轮，高精度定时器hrtimer采用红黑树）管理众多的定时器，在时钟中断回调函数中判断哪些定时器超时，然后执行超时处理动作(一般是唤醒等待队列中的进程)。<br> 所以说低精度定时器(ms级)实现不了高精度定时任务(ns级)，会导致提前或延后触发定时任务。</p> 
</blockquote> 
<h3><a id="select_98"></a>二、select源码解析</h3> 
<p>我们结合select的Glibc库使用来分析。</p> 
<h5><a id="21select_101"></a>2.1、select使用案例</h5> 
<p><a href="https://blog.csdn.net/weixin_38597669/article/details/136048862">select api说明</a>。<br> 对于select fd_set类型参数可以用下面函数进行操作：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">FD_SET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置文件描述符到集合中</span>
<span class="token keyword">void</span> <span class="token function">FD_CLR</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//从集合中清除文件描述符标志</span>
<span class="token keyword">int</span>  <span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//判断文件描述符在集合中是否被标志</span>
<span class="token keyword">void</span> <span class="token function">FD_ZERO</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清空集合</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FD_SET</span><span class="token expression"><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>fdsetp<span class="token punctuation">)</span>    <span class="token function">__FD_SET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>fdsetp<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FD_CLR</span><span class="token expression"><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>fdsetp<span class="token punctuation">)</span>    <span class="token function">__FD_CLR</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>fdsetp<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FD_ISSET</span><span class="token expression"><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>fdsetp<span class="token punctuation">)</span>    <span class="token function">__FD_ISSET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>fdsetp<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FD_ZERO</span><span class="token expression"><span class="token punctuation">(</span>fdsetp<span class="token punctuation">)</span>        <span class="token function">__FD_ZERO</span><span class="token punctuation">(</span>fdsetp<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__FD_SET</span><span class="token expression"><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> fdsetp<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>fdsetp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>fds_bits<span class="token punctuation">[</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//其实就是将fds_bits数组特定位设置为1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__FD_CLR</span><span class="token expression"><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> fdsetp<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>fdsetp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>fds_bits<span class="token punctuation">[</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="token comment">//其实就是将fds_bits数组特定位设置为0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__FD_ISSET</span><span class="token expression"><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> fdsetp<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>fdsetp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>fds_bits<span class="token punctuation">[</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span><span class="token comment">//其实就是判定fds_bits数组特定位是否为1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__FD_ZERO</span><span class="token expression"><span class="token punctuation">(</span>fdsetp<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span><span class="token function">memset</span> <span class="token punctuation">(</span>fdsetp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>fdsetp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">//其实就是将fds_bits数组所有位设置为0</span></span>
</code></pre> 
<p><code>综上可知fd_set结构体包含了一个fds_bits的long型数组，不管32位还是64为系统下，其总位数是FD_SETSIZE（内核默认1024），通过每一位是0或1来描述对应socket描述符状态（即是否有I/O事件）。我们通过select API将我们要监听的文件描述符对应的位设置好后，传递给内核空间，内核会重新设置要监听的文件描述符对应的位是0或1，最后返回到用户空间，告诉我们该描述符是否有I/O事件</code></p> 
<p>DEMO:</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">int</span> server_sockfd<span class="token punctuation">,</span> client_sockfd<span class="token punctuation">;</span> 
    <span class="token keyword">int</span> server_len<span class="token punctuation">,</span> client_len<span class="token punctuation">;</span> 
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_address<span class="token punctuation">;</span> 
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> addr_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">int</span> ret<span class="token punctuation">,</span> fd<span class="token punctuation">;</span> 
    fd_set readfds<span class="token punctuation">,</span> tempfds<span class="token punctuation">;</span> 
    server_sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//建立TCP socket </span>
    
    server_address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span> 
    server_address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//地址 0.0.0.0</span>
    server_address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>server_sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span> 
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bind err: %d\n"</span><span class="token punctuation">,</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>server_sockfd<span class="token punctuation">,</span> <span class="token number">125</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置TCP连接队列容量为125</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span> 
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"listen err: %d\n"</span><span class="token punctuation">,</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">FD_SET</span><span class="token punctuation">(</span>server_sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将TCP socket加入到监听集合中</span>
    <span class="token keyword">int</span> maxfd <span class="token operator">=</span> server_sockfd<span class="token punctuation">;</span>  <span class="token comment">//监听的最大套接字</span>
    
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> tv <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>    
 	     <span class="token punctuation">.</span>tv_sec<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>    
 	     <span class="token punctuation">.</span>tv_usec<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>    
    <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//select超时时间为5s</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//接收客户端数据</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        tempfds <span class="token operator">=</span> readfds<span class="token punctuation">;</span><span class="token comment">//将需要监视的描述符集copy到select查询队列中，select会对其修改，所以一定要分开使用变量 </span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server to waiting\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

        ret <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>maxfd<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tempfds<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//FD_SETSIZE：系统默认的最大文件描述符</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span> 
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"select err: %d\n"</span><span class="token punctuation">,</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//这里出错就退出循环</span>
        <span class="token punctuation">}</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//超时继续</span>
        <span class="token punctuation">{<!-- --></span> 
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"select timeout.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">continue</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
        <span class="token comment">//先处理下新的客户端连接</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>server_sockfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>tempfds<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>  
             client_sockfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>server_sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>client_sockfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
             <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"accept err: %d\n"</span><span class="token punctuation">,</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span> 
             <span class="token punctuation">}</span>
             <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>client_sockfd <span class="token operator">&gt;=</span> FD_SETSIZE<span class="token punctuation">)</span> <span class="token comment">//最多1024个</span>
             <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error: too many client\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
             <span class="token keyword">else</span>
             <span class="token punctuation">{<!-- --></span>
                <span class="token function">FD_SET</span><span class="token punctuation">(</span>client_sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将客户端socket加入到集合中</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"new client fd: %d\n"</span><span class="token punctuation">,</span> client_sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>maxfd <span class="token operator">&lt;</span> client_sockfd<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    maxfd <span class="token operator">=</span> client_sockfd<span class="token punctuation">;</span>  <span class="token comment">//更新maxfd</span>
                <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span> 
         
        <span class="token keyword">for</span><span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> fd <span class="token operator">&lt;=</span> maxfd<span class="token punctuation">;</span> fd<span class="token operator">++</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tempfds<span class="token punctuation">)</span> <span class="token operator">||</span> fd <span class="token operator">==</span> server_sockfd<span class="token punctuation">)</span> <span class="token comment">//过滤</span>
            <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">bzero</span> <span class="token punctuation">(</span>buf<span class="token punctuation">,</span> BUFSIZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">read</span> <span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> BUFSIZ <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read err: %d\n"</span><span class="token punctuation">,</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//关闭</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"close client fd: %d\n"</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">FD_CLR</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将socket 从集合中移除</span>
                <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭client socket</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
               <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"msg form client[%d]: %s\n"</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
    <span class="token function">close</span><span class="token punctuation">(</span>server_sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关闭server socket</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="22select_243"></a>2.2、select源码</h5> 
<p>我们通过Glibc库调用select API时，其实走的是<a href="https://github.com/torvalds/linux/blob/v6.7/fs/select.c#L726">Linux 内核一个函数</a>：</p> 
<pre><code class="prism language-c"><span class="token function">SYSCALL_DEFINE5</span><span class="token punctuation">(</span>select<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> fd_set __user <span class="token operator">*</span><span class="token punctuation">,</span> inp<span class="token punctuation">,</span> fd_set __user <span class="token operator">*</span><span class="token punctuation">,</span> outp<span class="token punctuation">,</span>
		fd_set __user <span class="token operator">*</span><span class="token punctuation">,</span> exp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">__kernel_old_timeval</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> tvp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">kern_select</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> inp<span class="token punctuation">,</span> outp<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> tvp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>根据源码可知其调用链如下：<img src="https://images2.imgbox.com/73/27/FCjljTpK_o.png" alt="Linux select源码调用链"></p> 
<h6><a id="221_254"></a>2.2.1、相关结构体</h6> 
<p>先熟悉下若干结构体。</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">poll_table_struct</span> <span class="token punctuation">{<!-- --></span>
	poll_queue_proc _qproc<span class="token punctuation">;</span> <span class="token comment">//关注下这个结构体_qproc是一个回调函数就好了，在select源码里面会被设置为__pollwait函数</span>
	__poll_t _key<span class="token punctuation">;</span>
<span class="token punctuation">}</span> poll_table<span class="token punctuation">;</span>
<span class="token comment">/*
 * Structures and helpers for select/poll syscall
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">poll_wqueues</span> <span class="token punctuation">{<!-- --></span>
	poll_table pt<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">poll_table_page</span> <span class="token operator">*</span>table<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>polling_task<span class="token punctuation">;</span> <span class="token comment">//Linux中task_struct结构体是进程控制块（PCB）</span>
	<span class="token keyword">int</span> triggered<span class="token punctuation">;</span>
	<span class="token keyword">int</span> error<span class="token punctuation">;</span>
	<span class="token keyword">int</span> inline_index<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">poll_table_entry</span> inline_entries<span class="token punctuation">[</span>N_INLINE_POLL_ENTRIES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">poll_table_entry</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">;</span>
	__poll_t key<span class="token punctuation">;</span>
	<span class="token class-name">wait_queue_entry_t</span> wait<span class="token punctuation">;</span> <span class="token comment">//当前进程在等待队列中的节点</span>
	<span class="token class-name">wait_queue_head_t</span> <span class="token operator">*</span>wait_address<span class="token punctuation">;</span> <span class="token comment">//等待队列头</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="222core_sys_select_281"></a>2.2.2、core_sys_select</h6> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/fs/select.c#L625">core_sys_select</a>函数主要工作时申请内存，将数据从用户空间copy到内核空间，处理后再从内核空间copy到用户空间。</p> 
<pre><code class="prism language-c"><span class="token comment">//注意，省略了一些代码，最好直接看源码</span>
<span class="token keyword">int</span> <span class="token function">core_sys_select</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">,</span> fd_set __user <span class="token operator">*</span>inp<span class="token punctuation">,</span> fd_set __user <span class="token operator">*</span>outp<span class="token punctuation">,</span> fd_set __user <span class="token operator">*</span>exp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timespec64</span> <span class="token operator">*</span>end_time<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//栈上分配一段内存</span>
	<span class="token keyword">long</span> stack_fds<span class="token punctuation">[</span>SELECT_STACK_ALLOC<span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">//n个socket描述符需要多少字节</span>
	size <span class="token operator">=</span> <span class="token function">FDS_BYTES</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
	bits <span class="token operator">=</span> stack_fds<span class="token punctuation">;</span>
	<span class="token comment">/* 
   * 如果栈上的内存太小，那么就重新分配内存
   * 为什么是除以6呢？
   * 因为每个文件描述符要占6个bit（输入：可读，可写，异常；输出结果：可读，可写，异常）
   */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stack_fds<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">6</span><span class="token punctuation">)</span>
        bits <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> size<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//设置好bitmap对应的内存空间</span>
	fds<span class="token punctuation">.</span>in      <span class="token operator">=</span> bits<span class="token punctuation">;</span><span class="token comment">//可读</span>
	fds<span class="token punctuation">.</span>out     <span class="token operator">=</span> bits <span class="token operator">+</span>   size<span class="token punctuation">;</span><span class="token comment">//可写</span>
	fds<span class="token punctuation">.</span>ex      <span class="token operator">=</span> bits <span class="token operator">+</span> <span class="token number">2</span><span class="token operator">*</span>size<span class="token punctuation">;</span><span class="token comment">//异常</span>
	fds<span class="token punctuation">.</span>res_in  <span class="token operator">=</span> bits <span class="token operator">+</span> <span class="token number">3</span><span class="token operator">*</span>size<span class="token punctuation">;</span><span class="token comment">//用于返回可读结果</span>
	fds<span class="token punctuation">.</span>res_out <span class="token operator">=</span> bits <span class="token operator">+</span> <span class="token number">4</span><span class="token operator">*</span>size<span class="token punctuation">;</span><span class="token comment">//用于返回可写结果</span>
	fds<span class="token punctuation">.</span>res_ex  <span class="token operator">=</span> bits <span class="token operator">+</span> <span class="token number">5</span><span class="token operator">*</span>size<span class="token punctuation">;</span><span class="token comment">//用于返回异常结果</span>
  <span class="token comment">//将应用层的监听集合拷贝到内核空间</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">get_fd_set</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> inp<span class="token punctuation">,</span> fds<span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
	    <span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">get_fd_set</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> outp<span class="token punctuation">,</span> fds<span class="token punctuation">.</span>out<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
	    <span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">get_fd_set</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> fds<span class="token punctuation">.</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token comment">//清空三个输出结果的集合</span>
	<span class="token function">zero_fd_set</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> fds<span class="token punctuation">.</span>res_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">zero_fd_set</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> fds<span class="token punctuation">.</span>res_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">zero_fd_set</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> fds<span class="token punctuation">.</span>res_ex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">do_select</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fds<span class="token punctuation">,</span> end_time<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//阻塞，直至有I/O事件或超时</span>
  <span class="token comment">//将结果拷贝回用户空间，这里会修改用户select API参数，所以在2.1小节demo中需会有【tempfds = readfds;】</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">set_fd_set</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> inp<span class="token punctuation">,</span> fds<span class="token punctuation">.</span>res_in<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">set_fd_set</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> outp<span class="token punctuation">,</span> fds<span class="token punctuation">.</span>res_out<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">set_fd_set</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> fds<span class="token punctuation">.</span>res_ex<span class="token punctuation">)</span><span class="token punctuation">)</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="223do_select_322"></a>2.2.3、do_select</h6> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/fs/select.c#L479">do_select</a>函数用于阻塞进程，此时进程进入<code>TASK_INTERRUPTIBLE</code>状态，直至I/O事件就绪或超时，唤醒进程，进入<code>TASK_RUNNING</code>状态。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">init_poll_funcptr</span><span class="token punctuation">(</span>poll_table <span class="token operator">*</span>pt<span class="token punctuation">,</span> poll_queue_proc qproc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	pt<span class="token operator">-&gt;</span>_qproc <span class="token operator">=</span> qproc<span class="token punctuation">;</span>
	pt<span class="token operator">-&gt;</span>_key   <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>__poll_t<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* all events enabled */</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">poll_initwait</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">poll_wqueues</span> <span class="token operator">*</span>pwq<span class="token punctuation">)</span><span class="token comment">//初始化</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">init_poll_funcptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pwq<span class="token operator">-&gt;</span>pt<span class="token punctuation">,</span> __pollwait<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pwq<span class="token operator">-&gt;</span>polling_task <span class="token operator">=</span> current<span class="token punctuation">;</span> <span class="token comment">//设置当前PCB</span>
	pwq<span class="token operator">-&gt;</span>triggered <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	pwq<span class="token operator">-&gt;</span>error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	pwq<span class="token operator">-&gt;</span>table <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	pwq<span class="token operator">-&gt;</span>inline_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">do_select</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">,</span> fd_set_bits <span class="token operator">*</span>fds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timespec64</span> <span class="token operator">*</span>end_time<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">ktime_t</span> expire<span class="token punctuation">,</span> <span class="token operator">*</span>to <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">poll_wqueues</span> table<span class="token punctuation">;</span>
	poll_table <span class="token operator">*</span>wait<span class="token punctuation">;</span>
	<span class="token keyword">int</span> retval<span class="token punctuation">,</span> i<span class="token punctuation">,</span> timed_out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	u64 slack <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	__poll_t busy_flag <span class="token operator">=</span> <span class="token function">net_busy_loop_on</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> POLL_BUSY_LOOP <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//检查下网络是否繁忙</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> busy_start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	retval <span class="token operator">=</span> <span class="token function">max_select_fd</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> fds<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//确定下当前最大的socket描述符</span>
	<span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> retval<span class="token punctuation">;</span>
	n <span class="token operator">=</span> retval<span class="token punctuation">;</span>

	<span class="token function">poll_initwait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化poll_wqueues，辅助select/poll做syscall的，注意这里面table.pt-&gt;_qproc会被设置为__pollwait函数</span>
	wait <span class="token operator">=</span> <span class="token operator">&amp;</span>table<span class="token punctuation">.</span>pt<span class="token punctuation">;</span>
	<span class="token comment">//需要注意end_time==NULL和end_time!=NULL &amp;&amp; end_time-&gt;tv_sec==0 &amp;&amp; end_time-&gt;tv_nsec==0的区别</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>end_time <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>end_time<span class="token operator">-&gt;</span>tv_sec <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>end_time<span class="token operator">-&gt;</span>tv_nsec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	  <span class="token comment">//end_time!=NULL &amp;&amp; end_time-&gt;tv_sec==0 &amp;&amp; end_time-&gt;tv_nsec==0情况下</span>
		wait<span class="token operator">-&gt;</span>_qproc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">//将wait-&gt;_qproc设置NULL,这样下面vfs_poll时，就不会调用__pollwait，进而将当前进程设置到socket等待队列中，</span>
		<span class="token comment">//也就是说这种情况下没有I/O事件就绪通知了</span>
		timed_out <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//直接这只超时标志位1，这样最外层的死循环只循环一次就结束了</span>
	<span class="token punctuation">}</span>
  <span class="token comment">//如果end_time==NULL，最外层的死循环会一直进行，这样超过CPU时间片当前进程就会被挂起，稍后再被schedule继续死循环，直至收到I/O事件就绪或收到信号才会退出循环。</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>end_time <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>timed_out<span class="token punctuation">)</span>
		slack <span class="token operator">=</span> <span class="token function">select_estimate_accuracy</span><span class="token punctuation">(</span>end_time<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//估计一个松弛量</span>

	retval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>rinp<span class="token punctuation">,</span> <span class="token operator">*</span>routp<span class="token punctuation">,</span> <span class="token operator">*</span>rexp<span class="token punctuation">,</span> <span class="token operator">*</span>inp<span class="token punctuation">,</span> <span class="token operator">*</span>outp<span class="token punctuation">,</span> <span class="token operator">*</span>exp<span class="token punctuation">;</span>
		bool can_busy_loop <span class="token operator">=</span> false<span class="token punctuation">;</span>

		inp <span class="token operator">=</span> fds<span class="token operator">-&gt;</span>in<span class="token punctuation">;</span> outp <span class="token operator">=</span> fds<span class="token operator">-&gt;</span>out<span class="token punctuation">;</span> exp <span class="token operator">=</span> fds<span class="token operator">-&gt;</span>ex<span class="token punctuation">;</span>
		rinp <span class="token operator">=</span> fds<span class="token operator">-&gt;</span>res_in<span class="token punctuation">;</span> routp <span class="token operator">=</span> fds<span class="token operator">-&gt;</span>res_out<span class="token punctuation">;</span> rexp <span class="token operator">=</span> fds<span class="token operator">-&gt;</span>res_ex<span class="token punctuation">;</span>

		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>rinp<span class="token punctuation">,</span> <span class="token operator">++</span>routp<span class="token punctuation">,</span> <span class="token operator">++</span>rexp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">unsigned</span> <span class="token keyword">long</span> in<span class="token punctuation">,</span> out<span class="token punctuation">,</span> ex<span class="token punctuation">,</span> all_bits<span class="token punctuation">,</span> bit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">;</span>
			<span class="token keyword">unsigned</span> <span class="token keyword">long</span> res_in <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> res_out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> res_ex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			__poll_t mask<span class="token punctuation">;</span>

			in <span class="token operator">=</span> <span class="token operator">*</span>inp<span class="token operator">++</span><span class="token punctuation">;</span> out <span class="token operator">=</span> <span class="token operator">*</span>outp<span class="token operator">++</span><span class="token punctuation">;</span> ex <span class="token operator">=</span> <span class="token operator">*</span>exp<span class="token operator">++</span><span class="token punctuation">;</span>
			all_bits <span class="token operator">=</span> in <span class="token operator">|</span> out <span class="token operator">|</span> ex<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>all_bits <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				i <span class="token operator">+=</span> BITS_PER_LONG<span class="token punctuation">;</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> BITS_PER_LONG<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">,</span> <span class="token operator">++</span>i<span class="token punctuation">,</span> bit <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">struct</span> <span class="token class-name">fd</span> f<span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> n<span class="token punctuation">)</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>bit <span class="token operator">&amp;</span> all_bits<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>
				mask <span class="token operator">=</span> EPOLLNVAL<span class="token punctuation">;</span>
				f <span class="token operator">=</span> <span class="token function">fdget</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">wait_key_set</span><span class="token punctuation">(</span>wait<span class="token punctuation">,</span> in<span class="token punctuation">,</span> out<span class="token punctuation">,</span> bit<span class="token punctuation">,</span>
						     busy_flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
					mask <span class="token operator">=</span> <span class="token function">vfs_poll</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>file<span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用每一个文件描述符对应驱动的poll函数，得到一个掩码</span>

					<span class="token function">fdput</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mask <span class="token operator">&amp;</span> POLLIN_SET<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>in <span class="token operator">&amp;</span> bit<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//根据掩码设置可读集合中socket描述符对应位</span>
					res_in <span class="token operator">|=</span> bit<span class="token punctuation">;</span>
					retval<span class="token operator">++</span><span class="token punctuation">;</span>
					wait<span class="token operator">-&gt;</span>_qproc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mask <span class="token operator">&amp;</span> POLLOUT_SET<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>out <span class="token operator">&amp;</span> bit<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//根据掩码设置可写集合中socket描述符对应位</span>
					res_out <span class="token operator">|=</span> bit<span class="token punctuation">;</span>
					retval<span class="token operator">++</span><span class="token punctuation">;</span>
					wait<span class="token operator">-&gt;</span>_qproc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mask <span class="token operator">&amp;</span> POLLEX_SET<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ex <span class="token operator">&amp;</span> bit<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//根据掩码设置异常集合中socket描述符对应位</span>
					res_ex <span class="token operator">|=</span> bit<span class="token punctuation">;</span>
					retval<span class="token operator">++</span><span class="token punctuation">;</span>
					wait<span class="token operator">-&gt;</span>_qproc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">/* got something, stop busy polling */</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					can_busy_loop <span class="token operator">=</span> false<span class="token punctuation">;</span>
					busy_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>busy_flag <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span>
					can_busy_loop <span class="token operator">=</span> true<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>res_in<span class="token punctuation">)</span>
				<span class="token operator">*</span>rinp <span class="token operator">=</span> res_in<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>res_out<span class="token punctuation">)</span>
				<span class="token operator">*</span>routp <span class="token operator">=</span> res_out<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>res_ex<span class="token punctuation">)</span>
				<span class="token operator">*</span>rexp <span class="token operator">=</span> res_ex<span class="token punctuation">;</span>
			<span class="token function">cond_resched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		wait<span class="token operator">-&gt;</span>_qproc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">||</span> timed_out <span class="token operator">||</span> <span class="token function">signal_pending</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//有I/O事件就绪、超时、收到信号就退出死循环</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> 
		<span class="token keyword">if</span> <span class="token punctuation">(</span>table<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			retval <span class="token operator">=</span> table<span class="token punctuation">.</span>error<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">/* only if found POLL_BUSY_LOOP sockets &amp;&amp; not out of time */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>can_busy_loop <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">need_resched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>busy_start<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				busy_start <span class="token operator">=</span> <span class="token function">busy_loop_current_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">busy_loop_timeout</span><span class="token punctuation">(</span>busy_start<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		busy_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>end_time <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>to<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			expire <span class="token operator">=</span> <span class="token function">timespec64_to_ktime</span><span class="token punctuation">(</span><span class="token operator">*</span>end_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
			to <span class="token operator">=</span> <span class="token operator">&amp;</span>expire<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
     <span class="token comment">//定时器，设置select超时时间，注意这里是允许进程被socket I/O事件就绪提前唤醒的</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">poll_schedule_timeout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>table<span class="token punctuation">,</span> TASK_INTERRUPTIBLE<span class="token punctuation">,</span>to<span class="token punctuation">,</span> slack<span class="token punctuation">)</span><span class="token punctuation">)</span>
			timed_out <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">poll_freewait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将当前进程从readfds、writefds、exceptfds这三个集合中socket的等待队列中移，轮询</span>
	<span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过源码可知，对于最外围的死循环：</p> 
<blockquote> 
 <p>如果进入<code>do_select函数</code>时恰好有I/O就绪事件，那么循环一次就结束了；<br> 否则通过poll_schedule_timeout挂起进程，等待超时或I/O事件就绪通知，那么尽行第二次循环后结束；<br> 但是如果参数end_time==NULL，此时poll_schedule_timeout函数直接返回非0值，不会挂起进程，那么就会一直循环，当前进程运行超过 CPU时间片会被挂起，稍后再被schedule继续死循环，直至收到I/O事件就绪通知或收到信号才会退出循环。</p> 
</blockquote> 
<p><code>poll_schedule_timeout函数详情见第五章。</code></p> 
<h3><a id="IO_472"></a>三、I/O事件就绪通知源码解析</h3> 
<p>在<code>2.2小节</code>，我们知道select会通过<code>vfs_poll(f.file, wait)</code>获取一个掩码来确定该socket是否有就绪的I/O事件，那么这个函数做了什么呢？</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> __poll_t <span class="token function">vfs_poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">poll_table_struct</span> <span class="token operator">*</span>pt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token operator">-&gt;</span>f_op<span class="token operator">-&gt;</span>poll<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//该文件描述符驱动不支持poll函数，直接返回默认值</span>
		<span class="token keyword">return</span> DEFAULT_POLLMASK<span class="token punctuation">;</span>
	<span class="token keyword">return</span> file<span class="token operator">-&gt;</span>f_op<span class="token operator">-&gt;</span><span class="token function">poll</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到直接调用socket文件描述符对应驱动的poll函数，那poll函数是哪里来的的，这就要回到socket创建函数<code>socket()</code>了。</p> 
<pre><code class="prism language-c"><span class="token comment">/* family：被称为协议族。
 * type：套接字类型。
 * protocol：某个协议的类型常值，可以设置为 0。
 * return：返回整型的文件描述符，如果返回 -1 就失败。
 */</span>
<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span>
<span class="token comment">//例如 int socket_fd = socket(AF_INET, SOCK_STREAM, 0);创建一个TCP的socket</span>
</code></pre> 
<p>我们通过Glibc库的socket创建socket描述符时，其本质调用Linux内核的<a href="https://github.com/torvalds/linux/blob/v6.7/net/socket.c#L1701">__sys_socket函数</a>。</p> 
<p>根据源码可知其调用链如下图：<br> <img src="https://images2.imgbox.com/02/65/PIdWNJVL_o.png" alt="Linux socket内核源码调用链"></p> 
<h5><a id="31_499"></a>3.1、相关结构体</h5> 
<p>先熟悉下若干结构体。</p> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/include/linux/fs.h#L992">linux文件结构体</a></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    <span class="token keyword">struct</span> <span class="token class-name">path</span>                     f_path<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">inode</span>                    <span class="token operator">*</span>f_inode<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span>    <span class="token operator">*</span>f_op<span class="token punctuation">;</span> <span class="token comment">//本文需特别关注这个,即文件支持的操作，如open,read等等</span>

    <span class="token class-name">atomic_long_t</span>                    f_count<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                     f_flags<span class="token punctuation">;</span>
    <span class="token class-name">fmode_t</span>                          f_mode<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">mutex</span>                     f_pos_lock<span class="token punctuation">;</span>
    <span class="token class-name">loff_t</span>                           f_pos<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">fown_struct</span>               f_owner<span class="token punctuation">;</span>
    <span class="token comment">// ...省略</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/include/linux/fs.h#L1916">linux文件操作结构体</a></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>
	<span class="token class-name">loff_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>llseek<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_iter<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kiocb</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">iov_iter</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write_iter<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kiocb</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">iov_iter</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>iopoll<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kiocb</span> <span class="token operator">*</span>kiocb<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">io_comp_batch</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>iterate_shared<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dir_context</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__poll_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>poll<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">poll_table_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//本文要特别关注这个，这就是文件对应的poll函数</span>
	<span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>unlocked_ioctl<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>compat_ioctl<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>mmap<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> mmap_supported_flags<span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>flush<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">fl_owner_t</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ...省略</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/net/socket.c#L154">linux scoket对应的文件操作结构体实例</a></p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> socket_file_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>owner <span class="token operator">=</span>	THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>llseek <span class="token operator">=</span>	no_llseek<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read_iter <span class="token operator">=</span>	sock_read_iter<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write_iter <span class="token operator">=</span>	sock_write_iter<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>poll <span class="token operator">=</span>		sock_poll<span class="token punctuation">,</span> <span class="token comment">//本文要特别关注这个，这就是socket对应的poll函数，在2.2.2小节源码中file-&gt;f_op-&gt;poll(file, pt)执行的真正函数</span>
	<span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> sock_ioctl<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_COMPAT</span></span>
	<span class="token punctuation">.</span>compat_ioctl <span class="token operator">=</span> compat_sock_ioctl<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token punctuation">.</span>uring_cmd <span class="token operator">=</span>    io_uring_cmd_sock<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>mmap <span class="token operator">=</span>		sock_mmap<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span>	sock_close<span class="token punctuation">,</span>
	<span class="token comment">// ...省略</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><a href="https://github.com/torvalds/linux/blob/master/include/linux/net.h#L117">Linux socket结构体</a></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">socket</span> <span class="token punctuation">{<!-- --></span>
	socket_state		state<span class="token punctuation">;</span>
	<span class="token keyword">short</span>			type<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span>		flags<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">file</span>		<span class="token operator">*</span>file<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">sock</span>		<span class="token operator">*</span>sk<span class="token punctuation">;</span>  
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">proto_ops</span>	<span class="token operator">*</span>ops<span class="token punctuation">;</span> <span class="token comment">//本文需要特别关注这个，用于与上层协议TCP or UDP沟通的一个桥梁</span>
	<span class="token keyword">struct</span> <span class="token class-name">socket_wq</span>	wq<span class="token punctuation">;</span> <span class="token comment">//等待该socket的进程队列和异步通知队列，即同一个socket可能有多个进程都在等待使用</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">socket_wq</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* Note: wait MUST be first field of socket_wq */</span>
	<span class="token class-name">wait_queue_head_t</span>	wait<span class="token punctuation">;</span> <span class="token comment">//真正起作用的等待队列，Linux等待队列</span>
	<span class="token keyword">struct</span> <span class="token class-name">fasync_struct</span>	<span class="token operator">*</span>fasync_list<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span>		flags<span class="token punctuation">;</span> <span class="token comment">/* %SOCKWQ_ASYNC_NOSPACE, etc */</span>
	<span class="token keyword">struct</span> <span class="token class-name">rcu_head</span>		rcu<span class="token punctuation">;</span>
<span class="token punctuation">}</span> ____cacheline_aligned_in_smp<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="32tcpsocket_580"></a>3.2、tcp与socket关联源码分析</h5> 
<p>从前文我们知道了<code>sock_poll</code>函数就是2.2.2小节源码中file-&gt;f_op-&gt;poll(file, pt)执行的真正函数，我们先看下该函数干了什么。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> __poll_t <span class="token function">sock_poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>wait<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">socket</span> <span class="token operator">*</span>sock <span class="token operator">=</span> file<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">proto_ops</span> <span class="token operator">*</span>ops <span class="token operator">=</span> <span class="token function">READ_ONCE</span><span class="token punctuation">(</span>sock<span class="token operator">-&gt;</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	__poll_t events <span class="token operator">=</span> <span class="token function">poll_requested_events</span><span class="token punctuation">(</span>wait<span class="token punctuation">)</span><span class="token punctuation">,</span> flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ops<span class="token operator">-&gt;</span>poll<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token comment">// ...省略</span>
	<span class="token keyword">return</span> ops<span class="token operator">-&gt;</span><span class="token function">poll</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> wait<span class="token punctuation">)</span> <span class="token operator">|</span> flag<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这又来一个ops-&gt;poll,只不过是socket结构体下的poll，它是从哪里来的呢？在本章节开始就介绍了socket函数内核调用链的流程图，在<code>__sock_create</code>函数中有这样的逻辑：</p> 
<pre><code class="prism language-c">pf <span class="token operator">=</span> <span class="token function">rcu_dereference</span><span class="token punctuation">(</span>net_families<span class="token punctuation">[</span>family<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">//选择给定的协议族</span>
err <span class="token operator">=</span> pf<span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> kern<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">goto</span> out_module_put<span class="token punctuation">;</span>
</code></pre> 
<p>没错，突破点就在协议簇上，在socket编程中只能是AF_INET协议族，其初始化函数是<a href="https://github.com/torvalds/linux/blob/v6.7/net/ipv4/af_inet.c#L1949">inet_init</a>，其<a href="https://blog.csdn.net/m0_50662680/article/details/128390721">Linux内核加载原理请看本文</a>。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">net_proto_family</span> inet_family_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//定义AF_INET协议族初始化</span>
	<span class="token punctuation">.</span>family <span class="token operator">=</span> PF_INET<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>create <span class="token operator">=</span> inet_create<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>owner	<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">inet_protosw</span> inetsw_array<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token comment">//定义AF_INET有哪些协议族</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>type <span class="token operator">=</span>       SOCK_STREAM<span class="token punctuation">,</span> <span class="token comment">//tcp</span>
		<span class="token punctuation">.</span>protocol <span class="token operator">=</span>   IPPROTO_TCP<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>prot <span class="token operator">=</span>       <span class="token operator">&amp;</span>tcp_prot<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>ops <span class="token operator">=</span>        <span class="token operator">&amp;</span>inet_stream_ops<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>flags <span class="token operator">=</span>      INET_PROTOSW_PERMANENT <span class="token operator">|</span> INET_PROTOSW_ICSK<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>type <span class="token operator">=</span>       SOCK_DGRAM<span class="token punctuation">,</span> <span class="token comment">//udp</span>
		<span class="token punctuation">.</span>protocol <span class="token operator">=</span>   IPPROTO_UDP<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>prot <span class="token operator">=</span>       <span class="token operator">&amp;</span>udp_prot<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>ops <span class="token operator">=</span>        <span class="token operator">&amp;</span>inet_dgram_ops<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>flags <span class="token operator">=</span>      INET_PROTOSW_PERMANENT<span class="token punctuation">,</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...省略</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">list_head</span> inetsw<span class="token punctuation">[</span>SOCK_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">inet_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token comment">// ...省略</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span>q <span class="token operator">=</span> inetsw_array<span class="token punctuation">;</span> q <span class="token operator">&lt;</span> <span class="token operator">&amp;</span>inetsw_array<span class="token punctuation">[</span>INETSW_ARRAY_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>q<span class="token punctuation">)</span> <span class="token comment">//注册tcp,udp等协议栈</span>
		<span class="token function">inet_register_protosw</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将tcp,udp等协议栈注册到全局变量inetsw中</span>
   <span class="token comment">// ...省略</span>
	<span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">sock_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inet_family_ops<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注册</span>
	<span class="token comment">// ...省略</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到通过<code>sock_register</code>函数注册了<code>inet_family_ops</code>,该函数会将<code>inet_family_ops</code>设置到全局变量<code>net_families</code>中，需要注意<a href="https://github.com/torvalds/linux/blob/v6.7/include/linux/socket.h#L249">PF_INET与AF_INET关系</a></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PF_INET</span>		<span class="token expression">AF_INET</span></span>
</code></pre> 
<p>看到这里就可以知道<code>pf-&gt;create</code>函数实际就是<a href="https://github.com/torvalds/linux/blob/v6.7/net/ipv4/af_inet.c#L251">inet_create</a>函数了。</p> 
<pre><code class="prism language-c"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">proto_ops</span> inet_stream_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//tcp相关操作</span>
	<span class="token punctuation">.</span>family		   <span class="token operator">=</span> PF_INET<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>owner		   <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release	   <span class="token operator">=</span> inet_release<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>bind		   <span class="token operator">=</span> inet_bind<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>connect	   <span class="token operator">=</span> inet_stream_connect<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>socketpair	   <span class="token operator">=</span> sock_no_socketpair<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>accept		   <span class="token operator">=</span> inet_accept<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>getname	   <span class="token operator">=</span> inet_getname<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>poll		   <span class="token operator">=</span> tcp_poll<span class="token punctuation">,</span> <span class="token comment">//本文需要关注</span>
	<span class="token punctuation">.</span>ioctl		   <span class="token operator">=</span> inet_ioctl<span class="token punctuation">,</span>
	<span class="token comment">// ...省略 </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//只列出了需要关注的代码</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">inet_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net</span> <span class="token operator">*</span>net<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">socket</span> <span class="token operator">*</span>sock<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">,</span><span class="token keyword">int</span> kern<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">inet_protosw</span> <span class="token operator">*</span>answer<span class="token punctuation">;</span>
  <span class="token comment">// ...省略 </span>
	<span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//我们socket函数第二个参数是SOCK_STREAM，那answer就是inetsw_array的第一个元素</span>
	<span class="token function">list_for_each_entry_rcu</span><span class="token punctuation">(</span>answer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inetsw<span class="token punctuation">[</span>sock<span class="token operator">-&gt;</span>type<span class="token punctuation">]</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">// ...省略</span>
	<span class="token punctuation">}</span>
	sock<span class="token operator">-&gt;</span>ops <span class="token operator">=</span> answer<span class="token operator">-&gt;</span>ops<span class="token punctuation">;</span><span class="token comment">//所以sock-&gt;ops被赋值为inet_stream_ops</span>
  <span class="token comment">// ...省略 </span>
	sk <span class="token operator">=</span> <span class="token function">sk_alloc</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> PF_INET<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">,</span> answer_prot<span class="token punctuation">,</span> kern<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化sock实例</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sk<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
   <span class="token comment">// ...省略</span>
	<span class="token function">sock_init_data</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> sk<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置sock实例，并与socket关联</span>
   <span class="token comment">// ...省略</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>到这里可以知道本节开头<code>sock_poll</code>函数中的<code>ops-&gt;poll</code>在tcp类型 的scoket下就是<a href="https://github.com/torvalds/linux/blob/v6.7/net/ipv4/tcp.c#L497">tcp_poll</a>函数。</p> 
<pre><code class="prism language-c">__poll_t <span class="token function">tcp_poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">socket</span> <span class="token operator">*</span>sock<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>wait<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...省略</span>
   <span class="token function">sock_poll_wait</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// ...省略</span>
   mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   shutdown <span class="token operator">=</span> <span class="token function">READ_ONCE</span><span class="token punctuation">(</span>sk<span class="token operator">-&gt;</span>sk_shutdown<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">if</span> <span class="token punctuation">(</span>shutdown <span class="token operator">==</span> SHUTDOWN_MASK <span class="token operator">||</span> state <span class="token operator">==</span> TCP_CLOSE<span class="token punctuation">)</span>
		 mask <span class="token operator">|=</span> EPOLLHUP<span class="token punctuation">;</span>
	 <span class="token keyword">if</span> <span class="token punctuation">(</span>shutdown <span class="token operator">&amp;</span> RCV_SHUTDOWN<span class="token punctuation">)</span>
		 mask <span class="token operator">|=</span> EPOLLIN <span class="token operator">|</span> EPOLLRDNORM <span class="token operator">|</span> EPOLLRDHUP<span class="token punctuation">;</span>
   <span class="token comment">// ...省略</span>
   <span class="token keyword">return</span> mask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">sock_poll_wait</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">socket</span> <span class="token operator">*</span>sock<span class="token punctuation">,</span>
				  poll_table <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">poll_does_not_wait</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">poll_wait</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sock<span class="token operator">-&gt;</span>wq<span class="token punctuation">.</span>wait<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">smp_mb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/include/linux/poll.h#L46">poll_wait函数</a></p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">poll_wait</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> filp<span class="token punctuation">,</span> <span class="token class-name">wait_queue_head_t</span> <span class="token operator">*</span> wait_address<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">&amp;&amp;</span> p<span class="token operator">-&gt;</span>_qproc <span class="token operator">&amp;&amp;</span> wait_address<span class="token punctuation">)</span>
		p<span class="token operator">-&gt;</span><span class="token function">_qproc</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> wait_address<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到<code>poll_wait</code>又调了<code>p-&gt;_qproc</code>，其本质就是<code>2.2.3小节 poll_initwait</code>函数会将p-&gt;_qproc设置为<a href="https://github.com/torvalds/linux/blob/v6.7/fs/select.c#L222">__pollwait</a>函数。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">init_waitqueue_func_entry</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">wait_queue_entry</span> <span class="token operator">*</span>wq_entry<span class="token punctuation">,</span> <span class="token class-name">wait_queue_func_t</span> func<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	wq_entry<span class="token operator">-&gt;</span>flags		<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	wq_entry<span class="token operator">-&gt;</span>private	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	wq_entry<span class="token operator">-&gt;</span>func		<span class="token operator">=</span> func<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__pollwait</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token class-name">wait_queue_head_t</span> <span class="token operator">*</span>wait_address<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token keyword">struct</span> <span class="token class-name">poll_wqueues</span> <span class="token operator">*</span>pwq <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">poll_wqueues</span><span class="token punctuation">,</span> pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">struct</span> <span class="token class-name">poll_table_entry</span> <span class="token operator">*</span>entry <span class="token operator">=</span> <span class="token function">poll_get_entry</span><span class="token punctuation">(</span>pwq<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">)</span>
		 <span class="token keyword">return</span><span class="token punctuation">;</span>
	 entry<span class="token operator">-&gt;</span>filp <span class="token operator">=</span> <span class="token function">get_file</span><span class="token punctuation">(</span>filp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 entry<span class="token operator">-&gt;</span>wait_address <span class="token operator">=</span> wait_address<span class="token punctuation">;</span>
	 entry<span class="token operator">-&gt;</span>key <span class="token operator">=</span> p<span class="token operator">-&gt;</span>_key<span class="token punctuation">;</span> <span class="token comment">//这里会把poll_table中的key同步到poll_table_entry中</span>
	 <span class="token function">init_waitqueue_func_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>entry<span class="token operator">-&gt;</span>wait<span class="token punctuation">,</span> pollwake<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 entry<span class="token operator">-&gt;</span>wait<span class="token punctuation">.</span>private <span class="token operator">=</span> pwq<span class="token punctuation">;</span> <span class="token comment">//将ppwq设置到等待队列中，注意pwq中有PCB,这时后面进行进程唤醒的关键</span>
	 <span class="token function">add_wait_queue</span><span class="token punctuation">(</span>wait_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>entry<span class="token operator">-&gt;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//加入socket的等待队列中</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意其中的<code>entry-&gt;wait</code>是<a href="https://github.com/torvalds/linux/blob/v6.7/include/linux/wait.h#L29">wait_queue_entry 结构体</a>，<code>init_waitqueue_func_entry</code>函数会将wait_queue_entry.func设置为<a href="https://github.com/torvalds/linux/blob/v6.7/fs/select.c#L222">pollwake</a>函数。</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">wait_queue_entry</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		flags<span class="token punctuation">;</span>
	<span class="token keyword">void</span>			<span class="token operator">*</span>private<span class="token punctuation">;</span>
	<span class="token class-name">wait_queue_func_t</span>	func<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	entry<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>探索到这里也就知道了I/O事件就绪时的进程唤醒函数是pollwake函数，那谁去调用pollwake呢？</p> 
<p>再看下如何加入到socket的等待队列中：<br> <a href="https://github.com/torvalds/linux/blob/v6.7/kernel/sched/wait.c#L17">add_wait_queue</a>。<br> 这个了解下<a href="https://www.cnblogs.com/hueyxu/p/13745029.html" rel="nofollow">Linux等待队列构造就可以理解了</a>。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">add_wait_queue</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">wait_queue_head</span> <span class="token operator">*</span>wq_head<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">wait_queue_entry</span> <span class="token operator">*</span>wq_entry<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>

	wq_entry<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>WQ_FLAG_EXCLUSIVE<span class="token punctuation">;</span>
	<span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__add_wait_queue</span><span class="token punctuation">(</span>wq_head<span class="token punctuation">,</span> wq_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">__add_wait_queue</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">wait_queue_head</span> <span class="token operator">*</span>wq_head<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">wait_queue_entry</span> <span class="token operator">*</span>wq_entry<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>head <span class="token operator">=</span> <span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>head<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">wait_queue_entry</span> <span class="token operator">*</span>wq<span class="token punctuation">;</span>

	<span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>wq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>head<span class="token punctuation">,</span> entry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>wq<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> WQ_FLAG_PRIORITY<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		head <span class="token operator">=</span> <span class="token operator">&amp;</span>wq<span class="token operator">-&gt;</span>entry<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_entry<span class="token operator">-&gt;</span>entry<span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>socket_post_create</p> 
<h5><a id="33TCP_778"></a>3.3、TCP收到数据时回调唤醒进程</h5> 
<p>在上一小节我们源码分析到了<code>I/O事件就绪时的进程唤醒函数是pollwake函数</code>，谁去调用还是两眼一抹黑。<br> 小伙伴可以回看下<code>1.1小节Linux下OSI五层模型收到数据后的处理过程</code>，其中有提到经过网卡中断和层层回调上报，到达传输层的TCP时会走<a href="https://github.com/torvalds/linux/blob/v6.7/net/ipv4/tcp_ipv4.c#L2161">tcp_v4_rcv 函数</a>。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">tcp_v4_rcv</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token comment">// ...省略</span>
   <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">;</span>
lookup<span class="token operator">:</span>
  <span class="token comment">//查找报文所属的套接口</span>
	sk <span class="token operator">=</span> <span class="token function">__inet_lookup_skb</span><span class="token punctuation">(</span>net<span class="token operator">-&gt;</span>ipv4<span class="token punctuation">.</span>tcp_death_row<span class="token punctuation">.</span>hashinfo<span class="token punctuation">,</span>skb<span class="token punctuation">,</span> 
	         <span class="token function">__tcp_hdrlen</span><span class="token punctuation">(</span>th<span class="token punctuation">)</span><span class="token punctuation">,</span> th<span class="token operator">-&gt;</span>source<span class="token punctuation">,</span>th<span class="token operator">-&gt;</span>dest<span class="token punctuation">,</span> sdif<span class="token punctuation">,</span> <span class="token operator">&amp;</span>refcounted<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token comment">// ...省略		       </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sk<span class="token operator">-&gt;</span>sk_state <span class="token operator">==</span> TCP_LISTEN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token function">tcp_v4_do_rcv</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> skb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//继续上报</span>
		<span class="token keyword">goto</span> put_and_return<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// ...省略</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">tcp_v4_do_rcv</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token comment">// ...省略</span>
   <span class="token function">tcp_rcv_established</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> skb<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//继续上报</span>
   <span class="token comment">// ...省略</span>
<span class="token punctuation">}</span>
<span class="token comment">// Fast processing is turned on in tcp_data_queue when everything is OK.</span>
<span class="token keyword">void</span> <span class="token function">tcp_rcv_established</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">// ...省略</span>
  reason <span class="token operator">=</span> <span class="token function">tcp_ack</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> skb<span class="token punctuation">,</span> FLAG_SLOWPATH <span class="token operator">|</span> FLAG_UPDATE_TS_RECENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>reason <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		reason <span class="token operator">=</span> <span class="token operator">-</span>reason<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> discard<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">tcp_rcv_rtt_measure_ts</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* Process urgent data. */</span>
	<span class="token function">tcp_urg</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> skb<span class="token punctuation">,</span> th<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* step 7: process the segment text */</span>
	<span class="token function">tcp_data_queue</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> skb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//继续上报</span>
	<span class="token comment">// ...省略</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">tcp_data_ready</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tcp_epollin_ready</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> sk<span class="token operator">-&gt;</span>sk_rcvlowat<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">sock_flag</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> SOCK_DONE<span class="token punctuation">)</span><span class="token punctuation">)</span>
		sk<span class="token operator">-&gt;</span><span class="token function">sk_data_ready</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//唤醒进程</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">tcp_data_queue</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">tcp_sock</span> <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">tcp_sk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ...省略</span>
queue_and_out<span class="token operator">:</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tcp_try_rmem_schedule</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> skb<span class="token punctuation">,</span> skb<span class="token operator">-&gt;</span>truesize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">/* TODO: maybe ratelimit these WIN 0 ACK ? */</span>
			<span class="token function">inet_csk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token operator">-&gt;</span>icsk_ack<span class="token punctuation">.</span>pending <span class="token operator">|=</span>
					<span class="token punctuation">(</span>ICSK_ACK_NOMEM <span class="token operator">|</span> ICSK_ACK_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">inet_csk_schedule_ack</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
			sk<span class="token operator">-&gt;</span><span class="token function">sk_data_ready</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//唤醒进程</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">skb_queue_len</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sk<span class="token operator">-&gt;</span>sk_receive_queue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				reason <span class="token operator">=</span> SKB_DROP_REASON_PROTO_MEM<span class="token punctuation">;</span>
				<span class="token function">NET_INC_STATS</span><span class="token punctuation">(</span><span class="token function">sock_net</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">,</span> LINUX_MIB_TCPRCVQDROP<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">goto</span> drop<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">sk_forced_mem_schedule</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> skb<span class="token operator">-&gt;</span>truesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// ...省略</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">sock_flag</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> SOCK_DEAD<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token function">tcp_data_ready</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//继续上报</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// ...省略</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们追踪源码可以看到最后调用<code>sk-&gt;sk_data_ready</code>来唤醒进行，那一起看下<code>struct sock</code>结构体内容：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// ...省略</span>
	<span class="token comment">/*
	 * The backlog queue is special, it is always used with
	 * the per-socket spinlock held and requires low latency  access. Therefore we special case it's implementation.
	 * Note : rmem_alloc is in this structure to fill a hole on 64bit arches, not because its logically part of backlog.
	 */</span>
	<span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">atomic_t</span>	rmem_alloc<span class="token punctuation">;</span>
		<span class="token keyword">int</span>		len<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">sk_buff</span>	<span class="token operator">*</span>head<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">sk_buff</span>	<span class="token operator">*</span>tail<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> sk_backlog<span class="token punctuation">;</span>
	 <span class="token comment">// ...省略</span>
	<span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
		 <span class="token keyword">struct</span> <span class="token class-name">socket_wq</span> __rcu	<span class="token operator">*</span>sk_wq<span class="token punctuation">;</span>
		 <span class="token comment">/* private: */</span>
		 <span class="token keyword">struct</span> <span class="token class-name">socket_wq</span>	<span class="token operator">*</span>sk_wq_raw<span class="token punctuation">;</span>
		 <span class="token comment">/* public: */</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// ...省略</span>
	<span class="token keyword">void</span>			<span class="token punctuation">(</span><span class="token operator">*</span>sk_state_change<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span>			<span class="token punctuation">(</span><span class="token operator">*</span>sk_data_ready<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span>			<span class="token punctuation">(</span><span class="token operator">*</span>sk_write_space<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span>			<span class="token punctuation">(</span><span class="token operator">*</span>sk_error_report<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span>			<span class="token punctuation">(</span><span class="token operator">*</span>sk_backlog_rcv<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...省略</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>到这里线索又又断了，这个<code>sk-&gt;sk_data_ready</code>是什么时候设置的呢？一般都会想到是<code>struct sock</code>初始化时设置的，那我们继续回到<code>3.2小节的inet_create函数</code>，其中有个<code>sock_init_data(sock, sk)</code>的函数调用，就是在这里设置的。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">sock_init_data</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">socket</span> <span class="token operator">*</span>sock<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">kuid_t</span> uid <span class="token operator">=</span> sock <span class="token operator">?</span> <span class="token function">SOCK_INODE</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token operator">-&gt;</span>i_uid <span class="token operator">:</span> <span class="token function">make_kuid</span><span class="token punctuation">(</span><span class="token function">sock_net</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token operator">-&gt;</span>user_ns<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sock_init_data_uid</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> sk<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">sock_init_data_uid</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">socket</span> <span class="token operator">*</span>sock<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token class-name">kuid_t</span> uid<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
     <span class="token comment">// ...省略</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>sock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		   sk<span class="token operator">-&gt;</span>sk_type	<span class="token operator">=</span>	sock<span class="token operator">-&gt;</span>type<span class="token punctuation">;</span>
		   <span class="token function">RCU_INIT_POINTER</span><span class="token punctuation">(</span>sk<span class="token operator">-&gt;</span>sk_wq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sock<span class="token operator">-&gt;</span>wq<span class="token punctuation">)</span><span class="token punctuation">;</span>
		   sock<span class="token operator">-&gt;</span>sk	<span class="token operator">=</span>	sk<span class="token punctuation">;</span> <span class="token comment">//将sk设置到sock中</span>
	  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		   <span class="token function">RCU_INIT_POINTER</span><span class="token punctuation">(</span>sk<span class="token operator">-&gt;</span>sk_wq<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
    <span class="token comment">// ...省略</span>
    sk<span class="token operator">-&gt;</span>sk_state_change	<span class="token operator">=</span>	sock_def_wakeup<span class="token punctuation">;</span>
	  sk<span class="token operator">-&gt;</span>sk_data_ready	<span class="token operator">=</span>	sock_def_readable<span class="token punctuation">;</span> <span class="token comment">//关注</span>
	  sk<span class="token operator">-&gt;</span>sk_write_space	<span class="token operator">=</span>	sock_def_write_space<span class="token punctuation">;</span>
	  sk<span class="token operator">-&gt;</span>sk_error_report	<span class="token operator">=</span>	sock_def_error_report<span class="token punctuation">;</span>
	  sk<span class="token operator">-&gt;</span>sk_destruct		<span class="token operator">=</span>	sock_def_destruct<span class="token punctuation">;</span>
    <span class="token comment">// ...省略 </span>
<span class="token punctuation">}</span>
</code></pre> 
<p>所以<code>sk-&gt;sk_data_ready</code>本质就是<a href="https://github.com/torvalds/linux/blob/v6.7/net/core/sock.c#L3337">sock_def_readable</a>函数,看名字就知道其是socket 可读时使用的。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">sock_def_readable</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">socket_wq</span> <span class="token operator">*</span>wq<span class="token punctuation">;</span>
	<span class="token function">trace_sk_data_ready</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	wq <span class="token operator">=</span> <span class="token function">rcu_dereference</span><span class="token punctuation">(</span>sk<span class="token operator">-&gt;</span>sk_wq<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">skwq_has_sleeper</span><span class="token punctuation">(</span>wq<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">wake_up_interruptible_sync_poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq<span class="token operator">-&gt;</span>wait<span class="token punctuation">,</span> EPOLLIN <span class="token operator">|</span> EPOLLPRI <span class="token operator">|</span> EPOLLRDNORM <span class="token operator">|</span> EPOLLRDBAND<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//进程唤醒</span>
	<span class="token function">sk_wake_async</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> SOCK_WAKE_WAITD<span class="token punctuation">,</span> POLL_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/include/linux/wait.h#L244">wake_up_interruptible_sync_poll</a></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">wake_up_interruptible_sync_poll</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">,</span> m<span class="token punctuation">)</span>	<span class="token function">__wake_up_sync_key</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> TASK_INTERRUPTIBLE<span class="token punctuation">,</span> <span class="token function">poll_to_key</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/kernel/sched/wait.c#L167">__wake_up_sync_key</a></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">__wake_up_sync_key</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">wait_queue_head</span> <span class="token operator">*</span>wq_head<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mode<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>wq_head<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token function">__wake_up_common_lock</span><span class="token punctuation">(</span>wq_head<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> WF_SYNC<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__wake_up_common_lock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">wait_queue_head</span> <span class="token operator">*</span>wq_head<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mode<span class="token punctuation">,</span> <span class="token keyword">int</span> nr_exclusive<span class="token punctuation">,</span> <span class="token keyword">int</span> wake_flags<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
	<span class="token keyword">int</span> remaining<span class="token punctuation">;</span>
	<span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	remaining <span class="token operator">=</span> <span class="token function">__wake_up_common</span><span class="token punctuation">(</span>wq_head<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> nr_exclusive<span class="token punctuation">,</span> wake_flags<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> nr_exclusive <span class="token operator">-</span> remaining<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//唤醒</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__wake_up_common</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">wait_queue_head</span> <span class="token operator">*</span>wq_head<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mode<span class="token punctuation">,</span>
			<span class="token keyword">int</span> nr_exclusive<span class="token punctuation">,</span> <span class="token keyword">int</span> wake_flags<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">wait_queue_entry_t</span> <span class="token operator">*</span>curr<span class="token punctuation">,</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

	<span class="token function">lockdep_assert_held</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	curr <span class="token operator">=</span> <span class="token function">list_first_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>head<span class="token punctuation">,</span> <span class="token class-name">wait_queue_entry_t</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取等待队列wq_head的队头</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>curr<span class="token operator">-&gt;</span>entry <span class="token operator">==</span> <span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>head<span class="token punctuation">)</span>
		<span class="token keyword">return</span> nr_exclusive<span class="token punctuation">;</span>

	<span class="token function">list_for_each_entry_safe_from</span><span class="token punctuation">(</span>curr<span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>head<span class="token punctuation">,</span> entry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//循环处理</span>
		<span class="token keyword">unsigned</span> flags <span class="token operator">=</span> curr<span class="token operator">-&gt;</span>flags<span class="token punctuation">;</span>
		<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

		ret <span class="token operator">=</span> curr<span class="token operator">-&gt;</span><span class="token function">func</span><span class="token punctuation">(</span>curr<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> wake_flags<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用唤醒函数，即3.2小节的pollwake函数</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> WQ_FLAG_EXCLUSIVE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">--</span>nr_exclusive<span class="token punctuation">)</span><span class="token comment">//跳出循环</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> nr_exclusive<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>终于看到pollwake函数是如何被调用的了。</p> 
<p>对于pollwake函数，我们在<code>2.2小节select内核源码调用链图示</code>中已知pollwake函数调用链：</p> 
<blockquote> 
 <p>pollwake-&gt;__pollwake-&gt;default_wake_function-&gt;try_to_wake_up-&gt;ttwu_do_wakeup-&gt;WRITE_ONCE(p-&gt;__state, TASK_RUNNING)<br> <a href="https://blog.csdn.net/shift_wwx/article/details/130082519">WRITE_ONCE作用</a>。</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pollwake</span><span class="token punctuation">(</span><span class="token class-name">wait_queue_entry_t</span> <span class="token operator">*</span>wait<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> mode<span class="token punctuation">,</span> <span class="token keyword">int</span> sync<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...省略</span>
	<span class="token keyword">return</span> <span class="token function">__pollwake</span><span class="token punctuation">(</span>wait<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> sync<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__pollwake</span><span class="token punctuation">(</span><span class="token class-name">wait_queue_entry_t</span> <span class="token operator">*</span>wait<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> mode<span class="token punctuation">,</span> <span class="token keyword">int</span> sync<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">poll_wqueues</span> <span class="token operator">*</span>pwq <span class="token operator">=</span> wait<span class="token operator">-&gt;</span>private<span class="token punctuation">;</span>
	<span class="token function">DECLARE_WAITQUEUE</span><span class="token punctuation">(</span>dummy_wait<span class="token punctuation">,</span> pwq<span class="token operator">-&gt;</span>polling_task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建等待队列元素</span>
	<span class="token function">smp_wmb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	pwq<span class="token operator">-&gt;</span>triggered <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">default_wake_function</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dummy_wait<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> sync<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//唤醒</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">default_wake_function</span><span class="token punctuation">(</span><span class="token class-name">wait_queue_entry_t</span> <span class="token operator">*</span>curr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> mode<span class="token punctuation">,</span> <span class="token keyword">int</span> wake_flags<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_SCHED_DEBUG<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> wake_flags <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>WF_SYNC<span class="token operator">|</span>WF_CURRENT_CPU<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//这里的参数curr-&gt;private就是pwq-&gt;polling_task，即PCB,后续逻辑就是通过WRITE_ONCE将其__state设为TASK_RUNNING</span>
	<span class="token keyword">return</span> <span class="token function">try_to_wake_up</span><span class="token punctuation">(</span>curr<span class="token operator">-&gt;</span>private<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> wake_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到pollwake函数最终会把该进程的状态设置为<code>TASK_RUNNING</code>状态,等待被调度即可。至此我们就把I/O事件就绪通知源码的整个调用链条理清楚了。</p> 
<h3><a id="socket_1002"></a>四、socket等待队列</h3> 
<p>通过第三章的源码追溯，可以知道socket等待队列本质就是<a href="https://www.cnblogs.com/hueyxu/p/13745029.html" rel="nofollow">Linux等待队列</a>，<a href="https://github.com/torvalds/linux/blob/v6.7/include/linux/wait.h#L36">相关结构体</a>如下：</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * A single wait-queue entry structure:
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">wait_queue_entry</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		flags<span class="token punctuation">;</span>
	<span class="token keyword">void</span>			<span class="token operator">*</span>private<span class="token punctuation">;</span>
	<span class="token class-name">wait_queue_func_t</span>	func<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	entry<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">wait_queue_head</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">spinlock_t</span>		lock<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	head<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">wait_queue_head</span> <span class="token class-name">wait_queue_head_t</span><span class="token punctuation">;</span>
</code></pre> 
<p>那么<code>struct socket的wq字段，即struct socket_wq的wait字段，即wait_queue_head_t在什么时候被初始化的呢？</code></p> 
<h5><a id="41sockfs_1023"></a>4.1、虚拟文件系统sockfs</h5> 
<p>Linux中<code>万物皆文件</code>，socket是一种VFS，在Linux中对应的文件系统叫<a href="https://zhuanlan.zhihu.com/p/479951844" rel="nofollow">sockfs</a>，每创建一个socket，就在sockfs中创建了一个特殊的文件，同时创建了sockfs文件系统中的inode，该inode唯一标识当前socket的通信。</p> 
<blockquote> 
 <p>在Linux内核中，sock_mnt全局变量是一个指向<code>struct vfsmount</code>结构体的指针，它代表了sockfs的挂载点，包含了挂载点的所有信息，如挂载类型、挂载选项、挂载位置等。Linux在内核初始化过程时会通过<a href="https://github.com/torvalds/linux/blob/v6.7/net/socket.c#L3264">sock_init函数</a>将sockfs挂载到内核的文件系统层次结构中。</p> 
</blockquote> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/include/linux/mount.h#L70">struct vfsmount结构体</a></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">vfsmount</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">dentry</span> <span class="token operator">*</span>mnt_root<span class="token punctuation">;</span>	<span class="token comment">//指向挂载点根目录的结构体指针</span>
	<span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>mnt_sb<span class="token punctuation">;</span>	<span class="token comment">/* pointer to superblock */</span> <span class="token comment">//本文需关注这个</span>
	<span class="token keyword">int</span> mnt_flags<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mnt_idmap</span> <span class="token operator">*</span>mnt_idmap<span class="token punctuation">;</span>
<span class="token punctuation">}</span> __randomize_layout<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">super_operations</span> sockfs_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>alloc_inode	<span class="token operator">=</span> sock_alloc_inode<span class="token punctuation">,</span><span class="token comment">//需要关注这个，socket创建时会用到</span>
	<span class="token punctuation">.</span>free_inode	<span class="token operator">=</span> sock_free_inode<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>statfs		<span class="token operator">=</span> simple_statfs<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">sockfs_init_fs_context</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fs_context</span> <span class="token operator">*</span>fc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">pseudo_fs_context</span> <span class="token operator">*</span>ctx <span class="token operator">=</span> <span class="token function">init_pseudo</span><span class="token punctuation">(</span>fc<span class="token punctuation">,</span> SOCKFS_MAGIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
	ctx<span class="token operator">-&gt;</span>ops <span class="token operator">=</span> <span class="token operator">&amp;</span>sockfs_ops<span class="token punctuation">;</span> <span class="token comment">//需要关注这个</span>
	ctx<span class="token operator">-&gt;</span>dops <span class="token operator">=</span> <span class="token operator">&amp;</span>sockfs_dentry_operations<span class="token punctuation">;</span>
	ctx<span class="token operator">-&gt;</span>xattr <span class="token operator">=</span> sockfs_xattr_handlers<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">vfsmount</span> <span class="token operator">*</span>sock_mnt __read_mostly<span class="token punctuation">;</span> <span class="token comment">//sockfs挂载点实例</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_system_type</span> sock_fs_type <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>name <span class="token operator">=</span>		<span class="token string">"sockfs"</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>init_fs_context <span class="token operator">=</span> sockfs_init_fs_context<span class="token punctuation">,</span><span class="token comment">//需要关注这个，挂载sockfs时会用到</span>
	<span class="token punctuation">.</span>kill_sb <span class="token operator">=</span>	kill_anon_super<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">sock_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>
	<span class="token comment">// ...省略</span>
	err <span class="token operator">=</span> <span class="token function">register_filesystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sock_fs_type<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注册sockfs</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	sock_mnt <span class="token operator">=</span> <span class="token function">kern_mount</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sock_fs_type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//挂载sockfs</span>
	<span class="token comment">// ...省略</span>
<span class="token punctuation">}</span>

<span class="token function">core_initcall</span><span class="token punctuation">(</span>sock_init<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* early initcall */</span> <span class="token comment">//一个宏，注册sock_init，这样Linux在内核初始化时会执行sock_init函数</span>
</code></pre> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/fs/namespace.c#L4752">kern_mount</a></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">vfsmount</span> <span class="token operator">*</span><span class="token function">kern_mount</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file_system_type</span> <span class="token operator">*</span>type<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">vfsmount</span> <span class="token operator">*</span>mnt<span class="token punctuation">;</span>
	mnt <span class="token operator">=</span> <span class="token function">vfs_kern_mount</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> SB_KERNMOUNT<span class="token punctuation">,</span> type<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...省略</span>
	<span class="token keyword">return</span> mnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> <span class="token class-name">vfsmount</span> <span class="token operator">*</span><span class="token function">vfs_kern_mount</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file_system_type</span> <span class="token operator">*</span>type<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">fs_context</span> <span class="token operator">*</span>fc<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">vfsmount</span> <span class="token operator">*</span>mnt<span class="token punctuation">;</span>
	<span class="token comment">// ...省略</span>
	fc <span class="token operator">=</span> <span class="token function">fs_context_for_mount</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建fs_context 并调用sockfs_init_fs_context函数</span>
  <span class="token comment">// ...省略</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span>
		mnt <span class="token operator">=</span> <span class="token function">fc_mount</span><span class="token punctuation">(</span>fc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//基于fc创建mnt</span>
	<span class="token keyword">else</span>
		mnt <span class="token operator">=</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">put_fs_context</span><span class="token punctuation">(</span>fc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> mnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="42socket_1100"></a>4.2、socket等待队列初始化</h5> 
<p>我们在第三章开头的socket创建的内核源码调用链图中有个<a href="https://github.com/torvalds/linux/blob/v6.7/net/socket.c#L629">sock_alloc</a>函数。<br> <a href="https://blog.csdn.net/m0_37383484/article/details/129244244">container_of宏用法</a>。</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">socket_alloc</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">socket</span> socket<span class="token punctuation">;</span> <span class="token comment">//socket</span>
	<span class="token keyword">struct</span> <span class="token class-name">inode</span> vfs_inode<span class="token punctuation">;</span><span class="token comment">//socket inode</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">socket</span> <span class="token operator">*</span><span class="token function">sock_alloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">socket</span> <span class="token operator">*</span>sock<span class="token punctuation">;</span>
	inode <span class="token operator">=</span> <span class="token function">new_inode_pseudo</span><span class="token punctuation">(</span>sock_mnt<span class="token operator">-&gt;</span>mnt_sb<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始申请socket inode</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inode<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
   <span class="token comment">// ...省略</span>
	sock <span class="token operator">=</span> <span class="token function">SOCKET_I</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> sock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">socket</span> <span class="token operator">*</span><span class="token function">SOCKET_I</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token comment">//这里与下文alloc_inode_sb函数申请的struct socket_alloc实例是联动的，通过inode的地址计算出struct socket_alloc下socket的地址</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token function">container_of</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">socket_alloc</span><span class="token punctuation">,</span> vfs_inode<span class="token punctuation">)</span><span class="token operator">-&gt;</span>socket<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/fs/inode.c#L1004">new_inode_pseudo</a></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token function">new_inode_pseudo</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>sb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode <span class="token operator">=</span> <span class="token function">alloc_inode</span><span class="token punctuation">(</span>sb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...省略</span>
	<span class="token keyword">return</span> inode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token function">alloc_inode</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>sb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">super_operations</span> <span class="token operator">*</span>ops <span class="token operator">=</span> sb<span class="token operator">-&gt;</span>s_op<span class="token punctuation">;</span><span class="token comment">//这里就是调用sockfs_ops</span>
	<span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token operator">-&gt;</span>alloc_inode<span class="token punctuation">)</span>
		inode <span class="token operator">=</span> ops<span class="token operator">-&gt;</span><span class="token function">alloc_inode</span><span class="token punctuation">(</span>sb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用sock_alloc_inode函数</span>
	<span class="token keyword">else</span>
		inode <span class="token operator">=</span> <span class="token function">alloc_inode_sb</span><span class="token punctuation">(</span>sb<span class="token punctuation">,</span> inode_cachep<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inode<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token comment">// ...省略</span>
	<span class="token keyword">return</span> inode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/net/socket.c#L304">sock_alloc_inode函数</a>。<br> <a href="https://github.com/torvalds/linux/blob/v6.7/include/linux/fs.h#L2935">alloc_inode_sb函数</a>。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token function">sock_alloc_inode</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>sb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">socket_alloc</span> <span class="token operator">*</span>ei<span class="token punctuation">;</span>
  <span class="token comment">//This must be used for allocating filesystems specific inodes to set up the inode reclaim context correctly.</span>
	ei <span class="token operator">=</span> <span class="token function">alloc_inode_sb</span><span class="token punctuation">(</span>sb<span class="token punctuation">,</span> sock_inode_cachep<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//申请socket inode</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ei<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ei<span class="token operator">-&gt;</span>socket<span class="token punctuation">.</span>wq<span class="token punctuation">.</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化socket的等待队列</span>
	<span class="token comment">// ...省略</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ei<span class="token operator">-&gt;</span>vfs_inode<span class="token punctuation">;</span><span class="token comment">//返回socket inode</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/kernel/sched/wait.c#L8">__init_waitqueue_head函数</a></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">__init_waitqueue_head</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">wait_queue_head</span> <span class="token operator">*</span>wq_head<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">lock_class_key</span> <span class="token operator">*</span>key<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lockdep_set_class_and_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> key<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>到这里就理清socket 等待队列如何初始化的了。</p> 
<h3><a id="select_1174"></a>五、select超时源码解析</h3> 
<p>在<code>2.2.3小节对do_select函数</code>分析可知，当参数<code>end_time != NULL &amp;&amp; (end_time-&gt;tv_sec &gt; 0 || end_time-&gt;tv_nsec &gt; 0)</code>时，如果第一次循环没有I/O就绪事件，则会通过<a href="https://github.com/torvalds/linux/blob/v6.7/fs/select.c#L237">poll_schedule_timeout函数</a>挂起当前进程。<br> 调用方式<code>poll_schedule_timeout(&amp;table, TASK_INTERRUPTIBLE,to, slack)</code>。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">poll_schedule_timeout</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">poll_wqueues</span> <span class="token operator">*</span>pwq<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">,</span> <span class="token class-name">ktime_t</span> <span class="token operator">*</span>expires<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> slack<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token operator">-</span>EINTR<span class="token punctuation">;</span>

	<span class="token function">set_current_state</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置当前进程状态为TASK_INTERRUPTIBLE</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pwq<span class="token operator">-&gt;</span>triggered<span class="token punctuation">)</span> <span class="token comment">//进入poll_schedule_timeout函数时被I/O就绪事件通知，就不等待了</span>
		rc <span class="token operator">=</span> <span class="token function">schedule_hrtimeout_range</span><span class="token punctuation">(</span>expires<span class="token punctuation">,</span> slack<span class="token punctuation">,</span> HRTIMER_MODE_ABS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动定时器</span>
	<span class="token function">__set_current_state</span><span class="token punctuation">(</span>TASK_RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置当前进程状态为TASK_RUNNING</span>

	<span class="token function">smp_store_mb</span><span class="token punctuation">(</span>pwq<span class="token operator">-&gt;</span>triggered<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//定时器结束也通过信号量将pwq-&gt;triggered设为0。另外被I/O唤醒也会被设为0的，见__pollwake函数。</span>
	<span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="https://github.com/torvalds/linux/blob/v6.7/kernel/time/hrtimer.c#L2352">schedule_hrtimeout_range函数</a></p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> __sched <span class="token function">schedule_hrtimeout_range</span><span class="token punctuation">(</span><span class="token class-name">ktime_t</span> <span class="token operator">*</span>expires<span class="token punctuation">,</span> u64 delta<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> <span class="token class-name">hrtimer_mode</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">schedule_hrtimeout_range_clock</span><span class="token punctuation">(</span>expires<span class="token punctuation">,</span> delta<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> CLOCK_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> __sched <span class="token function">schedule_hrtimeout_range_clock</span><span class="token punctuation">(</span><span class="token class-name">ktime_t</span> <span class="token operator">*</span>expires<span class="token punctuation">,</span> u64 delta<span class="token punctuation">,</span>
			       <span class="token keyword">const</span> <span class="token keyword">enum</span> <span class="token class-name">hrtimer_mode</span> mode<span class="token punctuation">,</span> <span class="token class-name">clockid_t</span> clock_id<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">hrtimer_sleeper</span> t<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>expires <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>expires <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//就是end_time != NULL &amp;&amp; end_time-&gt;tv_sec == 0 &amp;&amp; end_time-&gt;tv_nsec == 0的条件</span>
		<span class="token function">__set_current_state</span><span class="token punctuation">(</span>TASK_RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//直接返回</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/*
	 * A NULL parameter means "infinite"
	 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expires<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//就是end_time == NULL的条件</span>
		<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//主动调度，让出CPU</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINTR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rt_task</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//current 就是当前进程PCB</span>
		delta <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">hrtimer_init_sleeper_on_stack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">,</span> clock_id<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">hrtimer_set_expires_range_ns</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>timer<span class="token punctuation">,</span> <span class="token operator">*</span>expires<span class="token punctuation">,</span> delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">hrtimer_sleeper_start_expires</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//主动调度，让出CPU</span>
  <span class="token comment">//进程被唤醒后，会继续从这里执行</span>
	<span class="token function">hrtimer_cancel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//销毁定时器</span>
	<span class="token function">destroy_hrtimer_on_stack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">__set_current_state</span><span class="token punctuation">(</span>TASK_RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置当前进程状态为TASK_RUNNING</span>

	<span class="token keyword">return</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>task <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token operator">-</span>EINTR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__hrtimer_init_sleeper</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">hrtimer_sleeper</span> <span class="token operator">*</span>sl<span class="token punctuation">,</span> <span class="token class-name">clockid_t</span> clock_id<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">hrtimer_mode</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_PREEMPT_RT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">task_is_realtime</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> HRTIMER_MODE_SOFT<span class="token punctuation">)</span><span class="token punctuation">)</span>
			mode <span class="token operator">|=</span> HRTIMER_MODE_HARD<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">__hrtimer_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sl<span class="token operator">-&gt;</span>timer<span class="token punctuation">,</span> clock_id<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主要目的是初始化hrtimer的base字段，同时初始化作为红黑树的节点的node字段</span>
	sl<span class="token operator">-&gt;</span>timer<span class="token punctuation">.</span>function <span class="token operator">=</span> hrtimer_wakeup<span class="token punctuation">;</span> <span class="token comment">//设置唤醒函数</span>
	sl<span class="token operator">-&gt;</span>task <span class="token operator">=</span> current<span class="token punctuation">;</span> <span class="token comment">//设置当前定时器绑定的进程PCB</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们先看看<a href="https://github.com/torvalds/linux/blob/v6.7/kernel/time/hrtimer.c#L1934">hrtimer_wakeup函数</a>：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">enum</span> <span class="token class-name">hrtimer_restart</span> <span class="token function">hrtimer_wakeup</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">hrtimer</span> <span class="token operator">*</span>timer<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">hrtimer_sleeper</span> <span class="token operator">*</span>t <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">hrtimer_sleeper</span><span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//根据struct hrtimer指针计算出struct hrtimer_sleeper的指针</span>
	<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>task <span class="token operator">=</span> t<span class="token operator">-&gt;</span>task<span class="token punctuation">;</span><span class="token comment">//获取当前定时器绑定进程的PCB</span>
	t<span class="token operator">-&gt;</span>task <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">)</span>
		<span class="token function">wake_up_process</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//进程还没被销毁的话就唤醒</span>
	<span class="token keyword">return</span> HRTIMER_NORESTART<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">wake_up_process</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">try_to_wake_up</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> TASK_NORMAL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//后续逻辑就是通过WRITE_ONCE将其__state设为TASK_RUNNING,3.3小节末尾已提到</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>那谁去调hrtimer_wakeup函数呢？我们在<code>1.3小节Linux时钟中断</code>已经了解了其工作原理，<code>经过源码追踪hrtimer高精度定时器的时钟中断函数就是hrtimer_interrupt</code></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">hrtimer_interrupt</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">clock_event_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">hrtimer_cpu_base</span> <span class="token operator">*</span>cpu_base <span class="token operator">=</span> <span class="token function">this_cpu_ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hrtimer_bases<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ...省略</span>
	<span class="token function">__hrtimer_run_queues</span><span class="token punctuation">(</span>cpu_base<span class="token punctuation">,</span> now<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> HRTIMER_ACTIVE_HARD<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// ...省略</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__hrtimer_run_queues</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">hrtimer_cpu_base</span> <span class="token operator">*</span>cpu_base<span class="token punctuation">,</span> <span class="token class-name">ktime_t</span> now<span class="token punctuation">,</span>
				 <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> active_mask<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">hrtimer_clock_base</span> <span class="token operator">*</span>base<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> active <span class="token operator">=</span> cpu_base<span class="token operator">-&gt;</span>active_bases <span class="token operator">&amp;</span> active_mask<span class="token punctuation">;</span>

	<span class="token function">for_each_active_base</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> cpu_base<span class="token punctuation">,</span> active<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//循环所有定时器</span>
		<span class="token keyword">struct</span> <span class="token class-name">timerqueue_node</span> <span class="token operator">*</span>node<span class="token punctuation">;</span>
		<span class="token class-name">ktime_t</span> basenow<span class="token punctuation">;</span>

		basenow <span class="token operator">=</span> <span class="token function">ktime_add</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> base<span class="token operator">-&gt;</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>node <span class="token operator">=</span> <span class="token function">timerqueue_getnext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>base<span class="token operator">-&gt;</span>active<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">struct</span> <span class="token class-name">hrtimer</span> <span class="token operator">*</span>timer<span class="token punctuation">;</span>
			timer <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">hrtimer</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>basenow <span class="token operator">&lt;</span> <span class="token function">hrtimer_get_softexpires_tv64</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//定时器没到期就不执行</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token function">__run_hrtimer</span><span class="token punctuation">(</span>cpu_base<span class="token punctuation">,</span> base<span class="token punctuation">,</span> timer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>basenow<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行每个定时器</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>active_mask <span class="token operator">==</span> HRTIMER_ACTIVE_SOFT<span class="token punctuation">)</span>
				<span class="token function">hrtimer_sync_wait_running</span><span class="token punctuation">(</span>cpu_base<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__run_hrtimer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">hrtimer_cpu_base</span> <span class="token operator">*</span>cpu_base<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">hrtimer_clock_base</span> <span class="token operator">*</span>base<span class="token punctuation">,</span>
        <span class="token keyword">struct</span> <span class="token class-name">hrtimer</span> <span class="token operator">*</span>timer<span class="token punctuation">,</span> <span class="token class-name">ktime_t</span> <span class="token operator">*</span>now<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span> <span class="token function">__must_hold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cpu_base<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...省略</span>
	<span class="token function">__remove_hrtimer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> base<span class="token punctuation">,</span> HRTIMER_STATE_INACTIVE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//移除</span>
	fn <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>function<span class="token punctuation">;</span><span class="token comment">//获取定时器到期回调函数，即hrtimer_wakeup函数</span>
<span class="token comment">// ...省略</span>
	restart <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行hrtimer_wakeup函数</span>
<span class="token comment">// ...省略</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1304"></a>六、参考</h3> 
<p>1]:<a href="https://blog.csdn.net/m0_37383484/article/details/129244244">Linux 内核 container_of 宏详解</a><br> 2]:<a href="https://www.cnblogs.com/hueyxu/p/13745029.html" rel="nofollow">Linux等待队列wait_queue</a><br> 3]:<a href="https://blog.csdn.net/mrqiuwen/article/details/130478178">Linux内核中的各种锁</a><br> 4]:<a href="https://zhuanlan.zhihu.com/p/363791563" rel="nofollow">linux调度子系统8 - schedule函数</a><br> 5]:<a href="https://blog.csdn.net/iriczhao/article/details/122644580">linux内核的进程调度函数schedule</a><br> 6]:<a href="https://zhuanlan.zhihu.com/p/479951844" rel="nofollow">浅析Linux sockfs文件系统</a><br> 7:]<a href="https://www.cnblogs.com/theseventhson/p/15859467.html" rel="nofollow">socket&amp;sock结构体介绍</a><br> 8]:<a href="https://blog.csdn.net/Rong_Toa/article/details/105349859">Linux内核协议栈- 创建socket</a><br> 9]:<a href="https://blog.csdn.net/heliangbin87/article/details/79208326">linux内核之时间子系统</a><br> 10]<a href="https://zhuanlan.zhihu.com/p/650943020" rel="nofollow">Linux的时间子系统</a><br> 11]:<a href="https://www.cnblogs.com/zyly/p/17208082.html" rel="nofollow">linux驱动移植-RTC驱动</a><br> 12]:<a href="https://www.cnblogs.com/zyly/p/16597019.html" rel="nofollow">linux驱动移植-通用时钟框架子系统</a><br> 13]:<a href="https://blog.csdn.net/DroidPhone/article/details/8074892">Linux时间子系统之六：高精度定时器（HRTIMER）的原理和实现</a><br> 14]:<a href="https://zhuanlan.zhihu.com/p/450089796" rel="nofollow">入门linux内核高精度定时器hrtimer机制</a><br> 15]:<a href="https://www.cnblogs.com/edver/p/16016521.html" rel="nofollow">Linux时钟子系统分析</a><br> 16]:<a href="https://zhuanlan.zhihu.com/p/450089796" rel="nofollow"> Linux 时间子系统</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/01b2bb2d044442ef17ec22c178c06582/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">一个外国软件，让你的手机成为扩展屏</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/95d0f307409697df379b51af36fc426c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python Flask与微信小程序 统计管理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>