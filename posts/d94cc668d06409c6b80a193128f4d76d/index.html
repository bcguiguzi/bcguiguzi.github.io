<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>一文了解如何在window上轻松实现多进程任务 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="一文了解如何在window上轻松实现多进程任务" />
<meta property="og:description" content="参考 苏神写的parallel_apply link
python中multiprocessing文档 link
前言 在之前的工作中，我经常使用的多进程方式是进程池，在看了苏神写的parallel_apply之后，发现多进程使用队列的方式运行，从显示上（tqdm显示运行进度），灵活性上都更加好 经过更深入的使用之后，我发现其实进程池也可以比较灵活的传递参数。然而，在运行时发现多进程在windows上的支持很不友好，于是打算写一篇在windows上容易使用的多进程方法，当然也可以在linux上使用。
使用多进程来提高程序的运行效率是非常重要的，通常可以在数据处理，矩阵运算等方面应用。
进程在windows上使用的注意点 1.必须得保证你要使用多进程处理的程序是可序列化的，即可以转换为可存储或传输的形式，如generator就是不可序列化的形式，因此想要对jieba分词使用多进程就是不可行的
2.多个进程之间是独立的，所以想在多个进程中更新同一个类属性是不可行的，除非是使用multiprocessing中带的Array,List等方法，并将这些变量作为输入传入到进程中去，不过这个方法我并没有尝试过。
3.每个进程使用的函数都是一次性的，因此若是传入的类函数中，初始时赋值了变量，则这个变量在每一次运行时都会执行，若这个赋值变量的运行时间很长，则会导致使用多进程甚至比单独执行更慢，以下是例子：
import json class myClass: def __init__(self): with open(file_name, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f: self.data = json.load(f) def forward(self, idx): return self.data[idx] 上述例子中，初始化__init__函数中，需要载入数据来执行forward函数，这种情况下将foward放入多进程中，会极大的影响效率，甚至比单独执行更慢。
4.在if __name__ == &#39;__main__&#39;或者函数中设定的全局变量无法在多进程中使用，因为如果子进程中的代码尝试访问一个全局变量，它所看到的值（如果有）可能和父进程中执行 Process.start 那一刻的值不一样。例子如下：
import json from multiprocessing import Pool def forward(idx): return data[idx] if __name__ == &#39;__main__&#39;: global data with open(file_name, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f: data = json.load(f) with Pool(6) as pool: pool." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/d94cc668d06409c6b80a193128f4d76d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-09T13:59:21+08:00" />
<meta property="article:modified_time" content="2022-09-09T13:59:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">一文了解如何在window上轻松实现多进程任务</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>参考</h2> 
<p>苏神写的parallel_apply <a href="https://github.com/bojone/bert4keras/blob/master/bert4keras/snippets.py">link</a><br> python中multiprocessing文档 <a href="https://docs.python.org/zh-cn/3/library/multiprocessing.html#multiprocessing.pool.Pool" rel="nofollow">link</a></p> 
<h2><a id="_4"></a>前言</h2> 
<p>在之前的工作中，我经常使用的多进程方式是进程池，在看了苏神写的parallel_apply之后，发现多进程使用队列的方式运行，<s>从显示上（tqdm显示运行进度），灵活性上都更加好</s> 经过更深入的使用之后，我发现其实进程池也可以比较灵活的传递参数。然而，在运行时发现多进程在windows上的支持很不友好，于是打算写一篇在windows上容易使用的多进程方法，当然也可以在linux上使用。</p> 
<p>使用多进程来提高程序的运行效率是非常重要的，通常可以在数据处理，矩阵运算等方面应用。</p> 
<h2><a id="windows_9"></a>进程在windows上使用的注意点</h2> 
<p>1.必须得保证你要使用多进程处理的程序是可序列化的，即可以转换为可存储或传输的形式，如generator就是不可序列化的形式，因此想要对jieba分词使用多进程就是不可行的<br> 2.多个进程之间是独立的，所以想在多个进程中更新同一个类属性是不可行的，除非是使用multiprocessing中带的Array,List等方法，并将这些变量作为输入传入到进程中去，不过这个方法我并没有尝试过。<br> 3.每个进程使用的函数都是一次性的，因此若是传入的类函数中，初始时赋值了变量，则这个变量在每一次运行时都会执行，若这个赋值变量的运行时间很长，则会导致使用多进程甚至比单独执行更慢，以下是例子：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">class</span> <span class="token class-name">myClass</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
			self<span class="token punctuation">.</span>data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	
	<span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
</code></pre> 
<p>上述例子中，初始化<code>__init__</code>函数中，需要载入数据来执行<code>forward</code>函数，这种情况下将foward放入多进程中，会极大的影响效率，甚至比单独执行更慢。<br> 4.在<code>if __name__ == '__main__'</code>或者函数中设定的全局变量无法在多进程中使用，因为如果子进程中的代码尝试访问一个全局变量，它所看到的值（如果有）可能和父进程中执行 Process.start 那一刻的值不一样。例子如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
<span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">return</span> data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
	<span class="token keyword">global</span> data
	<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
		data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	<span class="token keyword">with</span> Pool<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span>
		pool<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>forward<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>而下面这种方式是可以的，因为全局变量是知识模块级别的变量</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
	data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">return</span> data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
	<span class="token keyword">with</span> Pool<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span>
		pool<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>forward<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>5.在使用多进程时，应当使用<code>if __name__ == '__main__'</code>，从而保护程序的入口点，不使用时可能会出现各种各样的错误。</p> 
<h2><a id="_53"></a>方法</h2> 
<h3><a id="_54"></a>进程池</h3> 
<p>进程池是比较简单的方法，只需设定好池中进程的数量，使用<code>map(function, args)</code>即可使用，也可以使用<code>starmap(function, args)</code>的方法，<code>map</code>与starmap的区别在于<code>map</code>仅能传递一个参数，而<code>starmap</code>可以传递多个参数，例子如下</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    y <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> x<span class="token operator">+</span>y

<span class="token keyword">def</span> <span class="token function">func1</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">return</span> x<span class="token operator">+</span>y

<span class="token keyword">def</span> <span class="token function">simple_calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">for</span> data <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> \
        <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        func<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Pool<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span>
        pool<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> tqdm<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> \
        <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> Pool<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span>
    	pool<span class="token punctuation">.</span>starmap<span class="token punctuation">(</span>func1<span class="token punctuation">,</span> tqdm<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> \
        <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    simple_calculate<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>map</code>调用的是func，每次传入的参数为<code>data</code>, 而starmap每次传入的参数为<code>x,y</code>。使用进程池运行上述例子的时间大约是4s，而简单的运算<code>simple_calculation</code>为3s，显然在简单的数值运算上，多进程并没有很好的性能</p> 
<h3><a id="_82"></a>队列</h3> 
<p>队列，顾名思义是将任务放入到队列中，然后每个进程从队列中取出任务执行的过程。因此使用队列进行多进程操作包括：<br> 1.将任务放入到队列中，我们使用<code>Queue.put()</code>方法<br> 2.启动进程，我们是用<code>Process(target=target, args=args).start()</code><br> 3.获取结果，我们是用<code>Queue.get()</code>方法<br> 4.终止进程，我们将终止信号<code>STOP</code>传入到每个进程中，使得进程停止的方法是<code>iter(iterable, sentinel)</code>中的<code>sentinel</code>参数，当<code>iter</code>获得<code>sentinel</code>参数时，迭代停止。<br> 队列的方法可以需在<code>worker</code>函数中，将函数<code>func</code>的输入变为<code>*data</code>，将调用的函数<code>funcs</code>自定义为1个参数或者多个参数，这对于调用别人写好的函数非常方便，下面是使用队列的例子：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Queue

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> func<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>get<span class="token punctuation">,</span> <span class="token string">'STOP'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>data<span class="token punctuation">)</span>
        output<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">multi_process</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> iterable<span class="token punctuation">,</span> nworkers<span class="token punctuation">)</span><span class="token punctuation">:</span>
    NUMBER_OF_PROCESSES <span class="token operator">=</span> nworkers
    results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># Create queues</span>
    task_queue <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    done_queue <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Submit tasks</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> task <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>iterable<span class="token punctuation">)</span><span class="token punctuation">:</span>
        task_queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> func<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Start worker processes</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>NUMBER_OF_PROCESSES<span class="token punctuation">)</span><span class="token punctuation">:</span>
        Process<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>task_queue<span class="token punctuation">,</span> done_queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># get result</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>iterable<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>done_queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Tell child processes to stop</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>NUMBER_OF_PROCESSES<span class="token punctuation">)</span><span class="token punctuation">:</span>
        task_queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'STOP'</span><span class="token punctuation">)</span>

    <span class="token comment"># the results are unordered, so use original idx to recovery order</span>
    results<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> results<span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">funcs</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> x<span class="token operator">+</span>y

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
	multi_process<span class="token punctuation">(</span>funcs<span class="token punctuation">,</span> tqdm<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> \
	<span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
</code></pre> 
<p>在这个例子中，执行时间为5-6分钟，远超于普通计算与进程池，在观察中发现，对于1000w数据，将任务放到进程池中的速度为30w/s，而获取结果的速度为3w/s。</p> 
<h2><a id="_135"></a>总结</h2> 
<p>可以发现，当计算任务非常简单的时候，使用多进程带来的提升效果不明显，当任务数非常庞大的时候，应当选择进程池的方法提升效率，当任务数不大的时候，可以同时选择进程池与队列的方式。<br> 我在pypi上传了spft(standard python function tools)的包，可以简单快速的上手多进程任务，使用<code>pip install spft</code>可以下载，使用如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> spft<span class="token punctuation">.</span>multiprocess <span class="token keyword">import</span> multi_process
multi_process<span class="token punctuation">(</span>func<span class="token punctuation">,</span> iterable<span class="token punctuation">,</span> worker_num<span class="token punctuation">,</span> is_queue<span class="token punctuation">)</span>
</code></pre> 
<p><code>multi_process</code>可以自动匹配函数使用单参数或多参数，<code>is_queue</code>决定使用进程池或队列方式。</p> 
<h4><a id="Pypi_143"></a>Pypi的上传方式</h4> 
<p>首先运行<code>python setup.py sdist bdist_wheel</code>，在<code>dist</code>目录下生成<code>.whl</code>和<code>.gz</code>文件，然后确认是否下载twine包，<code>pip install twine</code>，接着运行<code>twine upload dist/*</code>即可。</p> 
<h2><a id="_2022824_145"></a>更新 2022.8.24</h2> 
<p>最近在使用库处理数据的时候，速度能够提升8倍，但是进度条显示有几个数据没有处理完，同时程序跑到最后不会终止，一开始我怀疑是多进程无法处理大量数据的情况，后来终于发现，原来数据中存在脏乱数据，使用单进程的时候，遇到错误的数据程序会exit，但不会报错，因此在多进程的处理过程中，一个进行挂掉了但不会影响其他进程的处理，但是挂掉的进程无法stop导致程序跑到最后不会终止</p> 
<h2><a id="_202291_147"></a>更新 2022.9.1</h2> 
<p>上述多进程的使用方法都是输入完整的数据，输出完整的句子。但是在日常使用过程中，我们会遇到数据量非常大，没办法全部载入到内存中的情况，同时我们也希望能够每次读取已经处理好的数据，也就是“生产者消费者原则”。因此我们希望设计一个多进程的生成器，能够实现对多进程中处理好的数据进行实时读取，方法如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">multi_process_generator</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> iterable<span class="token punctuation">,</span> worker_num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    :param func: 调用的函数
    :param iterable: 可迭代对象
    :param worker_num: 进程数量
    :yield: 处理好的结果
    """</span>
    <span class="token comment"># Create queues</span>
    task_queue <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    done_queue <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Submit tasks</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> task <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>iterable<span class="token punctuation">)</span><span class="token punctuation">:</span>
        task_queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> func<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Start worker processes</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>worker_num<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> func<span class="token punctuation">.</span>__code__<span class="token punctuation">.</span>co_argcount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            Process<span class="token punctuation">(</span>target<span class="token operator">=</span>worker_single<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>task_queue<span class="token punctuation">,</span> done_queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            Process<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>task_queue<span class="token punctuation">,</span> done_queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># get result</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>iterable<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> done_queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Tell child processes to stop</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>worker_num<span class="token punctuation">)</span><span class="token punctuation">:</span>
        task_queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'STOP'</span><span class="token punctuation">)</span>
</code></pre> 
<p>上述方法已经整合到spft-0.0.4版本中了，使用方法如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> spft<span class="token punctuation">.</span>multiprocess <span class="token keyword">import</span> multi_process<span class="token punctuation">,</span> multi_process_generator
<span class="token keyword">def</span> <span class="token function">funcs</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    y <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> x<span class="token operator">+</span>y
<span class="token keyword">for</span> data <span class="token keyword">in</span> multi_process_generator<span class="token punctuation">(</span>funcs<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="202298_191"></a>更新2022.9.8</h3> 
<p>对于9月1日更新的多进程生成器，存在一个缺陷，当数据量非常庞大时，不停的将数据塞入<code>task_queue</code>中会导致内存爆炸，物理机死机，因此我们需要限制<code>task_queue</code>队列中最多可以放置的数据个数，可以采用设置max_queue_size的方式，例如<code>task_queue = Queue(max_queue_size)</code></p> 
<h4><a id="n_193"></a>使用多进程时，模型与方法被重复进行了n次</h4> 
<p>在使用多进程的时候，明明只想构建模型一次，或者加载数据一次，但是每次都会运行和进程数一样的次数，甚至导致内存爆炸电脑奔溃。最近终于找到了原因，windows中对于没有<code>if __name__ == '__main__'</code>的方法，在使用多进程的时候都会启动n次，因为windows没有标识符，所以我们只需要把所以只想运行一次的程序放到我们设定的<code>__main__</code>标识符下面，将多进程调用的程序放到标识符外面，就可以在windows上顺利使用多进程进行加速了！</p> 
<h4><a id="frozon_support_195"></a>frozon_support问题</h4> 
<p>当我们不在标识符<code>__main__</code>下面运行程序的时候，程序会报<code>frozon_support</code>的问题，不过我们可以将多进程的方法写到一个函数中，然后再在标识符下面运行多进程函数，就可以避免这个问题了。</p> 
<h3><a id="202299_joblib_197"></a>更新2022.9.9 (joblib)</h3> 
<p>在使用一些函数的时候，我们希望使用<code>functional.partial</code>固定某些参数，并使用多进程去调用这些函数，传入指定的参数，在这种情况下，使用<code>multiprocess</code>可能就没这么方便了，但是可以使用<code>joblib</code>来进行多进程的使用</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> functools <span class="token keyword">import</span> partial
<span class="token keyword">from</span> joblib <span class="token keyword">import</span> Parallel<span class="token punctuation">,</span> delayed
process_fn <span class="token operator">=</span> partial<span class="token punctuation">(</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">,</span> url<span class="token operator">=</span><span class="token string">'http://0.0.0.0:8000/deploy'</span><span class="token punctuation">)</span>
Parallel<span class="token punctuation">(</span>n_jobs<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span>delayed<span class="token punctuation">(</span>process_fn<span class="token punctuation">)</span><span class="token punctuation">(</span>params<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'param'</span><span class="token punctuation">:</span> param<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">for</span> param <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>params<span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">'load param'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>通过joblib，我们可以轻松的指定params参数进行多进程的传输。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/73975302522f1dabe5bd49d99ae797fe/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">uni-app开发时对ios底部安全区域的控制</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/95530064943110fc3e3d7f012cbb384b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">TCP&amp;UDP</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>