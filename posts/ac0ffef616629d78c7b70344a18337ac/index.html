<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>利用FCN-32s,FCN-16s和FCN-8s训练自己制作的数据集 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="利用FCN-32s,FCN-16s和FCN-8s训练自己制作的数据集" />
<meta property="og:description" content="前言 之前写过一篇博客是制作自己的数据集利用FCN-32s模型训练，对FCN-16s和FCN-8s训练写的比较粗略，所以写这篇博客主要是补充FCN-16s和FCN-8s训练过程。
训练前准备 在使用fcn之前需要配置caffe环境，可以参考win10&#43;vs2013&#43;caffe&#43;gpu&#43;python环境配置这篇博客，对如何制作自己的数据集以及FCN-32s训练过程可以参考FCN制作自己的数据集并训练和测试这篇博客
训练过程 训练FCN-16s
如果你的fcn-32s模型训练好之后，会在路径D:\caffe\caffe-master\fcn-master\voc-fcn32s\snapshot（这是我fcn-master代码的路径）中看到train_iter_100000.caffemodel文件，这个文件就是FCN-32s模型权重。如果你的fcn-32s模型训练好之后，会在路径D:\caffe\caffe-master\fcn-master\voc-fcn32s\snapshot（这是我fcn-master代码的路径）中看到train_iter_100000.caffemodel文件，这个文件就是FCN-32s模型权重。
接着在fcn-master目录下找到所有py文件复制到voc-fcn16s文件夹中，同时新建文件夹snapshot
你的文件夹中可能没有deploy.prototxt文件，这里给出下载地址deploy，里面有两个文件，将deploy_fcn16.prototxt重命名为deploy.prototxt并复制到到voc-fcn16s文件夹中
用vs打开solver.prototxt文件，这里面是一些参数配置，由于我的图片较少，所以我把test_iter参数改为2,这个参数是指在测试时一次测试多少张图片。其他参数默认就行。
对于train.prototxt，val.prototxt和voc_layers.py三个文件修改的方法和训练fcn-32s时一模一样，所以参考上述的FCN制作自己的数据集并训练和测试的博客就行。
打开solve.py文件，修改代码为下
import caffe import surgery, score import numpy as np import os import sys sys.path.append(&#39;D:/caffe/caffe-master/python&#39;) try: import setproctitle setproctitle.setproctitle(os.path.basename(os.getcwd())) except: pass weights = &#39;D:/caffe/caffe-master/fcn-master/voc-fcn32s/snapshot1/train_iter_100000.caffemodel&#39; # init #caffe.set_device(int(sys.argv[1])) caffe.set_mode_gpu() caffe.set_device(0) solver = caffe.SGDSolver(&#39;solver.prototxt&#39;) solver.net.copy_from(weights) # surgeries interp_layers = [k for k in solver.net.params.keys() if &#39;up&#39; in k] surgery.interp(solver.net, interp_layers) # scoring val = np.loadtxt(&#39;D:/caffe/caffe-master/fcn-master/data/pascal/VOCdevkit/VOC2012/ImageSets/Segmentation/seg11valid.txt&#39;, dtype=str) for _ in range(25): solver." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/ac0ffef616629d78c7b70344a18337ac/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-11-18T18:46:24+08:00" />
<meta property="article:modified_time" content="2018-11-18T18:46:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">利用FCN-32s,FCN-16s和FCN-8s训练自己制作的数据集</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_1"></a>前言</h2> 
<p>之前写过一篇博客是制作自己的数据集利用FCN-32s模型训练，对FCN-16s和FCN-8s训练写的比较粗略，所以写这篇博客主要是补充FCN-16s和FCN-8s训练过程。</p> 
<h2><a id="_3"></a>训练前准备</h2> 
<p>在使用fcn之前需要配置caffe环境，可以参考<a href="https://blog.csdn.net/weixin_42795611/article/details/83691456">win10+vs2013+caffe+gpu+python环境配置</a>这篇博客，对如何制作自己的数据集以及FCN-32s训练过程可以参考<a href="https://blog.csdn.net/weixin_42795611/article/details/84073879">FCN制作自己的数据集并训练和测试</a>这篇博客</p> 
<h2><a id="_5"></a>训练过程</h2> 
<p>训练FCN-16s<br> 如果你的fcn-32s模型训练好之后，会在路径D:\caffe\caffe-master\fcn-master\voc-fcn32s\snapshot（这是我fcn-master代码的路径）中看到train_iter_100000.caffemodel文件，这个文件就是FCN-32s模型权重。如果你的fcn-32s模型训练好之后，会在路径D:\caffe\caffe-master\fcn-master\voc-fcn32s\snapshot（这是我fcn-master代码的路径）中看到train_iter_100000.caffemodel文件，这个文件就是FCN-32s模型权重。<br> <img src="https://images2.imgbox.com/32/7b/rfQJHmgR_o.png" alt="在这里插入图片描述"><br> 接着在fcn-master目录下找到所有py文件复制到voc-fcn16s文件夹中，同时新建文件夹snapshot<br> <img src="https://images2.imgbox.com/85/55/xsACctMv_o.png" alt="在这里插入图片描述"><br> 你的文件夹中可能没有deploy.prototxt文件，这里给出下载地址<a href="https://pan.baidu.com/s/13I0ccstv4WZcjowv7wdeTQ" rel="nofollow">deploy</a>，里面有两个文件，将deploy_fcn16.prototxt重命名为deploy.prototxt并复制到到voc-fcn16s文件夹中<br> <img src="https://images2.imgbox.com/60/89/1lFwzcgz_o.png" alt="在这里插入图片描述"><br> 用vs打开solver.prototxt文件，这里面是一些参数配置，由于我的图片较少，所以我把test_iter参数改为2,这个参数是指在测试时一次测试多少张图片。其他参数默认就行。<br> <img src="https://images2.imgbox.com/f5/fa/zPVCc5Sp_o.png" alt="在这里插入图片描述"><br> 对于train.prototxt，val.prototxt和voc_layers.py三个文件修改的方法和训练fcn-32s时一模一样，所以参考上述的<a href="https://blog.csdn.net/weixin_42795611/article/details/84073879">FCN制作自己的数据集并训练和测试</a>的博客就行。</p> 
<p>打开solve.py文件，修改代码为下</p> 
<pre><code>import caffe
import surgery, score

import numpy as np
import os
import sys
sys.path.append('D:/caffe/caffe-master/python')
try:
    import setproctitle
    setproctitle.setproctitle(os.path.basename(os.getcwd()))
except:
    pass

weights = 'D:/caffe/caffe-master/fcn-master/voc-fcn32s/snapshot1/train_iter_100000.caffemodel'

# init
#caffe.set_device(int(sys.argv[1]))
caffe.set_mode_gpu()
caffe.set_device(0)

solver = caffe.SGDSolver('solver.prototxt')
solver.net.copy_from(weights)


# surgeries
interp_layers = [k for k in solver.net.params.keys() if 'up' in k]
surgery.interp(solver.net, interp_layers)

# scoring
val = np.loadtxt('D:/caffe/caffe-master/fcn-master/data/pascal/VOCdevkit/VOC2012/ImageSets/Segmentation/seg11valid.txt', dtype=str)

for _ in range(25):
    solver.step(4000)
    score.seg_tests(solver, False, val, layer='score')
</code></pre> 
<p>到这所有准备工作都已结束，下面开始训练。<br> 在cmd命令窗口中，指定到fcn-master\voc-fcn16s目录下，输入python solve.py命令，如下所示。<br> <img src="https://images2.imgbox.com/a1/b4/dOjxXU3A_o.png" alt="在这里插入图片描述"><br> 等待漫长的训练后，在voc-fcn16s\snapshot目录下生成train_iter_100000.caffemodel文件<br> <img src="https://images2.imgbox.com/28/b1/ivtLmTrG_o.png" alt="在这里插入图片描述"></p> 
<p>测试单张图片<br> 打开infer.py文件，修改代码如下，其中data文件夹是我在voc-fcn16s目录下创建的，不是fcn-master目录下的data</p> 
<pre><code>import numpy as np
from PIL import Image

import caffe
import vis
import sys
sys.path.append('D:/caffe/caffe-master/python')

# the demo image is "2007_000129" from PASCAL VOC

# load image, switch to BGR, subtract mean, and make dims C x H x W for Caffe
im = Image.open('data/image.jpg')
in_ = np.array(im, dtype=np.float32)
in_ = in_[:,:,::-1]
in_ -= np.array((104.00698793,116.66876762,122.67891434))
in_ = in_.transpose((2,0,1))

# load net
net = caffe.Net('deploy.prototxt', 'snapshot/train_iter_100000.caffemodel', caffe.TEST)
# shape for input (data blob is N x C x H x W), set data
net.blobs['data'].reshape(1, *in_.shape)
net.blobs['data'].data[...] = in_
# run net and take argmax for prediction
net.forward()
out = net.blobs['score'].data[0].argmax(axis=0)

# visualize segmentation in PASCAL VOC colors
voc_palette = vis.make_palette(5)
out_im = Image.fromarray(vis.color_seg(out, voc_palette))
out_im.save('data/output.png')
masked_im = Image.fromarray(vis.vis_seg(im, out, voc_palette))
masked_im.save('data/visualization.jpg')
</code></pre> 
<p>到此所有的fcn-16s模型训练工作都已结束。</p> 
<p>训练FCN-16s用的是FCN-32s的权重，训练FCN-8s用的是FCN-16s的权重，所以对于FCN-8s模型的训练和FCN-16s训练的过程一模一样，所以在这就不在重复叙述了，如果又不懂的地方可以随时问我，我的邮箱是905885574@q.com，欢迎一起交流探讨。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f9479d7c0b282cb1c7a74cd7568631d6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JS中对于for循环中点击事件的理解（通俗版）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ec338aa575440df1e09269418a53d2c7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">WMI Provider Host</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>