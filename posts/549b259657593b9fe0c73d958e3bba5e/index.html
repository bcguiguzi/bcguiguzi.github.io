<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>协程学习笔记二 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="协程学习笔记二" />
<meta property="og:description" content="协程（二） ucontext setjmp和ucontext哪个更好
https://stackoverflow.com/questions/5536913/c-setjmp-h-and-ucontext-h-which-is-better
https://stackoverflow.com/questions/15014647/why-was-ucontext-added-to-and-then-removed-from-posix
代码学习 风云写的协程代码（不搬运了）
https://github.com/cloudwu/coroutine/
站在巨人肩膀 将风云的手动resume，改为loop发现风云的_save_stack()在编译参数-On下是有问题的，我改为整段stack保存我在树莓派的Makefile中运行的时候，要么coredump，要么栈错位，百思不得其解，还以为ucontext在aarch64兼容不好。其实就是上一个问题，我加了-O3，真是运气。然后发现了个问题，stack的占用不小，远远大于_save_stack()计算的差值，虽然在swapcontext前，只拷贝那一小段，但是stack之后的数据会自己填充。（至于为什么，我也不清楚，寻找答案中…）关于makecontext后面的可变参数类型，虽然说是int，但64位的平台也支持指针
https://man7.org/linux/man-pages/man3/swapcontext.3.html On architectures where int and pointer types are the same size (e.g., x86-32, where both types are 32 bits), you may be able to get away with passing pointers as arguments to makecontext() following argc. However, doing this is not guaranteed to be portable, is undefined according to the standards, and won&#39;t work on architectures where pointers are larger than ints." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/549b259657593b9fe0c73d958e3bba5e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-07T11:35:38+08:00" />
<meta property="article:modified_time" content="2022-05-07T11:35:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">协程学习笔记二</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_1"></a>协程（二）</h2> 
<h4><a id="ucontext_3"></a>ucontext</h4> 
<p>setjmp和ucontext哪个更好<br> <a href="https://stackoverflow.com/questions/5536913/c-setjmp-h-and-ucontext-h-which-is-better" rel="nofollow">https://stackoverflow.com/questions/5536913/c-setjmp-h-and-ucontext-h-which-is-better</a><br> <a href="https://stackoverflow.com/questions/15014647/why-was-ucontext-added-to-and-then-removed-from-posix" rel="nofollow">https://stackoverflow.com/questions/15014647/why-was-ucontext-added-to-and-then-removed-from-posix</a></p> 
<h4><a id="_8"></a>代码学习</h4> 
<p>风云写的协程代码（不搬运了）<br> <a href="https://github.com/cloudwu/coroutine/">https://github.com/cloudwu/coroutine/</a></p> 
<h4><a id="_12"></a>站在巨人肩膀</h4> 
<ol><li>将风云的手动resume，改为loop</li><li>发现风云的_save_stack()在编译参数-On下是有问题的，我改为整段stack保存</li><li>我在树莓派的Makefile中运行的时候，要么coredump，要么栈错位，百思不得其解，还以为ucontext在aarch64兼容不好。其实就是上一个问题，我加了-O3，真是运气。然后发现了个问题，stack的占用不小，远远大于_save_stack()计算的差值，虽然在swapcontext前，只拷贝那一小段，但是stack之后的数据会自己填充。（至于为什么，我也不清楚，寻找答案中…）</li><li>关于makecontext后面的可变参数类型，虽然说是int，但64位的平台也支持指针<br> <a href="https://man7.org/linux/man-pages/man3/swapcontext.3.html" rel="nofollow">https://man7.org/linux/man-pages/man3/swapcontext.3.html</a></li></ol> 
<pre><code>On architectures where int and pointer types are the same size
(e.g., x86-32, where both types are 32 bits), you may be able to
get away with passing pointers as arguments to makecontext()
following argc.  However, doing this is not guaranteed to be
portable, is undefined according to the standards, and won't work
on architectures where pointers are larger than ints.
Nevertheless, starting with version 2.8, glibc makes some changes
to makecontext(), to permit this on some 64-bit architectures
(e.g., x86-64).
</code></pre> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ucontext.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"queue.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">COROUTINE_DEAD</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">COROUTINE_INIT</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">COROUTINE_READY</span> <span class="token expression"><span class="token number">2</span></span></span>

<span class="token keyword">struct</span> <span class="token class-name">_schedule</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">_coroutine</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>coroutine_func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_schedule</span><span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_schedule</span><span class="token punctuation">{<!-- --></span>
	<span class="token class-name">ucontext_t</span> main<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> nco<span class="token punctuation">;</span>
    <span class="token class-name">queue_t</span> ready<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> size<span class="token punctuation">;</span> 
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> stack<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>schedule<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
	coroutine_func func<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">;</span>
    <span class="token keyword">int</span> status<span class="token punctuation">;</span>
	<span class="token class-name">ucontext_t</span> ctx<span class="token punctuation">;</span>
    <span class="token class-name">queue_t</span> node<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> stack<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>coroutine<span class="token punctuation">;</span>

schedule <span class="token operator">*</span> <span class="token function">coroutine_open</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	schedule <span class="token operator">*</span>S <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>schedule<span class="token punctuation">)</span> <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// size不可过小</span>
    S<span class="token operator">-&gt;</span>nco <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    S<span class="token operator">-&gt;</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>
	<span class="token function">queue_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token operator">-&gt;</span>ready<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> S<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">coroutine_new</span><span class="token punctuation">(</span>schedule <span class="token operator">*</span>S<span class="token punctuation">,</span> coroutine_func func<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    coroutine <span class="token operator">*</span>co <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>coroutine<span class="token punctuation">)</span> <span class="token operator">+</span> S<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    co<span class="token operator">-&gt;</span>func <span class="token operator">=</span> func<span class="token punctuation">;</span>
    co<span class="token operator">-&gt;</span>arg <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    co<span class="token operator">-&gt;</span>status <span class="token operator">=</span> COROUTINE_INIT<span class="token punctuation">;</span>
    <span class="token function">queue_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>co<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">queue_insert_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token operator">-&gt;</span>ready<span class="token punctuation">,</span><span class="token operator">&amp;</span>co<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    S<span class="token operator">-&gt;</span>nco<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// void</span>
<span class="token comment">// _save_stack(struct coroutine *C, char *top) {<!-- --></span>
<span class="token comment">// 	char dummy = 0;</span>
<span class="token comment">// 	assert(top - &amp;dummy &lt;= STACK_SIZE);</span>
<span class="token comment">//     printf("store %lu\n",top - &amp;dummy);</span>
<span class="token comment">//     if(top - &amp;dummy &gt; C-&gt;stackcap){<!-- --></span>
<span class="token comment">//         free(C-&gt;stack);</span>
<span class="token comment">//         C-&gt;stackcap = top - &amp;dummy;</span>
<span class="token comment">//         C-&gt;stack = malloc(C-&gt;stackcap);</span>
<span class="token comment">//     }</span>
<span class="token comment">//     C-&gt;stacksize = top - &amp;dummy;</span>
<span class="token comment">// 	memcpy(C-&gt;stack, &amp;dummy, C-&gt;stacksize);</span>
<span class="token comment">// }</span>

<span class="token keyword">void</span> <span class="token function">coroutine_yield</span><span class="token punctuation">(</span> schedule <span class="token operator">*</span> S<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">queue_t</span> <span class="token operator">*</span>node <span class="token operator">=</span> <span class="token function">queue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token operator">-&gt;</span>ready<span class="token punctuation">)</span><span class="token punctuation">;</span>
    coroutine <span class="token operator">*</span>co <span class="token operator">=</span> <span class="token function">queue_data</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span>coroutine<span class="token punctuation">,</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">queue_remove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>co<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// _save_stack(co,S-&gt;stack+STACK_SIZE); // 实际数据不只这么少，可以打印S的stack看看，但是swapcontext后却会填充...</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>co<span class="token operator">-&gt;</span>stack<span class="token punctuation">,</span>S<span class="token operator">-&gt;</span>stack<span class="token punctuation">,</span>S<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    co<span class="token operator">-&gt;</span>status <span class="token operator">=</span> COROUTINE_READY<span class="token punctuation">;</span>
    <span class="token function">queue_insert_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token operator">-&gt;</span>ready<span class="token punctuation">,</span><span class="token operator">&amp;</span>co<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">swapcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>co<span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span><span class="token operator">&amp;</span>S<span class="token operator">-&gt;</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">resume_handle</span><span class="token punctuation">(</span>schedule <span class="token operator">*</span>S<span class="token punctuation">,</span> coroutine <span class="token operator">*</span>co<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    co<span class="token operator">-&gt;</span><span class="token function">func</span><span class="token punctuation">(</span>S<span class="token punctuation">,</span>co<span class="token operator">-&gt;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">queue_remove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>co<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    co<span class="token operator">-&gt;</span>status <span class="token operator">=</span> COROUTINE_DEAD<span class="token punctuation">;</span>
    <span class="token function">queue_insert_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token operator">-&gt;</span>ready<span class="token punctuation">,</span><span class="token operator">&amp;</span>co<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">coroutine_loop</span><span class="token punctuation">(</span>schedule <span class="token operator">*</span>S<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>S<span class="token operator">-&gt;</span>nco<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">queue_t</span> <span class="token operator">*</span>node <span class="token operator">=</span> <span class="token function">queue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token operator">-&gt;</span>ready<span class="token punctuation">)</span><span class="token punctuation">;</span>
        coroutine <span class="token operator">*</span>co <span class="token operator">=</span> <span class="token function">queue_data</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span>coroutine<span class="token punctuation">,</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>co<span class="token operator">-&gt;</span>status<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> COROUTINE_INIT<span class="token operator">:</span>
            <span class="token function">getcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>co<span class="token operator">-&gt;</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            co<span class="token operator">-&gt;</span>ctx<span class="token punctuation">.</span>uc_stack<span class="token punctuation">.</span>ss_sp <span class="token operator">=</span> S<span class="token operator">-&gt;</span>stack<span class="token punctuation">;</span>
            co<span class="token operator">-&gt;</span>ctx<span class="token punctuation">.</span>uc_stack<span class="token punctuation">.</span>ss_size <span class="token operator">=</span> S<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
            co<span class="token operator">-&gt;</span>ctx<span class="token punctuation">.</span>uc_link <span class="token operator">=</span> <span class="token operator">&amp;</span>S<span class="token operator">-&gt;</span>main<span class="token punctuation">;</span>

            <span class="token function">makecontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>co<span class="token operator">-&gt;</span>ctx<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>resume_handle<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>S<span class="token punctuation">,</span>co<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">swapcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token operator">-&gt;</span>main<span class="token punctuation">,</span><span class="token operator">&amp;</span>co<span class="token operator">-&gt;</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> COROUTINE_READY<span class="token operator">:</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>S<span class="token operator">-&gt;</span>stack<span class="token punctuation">,</span>co<span class="token operator">-&gt;</span>stack<span class="token punctuation">,</span>S<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">swapcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>S<span class="token operator">-&gt;</span>main<span class="token punctuation">,</span><span class="token operator">&amp;</span>co<span class="token operator">-&gt;</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">queue_remove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>co<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>co<span class="token punctuation">)</span><span class="token punctuation">;</span>
            S<span class="token operator">-&gt;</span>nco<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">coroutine_close</span><span class="token punctuation">(</span>schedule <span class="token operator">*</span>S<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">free</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">func1</span><span class="token punctuation">(</span>schedule<span class="token operator">*</span> S<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s %d\n"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">coroutine_yield</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">func2</span><span class="token punctuation">(</span>schedule<span class="token operator">*</span> S<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s %d\n"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">coroutine_yield</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    schedule <span class="token operator">*</span> sched <span class="token operator">=</span> <span class="token function">coroutine_open</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">coroutine_new</span><span class="token punctuation">(</span>sched<span class="token punctuation">,</span>func1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">coroutine_new</span><span class="token punctuation">(</span>sched<span class="token punctuation">,</span>func2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">coroutine_loop</span><span class="token punctuation">(</span>sched<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">coroutine_close</span><span class="token punctuation">(</span>sched<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="_178"></a>未完待续</h4> 
<p>看看怎么整合epoll…</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bff544ebd2653caf9c3c13f1ca3b62a7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Idea重启后保存的密码失效</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cac7df06ef0dba7bf4b7d4a153904102/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【修复收藏功能、更新登录接口】知识付费小程序、博客小程序、完整版开源源码、资源变现小程序</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>