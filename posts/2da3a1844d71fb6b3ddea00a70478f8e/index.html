<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>docker搭建nextcloud私有云盘 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="docker搭建nextcloud私有云盘" />
<meta property="og:description" content="知识背景 nextcloud是ownCloud原先的开发者弗兰克·卡利切离开以后创建了ownCloud的分支——Nextcloud。
NextCloud 是一款开源网络硬盘系统。任何人都可以自由的获取 NextCloud 程序，在家庭或公司构建私有且免费的网络硬盘。它是完全由你用户控制的私有、安全且功能完整的文件同步与共享解决方案。
下边开始介绍docker-compose安装nextcloud服务
安装docker和docker-compose docker安装链接：https://docs.docker.com/install/linux/docker-ce/centos/
docker-compose安装链接：https://docs.docker.com/compose/install/
编写docker-compose文件 version: &#39;2&#39; services: db: container_name: cloud_db image: mysql:5.7 volumes: - /var/data/cloud/mysql:/var/lib/mysql - /etc/localtime:/etc/localtime environment: MYSQL_ROOT_PASSWORD: nextcloud MYSQL_DATABASE: nextcloud nextcloud: container_name: cloud_web depends_on: - db image: nextcloud volumes: - /var/data/cloud/config:/var/www/html/config - /var/data/cloud/data:/var/www/html/data - /var/data/cloud/apps:/var/www/html/apps ports: - &#34;8090:80&#34; onlyoffice: container_name: cloud_office image: onlyoffice/documentserver ports: - &#34;9100:80&#34; networks: default: external: name: nextcloud 创建存放文件的路径，我这里是/var/data/cloud
执行前创建nextcloud网卡
docker network create nextcloud 启动容器服务,启动过程比较慢需要下载镜像，可以再执行前吧需要的镜像下载下来，过程不需要再赘述。
docker-compose up -d 服务启动以后，开始初始化nextcloud服务" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/2da3a1844d71fb6b3ddea00a70478f8e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-03T13:18:23+08:00" />
<meta property="article:modified_time" content="2020-03-03T13:18:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">docker搭建nextcloud私有云盘</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2> <strong>知识背景</strong></h2> 
<p>nextcloud是ownCloud原先的开发者弗兰克·卡利切离开以后创建了ownCloud的分支——Nextcloud。</p> 
<p>NextCloud 是一款开源网络硬盘系统。任何人都可以自由的获取 NextCloud 程序，在家庭或公司构建私有且免费的网络硬盘。它是完全由你用户控制的私有、安全且功能完整的文件同步与共享解决方案。</p> 
<p>下边开始介绍docker-compose安装nextcloud服务</p> 
<h2>安装docker和docker-compose</h2> 
<p>docker安装链接：<a href="https://docs.docker.com/install/linux/docker-ce/centos/" rel="nofollow">https://docs.docker.com/install/linux/docker-ce/centos/</a></p> 
<p>docker-compose安装链接：<a href="https://docs.docker.com/compose/install/" rel="nofollow">https://docs.docker.com/compose/install/</a></p> 
<h2>编写docker-compose文件</h2> 
<pre><code class="language-bash">version: '2'  
services:  
  db:  
    container_name: cloud_db  
    image: mysql:5.7
    volumes:  
      - /var/data/cloud/mysql:/var/lib/mysql
      - /etc/localtime:/etc/localtime 
    environment:  
      MYSQL_ROOT_PASSWORD: nextcloud
      MYSQL_DATABASE: nextcloud  
  nextcloud:  
    container_name: cloud_web  
    depends_on:  
      - db  
    image: nextcloud  
    volumes:  
      - /var/data/cloud/config:/var/www/html/config  
      - /var/data/cloud/data:/var/www/html/data  
      - /var/data/cloud/apps:/var/www/html/apps  
    ports:  
      - "8090:80"  
  onlyoffice:
    container_name: cloud_office
    image: onlyoffice/documentserver
    ports:
      - "9100:80"
networks:  
  default:  
    external:  
      name: nextcloud </code></pre> 
<p>创建存放文件的路径，我这里是/var/data/cloud</p> 
<p>执行前创建nextcloud网卡</p> 
<pre><code>docker network create nextcloud</code></pre> 
<p>启动容器服务,启动过程比较慢需要下载镜像，可以再执行前吧需要的镜像下载下来，过程不需要再赘述。</p> 
<pre><code>docker-compose up -d</code></pre> 
<p>服务启动以后，开始初始化nextcloud服务</p> 
<p>浏览器访问：<u>http://ip：端口  </u>（我这里是http://192.168.0.150:8090）</p> 
<p><img alt="" src="https://images2.imgbox.com/5e/22/7da1NpBr_o.png"></p> 
<p>登录以后是这个界面，选择存储&amp;数据库，我们这里使用的是mysqll数据库</p> 
<p>按照选项内容填写完整</p> 
<p><u>用户名：admin</u></p> 
<p><u>密码：nextcloud</u></p> 
<p><u>数据目录选择默认：/var/www/html/data</u></p> 
<p><u>数据库密码：nextcloud</u></p> 
<p><u>数据库实例：nextcloud</u></p> 
<p><u>端口：db（因为我们docker-compose文件里写的数据库服务是db）</u></p> 
<p>填写完整以后开始进行初始化，需要等待几分钟。</p> 
<p>初始化完成以后就可以使用创建的账号登录，到此服务基本安装完成。</p> 
<p> </p> 
<h2>安装onlyoffice应用，可以在线操作word等文件</h2> 
<p>下载onlyoffice应用：<a href="https://apps.nextcloud.com/apps/onlyoffice/releases?platform=18#18" rel="nofollow">https://apps.nextcloud.com/apps/onlyoffice/releases?platform=18#18</a></p> 
<p>我这里安装的是nextcloud18，选择的ONLYOFFICE 4.1.4下载。</p> 
<p>把下载好的文件放到/var/data/cloud/apps 下边</p> 
<p>解压缩：tar -zxvf  /var/data/cloud/apps/onlyoffice.tar.gz</p> 
<p>进入nextcloud容器修改onlyoffice的文件用户和所属组</p> 
<pre><code>docker-compose exec nextcloud bash
切换到apps文件下
root@766c5b93dbb4:/var/www/html# cd apps/
查看下边文件所属用户和组
root@766c5b93dbb4:/var/www/html/apps# ls -l
total 0
drwxr-xr-x 11 www-data root 122 Mar  1 18:44 accessibility
drwxr-xr-x 10 www-data root 181 Mar  2 10:33 activity
drwxr-xr-x  5 www-data root  48 Mar  1 18:44 admin_audit
drwxr-xr-x  5 www-data root  63 Mar  2 10:33 cloud_federation_api
drwxr-xr-x  8 www-data root  97 Mar  2 10:33 comments
drwxr-xr-x 10 www-data root 109 Mar  1 18:44 dav
drwxr-xr-x 10 www-data root 109 Mar  1 18:44 encryption
drwxr-xr-x 10 www-data root 109 Mar  1 18:44 federatedfilesharing
drwxr-xr-x 10 www-data root 109 Mar  1 18:44 federation
drwxr-xr-x 11 www-data root 181 Mar  2 10:33 files
drwxr-xr-x 11 www-data root 137 Mar  2 10:33 files_external
drwxr-xr-x  9 www-data root  95 Mar  1 18:44 files_pdfviewer
drwxr-xr-x  7 www-data root 123 Mar  2 10:33 files_rightclick
drwxr-xr-x 10 www-data root 143 Mar  2 10:33 files_sharing
drwxr-xr-x  9 www-data root 114 Mar  2 10:33 files_trashbin
drwxr-xr-x  8 www-data root  81 Mar  1 18:45 files_versions
drwxr-xr-x  6 www-data root  75 Mar  2 10:33 files_videoplayer
drwxr-xr-x  9 www-data root 112 Mar  2 10:33 firstrunwizard
drwxr-xr-x 12 www-data root 207 Mar  2 10:33 logreader
drwxr-xr-x  5 www-data root  48 Mar  1 18:45 lookup_server_connector
drwxr-xr-x  8 www-data root  97 Mar  2 10:33 nextcloud_announcements
drwxr-xr-x  9 www-data root 143 Mar  2 10:33 notifications
drwxr-xr-x  8 www-data root  87 Mar  1 18:45 oauth2
drwxrwxr-x 13 root root 230 Jan 28 10:27 onlyoffice
drwxr-xr-x 10 www-data root 121 Mar  2 10:33 password_policy
drwxr-xr-x 10 www-data root 237 Mar  2 10:33 photos
drwxr-xr-x  9 www-data root 263 Mar  2 10:33 privacy
drwxr-xr-x  6 www-data root  59 Mar  1 18:45 provisioning_api
drwxr-xr-x  6 www-data root 111 Mar  2 10:33 recommendations
drwxr-xr-x  9 www-data root 146 Mar  2 10:33 serverinfo
drwxr-xr-x 10 www-data root 109 Mar  1 18:45 settings
drwxr-xr-x 10 www-data root 109 Mar  1 18:45 sharebymail
drwxr-xr-x 10 www-data root 110 Mar  1 18:45 support
drwxr-xr-x  9 www-data root 133 Mar  2 10:33 survey_client
drwxr-xr-x 10 www-data root 125 Mar  2 10:33 systemtags
drwxr-xr-x  9 www-data root 258 Mar  2 10:33 text
drwxr-xr-x  9 www-data root  93 Mar  1 18:45 theming
drwxr-xr-x  9 www-data root  98 Mar  1 18:45 twofactor_backupcodes
drwxr-xr-x  9 www-data root  98 Mar  1 18:45 updatenotification
drwxr-xr-x 12 www-data root 135 Mar  1 18:45 user_ldap
drwxr-xr-x  7 www-data root 165 Mar  2 10:33 viewer
drwxr-xr-x  9 www-data root  98 Mar  1 18:45 workflowengine
按照原有的文件所属用户和组修改
chown -R www-data:root onlyoffice/
</code></pre> 
<p>然后访问服务，点击设置会在设置组里出现一个onlyoffice的节点，输入我们已经创建好的onlyoffice文件服务地址，保存即可</p> 
<p><img alt="" height="914" src="https://images2.imgbox.com/ab/f2/Qd2UXKWE_o.png" width="1200"></p> 
<p>然后我们就可以在线操作word等文件了</p> 
<p><img alt="" height="914" src="https://images2.imgbox.com/19/ce/tvjNmsK7_o.png" width="1200"></p> 
<p> </p> 
<p>nginx反向代理nextcloud</p> 
<p>我这边是单独启动了一个nginx的容器</p> 
<p>配置文件：nextcloud.conf<br>  </p> 
<pre><code>server {
        listen 443 ssl;  # 1.1版本后这样写
        server_name cloud.miumiu.com; #填写绑定证书的域名
        ssl_certificate /etc/nginx/ssl/www.miumiu.com.crt;  # 指定证书的位置，绝对路径
        ssl_certificate_key /etc/nginx/ssl/www.miumiu.com.key;  # 绝对路径，同上
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2; #按照这个协议配置
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;#按照这个套件配置
        ssl_prefer_server_ciphers on;
        location / {
        proxy_redirect off;
        proxy_set_header Host $host:$server_port;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_pass  http://192.168.0.150:8090;
        }
    }</code></pre> 
<p>容器启动以后直接访问：https://cloud.miumiu.com</p> 
<p>浏览器显示不能访问，这是需要修改一下nextcloud的配置文件：config.php</p> 
<p>添加以下参数：</p> 
<pre><code>  'overwriteprotocol' =&gt; 'https',
  'trusted_domains' =&gt;
  array (
   0 =&gt; '192.168.0.150:8090',
   1 =&gt; 'cloud.miumiu.com', #手动添加域名
  ),
</code></pre> 
<p>重启一下nextcloud服务以后就可以正常访问了</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bdc7b6b70a0a40bc5b17437b0ff5a07b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决Servlet4.0 注解匹配404问题 IDEA版</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cf12ea4b0a003a5d87783aa2a16461e5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">编译Filecoin</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>