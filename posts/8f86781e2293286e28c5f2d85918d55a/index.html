<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Retrofit2基础使用与解析：从使用步骤深入分析源码 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Retrofit2基础使用与解析：从使用步骤深入分析源码" />
<meta property="og:description" content="使用步骤 步骤一 添加依赖、权限 dependencies { compile &#39;com.squareup.retrofit2:retrofit:2.0.2&#39; // Retrofit库 compile &#39;com.squareup.okhttp3:okhttp:3.1.2&#39; // Okhttp库 } 联网权限：
&lt;uses-permission android:name=&#34;android.permission.INTERNET&#34;/&gt; 步骤二 创建接收数据实体类 public class Reception { ... } 依据服务器返回的数据，建造实体类承载数据
步骤三 创建网络请求接口 public interface GetRequest_Interface { @GET(&#34;openapi.do?keyfrom=Yanzhikai&amp;key=2032414398&amp;type=data&amp;doctype=json&amp;version=1.1&amp;q=car&#34;) Call&lt;Translation&gt; 接口方法(); } 使用注解进行请求方式、参数的设置。
方法的返回值默认使用Call&lt;数据实体类&gt;。（使用RxJava时用Observable&lt;实体类&gt;）
步骤四 创建Retrofit实例 Retrofit retrofit = new Retrofit.Builder() .baseUrl(&#34;http://fanyi.youdao.com/&#34;) // 网络请求基础Url地址 .addConverterFactory(GsonConverterFactory.create()) // 数据解析器 .addCallAdapterFactory(RxJavaCallAdapterFactory.create()) // 网络请求适配器 .build(); 步骤五 创建网络请求接口实例 // 创建 网络请求接口 的实例 GetRequest_Interface request = retrofit.create(GetRequest_Interface.class); //对 发送请求 进行封装 Call&lt;Reception&gt; call = request." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/8f86781e2293286e28c5f2d85918d55a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-15T17:05:55+08:00" />
<meta property="article:modified_time" content="2022-06-15T17:05:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Retrofit2基础使用与解析：从使用步骤深入分析源码</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>使用步骤</h3> 
<h4><a id="__1"></a>步骤一 添加依赖、权限</h4> 
<pre><code class="prism language-java">dependencies <span class="token punctuation">{<!-- --></span>
    compile 'com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>retrofit2<span class="token operator">:</span>retrofit<span class="token operator">:</span><span class="token number">2.0</span><span class="token number">.2</span>'
    <span class="token comment">// Retrofit库</span>
    compile 'com<span class="token punctuation">.</span>squareup<span class="token punctuation">.</span>okhttp3<span class="token operator">:</span>okhttp<span class="token operator">:</span><span class="token number">3.1</span><span class="token number">.2</span>'
    <span class="token comment">// Okhttp库</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>联网权限：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.INTERNET<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> 
<h4><a id="__15"></a>步骤二 创建接收数据实体类</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Reception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>依据服务器返回的数据，建造实体类承载数据</p> 
<h4><a id="__23"></a>步骤三 创建网络请求接口</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GetRequest_Interface</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@GET</span><span class="token punctuation">(</span><span class="token string">"openapi.do?keyfrom=Yanzhikai&amp;key=2032414398&amp;type=data&amp;doctype=json&amp;version=1.1&amp;q=car"</span><span class="token punctuation">)</span>
    <span class="token class-name">Call</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Translation</span><span class="token punctuation">&gt;</span></span>  接口方法<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用注解进行请求方式、参数的设置。<br> 方法的返回值默认使用Call&lt;数据实体类&gt;。（使用RxJava时用Observable&lt;实体类&gt;）</p> 
<h4><a id="_Retrofit_33"></a>步骤四 创建Retrofit实例</h4> 
<pre><code class="prism language-java"> <span class="token class-name">Retrofit</span> retrofit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Retrofit<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span><span class="token string">"http://fanyi.youdao.com/"</span><span class="token punctuation">)</span> <span class="token comment">// 网络请求基础Url地址</span>
                <span class="token punctuation">.</span><span class="token function">addConverterFactory</span><span class="token punctuation">(</span><span class="token class-name">GsonConverterFactory</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 数据解析器</span>
                <span class="token punctuation">.</span><span class="token function">addCallAdapterFactory</span><span class="token punctuation">(</span><span class="token class-name">RxJavaCallAdapterFactory</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 网络请求适配器</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="__42"></a>步骤五 创建网络请求接口实例</h4> 
<pre><code class="prism language-java"><span class="token comment">// 创建 网络请求接口 的实例</span>
<span class="token class-name">GetRequest_Interface</span> request <span class="token operator">=</span> retrofit<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">GetRequest_Interface</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//对 发送请求 进行封装</span>
<span class="token class-name">Call</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Reception</span><span class="token punctuation">&gt;</span></span> call <span class="token operator">=</span> request<span class="token punctuation">.</span>接口方法名<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>调用retrofit.create方法获取请求接口的实体类，调用该实体类方法即可对请求进行封装。</p> 
<h4><a id="__52"></a>步骤六 发出网络请求</h4> 
<pre><code class="prism language-java"><span class="token comment">//发送网络请求(异步)</span>
call<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Translation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//请求成功时回调</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token class-name">Call</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Translation</span><span class="token punctuation">&gt;</span></span> call<span class="token punctuation">,</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Translation</span><span class="token punctuation">&gt;</span></span> response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//请求处理,输出结果</span>
        response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//请求失败时候的回调</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">Call</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Translation</span><span class="token punctuation">&gt;</span></span> call<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"连接失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 发送网络请求（同步）</span>
<span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Reception</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> call<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>使用生成的call，分别调用enqueue、execute进行异步、同步请求。</p> 
<h4><a id="__75"></a>步骤七 处理返回的数据</h4> 
<pre><code class="prism language-java">response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>使用数据response进行数据处理。</p> 
<h3><a id="_82"></a>逐步骤进行源码分析</h3> 
<h4><a id="_retrofit_83"></a>步骤四 创建retrofit实例</h4> 
<pre><code class="prism language-java"> <span class="token class-name">Retrofit</span> retrofit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Retrofit<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span><span class="token string">"http://xxx.xxx.xxx/"</span><span class="token punctuation">)</span> <span class="token comment">// 网络请求基础Url地址</span>
                <span class="token punctuation">.</span><span class="token function">addConverterFactory</span><span class="token punctuation">(</span><span class="token class-name">GsonConverterFactory</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 数据解析器</span>
                <span class="token punctuation">.</span><span class="token function">addCallAdapterFactory</span><span class="token punctuation">(</span><span class="token class-name">RxJavaCallAdapterFactory</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 网络请求适配器</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>可以看出实例是使用建造者模式创建的，由用户传入一些基础设置参数后，即可build目标实例</p> 
<h5><a id="new_RetrofitRetrofit_92"></a>new Retrofit：Retrofit类</h5> 
<p>深入Retrofit类内部看它的成员，分析作用。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Retrofit</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">ServiceMethod</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> serviceMethodCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Call<span class="token punctuation">.</span>Factory</span> callFactory<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">HttpUrl</span> baseUrl<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Converter<span class="token punctuation">.</span>Factory</span><span class="token punctuation">&gt;</span></span> converterFactories<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CallAdapter<span class="token punctuation">.</span>Factory</span><span class="token punctuation">&gt;</span></span> callAdapterFactories<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Executor</span> callbackExecutor<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token keyword">boolean</span> validateEagerly<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><code>Map&lt;Method, ServiceMethod&lt;?, ?&gt;&gt; serviceMethodCache</code>：用于存储ServiceMethod，即依据接口生成的网络请求方法。（此处与学习的博客用的数据博客发生变化，我的版本用ConcurrentHashMap，而参考博客版本用的LinkedHashMap）<br> <code>okhttp3.Call.Factory callFactory</code>：生成网络请求器的工厂（生产Call）<br> <code>HttpUrl baseUrl</code>：网络请求的基础Url地址<br> <code>List&lt;Converter.Factory&gt; converterFactories</code>：数据转换器工厂集合（生产Converter）<br> <code>List&lt;CallAdapter.Factory&gt; callAdapterFactories</code>：网络请求适配器工厂集合（生产CallAdapter，用于将底层使用的OkHttpCall转换成适应于不同平台的网络请求器）<br> <code>Executor callbackExecutor</code>：回调方法执行器<br> <code>boolean validateEagerly</code>：标记是否需要提前对接口注解进行验证转换<br> 此处多次使用工厂模式，工厂模式可以自动生成对应对象（产品），用户无需再关心生成过程，可以将心思放到流程开发上。</p> 
<h5><a id="new_RetrofitBuilderBuilder_115"></a>new Retrofit.Builder()：Builder类</h5> 
<p><strong>成员</strong></p> 
<pre><code class="prism language-java"> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Builder</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Platform</span> platform<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Call<span class="token punctuation">.</span>Factory</span> callFactory<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">HttpUrl</span> baseUrl<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Converter<span class="token punctuation">.</span>Factory</span><span class="token punctuation">&gt;</span></span> converterFactories <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CallAdapter<span class="token punctuation">.</span>Factory</span><span class="token punctuation">&gt;</span></span> callAdapterFactories <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Executor</span> callbackExecutor<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> validateEagerly<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>Builder类的成员和Retrofit类是对应的，多了一个platform成员</p> 
<p><strong>实例化过程</strong><br> 第一步调用无参构造，内部又调用<code>Builder(Platform platform)</code>有参构造实现</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Platform</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>深入Platform类：</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Platform</span> PLATFORM <span class="token operator">=</span> <span class="token function">findPlatform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token class-name">Platform</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> PLATFORM<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用单例模式进行参数获取。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Platform</span> <span class="token function">findPlatform</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.os.Build"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Build</span><span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Android</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.util.Optional"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Java8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Platform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>借助Java反射完成对当前平台的识别，提供不同的实例，安卓使用返回<code>new Android()</code></p> 
<p><strong>继续深入Android类</strong></p> 
<pre><code class="prism language-java">  <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Android</span> <span class="token keyword">extends</span> <span class="token class-name">Platform</span> 
</code></pre> 
<p>该类是Platform的内部类</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">defaultCallbackExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>设置默认的回调方法执行器，主要用于在主、子线程切换，将请求数据返回到主UI线程进行方法回调</p> 
<pre><code class="prism language-java">    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MainThreadExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">Executor</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Handler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        handler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>该默认执行器保存主线程的handler，使用post方法切换到主线程进行回调</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span> <span class="token class-name">CallAdapter<span class="token punctuation">.</span>Factory</span> <span class="token function">defaultCallAdapterFactory</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Executor</span> callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackExecutor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorCallAdapterFactory</span><span class="token punctuation">(</span>callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>创建默认网络请求适配器，所需执行器参数，以便后续请求完成后，在对应执行器上回调。</p> 
<p>上述流程主要是依据安卓平台进行线程切换以完成子青丘县城完成后到主UI线程的回调。（切换是先由ExecutorCallAdapterFactory获取请求器Call，调用该Call的请求方法内部调用了传入的执行器Executor的回调execute方法）</p> 
<p>到此处platform获取完成，再看调用的Builder有参构造方法：</p> 
<pre><code class="prism language-java"><span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token class-name">Platform</span> platform<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>platform <span class="token operator">=</span> platform<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>将获取的参数设置到Builder内。<br> 至此Builder初始化完成，其内部配置了默认Android平台数据、默认网络请求适配器工厂defaultCallAdapterFactory（用于将默认Call再次封装）、给converterFactories和callAdapterFactories创建容器。</p> 
<h5><a id="baseUrl_210"></a>.baseUrl(“”)</h5> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">baseUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> baseUrl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">checkNotNull</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">,</span> <span class="token string">"baseUrl == null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">HttpUrl</span> httpUrl <span class="token operator">=</span> <span class="token class-name">HttpUrl</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>httpUrl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Illegal URL: "</span> <span class="token operator">+</span> baseUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">baseUrl</span><span class="token punctuation">(</span>httpUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>第一步将字符串参数转换为适合OkHttp的Url格式，将该Url传入下一函数：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">baseUrl</span><span class="token punctuation">(</span><span class="token class-name">HttpUrl</span> baseUrl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">checkNotNull</span><span class="token punctuation">(</span>baseUrl<span class="token punctuation">,</span> <span class="token string">"baseUrl == null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> pathSegments <span class="token operator">=</span> baseUrl<span class="token punctuation">.</span><span class="token function">pathSegments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pathSegments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pathSegments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"baseUrl must end in /: "</span> <span class="token operator">+</span> baseUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl <span class="token operator">=</span> baseUrl<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这一层将Url分段，判断是否以/结尾，若数据合理则记录到Builder的baseUrl成员内。<br> 该方法流程就是将字符串网址转换为合适格式后，进行数据合理判断，再存储起来。</p> 
<h5><a id="addConverterFactoryGsonConverterFactorycreate_236"></a>.addConverterFactory(GsonConverterFactory.create())</h5> 
<p><strong>GsonConverterFactory.create()</strong><br> Gson数据转换器工厂创建：</p> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">GsonConverterFactory</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>外部调用无参函数，内部传入Gson实例</p> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">GsonConverterFactory</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Gson</span> gson<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>gson <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"gson == null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GsonConverterFactory</span><span class="token punctuation">(</span>gson<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>此处依据使用的Gson实例真正返回工厂实例</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token class-name">GsonConverterFactory</span><span class="token punctuation">(</span><span class="token class-name">Gson</span> gson<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gson <span class="token operator">=</span> gson<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>构造方法就是将Gson对象保存起来</p> 
<p><strong>addConverterFactory()</strong></p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">addConverterFactory</span><span class="token punctuation">(</span><span class="token class-name">Converter<span class="token punctuation">.</span>Factory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      converterFactories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> <span class="token string">"factory == null"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>将创建的工厂存储到Builder的转换器工厂集合中<br> 剩余工厂参数配置流程基本同此。</p> 
<h5><a id="build_271"></a>.build()</h5> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">Retrofit</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>baseUrl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Base URL required."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre> 
<p>baseUrl必须配置好</p> 
<pre><code class="prism language-java">      <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Call<span class="token punctuation">.</span>Factory</span> callFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>callFactory<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>callFactory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        callFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre> 
<p>判断是否设置过网络请求执行器工厂，若没设置，采用默认OkHttp进行网络请求</p> 
<pre><code class="prism language-java">      <span class="token class-name">Executor</span> callbackExecutor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>callbackExecutor<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackExecutor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        callbackExecutor <span class="token operator">=</span> platform<span class="token punctuation">.</span><span class="token function">defaultCallbackExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre> 
<p>判断是否设置过回调执行器，若没设置，采用默认安卓自身的执行器（在platform中实现）</p> 
<pre><code class="prism language-java">      <span class="token comment">// Make a defensive copy of the adapters and add the default Call adapter.</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CallAdapter<span class="token punctuation">.</span>Factory</span><span class="token punctuation">&gt;</span></span> callAdapterFactories <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>callAdapterFactories<span class="token punctuation">)</span><span class="token punctuation">;</span>
      callAdapterFactories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>platform<span class="token punctuation">.</span><span class="token function">defaultCallAdapterFactory</span><span class="token punctuation">(</span>callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>将传入的所有适配器工厂参数接收进来， 最后加上系统默认工厂</p> 
<pre><code class="prism language-java">      <span class="token comment">// Make a defensive copy of the converters.</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Converter<span class="token punctuation">.</span>Factory</span><span class="token punctuation">&gt;</span></span> converterFactories <span class="token operator">=</span>
          <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>converterFactories<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Add the built-in converter factory first. This prevents overriding its behavior but also</span>
      <span class="token comment">// ensures correct behavior when using converters that consume all types.</span>
      converterFactories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BuiltInConverters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      converterFactories<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>converterFactories<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>依旧是接收所有配置进来的转换器工厂，先加入系统默认数据转换器BuiltInConverters，再加入配置好的工厂<br> 上述两个列表存储，后续查找使用都是从头遍历找到尾，固越在前面优先级越高。</p> 
<pre><code class="prism language-java">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Retrofit</span><span class="token punctuation">(</span>callFactory<span class="token punctuation">,</span> baseUrl<span class="token punctuation">,</span> <span class="token function">unmodifiableList</span><span class="token punctuation">(</span>converterFactories<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">unmodifiableList</span><span class="token punctuation">(</span>callAdapterFactories<span class="token punctuation">)</span><span class="token punctuation">,</span> callbackExecutor<span class="token punctuation">,</span> validateEagerly<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>最后调用Retrofit的构造函数生成实例。（<code>unmodifiableList</code>会使列表数据可以读取，但不能修改）</p> 
<h4><a id="__323"></a>步骤五 创建网络请求接口实例</h4> 
<pre><code class="prism language-java"><span class="token class-name">GetRequest_Interface</span> request <span class="token operator">=</span> retrofit<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">GetRequest_Interface</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Call</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Reception</span><span class="token punctuation">&gt;</span></span> call <span class="token operator">=</span> request<span class="token punctuation">.</span>接口方法名<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="retrofitcreate_329"></a>retrofit.create()</h5> 
<pre><code class="prism language-java"><span class="token keyword">public</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
</code></pre> 
<p>依据传入的接口class对象创建</p> 
<pre><code class="prism language-java">  <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">validateServiceInterface</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>此处判断是否是有效接口 <strong>方法一</strong></p> 
<pre><code class="prism language-java">  <span class="token keyword">if</span> <span class="token punctuation">(</span>validateEagerly<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">eagerlyValidateMethods</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>依据先前提到的boolean对象，判断是否需要提前验证 <strong>方法二</strong><br> 上述代码中详细方法解析：<br> <strong>方法一</strong></p> 
<pre><code class="prism language-java">  <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">validateServiceInterface</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>service<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"API declarations must be interfaces."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"API interfaces must not extend other interfaces."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>判断有效①class对象必须是接口②不可实现多个接口</p> 
<p><strong>方法二</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">eagerlyValidateMethods</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">Platform</span> platform <span class="token operator">=</span> <span class="token class-name">Platform</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> method <span class="token operator">:</span> service<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>platform<span class="token punctuation">.</span><span class="token function">isDefaultMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">loadServiceMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>将接口中非系统默认方法加载起来</p> 
<p>接下来是重点代理模式的实现</p> 
<pre><code class="prism language-java">  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> service <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Platform</span> platform <span class="token operator">=</span> <span class="token class-name">Platform</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>platform<span class="token punctuation">.</span><span class="token function">isDefaultMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> platform<span class="token punctuation">.</span><span class="token function">invokeDefaultMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> service<span class="token punctuation">,</span> proxy<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
</code></pre> 
<p>上述是将java、系统默认的方法不需记录直接通过反射调用即可。</p> 
<pre><code class="prism language-java">          <span class="token class-name">ServiceMethod</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> serviceMethod <span class="token operator">=</span>
              <span class="token punctuation">(</span><span class="token class-name">ServiceMethod</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token function">loadServiceMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">OkHttpCall</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> okHttpCall <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpCall</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>serviceMethod<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> serviceMethod<span class="token punctuation">.</span><span class="token function">adapt</span><span class="token punctuation">(</span>okHttpCall<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以上三步是生成服务最重要的部分</p> 
<h6><a id="ServiceMethodObject_Object_serviceMethod__ServiceMethodObject_Object_loadServiceMethodmethod_401"></a>ServiceMethod&lt;Object, Object&gt; serviceMethod = (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method);</h6> 
<p>依据接口种方法的注解生成ServiceMethod对象：</p> 
<pre><code class="prism language-java">  <span class="token class-name">ServiceMethod</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadServiceMethod</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ServiceMethod</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> serviceMethodCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> result<span class="token punctuation">;</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>serviceMethodCache<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      result <span class="token operator">=</span> serviceMethodCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceMethod<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serviceMethodCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>从方法缓存中查找是否加载过相同方法，若没有则采用建造者模式新生成（单例模式）</p> 
<h6><a id="result__new_ServiceMethodBuilderthis_methodbuild_420"></a>result = new ServiceMethod.Builder&lt;&gt;(this, method).build();</h6> 
<p><strong>new ServiceMethod类</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ServiceMethod</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> PARAM <span class="token operator">=</span> <span class="token string">"[a-zA-Z][a-zA-Z0-9_-]*"</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Pattern</span> PARAM_URL_REGEX <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"\\{("</span> <span class="token operator">+</span> PARAM <span class="token operator">+</span> <span class="token string">")\\}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Pattern</span> PARAM_NAME_REGEX <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>PARAM<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//使用正则判断接口名称、URL是否合法</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Call<span class="token punctuation">.</span>Factory</span> callFactory<span class="token punctuation">;</span>		<span class="token comment">//网络请求工厂</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CallAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> callAdapter<span class="token punctuation">;</span>			<span class="token comment">//请求适配器</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HttpUrl</span> baseUrl<span class="token punctuation">;</span>						<span class="token comment">//网络请求基础URL地址</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResponseBody</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> responseConverter<span class="token punctuation">;</span>	<span class="token comment">//数据转换器</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> httpMethod<span class="token punctuation">;</span>						<span class="token comment">//网络请求的HTTP方法（GET、POST...）</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> relativeUrl<span class="token punctuation">;</span>						<span class="token comment">//网络请求相对地址</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Headers</span> headers<span class="token punctuation">;</span>						<span class="token comment">//网络请求中http请求头，键值对设置参数</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MediaType</span> contentType<span class="token punctuation">;</span>					<span class="token comment">//网络http请求报文body类型</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasBody<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isFormEncoded<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isMultipart<span class="token punctuation">;</span>
  <span class="token comment">//依据注解设置参数</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ParameterHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterHandlers<span class="token punctuation">;</span><span class="token comment">//方法参数处理器，解析API定义时的方法参数，在请求时进行设置</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>该类包含了发出具体网络请求需要的全部内容</p> 
<p><strong>.Builder&lt;&gt;(this, method)</strong><br> Builder类的构造方法：</p> 
<pre><code class="prism language-java">    <span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token class-name">Retrofit</span> retrofit<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>retrofit <span class="token operator">=</span> retrofit<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> method<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>methodAnnotations <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>parameterTypes <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getGenericParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>parameterAnnotationsArray <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getParameterAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>依据传入方法获取其注解、参数类型、参数注解等内容</p> 
<p><strong>.build()</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">ServiceMethod</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  callAdapter <span class="token operator">=</span> <span class="token function">createCallAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  responseType <span class="token operator">=</span> callAdapter<span class="token punctuation">.</span><span class="token function">responseType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>此处获取网络请求适配器 <strong>方法一</strong><br> 并且依据适配器获取合适的返回值类型</p> 
<pre><code class="prism language-java">  <span class="token keyword">if</span> <span class="token punctuation">(</span>responseType <span class="token operator">==</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">||</span> responseType <span class="token operator">==</span> <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Response</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token function">methodError</span><span class="token punctuation">(</span><span class="token string">"'"</span>
        <span class="token operator">+</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">getRawType</span><span class="token punctuation">(</span>responseType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">+</span> <span class="token string">"' is not a valid response body type. Did you mean ResponseBody?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>判断获取的返回值类型是否合理</p> 
<pre><code class="prism language-java">  responseConverter <span class="token operator">=</span> <span class="token function">createResponseConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>创建数据转换器 <strong>方法二</strong></p> 
<pre><code class="prism language-java">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Annotation</span> annotation <span class="token operator">:</span> methodAnnotations<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">parseMethodAnnotation</span><span class="token punctuation">(</span>annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>httpMethod <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token function">methodError</span><span class="token punctuation">(</span><span class="token string">"HTTP method annotation is required (e.g., @GET, @POST, etc.)."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>遍历方法注解并且进行解析并将其设置入httpMethod（主要获取HTTP网络请求方式，用String保存如GET等）</p> 
<pre><code class="prism language-java">  <span class="token keyword">int</span> parameterCount <span class="token operator">=</span> parameterAnnotationsArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  parameterHandlers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParameterHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>parameterCount<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> p <span class="token operator">&lt;</span> parameterCount<span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Type</span> parameterType <span class="token operator">=</span> parameterTypes<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">hasUnresolvableType</span><span class="token punctuation">(</span>parameterType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token function">parameterError</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">"Parameter type must not include a type variable or wildcard: %s"</span><span class="token punctuation">,</span>
          parameterType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Annotation</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterAnnotations <span class="token operator">=</span> parameterAnnotationsArray<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parameterAnnotations <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token function">parameterError</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">"No Retrofit annotation found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    parameterHandlers<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">parseParameter</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> parameterType<span class="token punctuation">,</span> parameterAnnotations<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>对参数逐个依据注解、类型进行解析，生成handler</p> 
<pre><code class="prism language-java">  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServiceMethod</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后将该方法配置完成即可返回此对象。</p> 
<p><strong>方法一 createCallAdapter()</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">CallAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">createCallAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">Type</span> returnType <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getGenericReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Annotation</span><span class="token punctuation">[</span><span class="token punctuation">]</span> annotations <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">CallAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> retrofit<span class="token punctuation">.</span><span class="token function">callAdapter</span><span class="token punctuation">(</span>returnType<span class="token punctuation">,</span> annotations<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token function">methodError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"Unable to create call adapter for %s"</span><span class="token punctuation">,</span> returnType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>读取方法的返回值类型、方法注解生成适配器，该适配器工厂的选取在创建Retrofit实例时用列表存储，此处从前向后挨个使用即可。</p> 
<p><strong>方法二 createResponseConverter()</strong></p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResponseBody</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">createResponseConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Annotation</span><span class="token punctuation">[</span><span class="token punctuation">]</span> annotations <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> retrofit<span class="token punctuation">.</span><span class="token function">responseBodyConverter</span><span class="token punctuation">(</span>responseType<span class="token punctuation">,</span> annotations<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// Wide exception range because factories are user code.</span>
        <span class="token keyword">throw</span> <span class="token function">methodError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"Unable to create converter for %s"</span><span class="token punctuation">,</span> responseType<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>原理同方法一获取适配器的过程，依据方法注解，在Retrofit实例的转换器工厂列表选取合适工厂进行生产</p> 
<p>至此一个方法解析就完成了，后续在接口代理中将该方法对象加入缓存即可。</p> 
<h6><a id="OkHttpCallObject_okHttpCall__new_OkHttpCallserviceMethod_args_548"></a>OkHttpCall okHttpCall = new OkHttpCall&lt;&gt;(serviceMethod, args);</h6> 
<p><strong>new OkHttpCall&lt;&gt;类</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">OkHttpCall</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Call</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServiceMethod</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> serviceMethod<span class="token punctuation">;</span>		<span class="token comment">//该网络请求方法对象，保存所有参数内容等</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">;</span>				<span class="token comment">//网络请求接口的参数</span>

  <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> canceled<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Call</span> rawCall<span class="token punctuation">;</span>				<span class="token comment">//最终实际进行网络请求的类</span>
  <span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Throwable</span> creationFailure<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> executed<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这一步就是将获取好的方法、传入的参数封装入Call，以便后续请求时直接调用获取</p> 
<h6><a id="return_serviceMethodadaptokHttpCall_565"></a>return serviceMethod.adapt(okHttpCall);</h6> 
<p>最后一步使用适配器将请求器转换为合适版本，此处使用不同适配器是属于装饰模式，内部仍然使用okHttpCall执行网络请求，但在其之上还要有其他操作就依据使用的适配器进行装饰。<br> 至此，retrofit.create就分析完成，即完成了对网络请求接口的配置</p> 
<h5><a id="CallReception_call__request_569"></a>Call call = request.接口方法名();</h5> 
<p>从依据接口生成的request中获取用于网络请求的执行器Call，此处的接口方法会被之前动态代理的invoke拦截，执行其中的内容（即将接口方法进行解析配置）</p> 
<h4><a id="__572"></a>步骤六 发出网络请求</h4> 
<p>从基础的OkHttpCall的execute同步请求方法出发：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Overridepublic</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Call</span> call<span class="token punctuation">;</span>

  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    call <span class="token operator">=</span> rawCall<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>call <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        call <span class="token operator">=</span> rawCall <span class="token operator">=</span> <span class="token function">createRawCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">throwIfFatal</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  Do not assign a fatal error to creationFailure.</span>
        creationFailure <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">parseResponse</span><span class="token punctuation">(</span>call<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先这个Call的生成是在上一步调用方法时产生，看似调用了方法，实际被动态代理拦截，生成一个Call对象，内部包含了该方法的ServiceMethod对象和所需参数。<br> 接着就是上述代码，首先查看Call是否内部Call是否生成，若没生成则同步锁生成一个<code>createRawCall</code> <strong>方法一</strong><br> 最后使用生成的内部Call执行请求并且解析返回数据 <strong>方法二</strong>。</p> 
<p><strong>方法一 createRawCall()</strong></p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Call</span> <span class="token function">createRawCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Call</span> call <span class="token operator">=</span> serviceMethod<span class="token punctuation">.</span><span class="token function">toCall</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>call <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"Call.Factory returned null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> call<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>使用之前生成的serviceMethod（包含所有请求所需内容），依据传入参数生成发起请求使用的Call（生成了一个HTTP request）。</p> 
<p><strong>方法二 parseResponse(call.execute())</strong><br> 由生成的内部call（request）发起请求并且解析数据。</p> 
<pre><code class="prism language-java"><span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">parseResponse</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Response</span> rawResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">ResponseBody</span> rawBody <span class="token operator">=</span> rawResponse<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  rawResponse <span class="token operator">=</span> rawResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NoContentResponseBody</span><span class="token punctuation">(</span>rawBody<span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rawBody<span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> code <span class="token operator">=</span> rawResponse<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">&lt;</span> <span class="token number">200</span> <span class="token operator">||</span> code <span class="token operator">&gt;=</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">ResponseBody</span> bufferedBody <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>rawBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>bufferedBody<span class="token punctuation">,</span> rawResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      rawBody<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">204</span> <span class="token operator">||</span> code <span class="token operator">==</span> <span class="token number">205</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    rawBody<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> rawResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">ExceptionCatchingRequestBody</span> catchingBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExceptionCatchingRequestBody</span><span class="token punctuation">(</span>rawBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">T</span> body <span class="token operator">=</span> serviceMethod<span class="token punctuation">.</span><span class="token function">toResponse</span><span class="token punctuation">(</span>catchingBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> rawResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    catchingBody<span class="token punctuation">.</span><span class="token function">throwIfCaught</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>数据处理首先对response进行解析<br> ①状态码检查，依据不同状态码即可知道该请求的情况，进行相应处理<br> ②当请求成功，会将body传入serviceMethod中，使用之前的设置好的数据转换器将其转换为所需数据类型，再调用Response.success，返回一个完整response</p> 
<p>异步请求call.enqueue：</p> 
<pre><code class="prism language-java">call<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Translation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token class-name">Call</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Translation</span><span class="token punctuation">&gt;</span></span> call<span class="token punctuation">,</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Translation</span><span class="token punctuation">&gt;</span></span> response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">Call</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Translation</span><span class="token punctuation">&gt;</span></span> call<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"连接失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>请求的同步异步是相对于当前线程，并非任务的同步异步，进行同步请求通常将手动创建线程进行网络请求（否则将直接在主UI线程进行请求，阻塞），异步自动创建并执行，最后调回主线程进行数据处理。<br> 异步请求采用静态代理模式，用户写好请求数据的处理后，等请求完成回到主线程直接进行方法回调。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Callback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  delegate<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token class-name">Call</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> call<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      callbackExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            callback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">ExecutorCallbackCall</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            callback<span class="token punctuation">.</span><span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token class-name">ExecutorCallbackCall</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">Call</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> call<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      callbackExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          callback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">ExecutorCallbackCall</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>源码可以看出异步请求是使用静态代理delegate进行的 <strong>分析一</strong><br> <code>callbackExecutor.execute()</code>将最后的结果用执行器切换到主线程进行数据处理（安卓的默认执行器就是主线程执行器，是在先前platform中获取到的） <strong>分析二</strong></p> 
<p><strong>分析一 静态代理</strong></p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Callback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Call</span> call<span class="token punctuation">;</span>
    <span class="token class-name">Throwable</span> failure<span class="token punctuation">;</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Already executed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      executed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

      call <span class="token operator">=</span> rawCall<span class="token punctuation">;</span>
      failure <span class="token operator">=</span> creationFailure<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>call <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> failure <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          call <span class="token operator">=</span> rawCall <span class="token operator">=</span> <span class="token function">createRawCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">throwIfFatal</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
          failure <span class="token operator">=</span> creationFailure <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    call<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Call</span> call<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Response</span> rawResponse<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> response<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          response <span class="token operator">=</span> <span class="token function">parseResponse</span><span class="token punctuation">(</span>rawResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">callFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          callback<span class="token punctuation">.</span><span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token class-name">OkHttpCall</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          t<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span>Call</span> call<span class="token punctuation">,</span> <span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">callFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">callFailure</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          callback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">OkHttpCall</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          t<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>先前静态代理执行的enqueue实际还是调用了OkHttpCall内部的enqueue（内部流程与同步相同，先查看内部call/request是否生成，生产call并进行调用），在okhttp基础上以静态代理模式添加了线程切换操作。</p> 
<p>至此整个流程全部完成。<br> 后面的execute、enqueue都是解析的<strong>ExecutorCallbackCall</strong>，而不是OkHttpCall，因为在创建retrofit实例时，其中适配器的排序是将系统默认适配器排到了第一位，而安卓默认适配器就是<strong>ExecutorCallbackCallAdapter</strong>，所以一切业务层对call进行的调用都在对ExecutorCallbackCall的方法调用。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5d1978d999a7d001892094706bd8004e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">windows配置python2.7和python3.7(绿色免安装版)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b4251ec7acdda7bd1713f11356a81e44/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">神经网络-注意力机制</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>