<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>每日筛取候选股票——从零到实盘14 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="每日筛取候选股票——从零到实盘14" />
<meta property="og:description" content="前文介绍了多进程更新股票数据的过程。在实盘的过程中，每日更新股票数据后，筛出符合候选条件的股票，这样我们就可以在后续交易中，监测候选股票的价格，判断是否进行买入。本文记录筛取候选股票的过程，主要通过查询latest表获取最新一日所有股票的日线数据，然后选取candidate因子为True的股票。
主要代码分析 新建源文件，命名为data_center_v12.py，全部内容见文末，v12新增4个函数：
新增最新日线数据表函数 def update_latest_table(stock_codes): 该函数用于更新数据库中最新日线数据表，从数据库中读取每只股票的最新一天数据并返回，其中：
参数stock_codes为待更新数据的股票代码返回值为包含所有待处理股票的最新日线数据的DataFrame engine = create_mysql_engine() 创建数据库引擎对象。
latest_df = pd.DataFrame() 创建空的DataFrame。
for index, code in enumerate(stock_codes): 更新数据循环。
table_name = &#39;{}_{}&#39;.format(code[3:], code[:2]) 股票数据在数据库中的表名。
if table_name not in sqlalchemy.inspect(engine).get_table_names(): continue 判断是否存在该表，不存在则跳过。
sql_cmd = &#39;SELECT * FROM {} ORDER BY date DESC LIMIT 1;&#39;.format(table_name) df = pd.read_sql(sql=sql_cmd, con=engine) 从数据库中读取股票的最新一天数据。
if np.any(df.isnull()): continue 有缺失字段就不参与候选。
df[&#39;code&#39;] = code[3:] latest_df = latest_df.append(df) 添加code字段，并append到latest_df中。
return latest_df 将查询到最新日线数据返回。
新增多进程更新最新日线数据表 def update_latest_table_mp(stock_codes, process_num=61): 该函数使用多进程更新数据库中最新日线数据表，从各个子进程收集每只股票的最新日线数据并返回，其中：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/5e0ab3d328b790e2fdf80a1c099940dd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-04T15:13:01+08:00" />
<meta property="article:modified_time" content="2023-10-04T15:13:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">每日筛取候选股票——从零到实盘14</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><a href="http://coderx.com.cn/?p=375" rel="nofollow">前文</a>介绍了多进程更新股票数据的过程。在实盘的过程中，每日更新股票数据后，筛出符合候选条件的股票，这样我们就可以在后续交易中，监测候选股票的价格，判断是否进行买入。本文记录筛取候选股票的过程，主要通过查询latest表获取最新一日所有股票的日线数据，然后选取candidate因子为True的股票。</p> 
<h2><a id="_2"></a>主要代码分析</h2> 
<p>新建源文件，命名为data_center_v12.py，全部内容见文末，v12新增4个函数：</p> 
<h4><a id="_5"></a>新增最新日线数据表函数</h4> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">update_latest_table</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre> 
<p>该函数用于更新数据库中最新日线数据表，从数据库中读取每只股票的最新一天数据并返回，其中：</p> 
<ul><li>参数stock_codes为待更新数据的股票代码</li><li>返回值为包含所有待处理股票的最新日线数据的DataFrame</li></ul> 
<pre><code class="prism language-python">    engine <span class="token operator">=</span> create_mysql_engine<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>创建数据库引擎对象。</p> 
<pre><code class="prism language-python">    latest_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>创建空的DataFrame。</p> 
<pre><code class="prism language-python">    <span class="token keyword">for</span> index<span class="token punctuation">,</span> code <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre> 
<p>更新数据循环。</p> 
<pre><code class="prism language-python">        table_name <span class="token operator">=</span> <span class="token string">'{}_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>code<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> code<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>股票数据在数据库中的表名。</p> 
<pre><code class="prism language-python">        <span class="token keyword">if</span> table_name <span class="token keyword">not</span> <span class="token keyword">in</span> sqlalchemy<span class="token punctuation">.</span>inspect<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">.</span>get_table_names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
</code></pre> 
<p>判断是否存在该表，不存在则跳过。</p> 
<pre><code class="prism language-python">        sql_cmd <span class="token operator">=</span> <span class="token string">'SELECT * FROM {} ORDER BY date DESC LIMIT 1;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>table_name<span class="token punctuation">)</span>
        df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span>sql<span class="token operator">=</span>sql_cmd<span class="token punctuation">,</span> con<span class="token operator">=</span>engine<span class="token punctuation">)</span>
</code></pre> 
<p>从数据库中读取股票的最新一天数据。</p> 
<pre><code class="prism language-python">        <span class="token keyword">if</span> np<span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
</code></pre> 
<p>有缺失字段就不参与候选。</p> 
<pre><code class="prism language-python">        df<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> code<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        latest_df <span class="token operator">=</span> latest_df<span class="token punctuation">.</span>append<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
</code></pre> 
<p>添加code字段，并append到latest_df中。</p> 
<pre><code class="prism language-python">    <span class="token keyword">return</span> latest_df
</code></pre> 
<p>将查询到最新日线数据返回。</p> 
<h4><a id="_64"></a>新增多进程更新最新日线数据表</h4> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">update_latest_table_mp</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">,</span> process_num<span class="token operator">=</span><span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre> 
<p>该函数使用多进程更新数据库中最新日线数据表，从各个子进程收集每只股票的最新日线数据并返回，其中：</p> 
<ul><li>参数stock_codes为待更新数据的股票代码</li><li>参数process_num为进程数</li><li>返回值为包含所有待处理股票的最新日线数据的DataFrame</li></ul> 
<pre><code class="prism language-python">    latest_df <span class="token operator">=</span> multiprocessing_func_df<span class="token punctuation">(</span>update_latest_table<span class="token punctuation">,</span> <span class="token punctuation">(</span>process_num<span class="token punctuation">,</span> stock_codes<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>多进程获得最新日线数据，调用multiprocessing_func_df函数，收集子进程调用update_latest_table函数返回的DataFrame数据。</p> 
<pre><code class="prism language-python">   
    <span class="token keyword">if</span> latest_df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        latest_df<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'latest'</span><span class="token punctuation">,</span> con<span class="token operator">=</span>create_mysql_engine<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> if_exists<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p>将所有股票最新日线数据写入数据库表latest。</p> 
<pre><code class="prism language-python">    <span class="token keyword">return</span> latest_df
</code></pre> 
<p>返回包含所有股票最新日线数据的DataFrame。</p> 
<h4><a id="_91"></a>新增查询最新日线数据表函数</h4> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">query_latest_table</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">,</span> by_latest_table<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre> 
<p>该函数用于查询最新日线数据表，其中：</p> 
<ul><li>参数stock_codes为待获取最新日线数据的股票代码</li><li>参数by_latest_table表示是否通过表latest查询，为True（默认）时，直接从表latest中查询，否则从各个股票数据表中分别读取</li><li>返回值为包含所有待处理股票的最新日线数据的DataFrame</li></ul> 
<pre><code class="prism language-python">    engine <span class="token operator">=</span> create_mysql_engine<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>创建数据库引擎对象。</p> 
<pre><code class="prism language-python">    <span class="token keyword">if</span> by_latest_table <span class="token keyword">and</span> <span class="token string">'latest'</span> <span class="token keyword">in</span> sqlalchemy<span class="token punctuation">.</span>inspect<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">.</span>get_table_names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sql_cmd <span class="token operator">=</span> <span class="token string">'SELECT * FROM latest;'</span>
        <span class="token keyword">return</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span>sql<span class="token operator">=</span>sql_cmd<span class="token punctuation">,</span> con<span class="token operator">=</span>engine<span class="token punctuation">)</span>
</code></pre> 
<p>如果设置直接从表latest查询，且表latest存在，则直接从数据库读取数据返回。</p> 
<pre><code class="prism language-python">    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> update_latest_table_mp<span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span>
</code></pre> 
<p>否则从各股票数据表中分别读取最新一日数据再返回（过程中会更新表latest）。</p> 
<h4><a id="_118"></a>新增交易数据函数</h4> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">update_trade</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre> 
<p>该函数用于更新交易数据，其中：</p> 
<ul><li>参数stock_codes为更新股票范围</li><li>返回值为None</li></ul> 
<pre><code class="prism language-python">    df <span class="token operator">=</span> query_latest_table<span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span>
</code></pre> 
<p>查询最新日线数据。</p> 
<pre><code class="prism language-python">    df <span class="token operator">=</span> df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'candidate'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">]</span>
</code></pre> 
<p>筛选出候选股票。</p> 
<pre><code class="prism language-python">    <span class="token keyword">if</span> df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        df <span class="token operator">=</span> df<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'turn'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>按换手率升序排序，打印候选股票代码。</p> 
<p>以2021年12月1日为例，筛出的候选股票为002902铭普光磁，该日K线满足：</p> 
<ul><li>日线同时穿过5、10、20、30日均线</li><li>30日均线在60日均线上方</li><li>形成双神</li></ul> 
<p><img src="https://images2.imgbox.com/17/19/0ytupK2Y_o.png" alt=""></p> 
<h2><a id="_153"></a>小结</h2> 
<p>本文实现了筛取候选股票的过程，通过查询latest表获取最新一日所有股票的日线数据，然后选取candidate因子为True的股票。筛出候选股票后，就可以监测后续交易日，候选股票池内股票是否达到买点。<br> 下一篇文章将介绍完整的实盘策略思想。</p> 
<hr> 
<p>data_center_v12.py的全部代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> baostock <span class="token keyword">as</span> bs
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> time
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> multiprocessing
<span class="token keyword">import</span> sqlalchemy
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> pandas<span class="token punctuation">.</span>plotting <span class="token keyword">import</span> table

<span class="token comment"># 可用日线数量约束</span>
g_available_days_limit <span class="token operator">=</span> <span class="token number">250</span>

<span class="token comment"># BaoStock日线数据字段</span>
g_baostock_data_fields <span class="token operator">=</span> <span class="token string">'date,open,high,low,close,preclose,volume,amount,adjustflag,turn,tradestatus,pctChg,peTTM,pbMRQ, psTTM,pcfNcfTTM,isST'</span>


<span class="token keyword">def</span> <span class="token function">create_mysql_engine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    创建数据库引擎对象

    :return: 新创建的数据库引擎对象
    """</span>

    <span class="token comment"># 引擎参数信息</span>
    host <span class="token operator">=</span> <span class="token string">'localhost'</span>
    user <span class="token operator">=</span> <span class="token string">'root'</span>
    passwd <span class="token operator">=</span> <span class="token string">'111111'</span>
    port <span class="token operator">=</span> <span class="token string">'3306'</span>
    db <span class="token operator">=</span> <span class="token string">'db_quant'</span>

    <span class="token comment"># 创建数据库引擎对象</span>
    mysql_engine <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>create_engine<span class="token punctuation">(</span>
        <span class="token string">'mysql+pymysql://{0}:{1}@{2}:{3}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> passwd<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">,</span>
        poolclass<span class="token operator">=</span>sqlalchemy<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>NullPool
    <span class="token punctuation">)</span>

    <span class="token comment"># 如果不存在数据库db_quant则创建</span>
    mysql_engine<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"CREATE DATABASE IF NOT EXISTS {0} "</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 创建连接数据库db_quant的引擎对象</span>
    db_engine <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>create_engine<span class="token punctuation">(</span>
        <span class="token string">'mysql+pymysql://{0}:{1}@{2}:{3}/{4}?charset=utf8'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> passwd<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> db<span class="token punctuation">)</span><span class="token punctuation">,</span>
        poolclass<span class="token operator">=</span>sqlalchemy<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>NullPool
    <span class="token punctuation">)</span>

    <span class="token comment"># 返回引擎对象</span>
    <span class="token keyword">return</span> db_engine


<span class="token keyword">def</span> <span class="token function">get_stock_codes</span><span class="token punctuation">(</span>date<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> update<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    获取指定日期的A股代码列表

    若参数update为False，表示从数据库中读取股票列表
    若数据库中不存在股票列表的表，或者update为True，则下载指定日期date的交易股票列表
    若参数date为空，则返回最近1个交易日的A股代码列表
    若参数date不为空，且为交易日，则返回date当日的A股代码列表
    若参数date不为空，但不为交易日，则打印提示非交易日信息，程序退出

    :param date: 日期，默认为None
    :param update: 是否更新股票列表，默认为False
    :return: A股代码的列表
    """</span>

    <span class="token comment"># 创建数据库引擎对象</span>
    engine <span class="token operator">=</span> create_mysql_engine<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 数据库中股票代码的表名</span>
    table_name <span class="token operator">=</span> <span class="token string">'stock_codes'</span>

    <span class="token comment"># 数据库中不存在股票代码表，或者需要更新股票代码表</span>
    <span class="token keyword">if</span> table_name <span class="token keyword">not</span> <span class="token keyword">in</span> sqlalchemy<span class="token punctuation">.</span>inspect<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">.</span>get_table_names<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> update<span class="token punctuation">:</span>

        <span class="token comment"># 登录baostock</span>
        bs<span class="token punctuation">.</span>login<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 从BaoStock查询股票数据</span>
        stock_df <span class="token operator">=</span> bs<span class="token punctuation">.</span>query_all_stock<span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 如果获取数据长度为0，表示日期date非交易日</span>
        <span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>stock_df<span class="token punctuation">)</span><span class="token punctuation">:</span>

            <span class="token comment"># 如果设置了参数date，则打印信息提示date为非交易日</span>
            <span class="token keyword">if</span> date <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'当前选择日期为非交易日或尚无交易数据，请设置date为历史某交易日日期'</span><span class="token punctuation">)</span>
                sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

            <span class="token comment"># 未设置参数date，则向历史查找最近的交易日，当获取股票数据长度非0时，即找到最近交易日</span>
            delta <span class="token operator">=</span> <span class="token number">1</span>
            <span class="token keyword">while</span> <span class="token number">0</span> <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>stock_df<span class="token punctuation">)</span><span class="token punctuation">:</span>
                stock_df <span class="token operator">=</span> bs<span class="token punctuation">.</span>query_all_stock<span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span>delta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
                delta <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token comment"># 注销登录</span>
        bs<span class="token punctuation">.</span>logout<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 筛选股票数据，上证和深证股票代码在sh.600000与sz.39900之间</span>
        stock_df <span class="token operator">=</span> stock_df<span class="token punctuation">[</span><span class="token punctuation">(</span>stock_df<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token string">'sh.600000'</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>stock_df<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token string">'sz.399000'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment"># 将股票代码写入数据库</span>
        stock_df<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span>name<span class="token operator">=</span>table_name<span class="token punctuation">,</span> con<span class="token operator">=</span>engine<span class="token punctuation">,</span> if_exists<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> index_label<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        <span class="token comment"># 返回股票列表</span>
        <span class="token keyword">return</span> stock_df<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 从数据库中读取股票代码列表</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>

        <span class="token comment"># 待执行的sql语句</span>
        sql_cmd <span class="token operator">=</span> <span class="token string">'SELECT {} FROM {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>

        <span class="token comment"># 读取sql，返回股票列表</span>
        <span class="token keyword">return</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span>sql<span class="token operator">=</span>sql_cmd<span class="token punctuation">,</span> con<span class="token operator">=</span>engine<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">create_data</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">,</span> from_date<span class="token operator">=</span><span class="token string">'1990-12-19'</span><span class="token punctuation">,</span> to_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                adjustflag<span class="token operator">=</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    下载指定日期内，指定股票的日线数据，计算扩展因子

    :param stock_codes: 待下载数据的股票代码
    :param from_date: 日线开始日期
    :param to_date: 日线结束日期
    :param adjustflag: 复权选项 1：后复权  2：前复权  3：不复权  默认为前复权
    :return: None
    """</span>

    <span class="token comment"># 创建数据库引擎对象</span>
    engine <span class="token operator">=</span> create_mysql_engine<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 下载股票循环</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> code <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'({}/{})正在创建{}...'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 登录BaoStock</span>
        bs<span class="token punctuation">.</span>login<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 下载日线数据</span>
        out_df <span class="token operator">=</span> bs<span class="token punctuation">.</span>query_history_k_data_plus<span class="token punctuation">(</span>code<span class="token punctuation">,</span> g_baostock_data_fields<span class="token punctuation">,</span> start_date<span class="token operator">=</span>from_date<span class="token punctuation">,</span> end_date<span class="token operator">=</span>to_date<span class="token punctuation">,</span>
                                              frequency<span class="token operator">=</span><span class="token string">'d'</span><span class="token punctuation">,</span> adjustflag<span class="token operator">=</span>adjustflag<span class="token punctuation">)</span><span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 剔除停盘数据</span>
        <span class="token keyword">if</span> out_df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            out_df <span class="token operator">=</span> out_df<span class="token punctuation">[</span><span class="token punctuation">(</span>out_df<span class="token punctuation">[</span><span class="token string">'volume'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>out_df<span class="token punctuation">[</span><span class="token string">'volume'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment"># 如果数据为空，则不创建</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> out_df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        <span class="token comment"># 删除重复数据</span>
        out_df<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        <span class="token comment"># 日线数据少于g_available_days_limit，则不创建</span>
        <span class="token keyword">if</span> out_df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> g_available_days_limit<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        <span class="token comment"># 将数值数据转为float型，便于后续处理</span>
        convert_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token string">'high'</span><span class="token punctuation">,</span> <span class="token string">'low'</span><span class="token punctuation">,</span> <span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token string">'preclose'</span><span class="token punctuation">,</span> <span class="token string">'volume'</span><span class="token punctuation">,</span> <span class="token string">'amount'</span><span class="token punctuation">,</span> <span class="token string">'turn'</span><span class="token punctuation">,</span> <span class="token string">'pctChg'</span><span class="token punctuation">]</span>
        out_df<span class="token punctuation">[</span>convert_list<span class="token punctuation">]</span> <span class="token operator">=</span> out_df<span class="token punctuation">[</span>convert_list<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span>

        <span class="token comment"># 重置索引</span>
        out_df<span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        <span class="token comment"># 计算扩展因子</span>
        out_df <span class="token operator">=</span> extend_factor<span class="token punctuation">(</span>out_df<span class="token punctuation">)</span>

        <span class="token comment"># 写入数据库</span>
        table_name <span class="token operator">=</span> <span class="token string">'{}_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>code<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> code<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        out_df<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span>name<span class="token operator">=</span>table_name<span class="token punctuation">,</span> con<span class="token operator">=</span>engine<span class="token punctuation">,</span> if_exists<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index_label<span class="token operator">=</span><span class="token string">'id'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_code_group</span><span class="token punctuation">(</span>process_num<span class="token punctuation">,</span> stock_codes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    获取代码分组，用于多进程计算，每个进程处理一组股票

    :param process_num: 进程数
    :param stock_codes: 待处理的股票代码
    :return: 分组后的股票代码列表，列表的每个元素为一组股票代码的列表
    """</span>

    <span class="token comment"># 创建空的分组</span>
    code_group <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>process_num<span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token comment"># 按余数为每个分组分配股票</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> code <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        code_group<span class="token punctuation">[</span>index <span class="token operator">%</span> process_num<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>code<span class="token punctuation">)</span>

    <span class="token keyword">return</span> code_group


<span class="token keyword">def</span> <span class="token function">multiprocessing_func</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    多进程调用函数

    :param func: 函数名
    :param args: func的参数，类型为元组，第0个元素为进程数，第1个元素为股票代码列表
    :return: 包含各子进程返回对象的列表
    """</span>

    <span class="token comment"># 用于保存各子进程返回对象的列表</span>
    results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># 创建进程池</span>
    <span class="token keyword">with</span> multiprocessing<span class="token punctuation">.</span>Pool<span class="token punctuation">(</span>processes<span class="token operator">=</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span>
        <span class="token comment"># 多进程异步计算</span>
        <span class="token keyword">for</span> codes <span class="token keyword">in</span> get_code_group<span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pool<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>codes<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 阻止后续任务提交到进程池</span>
        pool<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 等待所有进程结束</span>
        pool<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> results


<span class="token keyword">def</span> <span class="token function">create_data_mp</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">,</span> process_num<span class="token operator">=</span><span class="token number">61</span><span class="token punctuation">,</span>
                   from_date<span class="token operator">=</span><span class="token string">'1990-12-19'</span><span class="token punctuation">,</span> to_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> adjustflag<span class="token operator">=</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    使用多进程创建指定日期内，指定股票的日线数据，计算扩展因子

    :param stock_codes: 待创建数据的股票代码
    :param process_num: 进程数
    :param from_date: 日线开始日期
    :param to_date: 日线结束日期
    :param adjustflag: 复权选项 1：后复权  2：前复权  3：不复权  默认为前复权
    :return: None
    """</span>

    multiprocessing_func<span class="token punctuation">(</span>create_data<span class="token punctuation">,</span> <span class="token punctuation">(</span>process_num<span class="token punctuation">,</span> stock_codes<span class="token punctuation">,</span> from_date<span class="token punctuation">,</span> to_date<span class="token punctuation">,</span> adjustflag<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">extend_factor</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    计算扩展因子

    :param df: 待计算扩展因子的DataFrame
    :return: 包含扩展因子的DataFrame
    """</span>

    <span class="token comment"># 使用pipe依次计算涨停、双神及是否为候选股票</span>
    df <span class="token operator">=</span> df<span class="token punctuation">.</span>pipe<span class="token punctuation">(</span>zt<span class="token punctuation">)</span><span class="token punctuation">.</span>pipe<span class="token punctuation">(</span>ss<span class="token punctuation">,</span> delta_days<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pipe<span class="token punctuation">(</span>candidate<span class="token punctuation">)</span>

    <span class="token keyword">return</span> df


<span class="token keyword">def</span> <span class="token function">zt</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    计算涨停因子

    若涨停，则因子为True，否则为False
    以当日收盘价较前一日收盘价上涨9.8%及以上作为涨停判断标准

    :param df: 待计算扩展因子的DataFrame
    :return: 包含扩展因子的DataFrame
    """</span>

    df<span class="token punctuation">[</span><span class="token string">'zt'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values <span class="token operator">&gt;=</span> <span class="token number">1.098</span> <span class="token operator">*</span> df<span class="token punctuation">[</span><span class="token string">'preclose'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> df


<span class="token keyword">def</span> <span class="token function">shift_i</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span> factor_list<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fill_value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> suffix<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    计算移动因子，用于获取前i日或者后i日的因子

    :param df: 待计算扩展因子的DataFrame
    :param factor_list: 待移动的因子列表
    :param i: 移动的步数
    :param fill_value: 用于填充NA的值，默认为0
    :param suffix: 值为a(ago)时表示移动获得历史数据，用于计算指标；值为l(later)时表示获得未来数据，用于计算收益
    :return: 包含扩展因子的DataFrame
    """</span>

    <span class="token comment"># 选取需要shift的列构成新的DataFrame，进行shift操作</span>
    shift_df <span class="token operator">=</span> df<span class="token punctuation">[</span>factor_list<span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span>i<span class="token punctuation">,</span> fill_value<span class="token operator">=</span>fill_value<span class="token punctuation">)</span>

    <span class="token comment"># 对新的DataFrame列进行重命名</span>
    shift_df<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">:</span> <span class="token string">'{}_{}{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> i<span class="token punctuation">,</span> suffix<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> factor_list<span class="token punctuation">}</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># 将重命名后的DataFrame合并到原始DataFrame中</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>df<span class="token punctuation">,</span> shift_df<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> df


<span class="token keyword">def</span> <span class="token function">shift_till_n</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span> factor_list<span class="token punctuation">,</span> n<span class="token punctuation">,</span> fill_value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> suffix<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    计算范围移动因子

    用于获取前/后n日内的相关因子，内部调用了shift_i

    :param df: 待计算扩展因子的DataFrame
    :param factor_list: 待移动的因子列表
    :param n: 移动的步数范围
    :param fill_value: 用于填充NA的值，默认为0
    :param suffix: 值为a(ago)时表示移动获得历史数据，用于计算指标；值为l(later)时表示获得未来数据，用于计算收益
    :return: 包含扩展因子的DataFrame
    """</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        df <span class="token operator">=</span> shift_i<span class="token punctuation">(</span>df<span class="token punctuation">,</span> factor_list<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> fill_value<span class="token punctuation">,</span> suffix<span class="token punctuation">)</span>
    <span class="token keyword">return</span> df


<span class="token keyword">def</span> <span class="token function">ss</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span> delta_days<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    计算双神因子，即间隔的两个涨停

    若当日形成双神，则因子为True，否则为False

    :param df: 待计算扩展因子的DataFrame
    :param delta_days: 两根涨停间隔的时间不能超过该值，否则不判定为双神，默认值为30
    :return: 包含扩展因子的DataFrame
    """</span>

    <span class="token comment"># 移动涨停因子，求取近delta_days天内的涨停情况，保存在一个临时DataFrame中</span>
    temp_df <span class="token operator">=</span> shift_till_n<span class="token punctuation">(</span>df<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'zt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> delta_days<span class="token punctuation">,</span> fill_value<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token comment"># 生成列表，用于后续检索第2天前至第delta_days天前是否有涨停出现</span>
    col_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'zt_{}a'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> delta_days <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token comment"># 计算双神，需同时满足3个条件：</span>
    <span class="token comment"># 1、第2天前至第delta_days天前，至少有1个涨停</span>
    <span class="token comment"># 2、1天前不是涨停（否则就是连续涨停，不是间隔的涨停）</span>
    <span class="token comment"># 3、当天是涨停</span>
    df<span class="token punctuation">[</span><span class="token string">'ss'</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp_df<span class="token punctuation">[</span>col_list<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>temp_df<span class="token punctuation">[</span><span class="token string">'zt_1a'</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> temp_df<span class="token punctuation">[</span><span class="token string">'zt'</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> df


<span class="token keyword">def</span> <span class="token function">ma</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token string">'close'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    计算均线因子

    :param df: 待计算扩展因子的DataFrame
    :param n: 待计算均线的周期，默认计算5日均线
    :param factor: 待计算均线的因子，默认为收盘价
    :return: 包含扩展因子的DataFrame
    """</span>

    <span class="token comment"># 均线名称，例如，收盘价的5日均线名称为ma_5，成交量的5日均线名称为volume_ma_5</span>
    name <span class="token operator">=</span> <span class="token string">'{}ma_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">''</span> <span class="token keyword">if</span> <span class="token string">'close'</span> <span class="token operator">==</span> factor <span class="token keyword">else</span> factor <span class="token operator">+</span> <span class="token string">'_'</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>

    <span class="token comment"># 取待计算均线的因子列</span>
    s <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>df<span class="token punctuation">[</span>factor<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span>name<span class="token punctuation">,</span> index<span class="token operator">=</span>df<span class="token punctuation">.</span>index<span class="token punctuation">)</span>

    <span class="token comment"># 利用rolling和mean计算均线数据</span>
    s <span class="token operator">=</span> s<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>center<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> window<span class="token operator">=</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 将均线数据添加到原始的DataFrame中</span>
    df <span class="token operator">=</span> df<span class="token punctuation">.</span>join<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

    <span class="token comment"># 均线数值保留两位小数</span>
    df<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.001</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> df


<span class="token keyword">def</span> <span class="token function">mas</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span> ma_list<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token string">'close'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    计算多条均线因子，内部调用ma计算单条均线

    :param df: 待计算扩展因子的DataFrame
    :param ma_list: 待计算均线的周期列表
    :param factor: 待计算均线的因子，默认为收盘价
    :return: 包含扩展因子的DataFrame
    """</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> ma_list<span class="token punctuation">:</span>
        df <span class="token operator">=</span> ma<span class="token punctuation">(</span>df<span class="token punctuation">,</span> i<span class="token punctuation">,</span> factor<span class="token punctuation">)</span>
    <span class="token keyword">return</span> df


<span class="token keyword">def</span> <span class="token function">cross_mas</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span> ma_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    计算穿均线因子

    若当日最低价不高于均线价格
    且当日收盘价不低于均线价格
    则当日穿均线因子值为True，否则为False

    :param df: 待计算扩展因子的DataFrame
    :param ma_list: 均线的周期列表
    :return: 包含扩展因子的DataFrame
    """</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> ma_list<span class="token punctuation">:</span>
        df<span class="token punctuation">[</span><span class="token string">'cross_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> df<span class="token punctuation">[</span><span class="token string">'ma_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>
                df<span class="token punctuation">[</span><span class="token string">'ma_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df


<span class="token keyword">def</span> <span class="token function">candidate</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    计算是否为候选

    若当日日线同时穿过5、10、20、30日均线
    且30日均线在60日均线上方
    且当日形成双神
    则当日作为候选，该因子值为True，否则为False

    :param df: 待计算扩展因子的DataFrame
    :return: 包含扩展因子的DataFrame
    """</span>

    <span class="token comment"># 均线周期列表</span>
    ma_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">]</span>

    <span class="token comment"># 计算均线的因子，保存到临时的DataFrame中</span>
    temp_df <span class="token operator">=</span> mas<span class="token punctuation">(</span>df<span class="token punctuation">,</span> ma_list<span class="token punctuation">)</span>

    <span class="token comment"># 计算穿多线的因子，保存到临时的DataFrame中</span>
    temp_df <span class="token operator">=</span> cross_mas<span class="token punctuation">(</span>temp_df<span class="token punctuation">,</span> ma_list<span class="token punctuation">)</span>

    <span class="token comment"># 穿多线因子的列名列表</span>
    column_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'cross_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> ma_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

    <span class="token comment"># 计算是否为候选</span>
    df<span class="token punctuation">[</span><span class="token string">'candidate'</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp_df<span class="token punctuation">[</span>column_list<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>temp_df<span class="token punctuation">[</span><span class="token string">'ma_30'</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> temp_df<span class="token punctuation">[</span><span class="token string">'ma_60'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> df<span class="token punctuation">[</span><span class="token string">'ss'</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> df


<span class="token keyword">def</span> <span class="token function">profit_loss_statistic</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">,</span> hold_days<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    盈亏分布统计，计算当日candidate为True，持仓hold_days天的收益分布

    :param stock_codes: 待分析的股票代码
    :param hold_days: 持仓天数
    :return: 筛选出符合买入条件的股票DataFrame
    """</span>

    <span class="token comment"># 创建数据库引擎对象</span>
    engine <span class="token operator">=</span> create_mysql_engine<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 创建空的DataFrame</span>
    candidate_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 计算收益分布循环</span>
    <span class="token keyword">for</span> code <span class="token keyword">in</span> stock_codes<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在处理{}...'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 股票数据在数据库中的表名</span>
        table_name <span class="token operator">=</span> <span class="token string">'{}_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>code<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> code<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># 如果数据库中没有该股票数据则跳过</span>
        <span class="token keyword">if</span> table_name <span class="token keyword">not</span> <span class="token keyword">in</span> sqlalchemy<span class="token punctuation">.</span>inspect<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">.</span>get_table_names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        <span class="token comment"># 从数据库读取特定字段数据</span>
        cols <span class="token operator">=</span> <span class="token string">'date, open, high, low, close, candidate'</span>
        sql_cmd <span class="token operator">=</span> <span class="token string">'SELECT {} FROM {} ORDER BY date DESC'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>cols<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>
        df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span>sql<span class="token operator">=</span>sql_cmd<span class="token punctuation">,</span> con<span class="token operator">=</span>engine<span class="token punctuation">)</span>

        <span class="token comment"># 移动第2日开盘价、最低价，以及hold_days的最高价、最低价数据</span>
        df <span class="token operator">=</span> shift_i<span class="token punctuation">(</span>df<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> suffix<span class="token operator">=</span><span class="token string">'l'</span><span class="token punctuation">)</span>
        df <span class="token operator">=</span> shift_till_n<span class="token punctuation">(</span>df<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">,</span> <span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hold_days<span class="token punctuation">,</span> suffix<span class="token operator">=</span><span class="token string">'l'</span><span class="token punctuation">)</span>

        <span class="token comment"># 丢弃最近hold_days日的数据</span>
        df <span class="token operator">=</span> df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>hold_days<span class="token punctuation">:</span> df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> g_available_days_limit<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>

        <span class="token comment"># 选取出现买点的股票</span>
        df <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'candidate'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'low_1l'</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment"># 将数据添加到候选池中</span>
        <span class="token keyword">if</span> df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            df<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> code
            candidate_df <span class="token operator">=</span> candidate_df<span class="token punctuation">.</span>append<span class="token punctuation">(</span>df<span class="token punctuation">)</span>

    <span class="token keyword">if</span> candidate_df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># 计算最大盈利</span>
        <span class="token comment"># 买入当天无法卖出，因此计算最大收益时，从第2日开始</span>
        cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'high_{}l'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> hold_days <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        candidate_df<span class="token punctuation">[</span><span class="token string">'max_high'</span><span class="token punctuation">]</span> <span class="token operator">=</span> candidate_df<span class="token punctuation">[</span>cols<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        candidate_df<span class="token punctuation">[</span><span class="token string">'max_profit'</span><span class="token punctuation">]</span> <span class="token operator">=</span> candidate_df<span class="token punctuation">[</span><span class="token string">'max_high'</span><span class="token punctuation">]</span> <span class="token operator">/</span> candidate_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'open_1l'</span><span class="token punctuation">,</span> <span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>

        <span class="token comment"># 计算最大亏损</span>
        cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'low_{}l'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> hold_days <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        candidate_df<span class="token punctuation">[</span><span class="token string">'min_low'</span><span class="token punctuation">]</span> <span class="token operator">=</span> candidate_df<span class="token punctuation">[</span>cols<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        candidate_df<span class="token punctuation">[</span><span class="token string">'max_loss'</span><span class="token punctuation">]</span> <span class="token operator">=</span> candidate_df<span class="token punctuation">[</span><span class="token string">'min_low'</span><span class="token punctuation">]</span> <span class="token operator">/</span> candidate_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'open_1l'</span><span class="token punctuation">,</span> <span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>

    <span class="token keyword">return</span> candidate_df


<span class="token keyword">def</span> <span class="token function">multiprocessing_func_df</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    多进程调用函数，收集返回各子进程返回的DataFrame

    :param func: 函数名
    :param args: func的参数，类型为元组，第0个元素为进程数，第1个元素为股票代码列表
    :return: 包含各子进程返回值的DataFrame
    """</span>

    <span class="token comment"># 多进程调用函数func，获取子进程返回对象的列表</span>
    results <span class="token operator">=</span> multiprocessing_func<span class="token punctuation">(</span>func<span class="token punctuation">,</span> args<span class="token punctuation">)</span>

    <span class="token comment"># 构建空DataFrame</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 收集各进程返回值</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> results<span class="token punctuation">:</span>
        df <span class="token operator">=</span> df<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> df


<span class="token keyword">def</span> <span class="token function">profit_loss_statistic_mp</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">,</span> process_num<span class="token operator">=</span><span class="token number">61</span><span class="token punctuation">,</span> hold_days<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    多进程盈亏分布统计，计算当日candidate为True，持仓hold_days天的收益分布
    输出数据分布表格及图片文件

    :param stock_codes: 待分析的股票代码
    :param process_num: 进程数
    :param hold_days: 持仓天数
    :return: None
    """</span>

    <span class="token comment"># 多进程计算获得候选股票数据</span>
    candidate_df <span class="token operator">=</span> multiprocessing_func_df<span class="token punctuation">(</span>profit_loss_statistic<span class="token punctuation">,</span> <span class="token punctuation">(</span>process_num<span class="token punctuation">,</span> stock_codes<span class="token punctuation">,</span> hold_days<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 将收益分布数据保存到excel文件</span>
    candidate_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">,</span> <span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'max_profit'</span><span class="token punctuation">,</span> <span class="token string">'max_loss'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_excel<span class="token punctuation">(</span>
        <span class="token string">'profit_loss_{}.xlsx'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>hold_days<span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

    <span class="token comment"># 重置索引，方便后面绘图</span>
    candidate_df<span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># 设置绘图格式并绘图</span>
    fig<span class="token punctuation">,</span> ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    table<span class="token punctuation">(</span>ax<span class="token punctuation">,</span> np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>candidate_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'max_profit'</span><span class="token punctuation">,</span> <span class="token string">'max_loss'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>describe<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loc<span class="token operator">=</span><span class="token string">'upper right'</span><span class="token punctuation">,</span>
          colWidths<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    candidate_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'max_profit'</span><span class="token punctuation">,</span> <span class="token string">'max_loss'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>ax<span class="token operator">=</span>ax<span class="token punctuation">,</span> legend<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>

    <span class="token comment"># 保存图表</span>
    fig<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'profit_loss_{}.png'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>hold_days<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 显示图表</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">update_data</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">,</span> query_days<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">,</span> adjustflag<span class="token operator">=</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    更新日线数据，计算相关因子

    :param stock_codes: 待更新数据的股票代码
    :param query_days: 在数据库中查询历史日线数据的天数，用于计算扩展因子，需要根据扩展因子设置，这里要计算60日均线，所以最小设置为60
    :param adjustflag: 复权选项 1：后复权  2：前复权  3：不复权  默认为前复权
    :return: 包含所有待处理股票的最新日线数据及扩展因子的DataFrame
    """</span>

    <span class="token comment"># 创建数据库引擎对象</span>
    engine <span class="token operator">=</span> create_mysql_engine<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 创建空DataFrame，存储最新一日的数据</span>
    latest_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 更新数据循环</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> code <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'({}/{})正在更新{}...'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 登录BaoStock</span>
        bs<span class="token punctuation">.</span>login<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 股票数据在数据库中的表名</span>
        table_name <span class="token operator">=</span> <span class="token string">'{}_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>code<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> code<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># 判断是否存在该表，不存在则跳过</span>
        <span class="token keyword">if</span> table_name <span class="token keyword">not</span> <span class="token keyword">in</span> sqlalchemy<span class="token punctuation">.</span>inspect<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">.</span>get_table_names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        <span class="token comment"># 获取按时间排序的最后query_days行数据</span>
        sql_cmd <span class="token operator">=</span> <span class="token string">'SELECT * FROM {} ORDER BY date DESC LIMIT {};'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>table_name<span class="token punctuation">,</span> query_days<span class="token punctuation">)</span>
        read_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span>sql<span class="token operator">=</span>sql_cmd<span class="token punctuation">,</span> con<span class="token operator">=</span>engine<span class="token punctuation">)</span>

        <span class="token comment"># 如果数据少于query_days，则不更新</span>
        <span class="token keyword">if</span> read_df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> query_days<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        <span class="token comment"># 数据按id(date)升序排序</span>
        read_df <span class="token operator">=</span> read_df<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'id'</span><span class="token punctuation">,</span> ascending<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        <span class="token comment"># 获取数据库中最新数据日期及id</span>
        last_id <span class="token operator">=</span> read_df<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        from_date <span class="token operator">=</span> read_df<span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token comment"># 如果数据库中已包含最新一日数据</span>
        <span class="token keyword">if</span> from_date <span class="token operator">&gt;=</span> datetime<span class="token punctuation">.</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

            <span class="token comment"># 将最新一日数据，添加code字段，append到latest_df中，并进行下一只股票更新</span>
            latest_series <span class="token operator">=</span> read_df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            latest_series<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> code<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            latest_df <span class="token operator">=</span> latest_df<span class="token punctuation">.</span>append<span class="token punctuation">(</span>latest_series<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{}当前已为最新数据'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>

        <span class="token comment"># 计算待更新数据的开始日期</span>
        from_date <span class="token operator">=</span> <span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>
            from_date<span class="token punctuation">,</span> <span class="token string">'%Y-%m-%d'</span><span class="token punctuation">)</span> <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d'</span><span class="token punctuation">)</span>

        <span class="token comment"># 下载日线数据</span>
        out_df <span class="token operator">=</span> bs<span class="token punctuation">.</span>query_history_k_data_plus<span class="token punctuation">(</span>code<span class="token punctuation">,</span> g_baostock_data_fields<span class="token punctuation">,</span> start_date<span class="token operator">=</span>from_date<span class="token punctuation">,</span>
                                              end_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                              frequency<span class="token operator">=</span><span class="token string">'d'</span><span class="token punctuation">,</span> adjustflag<span class="token operator">=</span>adjustflag<span class="token punctuation">)</span><span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 剔除停盘数据</span>
        <span class="token keyword">if</span> out_df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            out_df <span class="token operator">=</span> out_df<span class="token punctuation">[</span><span class="token punctuation">(</span>out_df<span class="token punctuation">[</span><span class="token string">'volume'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>out_df<span class="token punctuation">[</span><span class="token string">'volume'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment"># 如果数据为空，则不更新</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> out_df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        <span class="token comment"># 将数值数据转为float型，便于后续处理</span>
        convert_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token string">'high'</span><span class="token punctuation">,</span> <span class="token string">'low'</span><span class="token punctuation">,</span> <span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token string">'preclose'</span><span class="token punctuation">,</span> <span class="token string">'volume'</span><span class="token punctuation">,</span> <span class="token string">'amount'</span><span class="token punctuation">,</span> <span class="token string">'turn'</span><span class="token punctuation">,</span> <span class="token string">'pctChg'</span><span class="token punctuation">]</span>
        out_df<span class="token punctuation">[</span>convert_list<span class="token punctuation">]</span> <span class="token operator">=</span> out_df<span class="token punctuation">[</span>convert_list<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span>

        <span class="token comment"># 新添加行数</span>
        new_rows <span class="token operator">=</span> out_df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token comment"># 获取下载字段，拼接DataFrame，用于后续计算扩展指标</span>
        out_df <span class="token operator">=</span> read_df<span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">(</span>out_df<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>out_df<span class="token punctuation">)</span>

        <span class="token comment"># 重置索引</span>
        out_df<span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        <span class="token comment"># 计算扩展因子</span>
        out_df <span class="token operator">=</span> extend_factor<span class="token punctuation">(</span>out_df<span class="token punctuation">)</span>

        <span class="token comment"># 取最后new_rows行</span>
        out_df <span class="token operator">=</span> out_df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token operator">-</span>new_rows<span class="token punctuation">:</span><span class="token punctuation">]</span>

        <span class="token comment"># 判读是否有字段缺失</span>
        <span class="token keyword">if</span> np<span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span>out_df<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{}有缺失字段！！！'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 更新id</span>
        out_df<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>last_id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> last_id <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> new_rows<span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token operator">=</span>out_df<span class="token punctuation">.</span>index<span class="token punctuation">)</span>

        <span class="token comment"># 将更新数据写入数据库</span>
        out_df<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span>name<span class="token operator">=</span>table_name<span class="token punctuation">,</span> con<span class="token operator">=</span>engine<span class="token punctuation">,</span> if_exists<span class="token operator">=</span><span class="token string">'append'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        <span class="token comment"># 将更新的最后一行添加code字段，append到latest_df中</span>
        latest_series <span class="token operator">=</span> out_df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        latest_series<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> code<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        latest_df <span class="token operator">=</span> latest_df<span class="token punctuation">.</span>append<span class="token punctuation">(</span>latest_series<span class="token punctuation">)</span>

    <span class="token comment"># 返回包含最新一日股票日线数据的DataFrame</span>
    <span class="token keyword">return</span> latest_df


<span class="token keyword">def</span> <span class="token function">update_data_mp</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">,</span> process_num<span class="token operator">=</span><span class="token number">61</span><span class="token punctuation">,</span> query_days<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">,</span> adjustflag<span class="token operator">=</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    使用多进程更新日线数据，计算扩展因子

    :param stock_codes: 待更新数据的股票代码
    :param process_num: 进程数
    :param query_days: 在数据库中查询历史日线数据的天数，用于计算扩展因子
    :param adjustflag: 复权选项 1：后复权  2：前复权  3：不复权  默认为前复权
    :return: 包含所有待处理股票的最新日线数据的DataFrame
    """</span>

    <span class="token comment"># 多进程更新数据，获取最新日线数据的DataFrame</span>
    latest_df <span class="token operator">=</span> multiprocessing_func_df<span class="token punctuation">(</span>update_data<span class="token punctuation">,</span> <span class="token punctuation">(</span>process_num<span class="token punctuation">,</span> stock_codes<span class="token punctuation">,</span> query_days<span class="token punctuation">,</span> adjustflag<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 将所有股票最新日线数据写入数据库表latest</span>
    <span class="token keyword">if</span> latest_df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        latest_df<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'latest'</span><span class="token punctuation">,</span> con<span class="token operator">=</span>create_mysql_engine<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> if_exists<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> latest_df


<span class="token keyword">def</span> <span class="token function">update_latest_table</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    更新数据库中最新日线数据表

    从数据库中读取每只股票的最新一天数据并返回

    :param stock_codes: 待更新数据的股票代码
    :return: 包含所有待处理股票的最新日线数据的DataFrame
    """</span>

    <span class="token comment"># 创建数据库引擎对象</span>
    engine <span class="token operator">=</span> create_mysql_engine<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 创建空的DataFrame</span>
    latest_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 更新数据循环</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> code <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'({}/{})正在更新{}...'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 股票数据在数据库中的表名</span>
        table_name <span class="token operator">=</span> <span class="token string">'{}_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>code<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> code<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># 判断是否存在该表，不存在则跳过</span>
        <span class="token keyword">if</span> table_name <span class="token keyword">not</span> <span class="token keyword">in</span> sqlalchemy<span class="token punctuation">.</span>inspect<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">.</span>get_table_names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        <span class="token comment"># 从数据库中读取股票的最新一天数据</span>
        sql_cmd <span class="token operator">=</span> <span class="token string">'SELECT * FROM {} ORDER BY date DESC LIMIT 1;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>table_name<span class="token punctuation">)</span>
        df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span>sql<span class="token operator">=</span>sql_cmd<span class="token punctuation">,</span> con<span class="token operator">=</span>engine<span class="token punctuation">)</span>

        <span class="token comment"># 有缺失字段就不参与候选</span>
        <span class="token keyword">if</span> np<span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{}有缺失字段！！！'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>

        <span class="token comment"># 添加code字段，并append到latest_df中</span>
        df<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> code<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        latest_df <span class="token operator">=</span> latest_df<span class="token punctuation">.</span>append<span class="token punctuation">(</span>df<span class="token punctuation">)</span>

    <span class="token keyword">return</span> latest_df


<span class="token keyword">def</span> <span class="token function">update_latest_table_mp</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">,</span> process_num<span class="token operator">=</span><span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    多进程更新数据库中最新日线数据表

    从各个进程收集每只股票的最新一天数据并返回

    :param stock_codes: 待更新数据的股票代码
    :param process_num: 进程数
    :return: 包含所有待处理股票的最新日线数据的DataFrame
    """</span>

    <span class="token comment"># 多进程更新最新日线数据表，获取该表数据的DataFrame</span>
    latest_df <span class="token operator">=</span> multiprocessing_func_df<span class="token punctuation">(</span>update_latest_table<span class="token punctuation">,</span> <span class="token punctuation">(</span>process_num<span class="token punctuation">,</span> stock_codes<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 将所有股票最新日线数据写入数据库表latest</span>
    <span class="token keyword">if</span> latest_df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        latest_df<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'latest'</span><span class="token punctuation">,</span> con<span class="token operator">=</span>create_mysql_engine<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> if_exists<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> latest_df


<span class="token keyword">def</span> <span class="token function">query_latest_table</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">,</span> by_latest_table<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    查询最新日线数据表

    :param stock_codes: 待获取最新日线数据的股票代码
    :param by_latest_table: 是否通过表latest查询，为True（默认）时，直接从表latest中查询，否则从各个股票数据表中分别读取
    :return: 包含所有待处理股票的最新日线数据的DataFrame
    """</span>

    <span class="token comment"># 创建数据库引擎对象</span>
    engine <span class="token operator">=</span> create_mysql_engine<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 如果设置直接从表latest查询，且表latest存在，则直接从数据库读取数据返回</span>
    <span class="token keyword">if</span> by_latest_table <span class="token keyword">and</span> <span class="token string">'latest'</span> <span class="token keyword">in</span> sqlalchemy<span class="token punctuation">.</span>inspect<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">.</span>get_table_names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sql_cmd <span class="token operator">=</span> <span class="token string">'SELECT * FROM latest;'</span>
        <span class="token keyword">return</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span>sql<span class="token operator">=</span>sql_cmd<span class="token punctuation">,</span> con<span class="token operator">=</span>engine<span class="token punctuation">)</span>

    <span class="token comment"># 否则从各股票数据表中分别读取最新一日数据再返回（过程中会更新表latest）</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> update_latest_table_mp<span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">update_trade</span><span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    更新交易数据

    :param stock_codes: 更新股票范围
    :return: None
    """</span>

    <span class="token comment"># 查询最新日线数据</span>
    df <span class="token operator">=</span> query_latest_table<span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span>

    <span class="token comment"># 筛选出候选股票</span>
    df <span class="token operator">=</span> df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'candidate'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        df <span class="token operator">=</span> df<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'turn'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    stock_codes <span class="token operator">=</span> get_stock_codes<span class="token punctuation">(</span><span class="token punctuation">)</span>
    update_trade<span class="token punctuation">(</span>stock_codes<span class="token punctuation">)</span>
    end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'程序运行时间：{}s'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>end_time <span class="token operator">-</span> start_time<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<p><strong>博客内容只用于交流学习，不构成投资建议，盈亏自负！</strong></p> 
<p>个人博客：http://coderx.com.cn/（优先更新）<br> 项目最新代码：https://gitee.com/sl/quant_from_scratch<br> 欢迎大家转发、留言。有微信群用于学习交流，感兴趣的读者请扫码加微信！<br> 如果认为博客对您有帮助，可以扫码进行捐赠，感谢！</p> 
<table><thead><tr><th align="center">微信二维码</th><th align="center">微信捐赠二维码</th></tr></thead><tbody><tr><td align="center"></td><td align="center"></td></tr><tr><td align="center"><img src="https://images2.imgbox.com/50/e4/eNX9lxPy_o.png" alt="在这里插入图片描述"></td><td align="center"><img src="https://images2.imgbox.com/ca/4c/7fc6SHHw_o.png" alt="在这里插入图片描述"></td></tr></tbody></table>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d150e0d1b16ea581296dcd6e4c56a0c6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">开聊PTrade交易——从零到实盘16</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/85c6967af9e16ccb56de51ad029a7fb1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python量化交易学习笔记（42）——深度学习挖短线股2</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>