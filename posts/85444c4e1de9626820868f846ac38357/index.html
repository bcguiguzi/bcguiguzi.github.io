<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>根据OSS子账户获取STS的TOKEN - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="根据OSS子账户获取STS的TOKEN" />
<meta property="og:description" content="前言 目前来说，很多公司都使用者阿里云的资源，对象存储（OSS）就是其中一个我们经常使用的一个资源，在这个使用的过程中，如果我们想要做到一些安全管理（Security Token Service，简称 STS），以及资源的访问控制（Resource Access Management，简称 RAM），这里面也就是官方描述的RAM和STS。
如果你们平台对接很多个合作方，每个合作方又不想从阿里云中重新购买一个新的阿里云的oss，又想实现对每个合作方的资源的一个访问控制，以及权限管理，那么通过这种结合RAM和STS的方式，就非常容易解决这个问题。
阿里云的官方文档并未给出根据子账户的信息如何获取sts的token的例子，获取sts的token的流程有涉及到加签以及urlencode的处理，以及HMAC-SHA1算法的处理，所以这里面有一些坑，由于网上也没有找到详细的例子，官方也没给出例子，直是简单说了这个流程，所以自己倒腾了半天，才整理出来，并拿到生产上使用，下面结合代码说一下这个整体的实现流程。
实现逻辑 下面这个是官方给出的实现说明
根据子账户获取STS的TOKEN 生成sts的toke的工具类
import java.io.UnsupportedEncodingException; import java.net.URLEncoder; import java.text.SimpleDateFormat; import java.util.Date; import java.util.TimeZone; import java.util.UUID; import javax.crypto.Mac; import javax.crypto.spec.SecretKeySpec; import org.apache.commons.codec.binary.Base64; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; /** * @ClassName: GenTempOssUtil * @Description: 生成临时的oss信息 * @author wenhuixiang * @date 2018年5月30日 下午4:35:10 * */ public class GenTempOssUtil { private static final String ENCODING = &#34;UTF-8&#34;; private static final String STANDARD_DATE_FORMAT_UTC = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/85444c4e1de9626820868f846ac38357/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-05-30T23:20:23+08:00" />
<meta property="article:modified_time" content="2018-05-30T23:20:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">根据OSS子账户获取STS的TOKEN</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3 id="前言">前言</h3> 
<p>目前来说，很多公司都使用者阿里云的资源，对象存储（OSS）就是其中一个我们经常使用的一个资源，在这个使用的过程中，如果我们想要做到一些安全管理（Security Token Service，简称 STS），以及资源的访问控制（Resource Access Management，简称 RAM），这里面也就是官方描述的RAM和STS。</p> 
<p>如果你们平台对接很多个合作方，每个合作方又不想从阿里云中重新购买一个新的阿里云的oss，又想实现对每个合作方的资源的一个访问控制，以及权限管理，那么通过这种结合RAM和STS的方式，就非常容易解决这个问题。</p> 
<p>阿里云的官方文档并未给出根据子账户的信息如何获取sts的token的例子，获取sts的token的流程有涉及到加签以及urlencode的处理，以及HMAC-SHA1算法的处理，所以这里面有一些坑，由于网上也没有找到详细的例子，官方也没给出例子，直是简单说了这个流程，所以自己倒腾了半天，才整理出来，并拿到生产上使用，下面结合代码说一下这个整体的实现流程。</p> 
<h3 id="实现逻辑">实现逻辑</h3> 
<p>下面这个是官方给出的实现说明</p> 
<p><img src="https://images2.imgbox.com/04/30/dFkYskRB_o.png" alt="这里写图片描述" title=""></p> 
<h3 id="根据子账户获取sts的token">根据子账户获取STS的TOKEN</h3> 
<p>生成sts的toke的工具类</p> 
<pre class="prettyprint"><code class=" hljs java">
<span class="hljs-keyword">import</span> java.io.UnsupportedEncodingException;
<span class="hljs-keyword">import</span> java.net.URLEncoder;
<span class="hljs-keyword">import</span> java.text.SimpleDateFormat;
<span class="hljs-keyword">import</span> java.util.Date;
<span class="hljs-keyword">import</span> java.util.TimeZone;
<span class="hljs-keyword">import</span> java.util.UUID;

<span class="hljs-keyword">import</span> javax.crypto.Mac;
<span class="hljs-keyword">import</span> javax.crypto.spec.SecretKeySpec;

<span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;

<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;



<span class="hljs-javadoc">/** 
*<span class="hljs-javadoctag"> @ClassName</span>: GenTempOssUtil 
*<span class="hljs-javadoctag"> @Description</span>: 生成临时的oss信息
*<span class="hljs-javadoctag"> @author</span> wenhuixiang
*<span class="hljs-javadoctag"> @date</span> 2018年5月30日 下午4:35:10 
*  
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GenTempOssUtil</span> {<!-- --></span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String ENCODING = <span class="hljs-string">"UTF-8"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String STANDARD_DATE_FORMAT_UTC = <span class="hljs-string">"yyyy-MM-dd'T'HH:mm:ss'Z'"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String HMAC_SHA1_ALGORITHM = <span class="hljs-string">"HmacSHA1"</span>;  

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> Logger log = LoggerFactory.getLogger(HttpClientUtil.class);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(String[] args)<span class="hljs-keyword">throws</span> Exception {
        String accessId=<span class="hljs-string">"你的accessId信息"</span>;
        String secretKey=<span class="hljs-string">"你的secretKey信息"</span>;
        String arn=<span class="hljs-string">"你的arn信息"</span>;
        genOssInfo(accessId, secretKey, arn);
    }


    <span class="hljs-javadoc">/** 
    *<span class="hljs-javadoctag"> @Title</span>: genOssInfo 
    *<span class="hljs-javadoctag"> @Description</span>:  生产临时的 oss 信息
    *<span class="hljs-javadoctag"> @param</span><span class="hljs-javadoctag"> @param</span> accessId 子账户的accessId
    *<span class="hljs-javadoctag"> @param</span><span class="hljs-javadoctag"> @param</span> secretKey 子账户的secretKey
    *<span class="hljs-javadoctag"> @param</span><span class="hljs-javadoctag"> @param</span> arn       对应子账户的权限信息等
    */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">genOssInfo</span>(String accessId,String secretKey,String arn){
        StringBuilder stringToSign=<span class="hljs-keyword">new</span> StringBuilder();
        StringBuilder canonicalizedQueryString=<span class="hljs-keyword">new</span> StringBuilder();
        StringBuilder reqBuilder=<span class="hljs-keyword">new</span> StringBuilder();
        String resp=<span class="hljs-keyword">null</span>;
        String uuid=UUID.randomUUID().toString();

        SimpleDateFormat sdf = <span class="hljs-keyword">new</span> SimpleDateFormat(STANDARD_DATE_FORMAT_UTC);
        sdf.setTimeZone(TimeZone.getTimeZone(<span class="hljs-string">"UTC"</span>));
        String timestamp =sdf.format(<span class="hljs-keyword">new</span> Date());

        stringToSign.append(<span class="hljs-string">"GET&amp;%2F&amp;"</span>);

        <span class="hljs-keyword">try</span> {
            canonicalizedQueryString.append(<span class="hljs-string">"AccessKeyId="</span>+URLEncoder.encode(accessId,ENCODING))
            .append(<span class="hljs-string">"&amp;Action="</span>+URLEncoder.encode(<span class="hljs-string">"AssumeRole"</span>,ENCODING))
            .append(<span class="hljs-string">"&amp;Format="</span>+URLEncoder.encode(<span class="hljs-string">"JSON"</span>,ENCODING))
            .append(<span class="hljs-string">"&amp;GET="</span>)
            .append(<span class="hljs-string">"&amp;RoleArn="</span>+URLEncoder.encode(arn,ENCODING))
            .append(<span class="hljs-string">"&amp;RoleSessionName="</span>+URLEncoder.encode(<span class="hljs-string">"client"</span>,ENCODING))
            .append(<span class="hljs-string">"&amp;SignatureMethod="</span>+URLEncoder.encode(<span class="hljs-string">"HMAC-SHA1"</span>,ENCODING))
            .append(<span class="hljs-string">"&amp;SignatureNonce="</span>+URLEncoder.encode(uuid,ENCODING))
            .append(<span class="hljs-string">"&amp;SignatureVersion="</span>+URLEncoder.encode(<span class="hljs-string">"1.0"</span>,ENCODING))
            .append(<span class="hljs-string">"&amp;Timestamp="</span>+URLEncoder.encode(timestamp,ENCODING))
            .append(<span class="hljs-string">"&amp;Version="</span>+URLEncoder.encode(<span class="hljs-string">"2015-04-01"</span>,ENCODING));

            stringToSign.append(URLEncoder.encode(canonicalizedQueryString.toString(),ENCODING));

            log.info(<span class="hljs-string">"加签字符串:"</span>+stringToSign.toString());
            String genHMAC = genHMAC(stringToSign.toString(),secretKey+<span class="hljs-string">"&amp;"</span>);  

            reqBuilder.append(<span class="hljs-string">"Format="</span>+URLEncoder.encode(<span class="hljs-string">"JSON"</span>,ENCODING))
            .append(<span class="hljs-string">"&amp;Version="</span>+URLEncoder.encode(<span class="hljs-string">"2015-04-01"</span>,ENCODING))
            .append(<span class="hljs-string">"&amp;AccessKeyId="</span>+URLEncoder.encode(accessId,ENCODING))
            .append(<span class="hljs-string">"&amp;Signature="</span>+URLEncoder.encode(genHMAC,ENCODING))
            .append(<span class="hljs-string">"&amp;SignatureMethod="</span>+URLEncoder.encode(<span class="hljs-string">"HMAC-SHA1"</span>,ENCODING))
            .append(<span class="hljs-string">"&amp;SignatureVersion="</span>+URLEncoder.encode(<span class="hljs-string">"1.0"</span>,ENCODING))
            .append(<span class="hljs-string">"&amp;SignatureNonce="</span>+URLEncoder.encode(uuid,ENCODING))
            .append(<span class="hljs-string">"&amp;Timestamp="</span>+URLEncoder.encode(timestamp,ENCODING))
            .append(<span class="hljs-string">"&amp;Action="</span>+URLEncoder.encode(<span class="hljs-string">"AssumeRole"</span>,ENCODING))
            .append(<span class="hljs-string">"&amp;GET="</span>)
            .append(<span class="hljs-string">"&amp;RoleArn="</span>+URLEncoder.encode(arn,ENCODING))
            .append(<span class="hljs-string">"&amp;RoleSessionName="</span>+URLEncoder.encode(<span class="hljs-string">"client"</span>,ENCODING));
        } <span class="hljs-keyword">catch</span> (UnsupportedEncodingException e1) {
            resp=<span class="hljs-string">"{\"msg\":\"获取oss信息参数编码转换异常\"}"</span>;
            log.error(<span class="hljs-string">"获取oss信息参数编码转换异常"</span>,e1);
        }

        <span class="hljs-keyword">try</span> {
            String reqUrl=<span class="hljs-string">"https://sts.aliyuncs.com/?"</span>+reqBuilder.toString();
            log.info(<span class="hljs-string">"请求 获取临时的 oss 信息 地址："</span>+reqUrl);
            resp=HttpClientUtil.getRequest(reqUrl);
            JSONObject obj=JSON.parseObject(resp);
            obj.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"success"</span>);
            obj.put(<span class="hljs-string">"desc"</span>, <span class="hljs-string">"success"</span>);
            resp=JSON.toJSONString(obj);
            log.info(<span class="hljs-string">"阿里云返回的 oss 结果信息 ："</span>+resp);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            JSONObject obj=<span class="hljs-keyword">new</span> JSONObject();
            obj.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"failed"</span>);
            obj.put(<span class="hljs-string">"desc"</span>, <span class="hljs-string">"获取临时的oss信息异常"</span>);
            resp=JSON.toJSONString(obj);
            log.error(<span class="hljs-string">"获取临时的oss信息异常"</span>,e);
        }
     <span class="hljs-keyword">return</span> resp;
    }


    <span class="hljs-javadoc">/** 
     * 使用 HMAC-SHA1 签名方法对data进行签名 
     *  
     *<span class="hljs-javadoctag"> @param</span> data  被签名的字符串 
     *<span class="hljs-javadoctag"> @param</span> key   密钥      
     *<span class="hljs-javadoctag"> @return</span>      加密后的字符串 
     */</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">genHMAC</span>(String data, String key) {  
        <span class="hljs-keyword">byte</span>[] result = <span class="hljs-keyword">null</span>;  
        <span class="hljs-keyword">try</span> {  
            <span class="hljs-comment">//根据给定的字节数组构造一个密钥,第二参数指定一个密钥算法的名称    </span>
            SecretKeySpec signinKey = <span class="hljs-keyword">new</span> SecretKeySpec(key.getBytes(), HMAC_SHA1_ALGORITHM);  
            <span class="hljs-comment">//生成一个指定 Mac 算法 的 Mac 对象    </span>
            Mac mac = Mac.getInstance(HMAC_SHA1_ALGORITHM);  
            <span class="hljs-comment">//用给定密钥初始化 Mac 对象    </span>
            mac.init(signinKey);  
            <span class="hljs-comment">//完成 Mac 操作     </span>
            <span class="hljs-keyword">byte</span>[] rawHmac = mac.doFinal(data.getBytes());  
            result = Base64.encodeBase64(rawHmac);  

        } <span class="hljs-keyword">catch</span> (Exception e) {  
           log.error(<span class="hljs-string">"HMAC-SHA1 加密失败"</span>,e);
        }  
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != result) {  
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> String(result);  
        } <span class="hljs-keyword">else</span> {  
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;  
        }  
    }  
}</code></pre> 
<p>https请求的工具类</p> 
<pre class="prettyprint"><code class=" hljs java">
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Iterator;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">import</span> org.apache.commons.collections.MapUtils;
<span class="hljs-keyword">import</span> org.apache.commons.httpclient.HttpClient;
<span class="hljs-keyword">import</span> org.apache.commons.httpclient.HttpConnectionManager;
<span class="hljs-keyword">import</span> org.apache.commons.httpclient.HttpStatus;
<span class="hljs-keyword">import</span> org.apache.commons.httpclient.MultiThreadedHttpConnectionManager;
<span class="hljs-keyword">import</span> org.apache.commons.httpclient.NameValuePair;
<span class="hljs-keyword">import</span> org.apache.commons.httpclient.methods.GetMethod;
<span class="hljs-keyword">import</span> org.apache.commons.httpclient.methods.PostMethod;
<span class="hljs-keyword">import</span> org.apache.commons.httpclient.methods.StringRequestEntity;
<span class="hljs-keyword">import</span> org.apache.commons.httpclient.params.HttpConnectionManagerParams;
<span class="hljs-keyword">import</span> org.apache.commons.httpclient.params.HttpMethodParams;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;


<span class="hljs-javadoc">/** 
*<span class="hljs-javadoctag"> @ClassName</span>: GenTempOssUtil 
*<span class="hljs-javadoctag"> @Description</span>: 类HttpClientUtil.java的实现描述：httpclient工具类
*<span class="hljs-javadoctag"> @author</span> wenhuixiang
*<span class="hljs-javadoctag"> @date</span> 2018年5月30日 下午4:35:10 
*  
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpClientUtil</span> {<!-- --></span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String RETURN_CODE_FAIL = <span class="hljs-string">"request_fail"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> Logger logger = LoggerFactory.getLogger(HttpClientUtil.class);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> timeout = <span class="hljs-number">30000</span>;
    <span class="hljs-javadoc">/**
     * 每个主机最大连接数
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> maxConnectionsPerHost = <span class="hljs-number">20</span>;
    <span class="hljs-javadoc">/**
     * 最大总共连接数
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> maxTotalConnection = <span class="hljs-number">100</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String encoding = <span class="hljs-string">"UTF-8"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-title">HttpClientUtil</span>() {
    }

    <span class="hljs-javadoc">/**
     * post请求
     *
     *<span class="hljs-javadoctag"> @param</span> url    请求地址
     *<span class="hljs-javadoctag"> @param</span> params 请求参数
     *<span class="hljs-javadoctag"> @return</span> 返回结果
     *<span class="hljs-javadoctag"> @throws</span> Exception
     */</span>
    <span class="hljs-annotation">@SuppressWarnings</span>(<span class="hljs-string">"rawtypes"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">postRequest</span>(String url, Map&lt;String, String&gt; params) {
        <span class="hljs-keyword">return</span> postRequest(url, <span class="hljs-keyword">null</span>, params);
    }

    <span class="hljs-javadoc">/**
     * post请求
     *
     *<span class="hljs-javadoctag"> @param</span> url    请求地址
     *<span class="hljs-javadoctag"> @param</span> header 请求头
     *<span class="hljs-javadoctag"> @param</span> params 请求参数
     *<span class="hljs-javadoctag"> @return</span> 返回结果
     *<span class="hljs-javadoctag"> @throws</span> Exception
     */</span>
    <span class="hljs-annotation">@SuppressWarnings</span>(<span class="hljs-string">"rawtypes"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">postRequest</span>(String url, Map&lt;String, String&gt; header, Map&lt;String, String&gt; params) {
        String result = <span class="hljs-string">""</span>;
        PostMethod postMethod = <span class="hljs-keyword">null</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//创建连接</span>
            HttpClient httpClient = <span class="hljs-keyword">new</span> HttpClient(HttpClientUtilHolder.httpConnectionManager);
            <span class="hljs-comment">// 设置编码</span>
            httpClient.getParams().setContentCharset(encoding);
            httpClient.getParams().setHttpElementCharset(encoding);
            httpClient.getParams().setParameter(HttpMethodParams.HTTP_CONTENT_CHARSET, encoding);

            postMethod = <span class="hljs-keyword">new</span> PostMethod(url);

            <span class="hljs-comment">//设置头信息</span>
            <span class="hljs-keyword">if</span> (MapUtils.isNotEmpty(header)) {
                <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : header.entrySet()) {
                    postMethod.setRequestHeader(entry.getKey(), entry.getValue());
                }
            }

            <span class="hljs-comment">//设置参数</span>
            List&lt;NameValuePair&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;NameValuePair&gt;();
            NameValuePair nameValuePair = <span class="hljs-keyword">null</span>;
            Iterator iter = params.entrySet().iterator();
            <span class="hljs-keyword">while</span> (iter.hasNext()) {
                Map.Entry entry = (Map.Entry) iter.next();
                String key = (String) entry.getKey();
                String val = (String) entry.getValue();
                nameValuePair = <span class="hljs-keyword">new</span> NameValuePair(key, val);
                list.add(nameValuePair);
            }
            NameValuePair[] data = list.toArray(<span class="hljs-keyword">new</span> NameValuePair[list.size()]);
            postMethod.setRequestBody(data);

            <span class="hljs-comment">//请求</span>
            logger.info(<span class="hljs-string">"=================httpclient发起请求"</span>);
            httpClient.executeMethod(postMethod);
            logger.info(<span class="hljs-string">"=================httpclient请求结束"</span>);
            result = postMethod.getResponseBodyAsString();
            logger.info(<span class="hljs-string">"httpclient请求结果:{}"</span>, result);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            logger.error(<span class="hljs-string">"=================httpclient请求异常："</span>, e);
            result = RETURN_CODE_FAIL;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (postMethod != <span class="hljs-keyword">null</span>) {
                <span class="hljs-comment">//释放连接</span>
                postMethod.releaseConnection();
            }
        }
        <span class="hljs-keyword">return</span> result;

    }

    <span class="hljs-javadoc">/**
     * post请求-没有参数名，只有参数值
     *
     *<span class="hljs-javadoctag"> @param</span> url  请求地址
     *<span class="hljs-javadoctag"> @param</span> body 请求参数
     *<span class="hljs-javadoctag"> @return</span> 返回结果
     *<span class="hljs-javadoctag"> @throws</span> Exception
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">postRequestOfNoParamName</span>(String url, String body) {
        String result = <span class="hljs-string">""</span>;
        PostMethod postMethod = <span class="hljs-keyword">null</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//创建连接</span>
            HttpClient httpClient = <span class="hljs-keyword">new</span> HttpClient(HttpClientUtilHolder.httpConnectionManager);
            <span class="hljs-comment">// 设置编码</span>
            httpClient.getParams().setContentCharset(encoding);
            httpClient.getParams().setHttpElementCharset(encoding);
            httpClient.getParams().setParameter(HttpMethodParams.HTTP_CONTENT_CHARSET, encoding);

            postMethod = <span class="hljs-keyword">new</span> PostMethod(url);
            postMethod.setRequestEntity(<span class="hljs-keyword">new</span> StringRequestEntity(body, <span class="hljs-string">""</span>, encoding));

            <span class="hljs-comment">//请求</span>
            httpClient.executeMethod(postMethod);
            result = postMethod.getResponseBodyAsString();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            logger.error(<span class="hljs-string">"=================httpclient请求异常异常："</span>, e);
            result = RETURN_CODE_FAIL;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (postMethod != <span class="hljs-keyword">null</span>) {
                <span class="hljs-comment">//释放连接</span>
                postMethod.releaseConnection();
            }
        }
        <span class="hljs-keyword">return</span> result;

    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getRequest</span>(String url) <span class="hljs-keyword">throws</span> Exception {
        String result = <span class="hljs-string">""</span>;
        GetMethod getMethod = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//创建连接</span>
            HttpClient httpClient = <span class="hljs-keyword">new</span> HttpClient(HttpClientUtilHolder.httpConnectionManager);
            <span class="hljs-comment">// 设置编码</span>
            httpClient.getParams().setContentCharset(encoding);
            httpClient.getParams().setHttpElementCharset(encoding);
            httpClient.getParams().setParameter(HttpMethodParams.HTTP_CONTENT_CHARSET, encoding);

            getMethod = <span class="hljs-keyword">new</span> GetMethod(url);
            <span class="hljs-comment">//请求</span>
            <span class="hljs-keyword">int</span> statusCode = httpClient.executeMethod(getMethod);
            <span class="hljs-keyword">if</span> (statusCode == HttpStatus.SC_OK) {
                result = getMethod.getResponseBodyAsString();
            } <span class="hljs-keyword">else</span> {
                result = RETURN_CODE_FAIL;
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            logger.error(<span class="hljs-string">"=================httpclient请求异常异常："</span>, e);
            <span class="hljs-comment">//          result = RETURN_CODE_FAIL;</span>
            result = <span class="hljs-keyword">null</span>;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(e.getMessage(), e);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (getMethod != <span class="hljs-keyword">null</span>) {
                <span class="hljs-comment">//释放连接</span>
                getMethod.releaseConnection();
            }
        }
        <span class="hljs-keyword">return</span> result;

    }

    <span class="hljs-javadoc">/**
     * 单例创建httpConnectionManager.
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpClientUtilHolder</span> {<!-- --></span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HttpConnectionManager httpConnectionManager = initConnectionManager();

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HttpConnectionManager <span class="hljs-title">initConnectionManager</span>() {
            logger.info(<span class="hljs-string">"initConnectionManager"</span>);
            httpConnectionManager = <span class="hljs-keyword">new</span> MultiThreadedHttpConnectionManager();
            HttpConnectionManagerParams params = httpConnectionManager.getParams();
            params.setConnectionTimeout(timeout);
            params.setSoTimeout(timeout);
            params.setDefaultMaxConnectionsPerHost(maxConnectionsPerHost);
            params.setMaxTotalConnections(maxTotalConnection);
            <span class="hljs-keyword">return</span> httpConnectionManager;
        }
    }

}
</code></pre> 
<h3 id="结果示例">结果示例</h3> 
<p><img src="https://images2.imgbox.com/89/a8/G7rFObAE_o.png" alt="这里写图片描述" title=""></p> 
<h3 id="使用获取到的token信息上传文件">使用获取到的token信息上传文件</h3> 
<pre class="prettyprint"><code class=" hljs axapta">
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> main(String[] args) {
        String accessKeyId = <span class="hljs-string">"你获取到的accessKeyId"</span>;
        String accessKeySecret = <span class="hljs-string">"你获取到的secretKey"</span>;
        String securityToken = <span class="hljs-string">"你获取到的token"</span>;
        <span class="hljs-comment">// 以杭州为例</span>
        String endpoint = <span class="hljs-string">"http://oss-cn-hangzhou.aliyuncs.com"</span>;
        OSSClient <span class="hljs-keyword">client</span> = <span class="hljs-keyword">new</span> OSSClient(endpoint, accessKeyId, accessKeySecret, securityToken);

        ObjectMetadata meta = <span class="hljs-keyword">new</span> ObjectMetadata();
        <span class="hljs-comment">// 指定上传的内容类型。</span>
        meta.setContentType(<span class="hljs-string">"text/plain"</span>);

        UploadFileRequest fileReq=<span class="hljs-keyword">new</span> UploadFileRequest(<span class="hljs-string">"&lt;yourBucketName&gt;"</span>,<span class="hljs-string">"&lt;yourObjectName&gt;"</span>);
        <span class="hljs-comment">// 指定上传并发线程数，默认为1。</span>
        fileReq.setTaskNum(<span class="hljs-number">5</span>);
        <span class="hljs-comment">// 指定上传的分片大小，从100KB到5GB，单位是Byte，默认为100K。</span>
        fileReq.setPartSize(<span class="hljs-number">1</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);
        <span class="hljs-comment">// 指定上传的本地文件，必选参数。</span>
        fileReq.setUploadFile(<span class="hljs-string">"C:\\Users\\Administrator\\Desktop\\123.png"</span>);
        <span class="hljs-comment">//Object的元数据。</span>
        fileReq.setObjectMetadata(meta);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">client</span>.uploadFile(fileReq);
        } <span class="hljs-keyword">catch</span> (Throwable e) {
            e.printStackTrace();
        }<span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">client</span>!=<span class="hljs-keyword">null</span>) <span class="hljs-keyword">client</span>.shutdown();
        }
    }</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6a22c3907b1ee10cc83db901b6896ddc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【学习笔记】struts2项目部署出错解决思路，非程序错误</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c3c07e4af48284e1a9130d15f2bc496d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【操作系统】CPU中的时间片的概念</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>