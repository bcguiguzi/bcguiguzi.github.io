<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>swapper_pg_dir的作用 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="swapper_pg_dir的作用" />
<meta property="og:description" content="在内存系统初始化过程中，有如下代码：
1: static void __init pagetable_init(void) 2: { 3: pgd_t *pgd_base = swapper_pg_dir; 4: 5: permanent_kmaps_init(pgd_base); 6: } 这里，我们看到了神秘的swapper_pg_dir，全局搜索一下，发现了
1: /* 2: * Build a proper pagetable for the kernel mappings. Up until this 3: * point, we&#39;ve been running on some set of pagetables constructed by 4: * the boot process. 5: * 6: * If we&#39;re booting on native hardware, this will be a pagetable 7: * constructed in arch/x86/kernel/head_32." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/66e1b70aea9aa1f22b7464f88783f232/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-03T00:29:01+08:00" />
<meta property="article:modified_time" content="2019-07-03T00:29:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">swapper_pg_dir的作用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="cnblogs_post_body" class="blogpost-body"> 
 <p>在内存系统初始化过程中，有如下代码：</p> 
 <div style="border-bottom:#C0C0C0 1px solid;text-align:left;border-left:#C0C0C0 1px solid;line-height:12pt;font-family:'Courier New', courier, monospace;font-size:8pt;border-top:#C0C0C0 1px solid;border-right:#C0C0C0 1px solid;" id="codeSnippetWrapper"> 
  <div style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;" id="codeSnippet"> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum1">   1:</span> <span style="color:#0000ff;">static</span> <span style="color:#0000ff;">void</span> __init pagetable_init(<span style="color:#0000ff;">void</span>)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum2">   2:</span> {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum3">   3:</span>     pgd_t *pgd_base = swapper_pg_dir;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum4">   4:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum5">   5:</span>     permanent_kmaps_init(pgd_base);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum6">   6:</span> }</pre> 
  </div> 
 </div> 
 <p>这里，我们看到了神秘的swapper_pg_dir，全局搜索一下，发现了</p> 
 <div style="border-bottom:#C0C0C0 1px solid;text-align:left;border-left:#C0C0C0 1px solid;line-height:12pt;font-family:'Courier New', courier, monospace;font-size:8pt;border-top:#C0C0C0 1px solid;border-right:#C0C0C0 1px solid;"> 
  <div style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   1:</span> <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   2:</span> <span style="color:#008000;"> * Build a proper pagetable for the kernel mappings.  Up until this</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   3:</span> <span style="color:#008000;"> * point, we've been running on some set of pagetables constructed by</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   4:</span> <span style="color:#008000;"> * the boot process.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   5:</span> <span style="color:#008000;"> *</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   6:</span> <span style="color:#008000;"> * If we're booting on native hardware, this will be a pagetable</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum7">   7:</span> <span style="color:#008000;"> * constructed in arch/x86/kernel/head_32.S.  The root of the</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum8">   8:</span> <span style="color:#008000;"> * pagetable will be swapper_pg_dir.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum9">   9:</span> <span style="color:#008000;"> *</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum10">  10:</span> <span style="color:#008000;"> * If we're booting paravirtualized under a hypervisor, then there are</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum11">  11:</span> <span style="color:#008000;"> * more options: we may already be running PAE, and the pagetable may</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum12">  12:</span> <span style="color:#008000;"> * or may not be based in swapper_pg_dir.  In any case,</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum13">  13:</span> <span style="color:#008000;"> * paravirt_pagetable_setup_start() will set up swapper_pg_dir</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum14">  14:</span> <span style="color:#008000;"> * appropriately for the rest of the initialization to work.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum15">  15:</span> <span style="color:#008000;"> *</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum16">  16:</span> <span style="color:#008000;"> * In general, pagetable_init() assumes that the pagetable may already</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum17">  17:</span> <span style="color:#008000;"> * be partially populated, and so it avoids stomping on any existing</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum18">  18:</span> <span style="color:#008000;"> * mappings.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum19">  19:</span> <span style="color:#008000;"> */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum20">  20:</span> <span style="color:#0000ff;">void</span> __init early_ioremap_page_table_range_init(<span style="color:#0000ff;">void</span>)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum21">  21:</span> {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum22">  22:</span>     pgd_t *pgd_base = swapper_pg_dir;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum23">  23:</span>     <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> vaddr, end;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum24">  24:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum25">  25:</span>     <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum26">  26:</span> <span style="color:#008000;">     * Fixed mappings, only the page table structure has to be</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum27">  27:</span> <span style="color:#008000;">     * created - mappings will be set by set_fixmap():</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum28">  28:</span> <span style="color:#008000;">     */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum29">  29:</span>     vaddr = __fix_to_virt(__end_of_fixed_addresses - 1) &amp; PMD_MASK;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum30">  30:</span>     end = (FIXADDR_TOP + PMD_SIZE - 1) &amp; PMD_MASK;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum31">  31:</span>     page_table_range_init(vaddr, end, pgd_base);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum32">  32:</span>     early_ioremap_reset();</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum33">  33:</span> }</pre> 
  </div> 
 </div> 
 <p> </p> 
 <hr> 
 <p>在head_32.S中，定义了如下的BSS段，BSS段是在内核映像文件中不占空间，但是在内核被加载到内存时，会保留相应的空间。</p> 
 <p>在BSS段，一共保留了4个页面的空间，分别用initial_page_table, initial_pg_fixmap, empty_zero_page和swapper_pg_dir来标志其地址。</p> 
 <div style="border-bottom:#C0C0C0 1px solid;text-align:left;border-left:#C0C0C0 1px solid;line-height:12pt;font-family:'Courier New', courier, monospace;font-size:8pt;border-top:#C0C0C0 1px solid;border-right:#C0C0C0 1px solid;"> 
  <div style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   1:</span> <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   2:</span> <span style="color:#008000;"> * BSS section</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   3:</span> <span style="color:#008000;"> */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   4:</span> __PAGE_ALIGNED_BSS</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   5:</span>     .align PAGE_SIZE</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   6:</span> <span style="color:#cc6633;">#ifdef</span> CONFIG_X86_PAE</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   7:</span> initial_pg_pmd:</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   8:</span>     .fill 1024*KPMDS,4,0</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   9:</span> <span style="color:#cc6633;">#else</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  10:</span> ENTRY(initial_page_table)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  11:</span>     .fill 1024,4,0</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  12:</span> <span style="color:#cc6633;">#endif</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  13:</span> initial_pg_fixmap:</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  14:</span>     .fill 1024,4,0</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  15:</span> ENTRY(empty_zero_page)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  16:</span>     .fill 4096,1,0</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  17:</span> ENTRY(swapper_pg_dir)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  18:</span>     .fill 1024,4,0</pre> 
  </div> 
 </div> 
 <p>通过如下代码，将initial_page_table设置为初始页目录</p> 
 <div style="border-bottom:#C0C0C0 1px solid;text-align:left;border-left:#C0C0C0 1px solid;line-height:12pt;font-family:'Courier New', courier, monospace;font-size:8pt;border-top:#C0C0C0 1px solid;border-right:#C0C0C0 1px solid;"> 
  <div style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   1:</span> <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   2:</span> <span style="color:#008000;"> * Enable paging</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   3:</span> <span style="color:#008000;"> */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   4:</span>     movl $pa(initial_page_table), %eax</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   5:</span>     movl %eax,%cr3        <span style="color:#008000;">/* set the page table pointer.. */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   6:</span>     movl %cr0,%eax</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   7:</span>     orl  $X86_CR0_PG,%eax</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   8:</span>     movl %eax,%cr0        <span style="color:#008000;">/* ..and set paging (PG) bit */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   9:</span>     ljmp $__BOOT_CS,$1f    <span style="color:#008000;">/* Clear prefetch and normalize %eip */</span></pre> 
  </div> 
 </div> 
 <p>在内核初始化阶段，setup_arch调用了如下的函数：</p> 
 <div style="border-bottom:#C0C0C0 1px solid;text-align:left;border-left:#C0C0C0 1px solid;line-height:12pt;font-family:'Courier New', courier, monospace;font-size:8pt;border-top:#C0C0C0 1px solid;border-right:#C0C0C0 1px solid;"> 
  <div style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   1:</span> <span style="color:#0000ff;">void</span> __init setup_arch(<span style="color:#0000ff;">char</span> **cmdline_p)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   2:</span> {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   3:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   4:</span> ......</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   5:</span> <span style="color:#008000;">/* max_pfn_mapped is updated here */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   6:</span> max_low_pfn_mapped = init_memory_mapping(0, max_low_pfn&lt;&lt;PAGE_SHIFT);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   7:</span> max_pfn_mapped = max_low_pfn_mapped;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   8:</span> ......</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   9:</span> x86_init.paging.pagetable_setup_start(swapper_pg_dir);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  10:</span> paging_init();</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  11:</span> x86_init.paging.pagetable_setup_done(swapper_pg_dir);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  12:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  13:</span> ......</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  14:</span> }</pre> 
  </div> 
 </div> 
 <p>init_memory_mapping调用了kernel_physical_mapping_init，初始化swapper_pg_dir</p> 
 <div style="border-bottom:#C0C0C0 1px solid;text-align:left;border-left:#C0C0C0 1px solid;line-height:12pt;font-family:'Courier New', courier, monospace;font-size:8pt;border-top:#C0C0C0 1px solid;border-right:#C0C0C0 1px solid;"> 
  <div style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   1:</span> <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   2:</span> <span style="color:#008000;"> * This maps the physical memory to kernel virtual address space, a total</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   3:</span> <span style="color:#008000;"> * of max_low_pfn pages, by creating page tables starting from address</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   4:</span> <span style="color:#008000;"> * PAGE_OFFSET:</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   5:</span> <span style="color:#008000;"> */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   6:</span> <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> __init</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   7:</span> kernel_physical_mapping_init(<span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> start,</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   8:</span>                  <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> end,</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   9:</span>                  <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> page_size_mask)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  10:</span> {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  11:</span>     <span style="color:#0000ff;">int</span> use_pse = page_size_mask == (1&lt;&lt;PG_LEVEL_2M);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  12:</span>     <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> last_map_addr = end;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  13:</span>     <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> start_pfn, end_pfn;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  14:</span>     pgd_t *pgd_base = swapper_pg_dir;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  15:</span>     <span style="color:#0000ff;">int</span> pgd_idx, pmd_idx, pte_ofs;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  16:</span>     <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">long</span> pfn;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  17:</span>     pgd_t *pgd;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  18:</span>     pmd_t *pmd;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  19:</span>     pte_t *pte;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  20:</span>     <span style="color:#0000ff;">unsigned</span> pages_2m, pages_4k;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  21:</span>     <span style="color:#0000ff;">int</span> mapping_iter;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  22:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  23:</span>     start_pfn = start &gt;&gt; PAGE_SHIFT;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  24:</span>     end_pfn = end &gt;&gt; PAGE_SHIFT;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  25:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  26:</span>     <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  27:</span> <span style="color:#008000;">     * First iteration will setup identity mapping using large/small pages</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  28:</span> <span style="color:#008000;">     * based on use_pse, with other attributes same as set by</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  29:</span> <span style="color:#008000;">     * the early code in head_32.S</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  30:</span> <span style="color:#008000;">     *</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  31:</span> <span style="color:#008000;">     * Second iteration will setup the appropriate attributes (NX, GLOBAL..)</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  32:</span> <span style="color:#008000;">     * as desired for the kernel identity mapping.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  33:</span> <span style="color:#008000;">     *</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum34">  34:</span> <span style="color:#008000;">     * This two pass mechanism conforms to the TLB app note which says:</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum35">  35:</span> <span style="color:#008000;">     *</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum36">  36:</span> <span style="color:#008000;">     *     "Software should not write to a paging-structure entry in a way</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum37">  37:</span> <span style="color:#008000;">     *      that would change, for any linear address, both the page size</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum38">  38:</span> <span style="color:#008000;">     *      and either the page frame or attributes."</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum39">  39:</span> <span style="color:#008000;">     */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum40">  40:</span>     mapping_iter = 1;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum41">  41:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum42">  42:</span>     <span style="color:#0000ff;">if</span> (!cpu_has_pse)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum43">  43:</span>         use_pse = 0;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum44">  44:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum45">  45:</span>     at:</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum46">  46:</span>     pages_2m = pages_4k = 0;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum47">  47:</span>     pfn = start_pfn;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum48">  48:</span>     pgd_idx = pgd_index((pfn&lt;&lt;PAGE_SHIFT) + PAGE_OFFSET);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum49">  49:</span>     pgd = pgd_base + pgd_idx;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum50">  50:</span>     <span style="color:#0000ff;">for</span> (; pgd_idx &lt; PTRS_PER_PGD; pgd++, pgd_idx++) {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum51">  51:</span>         pmd = one_md_table_init(pgd);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum52">  52:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum53">  53:</span>         <span style="color:#0000ff;">if</span> (pfn &gt;= end_pfn)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum54">  54:</span>             <span style="color:#0000ff;">continue</span>;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum55">  55:</span>     ef CONFIG_X86_PAE</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum56">  56:</span>         pmd_idx = pmd_index((pfn&lt;&lt;PAGE_SHIFT) + PAGE_OFFSET);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum57">  57:</span>         pmd += pmd_idx;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum58">  58:</span>     e</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum59">  59:</span>         pmd_idx = 0;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum60">  60:</span>     <span style="color:#0000ff;">if</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum61">  61:</span>         <span style="color:#0000ff;">for</span> (; pmd_idx &lt; PTRS_PER_PMD &amp;&amp; pfn &lt; end_pfn;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum62">  62:</span>              pmd++, pmd_idx++) {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum63">  63:</span>             <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">int</span> addr = pfn * PAGE_SIZE + PAGE_OFFSET;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum64">  64:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum65">  65:</span>             <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum66">  66:</span> <span style="color:#008000;">             * Map with big pages if possible, otherwise</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum67">  67:</span> <span style="color:#008000;">             * create normal page tables:</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum68">  68:</span> <span style="color:#008000;">             */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum69">  69:</span>             <span style="color:#0000ff;">if</span> (use_pse) {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum70">  70:</span>                 <span style="color:#0000ff;">unsigned</span> <span style="color:#0000ff;">int</span> addr2;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum71">  71:</span>                 pgprot_t prot = PAGE_KERNEL_LARGE;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum72">  72:</span>                 <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum73">  73:</span> <span style="color:#008000;">                 * first pass will use the same initial</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum74">  74:</span> <span style="color:#008000;">                 * identity mapping attribute + _PAGE_PSE.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum75">  75:</span> <span style="color:#008000;">                 */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum76">  76:</span>                 pgprot_t init_prot =</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum77">  77:</span>                     __pgprot(PTE_IDENT_ATTR |</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum78">  78:</span>                          _PAGE_PSE);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum79">  79:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum80">  80:</span>                 addr2 = (pfn + PTRS_PER_PTE-1) * PAGE_SIZE +</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum81">  81:</span>                     PAGE_OFFSET + PAGE_SIZE-1;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum82">  82:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum83">  83:</span>                 <span style="color:#0000ff;">if</span> (is_kernel_text(addr) ||</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum84">  84:</span>                     is_kernel_text(addr2))</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum85">  85:</span>                     prot = PAGE_KERNEL_LARGE_EXEC;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum86">  86:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum87">  87:</span>                 pages_2m++;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum88">  88:</span>                 <span style="color:#0000ff;">if</span> (mapping_iter == 1)</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum89">  89:</span>                     set_pmd(pmd, pfn_pmd(pfn, init_prot));</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum90">  90:</span>                 <span style="color:#0000ff;">else</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum91">  91:</span>                     set_pmd(pmd, pfn_pmd(pfn, prot));</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum92">  92:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum93">  93:</span>                 pfn += PTRS_PER_PTE;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum94">  94:</span>                 <span style="color:#0000ff;">continue</span>;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum95">  95:</span>             }</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum96">  96:</span>             pte = one_page_table_init(pmd);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum97">  97:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum98">  98:</span>             pte_ofs = pte_index((pfn&lt;&lt;PAGE_SHIFT) + PAGE_OFFSET);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum99">  99:</span>             pte += pte_ofs;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum100"> 100:</span>             <span style="color:#0000ff;">for</span> (; pte_ofs &lt; PTRS_PER_PTE &amp;&amp; pfn &lt; end_pfn;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum101"> 101:</span>                  pte++, pfn++, pte_ofs++, addr += PAGE_SIZE) {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum102"> 102:</span>                 pgprot_t prot = PAGE_KERNEL;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum103"> 103:</span>                 <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum104"> 104:</span> <span style="color:#008000;">                 * first pass will use the same initial</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum105"> 105:</span> <span style="color:#008000;">                 * identity mapping attribute.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum106"> 106:</span> <span style="color:#008000;">                 */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum107"> 107:</span>                 pgprot_t init_prot = __pgprot(PTE_IDENT_ATTR);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum108"> 108:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum109"> 109:</span>                 <span style="color:#0000ff;">if</span> (is_kernel_text(addr))</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum110"> 110:</span>                     prot = PAGE_KERNEL_EXEC;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum111"> 111:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum112"> 112:</span>                 pages_4k++;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum113"> 113:</span>                 <span style="color:#0000ff;">if</span> (mapping_iter == 1) {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum114"> 114:</span>                     set_pte(pte, pfn_pte(pfn, init_prot));</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum115"> 115:</span>                     last_map_addr = (pfn &lt;&lt; PAGE_SHIFT) + PAGE_SIZE;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum116"> 116:</span>                 } <span style="color:#0000ff;">else</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum117"> 117:</span>                     set_pte(pte, pfn_pte(pfn, prot));</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum118"> 118:</span>             }</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum119"> 119:</span>         }</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum120"> 120:</span>     }</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum121"> 121:</span>     <span style="color:#0000ff;">if</span> (mapping_iter == 1) {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum122"> 122:</span>         <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum123"> 123:</span> <span style="color:#008000;">         * update direct mapping page count only in the first</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum124"> 124:</span> <span style="color:#008000;">         * iteration.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum125"> 125:</span> <span style="color:#008000;">         */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum126"> 126:</span>         update_page_count(PG_LEVEL_2M, pages_2m);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum127"> 127:</span>         update_page_count(PG_LEVEL_4K, pages_4k);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum128"> 128:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum129"> 129:</span>         <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum130"> 130:</span> <span style="color:#008000;">         * local global flush tlb, which will flush the previous</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum131"> 131:</span> <span style="color:#008000;">         * mappings present in both small and large page TLB's.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum132"> 132:</span> <span style="color:#008000;">         */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum133"> 133:</span>         __flush_tlb_all();</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum134"> 134:</span>     </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum135"> 135:</span>         <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum136"> 136:</span> <span style="color:#008000;">         * Second iteration will set the actual desired PTE attributes.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum137"> 137:</span> <span style="color:#008000;">         */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum138"> 138:</span>         mapping_iter = 2;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum139"> 139:</span>         <span style="color:#0000ff;">goto</span> repeat;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum140"> 140:</span>     }</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum141"> 141:</span>     <span style="color:#0000ff;">return</span> last_map_addr;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;" id="lnum142"> 142:</span> }</pre> 
  </div> 
 </div> 
 <blockquote> 
  <p>pgd_t *pgd_base = swapper_pg_dir;</p> 
  <p> </p> 
 </blockquote> 
 <p>将swapper_pg_dir作为页目录地址，赋给pgd_base</p> 
 <blockquote> 
  <p>    start_pfn = start &gt;&gt; PAGE_SHIFT;<br>    end_pfn = end &gt;&gt; PAGE_SHIFT;</p> 
 </blockquote> 
 <p>start和end代表着，内核直接映射的虚拟地址区域的开始物理地址和结束物理地址，通过右移PAGE_SHIFT位，再加上PAGE_OFFSET，得到其对应的页表项索引。</p> 
 <blockquote> 
  <p>    pgd_idx = pgd_index((pfn&lt;&lt;PAGE_SHIFT) + PAGE_OFFSET);<br>    pgd = pgd_base + pgd_idx;</p> 
 </blockquote> 
 <p>pgd_idx,pgd代表着在页目录中的索引，以及相应的页目录项</p> 
 <div style="border-bottom:#C0C0C0 1px solid;text-align:left;border-left:#C0C0C0 1px solid;line-height:12pt;font-family:'Courier New', courier, monospace;font-size:8pt;border-top:#C0C0C0 1px solid;border-right:#C0C0C0 1px solid;"> 
  <div style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   1:</span> pgprot_t prot = PAGE_KERNEL;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   2:</span> <span style="color:#008000;">/*</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   3:</span> <span style="color:#008000;"> * first pass will use the same initial</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   4:</span> <span style="color:#008000;"> * identity mapping attribute.</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   5:</span> <span style="color:#008000;"> */</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   6:</span> pgprot_t init_prot = __pgprot(PTE_IDENT_ATTR);</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   7:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   8:</span> <span style="color:#0000ff;">if</span> (is_kernel_text(addr))</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">   9:</span>     prot = PAGE_KERNEL_EXEC;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  10:</span>  </pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  11:</span> pages_4k++;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  12:</span> <span style="color:#0000ff;">if</span> (mapping_iter == 1) {<!-- --></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  13:</span>     set_pte(pte, pfn_pte(pfn, init_prot));</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  14:</span>     last_map_addr = (pfn &lt;&lt; PAGE_SHIFT) + PAGE_SIZE;</pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  15:</span> } <span style="color:#0000ff;">else</span></pre> 
   <pre style="border-bottom-style:none;text-align:left;line-height:12pt;border-right-style:none;font-family:'Courier New', courier, monospace;border-top-style:none;color:#000000;font-size:8pt;border-left-style:none;"><span style="color:#606060;">  16:</span>     set_pte(pte, pfn_pte(pfn, prot));</pre> 
  </div> 
 </div> 
 <p>最后，通过两个回合的遍历，将属性设置到对应的页表项上去。</p> 
</div> 
<p>转载于:https://www.cnblogs.com/long123king/p/3510297.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6a6011d79bcd733dce75aa54adc18a33/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43; string的用法和例子</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/848e50997137ec4e6005b68496e25146/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">正则表达式验证身份证号码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>