<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>大模型学习笔记（一）：部署ChatGLM模型以及stable-diffusion模型 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="大模型学习笔记（一）：部署ChatGLM模型以及stable-diffusion模型" />
<meta property="og:description" content="大模型学习笔记（一）：部署ChatGLM模型以及stable-diffusion模型 注册算力平台（驱动云平台）1.平台注册2.查看算力3.进入平台中心 部署ChatGLM3-6B模型1.创建项目2.配置环境设置镜像源、克隆项目修改requirements 3.修改web_demo_gradio.py代码1、修改模型目录2、修改启动代码3、添加外部端口映射4、运行gradio界面5、访问gradio页面 4.修改web_demo_streamlit.py代码1、修改模型目录2、运行streamlit界面3、访问streamlit界面 用免费GPU部署自己的stable-diffusion1.创建项目2. 初始化开发环境实例3. 部署模型4. 体验自己的stable diffusion 注册算力平台（驱动云平台） 1.平台注册 平台注册链接：
https://growthdata.virtaicloud.com/t/SA
2.查看算力 注册完成后，点击右上角：费用中心，可查看领取的算力。
3.进入平台中心 https://platform.virtaicloud.com/
部署ChatGLM3-6B模型 ChatGLM3 是智谱AI和清华大学 KEG 实验室联合发布的新一代对话预训练模型。
推理速度比上一代提高了很多，虽然本教程有两种启动方式，但教程作者强烈推荐使用streamlit体验，效果极佳。
1.创建项目 创建好账号之后，进入自己的空间，点击右上角的创建项目。 给项目起一个你喜欢的名称，选择添加镜像
镜像选择pytorch2.0.1，Conda3.9
选择预训练模型，点击公开，选择不要葱姜蒜上传的这个ChtaGLM3-6B模型。
都选完之后，点击右下角的创建，代码选择暂不上传。待会直接clone代码。
点击运行代码
资源配置选择：B1.large， 24G的显存足够加载模型了。其他的不需要设置，然后点击右下角的开始运行。
2.配置环境 等右边两个工具全部加载完毕之后，再点击JupyterLab进入开发环境~ 进入界面之后是这样的，然后点击这个小加号。
点击terminal，进入终端。
设置镜像源、克隆项目 升级apt，安装unzip apt-get update &amp;&amp; apt-get install unzip
设置镜像源，升级pip git config --global url.“https://gitclone.com/”.insteadOf https://
pip config set global.index-url https://pypi.virtaicloud.com/repository/pypi/simple
python3 -m pip install --upgrade pip
克隆项目，并进入项目目录 git clone https://github.com/THUDM/ChatGLM3.git
cd ChatGLM3
修改requirements 双击左侧的requirements." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/d3ec6448a32949897ae79faf427e8e58/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-13T22:50:39+08:00" />
<meta property="article:modified_time" content="2024-03-13T22:50:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">大模型学习笔记（一）：部署ChatGLM模型以及stable-diffusion模型</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>大模型学习笔记（一）：部署ChatGLM模型以及stable-diffusion模型</h4> 
 <ul><li><a href="#_1" rel="nofollow">注册算力平台（驱动云平台）</a></li><li><ul><li><a href="#1_3" rel="nofollow">1.平台注册</a></li><li><a href="#2_8" rel="nofollow">2.查看算力</a></li><li><a href="#3_13" rel="nofollow">3.进入平台中心</a></li></ul> 
  </li><li><a href="#ChatGLM36B_16" rel="nofollow">部署ChatGLM3-6B模型</a></li><li><ul><li><a href="#1_19" rel="nofollow">1.创建项目</a></li><li><a href="#2_35" rel="nofollow">2.配置环境</a></li><li><ul><li><a href="#_43" rel="nofollow">设置镜像源、克隆项目</a></li><li><a href="#requirements_58" rel="nofollow">修改requirements</a></li></ul> 
   </li><li><a href="#3web_demo_gradiopy_69" rel="nofollow">3.修改web_demo_gradio.py代码</a></li><li><ul><li><a href="#1_70" rel="nofollow">1、修改模型目录</a></li><li><a href="#2_74" rel="nofollow">2、修改启动代码</a></li><li><a href="#3_79" rel="nofollow">3、添加外部端口映射</a></li><li><a href="#4gradio_82" rel="nofollow">4、运行gradio界面</a></li><li><a href="#5gradio_91" rel="nofollow">5、访问gradio页面</a></li></ul> 
   </li><li><a href="#4web_demo_streamlitpy_95" rel="nofollow">4.修改web_demo_streamlit.py代码</a></li><li><ul><li><a href="#1_99" rel="nofollow">1、修改模型目录</a></li><li><a href="#2streamlit_102" rel="nofollow">2、运行streamlit界面</a></li><li><a href="#3streamlit_107" rel="nofollow">3、访问streamlit界面</a></li></ul> 
  </li></ul> 
  </li><li><a href="#GPUstablediffusion_116" rel="nofollow">用免费GPU部署自己的stable-diffusion</a></li><li><ul><li><a href="#1_117" rel="nofollow">1.创建项目</a></li><li><a href="#2__128" rel="nofollow">2. 初始化开发环境实例</a></li><li><a href="#3__136" rel="nofollow">3. 部署模型</a></li><li><a href="#4_stable_diffusion_165" rel="nofollow">4. 体验自己的stable diffusion</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>注册算力平台（驱动云平台）</h2> 
<h3><a id="1_3"></a>1.平台注册</h3> 
<p>平台注册链接：<br> <a href="https://growthdata.virtaicloud.com/t/SA" rel="nofollow">https://growthdata.virtaicloud.com/t/SA</a></p> 
<h3><a id="2_8"></a>2.查看算力</h3> 
<p>注册完成后，点击右上角：<strong>费用中心</strong>，可查看领取的算力。<br> <img src="https://images2.imgbox.com/29/ac/ENXaVNyQ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6c/41/Br7VOrmi_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ba/02/DhSlMSXu_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_13"></a>3.进入平台中心</h3> 
<p><a href="https://platform.virtaicloud.com/" rel="nofollow">https://platform.virtaicloud.com/</a></p> 
<h2><a id="ChatGLM36B_16"></a>部署ChatGLM3-6B模型</h2> 
<p>ChatGLM3 是智谱AI和清华大学 KEG 实验室联合发布的新一代对话预训练模型。<br> 推理速度比上一代提高了很多，虽然本教程有两种启动方式，但教程作者强烈推荐使用streamlit体验，效果极佳。</p> 
<h3><a id="1_19"></a>1.创建项目</h3> 
<ul><li>创建好账号之后，进入自己的空间，点击右上角的创建项目。</li></ul> 
<p><img src="https://images2.imgbox.com/b2/4c/j08LFxLf_o.png" alt="在这里插入图片描述"></p> 
<ul><li>给项目起一个你喜欢的名称，选择添加镜像<br> <img src="https://images2.imgbox.com/45/a2/OeyH9e4a_o.png" alt="在这里插入图片描述"></li><li>镜像选择pytorch2.0.1，Conda3.9<br> <img src="https://images2.imgbox.com/60/55/BsiYwI38_o.png" alt="在这里插入图片描述"></li><li>选择预训练模型，点击公开，选择不要葱姜蒜上传的这个ChtaGLM3-6B模型。<br> <img src="https://images2.imgbox.com/64/a3/yk636tUa_o.png" alt="在这里插入图片描述"></li><li>都选完之后，点击右下角的创建，代码选择暂不上传。待会直接clone代码。<br> <img src="https://images2.imgbox.com/28/4f/hCkTK3PN_o.png" alt="在这里插入图片描述"></li><li>点击运行代码<br> <img src="https://images2.imgbox.com/66/41/0EalR0Pp_o.png" alt="在这里插入图片描述"></li><li>资源配置选择：B1.large， 24G的显存足够加载模型了。其他的不需要设置，然后点击右下角的开始运行。<br> <img src="https://images2.imgbox.com/4f/f2/Cm3SDVqw_o.png" alt="在这里插入图片描述"></li></ul> 
<h3><a id="2_35"></a>2.配置环境</h3> 
<ul><li>等右边两个工具全部加载完毕之后，再点击JupyterLab进入开发环境~</li></ul> 
<p><img src="https://images2.imgbox.com/4d/0c/7Oao7cDq_o.png" alt="在这里插入图片描述"></p> 
<ul><li>进入界面之后是这样的，然后点击这个小加号。<br> <img src="https://images2.imgbox.com/9c/eb/EVs3RJP5_o.png" alt="在这里插入图片描述"></li><li>点击terminal，进入终端。<br> <img src="https://images2.imgbox.com/f5/e4/lpjFEn6v_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="_43"></a>设置镜像源、克隆项目</h4> 
<ul><li>升级apt，安装unzip</li></ul> 
<blockquote> 
 <p>apt-get update &amp;&amp; apt-get install unzip</p> 
</blockquote> 
<ul><li>设置镜像源，升级pip</li></ul> 
<blockquote> 
 <p>git config --global url.“https://gitclone.com/”.insteadOf https://<br> pip config set global.index-url https://pypi.virtaicloud.com/repository/pypi/simple<br> python3 -m pip install --upgrade pip</p> 
</blockquote> 
<ul><li>克隆项目，并进入项目目录</li></ul> 
<blockquote> 
 <p>git clone https://github.com/THUDM/ChatGLM3.git<br> cd ChatGLM3</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/fd/09/d3hPJnu9_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="requirements_58"></a>修改requirements</h4> 
<ul><li>双击左侧的requirements.txt文件，把其中的torch删掉，因为我们的环境中已经有torch了，避免重复下载浪费时间【注意：删除之后要保存文件，可以使用快捷键Ctrl+S或者点击左上角的File，再点击保存】。<br> <img src="https://images2.imgbox.com/df/13/B4HKd64M_o.png" alt="在这里插入图片描述"></li><li>点击左上选项卡，重新返回终端，安装依赖，依赖安装完毕后还需要安装peft</li></ul> 
<blockquote> 
 <p>pip install -r requirements.txt<br> pip install peft</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/3c/83/FFK33WDw_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/46/3d/KOkW2w0n_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3web_demo_gradiopy_69"></a>3.修改web_demo_gradio.py代码</h3> 
<h4><a id="1_70"></a>1、修改模型目录</h4> 
<ul><li>双击basic_demo 编辑web_demo_gradio.py，将加载模型的路径修改为：/gemini/pretrain，如下图所示</li></ul> 
<p><img src="https://images2.imgbox.com/aa/82/V7BghXJE_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2_74"></a>2、修改启动代码</h4> 
<ul><li>接下来还需要修改一段启动代码，将滚动条拉到最后一行，启动代码修改为如下~</li></ul> 
<blockquote> 
 <p>demo.queue().launch(share=False, server_name=“0.0.0.0”,server_port=7000)</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/fe/6f/xhpjnNRU_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3_79"></a>3、添加外部端口映射</h4> 
<ul><li>在界面的右边添加外部端口：7000<br> <img src="https://images2.imgbox.com/05/5d/GRocG35d_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="4gradio_82"></a>4、运行gradio界面</h4> 
<ul><li>点击左上选项卡，重新返回终端，运行web_demo_gradio.py</li></ul> 
<blockquote> 
 <p>cd basic_demo<br> python web_demo_gradio.py</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/cf/a2/fE4p9sdJ_o.png" alt="在这里插入图片描述"></p> 
<ul><li>等待模型慢慢加载完毕，可能需要个五六分钟叭保持一点耐心 ~<br> <img src="https://images2.imgbox.com/9c/29/hgCoOzZo_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="5gradio_91"></a>5、访问gradio页面</h4> 
<ul><li>加载完毕之后，复制外部访问的连接，到浏览器打打开</li></ul> 
<p><img src="https://images2.imgbox.com/0b/8e/LMbBzQ1z_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4web_demo_streamlitpy_95"></a>4.修改web_demo_streamlit.py代码</h3> 
<p>如果你运行了gradio，需要先杀掉这个进程，不然内存不够。<br> CTRL+C 可以杀掉进程~<br> 杀掉进程之后，显存不会立刻释放，可以观察右边的GPU内存占用，查看显存释放情况。</p> 
<h4><a id="1_99"></a>1、修改模型目录</h4> 
<ul><li>双击basic_demo 编辑web_demo_streamlit.py，将加载模型的路径修改为：/gemini/pretrain，如下图所示~<br> <img src="https://images2.imgbox.com/e8/f9/jU1fdIXC_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="2streamlit_102"></a>2、运行streamlit界面</h4> 
<ul><li>点击左上选项卡，重新返回终端，运行web_demo_stream.py并指定7000端口，这样就不用再次添加外部端口映射啦~</li></ul> 
<blockquote> 
 <p>streamlit run web_demo_streamlit.py --server.port 7000</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/aa/c7/ogoQRGoV_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3streamlit_107"></a>3、访问streamlit界面</h4> 
<ul><li>复制外部访问地址到浏览器打开，之后模型才会开始加载。等待模型记载完毕~<br> <img src="https://images2.imgbox.com/ee/c8/zHIx9VNN_o.png" alt="在这里插入图片描述"></li><li>以下是模型在加载时Streamlit的画面，在工作台中看到加载完成后刷新即可正常使用。<br> <img src="https://images2.imgbox.com/b1/27/hnXbEPL3_o.png" alt="在这里插入图片描述"></li><li>加载成功后工作台后端画面</li></ul> 
<p><img src="https://images2.imgbox.com/a8/f0/yRJ9Q5h4_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e6/d7/9HJfPvoH_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="GPUstablediffusion_116"></a>用免费GPU部署自己的stable-diffusion</h2> 
<h3><a id="1_117"></a>1.创建项目</h3> 
<ol><li>进入趋动云用户工作台，选择：当前空间，请确保当前所在空间是注册时系统自动生成的空间。<br> 注：非系统自动生成的空间，没有赠送的算力金</li><li>点击：快速创建，选择创建项目，创建新项目。</li><li>填写相关的项目信息，其中镜像选择如下。<br> <img src="https://images2.imgbox.com/a1/4c/kJtVY7Ru_o.png" alt="在这里插入图片描述"><br> 4.<strong>数据集</strong>选择如下。<br> <img src="https://images2.imgbox.com/bf/f3/42gYbzm6_o.png" alt="在这里插入图片描述"><br> 5.待项目信息完善后，镜像和数据集选择完毕之后，点击 “<strong>创建</strong>”。<br> <img src="https://images2.imgbox.com/65/90/BLpyigzp_o.png" alt="在这里插入图片描述"></li><li>弹出的上传代码对话框，选择 “<strong>暂不上传</strong>”。</li></ol> 
<h3><a id="2__128"></a>2. 初始化开发环境实例</h3> 
<p>之后找到最右侧 “<strong>开发</strong>”-&gt; “<strong>初始化开发环境实例</strong>”<br> <img src="https://images2.imgbox.com/26/c4/yvIv0UdO_o.png" alt="在这里插入图片描述"><br> 按照下图进行选择</p> 
<p><img src="https://images2.imgbox.com/e6/74/dthvGDC6_o.png" alt="在这里插入图片描述"><br> 运行初始化中，等待约 5-10 分钟，当右侧的 网页终端 和 JupyterLab 不再是灰色时，表明工具注入成功。此时您便可在此开发环境上通过工具进行模型调优，详情可参见下一步。<br> <img src="https://images2.imgbox.com/d6/d6/LAFcY1UU_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3__136"></a>3. 部署模型</h3> 
<p>初始化完毕，点击下图所示右侧 “<strong>网页终端</strong>”<br> <img src="https://images2.imgbox.com/10/78/QIrLOfTD_o.png" alt="在这里插入图片描述"><br> 依次输入以下4串命令就可以啦，注意每一次命令输入之后<strong>要等它运行完毕</strong>之后再输入下一条指令，<strong>建议复制命令</strong>而不是手动输入，容易出现遗漏空格或者路径出错的情况（网页终端无法使用Ctrl+C复制和Ctrl+V粘贴，可以鼠标在页面<strong>点击右键</strong>，然后选择“复制”或者“粘贴”）。</p> 
<p>1、解压代码及模型</p> 
<blockquote> 
 <p>tar xf /gemini/data-1/stable-diffusion-webui.tar -C /gemini/code/</p> 
</blockquote> 
<p>2、解压配置文件到隐藏目录/root/.cache</p> 
<blockquote> 
 <p>tar xf /gemini/data-1/cache.tar -C /root/ （文件位置可能发生变化，如果报错请删除该行）</p> 
</blockquote> 
<p>3、拷贝frpc内网穿透文件 （注意有两行 -&gt; 两条指令）</p> 
<blockquote> 
 <p>cp /gemini/data-1/frpc_linux_amd64 /root/miniconda3/lib/python3.10/site-packages/gradio/frpc_linux_amd64_v0.2 （文件位置可能发生变化，如果报错请删除该行）<br> chmod +x /root/miniconda3/lib/python3.10/site-packages/gradio/frpc_linux_amd64_v0.2</p> 
</blockquote> 
<p>4、拷贝模型文件到项目目录下</p> 
<blockquote> 
 <p>cp /gemini/data-1/v1-5-pruned-emaonly.safetensors /gemini/code/stable-diffusion-webui/</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/46/4d/MUASX3Sn_o.png" alt="在这里插入图片描述"><br> 5、更新系统httpx依赖</p> 
<blockquote> 
 <p>pip install httpx==0.24.1</p> 
</blockquote> 
<p>6、运行项目</p> 
<blockquote> 
 <p>cd /gemini/code/stable-diffusion-webui &amp;&amp; python launch.py --deepdanbooru --share --xformers --listen</p> 
</blockquote> 
<p>当命令窗口出现如下两个网址时表示部署成功，可以复制右侧的外部访问网址访问webui<br> <img src="https://images2.imgbox.com/d9/74/vBEFMDhf_o.png" alt="在这里插入图片描述"><br> 访问这个网址就可以直接使用啦<br> <img src="https://images2.imgbox.com/d5/29/p1wgkFnC_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_stable_diffusion_165"></a>4. 体验自己的stable diffusion</h3> 
<p>登录进去之后输入prompt提示词</p> 
<blockquote> 
 <p>(masterpiece),(best quality),(Realistic photos),a cute girl, war a cap, headphones, summer, sunset, mountain road, flowers, nice weather, healing sense, detailed, half-length shot, anime style, 8k</p> 
</blockquote> 
<p>注意：体验完后，一定要停止项目运转。一定要停止项目运转。一定要停止项目运转。不然会一直消耗GPU资源。<br> <img src="https://images2.imgbox.com/6a/00/LTqDACYZ_o.png" alt="在这里插入图片描述"></p> 
<p>参考资料：<a href="https://datawhaler.feishu.cn/docx/BwjzdQPJRonFh8xeiSOcRUI3n8b" rel="nofollow">https://datawhaler.feishu.cn/docx/BwjzdQPJRonFh8xeiSOcRUI3n8b</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/74d10191cc83d6d5a214d34849dc15e0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">在CentOS 7系统下通过二进制方式安装MySQL 8.0.34</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/37d949f3afb2992e3d552c59564503e6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于恒功率PQ控制的三电平并网逆变器MATLAB仿真模型</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>