<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Flink SQL】Flink SQL 基础概念（四）：SQL 的时间属性 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Flink SQL】Flink SQL 基础概念（四）：SQL 的时间属性" />
<meta property="og:description" content="《Flink SQL 基础概念》系列，共包含以下 5 篇文章：
Flink SQL 基础概念（一）：SQL &amp; Table 运行环境、基本概念及常用 APIFlink SQL 基础概念（二）：数据类型Flink SQL 基础概念（三）：SQL 动态表 &amp; 连续查询Flink SQL 基础概念（四）：SQL 的时间属性Flink SQL 基础概念（五）：SQL 时区问题 😊 如果您觉得这篇文章有用 ✔️ 的话，请给博主一个一键三连 🚀🚀🚀 吧 （点赞 🧡、关注 💛、收藏 💚）！！！您的支持 💖💖💖 将激励 🔥 博主输出更多优质内容！！！
Flink SQL 基础概念（四）：SQL 的时间属性 1.Flink 三种时间属性简介2.Flink 三种时间属性的应用场景2.1 事件时间案例2.2 处理时间案例2.3 摄入时间案例 3.SQL 指定时间属性的两种方式4.SQL 事件时间案例5.SQL 处理时间案例 与离线处理中常见的时间分区字段一样，在实时处理中，时间属性也是一个核心概念。Flink 支持 处理时间、事件时间、摄入时间 三种时间语义。
三种时间在生产环境的使用频次 事件时间（SQL 常用） &gt; &gt; &gt; 处理时间（SQL 几乎不用，DataStream 少用） &gt; &gt; &gt; 摄入时间（不用）。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/d7af75b8be986f57d7ddc3480aab77db/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-16T00:25:53+08:00" />
<meta property="article:modified_time" content="2024-03-16T00:25:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Flink SQL】Flink SQL 基础概念（四）：SQL 的时间属性</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>《<font color="#e47542"><strong>Flink SQL 基础概念</strong></font>》系列，共包含以下 5 篇文章：</p> 
<ul><li><a href="https://blog.csdn.net/Be_racle/article/details/136637091">Flink SQL 基础概念（一）：SQL &amp; Table 运行环境、基本概念及常用 API</a></li><li><a href="https://blog.csdn.net/Be_racle/article/details/136634313">Flink SQL 基础概念（二）：数据类型</a></li><li><a href="https://blog.csdn.net/Be_racle/article/details/136666759">Flink SQL 基础概念（三）：SQL 动态表 &amp; 连续查询</a></li><li><a href="https://blog.csdn.net/Be_racle/article/details/136720727">Flink SQL 基础概念（四）：SQL 的时间属性</a></li><li><a href="https://blog.csdn.net/Be_racle/article/details/136723893">Flink SQL 基础概念（五）：SQL 时区问题</a></li></ul> 
<blockquote> 
 <p>😊 如果您觉得这篇文章有用 ✔️ 的话，请给博主一个一键三连 🚀🚀🚀 吧 （点赞 🧡、关注 💛、收藏 💚）！！！您的支持 💖💖💖 将激励 🔥 博主输出更多优质内容！！！</p> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4> 
  <center>
    Flink SQL 基础概念（四）：SQL 的时间属性 
  </center></h4> 
 <ul><li><a href="#1Flink__14" rel="nofollow">1.Flink 三种时间属性简介</a></li><li><a href="#2Flink__22" rel="nofollow">2.Flink 三种时间属性的应用场景</a></li><li><ul><li><a href="#21__32" rel="nofollow">2.1 事件时间案例</a></li><li><a href="#22__41" rel="nofollow">2.2 处理时间案例</a></li><li><a href="#23__47" rel="nofollow">2.3 摄入时间案例</a></li></ul> 
  </li><li><a href="#3SQL__49" rel="nofollow">3.SQL 指定时间属性的两种方式</a></li><li><a href="#4SQL__59" rel="nofollow">4.SQL 事件时间案例</a></li><li><a href="#5SQL__184" rel="nofollow">5.SQL 处理时间案例</a></li></ul> 
</div> 
<p></p> 
<p>与离线处理中常见的时间分区字段一样，在实时处理中，时间属性也是一个核心概念。Flink 支持 <font color="#e47542"><strong>处理时间</strong></font>、<font color="#e47542"><strong>事件时间</strong></font>、<font color="#e47542"><strong>摄入时间</strong></font> 三种时间语义。</p> 
<p>三种时间在生产环境的使用频次 <font color="#e47542"><strong>事件时间</strong></font>（SQL 常用）<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         &gt; 
        
       
      
        &gt; 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5782em; vertical-align: -0.0391em;"></span><span class="mrel">&gt;</span></span></span></span></span> <font color="#e47542"><strong>处理时间</strong></font>（SQL 几乎不用，DataStream 少用）<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         &gt; 
        
       
      
        &gt; 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5782em; vertical-align: -0.0391em;"></span><span class="mrel">&gt;</span></span></span></span></span> <font color="#e47542"><strong>摄入时间</strong></font>（不用）。</p> 
<h2><a id="1Flink__14"></a>1.Flink 三种时间属性简介</h2> 
<ul><li><font color="#e47542"><strong>事件时间</strong></font>：指的是数据本身携带的时间，这个时间是在事件产生时的时间，而且在 Flink SQL 触发计算时，也使用数据本身携带的时间。这就叫做事件时间。目前生产环境中用的最多。</li><li><font color="#e47542"><strong>处理时间</strong></font>：指的是具体算子计算数据执行时的机器时间（例如在算子中 Java 取 <code>System.currentTimeMillis()</code>），在生产环境中用的次多。</li><li><font color="#e47542"><strong>摄入时间</strong></font>：指的是数据从数据源进入 Flink 的时间。摄入时间用的最少，可以说基本不使用。</li></ul> 
<p>小伙伴们要注意到：</p> 
<ul><li>上述的三种时间概念不是由于有了数据而诞生的，而是有了 Flink 之后根据实际的应用场景而诞生的。以事件时间举个例子，如果只是数据携带了时间，Flink 也消费了这个数据，但是在 Flink 中没有使用数据的这个时间作为计算的触发条件，也不能把这个 Flink 任务叫做事件时间的任务。</li><li>其次，要认识到，一般一个 Flink 任务只会有一个时间属性，所以时间属性通常认为是一个任务粒度的。举例：我们可以说 A 任务是事件时间语义的任务，B 任务是处理时间语义的任务。当然了，一个任务也可以存在多个时间属性。</li></ul> 
<h2><a id="2Flink__22"></a>2.Flink 三种时间属性的应用场景</h2> 
<p>讲到这里，有人会问，博主上面写的 3 种时间属性到底对我们的任务有啥影响呢？3 种时间属性的应用场景是啥？</p> 
<p>先说结论，在 Flink 中时间的作用：</p> 
<ul><li>主要体现在包含时间窗口的计算中：用于标识任务的时间进度，来判断是否需要触发窗口的计算。比如常用的滚动窗口、滑动窗口等都需要时间推动触发。这些窗口的应用场景后续会详细介绍。</li><li>次要体现在自定义时间语义的计算中：举个例子，比如用户可以自定义每隔 10s 的本地时间，或者消费到的数据的时间戳每增大 10s，就把计算结果输出一次，时间在此类应用中也是一种标识任务进度的作用。</li></ul> 
<p>博主以 <font color="#e47542"><strong>滚动窗口</strong></font> 的聚合任务为例来介绍一下事件时间和处理时间的对比区别。</p> 
<h3><a id="21__32"></a>2.1 事件时间案例</h3> 
<p>还是以之前的 <code>clicks</code> 表拿来举例。</p> 
<p><img src="https://images2.imgbox.com/8f/31/lb4Ot2jI_o.png" alt="在这里插入图片描述"><br> 上面这个案例的窗口大小是 1 小时，需求方需要按照用户点击时间戳 <code>cTime</code> 划分数据（划分滚动窗口），然后计算出 Count 聚合结果（这样计算能反映出事件的真实发生时间），那么就需要把 <code>cTime</code> 设置为窗口的划分时间戳，即代码中 <code>tumble(cTime, interval '1' hour)</code>。</p> 
<p>上面这种就叫做事件时间。即用数据中自带的时间戳进行窗口的划分（点击操作真实的发生时间）。</p> 
<p>后续 Flink SQL 任务在运行的过程中也会实际按照 <code>cTime</code> 的当前时间作为一小时窗口结束触发条件并计算一个小时窗口内的数据。</p> 
<h3><a id="22__41"></a>2.2 处理时间案例</h3> 
<p>还是以之前的 <code>clicks</code> 表拿来举例。</p> 
<p>还是上面那个案例，但是这次需求方不需要按照数据上的时间戳划分数据（划分滚动窗口），只需要数据来了之后， 在 Flink 机器上的时间作为一小时窗口结束的触发条件并计算。</p> 
<p>那么这种触发机制就是处理时间。</p> 
<h3><a id="23__47"></a>2.3 摄入时间案例</h3> 
<p>在 Flink 从外部数据源读取到数据时，给这条数据带上的当前数据源算子的本地时间戳。下游可以用这个时间戳进行窗口聚合，不过这种几乎不使用。</p> 
<h2><a id="3SQL__49"></a>3.SQL 指定时间属性的两种方式</h2> 
<p>如果要满足 Flink SQL 时间窗口类的聚合操作，SQL 或 Table API 中的 <font color="#e47542"><strong>数据源表</strong></font> 就需要提供时间属性（相当于我们把这个时间属性在 <font color="#e47542"><strong>数据源表</strong></font> 上面进行声明），以及支持时间相关的操作。</p> 
<p>那么来看看 Flink SQL 为我们提供的两种指定时间戳的方式：</p> 
<ul><li><code>CREATE TABLE DDL</code> 创建表的时候指定</li><li>可以在 <code>DataStream</code> 中指定，在后续的 DataStream 转的 Table 中使用</li></ul> 
<p>一旦时间属性定义好，它就可以像普通列一样使用，也可以在时间相关的操作中使用。</p> 
<h2><a id="4SQL__59"></a>4.SQL 事件时间案例</h2> 
<p>来看看 Flink 中如何指定事件时间。</p> 
<ul><li><code>CREATE TABLE DDL</code> 指定时间戳的方式。</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_actions <span class="token punctuation">(</span>
  user_name STRING<span class="token punctuation">,</span>
  <span class="token keyword">data</span> STRING<span class="token punctuation">,</span>
  user_action_time <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">-- 使用下面这句来将 user_action_time 声明为事件时间，并且声明 watermark 的生成规则，即 user_action_time 减 5 秒</span>
  <span class="token comment">-- 事件时间列的字段类型必须是 TIMESTAMP 或者 TIMESTAMP_LTZ 类型</span>
  WATERMARK <span class="token keyword">FOR</span> user_action_time <span class="token keyword">AS</span> user_action_time <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> <span class="token keyword">SECOND</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> TUMBLE_START<span class="token punctuation">(</span>user_action_time<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> user_name<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> user_actions
<span class="token comment">-- 然后就可以在窗口算子中使用 user_action_time</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> TUMBLE<span class="token punctuation">(</span>user_action_time<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>从上面这条语句可以看到，如果想使用事件时间，那么我们的时间戳类型必须是 <code>TIMESTAMP</code> 或者 <code>TIMESTAMP_LTZ</code> 类型。很多小伙伴会想到，我们的时间戳一般不都是秒或者是毫秒（<code>BIGINT</code> 类型）嘛，那这种情况怎么办？</p> 
<p>解决方案必须要有啊，如下。</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_actions <span class="token punctuation">(</span>
  user_name STRING<span class="token punctuation">,</span>
  <span class="token keyword">data</span> STRING<span class="token punctuation">,</span>
  <span class="token comment">-- 1. 这个 ts 就是常见的毫秒级别时间戳</span>
  ts <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token comment">-- 2. 将毫秒时间戳转换成 TIMESTAMP_LTZ 类型</span>
  time_ltz <span class="token keyword">AS</span> TO_TIMESTAMP_LTZ<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">-- 3. 使用下面这句来将 user_action_time 声明为事件时间，并且声明 watermark 的生成规则，即 user_action_time 减 5 秒</span>
  <span class="token comment">-- 事件时间列的字段类型必须是 TIMESTAMP 或者 TIMESTAMP_LTZ 类型</span>
  WATERMARK <span class="token keyword">FOR</span> time_ltz <span class="token keyword">AS</span> time_ltz <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> <span class="token keyword">SECOND</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> TUMBLE_START<span class="token punctuation">(</span>time_ltz<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> user_name<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> user_actions
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> TUMBLE<span class="token punctuation">(</span>time_ltz<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>DataStream 中指定事件时间。</li></ul> 
<p>之前介绍了 <code>Table</code> 和 <code>DataStream</code> 可以互转，那么 Flink 也提供了一个能力，就是在 <code>Table</code> 转为 <code>DataStream</code> 时，指定时间戳字段。如下案例：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataStreamSourceEventTimeTest</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span>
                <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">createLocalEnvironmentWithWebUI</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">EnvironmentSettings</span> settings <span class="token operator">=</span> <span class="token class-name">EnvironmentSettings</span>
                <span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">useBlinkPlanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">inStreamingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StreamTableEnvironment</span> tEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> settings<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1. 分配 watermark</span>
        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> r <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserDefinedSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">Row</span> element<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> element<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string">"f2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 使用 f2.rowtime 的方式将 f2 字段指为事件时间时间戳</span>
        <span class="token class-name">Table</span> sourceTable <span class="token operator">=</span> tEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">"f0, f1, f2.rowtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        tEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"source_table"</span><span class="token punctuation">,</span> sourceTable<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 在 tumble window 中使用 f2</span>
        <span class="token class-name">String</span> tumbleWindowSql <span class="token operator">=</span>
                <span class="token string">"SELECT TUMBLE_START(f2, INTERVAL '5' SECOND), COUNT(DISTINCT f0)\n"</span>
                <span class="token operator">+</span> <span class="token string">"FROM source_table\n"</span>
                <span class="token operator">+</span> <span class="token string">"GROUP BY TUMBLE(f2, INTERVAL '5' SECOND)"</span>
                <span class="token punctuation">;</span>

        <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span>tumbleWindowSql<span class="token punctuation">)</span><span class="token punctuation">;</span>

        tEnv<span class="token punctuation">.</span><span class="token function">toDataStream</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UserDefinedSource</span> <span class="token keyword">implements</span> <span class="token class-name">SourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">ResultTypeQueryable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> isCancel<span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> sourceContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isCancel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                sourceContext<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"a"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>isCancel <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> <span class="token function">getProducedType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RowTypeInfo</span><span class="token punctuation">(</span><span class="token class-name">TypeInformation</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TypeInformation</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">TypeInformation</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="5SQL__184"></a>5.SQL 处理时间案例</h2> 
<p>来看看 Flink SQL 中如何指定处理时间。</p> 
<ul><li><code>CREATE TABLE DDL</code> 指定时间戳的方式。</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_actions <span class="token punctuation">(</span>
  user_name STRING<span class="token punctuation">,</span>
  <span class="token keyword">data</span> STRING<span class="token punctuation">,</span>
  <span class="token comment">-- 使用下面这句来将 user_action_time 声明为处理时间</span>
  user_action_time <span class="token keyword">AS</span> PROCTIME<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> TUMBLE_START<span class="token punctuation">(</span>user_action_time<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> user_name<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> user_actions
<span class="token comment">-- 然后就可以在窗口算子中使用 user_action_time</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> TUMBLE<span class="token punctuation">(</span>user_action_time<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>DataStream 中指定处理时间。</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataStreamSourceProcessingTimeTest</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span>
                <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">createLocalEnvironmentWithWebUI</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">EnvironmentSettings</span> settings <span class="token operator">=</span> <span class="token class-name">EnvironmentSettings</span>
                <span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">useBlinkPlanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">inStreamingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StreamTableEnvironment</span> tEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> settings<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1. 分配 watermark</span>
        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> r <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserDefinedSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 使用 proctime.proctime 的方式将 f2 字段指为处理时间时间戳</span>
        <span class="token class-name">Table</span> sourceTable <span class="token operator">=</span> tEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">"f0, f1, f2, proctime.proctime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        tEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"source_table"</span><span class="token punctuation">,</span> sourceTable<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 在 tumble window 中使用 f2</span>
        <span class="token class-name">String</span> tumbleWindowSql <span class="token operator">=</span>
                <span class="token string">"SELECT TUMBLE_START(proctime, INTERVAL '5' SECOND), COUNT(DISTINCT f0)\n"</span>
                <span class="token operator">+</span> <span class="token string">"FROM source_table\n"</span>
                <span class="token operator">+</span> <span class="token string">"GROUP BY TUMBLE(proctime, INTERVAL '5' SECOND)"</span>
                <span class="token punctuation">;</span>

        <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span>tumbleWindowSql<span class="token punctuation">)</span><span class="token punctuation">;</span>

        tEnv<span class="token punctuation">.</span><span class="token function">toDataStream</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UserDefinedSource</span> <span class="token keyword">implements</span> <span class="token class-name">SourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">ResultTypeQueryable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> isCancel<span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> sourceContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isCancel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                sourceContext<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"a"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>isCancel <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> <span class="token function">getProducedType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RowTypeInfo</span><span class="token punctuation">(</span><span class="token class-name">TypeInformation</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TypeInformation</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">TypeInformation</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2b2bad30209e33064f977531b7683fd1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">应用层_HTTP&amp;HTTPS</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/333ef06f139d4129b7b905bf7a095ff4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Flink SQL】Flink SQL 基础概念（三）：SQL 动态表 &amp; 连续查询</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>