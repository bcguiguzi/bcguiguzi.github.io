<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>TensorFlow 实现车牌识别 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="TensorFlow 实现车牌识别" />
<meta property="og:description" content="文章目录 1：生成训练数据集2：数据读取3：构建神经网络模型4：开始训练模型5：测试模型准确度 1：生成训练数据集 #pip install pillow -i https://pypi.tuna.tsinghua.edu.cn/simple #pip install opencv-python -i https://pypi.tuna.tsinghua.edu.cn/simple import PIL from PIL import ImageFont from PIL import Image from PIL import ImageDraw import cv2; import numpy as np; import os; from math import * import matplotlib.pyplot as plt index = {&#34;京&#34;: 0, &#34;沪&#34;: 1, &#34;津&#34;: 2, &#34;渝&#34;: 3, &#34;冀&#34;: 4, &#34;晋&#34;: 5, &#34;蒙&#34;: 6, &#34;辽&#34;: 7, &#34;吉&#34;: 8, &#34;黑&#34;: 9, &#34;苏&#34;: 10, &#34;浙&#34;: 11, &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/e72197965b222e2dfaa15648a658eb2c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-22T21:29:49+08:00" />
<meta property="article:modified_time" content="2023-05-22T21:29:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">TensorFlow 实现车牌识别</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1_1" rel="nofollow">1：生成训练数据集</a></li><li><a href="#2_195" rel="nofollow">2：数据读取</a></li><li><a href="#3_263" rel="nofollow">3：构建神经网络模型</a></li><li><a href="#4_547" rel="nofollow">4：开始训练模型</a></li><li><a href="#5_631" rel="nofollow">5：测试模型准确度</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1_1"></a>1：生成训练数据集</h2> 
<pre><code class="prism language-python"><span class="token comment">#pip install pillow  -i https://pypi.tuna.tsinghua.edu.cn/simple</span>
<span class="token comment">#pip install opencv-python -i https://pypi.tuna.tsinghua.edu.cn/simple</span>
<span class="token keyword">import</span> PIL
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> ImageFont
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> ImageDraw
<span class="token keyword">import</span> cv2<span class="token punctuation">;</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token punctuation">;</span>
<span class="token keyword">import</span> os<span class="token punctuation">;</span>
<span class="token keyword">from</span> math <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

index <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"京"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"沪"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"津"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"渝"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"冀"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"晋"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"蒙"</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">"辽"</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"吉"</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"黑"</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">"苏"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">"浙"</span><span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">"皖"</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
         <span class="token string">"闽"</span><span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">"赣"</span><span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">"鲁"</span><span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">"豫"</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">"鄂"</span><span class="token punctuation">:</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">"湘"</span><span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"粤"</span><span class="token punctuation">:</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">"桂"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"琼"</span><span class="token punctuation">:</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">"川"</span><span class="token punctuation">:</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token string">"贵"</span><span class="token punctuation">:</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">"云"</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
         <span class="token string">"藏"</span><span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token string">"陕"</span><span class="token punctuation">:</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token string">"甘"</span><span class="token punctuation">:</span> <span class="token number">27</span><span class="token punctuation">,</span> <span class="token string">"青"</span><span class="token punctuation">:</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token string">"宁"</span><span class="token punctuation">:</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token string">"新"</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">:</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">:</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">:</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">:</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">:</span> <span class="token number">36</span><span class="token punctuation">,</span>
         <span class="token string">"6"</span><span class="token punctuation">:</span> <span class="token number">37</span><span class="token punctuation">,</span> <span class="token string">"7"</span><span class="token punctuation">:</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">:</span> <span class="token number">39</span><span class="token punctuation">,</span> <span class="token string">"9"</span><span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">:</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">:</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token string">"E"</span><span class="token punctuation">:</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token string">"F"</span><span class="token punctuation">:</span> <span class="token number">46</span><span class="token punctuation">,</span> <span class="token string">"G"</span><span class="token punctuation">:</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token string">"H"</span><span class="token punctuation">:</span> <span class="token number">48</span><span class="token punctuation">,</span>
         <span class="token string">"J"</span><span class="token punctuation">:</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token string">"K"</span><span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token string">"L"</span><span class="token punctuation">:</span> <span class="token number">51</span><span class="token punctuation">,</span> <span class="token string">"M"</span><span class="token punctuation">:</span> <span class="token number">52</span><span class="token punctuation">,</span> <span class="token string">"N"</span><span class="token punctuation">:</span> <span class="token number">53</span><span class="token punctuation">,</span> <span class="token string">"P"</span><span class="token punctuation">:</span> <span class="token number">54</span><span class="token punctuation">,</span> <span class="token string">"Q"</span><span class="token punctuation">:</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token string">"R"</span><span class="token punctuation">:</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token string">"S"</span><span class="token punctuation">:</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token string">"T"</span><span class="token punctuation">:</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token string">"U"</span><span class="token punctuation">:</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token string">"V"</span><span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
         <span class="token string">"W"</span><span class="token punctuation">:</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token string">"X"</span><span class="token punctuation">:</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token string">"Y"</span><span class="token punctuation">:</span> <span class="token number">63</span><span class="token punctuation">,</span> <span class="token string">"Z"</span><span class="token punctuation">:</span> <span class="token number">64</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

chars <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"京"</span><span class="token punctuation">,</span> <span class="token string">"沪"</span><span class="token punctuation">,</span> <span class="token string">"津"</span><span class="token punctuation">,</span> <span class="token string">"渝"</span><span class="token punctuation">,</span> <span class="token string">"冀"</span><span class="token punctuation">,</span> <span class="token string">"晋"</span><span class="token punctuation">,</span> <span class="token string">"蒙"</span><span class="token punctuation">,</span> <span class="token string">"辽"</span><span class="token punctuation">,</span> <span class="token string">"吉"</span><span class="token punctuation">,</span> <span class="token string">"黑"</span><span class="token punctuation">,</span> <span class="token string">"苏"</span><span class="token punctuation">,</span> <span class="token string">"浙"</span><span class="token punctuation">,</span> <span class="token string">"皖"</span><span class="token punctuation">,</span> <span class="token string">"闽"</span><span class="token punctuation">,</span> <span class="token string">"赣"</span><span class="token punctuation">,</span> <span class="token string">"鲁"</span><span class="token punctuation">,</span> <span class="token string">"豫"</span><span class="token punctuation">,</span> <span class="token string">"鄂"</span><span class="token punctuation">,</span> <span class="token string">"湘"</span><span class="token punctuation">,</span> <span class="token string">"粤"</span><span class="token punctuation">,</span> <span class="token string">"桂"</span><span class="token punctuation">,</span>
             <span class="token string">"琼"</span><span class="token punctuation">,</span> <span class="token string">"川"</span><span class="token punctuation">,</span> <span class="token string">"贵"</span><span class="token punctuation">,</span> <span class="token string">"云"</span><span class="token punctuation">,</span> <span class="token string">"藏"</span><span class="token punctuation">,</span> <span class="token string">"陕"</span><span class="token punctuation">,</span> <span class="token string">"甘"</span><span class="token punctuation">,</span> <span class="token string">"青"</span><span class="token punctuation">,</span> <span class="token string">"宁"</span><span class="token punctuation">,</span> <span class="token string">"新"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token string">"9"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span>
             <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token string">"E"</span><span class="token punctuation">,</span> <span class="token string">"F"</span><span class="token punctuation">,</span> <span class="token string">"G"</span><span class="token punctuation">,</span> <span class="token string">"H"</span><span class="token punctuation">,</span> <span class="token string">"J"</span><span class="token punctuation">,</span> <span class="token string">"K"</span><span class="token punctuation">,</span> <span class="token string">"L"</span><span class="token punctuation">,</span> <span class="token string">"M"</span><span class="token punctuation">,</span> <span class="token string">"N"</span><span class="token punctuation">,</span> <span class="token string">"P"</span><span class="token punctuation">,</span> <span class="token string">"Q"</span><span class="token punctuation">,</span> <span class="token string">"R"</span><span class="token punctuation">,</span> <span class="token string">"S"</span><span class="token punctuation">,</span> <span class="token string">"T"</span><span class="token punctuation">,</span> <span class="token string">"U"</span><span class="token punctuation">,</span> <span class="token string">"V"</span><span class="token punctuation">,</span> <span class="token string">"W"</span><span class="token punctuation">,</span> <span class="token string">"X"</span><span class="token punctuation">,</span>
             <span class="token string">"Y"</span><span class="token punctuation">,</span> <span class="token string">"Z"</span>
             <span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> <span class="token function">GenCh</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 生成中文字符</span>
    img<span class="token operator">=</span>Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">"RGB"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    draw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>val<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>font<span class="token operator">=</span>f<span class="token punctuation">)</span>
    img <span class="token operator">=</span>  img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    A <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token keyword">return</span> A

<span class="token keyword">def</span> <span class="token function">GenCh1</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 生成英文字符</span>
    img<span class="token operator">=</span>Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">"RGB"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    draw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>val<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'unicode_escape'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>font<span class="token operator">=</span>f<span class="token punctuation">)</span>
    A <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token keyword">return</span> A

<span class="token keyword">def</span> <span class="token function">AddSmudginess</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> Smu<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rows <span class="token operator">=</span> r<span class="token punctuation">(</span>Smu<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">50</span><span class="token punctuation">)</span>
    cols <span class="token operator">=</span> r<span class="token punctuation">(</span>Smu<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">50</span><span class="token punctuation">)</span>
    adder <span class="token operator">=</span> Smu<span class="token punctuation">[</span>rows<span class="token punctuation">:</span>rows <span class="token operator">+</span> <span class="token number">50</span><span class="token punctuation">,</span> cols<span class="token punctuation">:</span>cols <span class="token operator">+</span> <span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    adder <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>adder<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_not<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_and<span class="token punctuation">(</span>adder<span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_not<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img


<span class="token keyword">def</span> <span class="token function">rot</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span>angel<span class="token punctuation">,</span>shape<span class="token punctuation">,</span>max_angel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 添加仿射变。img表示输入图像，factor表示畸变的参数，size表示图片的目标尺寸。</span>
    size_o <span class="token operator">=</span> <span class="token punctuation">[</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    size <span class="token operator">=</span> <span class="token punctuation">(</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span> <span class="token builtin">int</span><span class="token punctuation">(</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>cos<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>max_angel <span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3.14</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    interval <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span> <span class="token builtin">int</span><span class="token punctuation">(</span> sin<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>angel<span class="token punctuation">)</span> <span class="token operator">/</span><span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3.14</span><span class="token punctuation">)</span><span class="token operator">*</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pts1 <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span>size_o<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>size_o<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>size_o<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>size_o<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>angel<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pts2 <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>interval<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>interval<span class="token punctuation">,</span>size_o<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        pts2 <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>interval<span class="token punctuation">,</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>interval<span class="token punctuation">,</span><span class="token number">0</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>size_o<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    M  <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getPerspectiveTransform<span class="token punctuation">(</span>pts1<span class="token punctuation">,</span>pts2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dst <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpPerspective<span class="token punctuation">(</span>img<span class="token punctuation">,</span>M<span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> dst

<span class="token keyword">def</span> <span class="token function">rotRandrom</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> factor<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 添加透视变换</span>
    shape <span class="token operator">=</span> size<span class="token punctuation">;</span>
    pts1 <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    pts2 <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>r<span class="token punctuation">(</span>factor<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">(</span>factor<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> r<span class="token punctuation">(</span>factor<span class="token punctuation">)</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> r<span class="token punctuation">(</span>factor<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> r<span class="token punctuation">(</span>factor<span class="token punctuation">)</span><span class="token punctuation">,</span>  r<span class="token punctuation">(</span>factor<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                       <span class="token punctuation">[</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> r<span class="token punctuation">(</span>factor<span class="token punctuation">)</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> r<span class="token punctuation">(</span>factor<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    M <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getPerspectiveTransform<span class="token punctuation">(</span>pts1<span class="token punctuation">,</span> pts2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dst <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpPerspective<span class="token punctuation">(</span>img<span class="token punctuation">,</span> M<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> dst

<span class="token keyword">def</span> <span class="token function">tfactor</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 添加饱和度光照的噪声</span>
    hsv <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>COLOR_BGR2HSV<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hsv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> hsv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0.8</span><span class="token operator">+</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hsv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> hsv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token operator">+</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hsv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> hsv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token operator">+</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>hsv<span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>COLOR_HSV2BGR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> img

<span class="token keyword">def</span> <span class="token function">random_envirment</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span>data_set<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 添加自然环境的噪声</span>
    index<span class="token operator">=</span>r<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data_set<span class="token punctuation">)</span><span class="token punctuation">)</span>
    env <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>data_set<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
    env <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>env<span class="token punctuation">,</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    bak <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bak <span class="token operator">=</span> bak<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">255</span><span class="token punctuation">;</span>
    inv <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_and<span class="token punctuation">(</span>bak<span class="token punctuation">,</span>env<span class="token punctuation">)</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_or<span class="token punctuation">(</span>inv<span class="token punctuation">,</span>img<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img

<span class="token keyword">def</span> <span class="token function">AddGauss</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 添加高斯模糊</span>
    <span class="token keyword">return</span> cv2<span class="token punctuation">.</span>blur<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>level <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> level <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">def</span> <span class="token function">r</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> val<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">AddNoiseSingleChannel</span><span class="token punctuation">(</span>single<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 添加高斯噪声</span>
    diff <span class="token operator">=</span> <span class="token number">255</span><span class="token operator">-</span>single<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    noise <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>normal<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">+</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>single<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">;</span>
    noise <span class="token operator">=</span> <span class="token punctuation">(</span>noise <span class="token operator">-</span> noise<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>noise<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>noise<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    noise<span class="token operator">=</span> diff<span class="token operator">*</span>noise<span class="token punctuation">;</span>
    noise<span class="token operator">=</span> noise<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    dst <span class="token operator">=</span> single <span class="token operator">+</span> noise
    <span class="token keyword">return</span> dst

<span class="token keyword">def</span> <span class="token function">addNoise</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span>sdev <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">,</span>avg<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span>  AddNoiseSingleChannel<span class="token punctuation">(</span>img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span>  AddNoiseSingleChannel<span class="token punctuation">(</span>img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span>  AddNoiseSingleChannel<span class="token punctuation">(</span>img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> img

<span class="token keyword">class</span> <span class="token class-name">GenPlate</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>fontCh<span class="token punctuation">,</span>fontEng<span class="token punctuation">,</span>NoPlates<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>fontC <span class="token operator">=</span>  ImageFont<span class="token punctuation">.</span>truetype<span class="token punctuation">(</span>fontCh<span class="token punctuation">,</span><span class="token number">43</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>fontE <span class="token operator">=</span>  ImageFont<span class="token punctuation">.</span>truetype<span class="token punctuation">(</span>fontEng<span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>img<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">"RGB"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">226</span><span class="token punctuation">,</span><span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bg  <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"./images/template.bmp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">226</span><span class="token punctuation">,</span><span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>smu <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"./images/smu2.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>noplates_path <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> parent<span class="token punctuation">,</span>parent_folder<span class="token punctuation">,</span>filenames <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>NoPlates<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> filename <span class="token keyword">in</span> filenames<span class="token punctuation">:</span>
                path <span class="token operator">=</span> parent<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>filename<span class="token punctuation">;</span>
                self<span class="token punctuation">.</span>noplates_path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">def</span> <span class="token function">draw</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">:</span>
        offset<span class="token operator">=</span> <span class="token number">2</span> <span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>img<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">70</span><span class="token punctuation">,</span>offset<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">:</span>offset<span class="token operator">+</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token operator">=</span> GenCh<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fontC<span class="token punctuation">,</span>val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>img<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">70</span><span class="token punctuation">,</span>offset<span class="token operator">+</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">23</span><span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">:</span>offset<span class="token operator">+</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">23</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">+</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token operator">=</span> GenCh1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fontE<span class="token punctuation">,</span>val<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            base <span class="token operator">=</span> offset<span class="token operator">+</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">23</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">+</span><span class="token number">23</span><span class="token operator">+</span><span class="token number">17</span> <span class="token operator">+</span>i<span class="token operator">*</span><span class="token number">23</span> <span class="token operator">+</span> i<span class="token operator">*</span><span class="token number">6</span> <span class="token punctuation">;</span>
            self<span class="token punctuation">.</span>img<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">70</span><span class="token punctuation">,</span> base  <span class="token punctuation">:</span> base<span class="token operator">+</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token operator">=</span> GenCh1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fontE<span class="token punctuation">,</span>val<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>img
    <span class="token keyword">def</span> <span class="token function">generate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">:</span>
            fg <span class="token operator">=</span> self<span class="token punctuation">.</span>draw<span class="token punctuation">(</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fg <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_not<span class="token punctuation">(</span>fg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            com <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_or<span class="token punctuation">(</span>fg<span class="token punctuation">,</span>self<span class="token punctuation">.</span>bg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            com <span class="token operator">=</span> rot<span class="token punctuation">(</span>com<span class="token punctuation">,</span>r<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">,</span>com<span class="token punctuation">.</span>shape<span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            com <span class="token operator">=</span> rotRandrom<span class="token punctuation">(</span>com<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">(</span>com<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>com<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            com <span class="token operator">=</span> tfactor<span class="token punctuation">(</span>com<span class="token punctuation">)</span>
            com <span class="token operator">=</span> random_envirment<span class="token punctuation">(</span>com<span class="token punctuation">,</span>self<span class="token punctuation">.</span>noplates_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            com <span class="token operator">=</span> AddGauss<span class="token punctuation">(</span>com<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">+</span>r<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            com <span class="token operator">=</span> addNoise<span class="token punctuation">(</span>com<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> com
    <span class="token keyword">def</span> <span class="token function">genPlateString</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>pos<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 生成车牌string,将其以图片形式保存</span>
        plateStr <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        box <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pos<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            box<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> unit<span class="token punctuation">,</span>cpos <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> unit <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                plateStr <span class="token operator">+=</span> val
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> cpos <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    plateStr <span class="token operator">+=</span> chars<span class="token punctuation">[</span>r<span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token keyword">elif</span> cpos <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    plateStr <span class="token operator">+=</span> chars<span class="token punctuation">[</span><span class="token number">41</span><span class="token operator">+</span>r<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    plateStr <span class="token operator">+=</span> chars<span class="token punctuation">[</span><span class="token number">31</span> <span class="token operator">+</span> r<span class="token punctuation">(</span><span class="token number">34</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token keyword">return</span> plateStr<span class="token punctuation">;</span>
    <span class="token comment"># 将生成的车牌图片写入文件夹</span>
    <span class="token keyword">def</span> <span class="token function">genBatch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batchSize<span class="token punctuation">,</span>pos<span class="token punctuation">,</span>charRange<span class="token punctuation">,</span> outputPath<span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>outputPath<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>batchSize<span class="token punctuation">)</span><span class="token punctuation">:</span>
                plateStr <span class="token operator">=</span> G<span class="token punctuation">.</span>genPlateString<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                img <span class="token operator">=</span>  G<span class="token punctuation">.</span>generate<span class="token punctuation">(</span>plateStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
                cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>outputPath <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".jpg"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span>
G <span class="token operator">=</span> GenPlate<span class="token punctuation">(</span><span class="token string">"./font/platech.ttf"</span><span class="token punctuation">,</span><span class="token string">'./font/platechar.ttf'</span><span class="token punctuation">,</span><span class="token string">"./NoPlates"</span><span class="token punctuation">)</span>
G<span class="token punctuation">.</span>genBatch<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"./plate"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">272</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#在每次其他模块运行时，若导入该库，则刷新该函数</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/89/68/Pap4QE5y_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e0/59/1mwSQo6j_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/23/4f/0eEf6DIO_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2_195"></a>2：数据读取</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> genplate <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment">#产生用于训练的数据</span>
<span class="token keyword">class</span> <span class="token class-name">OCRIter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>batch_size<span class="token punctuation">,</span>height<span class="token punctuation">,</span>width<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>OCRIter<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>genplate <span class="token operator">=</span> GenPlate<span class="token punctuation">(</span><span class="token string">"./font/platech.ttf"</span><span class="token punctuation">,</span><span class="token string">'./font/platechar.ttf'</span><span class="token punctuation">,</span><span class="token string">'./NoPlates'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>batch_size <span class="token operator">=</span> batch_size
        self<span class="token punctuation">.</span>height <span class="token operator">=</span> height
        self<span class="token punctuation">.</span>width <span class="token operator">=</span> width
        <span class="token comment">#print("make plate data")</span>

<span class="token comment">#    def iter(self):</span>
<span class="token comment">#        for k in range((int)(self.count / self.batch_size)):</span>
<span class="token comment">#            data = []</span>
<span class="token comment">#            label = []</span>
<span class="token comment">#            for i in range(self.batch_size):</span>
<span class="token comment">#                num, img = gen_sample(self.genplate, self.width, self.height)</span>
<span class="token comment">#                data.append(img)</span>
<span class="token comment">#                label.append(num)</span>
<span class="token comment">#            data_all = data</span>
<span class="token comment">#            label_all = label</span>
<span class="token comment">#        return data_all,label_all</span>

    <span class="token keyword">def</span> <span class="token function">iter</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
            num<span class="token punctuation">,</span> img <span class="token operator">=</span> gen_sample<span class="token punctuation">(</span>self<span class="token punctuation">.</span>genplate<span class="token punctuation">,</span> self<span class="token punctuation">.</span>width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
            data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            label<span class="token punctuation">.</span>append<span class="token punctuation">(</span>num<span class="token punctuation">)</span>
        data_all <span class="token operator">=</span> data
        label_all <span class="token operator">=</span> label
        <span class="token keyword">return</span> data_all<span class="token punctuation">,</span>label_all


<span class="token keyword">def</span> <span class="token function">rand_range</span><span class="token punctuation">(</span>lo<span class="token punctuation">,</span>hi<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> lo<span class="token operator">+</span>r<span class="token punctuation">(</span>hi<span class="token operator">-</span>lo<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">def</span> <span class="token function">gen_rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">""</span>
    label<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    label<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rand_range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#产生车牌开头32个省的标签</span>
    label<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rand_range<span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#产生车牌第二个字母的标签</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        label<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rand_range<span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#产生车牌后续5个字母的标签</span>

    name<span class="token operator">+=</span>chars<span class="token punctuation">[</span>label<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    name<span class="token operator">+=</span>chars<span class="token punctuation">[</span>label<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        name<span class="token operator">+=</span>chars<span class="token punctuation">[</span>label<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> name<span class="token punctuation">,</span>label

<span class="token keyword">def</span> <span class="token function">gen_sample</span><span class="token punctuation">(</span>genplate<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">:</span>
    num<span class="token punctuation">,</span>label <span class="token operator">=</span>gen_rand<span class="token punctuation">(</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> genplate<span class="token punctuation">.</span>generate<span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> np<span class="token punctuation">.</span>multiply<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">255.0</span><span class="token punctuation">)</span> <span class="token comment">#[height,width,channel]</span>
    <span class="token comment">#img = img.transpose(2,0,1)</span>
    <span class="token comment">#img = img.transpose(1,0,2)</span>
    <span class="token keyword">return</span> label<span class="token punctuation">,</span>img        <span class="token comment">#返回的label为标签，img为深度为3的图像像素</span>
</code></pre> 
<h2><a id="3_263"></a>3：构建神经网络模型</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">def</span> <span class="token function">inference</span> <span class="token punctuation">(</span>images<span class="token punctuation">,</span>keep_prob<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 第1层卷积层</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'conv1'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span>
                                  shape <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  dtype <span class="token operator">=</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                  initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
        conv <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>images<span class="token punctuation">,</span>weights<span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token string">'VALID'</span><span class="token punctuation">)</span>
        biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'biases'</span><span class="token punctuation">,</span>
                                 shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                 initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pre_activation <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>bias_add<span class="token punctuation">(</span>conv<span class="token punctuation">,</span>biases<span class="token punctuation">)</span>
        conv1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>pre_activation<span class="token punctuation">,</span>name<span class="token operator">=</span> scope<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

    <span class="token comment"># 第2层卷积层</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'conv2'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
        conv <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>conv1<span class="token punctuation">,</span>weights<span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token string">'VALID'</span><span class="token punctuation">)</span>
        biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'biases'</span><span class="token punctuation">,</span>
                                 shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                 initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pre_activation <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>bias_add<span class="token punctuation">(</span>conv<span class="token punctuation">,</span>biases<span class="token punctuation">)</span>
        conv2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>pre_activation<span class="token punctuation">,</span>name<span class="token operator">=</span> scope<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token comment"># 池化层1，进行最大池化操作</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'max_pooling1'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        pool1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>max_pool<span class="token punctuation">(</span>conv2<span class="token punctuation">,</span>ksize <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>strides<span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token string">'VALID'</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'pooling1'</span><span class="token punctuation">)</span>

    <span class="token comment"># 第3层卷积层</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'conv3'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
        conv <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>pool1<span class="token punctuation">,</span>weights<span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token string">'VALID'</span><span class="token punctuation">)</span>
        biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'biases'</span><span class="token punctuation">,</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype <span class="token operator">=</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>initializer<span class="token operator">=</span> tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pre_activation <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>bias_add<span class="token punctuation">(</span>conv<span class="token punctuation">,</span>biases<span class="token punctuation">)</span>
        conv3 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>pre_activation<span class="token punctuation">,</span>name<span class="token operator">=</span>scope<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

    <span class="token comment"># 第4层卷积层</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'conv4'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
        conv <span class="token operator">=</span>tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>conv3<span class="token punctuation">,</span>weights<span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token string">'VALID'</span><span class="token punctuation">)</span>
        biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'biases'</span><span class="token punctuation">,</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pre_activation <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>bias_add<span class="token punctuation">(</span>conv<span class="token punctuation">,</span>biases<span class="token punctuation">)</span>
        conv4 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>pre_activation<span class="token punctuation">,</span>name<span class="token operator">=</span>scope<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token comment"># 池化层2，进行最大池化操作</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'max_pooling2'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        pool2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>max_pool<span class="token punctuation">(</span>conv4<span class="token punctuation">,</span>ksize<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token string">'VALID'</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'pooling2'</span><span class="token punctuation">)</span>

    <span class="token comment"># 第5层卷积层</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'conv5'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
        conv <span class="token operator">=</span>tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>pool2<span class="token punctuation">,</span>weights<span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token string">'VALID'</span><span class="token punctuation">)</span>
        biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'biases'</span><span class="token punctuation">,</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pre_activation <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>bias_add<span class="token punctuation">(</span>conv<span class="token punctuation">,</span>biases<span class="token punctuation">)</span>
        conv5 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>pre_activation<span class="token punctuation">,</span>name<span class="token operator">=</span>scope<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

    <span class="token comment"># 第6层卷积层</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'conv6'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
        conv <span class="token operator">=</span>tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>conv5<span class="token punctuation">,</span>weights<span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token string">'VALID'</span><span class="token punctuation">)</span>
        biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'biases'</span><span class="token punctuation">,</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>constant_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        pre_activation <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>bias_add<span class="token punctuation">(</span>conv<span class="token punctuation">,</span>biases<span class="token punctuation">)</span>
        conv6 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>pre_activation<span class="token punctuation">,</span>name<span class="token operator">=</span>scope<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

    <span class="token comment"># 池化层3，进行最大池化操作</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'max_pool3'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
         pool3 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>max_pool<span class="token punctuation">(</span>conv6<span class="token punctuation">,</span>ksize<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token string">'VALID'</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'pool3'</span><span class="token punctuation">)</span>

    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'fc1'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        shp <span class="token operator">=</span> pool3<span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span>
        flattened_shape <span class="token operator">=</span>shp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token operator">*</span>shp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token operator">*</span>shp<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value
        reshape <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>pool3<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>flattened_shape<span class="token punctuation">]</span><span class="token punctuation">)</span>
        fc1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>reshape<span class="token punctuation">,</span>keep_prob<span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'fc1_dropdot'</span><span class="token punctuation">)</span>

    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'fc21'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span>
                                  shape<span class="token operator">=</span><span class="token punctuation">[</span>flattened_shape<span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                  initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.005</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>

        biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'biases'</span><span class="token punctuation">,</span>
                                 shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                 initializer <span class="token operator">=</span> tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">)</span>
        fc21 <span class="token operator">=</span> tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>fc1<span class="token punctuation">,</span>weights<span class="token punctuation">)</span><span class="token operator">+</span>biases
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'fc22'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span>
                                  shape<span class="token operator">=</span><span class="token punctuation">[</span>flattened_shape<span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                  initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.005</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>

        biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'biases'</span><span class="token punctuation">,</span>
                                 shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                 initializer <span class="token operator">=</span> tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">)</span>
        fc22 <span class="token operator">=</span> tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>fc1<span class="token punctuation">,</span>weights<span class="token punctuation">)</span><span class="token operator">+</span>biases
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'fc23'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span>
                                  shape<span class="token operator">=</span><span class="token punctuation">[</span>flattened_shape<span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                  initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.005</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>

        biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'biases'</span><span class="token punctuation">,</span>
                                 shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                 initializer <span class="token operator">=</span> tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">)</span>
        fc23<span class="token operator">=</span> tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>fc1<span class="token punctuation">,</span>weights<span class="token punctuation">)</span><span class="token operator">+</span>biases
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'fc24'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span>
                                  shape<span class="token operator">=</span><span class="token punctuation">[</span>flattened_shape<span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                  initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.005</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>

        biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'biases'</span><span class="token punctuation">,</span>
                                 shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                 initializer <span class="token operator">=</span> tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">)</span>
        fc24 <span class="token operator">=</span> tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>fc1<span class="token punctuation">,</span>weights<span class="token punctuation">)</span><span class="token operator">+</span>biases
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'fc25'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span>
                                  shape<span class="token operator">=</span><span class="token punctuation">[</span>flattened_shape<span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                  initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.005</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>

        biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'biases'</span><span class="token punctuation">,</span>
                                 shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                 initializer <span class="token operator">=</span> tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">)</span>
        fc25 <span class="token operator">=</span> tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>fc1<span class="token punctuation">,</span>weights<span class="token punctuation">)</span><span class="token operator">+</span>biases
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'fc26'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span>
                                  shape<span class="token operator">=</span><span class="token punctuation">[</span>flattened_shape<span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                  initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.005</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>

        biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'biases'</span><span class="token punctuation">,</span>
                                 shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                 initializer <span class="token operator">=</span> tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">)</span>
        fc26 <span class="token operator">=</span> tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>fc1<span class="token punctuation">,</span>weights<span class="token punctuation">)</span><span class="token operator">+</span>biases
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'fc27'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'weights'</span><span class="token punctuation">,</span>
                                  shape<span class="token operator">=</span><span class="token punctuation">[</span>flattened_shape<span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                  dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                  initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.005</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>

        biases <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">'biases'</span><span class="token punctuation">,</span>
                                 shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                 initializer <span class="token operator">=</span> tf<span class="token punctuation">.</span>truncated_normal_initializer<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">)</span>
        fc27 <span class="token operator">=</span> tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>fc1<span class="token punctuation">,</span>weights<span class="token punctuation">)</span><span class="token operator">+</span>biases

    <span class="token keyword">return</span> fc21<span class="token punctuation">,</span>fc22<span class="token punctuation">,</span>fc23<span class="token punctuation">,</span>fc24<span class="token punctuation">,</span>fc25<span class="token punctuation">,</span>fc26<span class="token punctuation">,</span>fc27    

<span class="token keyword">def</span> <span class="token function">losses</span><span class="token punctuation">(</span>logits1<span class="token punctuation">,</span>logits2<span class="token punctuation">,</span>logits3<span class="token punctuation">,</span>logits4<span class="token punctuation">,</span>logits5<span class="token punctuation">,</span>logits6<span class="token punctuation">,</span>logits7<span class="token punctuation">,</span>labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''Compute loss from logits and labels
    Args:
        logits: logits tensor, float, [7*batch_size, 65]
        labels: label tensor, tf.int32, [7*batch_size]

    Returns:
        loss tensor of float type
    '''</span>
    labels <span class="token operator">=</span> tf<span class="token punctuation">.</span>convert_to_tensor<span class="token punctuation">(</span>labels<span class="token punctuation">,</span>tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>

    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'loss1'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        cross_entropy <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>sparse_softmax_cross_entropy_with_logits<span class="token punctuation">(</span>logits<span class="token operator">=</span>logits1<span class="token punctuation">,</span> labels<span class="token operator">=</span>labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'xentropy_per_example'</span><span class="token punctuation">)</span>
        <span class="token comment">#cross_entropy = tf.nn.softmax_cross_entropy_with_logits(logits=logits,labels=labels,name='xentropy_per_example')</span>
        loss1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>cross_entropy<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'loss1'</span><span class="token punctuation">)</span>
        tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>scope<span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">'/loss1'</span><span class="token punctuation">,</span> loss1<span class="token punctuation">)</span>

    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'loss2'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        cross_entropy <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>sparse_softmax_cross_entropy_with_logits<span class="token punctuation">(</span>logits<span class="token operator">=</span>logits2<span class="token punctuation">,</span> labels<span class="token operator">=</span>labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'xentropy_per_example'</span><span class="token punctuation">)</span>
        <span class="token comment">#cross_entropy = tf.nn.softmax_cross_entropy_with_logits(logits=logits,labels=labels,name='xentropy_per_example')</span>
        loss2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>cross_entropy<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'loss2'</span><span class="token punctuation">)</span>
        tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>scope<span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">'/loss2'</span><span class="token punctuation">,</span> loss2<span class="token punctuation">)</span>

    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'loss3'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        cross_entropy <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>sparse_softmax_cross_entropy_with_logits<span class="token punctuation">(</span>logits<span class="token operator">=</span>logits3<span class="token punctuation">,</span> labels<span class="token operator">=</span>labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'xentropy_per_example'</span><span class="token punctuation">)</span>
        <span class="token comment">#cross_entropy = tf.nn.softmax_cross_entropy_with_logits(logits=logits,labels=labels,name='xentropy_per_example')</span>
        loss3 <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>cross_entropy<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'loss3'</span><span class="token punctuation">)</span>
        tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>scope<span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">'/loss3'</span><span class="token punctuation">,</span> loss3<span class="token punctuation">)</span>

    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'loss4'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        cross_entropy <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>sparse_softmax_cross_entropy_with_logits<span class="token punctuation">(</span>logits<span class="token operator">=</span>logits4<span class="token punctuation">,</span> labels<span class="token operator">=</span>labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'xentropy_per_example'</span><span class="token punctuation">)</span>
        <span class="token comment">#cross_entropy = tf.nn.softmax_cross_entropy_with_logits(logits=logits,labels=labels,name='xentropy_per_example')</span>
        loss4 <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>cross_entropy<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'loss4'</span><span class="token punctuation">)</span>
        tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>scope<span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">'/loss4'</span><span class="token punctuation">,</span> loss4<span class="token punctuation">)</span>

    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'loss5'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        cross_entropy <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>sparse_softmax_cross_entropy_with_logits<span class="token punctuation">(</span>logits<span class="token operator">=</span>logits5<span class="token punctuation">,</span> labels<span class="token operator">=</span>labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'xentropy_per_example'</span><span class="token punctuation">)</span>
        <span class="token comment">#cross_entropy = tf.nn.softmax_cross_entropy_with_logits(logits=logits,labels=labels,name='xentropy_per_example')</span>
        loss5 <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>cross_entropy<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'loss5'</span><span class="token punctuation">)</span>
        tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>scope<span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">'/loss5'</span><span class="token punctuation">,</span> loss5<span class="token punctuation">)</span>

    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'loss6'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        cross_entropy <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>sparse_softmax_cross_entropy_with_logits<span class="token punctuation">(</span>logits<span class="token operator">=</span>logits6<span class="token punctuation">,</span> labels<span class="token operator">=</span>labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'xentropy_per_example'</span><span class="token punctuation">)</span>
        <span class="token comment">#cross_entropy = tf.nn.softmax_cross_entropy_with_logits(logits=logits,labels=labels,name='xentropy_per_example')</span>
        loss6 <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>cross_entropy<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'loss6'</span><span class="token punctuation">)</span>
        tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>scope<span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">'/loss6'</span><span class="token punctuation">,</span> loss6<span class="token punctuation">)</span>

    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'loss7'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
        cross_entropy <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>sparse_softmax_cross_entropy_with_logits<span class="token punctuation">(</span>logits<span class="token operator">=</span>logits7<span class="token punctuation">,</span> labels<span class="token operator">=</span>labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'xentropy_per_example'</span><span class="token punctuation">)</span>
        <span class="token comment">#cross_entropy = tf.nn.softmax_cross_entropy_with_logits(logits=logits,labels=labels,name='xentropy_per_example')</span>
        loss7 <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>cross_entropy<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'loss7'</span><span class="token punctuation">)</span>
        tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>scope<span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">'/loss7'</span><span class="token punctuation">,</span> loss7<span class="token punctuation">)</span>

    <span class="token keyword">return</span> loss1<span class="token punctuation">,</span>loss2<span class="token punctuation">,</span>loss3<span class="token punctuation">,</span>loss4<span class="token punctuation">,</span>loss5<span class="token punctuation">,</span>loss6<span class="token punctuation">,</span>loss7

<span class="token keyword">def</span> <span class="token function">trainning</span><span class="token punctuation">(</span> loss1<span class="token punctuation">,</span>loss2<span class="token punctuation">,</span>loss3<span class="token punctuation">,</span>loss4<span class="token punctuation">,</span>loss5<span class="token punctuation">,</span>loss6<span class="token punctuation">,</span>loss7<span class="token punctuation">,</span> learning_rate<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''Training ops, the Op returned by this function is what must be passed to
        'sess.run()' call to cause the model to train.

    Args:
        loss: loss tensor, from losses()

    Returns:
        train_op: The op for trainning
    '''</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">'optimizer1'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        optimizer1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span> learning_rate<span class="token punctuation">)</span>
        global_step <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'global_step'</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        train_op1 <span class="token operator">=</span> optimizer1<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss1<span class="token punctuation">,</span> global_step<span class="token operator">=</span> global_step<span class="token punctuation">)</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">'optimizer2'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        optimizer2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span> learning_rate<span class="token punctuation">)</span>
        global_step <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'global_step'</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        train_op2 <span class="token operator">=</span> optimizer2<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss2<span class="token punctuation">,</span> global_step<span class="token operator">=</span> global_step<span class="token punctuation">)</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">'optimizer3'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        optimizer3 <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span> learning_rate<span class="token punctuation">)</span>
        global_step <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'global_step'</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        train_op3 <span class="token operator">=</span> optimizer3<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss3<span class="token punctuation">,</span> global_step<span class="token operator">=</span> global_step<span class="token punctuation">)</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">'optimizer4'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        optimizer4 <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span> learning_rate<span class="token punctuation">)</span>
        global_step <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'global_step'</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        train_op4 <span class="token operator">=</span> optimizer4<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss4<span class="token punctuation">,</span> global_step<span class="token operator">=</span> global_step<span class="token punctuation">)</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">'optimizer5'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        optimizer5 <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span> learning_rate<span class="token punctuation">)</span>
        global_step <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'global_step'</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        train_op5 <span class="token operator">=</span> optimizer5<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss5<span class="token punctuation">,</span> global_step<span class="token operator">=</span> global_step<span class="token punctuation">)</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">'optimizer6'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        optimizer6 <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span> learning_rate<span class="token punctuation">)</span>
        global_step <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'global_step'</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        train_op6 <span class="token operator">=</span> optimizer6<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss6<span class="token punctuation">,</span> global_step<span class="token operator">=</span> global_step<span class="token punctuation">)</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token string">'optimizer7'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        optimizer7 <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span> learning_rate<span class="token punctuation">)</span>
        global_step <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'global_step'</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        train_op7 <span class="token operator">=</span> optimizer7<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss7<span class="token punctuation">,</span> global_step<span class="token operator">=</span> global_step<span class="token punctuation">)</span>

    <span class="token keyword">return</span> train_op1<span class="token punctuation">,</span>train_op2<span class="token punctuation">,</span>train_op3<span class="token punctuation">,</span>train_op4<span class="token punctuation">,</span>train_op5<span class="token punctuation">,</span>train_op6<span class="token punctuation">,</span>train_op7

<span class="token keyword">def</span> <span class="token function">evaluation</span><span class="token punctuation">(</span>logits1<span class="token punctuation">,</span>logits2<span class="token punctuation">,</span>logits3<span class="token punctuation">,</span>logits4<span class="token punctuation">,</span>logits5<span class="token punctuation">,</span>logits6<span class="token punctuation">,</span>logits7<span class="token punctuation">,</span>labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token triple-quoted-string string">"""Evaluate the quality of the logits at predicting the label.
  Args:
    logits: Logits tensor, float - [batch_size, NUM_CLASSES].
    labels: Labels tensor, int32 - [batch_size], with values in the
      range [0, NUM_CLASSES).
  Returns:
    A scalar int32 tensor with the number of examples (out of batch_size)
    that were predicted correctly.
  """</span>
  logits_all <span class="token operator">=</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>logits1<span class="token punctuation">,</span>logits2<span class="token punctuation">,</span>logits3<span class="token punctuation">,</span>logits4<span class="token punctuation">,</span>logits5<span class="token punctuation">,</span>logits6<span class="token punctuation">,</span>logits7<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
  labels <span class="token operator">=</span> tf<span class="token punctuation">.</span>convert_to_tensor<span class="token punctuation">(</span>labels<span class="token punctuation">,</span>tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
  labels_all <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>labels<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span><span class="token string">'accuracy'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
      correct <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>in_top_k<span class="token punctuation">(</span>logits_all<span class="token punctuation">,</span> labels_all<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      correct <span class="token operator">=</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>correct<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float16<span class="token punctuation">)</span>
      accuracy <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>correct<span class="token punctuation">)</span>
      tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>scalar<span class="token punctuation">(</span>scope<span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">'/accuracy'</span><span class="token punctuation">,</span> accuracy<span class="token punctuation">)</span>
  <span class="token keyword">return</span> accuracy
</code></pre> 
<h2><a id="4_547"></a>4：开始训练模型</h2> 
<pre><code class="prism language-python"><span class="token comment">#%%</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">from</span> input_data <span class="token keyword">import</span> OCRIter
<span class="token keyword">import</span> model
<span class="token keyword">import</span> time
<span class="token keyword">import</span> datetime
tf<span class="token punctuation">.</span>reset_default_graph<span class="token punctuation">(</span><span class="token punctuation">)</span>
img_w <span class="token operator">=</span> <span class="token number">272</span>
img_h <span class="token operator">=</span> <span class="token number">72</span>
num_label<span class="token operator">=</span><span class="token number">7</span>
batch_size <span class="token operator">=</span> <span class="token number">8</span>
count <span class="token operator">=</span> <span class="token number">30000</span>
learning_rate <span class="token operator">=</span> <span class="token number">0.0001</span>

<span class="token comment">#默认参数[N,H,W,C]</span>
image_holder <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span><span class="token punctuation">[</span>batch_size<span class="token punctuation">,</span>img_h<span class="token punctuation">,</span>img_w<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
label_holder <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>int32<span class="token punctuation">,</span><span class="token punctuation">[</span>batch_size<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
keep_prob <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

logs_train_dir <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">r'.\train_result'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_batch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data_batch <span class="token operator">=</span> OCRIter<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span>img_h<span class="token punctuation">,</span>img_w<span class="token punctuation">)</span>
    image_batch<span class="token punctuation">,</span>label_batch <span class="token operator">=</span> data_batch<span class="token punctuation">.</span><span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    image_batch1 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>image_batch<span class="token punctuation">)</span>
    label_batch1 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>label_batch<span class="token punctuation">)</span>
    <span class="token keyword">return</span> image_batch1<span class="token punctuation">,</span>label_batch1


train_logits1<span class="token punctuation">,</span>train_logits2<span class="token punctuation">,</span>train_logits3<span class="token punctuation">,</span>train_logits4<span class="token punctuation">,</span>train_logits5<span class="token punctuation">,</span>train_logits6<span class="token punctuation">,</span>train_logits7<span class="token operator">=</span> model<span class="token punctuation">.</span>inference<span class="token punctuation">(</span>image_holder<span class="token punctuation">,</span>keep_prob<span class="token punctuation">)</span>

train_loss1<span class="token punctuation">,</span>train_loss2<span class="token punctuation">,</span>train_loss3<span class="token punctuation">,</span>train_loss4<span class="token punctuation">,</span>train_loss5<span class="token punctuation">,</span>train_loss6<span class="token punctuation">,</span>train_loss7 <span class="token operator">=</span> model<span class="token punctuation">.</span>losses<span class="token punctuation">(</span>train_logits1<span class="token punctuation">,</span>train_logits2<span class="token punctuation">,</span>train_logits3<span class="token punctuation">,</span>train_logits4<span class="token punctuation">,</span>train_logits5<span class="token punctuation">,</span>train_logits6<span class="token punctuation">,</span>train_logits7<span class="token punctuation">,</span>label_holder<span class="token punctuation">)</span>
train_op1<span class="token punctuation">,</span>train_op2<span class="token punctuation">,</span>train_op3<span class="token punctuation">,</span>train_op4<span class="token punctuation">,</span>train_op5<span class="token punctuation">,</span>train_op6<span class="token punctuation">,</span>train_op7 <span class="token operator">=</span> model<span class="token punctuation">.</span>trainning<span class="token punctuation">(</span>train_loss1<span class="token punctuation">,</span>train_loss2<span class="token punctuation">,</span>train_loss3<span class="token punctuation">,</span>train_loss4<span class="token punctuation">,</span>train_loss5<span class="token punctuation">,</span>train_loss6<span class="token punctuation">,</span>train_loss7<span class="token punctuation">,</span>learning_rate<span class="token punctuation">)</span>

train_acc <span class="token operator">=</span> model<span class="token punctuation">.</span>evaluation<span class="token punctuation">(</span>train_logits1<span class="token punctuation">,</span>train_logits2<span class="token punctuation">,</span>train_logits3<span class="token punctuation">,</span>train_logits4<span class="token punctuation">,</span>train_logits5<span class="token punctuation">,</span>train_logits6<span class="token punctuation">,</span>train_logits7<span class="token punctuation">,</span>label_holder<span class="token punctuation">)</span>

input_image<span class="token operator">=</span>tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>image<span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span>image_holder<span class="token punctuation">)</span>
<span class="token comment">#tf.summary.histogram('label',label_holder) #label的histogram,测试训练代码时用，参考:http://geek.csdn.net/news/detail/197155</span>

summary_op <span class="token operator">=</span> tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>get_collection<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>GraphKeys<span class="token punctuation">.</span>SUMMARIES<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#sess = tf.Session(config=tf.ConfigProto(log_device_placement=True))  #运行日志</span>
sess <span class="token operator">=</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
train_writer <span class="token operator">=</span> tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>FileWriter<span class="token punctuation">(</span>logs_train_dir<span class="token punctuation">,</span>sess<span class="token punctuation">.</span>graph<span class="token punctuation">)</span>
saver <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Saver<span class="token punctuation">(</span><span class="token punctuation">)</span>

sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

start_time1 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>

    x_batch<span class="token punctuation">,</span>y_batch <span class="token operator">=</span> get_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>

    start_time2 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time_str <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>

    feed_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>image_holder<span class="token punctuation">:</span>x_batch<span class="token punctuation">,</span>label_holder<span class="token punctuation">:</span>y_batch<span class="token punctuation">,</span>keep_prob<span class="token punctuation">:</span><span class="token number">0.5</span><span class="token punctuation">}</span>
    _<span class="token punctuation">,</span>_<span class="token punctuation">,</span>_<span class="token punctuation">,</span>_<span class="token punctuation">,</span>_<span class="token punctuation">,</span>_<span class="token punctuation">,</span>_<span class="token punctuation">,</span>tra_loss1<span class="token punctuation">,</span>tra_loss2<span class="token punctuation">,</span>tra_loss3<span class="token punctuation">,</span>tra_loss4<span class="token punctuation">,</span>tra_loss5<span class="token punctuation">,</span>tra_loss6<span class="token punctuation">,</span>tra_loss7<span class="token punctuation">,</span>acc<span class="token punctuation">,</span>summary_str<span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>train_op1<span class="token punctuation">,</span>train_op2<span class="token punctuation">,</span>train_op3<span class="token punctuation">,</span>train_op4<span class="token punctuation">,</span>train_op5<span class="token punctuation">,</span>train_op6<span class="token punctuation">,</span>train_op7<span class="token punctuation">,</span>train_loss1<span class="token punctuation">,</span>train_loss2<span class="token punctuation">,</span>train_loss3<span class="token punctuation">,</span>train_loss4<span class="token punctuation">,</span>train_loss5<span class="token punctuation">,</span>train_loss6<span class="token punctuation">,</span>train_loss7<span class="token punctuation">,</span>train_acc<span class="token punctuation">,</span>summary_op<span class="token punctuation">]</span><span class="token punctuation">,</span>feed_dict<span class="token punctuation">)</span>
    train_writer<span class="token punctuation">.</span>add_summary<span class="token punctuation">(</span>summary_str<span class="token punctuation">,</span>step<span class="token punctuation">)</span>
    duration <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start_time2
    tra_all_loss <span class="token operator">=</span>tra_loss1<span class="token operator">+</span>tra_loss2<span class="token operator">+</span>tra_loss3<span class="token operator">+</span>tra_loss4<span class="token operator">+</span>tra_loss5<span class="token operator">+</span>tra_loss6<span class="token operator">+</span>tra_loss7

    <span class="token comment">#print(y_batch)  #仅测试代码训练实际样本与标签是否一致</span>

    <span class="token keyword">if</span> step <span class="token operator">%</span> <span class="token number">10</span><span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        sec_per_batch <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s : Step %d,train_loss = %.2f,acc= %.2f,sec/batch=%.3f'</span> <span class="token operator">%</span><span class="token punctuation">(</span>time_str<span class="token punctuation">,</span>step<span class="token punctuation">,</span>tra_all_loss<span class="token punctuation">,</span>acc<span class="token punctuation">,</span>sec_per_batch<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> step <span class="token operator">%</span> <span class="token number">10000</span><span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>step<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> count<span class="token punctuation">:</span>
        checkpoint_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>logs_train_dir<span class="token punctuation">,</span><span class="token string">'model.ckpt'</span><span class="token punctuation">)</span>
        saver <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Saver<span class="token punctuation">(</span><span class="token punctuation">)</span>
        saver<span class="token punctuation">.</span>save<span class="token punctuation">(</span>sess<span class="token punctuation">,</span>checkpoint_path<span class="token punctuation">,</span>global_step<span class="token operator">=</span>step<span class="token punctuation">)</span>
sess<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start_time1<span class="token punctuation">)</span>
</code></pre> 
<p>因为测试数据过大，所以运行了一整天才出结果，调试可以把数据量改为30<br> <img src="https://images2.imgbox.com/37/33/QEcWYF2a_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="5_631"></a>5：测试模型准确度</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> os
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> model
<span class="token keyword">import</span> genplate
tf<span class="token punctuation">.</span>reset_default_graph<span class="token punctuation">(</span><span class="token punctuation">)</span>
index <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"京"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"沪"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"津"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"渝"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"冀"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"晋"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"蒙"</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">"辽"</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"吉"</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"黑"</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">"苏"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">"浙"</span><span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">"皖"</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
         <span class="token string">"闽"</span><span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">"赣"</span><span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">"鲁"</span><span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">"豫"</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">"鄂"</span><span class="token punctuation">:</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">"湘"</span><span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"粤"</span><span class="token punctuation">:</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">"桂"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"琼"</span><span class="token punctuation">:</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">"川"</span><span class="token punctuation">:</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token string">"贵"</span><span class="token punctuation">:</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">"云"</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
         <span class="token string">"藏"</span><span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token string">"陕"</span><span class="token punctuation">:</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token string">"甘"</span><span class="token punctuation">:</span> <span class="token number">27</span><span class="token punctuation">,</span> <span class="token string">"青"</span><span class="token punctuation">:</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token string">"宁"</span><span class="token punctuation">:</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token string">"新"</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">:</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">:</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">:</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">:</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">:</span> <span class="token number">36</span><span class="token punctuation">,</span>
         <span class="token string">"6"</span><span class="token punctuation">:</span> <span class="token number">37</span><span class="token punctuation">,</span> <span class="token string">"7"</span><span class="token punctuation">:</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">:</span> <span class="token number">39</span><span class="token punctuation">,</span> <span class="token string">"9"</span><span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">:</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">:</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token string">"E"</span><span class="token punctuation">:</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token string">"F"</span><span class="token punctuation">:</span> <span class="token number">46</span><span class="token punctuation">,</span> <span class="token string">"G"</span><span class="token punctuation">:</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token string">"H"</span><span class="token punctuation">:</span> <span class="token number">48</span><span class="token punctuation">,</span>
         <span class="token string">"J"</span><span class="token punctuation">:</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token string">"K"</span><span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token string">"L"</span><span class="token punctuation">:</span> <span class="token number">51</span><span class="token punctuation">,</span> <span class="token string">"M"</span><span class="token punctuation">:</span> <span class="token number">52</span><span class="token punctuation">,</span> <span class="token string">"N"</span><span class="token punctuation">:</span> <span class="token number">53</span><span class="token punctuation">,</span> <span class="token string">"P"</span><span class="token punctuation">:</span> <span class="token number">54</span><span class="token punctuation">,</span> <span class="token string">"Q"</span><span class="token punctuation">:</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token string">"R"</span><span class="token punctuation">:</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token string">"S"</span><span class="token punctuation">:</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token string">"T"</span><span class="token punctuation">:</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token string">"U"</span><span class="token punctuation">:</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token string">"V"</span><span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
         <span class="token string">"W"</span><span class="token punctuation">:</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token string">"X"</span><span class="token punctuation">:</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token string">"Y"</span><span class="token punctuation">:</span> <span class="token number">63</span><span class="token punctuation">,</span> <span class="token string">"Z"</span><span class="token punctuation">:</span> <span class="token number">64</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

chars <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"京"</span><span class="token punctuation">,</span> <span class="token string">"沪"</span><span class="token punctuation">,</span> <span class="token string">"津"</span><span class="token punctuation">,</span> <span class="token string">"渝"</span><span class="token punctuation">,</span> <span class="token string">"冀"</span><span class="token punctuation">,</span> <span class="token string">"晋"</span><span class="token punctuation">,</span> <span class="token string">"蒙"</span><span class="token punctuation">,</span> <span class="token string">"辽"</span><span class="token punctuation">,</span> <span class="token string">"吉"</span><span class="token punctuation">,</span> <span class="token string">"黑"</span><span class="token punctuation">,</span> <span class="token string">"苏"</span><span class="token punctuation">,</span> <span class="token string">"浙"</span><span class="token punctuation">,</span> <span class="token string">"皖"</span><span class="token punctuation">,</span> <span class="token string">"闽"</span><span class="token punctuation">,</span> <span class="token string">"赣"</span><span class="token punctuation">,</span> <span class="token string">"鲁"</span><span class="token punctuation">,</span> <span class="token string">"豫"</span><span class="token punctuation">,</span> <span class="token string">"鄂"</span><span class="token punctuation">,</span> <span class="token string">"湘"</span><span class="token punctuation">,</span> <span class="token string">"粤"</span><span class="token punctuation">,</span> <span class="token string">"桂"</span><span class="token punctuation">,</span>
             <span class="token string">"琼"</span><span class="token punctuation">,</span> <span class="token string">"川"</span><span class="token punctuation">,</span> <span class="token string">"贵"</span><span class="token punctuation">,</span> <span class="token string">"云"</span><span class="token punctuation">,</span> <span class="token string">"藏"</span><span class="token punctuation">,</span> <span class="token string">"陕"</span><span class="token punctuation">,</span> <span class="token string">"甘"</span><span class="token punctuation">,</span> <span class="token string">"青"</span><span class="token punctuation">,</span> <span class="token string">"宁"</span><span class="token punctuation">,</span> <span class="token string">"新"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token string">"9"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span>
             <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token string">"E"</span><span class="token punctuation">,</span> <span class="token string">"F"</span><span class="token punctuation">,</span> <span class="token string">"G"</span><span class="token punctuation">,</span> <span class="token string">"H"</span><span class="token punctuation">,</span> <span class="token string">"J"</span><span class="token punctuation">,</span> <span class="token string">"K"</span><span class="token punctuation">,</span> <span class="token string">"L"</span><span class="token punctuation">,</span> <span class="token string">"M"</span><span class="token punctuation">,</span> <span class="token string">"N"</span><span class="token punctuation">,</span> <span class="token string">"P"</span><span class="token punctuation">,</span> <span class="token string">"Q"</span><span class="token punctuation">,</span> <span class="token string">"R"</span><span class="token punctuation">,</span> <span class="token string">"S"</span><span class="token punctuation">,</span> <span class="token string">"T"</span><span class="token punctuation">,</span> <span class="token string">"U"</span><span class="token punctuation">,</span> <span class="token string">"V"</span><span class="token punctuation">,</span> <span class="token string">"W"</span><span class="token punctuation">,</span> <span class="token string">"X"</span><span class="token punctuation">,</span>
             <span class="token string">"Y"</span><span class="token punctuation">,</span> <span class="token string">"Z"</span>
             <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token triple-quoted-string string">'''
Test one image against the saved models and parameters
'''</span>
<span class="token keyword">global</span> pic
<span class="token keyword">def</span> <span class="token function">get_one_image</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    Randomly pick one image from training data
    Return: ndarry
    '''</span>
    G <span class="token operator">=</span> genplate<span class="token punctuation">.</span>GenPlate<span class="token punctuation">(</span><span class="token string">"./font/platech.ttf"</span><span class="token punctuation">,</span> <span class="token string">'./font/platechar.ttf'</span><span class="token punctuation">,</span> <span class="token string">"./NoPlates"</span><span class="token punctuation">)</span>

    G<span class="token punctuation">.</span>genBatch<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"./plate"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">272</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 注释原因为每次其他模块运行，若导入该库，都会刷性该函数</span>
    n <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span>
    ind <span class="token operator">=</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span>
    img_dir <span class="token operator">=</span> test<span class="token punctuation">[</span>ind<span class="token punctuation">]</span>

    image_show <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img_dir<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image_show<span class="token punctuation">)</span>
    <span class="token comment">#image = image.resize([120,30])</span>
    image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_dir<span class="token punctuation">)</span>
    <span class="token keyword">global</span>  pic
    pic <span class="token operator">=</span> image
    <span class="token comment"># cv2.imshow('image', image)</span>
    <span class="token comment"># cv2.waitKey(0)</span>
    img <span class="token operator">=</span> np<span class="token punctuation">.</span>multiply<span class="token punctuation">(</span>image<span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">255.0</span><span class="token punctuation">)</span>
    <span class="token comment">#image = np.array(img)</span>
    <span class="token comment">#image = img.transpose(1,0,2)</span>
    image <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>img<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

    <span class="token keyword">return</span> image

batch_size <span class="token operator">=</span> <span class="token number">1</span>
x <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span><span class="token punctuation">[</span>batch_size<span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">272</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
keep_prob <span class="token operator">=</span>tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

test_dir <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">r'.\plate/'</span><span class="token punctuation">)</span>
test_image <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>test_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    test_image<span class="token punctuation">.</span>append<span class="token punctuation">(</span>test_dir <span class="token operator">+</span> <span class="token builtin">file</span><span class="token punctuation">)</span>
test_image <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>test_image<span class="token punctuation">)</span>

image_array <span class="token operator">=</span> get_one_image<span class="token punctuation">(</span>test_image<span class="token punctuation">)</span>

<span class="token comment">#logit = model.inference(x,keep_prob)</span>
logit1<span class="token punctuation">,</span>logit2<span class="token punctuation">,</span>logit3<span class="token punctuation">,</span>logit4<span class="token punctuation">,</span>logit5<span class="token punctuation">,</span>logit6<span class="token punctuation">,</span>logit7 <span class="token operator">=</span> model<span class="token punctuation">.</span>inference<span class="token punctuation">(</span>x<span class="token punctuation">,</span>keep_prob<span class="token punctuation">)</span>

<span class="token comment">#logit1 = tf.nn.softmax(logit1)</span>
<span class="token comment">#logit2 = tf.nn.softmax(logit2)</span>
<span class="token comment">#logit3 = tf.nn.softmax(logit3)</span>
<span class="token comment">#logit4 = tf.nn.softmax(logit4)</span>
<span class="token comment">#logit5 = tf.nn.softmax(logit5)</span>
<span class="token comment">#logit6 = tf.nn.softmax(logit6)</span>
<span class="token comment">#logit7 = tf.nn.softmax(logit7)</span>

<span class="token comment"># logs_train_dir = '/home/llc/TF_test/Chinese_plate_recognition/Plate_recognition/train_logs_50000/'</span>
logs_train_dir <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">r'.\train_result/'</span><span class="token punctuation">)</span>
saver <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Saver<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>get_variable_scope<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reuse_variables<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"Reading checkpoint..."</span><span class="token punctuation">)</span>
    ckpt <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>get_checkpoint_state<span class="token punctuation">(</span>logs_train_dir<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ckpt <span class="token keyword">and</span> ckpt<span class="token punctuation">.</span>model_checkpoint_path<span class="token punctuation">:</span>
        global_step <span class="token operator">=</span> ckpt<span class="token punctuation">.</span>model_checkpoint_path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        saver<span class="token punctuation">.</span>restore<span class="token punctuation">(</span>sess<span class="token punctuation">,</span> ckpt<span class="token punctuation">.</span>model_checkpoint_path<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Loading success, global_step is %s'</span> <span class="token operator">%</span> global_step<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'No checkpoint file found'</span><span class="token punctuation">)</span>

    pre1<span class="token punctuation">,</span>pre2<span class="token punctuation">,</span>pre3<span class="token punctuation">,</span>pre4<span class="token punctuation">,</span>pre5<span class="token punctuation">,</span>pre6<span class="token punctuation">,</span>pre7 <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>logit1<span class="token punctuation">,</span>logit2<span class="token punctuation">,</span>logit3<span class="token punctuation">,</span>logit4<span class="token punctuation">,</span>logit5<span class="token punctuation">,</span>logit6<span class="token punctuation">,</span>logit7<span class="token punctuation">]</span><span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">:</span> image_array<span class="token punctuation">,</span>keep_prob<span class="token punctuation">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    prediction <span class="token operator">=</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>pre1<span class="token punctuation">,</span>pre2<span class="token punctuation">,</span>pre3<span class="token punctuation">,</span>pre4<span class="token punctuation">,</span>pre5<span class="token punctuation">,</span>pre6<span class="token punctuation">,</span>pre7<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">#prediction = np.array([[pre1],[pre2],[pre3],[pre4],[pre5],[pre6],[pre7]])</span>
    <span class="token comment">#print(prediction)</span>

    max_index <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>prediction<span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>max_index<span class="token punctuation">)</span>
    line <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>prediction<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">41</span><span class="token punctuation">:</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">41</span>
        <span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">31</span>

        line <span class="token operator">+=</span> chars<span class="token punctuation">[</span>result<span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">" "</span>
    <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'predicted: '</span> <span class="token operator">+</span> line<span class="token punctuation">)</span>

cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'pic'</span><span class="token punctuation">,</span>pic<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>waitKeyEx<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/08/74/fhGaj9aV_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/72/fb/PZt77tu0_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8e720a89a284afa888e79e40fed0efc0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">图像数据处理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4de4c6f012134c153f29a80bb2e8ac1c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python入门网络爬虫之精华版，赶快收藏</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>