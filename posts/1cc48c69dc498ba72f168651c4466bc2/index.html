<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>2.Kubernetes基础-1 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="2.Kubernetes基础-1" />
<meta property="og:description" content="Kubernetes基础-1 掌握Kubernetes，需要我们有扎实的docker基础。
深入了解pods之前，我们需要：
应用程序已经开发并打包成Docker镜像，并且在Docker存储库（如Docker Hub）中可用，可下载Kubernetes集群正在工作（单节点或多节点） 使用Kubernetes的最终目标是将应用程序以容器的形式部署在配置为集群中工作节点的一组机器上。
Kubernetes不会直接在工作节点上部署容器。容器被封装到称为pods的Kubernetes对象中。pod是应用程序的单个实例。pod是您可以在Kubernetes中创建的最小对象。在这里，我们看到了最简单的情况，即您有一个单节点Kubernetes集群，其中您的应用程序的单个实例在单个Docker容器中运行，封装在pod中。
Pod Pod是kubernetes的最小调度单元，也是最基础的概念。
容器的本质是一个隔离的进程；而Pod则是一组相互联系的进程。Pod可以包含一个或者多个容器。
我们可以通过kubectl run来启动Pod，默认image会从docker hub拉取
kubectl run nginx-pod --image=nginx # pod/nginx created kubectl get pods # NAME READY STATUS RESTARTS AGE # nginx 1/1 Running 0 50s kubectl describe pod nginx-pod # Name: nginx # Namespace: default # Priority: 0 # Node: node2/192.168.0.7 # Start Time: Thu, 02 Feb 2023 06:44:13 &#43;0000 # Labels: run=nginx # Annotations: &lt;none&gt; # Status: Running # IP: 10." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/1cc48c69dc498ba72f168651c4466bc2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-18T16:49:07+08:00" />
<meta property="article:modified_time" content="2024-02-18T16:49:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">2.Kubernetes基础-1</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Kubernetes1_0"></a>Kubernetes基础-1</h2> 
<p>掌握Kubernetes，需要我们有扎实的docker基础。</p> 
<p>深入了解pods之前，我们需要：</p> 
<ul><li>应用程序已经开发并打包成Docker镜像，并且在Docker存储库（如Docker Hub）中可用，可下载</li><li>Kubernetes集群正在工作（单节点或多节点）</li></ul> 
<p>使用Kubernetes的最终目标是将应用程序以容器的形式部署在配置为集群中工作节点的一组机器上。<br> Kubernetes不会直接在工作节点上部署容器。容器被封装到称为pods的Kubernetes对象中。pod是应用程序的单个实例。pod是您可以在Kubernetes中创建的最小对象。在这里，我们看到了最简单的情况，即您有一个单节点Kubernetes集群，其中您的应用程序的单个实例在单个Docker容器中运行，封装在pod中。</p> 
<h3><a id="Pod_12"></a>Pod</h3> 
<p>Pod是kubernetes的最小调度单元，也是最基础的概念。<br> 容器的本质是一个隔离的进程；而Pod则是一组相互联系的进程。Pod可以包含一个或者多个容器。</p> 
<p>我们可以通过<code>kubectl run</code>来启动Pod，默认image会从docker hub拉取</p> 
<pre><code class="prism language-bash">kubectl run nginx-pod <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx
<span class="token comment"># pod/nginx created</span>

kubectl get pods
<span class="token comment"># NAME    READY   STATUS    RESTARTS   AGE</span>
<span class="token comment"># nginx   1/1     Running   0          50s</span>

kubectl describe pod nginx-pod
<span class="token comment"># Name:         nginx</span>
<span class="token comment"># Namespace:    default</span>
<span class="token comment"># Priority:     0</span>
<span class="token comment"># Node:         node2/192.168.0.7</span>
<span class="token comment"># Start Time:   Thu, 02 Feb 2023 06:44:13 +0000</span>
<span class="token comment"># Labels:       run=nginx</span>
<span class="token comment"># Annotations:  &lt;none&gt;</span>
<span class="token comment"># Status:       Running</span>
<span class="token comment"># IP:           10.5.1.2</span>
<span class="token comment"># IPs:</span>
<span class="token comment">#   IP:  10.5.1.2</span>
<span class="token comment"># Containers:</span>
<span class="token comment">#   nginx:</span>
<span class="token comment">#     Container ID:   docker://40f5485d27cce5862a6424645a01c962aa3f9c4ae85dc5db7273cfbc4c717cdf</span>
<span class="token comment">#     Image:          nginx</span>
<span class="token comment">#     Image ID:       docker-pullable://nginx@sha256:b8f2383a95879e1ae064940d9a200f67a6c79e710ed82ac42263397367e7cc4e</span>
<span class="token comment">#     Port:           &lt;none&gt;</span>
<span class="token comment">#     Host Port:      &lt;none&gt;</span>
<span class="token comment">#     State:          Running</span>
<span class="token comment">#       Started:      Thu, 02 Feb 2023 06:44:27 +0000</span>
<span class="token comment">#     Ready:          True</span>
<span class="token comment">#     Restart Count:  0</span>
<span class="token comment">#     Environment:    &lt;none&gt;</span>
<span class="token comment">#     Mounts:</span>
<span class="token comment">#       /var/run/secrets/kubernetes.io/serviceaccount from default-token-69hgb (ro)</span>
<span class="token comment"># Conditions:</span>
<span class="token comment">#   Type              Status</span>
<span class="token comment">#   Initialized       True </span>
<span class="token comment">#   Ready             True </span>
<span class="token comment">#   ContainersReady   True </span>
<span class="token comment">#   PodScheduled      True </span>
<span class="token comment"># Volumes:</span>
<span class="token comment">#   default-token-69hgb:</span>
<span class="token comment">#     Type:        Secret (a volume populated by a Secret)</span>
<span class="token comment">#     SecretName:  default-token-69hgb</span>
<span class="token comment">#     Optional:    false</span>
<span class="token comment"># QoS Class:       BestEffort</span>
<span class="token comment"># Node-Selectors:  &lt;none&gt;</span>
<span class="token comment"># Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists for 300s</span>
<span class="token comment">#                  node.kubernetes.io/unreachable:NoExecute op=Exists for 300s</span>
<span class="token comment"># Events:</span>
<span class="token comment">#   Type     Reason            Age                From               Message</span>
<span class="token comment">#   ----     ------            ----               ----               -------</span>
<span class="token comment">#   Warning  FailedScheduling  49s (x5 over 63s)  default-scheduler  0/3 nodes are available: 1 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn't tolerate, 2 node(s) had taint {node.kubernetes.io/not-ready: }, that the pod didn't tolerate.</span>
<span class="token comment">#   Normal   Scheduled         39s                default-scheduler  Successfully assigned default/nginx to node2</span>
<span class="token comment">#   Normal   Pulling           37s                kubelet            Pulling image "nginx"</span>
<span class="token comment">#   Normal   Pulled            26s                kubelet            Successfully pulled image "nginx" in 11.258745578s</span>
<span class="token comment">#   Normal   Created           25s                kubelet            Created container nginx</span>
<span class="token comment">#   Normal   Started           25s                kubelet            Started container nginx</span>

kubectl get pods <span class="token parameter variable">-o</span> wide
<span class="token comment"># NAME    READY   STATUS    RESTARTS   AGE    IP         NODE    NOMINATED NODE   READINESS GATES</span>
<span class="token comment"># nginx   1/1     Running   0          103s   10.5.1.2   node2   &lt;none&gt;           &lt;none&gt;</span>
</code></pre> 
<p>kubectl get pods命令可以帮助我们查看集群中的pod列表</p> 
<h3><a id="YAML_84"></a>YAML描述对象</h3> 
<p>Kubernetes不推荐使用命令行的方式直接运行容器（kubectl run），而是用 YAML 文件的方式：<code>kubectl create -f file.yml</code></p> 
<p>kubernetes使用yaml文件来描述API对象，<code>kubectl run nginx --image=nginx</code>等价于<br> <code>vim myapp-pod.yml</code></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp
    <span class="token key atrule">type</span><span class="token punctuation">:</span> myservice
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
</code></pre> 
<p>之前在docker章节，我们已经见过用yaml声明对象的方式。在这个yaml文件中，它要求kubernetes创建一个Pod，使用nginx镜像，开放端口80。</p> 
<p>Kubernetes使用YAML文件作为创建对象的输入，如Pod、Replica、Deployment、Service等等。所有这些都遵循类似的结构。Kubernetes定义文件总是包含四个顶级字段：API版本、种类、元数据和规格spec。这些也是必须的字段.</p> 
<ul><li>apiVersion：API版本号。根据创建的内容，必须使用正确的API版本。V1, app/V1beta，extensions/V1beta，等等</li><li>kind：资源类型，类型指的是创建的对象的类型，其他可能的值 Pod, Service, ReplicaSet, Deployment…</li><li>metadata:元数据，用来标记对象,比如它的名字、标签等等。不同于前两项，metadata采用字典格式,所以元数据下的所有东西都向右移一点，名字和标签是元数据的子节点。 
  <ul><li>名字和标签这两个属性前面的空格数并不重要，但它们应该是一样的，因为它们是同级别的。</li><li>标签是元数据字典中的一个字典，它可以存储任何键值对。 
    <ul><li>例如，有数百个运行前端应用程序的pod和数百个运行后端应用程序或数据库的pod。一旦这些pod被部署，你将很难对它们进行分组。如果你现在把它们标记为前端、后端或数据库，以后根据这个标签来过滤这些pod。</li></ul> </li></ul> </li><li>spec: 同样使用字典。其中container是一个数组，因为pod中可以有多个容器，名字前面的破折号表示这是列表中的第一个项目。 
  <ul><li>列表中的每一个元素又是一个字典，所以要添加一个名称和image属性。image的值是nginx，这是docker仓库中的docker镜像。</li></ul> </li></ul> 
<p>我们可以使用<code>kubectl apply</code>来创建对象</p> 
<pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> myapp-pod.yml
<span class="token comment"># pod/myapp-pod created</span>

kubectl get pods
<span class="token comment"># NAME        READY   STATUS    RESTARTS   AGE</span>
<span class="token comment"># myapp-pod   1/1     Running   0          29s</span>

<span class="token comment"># kubectl describe pod myapp-pod</span>

<span class="token comment"># kubectl delete -f myapp-pod.yml</span>
</code></pre> 
<p>kubectl get从Kubernetes里面获取指定的 API 对象。</p> 
<h3><a id="ReplicationController__ReplicaSet_133"></a>ReplicationController &amp; ReplicaSet</h3> 
<p>Pod可以通过控制器来管理。控制器是Kubernetes的大脑,它们监测Kubernetes对象并作出相应反应。</p> 
<p>ReplicationController 确保在任何时候都有特定数量的 Pod 副本处于运行状态:<br> 场景:有一个单一的pod运行应用程序。如果由于某种原因，应用程序崩溃了，pod失败了怎么办？</p> 
<ul><li>用户将不再能够访问应用程序。为了防止用户失去对应用程序的访问，需要有一个以上的实例或pod同时运行。如果一个失败了，仍然有应用程序在另一个上运行。<br> ReplicationController在Kubernetes集群中运行一个pod的多个实例，从而提供高可用性。<br> 即使只有一个pod，当现有的pod发生故障时，ReplicationController也可以通过自动调出一个新的pod来。因此，Replication Controller确保指定数量的pod在任何时候都在运行，即使只有一个或100个。</li></ul> 
<p>需要Replication Controller的另一个原因是创建多个pod来分担它们的负载。例如，在这个简单的场景中，有一个单一的pod为一组用户服务。当用户数量增加时，部署额外的pod来平衡两部分的负载。如果需求进一步增加，如果在第一个节点上耗尽资源，可以在集群的其他节点上部署额外的部分。</p> 
<p>Replication Controller是旧的技术，正在被Replica Set取代。Replica Set是新推荐的设置副本的方式。</p> 
<p>创建一个Replication Controller的定义文件。我们将其命名为myapp-rc.yml：有四个部分：API版本、种类、元数据和规格。</p> 
<ul><li>API版本V1支持Replication Controller，所以我们将其设置为V1。</li><li>Kind就是Replication Controller。</li><li>在元数据下，我们将添加一个名称，我们将称之为myapp-rc， 
  <ul><li>添加标签，应用程序和类型，并为它们赋值。到目前为止，这与我们在上一节中创建一个pod的方式非常相似。接下来是</li></ul> </li><li>定义Spec: 我们需要在Spec下创建一个template部分，提供一个pod template，由Replication Controller用来创建副本。 
  <ul><li>定义pod template</li><li>在Spec中添加另一个名为replicas的属性，输入需要的复制数量。template和replicas是Spec部分的直接子项，必须在同一缩进上</li></ul> </li></ul> 
<p><code>vim myapp-rc.yml</code></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicationController
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>rc
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp
    <span class="token key atrule">type</span><span class="token punctuation">:</span> myservice
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod
      <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
        <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
</code></pre> 
<p>从nginx-pod.yml复制spec中的内容到template，然后设置replicas为3</p> 
<pre><code class="prism language-bash">kubectl create <span class="token parameter variable">-f</span> myapp-rc.yml 
<span class="token comment"># replicationcontroller/myapp-rc created</span>

<span class="token comment"># kubectl get replicationcontroller</span>
kubectl get rc
<span class="token comment"># NAME       DESIRED   CURRENT   READY   AGE</span>
<span class="token comment"># myapp-rc   3         3         3       20s</span>

kubectl get pods
<span class="token comment"># NAME             READY   STATUS    RESTARTS   AGE</span>
<span class="token comment"># myapp-rc-ngbhp   1/1     Running   0          44s</span>
<span class="token comment"># myapp-rc-qskjr   1/1     Running   0          44s</span>
<span class="token comment"># myapp-rc-tk8lx   1/1     Running   0          44s</span>
</code></pre> 
<p>Replica Set与Replication Controller非常相似。ReplicaSet则相当于ReplicationController的升级版，它的作用也是控制pod的数量始终维持在预设的个数。</p> 
<ul><li>首先API版本、Kind、Metadata和Spec。不过API版本有点不同，是app/V1，这与Replication Controller不同，后者只是V1。如果弄错了，控制台报错没有匹配的Replica Set，因为指定的Kubernetes API版本不支持Replica Set。</li><li>spec 与Replication Controller非常相似，有一个template部分。Replication Controller和Replica Set之间有一个主要区别，Replica Set需要一个选择器定义。选择器部分帮助Replica Set识别哪些pod属于它。 
  <ul><li>这是因为 Replica Set 也可以管理那些没有作为 Replica Set 创建的一部分而创建的 pod。 
    <ul><li>比如说，在创建Replica Set之前，有一些pod是与选择器中指定的标签相匹配的，Replica Set在创建副本时也会考虑到这些pod。</li><li>在Replication Controller中，选择器不是一个必须的字段，但它仍然是可用的。不显示定义时，它假定它与pod定义文件中提供的标签相同。</li><li>在Replica Set中，这个属性需要用户输入，它必须以matchLabel的形式写入。选择器将指定的标签与Pod上的标签相匹配。</li></ul> </li></ul> </li></ul> 
<p><code>vim myapp-rs.yml</code></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>rs
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp
    <span class="token key atrule">type</span><span class="token punctuation">:</span> myservice
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod
      <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
        <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp
        <span class="token key atrule">type</span><span class="token punctuation">:</span> myservice
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> 
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> myservice
</code></pre> 
<ul><li><code>apiVersion</code>需要设置为<code>apps/v1</code>，否则会无法识别ReplicaSet</li><li><code>selector</code>可以用来匹配已有对象的label标签</li><li>labels是一组 key-value 格式的标签。</li><li>selector.matchLabels字段，一般称之为Label Selector。</li></ul> 
<pre><code class="prism language-bash">kubectl create <span class="token parameter variable">-f</span> myapp-rs.yml 
<span class="token comment"># replicaset.apps/myapp-rc created</span>

kubectl get replicaset
<span class="token comment"># NAME       DESIRED   CURRENT   READY   AGE</span>
<span class="token comment"># myapp-rc   3         3         3       23s</span>

kubectl get pods
<span class="token comment"># NAME             READY   STATUS    RESTARTS   AGE</span>
<span class="token comment"># myapp-rc-j29gh   1/1     Running   0          34s</span>
<span class="token comment"># myapp-rc-pf9sx   1/1     Running   0          34s</span>
<span class="token comment"># myapp-rc-vlgl7   1/1     Running   0          34s</span>

kubectl delete pod myapp-rc-j29gh 

kubectl get pods

kubectl describe replicaset myapp-rs
</code></pre> 
<p>kubectl describe命令，查看一个 API 对象的细节。所有重要操作，会被记录在Events里，并且显示在 kubectl describe 指令返回的结果中。</p> 
<h4><a id="_255"></a>扩容</h4> 
<p>从myapp-pod新建一个pod，会发现因为存在replicaset，新建的pod被自动终止了</p> 
<pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> myapp-pod.yml

kubectl get pods

kubectl describe replicaset myapp-rs
</code></pre> 
<p>kubectl apply命令进行Kubernetes对象的创建和更新操作。Kubernetes会根据 YAML文件的内容变化，自动进行具体的处理。</p> 
<p>尝试将replicaset的副本扩容成6个</p> 
<pre><code class="prism language-bash">kubectl scale replicaset myapp-rs <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">6</span>
</code></pre> 
<h3><a id="Deployment_273"></a>Deployment</h3> 
<p>官方推荐不要直接使用ReplicaSet，用Deployments。Deployment可以通过selector来匹配labels字段，过滤出它所关心的被控制对象。</p> 
<p>Deployment不直接管理Pod对象，而是由Deployment管理ReplicaSet，再由ReplicaSet负责管理Pod对象。</p> 
<p><img src="https://images2.imgbox.com/6f/ba/QyUIEJ07_o.png" alt="外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传"></p> 
<p>Deployment是一个Kubernetes对象，在层次结构中更高。<br> Deployment为我们提供了使用滚动更新无缝升级底层实例的能力，e.g.撤销变化，暂停，并根据需要恢复变化。</p> 
<p>创建一个Deployment定义文件。Deployment定义文件的内容与ReplicaSet定义文件完全相似。(在这里ReplicaSet和Deployment之间还没有太大的区别，除了Deployment创建了一个新的Kubernetes对象，叫做deployment)</p> 
<pre><code class="prism language-bash">kubectl create deployment my-nginx <span class="token parameter variable">--image</span> nginx
<span class="token comment"># deployment.apps/my-nginx created</span>

kubectl get all
</code></pre> 
<p><code>vim myapp-deploy.yml</code></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>deployment
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp
    <span class="token key atrule">type</span><span class="token punctuation">:</span> myservice
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> 
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> myservice
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod
      <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
        <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp
        <span class="token key atrule">type</span><span class="token punctuation">:</span> myservice
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
</code></pre> 
<p>创建deployment</p> 
<pre><code class="prism language-bash">kubectl create <span class="token parameter variable">-f</span> myapp-deploy.yml

kubectl get deployments

kubectl get replicaset

kubectl get pods
</code></pre> 
<h4><a id="___330"></a>版本升级 &amp; 回滚</h4> 
<p>升级策略</p> 
<ul><li>recreate 一次性升级</li><li>rolling update 滚动升级<br> <img src="https://images2.imgbox.com/d5/f8/S1zvAWR9_o.png" alt="外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传"></li></ul> 
<pre><code class="prism language-bash"><span class="token comment"># kubectl create -f myapp-deploy.yml</span>

kubectl delete deployment myapp-deployment

kubectl create <span class="token parameter variable">-f</span> myapp-deploy.yml <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
kubectl rollout status deployment/myapp-deployment
<span class="token comment"># deployment.apps/myapp-deployment created</span>
<span class="token comment"># Waiting for deployment "myapp-deployment" rollout to finish: 0 of 3 updated replicas are available...</span>
<span class="token comment"># Waiting for deployment "myapp-deployment" rollout to finish: 1 of 3 updated replicas are available...</span>
<span class="token comment"># Waiting for deployment "myapp-deployment" rollout to finish: 2 of 3 updated replicas are available...</span>
<span class="token comment"># deployment "myapp-deployment" successfully rolled out</span>

kubectl rollout <span class="token function">history</span> deployment/myapp-deployment
<span class="token comment"># deployment.apps/myapp-deployment </span>
<span class="token comment"># REVISION  CHANGE-CAUSE</span>
<span class="token comment"># 1         &lt;none&gt;</span>
</code></pre> 
<p>可以看见所有的pod被挨个启动，change cause为空。我们重新执行这次部署</p> 
<pre><code class="prism language-bash">kubectl delete deployment myapp-deployment

kubectl get pods

kubectl create <span class="token parameter variable">-f</span> myapp-deploy.yml <span class="token parameter variable">--record</span> 

kubectl rollout status deployment/myapp-deployment

kubectl describe deployment myapp-deployment
<span class="token comment"># 在annotation中出现</span>

kubectl edit deployment myapp-deployment <span class="token parameter variable">--record</span>
<span class="token comment"># 修改使用nginx：alpine</span>

kubectl rollout status deployment/myapp-deployment
<span class="token comment"># Waiting for deployment "myapp-deployment" rollout to finish: 1 out of 3 new replicas have been updated...</span>
<span class="token comment"># Waiting for deployment "myapp-deployment" rollout to finish: 1 out of 3 new replicas have been updated...</span>
<span class="token comment"># Waiting for deployment "myapp-deployment" rollout to finish: 1 out of 3 new replicas have been updated...</span>
<span class="token comment"># Waiting for deployment "myapp-deployment" rollout to finish: 2 out of 3 new replicas have been updated...</span>
<span class="token comment"># Waiting for deployment "myapp-deployment" rollout to finish: 2 out of 3 new replicas have been updated...</span>
<span class="token comment"># Waiting for deployment "myapp-deployment" rollout to finish: 2 out of 3 new replicas have been updated...</span>
<span class="token comment"># Waiting for deployment "myapp-deployment" rollout to finish: 1 old replicas are pending termination...</span>
<span class="token comment"># Waiting for deployment "myapp-deployment" rollout to finish: 1 old replicas are pending termination...</span>

kubectl describe deployment myapp-deployment
<span class="token comment"># 注意annotation 和 events</span>

kubectl <span class="token builtin class-name">set</span> image deployment myapp-deployment <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:perl <span class="token parameter variable">--record</span>

kubectl rollout status deployment/myapp-deployment

kubectl rollout <span class="token function">history</span> deployment/myapp-deployment

kubectl describe deployment myapp-deployment <span class="token operator">|</span> <span class="token function">grep</span> nginx

kubectl rollout undo deployment/myapp-deployment

kubectl <span class="token builtin class-name">set</span> image deployment myapp-deployment <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:3 <span class="token parameter variable">--record</span>

kubectl rollout status deployment/myapp-deployment


kubectl get deployment myapp-deployment
<span class="token comment"># NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span class="token comment"># myapp-deployment   3/3     1            3           18m</span>

kubectl get pods
<span class="token comment"># NAME                                READY   STATUS             RESTARTS   AGE</span>
<span class="token comment"># myapp-deployment-56b894845f-7pm9v   1/1     Running            0          4m25s</span>
<span class="token comment"># myapp-deployment-56b894845f-rs699   1/1     Running            0          4m18s</span>
<span class="token comment"># myapp-deployment-56b894845f-svjs5   1/1     Running            0          4m22s</span>
<span class="token comment"># myapp-deployment-67c8cfbf79-p4j6j   0/1     ImagePullBackOff   0          77s</span>

kubectl rollout undo deployment/myapp-deployment

kubectl get pods
</code></pre> 
<p><code>vim myapp-deploy.yml</code></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>deployment
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp
    <span class="token key atrule">type</span><span class="token punctuation">:</span> myservice
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> 
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> myservice
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod
      <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
        <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp
        <span class="token key atrule">type</span><span class="token punctuation">:</span> myservice
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
</code></pre> 
<h3><a id="api___443"></a>api资源 &amp; 缩写形式</h3> 
<pre><code class="prism language-bash">kubectl api-resources
<span class="token comment"># NAME                              SHORTNAMES   APIVERSION                             NAMESPACED   KIND</span>
<span class="token comment"># bindings                                       v1                                     true         Binding</span>
<span class="token comment"># componentstatuses                 cs           v1                                     false        ComponentStatus</span>
<span class="token comment"># configmaps                        cm           v1                                     true         ConfigMap</span>
<span class="token comment"># endpoints                         ep           v1                                     true         Endpoints</span>
<span class="token comment"># events                            ev           v1                                     true         Event</span>
<span class="token comment"># limitranges                       limits       v1                                     true         LimitRange</span>
<span class="token comment"># namespaces                        ns           v1                                     false        Namespace</span>
<span class="token comment"># nodes                             no           v1                                     false        Node</span>
<span class="token comment"># persistentvolumeclaims            pvc          v1                                     true         PersistentVolumeClaim</span>
<span class="token comment"># persistentvolumes                 pv           v1                                     false        PersistentVolume</span>
<span class="token comment"># pods                              po           v1                                     true         Pod</span>
<span class="token comment"># podtemplates                                   v1                                     true         PodTemplate</span>
<span class="token comment"># replicationcontrollers            rc           v1                                     true         ReplicationController</span>
<span class="token comment"># resourcequotas                    quota        v1                                     true         ResourceQuota</span>
<span class="token comment"># secrets                                        v1                                     true         Secret</span>
<span class="token comment"># serviceaccounts                   sa           v1                                     true         ServiceAccount</span>
<span class="token comment"># services                          svc          v1                                     true         Service</span>
<span class="token comment"># mutatingwebhookconfigurations                  admissionregistration.k8s.io/v1        false        MutatingWebhookConfiguration</span>
<span class="token comment"># validatingwebhookconfigurations                admissionregistration.k8s.io/v1        false        ValidatingWebhookConfiguration</span>
<span class="token comment"># customresourcedefinitions         crd,crds     apiextensions.k8s.io/v1                false        CustomResourceDefinition</span>
<span class="token comment"># apiservices                                    apiregistration.k8s.io/v1              false        APIService</span>
<span class="token comment"># controllerrevisions                            apps/v1                                true         ControllerRevision</span>
<span class="token comment"># daemonsets                        ds           apps/v1                                true         DaemonSet</span>
<span class="token comment"># deployments                       deploy       apps/v1                                true         Deployment</span>
<span class="token comment"># replicasets                       rs           apps/v1                                true         ReplicaSet</span>
<span class="token comment"># statefulsets                      sts          apps/v1                                true         StatefulSet</span>
<span class="token comment"># tokenreviews                                   authentication.k8s.io/v1               false        TokenReview</span>
<span class="token comment"># localsubjectaccessreviews                      authorization.k8s.io/v1                true         LocalSubjectAccessReview</span>
<span class="token comment"># selfsubjectaccessreviews                       authorization.k8s.io/v1                false        SelfSubjectAccessReview</span>
<span class="token comment"># selfsubjectrulesreviews                        authorization.k8s.io/v1                false        SelfSubjectRulesReview</span>
<span class="token comment"># subjectaccessreviews                           authorization.k8s.io/v1                false        SubjectAccessReview</span>
<span class="token comment"># horizontalpodautoscalers          hpa          autoscaling/v1                         true         HorizontalPodAutoscaler</span>
<span class="token comment"># cronjobs                          cj           batch/v1beta1                          true         CronJob</span>
<span class="token comment"># jobs                                           batch/v1                               true         Job</span>
<span class="token comment"># certificatesigningrequests        csr          certificates.k8s.io/v1                 false        CertificateSigningRequest</span>
<span class="token comment"># leases                                         coordination.k8s.io/v1                 true         Lease</span>
<span class="token comment"># endpointslices                                 discovery.k8s.io/v1beta1               true         EndpointSlice</span>
<span class="token comment"># events                            ev           events.k8s.io/v1                       true         Event</span>
<span class="token comment"># ingresses                         ing          extensions/v1beta1                     true         Ingress</span>
<span class="token comment"># flowschemas                                    flowcontrol.apiserver.k8s.io/v1beta1   false        FlowSchema</span>
<span class="token comment"># prioritylevelconfigurations                    flowcontrol.apiserver.k8s.io/v1beta1   false        PriorityLevelConfiguration</span>
<span class="token comment"># ingressclasses                                 networking.k8s.io/v1                   false        IngressClass</span>
<span class="token comment"># ingresses                         ing          networking.k8s.io/v1                   true         Ingress</span>
<span class="token comment"># networkpolicies                   netpol       networking.k8s.io/v1                   true         NetworkPolicy</span>
<span class="token comment"># runtimeclasses                                 node.k8s.io/v1                         false        RuntimeClass</span>
<span class="token comment"># poddisruptionbudgets              pdb          policy/v1beta1                         true         PodDisruptionBudget</span>
<span class="token comment"># podsecuritypolicies               psp          policy/v1beta1                         false        PodSecurityPolicy</span>
<span class="token comment"># clusterrolebindings                            rbac.authorization.k8s.io/v1           false        ClusterRoleBinding</span>
<span class="token comment"># clusterroles                                   rbac.authorization.k8s.io/v1           false        ClusterRole</span>
<span class="token comment"># rolebindings                                   rbac.authorization.k8s.io/v1           true         RoleBinding</span>
<span class="token comment"># roles                                          rbac.authorization.k8s.io/v1           true         Role</span>
<span class="token comment"># priorityclasses                   pc           scheduling.k8s.io/v1                   false        PriorityClass</span>
<span class="token comment"># csidrivers                                     storage.k8s.io/v1                      false        CSIDriver</span>
<span class="token comment"># csinodes                                       storage.k8s.io/v1                      false        CSINode</span>
<span class="token comment"># storageclasses                    sc           storage.k8s.io/v1                      false        StorageClass</span>
<span class="token comment"># volumeattachments                              storage.k8s.io/v1                      false        VolumeAttachment</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a16562628c2e5304d17f45402e4e2de6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">1.搭建Kubernetes环境</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/af2aa6f061d0d0661c6f04c42b6c9d8e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【开源】SpringBoot框架开发服装店库存管理系统</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>