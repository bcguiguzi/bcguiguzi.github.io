<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring Cloud Alibaba一一SentinelResource - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Spring Cloud Alibaba一一SentinelResource" />
<meta property="og:description" content="SentinelResource 在定义了资源点之后，我们可以通过Dashboard控制台页面来设置限流和降级策略来对资源点进行保护。同时还能通过[**@SentinelResource**](/SentinelResource)****注解来制定出现异常时的处理策略
1、属性说明
value 资源名称、必须项、因为需要通过resource name找到对应的规则，这个是必须配置的。
blockHandler blockHandler对应处理BlockException的函数名称，可选项。blockHandler函数访问范围需要是public，返回的类型需要与原方法相匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为BlockException。
fallback fallback函数名称，可选项，用于在抛出异常的时候提供fallback处理逻辑。fallBack函数可以针对所有类型的异常（Throwable）
blockHandlerClass blockHandler函数默认需要和原生方法在同一个类中，如果希望使用其他类的函数，则需要指定blockhandlerClass为对应的类的Class对象，注意对应的函数必须为static函数，否则无法解析。
fallbackClass fallBackClass的应用和blockHandlerClass类似，fallback函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定fallbackClass为对应的类的Class对象，注意对应的函数必须为static函数，否则无法解析。
2、自定义处理限流和业务异常
@GetMapping(&#34;/hello4&#34;) @SentinelResource(value =&#34;hel1o4&#34;,blockHandler =&#34;blockHandler&#34;,fallback =&#34;fallbackHandler&#34;) public string hello4(Integer age){ int i = 10 / age; return &#34;hello4&#34;; } // hel13Handler方法的参数和返回值要和原方法一直，BlockException用来接收原方法的异常 public string blockHandler(Integer age,BlockException e){ return&#34;资源被限流”; } //hel13Handler方法的参数和返回值要和原方法一直，Throwable用来接收原方法的异常(这里必须是Throwable用来接收原方法的异常，不能是exception) public string fallbackHandler(Integer age,Throwable e) { return&#34;资源出现异常&#34;; } 以上这种方式可以处理资源中的限流和业务异常了，但是发现异常处理类和业务代码耦合了，而且还没办法复用。
3、处理异常类和业务类解耦
@RestController @slf4j public class HelloController f @GetMapping(&#34;/hel1o4&#34;) @SentinelResource(value = &#34;hello4&#34;, blockHandlerClass = MyBlockHandlerClass.class, blockHandler =&#34;blockHandler&#34;, fallbackClass = FallbackHandler." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/d6f919bb69b2666d8333b0abde03381c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-05T13:25:14+08:00" />
<meta property="article:modified_time" content="2024-03-05T13:25:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring Cloud Alibaba一一SentinelResource</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>SentinelResource</h3> 
<p>    在定义了资源点之后，我们可以通过Dashboard控制台页面来设置限流和降级策略来对资源点进行保护。同时还能通过[**@SentinelResource**](/SentinelResource)****注解来制定出现异常时的处理策略</p> 
<p>1、属性说明</p> 
<ul><li>value</li></ul> 
<p>         资源名称、必须项、因为需要通过resource name找到对应的规则，这个是必须配置的。</p> 
<ul><li>blockHandler</li></ul> 
<p>         blockHandler对应处理BlockException的函数名称，可选项。blockHandler函数访问范围需要是public，返回的类型需要与原方法相匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为BlockException。</p> 
<ul><li>fallback</li></ul> 
<p>         fallback函数名称，可选项，用于在抛出异常的时候提供fallback处理逻辑。fallBack函数可以针对所有类型的异常（Throwable）</p> 
<ul><li>blockHandlerClass</li></ul> 
<p>         blockHandler函数默认需要和原生方法在同一个类中，如果希望使用其他类的函数，则需要指定blockhandlerClass为对应的类的Class对象，注意对应的函数必须为static函数，否则无法解析。</p> 
<ul><li>fallbackClass</li></ul> 
<p>         fallBackClass的应用和blockHandlerClass类似，fallback函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定fallbackClass为对应的类的Class对象，注意对应的函数必须为static函数，否则无法解析。</p> 
<p>2、自定义处理限流和业务异常</p> 
<pre><code>@GetMapping("/hello4")
@SentinelResource(value ="hel1o4",blockHandler ="blockHandler",fallback ="fallbackHandler")
public string hello4(Integer age){
     int i = 10 / age;
     return "hello4";
}
// hel13Handler方法的参数和返回值要和原方法一直，BlockException用来接收原方法的异常
public string blockHandler(Integer age,BlockException e){
      return"资源被限流”;
}
//hel13Handler方法的参数和返回值要和原方法一直，Throwable用来接收原方法的异常(这里必须是Throwable用来接收原方法的异常，不能是exception)
public string fallbackHandler(Integer age,Throwable e) {
    return"资源出现异常";
}</code></pre> 
<p>     以上这种方式可以处理资源中的限流和业务异常了，但是发现异常处理类和业务代码耦合了，而且还没办法复用。</p> 
<p>3、处理异常类和业务类解耦</p> 
<pre><code>@RestController
@slf4j
public class HelloController f
     @GetMapping("/hel1o4")
     @SentinelResource(value = "hello4",
                                     blockHandlerClass = MyBlockHandlerClass.class,
                                     blockHandler ="blockHandler",
                                     fallbackClass = FallbackHandler.class,
                                     fallback ="fallbackHandler")
     public string hello4(Integer age) {
            int i = 18 / age;
            return "hel1o4";
     }
}
public class FallbackHandler {
              // 这里的方法必须是静态的,方法参数和返回值要和原方法一致
              public static string fallbackHandler(Integer age,Throwable e) {
                    return"资源出现异常"
              }
}
public class MyBlockHandlerClass f
         // 这里的方法必须是静态的，方法参数和返回值要和原方法一致
         public static string blockHandler(Integer age,BlockException e) {
              System.out.println("bolockHanlder age ="+ age +",e="+e);
              return"资源被限流”;
          }
}</code></pre> 
<h3>Feign整合Sentinel实现降级</h3> 
<p>    Feign整合Sentinel后不同异常调用不同的处理器来解决异常。</p> 
<p>    流控异常调用：blockHandler</p> 
<p>   服务运行时异常调用：fallback</p> 
<p>   feign调用异常调用：feign降级</p> 
<p>1、导入依赖</p> 
<pre><code>&lt;dependency&gt;
     &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
     &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactIdx
&lt;/dependency&gt;
&lt;dependency&gt;
      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre> 
<p>2、FeignFallbackFactory</p> 
<pre><code>@Component
public class FeignFallbackFactory implements FallbackFactory&lt;HelloService&gt;(
       @Autowired
        private HelloServiceImpl helloService;
        @Override
        public HelloService create(Throwable throwable) {
             System.out.println(throwable);
             return helloService;
        }
}</code></pre> 
<p>3、Feign接口</p> 
<pre><code>@FeignClient(value = "provider-1",fallbackFactory = FeignFallbackFactory.class)
public interface HelloService {
     @RequestMapping("/hello")
     public string hello();
}</code></pre> 
<p>4、开启sentinel</p> 
<pre><code>feign:
   sentinel:
     enabled: true</code></pre> 
<p>5、版本问题</p> 
<p>SpringCloud版本和SpringCloudAlibaba版本冲突的问题。</p> 
<pre><code>Caused by:at feien.FeignsBuilder.com.alibaba.cloud.sentinel.feign,sentinelcontractHolder.parseAndvalidateMetadajava .lang.AbstractMethoderror:lane/class;)Liava/util/list:
at feignReflectiveFeigsParseHandlersByllame,apply(Reflectivefeign.java:151) feign-(ore-10.7,4,jar:na
at feign,ReflectiveFein,newinstance(ReflectiveFeign.java:49) [feign-core-10.7.4jar:na)
target(feien.ia
core-18.7.4.ar;na7
at or3.sorineframework.coudopenfeien.-strixtareter.tareetHystrixtmeter, ava:33)  sorine-cloud-enfee-ore-2.2.2,RELEASE,m2.2.2RELEASE
at r.trmewo.cou.ttr da ertat  -
at org.sprineframevwork,cIod.0pfeignFegclietactoryBen-gtTretFeclitFto Bean av282  gprn-coud-Efe-0re-2-22RELEASE.ar:2.2.2ELEASE
  am.Co.0 it B- tat 2----S22S
t org.pringframework.beans.atory, support.Fto Beamegistryuprt,0etbjectfrnFtr Ben (to Beamepistry supprtaa71)re-ns-52.4ELEASE5.2.4ELEASE
... 67 common frames omitted</code></pre> 
<p>解决方式</p> 
<p>自定义一个SentinelContractHolder类，包名和源码保持一致。</p> 
<pre><code>packagecom.alibaba.cloud.sentinel.feign;
import feign.Contract;
import feign.MethodMetadata;
import java.util.HashMap;import
import java.util.List;import
import java.util.Map;
public class SentinelContractHolder implements Contract {
          private final Contract delegate;
           /* map key is constructed by ClassFullName + configkey. configkey is constructed by
            * (@link feign.Feign#configKey}
            */
          public final static Map&lt;String, MethodMetadata&gt; METADATA MAP = new HashMap&lt;&gt;();
          public SentinelContractHolder(Contract delegate) {
                this.delegate = delegate!
          }
         @Override
          public List&lt;MethodMetadata&gt; parseAndValidateMetadata(Class&lt;?&gt; targetType) {
                     List&lt;MethodMetadata&gt; metadatas = delegate.parseAndValidateMetadata(targetType);
                     metadatas.forEach(metadata -&gt; METADATA MAP.put(targetType.getName() + metadata.configkey(), metadata));
                     return metadatas;
          }
}</code></pre> 
<p></p> 
<p class="img-center"><img alt="" height="355" src="https://images2.imgbox.com/bf/c0/br2P681K_o.png" width="974"></p> 
<p>        Feign调用服务过程中，服务出现故障，如果服务中存在全局异常管理器，会认为这个故障已经被服务处理了，然后返回一个空的对象，feign不会调用自己的降级方法。</p> 
<h3>       sentinel持久化</h3> 
<p> 1、sentinel工作模式</p> 
<p></p> 
<p class="img-center"><img alt="" height="591" src="https://images2.imgbox.com/6a/3e/oErzZKH8_o.png" width="1003"></p> 
<p>    在Sentinel客户端（微服务）中用代码写的配置，在启动后，当有第一次流量进来的时候，会推送给Sentinel-Dashboard；在Sentinel-Dashboard中的配置，会被推送到Sentinel客户端（微服务）；默认情况下，不论 Sentinel-Dashboard中的配置还是Sentinel客户端中的配置，都是在内存中的，一点重启，这些变化过的规则就全部消失了。</p> 
<p>2、semtinel持久化</p> 
<p></p> 
<p class="img-center"><img alt="" height="573" src="https://images2.imgbox.com/81/d6/1nFS3ioh_o.png" width="982"></p> 
<p>在此将规则持久化到nacos中，在nacos中添加规则，然后同步到dashboard中。</p> 
<p>1、导入依赖</p> 
<pre><code>&lt;dependency&gt;
&lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;
&lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre> 
<p>2、在yml中配置nacos信息</p> 
<pre><code>spring:
  application:
    name: sentinel-server
  cloud:
    nacos:
      discovery:
         server-addr: 192.168.147.11.8848
    sentinel:
       transport:
          dashboard: 192.168.147.11:8080
          port: 8719
       eager: true
       datasource:
          sentinel1:
             nacos:
                serverAddr: 192.168.147.11:8848
                dataId: ${spring.application.name}
                groupId: DEFAULT_GROUP
                data-type: json
                rule-type: flow</code></pre> 
<p>3、在nacos中添加规则</p> 
<pre><code>[
     {
         "resource":"he11o4",
         "limitApp":"default",
         "grade": 1,
         "count": 5,
         "strategy": 0,
         "controlBehavior":0,
         'clusterMode": false
     }
]</code></pre> 
<ul><li>resource: 资源名称</li><li>limitApp: 来源应用</li><li>grade: 阈值类型， 0-线程数  1-qps</li><li>count: 单机阈值</li><li>strategy: 流控模式， 0-直接  1-关联  2-链路</li><li>controlBehavior：流控效果、0-快速失败，1-warm up，2-排队等待</li><li>clusterMode: 是否集群</li></ul> 
<p>4、测试</p> 
<p>服务启动后，当有第一次流量进来的时候，Sentinel-Dashboard会从nacos中拉取流控信息。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7a88f0c4786cfd4644e66ca2279a5dcd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring Cloud Alibaba一一熔断降级</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c4c0ebb1959f0577a9df86dc3e19ce76/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">c&#43;&#43;内存泄漏</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>