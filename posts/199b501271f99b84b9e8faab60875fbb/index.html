<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux第66步_linux字符设备驱动_挂载和卸载 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux第66步_linux字符设备驱动_挂载和卸载" />
<meta property="og:description" content="1、了解linux中的驱动类型:
1)、字符设备驱动
字符设备是limnux驱动中最基本的一类设备驱动，字符设备就是一个一个字节，按照字节流进行读写操作的设备，读写数据是分先后顺序的。如：GPIO输入输出、UART、I2C、SPI、USB、LCD、音频等都属于字符设备驱动。
2)、块设备驱动
块设备驱动就是存储器设备的驱动，比如EMMC、NAND、SD卡和U盘等存储设备，因为这些存储设备的特点是以存储块为基础,因此叫做“块设备”。
3)、网络设备驱动网络设备就是网络驱动，不管是有线的，还是无线的，都属于网络设备驱动的范畴。
注意：
一个设备可以属于多种设备驱动类型，比如：USB WIFI，其使用USB接口，所以属于字符设备，但是其又能上网，所以它又属于网络设备驱动。
2、了解Limux应用程序调用驱动程序的流程
在Linux中一切皆为文件。驱动加载成功以后会在“/dev”目录下生成一个相应的驱动文件，如“xxx”的驱动文件名。应用程序通过对“/dev/xxx”的文件进行相应的操作，就可实现对硬件的操作。比如：现在有个叫做“/dev/led ”的驱动文件，它是1ed灯的驱动文件。应用程序使用“open函数”打开驱动文件“/dev/led ”,然后使用“close函数”关闭驱动文件“/dev/led”。open和close 就是打开和关闭led驱动的函数，如果要点亮或关闭1ed，那么就使用write函数来操作，也就是向此驱动写入数据，这个数据就是要关闭还是要打开led的控制参数。如果要获取led灯的状态，就用read函数从驱动中读取相应的状态。应用程序运行在用户空间，而limux驱动属于内核的一部分，因此驱动运行于内核空间。当我们在用户空间想要实现对内核进行操作，比如使用open函数打开/dev/led这个驱动，因为用户空间不能直接对内核进行操作，因此必须使用一个叫做“系统调用”的方法来实现从用户空间“陷入”到内核空间，这样才能实现对底层驱动的操作。open、close、write和read等这些函数是由C库提供的，在Limux系统中，系统调用作为C库的一部分。
我们重点关注的时应用程序调用的函数和驱动调用的函数，至于C库和内核调用的函数，我们不用去关心。
3、了解“file_operations”结构体
打开虚拟机上“VSCode”，点击“文件”，点击“打开文件夹”，点击“zgq”，点击“linux”，点击“atk-mp1”，点击“linux”，点击“my_linux”，点击“linux-5.4.31”，见下图：
点击“确定”
点击“查看”，点击“搜索”，输入“struct file_operations”
随便点击其中一个“struct file_operations”，得到下面的界面：
在“file_operations”点击“鼠标右键”，点击“转到定义”，见下图：
得到下图：
字符设备驱动重点是“file_operations”结构体
“fs.h”定义“file_operations”结构体如下：
struct file_operations {
struct module *owner;
loff_t (*llseek) (struct file *, loff_t, int);
ssize_t (*read) (struct file *, char __user *, size_t, loff_t *);
ssize_t (*write) (struct file *, const char __user *, size_t, loff_t *);
ssize_t (*read_iter) (struct kiocb *, struct iov_iter *);" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/199b501271f99b84b9e8faab60875fbb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-27T08:27:31+08:00" />
<meta property="article:modified_time" content="2024-02-27T08:27:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux第66步_linux字符设备驱动_挂载和卸载</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:.0001pt;text-align:justify;">1、了解linux中的驱动类型:</p> 
<p style="margin-left:.0001pt;text-align:justify;">1)、字符设备驱动</p> 
<p style="margin-left:.0001pt;text-align:justify;">字符设备是limnux驱动中最基本的一类设备驱动，字符设备就是一个一个字节，按照字节流进行读写操作的设备，读写数据是分先后顺序的。如：GPIO输入输出、UART、I2C、SPI、USB、LCD、音频等都属于字符设备驱动。</p> 
<p style="margin-left:.0001pt;text-align:justify;">2)、块设备驱动</p> 
<p style="margin-left:.0001pt;text-align:justify;">块设备驱动就是存储器设备的驱动，比如EMMC、NAND、SD卡和U盘等存储设备，因为这些存储设备的特点是以存储块为基础,因此叫做“<span style="color:#ff0000;">块设备</span><span style="color:#000000;">”</span>。</p> 
<p style="margin-left:.0001pt;text-align:justify;">3)、网络设备驱动网络设备就是网络驱动，不管是有线的，还是无线的，都属于网络设备驱动的范畴。</p> 
<p style="margin-left:.0001pt;text-align:justify;">注意：</p> 
<p style="margin-left:.0001pt;text-align:justify;">一个设备可以属于多种设备驱动类型，比如：USB WIFI，其使用USB接口，所以属于字符设备，但是其又能上网，所以它又属于网络设备驱动。</p> 
<p style="margin-left:.0001pt;text-align:justify;">2、了解<span style="color:#00b050;">Limux应用程序</span>调用<span style="color:#0070c0;">驱动程序</span>的流程</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="537" src="https://images2.imgbox.com/49/02/E9OoogBw_o.png" width="830"></p> 
<p style="margin-left:.0001pt;text-align:justify;">在Linux中一切皆为文件。驱动加载成功以后会在“<span style="color:#ff0000;">/dev</span>”目录下生成一个相应的驱动文件，如“xxx”的驱动文件名。<span style="color:#00b050;">应用程序</span>通过对<span style="color:#ff0000;">“/dev/xxx”的文件</span>进行相应的操作，就可实现对硬件的操作。比如：现在有个叫做“<span style="color:#ff0000;">/dev/led </span>”的驱动文件，它是1ed灯的驱动文件。<span style="color:#00b050;">应用程序</span>使用“open函数”打开驱动文件“<span style="color:#ff0000;">/dev/led </span>”,然后使用“close函数”关闭驱动文件“<span style="color:#ff0000;">/dev/led”</span>。open和close 就是打开和关闭led驱动的函数，如果要点亮或关闭1ed，那么就使用write函数来操作，也就是向此驱动写入数据，这个数据就是要关闭还是要打开led的控制参数。如果要获取led灯的状态，就用read函数从驱动中读取相应的状态。<span style="color:#00b050;">应用程序</span>运行在用户空间，而limux驱动属于内核的一部分，因此驱动运行于内核空间。当我们在用户空间想要实现对内核进行操作，比如使用open函数打开/dev/led这个驱动，因为用户空间不能直接对内核进行操作，因此必须使用一个叫做“系统调用”的方法来实现从用户空间“陷入”到内核空间，这样才能实现对底层驱动的操作。open、close、write和read等这些函数是由C库提供的，在Limux系统中，系统调用作为C库的一部分。</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="241" src="https://images2.imgbox.com/5e/d2/XdsUFiIR_o.png" width="830"></p> 
<p style="margin-left:.0001pt;text-align:justify;">我们重点关注的时<span style="color:#00b050;">应用程序调用的函数</span>和<span style="color:#0070c0;">驱动调用的函数</span>，至于C库和内核调用的函数，我们不用去关心。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">3、了解“file_operations”结构体</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">打开虚拟机上</span><span style="color:#000000;">“</span><span style="color:#ff0000;">VSCode</span><span style="color:#000000;">”</span><span style="color:#000000;">，点击“</span><span style="color:#ff0000;">文件</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">打开文件夹</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">zgq</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">linux</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">atk-mp1</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">linux</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">my_linux</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">linux-5.4.31</span><span style="color:#000000;">”，见下图：</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="537" src="https://images2.imgbox.com/b6/e4/QuR6A7SN_o.png" width="873"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">点击“</span><span style="color:#ff0000;">确定</span><span style="color:#000000;">”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">点击“</span><span style="color:#ff0000;">查看</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">搜索</span><span style="color:#000000;">”，输入“</span><span style="color:#ff0000;">struct file_operations</span><span style="color:#000000;">”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="663" src="https://images2.imgbox.com/d2/67/FXiQAHwr_o.png" width="879"></p> 
<p style="margin-left:.0001pt;text-align:justify;">随便点击其中一个<span style="color:#000000;">“</span><span style="color:#ff0000;">struct file_operations</span><span style="color:#000000;">”，得到下面的界面：</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="464" src="https://images2.imgbox.com/5a/02/Zb70wNYV_o.png" width="1004"></p> 
<p style="margin-left:.0001pt;text-align:justify;">在“<span style="color:#ff0000;">file_operations</span>”点击“<span style="color:#ff0000;">鼠标右键</span>”，点击“<span style="color:#ff0000;">转到定义</span>”，见下图：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="873" src="https://images2.imgbox.com/d0/4f/teBS8128_o.png" width="991"></p> 
<p style="margin-left:.0001pt;text-align:justify;">得到下图：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="655" src="https://images2.imgbox.com/22/8a/ThVbk1dL_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;">字符设备驱动重点是“file_operations”结构体</p> 
<p style="margin-left:.0001pt;text-align:justify;">“fs.h”定义“file_operations”结构体如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">struct</span> file_operations {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">struct</span> module *owner;</p> 
<p style="margin-left:.0001pt;text-align:justify;">loff_t (*llseek) (<span style="color:#0000ff;">struct</span> file *, loff_t, int);</p> 
<p style="margin-left:.0001pt;text-align:justify;">ssize_t (*<span style="color:#ff0000;">read</span>) (<span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">char</span> __user *, size_t, loff_t *);</p> 
<p style="margin-left:.0001pt;text-align:justify;">ssize_t (*<span style="color:#ff0000;">write</span>) (<span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">const char</span> __user *, size_t, loff_t *);</p> 
<p style="margin-left:.0001pt;text-align:justify;">ssize_t (*read_iter) (<span style="color:#0000ff;">struct</span> kiocb *, <span style="color:#0000ff;">struct</span> iov_iter *);</p> 
<p style="margin-left:.0001pt;text-align:justify;">ssize_t (*write_iter) (<span style="color:#0000ff;">struct</span> kiocb *, <span style="color:#0000ff;">struct</span> iov_iter *);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> (*iopoll)(<span style="color:#0000ff;">struct</span> kiocb *kiocb, <span style="color:#0000ff;">bool</span> spin);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> (*iterate) (<span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">struct</span> dir_context *);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> (*iterate_shared) (<span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">struct</span> dir_context *);</p> 
<p style="margin-left:.0001pt;text-align:justify;">__poll_t (*poll) (<span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">struct</span> poll_table_struct *);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">long</span> (*unlocked_ioctl) (<span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">unsigned int</span>, <span style="color:#0000ff;">unsigned long</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">long</span> (*compat_ioctl) (<span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">unsigned int</span>, <span style="color:#0000ff;">unsigned long</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> (*mmap) (<span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">struct</span> vm_area_struct *);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">unsigned long</span> mmap_supported_flags;</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> (*<span style="color:#ff0000;">open</span>) (<span style="color:#0000ff;">struct</span> inode *, <span style="color:#0000ff;">struct</span> file *);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> (*flush) (<span style="color:#0000ff;">struct</span> file *, fl_owner_t id);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> (*<span style="color:#ff0000;">release</span>) (<span style="color:#0000ff;">struct</span> inode *, <span style="color:#0000ff;">struct</span> file *);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> (*fsync) (<span style="color:#0000ff;">struct</span> file *, loff_t, loff_t, <span style="color:#0000ff;">int</span> datasync);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> (*fasync) (<span style="color:#0000ff;">int</span>, <span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">int</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> (*lock) (<span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">int</span>, <span style="color:#0000ff;">struct</span> file_lock *);</p> 
<p style="margin-left:.0001pt;text-align:justify;">ssize_t (*sendpage) (<span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">struct</span> page *, <span style="color:#0000ff;">int</span>, size_t, loff_t *, <span style="color:#0000ff;">int</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">unsigned long</span> (*get_unmapped_area)(<span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">unsigned long</span>, <span style="color:#0000ff;">unsigned long</span>, <span style="color:#0000ff;">unsigned long</span>, <span style="color:#0000ff;">unsigned long</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> (*check_flags)(<span style="color:#0000ff;">int</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> (*flock) (<span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">int</span>, <span style="color:#0000ff;">struct</span> file_lock *);</p> 
<p style="margin-left:.0001pt;text-align:justify;">ssize_t (*splice_write)(<span style="color:#0000ff;">struct</span> pipe_inode_info *, <span style="color:#0000ff;">struct</span> file *, loff_t *, size_t, <span style="color:#0000ff;">unsigned int</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;">ssize_t (*splice_read)(<span style="color:#0000ff;">struct</span> file *, loff_t *, <span style="color:#0000ff;">struct</span> pipe_inode_info *, size_t, <span style="color:#0000ff;">unsigned int</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">int</span> (*setlease)(<span style="color:#0000ff;">struct</span> file *, <span style="color:#0000ff;">long</span>, <span style="color:#0000ff;">struct</span> file_lock **, <span style="color:#0000ff;">void</span> **);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">long</span> (*fallocate)(<span style="color:#0000ff;">struct</span> file *file, <span style="color:#0000ff;">int</span> mode, loff_t offset,</p> 
<p style="margin-left:.0001pt;text-align:justify;">  loff_t len);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">void</span> (*show_fdinfo)(<span style="color:#0000ff;">struct</span> seq_file *m, <span style="color:#0000ff;">struct</span> file *f);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">#ifndef</span> CONFIG_MMU</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">unsigned</span> (*mmap_capabilities)(<span style="color:#0070c0;">struct</span> file *);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">#endif</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">ssize_t (*copy_file_range)(<span style="color:#0070c0;">struct</span> file *, loff_t, <span style="color:#0070c0;">struct</span> file *,</p> 
<p style="margin-left:.0001pt;text-align:justify;">loff_t, size_t, <span style="color:#0070c0;">unsigned int</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;">loff_t (*remap_file_range)(<span style="color:#0070c0;">struct</span> file *file_in, loff_t pos_in,</p> 
<p style="margin-left:.0001pt;text-align:justify;">   <span style="color:#0070c0;">struct</span> file *file_out, loff_t pos_out,</p> 
<p style="margin-left:.0001pt;text-align:justify;">   loff_t len, <span style="color:#0070c0;">unsigned int</span> remap_flags);</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">int</span> (*fadvise)(<span style="color:#0070c0;">struct</span> file *, loff_t, loff_t, <span style="color:#0070c0;">int</span>);</p> 
<p style="margin-left:.0001pt;text-align:justify;">} __randomize_layout;</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/* 设备操作函数结构体</span> <span style="color:#00b050;">*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">static struct</span> file_operations chrdevbase_fops = {<!-- --></p> 
<p style="margin-left:.0001pt;text-align:justify;">    .owner = THIS_MODULE,  </p> 
<p style="margin-left:.0001pt;text-align:justify;">    .open = chrdevbase_open,</p> 
<p style="margin-left:.0001pt;text-align:justify;">    .read = chrdevbase_read,</p> 
<p style="margin-left:.0001pt;text-align:justify;">    .write = chrdevbase_write,</p> 
<p style="margin-left:.0001pt;text-align:justify;">    .release = chrdevbase_release,</p> 
<p style="margin-left:.0001pt;text-align:justify;">};</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">4、了解“<span style="color:#000000;">linux-5.4.31</span>”中的驱动</p> 
<p style="margin-left:.0001pt;text-align:justify;">下面我们通过<span style="color:#000000;">“crc-vpmsum_test.c”来学习linux驱动的编写:</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">1)、点击“</span><span style="color:#ff0000;">转到</span><span style="color:#000000;">”，点击“</span><span style="color:#ff0000;">转到文件</span><span style="color:#000000;">”，在输入框中输入“</span><span style="color:#ff0000;">crc-vpmsum_test.c</span><span style="color:#000000;">”，按“</span><span style="color:#ff0000;">回车键</span><span style="color:#000000;">”打开“</span><span style="color:#ff0000;">crc-vpmsum_test.c</span><span style="color:#000000;">”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">见下图：</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="231" src="https://images2.imgbox.com/c0/a3/7xHwQsoC_o.png" width="830"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">“</span><span style="color:#0070c0;">crc-vpmsum_test.c</span><span style="color:#000000;">”内容如下：</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">// SPDX-License-Identifier: GPL-2.0-only</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;"> * CRC vpmsum tester</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;"> * Copyright 2017 Daniel Axtens, IBM Corporation.</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;"> */</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">#include</span><span style="color:#000000;"> &lt;linux/crc-t10dif.h&gt;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">#include</span><span style="color:#000000;"> &lt;linux/crc32.h&gt;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">#include</span><span style="color:#000000;"> &lt;crypto/internal/hash.h&gt;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">#include</span><span style="color:#000000;"> &lt;</span><span style="color:#ff0000;">linux/init.h</span><span style="color:#000000;">&gt;       </span><span style="color:#00b050;">//必须要包含的头文件</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">#include</span><span style="color:#000000;"> &lt;</span><span style="color:#ff0000;">linux/module.h</span><span style="color:#000000;">&gt;     </span><span style="color:#00b050;">//必须要包含的头文件</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">#include</span><span style="color:#000000;"> &lt;</span><span style="color:#ff0000;">linux/string.h</span><span style="color:#000000;">&gt;     </span><span style="color:#00b050;">//下面要用到字符串，显然也要包含</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">#include</span><span style="color:#000000;"> &lt;</span><span style="color:#00b050;">linux/kernel.h</span><span style="color:#000000;">&gt;     </span><span style="color:#00b050;">//必须要包含的头文件</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">#include</span><span style="color:#000000;"> &lt;linux/cpufeature.h&gt;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">#include</span><span style="color:#000000;"> &lt;asm/switch_to.h&gt;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">static unsigned long</span><span style="color:#000000;"> iterations = 10000;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">#define</span><span style="color:#000000;"> MAX_CRC_LENGTH 65535</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*入口函数初始化*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">static int</span><span style="color:#000000;"> __init crc_test_init(</span><span style="color:#0070c0;">void</span><span style="color:#000000;">)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">{<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">u16 crc16 = 0, verify16 = 0;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">u32 crc32 = 0, verify32 = 0;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">__le32 verify32le = 0;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">unsigned char</span><span style="color:#000000;"> *data;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">unsigned long</span><span style="color:#000000;"> i;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">int</span><span style="color:#000000;"> ret;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">struct</span><span style="color:#000000;"> crypto_shash *crct10dif_tfm;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">struct</span><span style="color:#000000;"> crypto_shash *crc32c_tfm;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">if</span><span style="color:#000000;"> (!cpu_has_feature(CPU_FTR_ARCH_207S))</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">return</span><span style="color:#000000;"> -ENODEV;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">data = kmalloc(MAX_CRC_LENGTH, GFP_KERNEL);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">if</span><span style="color:#000000;"> (!data)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">return</span><span style="color:#000000;"> -ENOMEM;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">crct10dif_tfm = crypto_alloc_shash("</span><span style="color:#e36c09;">crct10dif</span><span style="color:#000000;">", 0, 0);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">if</span><span style="color:#000000;"> (IS_ERR(crct10dif_tfm)) {<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">pr_err("</span><span style="color:#e36c09;">Error allocating crc-t10dif\n</span><span style="color:#000000;">");</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">goto free_buf;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">crc32c_tfm = crypto_alloc_shash("</span><span style="color:#e36c09;">crc32c</span><span style="color:#000000;">", 0, 0);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">if</span><span style="color:#000000;"> (IS_ERR(crc32c_tfm)) {<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">pr_err("</span><span style="color:#e36c09;">Error allocating crc32c\n</span><span style="color:#000000;">");</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">goto</span><span style="color:#000000;"> free_16;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">do</span><span style="color:#000000;"> {<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">SHASH_DESC_ON_STACK(crct10dif_shash, crct10dif_tfm);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">SHASH_DESC_ON_STACK(crc32c_shash, crc32c_tfm);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">crct10dif_shash-&gt;tfm = crct10dif_tfm;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">ret = crypto_shash_init(crct10dif_shash);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">if</span><span style="color:#000000;"> (ret) {<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">pr_err("</span><span style="color:#e36c09;">Error initing crc-t10dif\n</span><span style="color:#000000;">");</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">goto</span><span style="color:#000000;"> free_32;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">crc32c_shash-&gt;tfm = crc32c_tfm;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">ret = crypto_shash_init(crc32c_shash);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">if</span><span style="color:#000000;"> (ret) {<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">pr_err("</span><span style="color:#e36c09;">Error initing crc32c\n</span><span style="color:#000000;">");</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">goto</span><span style="color:#000000;"> free_32;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">pr_info("</span><span style="color:#e36c09;">crc-vpmsum_test begins, %lu iterations\n</span><span style="color:#000000;">", iterations);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">for</span><span style="color:#000000;"> (i=0; i&lt;iterations; i++) {<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">size_t offset = prandom_u32_max(16);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">size_t len = prandom_u32_max(MAX_CRC_LENGTH);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">if</span><span style="color:#000000;"> (len &lt;= offset)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">continue;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">prandom_bytes(data, len);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">len -= offset;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">crypto_shash_update(crct10dif_shash, data+offset, len);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">crypto_shash_final(crct10dif_shash, (u8 *)(&amp;crc16));</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">verify16 = crc_t10dif_generic(verify16, data+offset, len);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">if</span><span style="color:#000000;"> (crc16 != verify16) {<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">pr_err("</span><span style="color:#e36c09;">FAILURE in CRC16: got 0x%04x expected 0x%04x (len %lu)\n</span><span style="color:#000000;">",</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">       crc16, verify16, len);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">break</span><span style="color:#000000;">;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">crypto_shash_update(crc32c_shash, data+offset, len);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">crypto_shash_final(crc32c_shash, (u8 *)(&amp;crc32));</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">verify32 = le32_to_cpu(verify32le);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">        verify32le = ~cpu_to_le32(__crc32c_le(~verify32, data+offset, len));</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">if</span><span style="color:#000000;"> (crc32 != (u32)verify32le) {<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">pr_err("</span><span style="color:#e36c09;">FAILURE in CRC32: got 0x%08x expected 0x%08x (len %lu)\n</span><span style="color:#000000;">",</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">       crc32, verify32, len);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">break</span><span style="color:#000000;">;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">pr_info("</span><span style="color:#e36c09;">crc-vpmsum_test done, completed %lu iterations\n</span><span style="color:#000000;">", i);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">} </span><span style="color:#0070c0;">while</span><span style="color:#000000;"> (0);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">free_32:</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">crypto_free_shash(crc32c_tfm);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">free_16:</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">crypto_free_shash(crct10dif_tfm);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">free_buf:</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">kfree(data);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">return</span><span style="color:#000000;"> 0;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*出口函数初始化*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">static void</span><span style="color:#000000;"> __exit crc_test_exit(void) {}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">module_init(crc_test_init);</span><span style="color:#00b050;">/*将crc_test_init()指定为入口函数*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">module_exit(crc_test_exit);</span> <span style="color:#00b050;">/*将crc_test_exit()指定为出口函数*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">module_param(iterations, long, 0400);</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">MODULE_AUTHOR("</span><span style="color:#984806;">Daniel Axtens &lt;dja@axtens.net&gt;</span><span style="color:#000000;">");</span><span style="color:#00b050;">//添加作者名字</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">MODULE_DESCRIPTION("</span><span style="color:#984806;">Vector polynomial multiply-sum CRC tester</span><span style="color:#000000;">");</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">//从字面意思上看，指的是模块介绍</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">MODULE_LICENSE("</span><span style="color:#984806;">GPL</span><span style="color:#000000;">");</span><span style="color:#00b050;">//LICENSE采用“GPL协议”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">上面的程序用到“pr_err()和pr_info()”，通过查找，它们都是调用“printk()”，内容如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">#define</span> pr_err(fmt, ...) \</p> 
<p style="margin-left:.0001pt;text-align:justify;">printk(KERN_ERR pr_fmt(fmt), ##__VA_ARGS__)</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">#define</span> pr_info(fmt, ...) \</p> 
<p style="margin-left:.0001pt;text-align:justify;">printk(KERN_INFO pr_fmt(fmt), ##__VA_ARGS__)</p> 
<p style="margin-left:.0001pt;text-align:justify;">因此，我们知道linux的串口输出是调用printk()来实现的，相当于C语言的printf()函数。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">Linux驱动的运行方式：</p> 
<p style="margin-left:.0001pt;text-align:justify;">1)、将驱动<span style="color:#00b050;">源码</span>编译进Linux内核中，生成uImage/zImage系统镜像里面。</p> 
<p style="margin-left:.0001pt;text-align:justify;">2)、<span style="color:#00b050;">将驱动</span><span style="color:#00b050;">源码</span><span style="color:#00b050;">编译成模块</span><span style="color:#00b050;">，</span><span style="color:#00b050;">生成以“.</span><span style="color:#00b050;">ko</span><span style="color:#00b050;">”</span><span style="color:#00b050;">结尾的文件</span><span style="color:#00b050;">，</span><span style="color:#00b050;">然后</span><span style="color:#00b050;">在Linux内核</span><span style="color:#00b050;">里</span><span style="color:#00b050;">加载驱动模块</span>。也可以编译进内核，最终集成到uImage里面。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">4、<span style="color:#000000;">加载</span><span style="color:#000000;">模块</span><span style="color:#000000;">使用modprobe命令</span><span style="color:#000000;">，</span>卸载模块使用rmmod命令</p> 
<p style="margin-left:.0001pt;text-align:justify;">比如执行“<span style="color:#ff0000;">insmod</span> <span style="color:#ff0000;">drv</span><span style="color:#ff0000;">.</span><span style="color:#ff0000;">ko</span>”加载“<span style="color:#ff0000;">drv</span><span style="color:#ff0000;">.</span><span style="color:#ff0000;">ko</span>”模块，由于drv.ko模块需要依赖first.ko模块，因此，要先执行“<span style="color:#ff0000;">insmod</span> <span style="color:#ff0000;">first.ko</span>”，然后再执行“<span style="color:#ff0000;">insmod</span> <span style="color:#ff0000;">drv</span><span style="color:#ff0000;">.</span><span style="color:#ff0000;">ko</span>”，才可以加载。而执行“<span style="color:#ff0000;">modprobe</span> <span style="color:#ff0000;">drv</span><span style="color:#ff0000;">.</span><span style="color:#ff0000;">ko</span>”加载“<span style="color:#ff0000;">drv</span><span style="color:#ff0000;">.</span><span style="color:#ff0000;">ko</span>”模块，它会分析<span style="color:#ff0000;">first.ko</span>和<span style="color:#ff0000;">drv</span><span style="color:#ff0000;">.</span><span style="color:#ff0000;">ko</span>模块之间的依赖关系，自动将“<span style="color:#ff0000;">first.ko</span>和<span style="color:#ff0000;">drv</span><span style="color:#ff0000;">.</span><span style="color:#ff0000;">ko</span>”加载到内核中。因此<span style="color:#00b050;">加载驱动使用modprobe命令</span>。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">在卸载的时候，执行“<span style="color:#7030a0;">rmmod drv.ko</span>”就可以卸载了，而modprobe命令在分析出“<span style="color:#ff0000;">first.ko</span>和<span style="color:#ff0000;">drv</span><span style="color:#ff0000;">.</span><span style="color:#ff0000;">ko</span>”模块之间有依赖关系，若<span style="color:#ff0000;">first.ko</span>被其它模块使用le，就不能执行“<span style="color:#7030a0;">modprobe -r drv</span><span style="color:#000000;">”</span>；若<span style="color:#ff0000;">first.ko</span>没有被其它模块使用，就可以执行“<span style="color:#7030a0;">modprobe -r drv</span><span style="color:#000000;">”</span>；。因此<span style="color:#00b050;">卸载模块使用</span><span style="color:#00b050;">insmod命令</span>。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">注意：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">Limnux kemnel的版本号为5.4.31</span><span style="color:#0000ff;">，</span><span style="color:#0000ff;">modprobe命令</span><span style="color:#0000ff;">就</span><span style="color:#0000ff;">会到“/lib/modules/5.4.31”目录中</span><span style="color:#0000ff;">去</span><span style="color:#0000ff;">查找相应的驱动模块，</span><span style="color:#0000ff;">因此我们需要将编写好的驱动会放到</span><span style="color:#0000ff;">“/lib/modules/5.4.31”目录中</span>。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">5、“字符设备加载与卸载模板”</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*驱动入口函数 */</span><span style="color:#0070c0;">static int</span>  __init xxx init(<span style="color:#0070c0;">void</span>){   <span style="color:#00b050;">/*入口函数具体内容 */</span>   <span style="color:#0070c0;">return</span> 0;}</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*驱动出口函数 */</span><span style="color:#0070c0;">static void</span> __exit xxx_exit(<span style="color:#0070c0;">void</span>){   <span style="color:#00b050;">/*出口函数具体内容 */</span>}</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">module_init(xxx_init); <span style="color:#00b050;">//声明xxx_init()为驱动入口函数</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">module_exit(xxx_exit); <span style="color:#00b050;">//声明xxx_exit()为驱动出口函数</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">通过<span style="color:#000000;">“crc-vpmsum_test.c”学习</span>，我们仿写一个驱动，命名为My_TestDriver.c。</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">1)、创建“</span><span style="color:#00b050;">/home/zgq/linux/Linux_Drivers/00_My_TestDriver/</span><span style="color:#000000;">”目录</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">输入“</span><span style="color:#ff0000;">cd /home/zgq/linux/Linux_Drivers/</span><span style="color:#000000;">”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">切换到“</span><span style="color:#00b050;">/home/zgq/linux/Linux_Drivers/</span><span style="color:#000000;">”目录</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">输入“</span><span style="color:#ff0000;">mkdir 00_My_TestDriver</span><span style="color:#000000;">”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">创建“</span><span style="color:#00b050;">/home/zgq/linux/Linux_Drivers/00_My_TestDriver/</span><span style="color:#000000;">”目录</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">输入“</span><span style="color:#ff0000;">ls</span><span style="color:#000000;">”，查询“</span><span style="color:#00b050;">/home/zgq/linux/Linux_Drivers/</span><span style="color:#000000;">”目录下的文件和文件夹</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">输入“</span><span style="color:#ff0000;">cd 00_My_TestDriver/</span><span style="color:#000000;">”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">切换到“</span><span style="color:#00b050;">/home/zgq/linux/Linux_Drivers/00_My_TestDriver/</span><span style="color:#000000;">”目录</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">vi My_TestDriver.c</span>”打开“My_TestDriver.c”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入内容如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">#include</span><span style="color:#000000;"> &lt;</span><span style="color:#ff0000;">linux/init.h</span><span style="color:#000000;">&gt;       </span><span style="color:#00b050;">//必须要包含的头文件</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">#include</span><span style="color:#000000;"> &lt;</span><span style="color:#ff0000;">linux/module.h</span><span style="color:#000000;">&gt;     </span><span style="color:#00b050;">//必须要包含的头文件</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">#include</span><span style="color:#000000;"> &lt;</span><span style="color:#ff0000;">linux/string.h</span><span style="color:#000000;">&gt;     </span><span style="color:#00b050;">//下面要用到字符串，显然也要包含</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">#include</span><span style="color:#000000;"> &lt;</span><span style="color:#ff0000;">linux/kernel.h</span><span style="color:#000000;">&gt;     </span><span style="color:#00b050;">//必须要包含的头文件</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*入口函数初始化*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">static int</span><span style="color:#000000;"> __init </span><span style="color:#ff0000;">My_TestDriver_init</span><span style="color:#000000;">(</span><span style="color:#0070c0;">void</span><span style="color:#000000;">)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">{<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">int</span><span style="color:#000000;"> ret = 0;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">    printk("<span style="color:#ff0000;">My_TestDriver_init</span>\r\n");</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">return</span><span style="color:#000000;"> ret;</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">/*出口函数初始化*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0070c0;">static void</span><span style="color:#000000;"> __exit </span><span style="color:#ff0000;">My_TestDriver_exit</span><span style="color:#000000;">(void)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">{<!-- --></span></p> 
<p style="margin-left:.0001pt;text-align:justify;">printk("<span style="color:#ff0000;">My_TestDriver_exit</span>\r\n");</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">}</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">module_init(</span><span style="color:#ff0000;">My_TestDriver_init</span><span style="color:#000000;">);</span><span style="color:#00b050;">/*将</span><span style="color:#ff0000;">My_TestDriver_init</span><span style="color:#00b050;">()指定为入口函数*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">module_exit(</span><span style="color:#ff0000;">My_TestDriver_exit</span><span style="color:#000000;">);</span> <span style="color:#00b050;">/*将</span><span style="color:#ff0000;">My_TestDriver_exit</span><span style="color:#00b050;">()指定为出口函数*/</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">MODULE_AUTHOR("</span><span style="color:#984806;">Zhanggong</span><span style="color:#000000;">");</span><span style="color:#00b050;">//添加作者名字</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">MODULE_DESCRIPTION("</span><span style="color:#984806;">This is test module!</span><span style="color:#000000;">");</span><span style="color:#00b050;">//模块介绍</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">MODULE_LICENSE("</span><span style="color:#984806;">GPL</span><span style="color:#000000;">");</span><span style="color:#00b050;">//LICENSE采用“GPL协议”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">MODULE_INFO(intree,"Y");</span><span style="color:#00b050;">//去处显示“loading out-of-tree module taints kernel.”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="843" src="https://images2.imgbox.com/88/10/pRBJ40uV_o.png" width="1054"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">按“<span style="color:#ff0000;">ESC键</span>”，输入“<span style="color:#ff0000;">:wq回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">vim Makefile</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">添加内容如下：</p> 
<p style="margin-left:.0001pt;text-align:justify;">KERNELDIR := /home/zgq/linux/atk-mp1/linux/my_linux/linux-5.4.31</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#使用“:=”将其后面的字符串赋值给KERNELDIR</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">CURRENT_PATH := $(shell pwd)</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#采用“shell pwd”获取当前打开的路径</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#使用“$(变量名)”引用“变量的值”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">obj-m := My_TestDriver.o</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#生成“obj-m”需要依赖“My_TestDriver.o”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">build: kernel_modules</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#生成“build”需要依赖“kernel_modules”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">        @echo $(KERNELDIR)<br><span style="color:#1c7331;">#输出KERNELDIR的值为“/home/zgq/linux/atk-mp1/linux/linux-5.4.31”</span><br>         @echo $(CURRENT_PATH)<br><span style="color:#1c7331;">#输出CURRENT_PATH的值为/home/zgq/linux/Linux_Drivers/00_My_TestDriver”</span><br>         @echo $(MAKE)<br><span style="color:#1c7331;">#输出MAKE的值为make</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">kernel_modules:</p> 
<p style="margin-left:.0001pt;text-align:justify;">        $(MAKE) -C $(KERNELDIR) M=$(CURRENT_PATH) modules</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#后面的"modules"表示编译成模块</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#“KERNELDIR”上面定义为“/home/zgq/linux/atk-mp1/linux/my_linux/linux-5.4.31”，即“指定的工作目录”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#“CURRENT_PATH”上面定义为“当前的工作目录”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#“-C $(KERNELDIR) M=$(CURRENT_PATH) ”表示将“当前的工作目录”切换到“指定的目录”中</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#即切换到“/home/zgq/linux/atk-mp1/linux/my_linux/linux-5.4.31”。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#M表示模块源码目录</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#在“make和modules”之间加入“M=$(CURRENT_PATH)”，表示切换到由“CURRENT_PATH”指定的目录中读取源码，同时将其编&gt;译为.ko 文件</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">clean:</p> 
<p style="margin-left:.0001pt;text-align:justify;">        $(MAKE) -C $(KERNELDIR) M=$(CURRENT_PATH) clean</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#“KERNELDIR”上面定义为“/home/zgq/linux/atk-mp1/linux/my_linux/linux-5.4.31”，即“指定的工作目录”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">#“CURRENT_PATH”上面定义为“当前的工作目录”</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="673" src="https://images2.imgbox.com/1f/ff/UOyFJhcY_o.png" width="1141"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">按“<span style="color:#ff0000;">ESC键</span>”，输入“<span style="color:#ff0000;">:wq回车</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">在linx驱动中的Makefile文件，有点像“八股文”，在格式上基本是固定的。</p> 
<p style="margin-left:.0001pt;text-align:justify;">驱动测试</p> 
<p style="margin-left:.0001pt;text-align:justify;">在连接开发板之前，需要将“<span style="color:#0070c0;">My_TestDriver.ko</span>”拷贝到“<span style="color:#ff0000;">/home/zgq/linux/nfs/rootfs/lib/modules/5.4.31</span><span style="color:#ff0000;">/</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">cd /home/zgq/linux/Linux_Drivers/00_My_TestDriver/</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">切换到“<span style="color:#00b050;">/home/zgq/linux/Linux_Drivers/00_My_TestDriver/</span>”目录</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">输入“</span><span style="color:#ff0000;">ls</span><span style="color:#000000;">”，查询“</span><span style="color:#00b050;">/home/zgq/linux/Linux_Drivers/00_My_TestDriver/</span><span style="color:#000000;">”目录下的文件和文件夹</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">make clean回车</span>”清除工程</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">make回车</span>”执行编译</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">输入“</span><span style="color:#ff0000;">ls</span><span style="color:#000000;">”，查询“</span><span style="color:#00b050;">/home/zgq/linux/Linux_Drivers/00_My_TestDriver/</span><span style="color:#000000;">”目录下的文件和文件夹</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">sudo </span><span style="color:#ff0000;">cp  My_TestDriver.ko  </span><span style="color:#ff0000;">/home/zgq/linux/nfs/rootfs/lib/modules/5.4.31</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">将“<span style="color:#0070c0;">My_TestDriver.ko</span>”拷贝到“<span style="color:#ff0000;">/home/zgq/linux/nfs/rootfs/lib/modules/5.4.31</span>”</p> 
<p> <img alt="" height="611" src="https://images2.imgbox.com/b7/a0/1UpcPmyu_o.png" width="737"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">启动开发板，从网络下载程序</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“root”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">cd </span><span style="color:#ff0000;">/lib/modules/5.4.31</span><span style="color:#ff0000;">/</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">在nfs挂载中，切换到“<span style="color:#1a439c;">/lib/modules/5.4.31/</span>”目录</p> 
<p style="margin-left:.0001pt;text-align:justify;">注意：“<span style="color:#1a439c;">lib/modules/5.4.31/</span>”<span style="color:#ff0000;">在虚拟机中是位于“/home/zgq/linux/nfs/rootfs/</span><span style="color:#ff0000;">”目录下，但在开发板中，却是位于根目录中</span>。</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">ls</span>”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">depmod</span>”,驱动在第一次执行时，需要运行“depmod”</p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#ff0000;">modprobe</span> <span style="color:#00b050;">My_TestDriver.ko</span>”，加载“<span style="color:#00b050;">My_TestDriver</span><span style="color:#00b050;">.ko</span>”模块</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">输入“</span><span style="color:#ff0000;">lsmod</span><span style="color:#000000;">”查看有哪些驱动在工作</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">输入“<span style="color:#7030a0;">rmmod </span><span style="color:#00b050;">My_TestDriver</span><span style="color:#00b050;">.ko</span>”，卸载“<span style="color:#00b050;">My_TestDriver</span><span style="color:#00b050;">.ko</span>”模块</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#00b050;">注意:</span><span style="color:#00b050;">输入“</span><span style="color:#00b050;">rmmod </span><span style="color:#00b050;">My_TestDriver</span><span style="color:#00b050;">”</span><span style="color:#00b050;">也可以</span><span style="color:#00b050;">卸载“</span><span style="color:#00b050;">My_TestDriver</span><span style="color:#00b050;">.ko</span><span style="color:#00b050;">”</span><span style="color:#00b050;">模块</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#000000;">输入“</span><span style="color:#ff0000;">lsmod</span><span style="color:#000000;">”查看有哪些驱动在工作</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="653" src="https://images2.imgbox.com/40/d1/zM3uSLsG_o.png" width="831"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">至此，我们完成了linux字符设备驱动的挂载和卸载。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1a581e83c50270969649b16b90d1cca5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">AOSP并发编程案例之ConditionVariable</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8064e59dc3e3a78c3288dc322abea710/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ElasticSearch 8.x 创建父子文档，用Join类型字段以及用has_child、has_parent 检索</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>