<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Haproxy - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Haproxy" />
<meta property="og:description" content="文章目录 Haproxy一、关于Haproxy1、Haproxy介绍2、Haproxy 主要特性3、常见的Haproxy负载均衡策略4、LVS、Nginx、HAproxy的区别 二、安装haproxy1、yum 安装2、第三方yum仓库安装3、编译安装3.1 解决lua环境3.2 编译安装 haproxy 三、配置文件详解1、global配置1.1 状态页1.2 指定进程线程个数1.3 cpu亲缘性1.4 多进程和线程1.5 日志 2、Proxies配置2.1 Proxies配置-defaults2.2 Proxies 配置 -listen 简化配置2.3 Proxies 配置 -frontend2.4 Proxies 配置 -backend Haproxy 一、关于Haproxy 1、Haproxy介绍 HAProxy是法国开发者威利塔罗(Willy Tarreau)在2000年使用C语言开发的一个开源软件，是一款具备高并发(一万以上)、高性能的TCP和HTTP负载均衡器，支持基于cookie的持久性，自动故障切换，支持正则表达式及web状态统计，目前最新TLS版本为2.2。
HAProxy是可提供高可用性、负载均衡以及基于TcP和HTTP应用的代理，是免费、快速并且可靠的一种解决方案。HProxy非常适用于并发大(并发达1w以上) web站点，这些站点通常又需要会话保持或七层处理。HAProxy的运行模式使得它可以很简单安全的整合至当前的架构中，同时可以保护web服务器不被暴露到网络上。
支持功能：
TCP 和 HTTP反向代理SSL/TSL服务器可以针对HTTP请求添加cookie，进行路由后端服务器可平衡负载至后端服务器，并支持持久连接支持所有主服务器故障切换至备用服务器 keepalive支持专用端口实现监控服务支持停止接受新连接请求，而不影响现有连接可以在双向添加，修改或删除HTTP报文首部字段响应报文压缩支持基于pattern实现连接请求的访问控制通过特定的URI（url）为授权用户提供详细的状态信息 2、Haproxy 主要特性 可靠性和稳定性非常好，可以与硬件级的F5负载均衡设备相媲美最高可以同时维护40000-50000个并发连接，单位时间内处理的最大请求数为20000个，最大处理能力可达10Git/s支持多达8种负载均衡算法,同时也支持会话保持支持虚拟机主机功能，从而实现web负载均衡更加灵活支持连接拒绝、全透明代理等独特的功能拥有强大的ACL支持,用于访问控制; sendfile其独特的弹性二x树数据结构，使数据结构的复杂性上升到了0(1)，即数据的查寻速度不会随着数据条日的增加而速度有所下降；支持客户端的keepalive功能，减少客户端与haproxy的多次三次握手导致资源浪费，让多个请求在一个tcp连接中完成支持TCP加速,零复制功能,类似于mmap机制支持响应池(response buffering)支持RDP协议基于源的粘性，类似nginx的ip hash功能，把来自同一客户端的请求在一定时间内始终调度到上游的同一服务器;·更好统计数据接口，其web接口显示后端集群中各个服务器的接收、发送、拒绝、错误等数据的统计信息详细的健康状态检测，web接口中有关于对上游服务器的健康检测状态，并提供了一定的管理功能基于流量的健康评估机制基于http认证基于命令行的管理接口日志分析器，可对日志进行分析 3、常见的Haproxy负载均衡策略 官方文档
http://cbonte.github.io/haproxy-dconv/2.4/configuration.html#4-balance roundrobin，表示简单的轮询 rr
static-rr，表示根据权重
leastconn，表示最少连接者先处理
source，表示根据请求源IP
uri，表示根据请求的URI，做cdn需使用
url param，表示根据请求的URl参数’ balance url param’requires an URL parameter name
hdr(name)，表示根据HTTP请求头来锁定每一次HTTP请求
rdp-cookie (name)，表示根据据cookie(name)来锁定并哈希每一次TCP请求
静态调度算法：不管后端服务器，按照调度器的算法进行分配
动态调度算法：会考虑后端服务器的负载情况（直接动态的调整算法，发送指令给进程，直接生效）
4、LVS、Nginx、HAproxy的区别 调度算法的区别 nginxhaproxylvs（四层）rrrrrr加权轮询static-rrwrr（加权）ip hash最小连接数源地址hash（SH）url hashsource（根据源地址）目的地址hash（DH）cookie hash根据请求来调度默认wlc 加权最小连接数fair根据cookie来调度lc 最小连接最小连接数根据请求头初始连接高权重优先（SED）每个人都有一个连接后，再使用初始连接高权重（NQ） IVS基于Linux操作系统实现软负载均衡，而HAProxy和Nginx是基于第三方应用实现的软负载均衡" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/fcbe5c6a594ae4de1371f0436a52b80f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-13T15:20:41+08:00" />
<meta property="article:modified_time" content="2024-03-13T15:20:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Haproxy</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Haproxy_1" rel="nofollow">Haproxy</a></li><li><ul><li><a href="#Haproxy_3" rel="nofollow">一、关于Haproxy</a></li><li><ul><li><a href="#1Haproxy_5" rel="nofollow">1、Haproxy介绍</a></li><li><a href="#2Haproxy__25" rel="nofollow">2、Haproxy 主要特性</a></li><li><a href="#3Haproxy_44" rel="nofollow">3、常见的Haproxy负载均衡策略</a></li><li><a href="#4LVSNginxHAproxy_73" rel="nofollow">4、LVS、Nginx、HAproxy的区别</a></li></ul> 
   </li><li><a href="#haproxy_106" rel="nofollow">二、安装haproxy</a></li><li><ul><li><a href="#1yum__108" rel="nofollow">1、yum 安装</a></li><li><a href="#2yum_127" rel="nofollow">2、第三方yum仓库安装</a></li><li><a href="#3_140" rel="nofollow">3、编译安装</a></li><li><ul><li><a href="#31_lua_142" rel="nofollow">3.1 解决lua环境</a></li><li><a href="#32__haproxy_188" rel="nofollow">3.2 编译安装 haproxy</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_309" rel="nofollow">三、配置文件详解</a></li><li><ul><li><a href="#1global_394" rel="nofollow">1、global配置</a></li><li><ul><li><a href="#11__428" rel="nofollow">1.1 状态页</a></li><li><a href="#12__453" rel="nofollow">1.2 指定进程线程个数</a></li><li><a href="#13_cpu_478" rel="nofollow">1.3 cpu亲缘性</a></li><li><a href="#14__506" rel="nofollow">1.4 多进程和线程</a></li><li><a href="#15__531" rel="nofollow">1.5 日志</a></li></ul> 
    </li><li><a href="#2Proxies_624" rel="nofollow">2、Proxies配置</a></li><li><ul><li><a href="#21_Proxiesdefaults_643" rel="nofollow">2.1 Proxies配置-defaults</a></li><li><a href="#22_Proxies__listen__741" rel="nofollow">2.2 Proxies 配置 -listen 简化配置</a></li><li><a href="#23_Proxies__frontend_756" rel="nofollow">2.3 Proxies 配置 -frontend</a></li><li><a href="#24_Proxies__backend_801" rel="nofollow">2.4 Proxies 配置 -backend</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Haproxy_1"></a>Haproxy</h2> 
<h3><a id="Haproxy_3"></a>一、关于Haproxy</h3> 
<h4><a id="1Haproxy_5"></a>1、Haproxy介绍</h4> 
<p>HAProxy是法国开发者威利塔罗(Willy Tarreau)在2000年使用C语言开发的一个开源软件，是一款具备高并发(一万以上)、高性能的TCP和HTTP负载均衡器，支持基于cookie的持久性，自动故障切换，支持正则表达式及web状态统计，目前最新TLS版本为2.2。</p> 
<p>HAProxy是可提供高可用性、负载均衡以及基于TcP和HTTP应用的代理，是免费、快速并且可靠的一种解决方案。HProxy非常适用于并发大(并发达1w以上) web站点，这些站点通常又需要会话保持或七层处理。HAProxy的运行模式使得它可以很简单安全的整合至当前的架构中，同时可以保护web服务器不被暴露到网络上。</p> 
<p><strong>支持功能：</strong></p> 
<ul><li>TCP 和 HTTP反向代理</li><li>SSL/TSL服务器</li><li>可以针对HTTP请求添加cookie，进行路由后端服务器</li><li>可平衡负载至后端服务器，并支持持久连接</li><li>支持所有主服务器故障切换至备用服务器 keepalive</li><li>支持专用端口实现监控服务</li><li>支持停止接受新连接请求，而不影响现有连接</li><li>可以在双向添加，修改或删除HTTP报文首部字段</li><li>响应报文压缩</li><li>支持基于pattern实现连接请求的访问控制</li><li>通过特定的URI（url）为授权用户提供详细的状态信息</li></ul> 
<h4><a id="2Haproxy__25"></a>2、Haproxy 主要特性</h4> 
<ul><li>可靠性和稳定性非常好，可以与硬件级的F5负载均衡设备相媲美</li><li>最高可以同时维护40000-50000个并发连接，单位时间内处理的最大请求数为20000个，最大处理能力可达10Git/s</li><li>支持多达8种负载均衡算法,同时也支持会话保持</li><li>支持虚拟机主机功能，从而实现web负载均衡更加灵活</li><li>支持连接拒绝、全透明代理等独特的功能</li><li>拥有强大的ACL支持,用于访问控制; sendfile</li><li>其独特的弹性二x树数据结构，使数据结构的复杂性上升到了0(1)，即数据的查寻速度不会随着数据条日的增加而速度有所下降；支持客户端的keepalive功能，减少客户端与haproxy的多次三次握手导致资源浪费，让多个请求在一个tcp连接中完成</li><li>支持TCP加速,零复制功能,类似于mmap机制</li><li>支持响应池(response buffering)</li><li>支持RDP协议</li><li>基于源的粘性，类似nginx的ip hash功能，把来自同一客户端的请求在一定时间内始终调度到上游的同一服务器;·更好统计数据接口，其web接口显示后端集群中各个服务器的接收、发送、拒绝、错误等数据的统计信息</li><li>详细的健康状态检测，web接口中有关于对上游服务器的健康检测状态，并提供了一定的管理功能</li><li>基于流量的健康评估机制</li><li>基于http认证</li><li>基于命令行的管理接口</li><li>日志分析器，可对日志进行分析</li></ul> 
<h4><a id="3Haproxy_44"></a>3、常见的Haproxy负载均衡策略</h4> 
<p><strong>官方文档</strong></p> 
<pre><code class="prism language-bash">http://cbonte.github.io/haproxy-dconv/2.4/configuration.html<span class="token comment">#4-balance</span>
</code></pre> 
<ul><li> <p>roundrobin，表示简单的轮询 rr</p> </li><li> <p>static-rr，表示根据权重</p> </li><li> <p>leastconn，表示最少连接者先处理</p> </li><li> <p>source，表示根据请求源IP</p> </li><li> <p>uri，表示根据请求的URI，做cdn需使用</p> </li><li> <p>url param，表示根据请求的URl参数’ balance url param’requires an URL parameter name</p> </li><li> <p>hdr(name)，表示根据HTTP请求头来锁定每一次HTTP请求</p> </li><li> <p>rdp-cookie (name)，表示根据据cookie(name)来锁定并哈希每一次TCP请求</p> </li></ul> 
<p><strong>静态调度算法</strong>：不管后端服务器，按照调度器的算法进行分配</p> 
<p><strong>动态调度算法</strong>：会考虑后端服务器的负载情况（直接动态的调整算法，发送指令给进程，直接生效）</p> 
<h4><a id="4LVSNginxHAproxy_73"></a>4、LVS、Nginx、HAproxy的区别</h4> 
<ul><li>调度算法的区别</li></ul> 
<table><thead><tr><th>nginx</th><th>haproxy</th><th>lvs（四层）</th></tr></thead><tbody><tr><td>rr</td><td>rr</td><td>rr</td></tr><tr><td>加权轮询</td><td>static-rr</td><td>wrr（加权）</td></tr><tr><td>ip hash</td><td>最小连接数</td><td>源地址hash（SH）</td></tr><tr><td>url hash</td><td>source（根据源地址）</td><td>目的地址hash（DH）</td></tr><tr><td>cookie hash</td><td>根据请求来调度</td><td>默认wlc 加权最小连接数</td></tr><tr><td>fair</td><td>根据cookie来调度</td><td>lc 最小连接</td></tr><tr><td>最小连接数</td><td>根据请求头</td><td>初始连接高权重优先（SED）</td></tr><tr><td></td><td></td><td>每个人都有一个连接后，再使用初始连接高权重（NQ）</td></tr></tbody></table> 
<ul><li> <p>IVS基于Linux操作系统实现软负载均衡，而HAProxy和Nginx是基于第三方应用实现的软负载均衡</p> </li><li> <p>LVS是可实现4层的IP负载均衡技术，无法实现基于目录、URL的转发。而HAProxy和Nginx都可以实现4层和7层技术，HAProxy可提供TCP和HTTP应用的负载均衡综合解决方案，但是性能不如lvs，lvs &gt; haproxy &gt; nginx</p> </li><li> <p>LVs因为工作在TCP模型的第四层，其状态监测功能单一，而HAProxy在状态监测方面功能更丰富、强大，可支持端口、URI等多种状态检测方式</p> </li><li> <p>HAProxy功能强大,但整体性能低于4层模式的IVS负载均衡</p> </li><li> <p>Nginx主要用于web服务器或缓存服务器。Nginx的upstream模块虽然也支持群集功能，但是对群集节点健康检查功能不强，性能没有Haproxy好</p> </li><li> <p>haproxy对比nginx性能优越，功能又单一，haproxy只做反向代理</p> </li><li> <p>lvs没有后端服务器健康性检测，nginx和haproxy有后端服务器健康性检测</p> </li></ul> 
<p><strong>四层协议和七层协议区别：</strong></p> 
<p>四层协议：性能好，功能少，只能控制四层协议，端口ip</p> 
<p>七层协议：性能弱，功能多，可以控制七层协议http</p> 
<h3><a id="haproxy_106"></a>二、安装haproxy</h3> 
<h4><a id="1yum__108"></a>1、yum 安装</h4> 
<p>CentOS 7 的默认的base仓库中包含haproxy的安装包文件，但是版本比较旧，是1.5.18的版本，距离当前版本已经有较长时间没有更新，由于版本比较旧所以有很多功能不支持，如果对功能和性能没有要求可以使用此版本，否则推荐使用新版本。</p> 
<pre><code class="prism language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> haproxy.x86_64
<span class="token comment">#安装haproxy</span>

haproxy <span class="token parameter variable">-v</span>
<span class="token comment">#查看haproxy版本</span>

yum info haproxy
<span class="token comment">#版本信息更详细</span>

<span class="token comment">##yum安装的haproxy服务版本过于老旧，很多功能不支持</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b2/1e/6ERTvd70_o.png" alt="image-20240308122200883"></p> 
<h4><a id="2yum_127"></a>2、第三方yum仓库安装</h4> 
<pre><code class="prism language-bash">yum <span class="token function">install</span> centos-release-scl-rh 
yum <span class="token function">install</span> rh-haproxy18-haproxy
<span class="token comment">#使用第三方仓库安装haproxy</span>

systemctl start rh-haproxy18-haproxy.service
<span class="token comment">#开启服务</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/88/74/TpxHLviV_o.png" alt="image-20240312141653575"></p> 
<h4><a id="3_140"></a>3、编译安装</h4> 
<h5><a id="31_lua_142"></a>3.1 解决lua环境</h5> 
<p>HAProxy 支持基于lua实现功能扩展，lua是一种小巧的脚本语言，于1993年由巴西里约热内卢天主教大学（Pontifical Catholic University of Rio de Janeiro）里的一个研究小组开发，其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p> 
<p>Lua 官网：www.lua.org</p> 
<p>Lua 应用场景</p> 
<ul><li>游戏开发</li><li>独立应用脚本</li><li>Web 应用脚本</li><li>扩展和数据库插件，如MySQL Proxy</li><li>安全系统，如入侵检测系统</li></ul> 
<p>由于CentOS7 之前版本自带的lua版本比较低并不符合HAProxy要求的lua最低版本(5.3)的要求，因此需要编译安装较新版本的lua环境，然后才能编译安装HAProxy，过程如下：</p> 
<pre><code class="prism language-bash"><span class="token comment">#当前系统版本</span>
lua <span class="token parameter variable">-v</span> 
Lua <span class="token number">5.1</span>.4  Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">1994</span>-2008 Lua.org, PUC-Rio

https://www.lua.org
<span class="token comment">##登录lua官方网站，选择download，查看下载安装步骤</span>
<span class="token function">curl</span> <span class="token parameter variable">-L</span> <span class="token parameter variable">-R</span> <span class="token parameter variable">-O</span> https://www.lua.org/ftp/lua-5.4.6.tar.gz
<span class="token function">tar</span> zxf lua-5.4.6.tar.gz
<span class="token builtin class-name">cd</span> lua-5.4.6
<span class="token function">make</span> all <span class="token builtin class-name">test</span>

yum groupinstall <span class="token string">'Development Tools'</span>
<span class="token comment">#安装gcc命令</span>

<span class="token function">make</span> all <span class="token builtin class-name">test</span>
<span class="token builtin class-name">cd</span>  src
./lua <span class="token parameter variable">-v</span> 
</code></pre> 
<p><img src="https://images2.imgbox.com/5e/92/sCHXV02M_o.png" alt="image-20240312151610166"></p> 
<p><img src="https://images2.imgbox.com/58/19/oHwlPQXJ_o.png" alt="image-20240312151659280"></p> 
<p><img src="https://images2.imgbox.com/4b/f1/5n0rlCq1_o.png" alt="image-20240312160303437"></p> 
<p><img src="https://images2.imgbox.com/af/bc/oE0eThsQ_o.png" alt="image-20240312160557245"></p> 
<h5><a id="32__haproxy_188"></a>3.2 编译安装 haproxy</h5> 
<pre><code class="prism language-bash"><span class="token function">ln</span> <span class="token parameter variable">-s</span> lua-5.4.6 lua
<span class="token comment">#做软链接</span>

yum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc openssl-devel pcre-devel systemd-devel
<span class="token comment">#安装依赖环境</span>

<span class="token function">tar</span> xf haproxy-2.4.25.tar.gz
<span class="token comment">#上传需要的haproxy安装包，解压</span>

<span class="token builtin class-name">cd</span> haproxy-2.4.25/
<span class="token comment">#切换目录</span>

<span class="token function">cat</span> INSTALL
<span class="token comment">#查看安装方法</span>

<span class="token function">make</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>x86_64 <span class="token assign-left variable">TARGET</span><span class="token operator">=</span>linux-glibc <span class="token assign-left variable">USE_PCRE</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">USE_OPENSSL</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">USE_ZLIB</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">USE_SYSTEMD</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">USE_LUA</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">LUA_INC</span><span class="token operator">=</span>/data/lua/src/  <span class="token assign-left variable">LUA_LIB</span><span class="token operator">=</span>/data/lua/src/
<span class="token comment">#安装</span>

<span class="token function">make</span> <span class="token function">install</span> <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/apps/haproxy
<span class="token comment">#安装并指定目录</span>
 
<span class="token function">ln</span> <span class="token parameter variable">-s</span> /apps/haproxy/sbin/haproxy /usr/sbin/
<span class="token comment">#做软连接</span>

haproxy  <span class="token parameter variable">-v</span>
<span class="token comment">#查看haproxy版本</span>

<span class="token comment">#多行重定向，编辑配置文件，可以使用systemctl管理</span>
<span class="token function">tee</span> /usr/lib/systemd/system/haproxy.service  <span class="token operator">&lt;&lt;</span><span class="token string">eof

[Unit]
Description=HAProxy Load Balancer
After=syslog.target network.target

[Service]
ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg  -c -q
ExecStart=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /var/lib/haproxy/haproxy.pid
ExecReload=/bin/kill -USR2 <span class="token variable">$MAINPID</span>
LimitNOFILE=100000

[Install]
WantedBy=multi-user.target


eof</span>

<span class="token function">mkdir</span> /etc/haproxy
<span class="token comment">#建立配置文件夹</span>

<span class="token comment">#编辑配置文件</span>
<span class="token function">vim</span> /etc/haproxy/haproxy.cfg
global
maxconn <span class="token number">100000</span>
<span class="token function">chroot</span> /apps/haproxy
stats socket /var/lib/haproxy/haproxy.sock mode <span class="token number">600</span> level admin
uid <span class="token number">99</span>
gid <span class="token number">99</span>
daemon
<span class="token comment">#nbproc 4</span>
<span class="token comment">#cpu-map 1 0</span>
<span class="token comment">#cpu-map 2 1</span>
<span class="token comment">#cpu-map 3 2</span>
<span class="token comment">#cpu-map 4 3</span>
pidfile /var/lib/haproxy/haproxy.pid
log <span class="token number">127.0</span>.0.1 local3 info

defaults
option http-keep-alive
option  forwardfor
maxconn <span class="token number">100000</span>
mode http
<span class="token function">timeout</span> connect 300000ms
<span class="token function">timeout</span> client  300000ms
<span class="token function">timeout</span> server  300000ms

listen stats
 mode http
 <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:9999
 stats <span class="token builtin class-name">enable</span>
 log global
 stats uri     /haproxy-status
 stats auth    haadmin:123456

listen  web_port
 <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:8899
 mode http
 log global
 server web1  <span class="token number">127.0</span>.0.1:8080  check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>

<span class="token function">mkdir</span>  /var/lib/haproxy
<span class="token comment">#建立pid文件路径</span>

<span class="token function">useradd</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-s</span> /sbin/nologin  haproxy
<span class="token comment">#新建用户，设置目录权限（-r表示随机生成pid号）</span>

systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> haproxy
<span class="token comment">#自启并立即启动</span>

systemctl status haproxy.service
<span class="token comment">#查看haproxy状态</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1a/68/cX0zaDAt_o.png" alt="image-20240312163430397"></p> 
<p><img src="https://images2.imgbox.com/b3/d5/CjDZIJs2_o.png" alt="image-20240312162341347"></p> 
<p><img src="https://images2.imgbox.com/2a/61/aXsKQMPD_o.png" alt="image-20240312162416218"></p> 
<p><img src="https://images2.imgbox.com/c9/b9/KmdrFRYj_o.png" alt="image-20240312164504963"></p> 
<p><img src="https://images2.imgbox.com/49/d6/txC8uGU2_o.png" alt="image-20240312165211878"></p> 
<p><img src="https://images2.imgbox.com/cc/e0/eLlSBgxA_o.png" alt="image-20240312165640248"></p> 
<p><img src="https://images2.imgbox.com/35/d2/2XSmTl4U_o.png" alt="image-20240312165842075"></p> 
<p><img src="https://images2.imgbox.com/33/91/ZCowkvwO_o.png" alt="image-20240312170402631"></p> 
<h3><a id="_309"></a>三、配置文件详解</h3> 
<p><strong>官方帮助文档</strong></p> 
<pre><code class="prism language-http">http://cbonte.github.io/haproxy-dconv/
http://cbonte.github.io/haproxy-dconv/2.4/configuration.html
https://www.haproxy.org/download/2.5/doc/configuration.txt
</code></pre> 
<p><strong>相关配置详解</strong></p> 
<pre><code class="prism language-nginx">chroot    #锁定运行目录
deamon    #以守护进程运行，后台运行
stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin process 1   #socket文件
user, group, uid, gid  #运行haproxy的用户身份
nbproc    n     #开启的haproxy work 进程数，默认进程数是一个
#nbthread  1    #和多进程 nbproc配置互斥（版本有关,CentOS8的haproxy1.8无此问题）,指定每个haproxy进程开启的线程数，默认为每个进程一个线程
#如果同时启用nbproc和nbthread 会出现以下日志的错误，无法启动服务Apr  714:46:23 haproxy haproxy: [ALERT] 097/144623 (1454) : config : cannot enable multiple processes if multiple threads are configured. Please use either nbproc or nbthread but not both.

cpu-map 1  0     #绑定haproxy worker 进程至指定CPU，将第1个work进程绑定至0号CPU
cpu-map 2  1     #绑定haproxy worker 进程至指定CPU，将第2个work进程绑定至1  号CPU
                 #ps axo  pid,cmd,psr  |grep haproxy
maxconn  n      #每个haproxy进程的最大并发连接数
maxsslconn  n   #每个haproxy进程ssl最大连接数,用于haproxy配置了证书的场景下
maxconnrate n   #每个进程每秒创建的最大连接数量
spread-checks n #后端server状态check随机提前或延迟百分比时间，建议2-5(20%-50%)之间，默认值0
pidfile         #指定pid文件路径
log 127.0.0.1  local2 info #定义全局的syslog服务器；日志服务器需要开启UDP协议，最多可以定义两个

defaults
        log     global    	#引入global定义的日志格式
        mode    http      	#模式为http（7层代理http，4层代理tcp）
        option  httplog	   	#日志类别为http日志格式		 	
        option  dontlognull	#不记录健康检查日志信息
        retries 3           #检查节点服务器失败次数，连续达到3次，则反馈不可用 
        redispatch			#当服务器负载很高时，自动结束当前队列处理比较久的连接
        maxconn 2000		#最大连接数，此处的数值不能大于全局里的数值
        contimeout      5000  #设置连接超时时间，默认单位是毫秒
		clitimeout      50000 #设置客户端超时时间，默认单位是毫秒
		srvtimeout      50000 #设置服务器超时时间，默认单位是毫秒

#以下是新版本中的
timeout http-request 10s  	#默认http请求超时时间
timeout queue 1m 			#默认队列超时时间	
timeout connect 10s 		#默认连接超时时间，新版本中替代
timeout client 1m
timeout server 1m
timeout http-keep-alive
timeout check 10s

defaults [&lt;name&gt;] #默认配置项，针对以下的frontend、backend和listen生效，可以多个name也可以没有name
frontend &lt;name&gt;   #前端servername，类似于Nginx的一个虚拟主机 server和LVS服务集群。
backend &lt;name&gt;   #后端服务器组，等于nginx的upstream和LVS中的RS服务器
listen   &lt;name&gt;   #将frontend和backend合并在一起配置，相对于frontend和backend配置更简洁，生产常用

使用listen替换 frontend和backend的配置方式，可以简化设置，通常只用于TCP协议的应用
#官网业务访问入口
listen  webcluster 0.0.0.0:80
        option httpchk GET /test.html
        balance roundrobin
        server  inst1 192.168.10.12:80 check inter 2000 fall 3
        server  inst2 192.168.10.13:80 check inter 2000 fall 3
</code></pre> 
<p>HAProxy 的配置文件haproxy.cfg由两大部分组成，分别是global和proxies部分</p> 
<ul><li><strong>global</strong>：全局配置段</li></ul> 
<pre><code class="prism language-http">进程及安全配置相关的参数
性能调整相关参数
Debug参数
</code></pre> 
<ul><li><strong>proxies</strong>：代理配置段</li></ul> 
<pre><code class="prism language-http">defaults：为frontend, backend, listen提供默认配置
frontend：前端，相当于nginx中的server {}
backend：后端，相当于nginx中的upstream {}
listen：同时拥有前端和后端配置,配置简单,生产推荐使用
</code></pre> 
<h4><a id="1global_394"></a>1、global配置</h4> 
<p><strong>官方文档：</strong></p> 
<pre><code class="prism language-http">http://cbonte.github.io/haproxy-dconv/2.4/configuration.html#3
</code></pre> 
<p><strong>配置详细讲解：</strong></p> 
<pre><code class="prism language-bash"><span class="token function">chroot</span> <span class="token comment">#锁定运行目录，类似于ftp中的禁锢</span>
deamon <span class="token comment">#以守护进程运行</span>
stats socket /var/lib/haproxy/haproxy.sock mode <span class="token number">600</span> level admin process <span class="token number">1</span>   <span class="token comment">#socket文件进程件通信</span>
user, group, uid, gid  <span class="token comment">#运行haproxy的用户身份</span>

nbproc   n <span class="token comment">#开启的haproxy worker进程数，默认进程数是一个，保持与 淳朴个数相同</span>
<span class="token comment">#nbthread 1 #和多进程 nbproc配置互斥（版本有关,CentOS8的haproxy1.8无此问题）,指定每个haproxy进程开启的线程数，默认为每个进程一个线程</span>
<span class="token comment">#如果同时启用nbproc和nbthread 会出现以下日志的错误，无法启动服务</span>

Apr  <span class="token number">7</span> <span class="token number">14</span>:46:23 haproxy haproxy: <span class="token punctuation">[</span>ALERT<span class="token punctuation">]</span> 097/144623 <span class="token punctuation">(</span><span class="token number">1454</span><span class="token punctuation">)</span> <span class="token builtin class-name">:</span> config <span class="token builtin class-name">:</span> cannot 
<span class="token builtin class-name">enable</span> multiple processes <span class="token keyword">if</span> multiple threads are configured. Please use either 
nbproc or nbthread but not both.

cpu-map <span class="token number">1</span> <span class="token number">0</span>   		<span class="token comment">#绑定haproxy worker 进程至指定CPU，将第1个work进程绑定至0号CPU</span>
cpu-map <span class="token number">2</span> <span class="token number">1</span>     	<span class="token comment">#绑定haproxy worker 进程至指定CPU，将第2个work进程绑定至1号CPU</span>
maxconn n   		<span class="token comment">#每个haproxy进程的最大并发连接数</span>
maxsslconn n   		<span class="token comment">#每个haproxy进程ssl最大连接数,用于haproxy配置了证书的场景下</span>
maxconnrate n   	<span class="token comment">#每个进程每秒创建的最大连接数量</span>
spread-checks n 	<span class="token comment">#后端server状态check随机提前或延迟百分比时间，建议2-5(20%-50%)之间，默认值0</span>
pidfile 			<span class="token comment">#指定pid文件路径</span>
log <span class="token number">127.0</span>.0.1 local2 info <span class="token comment">#定义全局的syslog服务器；日志服务器需要开启UDP协议，最多可以定义两个</span>
</code></pre> 
<h5><a id="11__428"></a>1.1 状态页</h5> 
<pre><code class="prism language-bash"><span class="token comment">#状态页配置</span>
<span class="token function">vim</span> /etc/haproxy/haproxy.cfg
listen stats
 mode http
 <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:9999
 stats <span class="token builtin class-name">enable</span>
 log global
 stats uri     /haproxy-status
 stats auth    haadmin:123456

systemctl restart haproxy
<span class="token comment">#重启服务</span>

<span class="token comment">#验证访问</span>
<span class="token number">192.168</span>.10.12:9999/haproxy-status
</code></pre> 
<p><img src="https://images2.imgbox.com/d5/fd/M14KoKjo_o.png" alt="image-20240312183230517"><img src="https://images2.imgbox.com/6d/a4/2Q6yY8Pm_o.png" alt="image-20240312183506435"></p> 
<p><img src="https://images2.imgbox.com/53/48/dCkpMcD1_o.png" alt="image-20240312183646855"></p> 
<h5><a id="12__453"></a>1.2 指定进程线程个数</h5> 
<ul><li>进程与线程会有冲突</li></ul> 
<pre><code class="prism language-bash">nbproc  n     <span class="token comment">#开启的haproxy work 进程数，默认进程数是一个</span>
<span class="token comment">#nbthread  1    #和多进程 nbproc配置互斥（版本关,CentOS8的haproxy1.8无此问题）,指定每个haproxy进程开启的线程数，默认为每个进程一个线程</span>
<span class="token comment">#如果同时启用nbproc和nbthread 会出现以下日志的错误，无法启动服务Apr  714:46:23 haproxy haproxy: [ALERT] 097/144623 (1454) : config : cannot enable multiple processes if multiple threads are configured. Please use either nbproc or nbthread but not both.</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">vim</span> /etc/haproxy/haproxy.cfg
nbproc <span class="token number">4</span>
<span class="token comment">#修改配置文件，开启4个进程</span>

systemctl restart haproxy
<span class="token comment">#重启服务</span>

pstree <span class="token parameter variable">-p</span> <span class="token operator">|</span><span class="token function">grep</span> haproxy
<span class="token comment">#过滤haproxy进程</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/67/72/o43z0Ouu_o.png" alt="image-20240312184208991"></p> 
<h5><a id="13_cpu_478"></a>1.3 cpu亲缘性</h5> 
<pre><code class="prism language-bash">nbproc  <span class="token number">2</span>
cpu-map <span class="token number">1</span>  <span class="token number">0</span>     <span class="token comment">#绑定haproxy worker进程至指定CPU，将第1个work进程绑定至0号CPU</span>
cpu-map <span class="token number">2</span>  <span class="token number">1</span>     <span class="token comment">#绑定haproxy worker进程至指定CPU，将第2个work进程绑定至1号CPU</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">ps</span> axo cmd,psr <span class="token operator">|</span><span class="token function">grep</span> haproxy
<span class="token comment">#查看cpu亲缘性，未绑定</span>

<span class="token comment">#修改配置文件，cpu亲缘性绑定</span>
<span class="token function">vim</span> /etc/haproxy/haproxy.cfg
cpu-map <span class="token number">1</span> <span class="token number">0</span>
cpu-map <span class="token number">2</span> <span class="token number">1</span>
cpu-map <span class="token number">3</span> <span class="token number">2</span>
cpu-map <span class="token number">4</span> <span class="token number">3</span>

systemctl restart haproxy.service
<span class="token comment">#重启服务</span>

<span class="token function">ps</span> axo cmd,psr <span class="token operator">|</span><span class="token function">grep</span> haproxy
<span class="token comment">#查看cpu亲缘性绑定</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/28/56/GqDXHy7p_o.png" alt="image-20240313112339517"></p> 
<h5><a id="14__506"></a>1.4 多进程和线程</h5> 
<ul><li>多进程和socket文件</li></ul> 
<pre><code class="prism language-nginx">#多进程配置文件
vim /etc/haproxy/haproxy.cfg
global
maxconn 100000
chroot /apps/haproxy
stats socket /var/lib/haproxy/haproxy.sock1 mode 600 level admin process 1       
stats socket /var/lib/haproxy/haproxy.sock2 mode 600 level admin process 2
uid 99
gid 99
daemon
nbproc 4

systemctl restart haproxy
#重启服务

pstree -p |grep haproxy
#查看haproxy进程
</code></pre> 
<h5><a id="15__531"></a>1.5 日志</h5> 
<ul><li>HAproxy本身不记录客户端的访问日志，以减少服务器负载，一般生产中HAProxy不记录日志，也可以配置HAProxy利用rsyslog服务记录日志到指定日志文件中。</li></ul> 
<pre><code class="prism language-bash"><span class="token comment">#在global配置项定义：</span>
log <span class="token number">127.0</span>.0.1 local<span class="token punctuation">{<!-- --></span><span class="token number">1</span>-7<span class="token punctuation">}</span> info <span class="token comment">#基于syslog记录日志到指定设备，级别有(err、warning、info、debug)</span>
listen web_port
 <span class="token builtin class-name">bind</span> <span class="token number">127.0</span>.0.1:80
 mode http
 log global <span class="token comment">#开启当前web_port的日志功能，默认不记录日志</span>
 server web1  <span class="token number">127.0</span>.0.1:8080 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
</code></pre> 
<p><strong>将日志记录到指定的文件中（本地日志）：</strong></p> 
<pre><code class="prism language-bash"><span class="token comment">#修改配置文件</span>
<span class="token function">vim</span> /etc/haproxy/haproxy.cfg
log <span class="token number">127.0</span>.0.1 local3 info
<span class="token comment">#记录日志到local3 info</span>

<span class="token comment">#修改配置文件</span>
<span class="token function">vim</span> /etc/rsyslog.conf
 <span class="token number">14</span> <span class="token comment"># Provides UDP syslog reception</span>
 <span class="token number">15</span> <span class="token variable">$ModLoad</span> imudp
 <span class="token number">16</span> <span class="token variable">$UDPServerRun</span> <span class="token number">514</span>
 <span class="token number">74</span> local3.*                                                /var/log/haproxy.log

systemctl restart haproxy.service 
systemctl restart rsyslog.service 
<span class="token comment">#重启服务</span>

<span class="token function">ls</span> /var/log/haproxy.log
<span class="token comment">#访问haproxy状态页，生成日志文件</span>

<span class="token number">192.168</span>.10.12:9999/haproxy-status
<span class="token comment">#验证访问</span>

<span class="token function">tail</span> <span class="token parameter variable">-f</span> /var/log/haproxy.log
<span class="token comment">#实时查看</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/86/8f/Vpn46eDA_o.png" alt="image-20240313113425105"></p> 
<p><img src="https://images2.imgbox.com/a9/32/SbBq2Z3P_o.png" alt="image-20240313113359890"></p> 
<p><img src="https://images2.imgbox.com/30/f0/5GGw8y24_o.png" alt="image-20240313120535316"></p> 
<p><img src="https://images2.imgbox.com/39/2d/0x8yQzJb_o.png" alt="image-20240313120440335"></p> 
<p><strong>将日志传给远端服务器（远程日志）：</strong></p> 
<pre><code class="prism language-bash"><span class="token comment">#修改配置文件</span>
<span class="token function">vim</span> /etc/haproxy/haproxy.cfg
log <span class="token number">127.0</span>.0.1 local3 info
log <span class="token number">192.168</span>.10.11  local6 info
<span class="token comment">#指定远端服务器记录日志到local6 info</span>
 
systemctl restart haproxy.service 
<span class="token comment">#重启服务</span>
 
<span class="token comment">#修改远端服务器配置文件</span>
<span class="token function">vim</span> /etc/rsyslog.conf
<span class="token number">14</span> <span class="token comment"># Provides UDP syslog reception</span>
<span class="token number">15</span> <span class="token variable">$ModLoad</span> imudp
<span class="token number">16</span> <span class="token variable">$UDPServerRun</span> <span class="token number">514</span>
<span class="token comment">#服务器要开启udp端口</span>
<span class="token number">72</span> <span class="token comment"># Save boot messages also to boot.log</span>
<span class="token number">73</span> local7.*                                                /var/log/boot.log
<span class="token number">74</span> local6.*                                                /var/log/haproxy.log
<span class="token comment">#指定日志存放位置</span>
 
systemctl restart rsyslog.service 
<span class="token comment">#重启服务</span>

<span class="token number">192.168</span>.10.12:9999/haproxy-status
<span class="token comment">#验证访问</span>

<span class="token function">tail</span> <span class="token parameter variable">-f</span> /var/log/haproxy.log
<span class="token comment">#实时查看</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/40/7f/U8KYxXRi_o.png" alt="image-20240313122051513"></p> 
<p><img src="https://images2.imgbox.com/93/16/RxRsfzhB_o.png" alt="image-20240313122008151"></p> 
<p><img src="https://images2.imgbox.com/20/77/smPGlbOL_o.png" alt="image-20240313122228700"></p> 
<p><img src="https://images2.imgbox.com/cc/b7/pTnY3BWs_o.png" alt="image-20240313122319455"></p> 
<h4><a id="2Proxies_624"></a>2、Proxies配置</h4> 
<p><strong>官方文档</strong></p> 
<pre><code class="prism language-bash">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html<span class="token comment">#4</span>
</code></pre> 
<p><strong>相关配置详解：</strong></p> 
<pre><code class="prism language-bash">defaults <span class="token punctuation">[</span><span class="token operator">&lt;</span>name<span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token comment">#默认配置项，针对以下的frontend、backend和listen生效，可以多个name也可以没有name</span>
frontend <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>   <span class="token comment">#前端servername，类似于Nginx的一个虚拟主机 server和LVS服务集群。</span>
backend <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>   <span class="token comment">#后端服务器组，等于nginx的upstream和LVS中的RS服务器</span>
listen  <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>   <span class="token comment">#将frontend和backend合并在一起配置，相对于frontend和backend配置更简洁，生产常用</span>
</code></pre> 
<p>注意：name字段只能使用大小写字母，数字，‘-’(dash)，‘_‘(underscore)，’.’ (dot)和 ‘:’(colon)，并且严格区分大小写。</p> 
<h5><a id="21_Proxiesdefaults_643"></a>2.1 Proxies配置-defaults</h5> 
<p><strong>defaults 配置参数：</strong></p> 
<pre><code class="prism language-bash">option redispatch    			<span class="token comment">#当server Id对应的服务器挂掉后，强制定向到其他健康的服务器，重新派发</span>
option abortonclose   			<span class="token comment">#当服务器负载很高时，自动结束掉当前队列处理比较久的连接，针对业务情况选择开启</span>
option http-keep-alive 			<span class="token comment">#开启与客户端的会话保持</span>
option forwardfor     			<span class="token comment">#透传客户端真实IP至后端web服务器</span>
mode http<span class="token operator">|</span>tcp 					<span class="token comment">#设置默认工作类型,使用TCP服务器性能更好，减少压力</span>
<span class="token function">timeout</span> http-keep-alive 120s 	<span class="token comment">#session 会话保持超时时间，此时间段内会转发到相同的后端服务器</span>
<span class="token function">timeout</span> connect 120s 			<span class="token comment">#客户端请求从haproxy到后端server最长连接等待时间(TCP连接之前)，默认单位ms</span>
<span class="token function">timeout</span> server 600s 			<span class="token comment">#客户端请求从haproxy到后端服务端的请求处理超时时长(TCP连接之后)，默认单位ms，如果超时，会出现502错误，此值建议设置较大些，防止502错误</span>
<span class="token function">timeout</span> client 600s 			<span class="token comment">#设置haproxy与客户端的最长非活动时间，默认单位ms，建议和timeout server相同</span>
<span class="token function">timeout</span> check   5s   			<span class="token comment">#对后端服务器的默认检测超时时间</span>
default-server inter <span class="token number">1000</span> weight <span class="token number">3</span>   <span class="token comment">#指定后端服务器的默认设置</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token number">1</span>、调度服务器（地址：192.168.10.12）
<span class="token comment">#修改配置文件（负载均衡配置）</span>
<span class="token function">vim</span> /etc/haproxy/haproxy.cfg
listen  xxx_http_80
 <span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.10.12:80
 log global
 server rs1  <span class="token number">192.168</span>.10.11
 server rs2  <span class="token number">192.168</span>.10.13

systemctl restart haproxy.service
<span class="token comment">#重启服务</span>


<span class="token number">2</span>、后端服务器（地址：192.168.10.11、192.168.10.13）
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> httpd
<span class="token comment">#安装httpd服务</span>

systemctl start httpd
<span class="token comment">#开启服务</span>

<span class="token builtin class-name">cd</span> /var/www/html
<span class="token comment">#切换目录</span>

<span class="token builtin class-name">echo</span> this is <span class="token number">192.168</span>.10.11 <span class="token operator">&gt;</span> index.html
<span class="token comment">#写入页面内容</span>

<span class="token builtin class-name">echo</span> this is <span class="token number">192.168</span>.10.13 <span class="token operator">&gt;</span> index.html
<span class="token comment">#写入页面内容</span>


<span class="token number">3</span>、访问验证（使用客户端访问）
<span class="token function">curl</span> <span class="token number">192.168</span>.10.12
<span class="token comment">#后端服务器页面交替显示</span>

systemctl stop httpd
<span class="token comment">#关闭一台后端服务器</span>

<span class="token function">curl</span> <span class="token number">192.168</span>.10.12
<span class="token comment">#访问时，依旧会访问关闭的后端服务器</span>

<span class="token comment">#修改配置文件（负载均衡配置）</span>
<span class="token function">vim</span> /etc/haproxy/haproxy.cfg
 server rs1  <span class="token number">192.168</span>.10.11:80  check
 server rs2  <span class="token number">192.168</span>.10.13:80  check
 <span class="token comment">#在配置文件中加入健康性检测，添加端口号</span>

systemctl restart haproxy.service
<span class="token comment">#重启服务</span>

<span class="token function">curl</span> <span class="token number">192.168</span>.10.12
<span class="token comment">#此时访问调度服务器，不会再去访问关闭的后端服务器</span>
</code></pre> 
<ul><li>调度服务器配置</li></ul> 
<p><img src="https://images2.imgbox.com/68/c9/Ovi4g6Ro_o.png" alt="image-20240313140248279"></p> 
<ul><li>后端服务器配置</li></ul> 
<p><img src="https://images2.imgbox.com/c8/5b/oYspwLJz_o.png" alt="image-20240313142750820"></p> 
<p><img src="https://images2.imgbox.com/42/89/PLx5hhzt_o.png" alt="image-20240313142615418"></p> 
<ul><li>验证</li></ul> 
<p><img src="https://images2.imgbox.com/bc/07/Q2g5xnQQ_o.png" alt="image-20240313143104649"></p> 
<ul><li>关闭一台后端服务器再访问，依旧会访问，没有健康性检测</li></ul> 
<p><img src="https://images2.imgbox.com/8a/d7/xfT9OPEZ_o.png" alt="image-20240313143325853"></p> 
<p><img src="https://images2.imgbox.com/61/91/nJBnwnCz_o.png" alt="image-20240313143539845"></p> 
<ul><li>配置文件中加入健康检测，添加端口号</li></ul> 
<p><img src="https://images2.imgbox.com/4d/45/XcFbjZVa_o.png" alt="image-20240313143919729"></p> 
<p><img src="https://images2.imgbox.com/38/27/UTrxbwax_o.png" alt="image-20240313144040177"></p> 
<h5><a id="22_Proxies__listen__741"></a>2.2 Proxies 配置 -listen 简化配置</h5> 
<ul><li>使用listen替换 frontend和backend的配置方式，可以简化设置，通常只用于TCP协议的应用</li></ul> 
<pre><code class="prism language-bash"><span class="token comment">#官网业务访问入口</span>
listen WEB_PORT_80    <span class="token comment">#业务名称</span>
   <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80   <span class="token comment">#ip加端口</span>
   mode http          <span class="token comment">#默认 可以不写</span>
   option forwardfor  <span class="token comment">#透传客户端真实IP至后端web服务器</span>
   server web1   <span class="token number">10.0</span>.0.17:8080   check inter <span class="token number">3000</span> fall <span class="token number">3</span> rise <span class="token number">5</span>
   server web2   <span class="token number">10.0</span>.0.27:8080   check inter <span class="token number">3000</span> fall <span class="token number">3</span> rise <span class="token number">5</span>
</code></pre> 
<h5><a id="23_Proxies__frontend_756"></a>2.3 Proxies 配置 -frontend</h5> 
<p><strong>frontend配置参数：</strong></p> 
<pre><code class="prism language-bash">bind： <span class="token comment">#指定HAProxy的监听地址，可以是IPV4或IPV6，可以同时监听多个IP或端口，可同时用于listen字段中</span>

<span class="token comment">#格式：</span>
<span class="token builtin class-name">bind</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>address<span class="token operator">&gt;</span><span class="token punctuation">]</span>:<span class="token operator">&lt;</span>port_range<span class="token operator">&gt;</span> <span class="token punctuation">[</span>, <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>param*<span class="token punctuation">]</span>
<span class="token comment">#注意：如果需要绑定在非本机的IP，需要开启内核参数：net.ipv4.ip_nonlocal_bind=1</span>

backlog <span class="token operator">&lt;</span>backlog<span class="token operator">&gt;</span> <span class="token comment">#针对所有server配置,当前端服务器的连接数达到上限后的后援队列长度，注意：不支持backend</span>
</code></pre> 
<ul><li><strong>相关配置详解：</strong></li></ul> 
<pre><code class="prism language-bash">listen http_proxy <span class="token comment">#监听http的多个IP的多个端口和sock文件</span>
   <span class="token builtin class-name">bind</span> :80,:443,:8801-8810
   <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.1:10080,10.0.0.1:10443
   <span class="token builtin class-name">bind</span> /var/run/ssl-frontend.sock user root mode <span class="token number">600</span> accept-proxy

listen http_https_proxy <span class="token comment">#https监听</span>
   <span class="token builtin class-name">bind</span> :80
   <span class="token builtin class-name">bind</span> :443 ssl crt /etc/haproxy/site.pem <span class="token comment">#公钥和私钥公共文件</span>

listen http_https_proxy_explicit <span class="token comment">#监听ipv6、ipv4和unix sock文件</span>
   <span class="token builtin class-name">bind</span> ipv6@:80
   <span class="token builtin class-name">bind</span> ipv4@public_ssl:443 ssl crt /etc/haproxy/site.pem
   <span class="token builtin class-name">bind</span> unix@ssl-frontend.sock user root mode <span class="token number">600</span> accept-proxy

listen external_bind_app1 <span class="token comment">#监听file descriptor</span>
   <span class="token builtin class-name">bind</span> <span class="token string">"fd@<span class="token variable">${FD_APP1}</span>"</span>
</code></pre> 
<pre><code class="prism language-bash">frontend xx_web_port <span class="token comment">#可以采用后面形式命名：业务-服务-端口号</span>
   <span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.10.14:80
   use_backend <span class="token operator">&lt;</span>backend_name<span class="token operator">&gt;</span>  <span class="token comment">#调用的后端服务器组名称</span>
   
 backend  xx_web   <span class="token comment">#调给后端服务器</span>
   server rs1  <span class="token number">192.168</span>.10.11:80  check
   server rs2  <span class="token number">192.168</span>.10.13:80  check
</code></pre> 
<h5><a id="24_Proxies__backend_801"></a>2.4 Proxies 配置 -backend</h5> 
<ul><li>定义一组后端服务器，backend服务器将被frontend进行调用。</li></ul> 
<p>注意: backend 的名称必须唯一,并且必须在listen或frontend中事先定义才可以使用,否则服务无法启动</p> 
<pre><code class="prism language-bash">mode http<span class="token operator">|</span>tcp     <span class="token comment">#指定负载协议类型,和对应的frontend必须一致</span>
option <span class="token comment">#配置选项</span>
server   <span class="token comment">#定义后端real server,必须指定IP和端口</span>
</code></pre> 
<ul><li><strong>server 配置</strong></li></ul> 
<pre><code class="prism language-bash"><span class="token comment">#针对一个server配置</span>
check <span class="token comment">#对指定real进行健康状态检查，如果不加此设置，默认不开启检查,只有check后面没</span>
有其它配置也可以启用检查功能
 <span class="token comment">#默认对相应的后端服务器IP和端口,利用TCP连接进行周期性健康性检查,注意必须指定</span>
端口才能实现健康性检查
 addr <span class="token operator">&lt;</span>IP<span class="token operator">&gt;</span>   <span class="token comment">#可指定的健康状态监测IP，可以是专门的数据网段，减少业务网络的流量</span>
 port <span class="token operator">&lt;</span>num<span class="token operator">&gt;</span> <span class="token comment">#指定的健康状态监测端口</span>
 inter <span class="token operator">&lt;</span>num<span class="token operator">&gt;</span> <span class="token comment">#健康状态检查间隔时间，默认2000 ms</span>
 fall <span class="token operator">&lt;</span>num<span class="token operator">&gt;</span>   <span class="token comment">#后端服务器从线上转为线下的检查的连续失效次数，默认为3</span>
 rise <span class="token operator">&lt;</span>num<span class="token operator">&gt;</span>   <span class="token comment">#后端服务器从下线恢复上线的检查的连续有效次数，默认为2</span>
weight <span class="token operator">&lt;</span>weight<span class="token operator">&gt;</span> <span class="token comment">#默认为1，最大值为256，0(状态为蓝色)表示不参与负载均衡，但仍接受持久连</span>
接
backup <span class="token comment">#将后端服务器标记为备份状态,只在所有非备份主机down机时提供服务，类似</span>
Sorry Server
disabled <span class="token comment">#将后端服务器标记为不可用状态，即维护状态，除了持久模式，将不再接受连接,</span>
状态为深黄色,优雅下线,不再接受新用户的请求
redirect prefix http://www.baidu.com/ <span class="token comment">#将请求临时(302)重定向至其它URL，只适用于</span>
http模式
redir http://www.baidu.com       <span class="token comment">#将请求临时(302)重定向至其它URL，只适用于</span>
http模式
maxconn <span class="token operator">&lt;</span>maxconn<span class="token operator">&gt;</span> <span class="token comment">#当前后端server的最大并发连接数</span>
</code></pre> 
<p><strong>拓展：</strong></p> 
<p><strong>四层</strong></p> 
<ul><li>LVS：Linux Virtual Server</li><li>Nginx：</li><li>HAProxy：High Availability Proxy</li></ul> 
<p><strong>七层</strong></p> 
<ul><li>HAProxy</li><li>Nginx</li></ul> 
<p><strong>硬件</strong></p> 
<ul><li> <p>F5</p> <pre><code class="prism language-bash"> https://f5.com/zh
</code></pre> </li><li> <p>Netscaler</p> <pre><code class="prism language-bash">https://www.citrix.com.cn/products/citrix-adc/
</code></pre> </li><li> <p>Array</p> <pre><code class="prism language-bash">https://www.arraynetworks.com.cn/
</code></pre> </li><li> <p>深信服</p> <pre><code class="prism language-bash">http://www.sangfor.com.cn/
</code></pre> </li><li> <p>北京灵州</p> <pre><code class="prism language-bash">http://www.lingzhou.com.cn/cpzx/llfzjh/
</code></pre> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d39b7ab4936b4de2c0ed0692b611bb96/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python爬虫基础学习-互联网、HTTP与HTML</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/432bc64575e056b75a77d314e6ecca0b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Guava Cache LoadingCache 基本使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>