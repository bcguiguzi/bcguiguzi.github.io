<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>macOS上基于httpd-dav搭建WebDav服务 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="macOS上基于httpd-dav搭建WebDav服务" />
<meta property="og:description" content="文章目录 配置 Apache httpd修改 ServerName启动验证 httpd 服务启用 Dav 扩展服务配置 配置 httpd 扩展 Dav 服务设置共享目录文件夹配置 DavLockDB 目录创建 WebDAV 访客用户 httpd-dav.conf 主要改动部分BasicDigest共享多个目录 授予 httpd 完全磁盘访问权限验证更新配置重启Apache Httpd局域网连接验证WebDAV服务 在局域网中，要想共享或访问 macOS 机器上的文件，可以通过文件共享、屏幕共享或 远程登录 这几种方式：
FS（SMB）: Set up file sharing on Mac，Control access to your Public folder on Mac。SSH&#43;SFTP: Allow a remote computer to access your MacScreen Sharing（VNC）: Turn Mac screen sharing on or off，Share the screen of another Mac。RD: Enable remote management for Remote Desktop 以上几种方式，基本都涉及到复杂的分级账户和ACL权限控制问题。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/a2a55600fb1d74c3880fec9150b12bb2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-16T23:14:19+08:00" />
<meta property="article:modified_time" content="2024-03-16T23:14:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">macOS上基于httpd-dav搭建WebDav服务</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_Apache_httpd_20" rel="nofollow">配置 Apache httpd</a></li><li><ul><li><a href="#_ServerName_38" rel="nofollow">修改 ServerName</a></li><li><a href="#_httpd__52" rel="nofollow">启动验证 httpd 服务</a></li><li><a href="#_Dav__83" rel="nofollow">启用 Dav 扩展服务配置</a></li></ul> 
   </li><li><a href="#_httpd__Dav__102" rel="nofollow">配置 httpd 扩展 Dav 服务</a></li><li><ul><li><a href="#_114" rel="nofollow">设置共享目录文件夹</a></li><li><a href="#_DavLockDB__143" rel="nofollow">配置 DavLockDB 目录</a></li><li><a href="#_WebDAV__160" rel="nofollow">创建 WebDAV 访客用户</a></li></ul> 
   </li><li><a href="#httpddavconf__187" rel="nofollow">httpd-dav.conf 主要改动部分</a></li><li><ul><li><a href="#Basic_189" rel="nofollow">Basic</a></li><li><a href="#Digest_220" rel="nofollow">Digest</a></li><li><a href="#_253" rel="nofollow">共享多个目录</a></li></ul> 
   </li><li><a href="#_httpd__277" rel="nofollow">授予 httpd 完全磁盘访问权限</a></li><li><a href="#Apache_Httpd_287" rel="nofollow">验证更新配置重启Apache Httpd</a></li><li><a href="#WebDAV_295" rel="nofollow">局域网连接验证WebDAV服务</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>在局域网中，要想共享或访问 macOS 机器上的文件，可以通过文件共享、屏幕共享或 <a href="https://apple.stackexchange.com/questions/278744/command-line-enable-remote-login-and-remote-management" rel="nofollow">远程登录</a> 这几种方式：</p> 
<ol><li><strong>FS</strong>（SMB）: <a href="https://support.apple.com/zh-sg/guide/mac-help/mh17131/mac" rel="nofollow">Set up file sharing on Mac</a>，<a href="https://support.apple.com/zh-sg/guide/mac-help/mchlp1775/mac" rel="nofollow">Control access to your Public folder on Mac</a>。</li><li><strong>SSH</strong>+SFTP: <a href="https://support.apple.com/en-hk/guide/mac-help/mchlp1066/mac" rel="nofollow">Allow a remote computer to access your Mac</a></li><li><strong>Screen Sharing</strong>（VNC）: <a href="https://support.apple.com/en-hk/guide/mac-help/mh11848/mac" rel="nofollow">Turn Mac screen sharing on or off</a>，<a href="https://support.apple.com/en-hk/guide/mac-help/mh14066/mac" rel="nofollow">Share the screen of another Mac</a>。</li><li><strong>RD</strong>: <a href="https://support.apple.com/en-hk/guide/remote-desktop/apd8b1c65bd/mac" rel="nofollow">Enable remote management for Remote Desktop</a></li></ol> 
<p>以上几种方式，基本都涉及到复杂的分级账户和ACL权限控制问题。</p> 
<p>在多终端设备时代，很多人都购买了在线网络云盘服务，或者自己动手DIY搭建部署家庭局域网NAS私有云服务器，作为家里的数据和影音中心，方便文件共享和存储备份同步。另一个日益增长的需求就是分布式协作，Google文档、腾讯文档等产品就是解决这类问题的在线协同编辑的办公软件。</p> 
<p>早在1996年，加州大学尔湾分校博士毕业生Jim Whitehead就与W3C共同主办了两场会议讨论了万维网上的分布式创作问题，并成立了WebDAV工作小组。</p> 
<p><strong>WebDAV</strong> 是 Web-based Distributed Authoring and Versioning 的缩写，即基于Web的分布式编写和版本控制。它是对 HTTP 的扩展，为用户在服务器上创建、更改和移动文档提供了一个框架，方便用户间协同编辑和管理存储在万维网服务器上的文档。</p> 
<p>因为基于HTTP，WebDAV 在广域网上共享文件有天然的优势，移动端文件管理APP大多都支持WebDAV协议，使用HTTPS还能保安全性。微软的Office和自家Sharepoint服务器通信，苹果的iWork套件也是基于WebDAV。Apache和Nginx都扩展支持WebDAV，可作为WebDAV文件共享服务器软件。</p> 
<p>本文记录了在 macOS 上基于内置的 Apache Httpd 搭建 WebDAV 服务的步骤流程，以供备忘和参考。</p> 
<h3><a id="_Apache_httpd_20"></a>配置 Apache httpd</h3> 
<p>Apache Httpd 配置文件：/etc/apache2/httpd.conf。</p> 
<pre><code class="prism language-Shell">$ cd /etc/apache2/
//  备份文件，以防不测
$ sudo cp httpd.conf httpd.conf.bak
$ sudo vim httpd.conf
</code></pre> 
<p>默认的文档服务目录：</p> 
<pre><code class="prism language-Shell">DocumentRoot "/Library/WebServer/Documents"
&lt;Directory "/Library/WebServer/Documents"&gt;
</code></pre> 
<h4><a id="_ServerName_38"></a>修改 ServerName</h4> 
<p>通过以下命令获取主机名：</p> 
<ul><li>hostname</li><li>scutil --get ComputerName</li><li>scutil --get LocalHostName</li></ul> 
<p>搜索 ServerName 注释行，设置与主机名称一致</p> 
<pre><code class="prism language-Shell">ServerName mbpa1398:80
</code></pre> 
<h4><a id="_httpd__52"></a>启动验证 httpd 服务</h4> 
<p>由于尚未配置 webdav 扩展服务，暂时先不管 webDAV 服务，先把 httpd server 跑起来。</p> 
<p>请检查 wfsctl status 是否为禁用状态：</p> 
<pre><code class="prism language-Shell">$ sudo wfsctl status
disabled
</code></pre> 
<p>如果否，请先执行 <code>sudo wfsctl stop</code> 停止，否则可能会有端口冲突等问题导致后续无法访问。</p> 
<hr> 
<p>执行 <code>sudo apachectl -k start</code> 启动 Apache Httpd 服务，然后在本地命令行输入 <code>curl localhost</code>，正常应返回 DocumentRoot 下的 index.html.en 页面：</p> 
<pre><code class="prism language-HTML">&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre> 
<p>或在浏览器输入 <a href="http://localhost" rel="nofollow">http://localhost</a> 或 <a href="http://mbpa1398.local" rel="nofollow">http://mbpa1398.local</a> 看看是否正常输出 <code>It works!</code> 。</p> 
<p><a href="https://httpd.apache.org/docs/2.4/en/stopping.html" rel="nofollow">Stopping and Restarting Apache HTTP Server - Apache HTTP Server Version 2.4</a></p> 
<pre><code class="prism language-Shell"># 停止内置 Apache 方法
sudo apachectl -k stop
sudo launchctl unload -w /System/Library/LaunchDaemons/org.apache.httpd.plist 2&gt;/dev/null
</code></pre> 
<h4><a id="_Dav__83"></a>启用 Dav 扩展服务配置</h4> 
<p>移除以下配置文件中 5 行行首的注释：</p> 
<pre><code class="prism language-Shell"> 92 #LoadModule auth_digest_module libexec/apache2/mod_auth_digest.so
165 #LoadModule dav_module libexec/apache2/mod_dav.so
176 #LoadModule dav_fs_module libexec/apache2/mod_dav_fs.so
177 #LoadModule dav_lock_module libexec/apache2/mod_dav_lock.so

533 #Include /private/etc/apache2/extra/httpd-dav.conf
</code></pre> 
<ol><li>LoadModule 加载 mod_dav 相关的三个动态库和用于 digest auth 验证的动态库。</li><li>Include 包含（引入）dav 扩展服务配置（extra/httpd-dav.conf）。</li></ol> 
<blockquote> 
 <p>如果使用默认的认证方式 AuthType Digest，则需加载 mod_auth_digest.so。<br> 如果改为 Basic，默认已经加载了 mod_auth_basic.so，无需加载 mod_auth_digest.so。</p> 
</blockquote> 
<h3><a id="_httpd__Dav__102"></a>配置 httpd 扩展 Dav 服务</h3> 
<p>Httpd 的 Dav 扩展服务配置文件：/etc/apache2/extra/httpd-dav.conf。</p> 
<pre><code class="prism language-Shell">$ cd extra
# 备份配置文件
$ sudo cp httpd-dav.conf httpd-dav.conf.bak
# 编辑配置文件
$ sudo vim httpd-dav.conf
</code></pre> 
<h4><a id="_114"></a>设置共享目录文件夹</h4> 
<p>第19行指定共享服务目录：/Users/faner/Public/DAVNAS。</p> 
<p>第17行设置 alias 名字为 /webdav，这个为后续访问 URL 的根路径。</p> 
<pre><code class="prism language-Shell"> 17 Alias /webdav "/Users/faner/Public/DAVNAS"
 18
 19 &lt;Directory "/Users/faner/Public/DAVNAS"&gt;
</code></pre> 
<p>httpd.conf 中指定了运行 httpd daemon 进程的用户和组：</p> 
<pre><code class="prism language-aconf">User _www
Group _www
</code></pre> 
<p>macOS 下 mkdir/touch 新创建的文件（夹），默认对 staff 工作组和 everyone 都开放了 Read Only 权限。</p> 
<p>客户端通过 HTTP Basic/Digest 认证访问 web 服务，运行 httpd 服务的 <code>_www._www</code> 用户作为 everyone，拥有对 Directory 目录的只读浏览权限。</p> 
<p>想要写共享的 Directory 目录，需要将该目录更改为 <code>_www._www</code> 用户组名下。调用 <code>chown</code> 命令即可：</p> 
<pre><code class="prism language-Shell">chown -R _www:_www /Users/faner/Public/DAVNAS
</code></pre> 
<h4><a id="_DavLockDB__143"></a>配置 DavLockDB 目录</h4> 
<p>创建 /opt/webdav/var 目录：</p> 
<pre><code class="prism language-Shell">$ sudo mkdir -p /opt/webdav/var
# -R?
$ sudo chown _www:_www /opt/webdav/var
</code></pre> 
<p>修改 httpd-dav.conf 第 15 行的 DavLockDB 路径配置：</p> 
<pre><code class="prism language-Shell"># 15 DavLockDB "/usr/var/DavLock"
15 DavLockDB /opt/webdav/var/DavLock
</code></pre> 
<h4><a id="_WebDAV__160"></a>创建 WebDAV 访客用户</h4> 
<p>新建存储密码的文件 user.passwd，并修改所属的用户和组。</p> 
<pre><code class="prism language-Shell">$ sudo touch /opt/webdav/user.passwd
$ sudo chown _www:_www /opt/webdav/user.passwd
</code></pre> 
<p>紧接着，为 webdav 域新增用户 username。</p> 
<p>如果 AuthType 是 Digest，执行 htdigest 命令：</p> 
<pre><code class="prism language-Shell">$ sudo htdigest -c /opt/webdav/user.passwd webdav $username
</code></pre> 
<p>如果 AuthType 改为了 Basic，则执行 htpasswd 命令：</p> 
<pre><code class="prism language-Shell">$ sudo htpasswd -c /opt/webdav/user.passwd $username
</code></pre> 
<p>其中， <code>-c</code> 选项将 truncate 已存在的密码文件。</p> 
<p>根据提示，为新增的用户（username）设置密码并确认。</p> 
<h3><a id="httpddavconf__187"></a>httpd-dav.conf 主要改动部分</h3> 
<h4><a id="Basic_189"></a>Basic</h4> 
<ul><li>改：DavLockDB</li><li>改：AuthName</li><li>改：AuthUserFile</li><li>注：AuthDigestProvider</li></ul> 
<pre><code class="prism language-aconf">15 DavLockDB "/opt/webdav/var/DavLock"
16
17 Alias /webdav "/Users/faner/Public/DAVNAS"
18
19 &lt;Directory "/Users/faner/Public/DAVNAS"&gt;
20     Dav On
21
22     AuthType Basic
23     AuthName webdav
24     # You can use the htdigest program to create the password database:
25     #   htdigest -c "/usr/user.passwd" $AuthName $username
26     AuthUserFile "/opt/webdav/user.passwd"
27     # AuthDigestProvider file
29
30     # Allow universal read-access, but writes are restricted
31     # to the admin user.
32     &lt;RequireAny&gt;
33        Require method GET POST OPTIONS
34        Require user $username
35    &lt;/RequireAny&gt;
36 &lt;/Directory&gt;
</code></pre> 
<h4><a id="Digest_220"></a>Digest</h4> 
<ul><li>改：DavLockDB</li><li>改：AuthName</li><li>改：AuthUserFile</li><li>增：Require valid-user</li><li>注：&lt;RequireAny&gt;…&lt;/RequireAny&gt;</li></ul> 
<pre><code class="prism language-aconf">15 DavLockDB "/opt/webdav/var/DavLock"
16
17 Alias /webdav "/Users/faner/Public/DAVNAS"
18
19 \&lt;Directory "/Users/faner/Public/DAVNAS"&gt;
20     Dav On
21
22     AuthType Digest
23     AuthName webdav
24     # You can use the htdigest program to create the password database:
25     #   htdigest -c "/usr/user.passwd" DAV-upload admin
26     AuthUserFile "/opt/webdav/user.passwd"
27     Require valid-user
28     AuthDigestProvider file
29
30     # Allow universal read-access, but writes are restricted
31     # to the admin user.
32 #    \&lt;RequireAny&gt;
33 #        Require method GET POST OPTIONS
34 #        Require user admin
35 #    \&lt;/RequireAny&gt;
36 \&lt;/Directory&gt;
</code></pre> 
<h4><a id="_253"></a>共享多个目录</h4> 
<p>建议把要共享的内容放在一个共享目录（DAVNAS），然后通过 /webdav 访问。</p> 
<p>如果有多个共享目录，可以复制 Alias、Directory，建立多组 URL 路径映射。</p> 
<pre><code class="prism language-aconf">Alias /webdav1 "/Users/faner/Public/DAVNAS1"

&lt;Directory "/Users/faner/Public/DAVNAS1"&gt;
    Dav On
    # Dav access control
&lt;/Directory&gt;

Alias /webdav2 "/Users/faner/Public/DAVNAS2"

&lt;Directory "/Users/faner/Public/DAVNAS2"&gt;
    Dav On
    # Dav access control
&lt;/Directory&gt;
</code></pre> 
<p>这样，后续就可以通过 <a href="http://192.168.0.100/webdav1" rel="nofollow">http://192.168.0.100/webdav1</a>, <a href="http://192.168.0.100/webdav2" rel="nofollow">http://192.168.0.100/webdav2</a> 分别访问不同的共享目录。</p> 
<h3><a id="_httpd__277"></a>授予 httpd 完全磁盘访问权限</h3> 
<p>将 DAVNAS 共享目录分配给 <code>_www:_www</code> 后，还得给 httpd 相关 daemon 进程分配磁盘访问权限，这样才能读写磁盘文件系统。</p> 
<p>打开 macOS 设置(System Settings)，隐私与安全性(Privacy &amp; Security)，完全磁盘访问权限(Full Disk Access)，</p> 
<p>点按左下角的 + 号，在打开的访达窗口按 Shift+Command+G 调出路径访问方式，输入 <code>/usr/sbin/httpd</code> 回车，找到 httpd 命令添加。</p> 
<p>依此方法，添加 <code>/usr/sbin/htdigest</code>（或 <code>/usr/sbin/htpasswd</code>）。</p> 
<h3><a id="Apache_Httpd_287"></a>验证更新配置重启Apache Httpd</h3> 
<p>执行 <code>apachectl configtest</code> 检查 Apache Httpd 配置文件：如果仅输出一行 <code>Syntax OK</code> 代表配置正确；否则，表示配置有问题，请按提示检查配置文件，也可查看分析问题日志 /var/log/apache2/error_log。</p> 
<p>配置文件验证无误后，执行 <code>sudo apachectl graceful</code> 重载配置文件使生效。</p> 
<p>最后，重新启动 Apache 服务器：<code>sudo apachectl -k restart</code>。</p> 
<h3><a id="WebDAV_295"></a>局域网连接验证WebDAV服务</h3> 
<p>打开本机访达（Finder），按 Command+k 连接服务器，输入 <a href="http://192.168.0.100/webdav" rel="nofollow">http://192.168.0.100/webdav</a> 或 <a href="http://mbpa1398.local/webdav/" rel="nofollow">http://mbpa1398.local/webdav/</a> ，输入在 user.passwd 中配置的账户密码，看看是否可以正常访问。</p> 
<p>本机验证通过后，在局域网其他终端（例如 Mac Finder，iPhone PDF expert）上尝试连接 webdav 服务。连接成功后，即可进行简单的多用户协作。</p> 
<p>这样，就可以将 DAVNAS 作为家庭局域网内的简陋 NAS，支持多设备共享和编辑同步文件。</p> 
<blockquote> 
 <p>需要注意的是，DAVNAS 目录隶属 <code>_www:_www</code> 用户组，所有用户请统一通过 WebDAV 客户形式以 <code>_www</code> 身份对其进行访存。</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c2f43adb247c1189d4258f28e2313566/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【毕业设计】基于微信小程序演示合集-更新中</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/157ff0edbf56219be483439374f18d5b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">力扣热题100_矩阵_240_搜索二维矩阵 II</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>