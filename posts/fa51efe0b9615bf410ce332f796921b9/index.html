<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>linux 用户空间映射,在Linux中如何从用户空间访问物理地址？ - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="linux 用户空间映射,在Linux中如何从用户空间访问物理地址？" />
<meta property="og:description" content="busybox devmem
busybox devmem是mmaps的小型CLI实用程序/dev/mem。
您可以通过以下方式在Ubuntu中获取它： sudo apt-get install busybox
用法：从物理地址读取4个字节0x12345678：
sudo busybox devmem 0x12345678
写入0x9abcdef0该地址：
sudo busybox devmem 0x12345678 w 0x9abcdef0
来源：https : //github.com/mirror/busybox/blob/1_27_2/miscutils/devmem.c#L85
mmap MAP_SHARED
映射时/dev/mem，您可能要使用：
open(&#34;/dev/mem&#34;, O_RDWR | O_SYNC);
mmap(..., PROT_READ | PROT_WRITE, MAP_SHARED, ...)
MAP_SHARED 使写操作立即进入物理内存，这使观察起来更容易，并且对硬件寄存器写操作更有意义。
CONFIG_STRICT_DEVMEM 和 nopat
要/dev/mem查看和修改内核v4.9上的常规RAM，必须首先：
禁用CONFIG_STRICT_DEVMEM(在Ubuntu 17.04上默认设置)
传递nopatx86 的内核命令行选项
没有这些端口，IO端口仍然可以工作。
另请参见：/ dev / mem的mmap失败，且virt_to_phys地址的参数无效，但是地址是页面对齐的
缓存刷新
如果您尝试写入RAM而不是寄存器，则CPU可能会缓存内存：如何在Linux中刷新CPU缓存以获取地址空间区域？而且我看不到一种非常方便/简便的方法来刷新它或将该区域标记为不可缓存：
如何使用O_DIRECT将内核空间内存(物理地址)写入文件？
如何在Linux中刷新地址空间区域的CPU缓存？
是否可以在用户空间上在Linux上分配不可缓存的内存块？
因此，也许/dev/mem不能可靠地用于将内存缓冲区传递给设备吗？
不幸的是，这在QEMU中无法观察到，因为QEMU不模拟缓存。
如何测试
现在是有趣的部分。以下是一些不错的设置：
用户区内存
volatile在用户态进程上分配变量
使用/proc//maps&#43; 获取物理地址/proc//pagemap
使用修改物理地址上的值devmem，并观察用户态过程的反应
内核内存
用以下方式分配内核内存 kmalloc" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/fa51efe0b9615bf410ce332f796921b9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-28T16:03:35+08:00" />
<meta property="article:modified_time" content="2021-04-28T16:03:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">linux 用户空间映射,在Linux中如何从用户空间访问物理地址？</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>busybox devmem</p> 
 <p>busybox devmem是mmaps的小型CLI实用程序/dev/mem。</p> 
 <p>您可以通过以下方式在Ubuntu中获取它： sudo apt-get install busybox</p> 
 <p>用法：从物理地址读取4个字节0x12345678：</p> 
 <p>sudo busybox devmem 0x12345678</p> 
 <p>写入0x9abcdef0该地址：</p> 
 <p>sudo busybox devmem 0x12345678 w 0x9abcdef0</p> 
 <p>来源：https : //github.com/mirror/busybox/blob/1_27_2/miscutils/devmem.c#L85</p> 
 <p>mmap MAP_SHARED</p> 
 <p>映射时/dev/mem，您可能要使用：</p> 
 <p>open("/dev/mem", O_RDWR | O_SYNC);</p> 
 <p>mmap(..., PROT_READ | PROT_WRITE, MAP_SHARED, ...)</p> 
 <p>MAP_SHARED 使写操作立即进入物理内存，这使观察起来更容易，并且对硬件寄存器写操作更有意义。</p> 
 <p>CONFIG_STRICT_DEVMEM 和 nopat</p> 
 <p>要/dev/mem查看和修改内核v4.9上的常规RAM，必须首先：</p> 
 <p>禁用CONFIG_STRICT_DEVMEM(在Ubuntu 17.04上默认设置)</p> 
 <p>传递nopatx86 的内核命令行选项</p> 
 <p>没有这些端口，IO端口仍然可以工作。</p> 
 <p>另请参见：/ dev / mem的mmap失败，且virt_to_phys地址的参数无效，但是地址是页面对齐的</p> 
 <p>缓存刷新</p> 
 <p>如果您尝试写入RAM而不是寄存器，则CPU可能会缓存内存：如何在Linux中刷新CPU缓存以获取地址空间区域？而且我看不到一种非常方便/简便的方法来刷新它或将该区域标记为不可缓存：</p> 
 <p>如何使用O_DIRECT将内核空间内存(物理地址)写入文件？</p> 
 <p>如何在Linux中刷新地址空间区域的CPU缓存？</p> 
 <p>是否可以在用户空间上在Linux上分配不可缓存的内存块？</p> 
 <p>因此，也许/dev/mem不能可靠地用于将内存缓冲区传递给设备吗？</p> 
 <p>不幸的是，这在QEMU中无法观察到，因为QEMU不模拟缓存。</p> 
 <p>如何测试</p> 
 <p>现在是有趣的部分。以下是一些不错的设置：</p> 
 <p>用户区内存</p> 
 <p>volatile在用户态进程上分配变量</p> 
 <p>使用/proc//maps+ 获取物理地址/proc//pagemap</p> 
 <p>使用修改物理地址上的值devmem，并观察用户态过程的反应</p> 
 <p>内核内存</p> 
 <p>用以下方式分配内核内存 kmalloc</p> 
 <p>获取物理地址virt_to_phys并将其传回用户空间</p> 
 <p>修改物理地址 devmem</p> 
 <p>从内核模块查询值</p> 
 <p>IO内存和QEMU虚拟平台设备</p> 
 <p>创建具有已知物理寄存器地址的平台设备</p> 
 <p>用于devmem写入寄存器</p> 
 <p>手表printf从虚拟设备中出来以响应</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0b82132fc48534956a3da958376448e6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring升级后切面注解代理失效</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e743a74ca9583c2532deeda25611e47c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">linux 用户空间 物理地址,在Linux中如何从用户空间访问物理地址？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>