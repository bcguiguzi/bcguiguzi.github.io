<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>backtrader 数据源相关的几个问题 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="backtrader 数据源相关的几个问题" />
<meta property="og:description" content="backtrader 是量化分析中最好框架之一，方便，功能强大。
使用backtrader之前（其他所有回测框架也一样），首先需要解决数据来源问题。
一般的文档大都一来就拿别的数据来作为示例，真正说到点子的并非很多。
本文针对自己遇到的几个问题捋一捋，希望有助于使用者。
一、数据来源
1、tushare
挖地兔的tushare是股市分析的必备数据来源，最近改善后变成了pro版，也从免费版变成了需要积分才能使用，不过好在获取基本的数据，只要注册后基本就可以使用
优点：数据准确，取数方便
缺点：没有港股等数据，需要一定积分，有一定次数限制。
方法：
（1）旧接口
ts.get_k_data(code,autype=&#39;qfq&#39;,start=start,end=end) 每次使用都会提示你接口马上要过去，请用新接口替换；前复权的参数似乎没有用了，
（2）新接口
ts.set_token(&#39;xxxx token&#39;) #请用申请到的token取代 pro = ts.pro_api() ts.pro_bar(ts_code=sCode, adj=sadj,start_date=sDate, end_date=eDate) # 带入参数 具体就不说了，可以参考挖地兔的文档。注意的是调用次数有限制。
2、东方财富
另一个数据源是各个网站，我自己使用感觉东方财富不错，基本上看得到的数据都能拿到。
其他如新浪等，虽然有一些接口，但网上语焉不详，大部分只有个别例子，Yahoo数据本来是比价受欢迎，可惜经常会因为在国外被墙，没办法使用。
例如：
tushare 缺少的港股数据，东方财富可以比较简单抓到：
def getHKCode(sDate,eDate): # 根据开始和结束日期获取港股数据 url = &#34;http://datainterface3.eastmoney.com/EM_DataCenter_V3/api/GDZC/GetGDZC?tkn=eastmoney&amp;cfg=gdzc&amp;secucode=&amp;fx=&amp;sharehdname=&amp;pageSize=500&amp;pageNum=1&amp;sortFields=BDJZ&amp;sortDirec=1&amp;startDate=&#34;&#43;sDate&#43;&#34;&amp;endDate=&#34;&#43;eDate response=requests.get(url) items={} items=response.text items=eval(items) item=items[&#34;Data&#34;][0] lsData=[] for i in item[&#34;Data&#34;]: i=i.split(&#39;|&#39;) lsData.append(i) return lsData 这种例子很多，而且获得数据也很快。不过东方财富估计是雇佣了不同的人写不同的接口，并没有统一的标准，需要每个接口数据导出来后自己分析。
二、读入数据
1、读入办法
（1）dataframe 数据，最典型的是从tushare读取数据。
#使用tushare旧版接口获取数据 def get_data(code,start=&#39;2010-01-01&#39;,end=&#39;2020-03-31&#39;): df=ts.get_k_data(code,autype=&#39;qfq&#39;,start=start,end=end) df.index=pd.to_datetime(df.date) df[&#39;openinterest&#39;]=0 df=df[[&#39;open&#39;,&#39;high&#39;,&#39;low&#39;,&#39;close&#39;,&#39;volume&#39;,&#39;openinterest&#39;]] return df start=datetime(2010, 3, 31) end=datetime(2020, 3, 31) # 加载数据 df = get_data(&#39;000001&#39;) data = bt." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/21de8f81eeb1b42baecbb3b9ea1db62d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-20T21:14:33+08:00" />
<meta property="article:modified_time" content="2021-09-20T21:14:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">backtrader 数据源相关的几个问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>backtrader 是量化分析中最好框架之一，方便，功能强大。<br> 使用backtrader之前（其他所有回测框架也一样），首先需要解决数据来源问题。<br> 一般的文档大都一来就拿别的数据来作为示例，真正说到点子的并非很多。<br> 本文针对自己遇到的几个问题捋一捋，希望有助于使用者。</p> 
<p>一、数据来源<br> 1、tushare<br> 挖地兔的tushare是股市分析的必备数据来源，最近改善后变成了pro版，也从免费版变成了需要积分才能使用，不过好在获取基本的数据，只要注册后基本就可以使用<br> 优点：数据准确，取数方便<br> 缺点：没有港股等数据，需要一定积分，有一定次数限制。</p> 
<p>方法：<br> （1）旧接口</p> 
<pre><code class="prism language-csharp">ts<span class="token punctuation">.</span><span class="token function">get_k_data</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span>autype<span class="token operator">=</span>'qfq'<span class="token punctuation">,</span>start<span class="token operator">=</span>start<span class="token punctuation">,</span>end<span class="token operator">=</span>end<span class="token punctuation">)</span>
</code></pre> 
<p>每次使用都会提示你接口马上要过去，请用新接口替换；前复权的参数似乎没有用了，</p> 
<p>（2）新接口</p> 
<pre><code class="prism language-csharp">ts<span class="token punctuation">.</span><span class="token function">set_token</span><span class="token punctuation">(</span>'xxxx token'<span class="token punctuation">)</span>  #请用申请到的token取代
pro <span class="token operator">=</span> ts<span class="token punctuation">.</span><span class="token function">pro_api</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ts<span class="token punctuation">.</span><span class="token function">pro_bar</span><span class="token punctuation">(</span>ts_code<span class="token operator">=</span>sCode<span class="token punctuation">,</span> adj<span class="token operator">=</span>sadj<span class="token punctuation">,</span>start_date<span class="token operator">=</span>sDate<span class="token punctuation">,</span> end_date<span class="token operator">=</span>eDate<span class="token punctuation">)</span>  # 带入参数
</code></pre> 
<p>具体就不说了，可以参考挖地兔的文档。注意的是调用次数有限制。</p> 
<p>2、东方财富<br> 另一个数据源是各个网站，我自己使用感觉东方财富不错，基本上看得到的数据都能拿到。<br> 其他如新浪等，虽然有一些接口，但网上语焉不详，大部分只有个别例子，Yahoo数据本来是比价受欢迎，可惜经常会因为在国外被墙，没办法使用。</p> 
<p>例如：<br> tushare 缺少的港股数据，东方财富可以比较简单抓到：</p> 
<pre><code class="prism language-csharp"><span class="token return-type class-name">def</span> <span class="token function">getHKCode</span><span class="token punctuation">(</span>sDate<span class="token punctuation">,</span>eDate<span class="token punctuation">)</span><span class="token punctuation">:</span>  # 根据开始和结束日期获取港股数据
    url <span class="token operator">=</span> <span class="token string">"http://datainterface3.eastmoney.com/EM_DataCenter_V3/api/GDZC/GetGDZC?tkn=eastmoney&amp;cfg=gdzc&amp;secucode=&amp;fx=&amp;sharehdname=&amp;pageSize=500&amp;pageNum=1&amp;sortFields=BDJZ&amp;sortDirec=1&amp;startDate="</span><span class="token operator">+</span>sDate<span class="token operator">+</span><span class="token string">"&amp;endDate="</span><span class="token operator">+</span><span class="token class-name">eDate</span>
    response<span class="token operator">=</span>requests<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>

    items<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    items<span class="token operator">=</span><span class="token class-name">response<span class="token punctuation">.</span>text</span>
    items<span class="token operator">=</span><span class="token function">eval</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>

    item<span class="token operator">=</span>items<span class="token punctuation">[</span><span class="token string">"Data"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    lsData<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> item<span class="token punctuation">[</span><span class="token string">"Data"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        i<span class="token operator">=</span>i<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string character">'|'</span><span class="token punctuation">)</span>
        lsData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token keyword">return</span> lsData

</code></pre> 
<p>这种例子很多，而且获得数据也很快。不过东方财富估计是雇佣了不同的人写不同的接口，并没有统一的标准，需要每个接口数据导出来后自己分析。</p> 
<p>二、读入数据<br> 1、读入办法<br> （1）dataframe 数据，最典型的是从tushare读取数据。</p> 
<pre><code class="prism language-csharp"><span class="token preprocessor property">#使用tushare旧版接口获取数据</span>
<span class="token return-type class-name">def</span> <span class="token function">get_data</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span>start<span class="token operator">=</span>'<span class="token number">2010</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span>'<span class="token punctuation">,</span>end<span class="token operator">=</span>'<span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">31</span>'<span class="token punctuation">)</span><span class="token punctuation">:</span>

    df<span class="token operator">=</span>ts<span class="token punctuation">.</span><span class="token function">get_k_data</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span>autype<span class="token operator">=</span>'qfq'<span class="token punctuation">,</span>start<span class="token operator">=</span>start<span class="token punctuation">,</span>end<span class="token operator">=</span>end<span class="token punctuation">)</span>
    df<span class="token punctuation">.</span>index<span class="token operator">=</span>pd<span class="token punctuation">.</span><span class="token function">to_datetime</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>date<span class="token punctuation">)</span>
    df<span class="token punctuation">[</span>'openinterest'<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>
    df<span class="token operator">=</span>df<span class="token punctuation">[</span><span class="token punctuation">[</span>'open<span class="token string character">','</span>high<span class="token string character">','</span>low<span class="token string character">','</span>close<span class="token string character">','</span>volume<span class="token string character">','</span>openinterest'<span class="token punctuation">]</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> <span class="token class-name">df</span>         

start<span class="token operator">=</span>datetime<span class="token class-name"><span class="token punctuation">(</span>2010<span class="token punctuation">,</span> 3<span class="token punctuation">,</span> 31<span class="token punctuation">)</span></span>
end<span class="token operator">=</span><span class="token function">datetime</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span>
<span class="token preprocessor property"># 加载数据</span>
df <span class="token operator">=</span> <span class="token function">get_data</span><span class="token punctuation">(</span>'<span class="token number">000001</span>'<span class="token punctuation">)</span>
data <span class="token operator">=</span> bt<span class="token punctuation">.</span>feeds<span class="token punctuation">.</span><span class="token function">PandasData</span><span class="token punctuation">(</span>dataname<span class="token operator">=</span>df<span class="token punctuation">,</span>fromdate<span class="token operator">=</span>start<span class="token punctuation">,</span>todate<span class="token operator">=</span>end<span class="token punctuation">)</span>

</code></pre> 
<p>这种方法读到的数据是 class ‘backtrader.feeds.pandafeed.PandasData’</p> 
<p>（2）csv 格式</p> 
<pre><code class="prism language-csharp"><span class="token preprocessor property"># 先找到脚本的位置，然后根据脚本与数据的相对路径关系找到数据位置</span>
<span class="token preprocessor property"># 这样脚本从任意地方被调用，都可以正确地访问到数据</span>
modpath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">abspath</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
datapath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token keyword">join</span><span class="token punctuation">(</span>modpath<span class="token punctuation">,</span> '<span class="token number">000001</span><span class="token punctuation">.</span>csv'<span class="token punctuation">)</span>
<span class="token preprocessor property"># 创建价格数据</span>
data <span class="token operator">=</span> bt<span class="token punctuation">.</span>feeds<span class="token punctuation">.</span><span class="token function">GenericCSVData</span><span class="token punctuation">(</span>
        dataname <span class="token operator">=</span> datapath<span class="token punctuation">,</span>
        fromdate <span class="token operator">=</span> <span class="token function">datetime</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        todate <span class="token operator">=</span> <span class="token function">datetime</span><span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        nullvalue <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
        dtformat <span class="token operator">=</span> <span class="token punctuation">(</span>'<span class="token operator">%</span>Y<span class="token operator">-</span><span class="token operator">%</span>m<span class="token operator">-</span><span class="token operator">%</span>d'<span class="token punctuation">)</span><span class="token punctuation">,</span>
        datetime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        open <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        high <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
        low <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
        close <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
        volume <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
        openinterest <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token punctuation">)</span>
</code></pre> 
<p>读到的数据格式是 class ‘backtrader.feeds.csvgeneric.GenericCSVData’</p> 
<p>需要注意：<br> 数据都不能用print直接输出，只能在策略中使用，采用backtrader的索引办法取数<br> 数据格式中，只能容纳7列数据，即datetime，open，high，low，close，volume，openinterest（未平仓合约，国内股市数据一般用不到）<br> 如果需要其他数据，则需要自己去扩展这些类</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cf55078cdd3204a11d9d0e3336a3a250/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">❤️ 单例模式：中秋佳节C站陪你不孤单 ❤️</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6d02cfeb4034b29cdc64d7a11b860619/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【A】RHEL 6 中误删 libc.so.6 文件后恢复</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>