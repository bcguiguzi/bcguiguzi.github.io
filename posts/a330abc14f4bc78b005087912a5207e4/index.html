<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android筑基——Gson 框架学习笔记 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android筑基——Gson 框架学习笔记" />
<meta property="og:description" content="目录 1 前言2 正文2.1 基本使用简单的类泛型类解决反序列化为泛型类的异常 2.2 使用 Gson 框架提供的注解`@SerializedName` 注解`@Expose` 注解 2.3 使用 Gson 框架提供的配置使用 `serializeNulls()` 配置，强制序列化 `null` 值使用 `setPrettyPrinting()` 配置，格式化 json 字符串打印使用`disableHtmlEscaping()` 配置，去除 html 字符转义使用 `setExclusionStrategies(ExclusionStrategy... strategies)` 配置，添加灵活的排除策略 2.4 自定义 Gson 的序列化与反序列化使用 `JsonSerializer` 自定义序列化使用 `JsonDeserializer` 自定义反序列化使用 `InstanceCreator` 自定义反序列化使用`TypeAdapter` 自定义序列化与反序列化 2.5 源码里的解析过程 3 最后参考 1 前言 在 Android 开发中，常使用 Gson 框架来进行 Java 对象的序列化与 json 数据的反序列化。
本文会通过实际的例子逐步深入地展示 Gson 框架的使用，希望能够帮助同学们更好地开发。
2 正文 2.1 基本使用 使用 Gson 对象的 toJson() 和 fromJson() 来进行 Java 对象的序列化，json 数据的反序列化。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/a330abc14f4bc78b005087912a5207e4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-31T06:56:14+08:00" />
<meta property="article:modified_time" content="2021-05-31T06:56:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android筑基——Gson 框架学习笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#1__1" rel="nofollow">1 前言</a></li><li><a href="#2__5" rel="nofollow">2 正文</a></li><li><ul><li><a href="#21__6" rel="nofollow">2.1 基本使用</a></li><li><ul><li><a href="#_12" rel="nofollow">简单的类</a></li><li><a href="#_58" rel="nofollow">泛型类</a></li><li><a href="#_139" rel="nofollow">解决反序列化为泛型类的异常</a></li></ul> 
   </li><li><a href="#22__Gson__182" rel="nofollow">2.2 使用 Gson 框架提供的注解</a></li><li><ul><li><a href="#SerializedName__183" rel="nofollow">`@SerializedName` 注解</a></li><li><a href="#Expose__416" rel="nofollow">`@Expose` 注解</a></li></ul> 
   </li><li><a href="#23__Gson__492" rel="nofollow">2.3 使用 Gson 框架提供的配置</a></li><li><ul><li><a href="#_serializeNulls__null__493" rel="nofollow">使用 `serializeNulls()` 配置，强制序列化 `null` 值</a></li><li><a href="#_setPrettyPrinting__json__532" rel="nofollow">使用 `setPrettyPrinting()` 配置，格式化 json 字符串打印</a></li><li><a href="#disableHtmlEscaping__html__585" rel="nofollow">使用`disableHtmlEscaping()` 配置，去除 html 字符转义</a></li><li><a href="#_setExclusionStrategiesExclusionStrategy_strategies__616" rel="nofollow">使用 `setExclusionStrategies(ExclusionStrategy... strategies)` 配置，添加灵活的排除策略</a></li></ul> 
   </li><li><a href="#24__Gson__675" rel="nofollow">2.4 自定义 Gson 的序列化与反序列化</a></li><li><ul><li><a href="#_JsonSerializer__706" rel="nofollow">使用 `JsonSerializer` 自定义序列化</a></li><li><a href="#_JsonDeserializer__840" rel="nofollow">使用 `JsonDeserializer` 自定义反序列化</a></li><li><a href="#_InstanceCreator__923" rel="nofollow">使用 `InstanceCreator` 自定义反序列化</a></li><li><a href="#TypeAdapter__1034" rel="nofollow">使用`TypeAdapter` 自定义序列化与反序列化</a></li></ul> 
   </li><li><a href="#25__1080" rel="nofollow">2.5 源码里的解析过程</a></li></ul> 
  </li><li><a href="#3__1420" rel="nofollow">3 最后</a></li><li><ul><li><a href="#_1431" rel="nofollow">参考</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1__1"></a>1 前言</h2> 
<p>在 Android 开发中，常使用 Gson 框架来进行 Java 对象的序列化与 json 数据的反序列化。</p> 
<p>本文会通过实际的例子逐步深入地展示 Gson 框架的使用，希望能够帮助同学们更好地开发。</p> 
<h2><a id="2__5"></a>2 正文</h2> 
<h3><a id="21__6"></a>2.1 基本使用</h3> 
<p>使用 <code>Gson</code> 对象的 <code>toJson()</code> 和 <code>fromJson()</code> 来进行 Java 对象的序列化，json 数据的反序列化。<br> 打开 <code>Gson</code> 类的代码，可以看到有多组 <code>toJson()</code> 以及 <code>fromJson()</code> 方法，它们之间的调用关系如下图所示（请点击大图查看）：<br> <img src="https://images2.imgbox.com/c9/4c/GF8rV8Ep_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a4/33/A16Rjgye_o.png" alt="在这里插入图片描述"><br> 看完上面的调用关系图，我们接着看一下 <code>toJson()</code> 和 <code>fromJson()</code> 方法的使用吧。</p> 
<h4><a id="_12"></a>简单的类</h4> 
<p>首先定义一个简单的类，<code>Person</code> 类：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"Person{"</span> <span class="token operator">+</span>
                <span class="token string">"name='"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", age="</span> <span class="token operator">+</span> age <span class="token operator">+</span>
                <span class="token string">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test01</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 序列化</span>
        <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"willwaywang6"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> personJson <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>personJson<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 反序列化</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token string">"{\"name\":\"willwaywang6\",\"age\":18}"</span><span class="token punctuation">;</span>
        <span class="token class-name">Person</span> p <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>打印结果如下：</p> 
<pre><code class="prism language-txt">{"name":"willwaywang6","age":18}
Person{name='willwaywang6', age=18}
</code></pre> 
<p>可以看到，通过创建一个 <code>Gson</code> 对象，使用 <code>toJson()</code>和 <code>fromJson()</code> 就可以实现基本的序列化与反序列化了。</p> 
<h4><a id="_58"></a>泛型类</h4> 
<p>那么，对于泛型类，还使用上面的方式处理，还会适用吗？</p> 
<p>我们引入一个泛型类：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"Response{"</span> <span class="token operator">+</span>
                <span class="token string">"code="</span> <span class="token operator">+</span> code <span class="token operator">+</span>
                <span class="token string">", message='"</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", data="</span> <span class="token operator">+</span> data <span class="token operator">+</span>
                <span class="token string">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这样的一个泛型类，在开发中常常作为接收服务端返回的数据。</p> 
<p>先进行序列化的测试，使用 <code>Person</code> 来作为泛型类型参数的实参：</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 序列化</span>
<span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"willwaywang6"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
response<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
response<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
response<span class="token punctuation">.</span>data <span class="token operator">=</span> person<span class="token punctuation">;</span>
<span class="token class-name">String</span> responseJson <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>responseJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印结果如下：</p> 
<pre><code class="prism language-txt">{"code":0,"message":"success","data":{"name":"willwaywang6","age":18}}
</code></pre> 
<p>可以看到，对于包含泛型的类，序列化是没有问题的。</p> 
<p>接着看反序列化：</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 反序列化</span>
<span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token string">"{\"code\":0,\"message\":\"success\",\"data\":{\"name\":\"willwaywang6\",\"age\":18}}"</span><span class="token punctuation">;</span>
<span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> r <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印结果如下：</p> 
<pre><code class="prism language-text">Response{code=0, message='success', data={name=willwaywang6, age=18.0}}
</code></pre> 
<p>貌似也是正常的吧？</p> 
<p>不不不，好像有点不对啊？我们知道 <code>age</code> 的数据类型是 <code>int</code> 类型，但是打印出的怎么是 <code>age=18.0</code> 呢？</p> 
<p>这是怎么回事呢？</p> 
<p>为了一探究竟，我们就在 <code>System.out.println(r);</code> 这行打一个断点，debug 一下吧。</p> 
<p><img src="https://images2.imgbox.com/4b/e0/s2OKnviz_o.png" alt="在这里插入图片描述"><br> 看我们的截图，<code>age</code> 的类型确实变成了 <code>Double</code> 类型，关键的是 <code>Response</code> 对象的<code>data</code> 字段，它的类型是 <code>LinkedTreeMap</code>，而不是我们期望的 <code>Person</code> 类型。</p> 
<p>可能有同学会想，输出仅仅是有一个 <code>age</code> 的类型不正确而已，还是正常地反序列化了吧？不用再做别的事情了吧？</p> 
<p>为了说明这种想法的错误，我们再添加一行代码：</p> 
<pre><code class="prism language-java"><span class="token class-name">Person</span> p2 <span class="token operator">=</span> r<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
</code></pre> 
<p>目的是为了取出 <code>Response</code> 对象的 <code>data</code> 字段里的 <code>Person</code> 对象，以便程序里面进一步使用。<br> 运行程序，会看到如下报错信息：</p> 
<pre><code class="prism language-text">java.lang.ClassCastException: com.google.gson.internal.LinkedTreeMap cannot be cast to com.example.lib.basic.Person
	at com.example.lib.basic.Test02.main(Test02.java:31)
</code></pre> 
<p>类型转换异常：不能把 <code>LinkedTreeMap</code> 类型转换为 <code>Person</code> 类型。</p> 
<p>这个异常的发生是很明显的，从 debug 截图里我们可以知道，<code>data</code> 字段目前的类型是 <code>LinkedTreeMap</code>，这里把 <code>LinkedTreeMap</code> 类型转换为 <code>Person</code> 类型，当然是不可以的。</p> 
<p>因此，对于 json 需要反序列化为泛型对象，不能直接使用 <code>public &lt;T&gt; T fromJson(String json, Class&lt;T&gt; classOfT)</code> 这个方法了。</p> 
<h4><a id="_139"></a>解决反序列化为泛型类的异常</h4> 
<p>我们使用 <code>public &lt;T&gt; T fromJson(String json, Type typeOfT)</code> 这个方法来解决反序列化时失败的问题。</p> 
<p>看如下测试代码：</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 反序列化</span>
<span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token string">"{\"code\":0,\"message\":\"success\",\"data\":{\"name\":\"willwaywang6\",\"age\":18}}"</span><span class="token punctuation">;</span>
<span class="token class-name">Type</span> responseType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeToken</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> r <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> responseType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Person</span> p2 <span class="token operator">=</span> r<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    exception<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，我们先获取了 <code>Type responseType</code> 对象：</p> 
<pre><code class="prism language-java"><span class="token class-name">Type</span> responseType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeToken</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>接着把 <code>responseType</code> 传入了 <code>fromJson(String json, Type typeOfT)</code> 方法：</p> 
<pre><code class="prism language-java"><span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> r <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> responseType<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>运行一下程序，查看结果：</p> 
<pre><code class="prism language-text">Response{code=0, message='success', data=Person{name='willwaywang6', age=18}}
Person{name='willwaywang6', age=18}
</code></pre> 
<p>为了更细致地查看一下，这是还是打断点查看一下返回结果吧。</p> 
<p><img src="https://images2.imgbox.com/c5/28/cUrpCdTW_o.png" alt="在这里插入图片描述"><br> No problem！</p> 
<p>到这里，gson 框架的基本使用就完成了。</p> 
<p>但是，实际开发中，满足于 gson 的基本使用是不够的。gson 也为我们提供了一些配置来解决实际开发中的问题。</p> 
<h3><a id="22__Gson__182"></a>2.2 使用 Gson 框架提供的注解</h3> 
<h4><a id="SerializedName__183"></a><code>@SerializedName</code> 注解</h4> 
<p>看一下 <code>@SerializedName</code> 注解的定义：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>FIELD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">SerializedName</span> <span class="token punctuation">{<!-- --></span>

  <span class="token comment">/**
   * @return the desired name of the field when it is serialized or deserialized
   * 当进行序列化或反序列化时，返回期望的字段名字
   */</span>
  <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * @return the alternative names of the field when it is deserialized
   * 当进行反序列化时，返回可选的字段名字
   */</span>
  <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">alternate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下面通过例子来进行说明：</p> 
<p>现在有一个简单的 <code>Response</code> 类：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">Response</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token keyword">public</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> data<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"Response{"</span> <span class="token operator">+</span>
                <span class="token string">"code="</span> <span class="token operator">+</span> code <span class="token operator">+</span>
                <span class="token string">", message='"</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", data="</span> <span class="token operator">+</span> data <span class="token operator">+</span>
                <span class="token string">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>需求是把一个 <code>Response</code> 对象序列化为 json 后传递给服务端解析，服务端要求的 json 是这样的：</p> 
<pre><code class="prism language-text">{
	"code": 0,
	"msg": "ok",
	"content": "some data"
}
</code></pre> 
<p>如果我们不做什么处理，对 <code>Response</code> 对象进行序列化是不能满足要求的。</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 序列化</span>
<span class="token class-name">Response</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"ok"</span><span class="token punctuation">,</span> <span class="token string">"some data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> responseJson <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>responseJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印结果如下：</p> 
<pre><code class="prism language-text">{"code":0,"message":"ok","data":"some data"}
</code></pre> 
<p>这与服务端要求的 json 格式是不一致的。</p> 
<p>这时就需要用到 <code>@SerializedName</code> 注解的 <code>value</code> 元素了，在 <code>message</code> 和 <code>data</code> 字段上分别添加注解，如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">Response</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SerializedName</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SerializedName</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>再次运行程序，运行结果如下：</p> 
<pre><code class="prism language-text">{"code":0,"msg":"ok","content":"some data"}
</code></pre> 
<p>可以看到满足了需求。</p> 
<p>说完了序列化，我们遇到了一个反序列化的需求，希望把</p> 
<pre><code class="prism language-text">{"code":0,"msg":"ok","content":"some data"}
</code></pre> 
<p>反序列化一个 <code>Response</code> 对象，注意这时的 <code>Response</code> 类还没有使用任何注解。</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">Response</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试代码如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 反序列化</span>
<span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token string">"{\"code\":0,\"msg\":\"ok\",\"content\":\"some data\"}"</span><span class="token punctuation">;</span>
<span class="token class-name">Response</span> r <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印结果如下：</p> 
<pre><code class="prism language-text">Response{code=0, message='null', data=null}
</code></pre> 
<p>显然没有反序列化成功。</p> 
<p>解决办法仍是在 <code>message</code> 和 <code>data</code> 字段上分别添加注解，如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">Response</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SerializedName</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SerializedName</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>再次运行程序，查看结果：</p> 
<pre><code class="prism language-text">Response{code=0, message='ok', data=some data}
</code></pre> 
<p><strong>小结一下：</strong></p> 
<ul><li> <p>当把 Java 对象序列化为 json 字符串时，类中声明了该注解的字段会使用 <code>@SerializedName</code> 注解指定的 <code>value</code> 元素值作为 json 字符串中对应的 key；</p> </li><li> <p>当把 json 字符串反序列化为 Java 对象时，以 <code>@SerializedName</code> 注解指定的 <code>value</code> 元素值作为 key 的 value 值，会赋值给类中声明了该注解的字段。</p> </li></ul> 
<p>细心的你，有没有注意到了 <code>@SerializedName</code> 注解还有一个 <code>alternate</code> 元素？这个也十分有用，但它只作用在反序列化的过程中。</p> 
<p>通过一个场景来说明 <code>alternate</code> 元素的使用吧。</p> 
<p>现在服务端下发了这样的三组 json 字符串：</p> 
<pre><code class="prism language-text">{
	"code": 0,
	"msg": "ok",
	"content": "some data"
}
</code></pre> 
<pre><code class="prism language-text">{
	"code": 1,
	"msg": "server bang",
	"result": "blablabla"
}
</code></pre> 
<pre><code class="prism language-text">{
	"code": 2,
	"msg": "server bang",
	"result_data": "blablabla"
}
</code></pre> 
<p>看一下上面的三个 json 字符串，它们的 key 是不同的，分别为 <code>content</code>，<code>result</code>，<code>result_data</code>，在客户端它们都对应于 <code>Response</code> 类，因此客户端需要把它们都序列化为 <code>Response</code> 对象。</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">Response</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SerializedName</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SerializedName</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>来进行一下测试，查看结果：</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> json1 <span class="token operator">=</span> <span class="token string">"{\"code\":0,\"msg\":\"ok\",\"content\":\"some data\"}"</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> json2 <span class="token operator">=</span> <span class="token string">"{\"code\":1,\"msg\":\"server bang\",\"result\":\"blablabla\"}"</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> json3 <span class="token operator">=</span> <span class="token string">"{\"code\":2,\"msg\":\"server bang\",\"result_data\":\"blablabla\"}"</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json1<span class="token punctuation">,</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json2<span class="token punctuation">,</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json3<span class="token punctuation">,</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印结果：</p> 
<pre><code class="prism language-text">Response{code=0, message='ok', data=some data}
Response{code=1, message='server bang', data=null}
Response{code=2, message='server bang', data=null}
</code></pre> 
<p>可以看到，后面两个 json 字符串并没有成功反序列化 Java 对象的 <code>data</code> 字段。</p> 
<p>这时就需要用到 <code>@SerializedName</code> 注解的 <code>alternate</code> 元素了。</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">Response</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SerializedName</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SerializedName</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"content"</span><span class="token punctuation">,</span> alternate <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"result"</span><span class="token punctuation">,</span> <span class="token string">"result_data"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>再次运行，查看结果：</p> 
<pre><code class="prism language-text">Response{code=0, message='ok', data=some data}
Response{code=1, message='server bang', data=blablabla}
Response{code=2, message='server bang', data=blablabla}
</code></pre> 
<p>可以看到，成功地完成了反序列化。</p> 
<p>如果出现了这样的 json 字符串，会如何反序列化呢？</p> 
<pre><code class="prism language-text">{
	"code": 4,
	"msg": "server bang",
	"content": "some data",
	"result": "blablabla",
	"reslut_data": "plaplapla"
}
</code></pre> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 出现多个备选时的反序列化</span>
<span class="token class-name">String</span> json4 <span class="token operator">=</span> <span class="token string">"{\"code\":4,\"msg\":\"server bang\",\"content\":\"some data\",\"result\":\"blablabla\",\"result_data\":\"plaplapla\"}"</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> json5 <span class="token operator">=</span> <span class="token string">"{\"code\":5,\"msg\":\"server bang\",\"result\":\"blablabla\",\"result_data\":\"plaplapla\",\"content\":\"some data\"}"</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> json6 <span class="token operator">=</span> <span class="token string">"{\"code\":6,\"msg\":\"server bang\",\"result_data\":\"plaplapla\",\"content\":\"some data\",\"result\":\"blablabla\"}"</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json4<span class="token punctuation">,</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json5<span class="token punctuation">,</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json6<span class="token punctuation">,</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印结果如下：</p> 
<pre><code class="prism language-text">Response{code=4, message='server bang', data=plaplapla}
Response{code=5, message='server bang', data=some data}
Response{code=6, message='server bang', data=blablabla}
</code></pre> 
<p>查看打印结果，当 json 字符串中出现了 <code>alternate</code> 数组里的多个元素时，会选取最后一个赋值给类中声明了该注解的字段。</p> 
<p><strong>小结一下：</strong></p> 
<p>当把 json 字符串反序列化为 Java 对象时，以 <code>@SerializedName</code> 注解指定的 <code>alternate</code> 元素数组里的元素作为 key 的 value 值，都会赋值给类中声明了该注解的字段。</p> 
<p>当 json 字符串中出现了 <code>alternate</code> 数组里的多个元素时，会选取最后一个赋值给类中声明了该注解的字段。</p> 
<h4><a id="Expose__416"></a><code>@Expose</code> 注解</h4> 
<p>使用 <code>Expose</code> 注解，可以明显地指定某个字段是否可以序列化或反序列化。</p> 
<p>看下面的类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Expose</span>
    <span class="token class-name">String</span> firstName<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Expose</span><span class="token punctuation">(</span>deserialize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> lastName<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Expose</span><span class="token punctuation">(</span>serialize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> age<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Expose</span><span class="token punctuation">(</span>serialize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> deserialize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token class-name">String</span> phoneNumber<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>先说明各个字段参与序列化与反序列化的情况：</p> 
<table><thead><tr><th>字段名</th><th>参与序列化？</th><th>参与反序列化？</th></tr></thead><tbody><tr><td>firstName</td><td>√</td><td>√</td></tr><tr><td>lastName</td><td>√</td><td>×</td></tr><tr><td>age</td><td>×</td><td>√</td></tr><tr><td>password</td><td>×</td><td>×</td></tr><tr><td>phoneNumber</td><td>×</td><td>×</td></tr></tbody></table> 
<p>测试代码如下：</p> 
<pre><code class="prism language-java"><span class="token comment">// 序列化</span>
<span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"zhichao"</span><span class="token punctuation">,</span> <span class="token string">"wang"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">,</span> <span class="token string">"13912345678"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 反序列化</span>
<span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token string">"{\"firstName\":\"zhichao\",\"lastName\":\"wang\",\"age\":18,\"password\":\"123456\",\"phoneNumber\":\"13912345678\"}"</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>运行结果：</p> 
<pre><code class="prism language-text">{"firstName":"zhichao","lastName":"wang","age":18,"password":"123456","phoneNumber":"13912345678"}
Person{firstName='zhichao', lastName='wang', age=18, password='123456', phoneNumber='13912345678'}
</code></pre> 
<p>没有看到使用了 <code>@Expose</code> 注解的效果，所有的字段都参与了序列化与反序列化的过程。</p> 
<p>这是因为构建 <code>Gson</code> 对象的方式以及没有添加 <code>excludeFieldsWithoutExposeAnnotation()</code> 配置，修改创建 <code>Gson</code> 对象的代码为：</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">excludeFieldsWithoutExposeAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>再次运行程序，如下：</p> 
<pre><code class="prism language-text">{"firstName":"zhichao","lastName":"wang"}
Person{firstName='zhichao', lastName='null', age=18, password='null', phoneNumber='null'}
</code></pre> 
<p>对照上面给出的表格，再看一下：</p> 
<table><thead><tr><th>字段名</th><th>参与序列化？</th><th>参与反序列化？</th></tr></thead><tbody><tr><td>firstName</td><td>√</td><td>√</td></tr><tr><td>lastName</td><td>√</td><td>×</td></tr><tr><td>age</td><td>×</td><td>√</td></tr><tr><td>password</td><td>×</td><td>×</td></tr><tr><td>phoneNumber</td><td>×</td><td>×</td></tr></tbody></table> 
<p>参与序列化的字段有 <code>firstName</code>、<code>lastName</code>，因此序列化后的 json 字符串是：</p> 
<pre><code class="prism language-text">{"firstName":"zhichao","lastName":"wang"}
</code></pre> 
<p>参与反序列化的字段有 <code>firstName</code>、<code>age</code>，因此反序列化后的对象打印是：</p> 
<pre><code class="prism language-text">Person{firstName='zhichao', lastName='null', age=18, password='null', phoneNumber='null'}
</code></pre> 
<p><code>@Expose</code> 与 <code>transient</code> 关键字的区别：</p> 
<p>声明了 <code>@Expose</code> 注解的字段，可以单独地控制是否进行序列化和是否进行反序列化；<br> 而使用 <code>transient</code> 关键字修饰的字段，既不可以序列化，也不可以反序列化。</p> 
<h3><a id="23__Gson__492"></a>2.3 使用 Gson 框架提供的配置</h3> 
<h4><a id="_serializeNulls__null__493"></a>使用 <code>serializeNulls()</code> 配置，强制序列化 <code>null</code> 值</h4> 
<p>现在有一个请求类 <code>RequestBean</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestBean</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 文章 id
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 文章标题
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 用户喜欢，则为 true；用户不喜欢，则为 false；用户没有选择，则为 null
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> action<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>要求是三个字段的值，都必须序列化后报给服务端。</p> 
<p>这个需求不是很难吧，看代码：</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RequestBean</span> requestBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
requestBean<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
requestBean<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">"国士无双"</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>requestBean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印结果如下：</p> 
<pre><code class="prism language-text">{"id":1,"title":"国士无双"}
</code></pre> 
<p>但是，序列化后的结果与需求不符号，因为里面并没有包含 <code>action</code> 字段的值，服务端肯定会找过来的。</p> 
<p>这时就要用到 <code>serializeNulls()</code> 配置，修改获取 <code>Gson</code> 对象的代码，如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serializeNulls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_setPrettyPrinting__json__532"></a>使用 <code>setPrettyPrinting()</code> 配置，格式化 json 字符串打印</h4> 
<p>现在有一个 <code>UserBean</code> 类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserBean</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> userid<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> height<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> salary<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>需要打印它的对象序列化后的 json 字符串：</p> 
<pre><code class="prism language-java"><span class="token class-name">UserBean</span> userBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userBean<span class="token punctuation">.</span>userid <span class="token operator">=</span> <span class="token string">"204895272048"</span><span class="token punctuation">;</span>
userBean<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">"奥特曼"</span><span class="token punctuation">;</span>
userBean<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
userBean<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>
userBean<span class="token punctuation">.</span>password <span class="token operator">=</span> <span class="token string">"1234567890"</span><span class="token punctuation">;</span>
userBean<span class="token punctuation">.</span>salary <span class="token operator">=</span> <span class="token number">30000.0</span><span class="token punctuation">;</span>
userBean<span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token string">"outer space, unknown"</span><span class="token punctuation">;</span>
<span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>userBean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印结果：</p> 
<pre><code class="prism language-text">{"userid":"204895272048","username":"奥特曼","password":"1234567890","age":1000,"height":300,"salary":30000.0,"address":"outer space, unknown"}
</code></pre> 
<p>看到打印结果没有格式化，期望的是这样的：</p> 
<p><img src="https://images2.imgbox.com/ca/cc/FLPs7sRp_o.png" alt="在这里插入图片描述"><br> 通过使用 <code>setPrettyPringint()</code> 配置，修改获取 <code>Gson</code> 对象的方式：</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPrettyPrinting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印结果：</p> 
<pre><code class="prism language-text">{
  "userid": "204895272048",
  "username": "奥特曼",
  "password": "1234567890",
  "age": 1000,
  "height": 300,
  "salary": 30000.0,
  "address": "outer space, unknown"
}
</code></pre> 
<h4><a id="disableHtmlEscaping__html__585"></a>使用<code>disableHtmlEscaping()</code> 配置，去除 html 字符转义</h4> 
<p>现在有一个简单的类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleBean</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试代码如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">SimpleBean</span> bean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bean<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">"Mr Bush's House"</span><span class="token punctuation">;</span>
bean<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">"a &gt; b"</span><span class="token punctuation">;</span>
<span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印结果如下：</p> 
<pre><code class="prism language-text">{"title":"Mr Bush\u0027s House","message":"a \u003e b"}
</code></pre> 
<p>可以看到 <code>'</code> 字符被转义成了 <code>\u0027</code>，<code>&gt;</code> 字符被转义成了 <code>\u003e</code>。</p> 
<p>这样的内容直接显示在手机屏幕上，用户指定看不懂。因此，必须改，可以使用 <code>disableHtmlEscaping()</code>，修改获取 <code>Gson</code> 对象的代码为：</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disableHtmlEscaping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>重新运行后，结果如下：</p> 
<pre><code class="prism language-text">{"title":"Mr Bush's House","message":"a &gt; b"}
</code></pre> 
<h4><a id="_setExclusionStrategiesExclusionStrategy_strategies__616"></a>使用 <code>setExclusionStrategies(ExclusionStrategy... strategies)</code> 配置，添加灵活的排除策略</h4> 
<p>之前的 <code>@Expose</code> 主要针对单个的字段来设置是否序列化与是否反序列化，这里可以通过 <code>setExclusionStrategies(ExclusionStrategy... strategies)</code> 统一配置排除策略。</p> 
<p>下面具体进行演示说明：</p> 
<p>这是一个简单的类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> gender<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Date</span> birthday<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> _school<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们打算序列化与反序列化都排除掉 <code>boolean</code> 类型和 <code>Date</code> 类型的字段，可以这么做：</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setExclusionStrategies</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExclusionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">shouldSkipField</span><span class="token punctuation">(</span><span class="token class-name">FieldAttributes</span> f<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">shouldSkipClass</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> clazz <span class="token operator">==</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">||</span> clazz <span class="token operator">==</span> <span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 序列化</span>
<span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
student<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"willwaywang6"</span><span class="token punctuation">;</span>
student<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
student<span class="token punctuation">.</span>gender <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
student<span class="token punctuation">.</span>birthday <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
student<span class="token punctuation">.</span>_school <span class="token operator">=</span> <span class="token string">"college"</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 反序列化</span>
<span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token string">"{\"name\":\"willwaywang6\",\"age\":18,\"gender\":true,\"birthday\":\"May 30, 2021 1:58:25 PM\",\"_school\":\"college\"}"</span><span class="token punctuation">;</span>
<span class="token class-name">Student</span> s <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Student</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印结果：</p> 
<pre><code class="prism language-text">{"name":"willwaywang6","age":18,"_school":"college"}
Student{name='willwaywang6', age=18, gender=false, birthday=null, _school='college'}
</code></pre> 
<p>如果还想基于字段的名字，注解，修饰符来排除序列化与反序列化，可以在 <code>shouldSkipField</code> 方法里面处理，修改代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">shouldSkipField</span><span class="token punctuation">(</span><span class="token class-name">FieldAttributes</span> f<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 排除名字以 "_" 开头的字段</span>
    <span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>重新运行，查看结果：</p> 
<pre><code class="prism language-text">{"name":"willwaywang6","age":18}
Student{name='willwaywang6', age=18, gender=false, birthday=null, _school='null'}
</code></pre> 
<p>可以看到：<code>_school</code> 字段没有参与序列化与反序列化了。</p> 
<h3><a id="24__Gson__675"></a>2.4 自定义 Gson 的序列化与反序列化</h3> 
<p>这里指的就是通过 <code>registerTypeAdapter</code> 的方式：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">GsonBuilder</span> <span class="token function">registerTypeAdapter</span><span class="token punctuation">(</span><span class="token class-name">Type</span> type<span class="token punctuation">,</span> <span class="token class-name">Object</span> typeAdapter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  $<span class="token class-name">Gson</span>$<span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkArgument</span><span class="token punctuation">(</span>typeAdapter <span class="token keyword">instanceof</span> <span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span>
      <span class="token operator">||</span> typeAdapter <span class="token keyword">instanceof</span> <span class="token class-name">JsonDeserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span>
      <span class="token operator">||</span> typeAdapter <span class="token keyword">instanceof</span> <span class="token class-name">InstanceCreator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span>
      <span class="token operator">||</span> typeAdapter <span class="token keyword">instanceof</span> <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>typeAdapter <span class="token keyword">instanceof</span> <span class="token class-name">InstanceCreator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    instanceCreators<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">InstanceCreator</span><span class="token punctuation">)</span> typeAdapter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>typeAdapter <span class="token keyword">instanceof</span> <span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token operator">||</span> typeAdapter <span class="token keyword">instanceof</span> <span class="token class-name">JsonDeserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">TypeToken</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> typeToken <span class="token operator">=</span> <span class="token class-name">TypeToken</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TreeTypeAdapter</span><span class="token punctuation">.</span><span class="token function">newFactoryWithMatchRawType</span><span class="token punctuation">(</span>typeToken<span class="token punctuation">,</span> typeAdapter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>typeAdapter <span class="token keyword">instanceof</span> <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span><span class="token function">newFactory</span><span class="token punctuation">(</span><span class="token class-name">TypeToken</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">TypeAdapter</span><span class="token punctuation">)</span>typeAdapter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个方法的作用就是配置 Gson 进行自定义的序列化与反序列化。</p> 
<p>这里把整个方法都贴出来，是为了让大家看到虽然方法的名字叫做 <code>registerTypeAdapter</code>，但是可以传入的类型可不止 <code>TypeAdapter</code>，具体来说是可以传入四种类型的对象：</p> 
<ul><li><code>JsonSerializer</code> 类型；</li><li><code>JsonDeserializer</code> 类型；</li><li><code>InstanceCreator</code> 类型；</li><li><code>TypeAdapter</code> 类型。</li></ul> 
<p>下面会分别演示每一种类型的实际案例，但是只是实际中的一种应用，而非所有的应用，更多的应用方式还需要大家在实际开发中“因地制宜”，灵活运用。</p> 
<h4><a id="_JsonSerializer__706"></a>使用 <code>JsonSerializer</code> 自定义序列化</h4> 
<p>这里构建一个买家，选择商品，最后生成订单，序列化后发给服务器的过程。</p> 
<p>先看一下会使用到的几个类：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 买家
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Shopper</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> userid<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 商品
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Commodity</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 订单
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> orderid<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> userid<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Commodity</span><span class="token punctuation">&gt;</span></span> commodities<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>演示代码在这里：</p> 
<pre><code class="prism language-java"><span class="token class-name">Shopper</span> shopper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shopper</span><span class="token punctuation">(</span><span class="token string">"userid_1234"</span><span class="token punctuation">,</span> <span class="token string">"willwaywang6"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Commodity</span><span class="token punctuation">&gt;</span></span> commodities <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">Commodity</span><span class="token punctuation">(</span><span class="token string">"id_12345"</span><span class="token punctuation">,</span> <span class="token string">"Huawei P50"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">Commodity</span><span class="token punctuation">(</span><span class="token string">"id_23456"</span><span class="token punctuation">,</span> <span class="token string">"Huawei P60"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token string">"order_1111"</span><span class="token punctuation">,</span> shopper<span class="token punctuation">.</span>userid<span class="token punctuation">,</span> shopper<span class="token punctuation">.</span>username<span class="token punctuation">,</span> commodities<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPrettyPrinting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>运行结果如下：</p> 
<pre><code class="prism language-text">{
  "orderid": "order_1111",
  "userid": "userid_1234",
  "username": "willwaywang6",
  "commodities": [
    {
      "id": "id_12345",
      "name": "Huawei P50"
    },
    {
      "id": "id_23456",
      "name": "Huawei P60"
    }
  ]
}
</code></pre> 
<p>到这里，我们似乎已经完成了需求。</p> 
<p>但是，不一会儿，服务端找过来了，说：“客户端的同学，能不能修改一下上报订单的数据格式啊？现在上报的数据有些冗余，服务器会爆炸的，帮忙修改成这样：”</p> 
<pre><code class="prism language-text">{
	"orderid": "order_1111",
	"userid": "userid_1234",
	"username": "willwaywang6",
	"commodities": [
		"id_12345", "id_23456"
	]
}
</code></pre> 
<p>首先想到的是，针对单个 <code>Commodity</code> 对象，只序列化 <code>id</code> 字段，修改代码如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Commodity</span><span class="token punctuation">&gt;</span></span> jsonSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Commodity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonElement</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">Commodity</span> src<span class="token punctuation">,</span> <span class="token class-name">Type</span> typeOfSrc<span class="token punctuation">,</span> <span class="token class-name">JsonSerializationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JsonObject</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">addProperty</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> src<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPrettyPrinting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerTypeAdapter</span><span class="token punctuation">(</span><span class="token class-name">Commodity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> jsonSerializer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>运行结果如下：</p> 
<pre><code class="prism language-text">{
  "orderid": "order_1111",
  "userid": "userid_1234",
  "username": "willwaywang6",
  "commodities": [
    {
      "id": "id_12345"
    },
    {
      "id": "id_23456"
    }
  ]
}
</code></pre> 
<p>不符合要求。</p> 
<p>其实，应该拿到整个 <code>List&lt;Commodity&gt;</code> 对象，然后取出里面的 <code>id</code>，存放在一个数组里面，修改代码如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Commodity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> jsonSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Commodity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonElement</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Commodity</span><span class="token punctuation">&gt;</span></span> src<span class="token punctuation">,</span> <span class="token class-name">Type</span> typeOfSrc<span class="token punctuation">,</span> <span class="token class-name">JsonSerializationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JsonArray</span> jsonArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Commodity</span> commodity <span class="token operator">:</span> src<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            jsonArray<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>commodity<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> jsonArray<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 注意这里有泛型，要这样获取 type。</span>
<span class="token class-name">Type</span> type <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeToken</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Commodity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPrettyPrinting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerTypeAdapter</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> jsonSerializer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>运行结果如下：</p> 
<pre><code class="prism language-text">{
  "orderid": "order_1111",
  "userid": "userid_1234",
  "username": "willwaywang6",
  "commodities": [
    "id_12345",
    "id_23456"
  ]
}
</code></pre> 
<p>哈哈，这次满足了服务端的要求了。</p> 
<h4><a id="_JsonDeserializer__840"></a>使用 <code>JsonDeserializer</code> 自定义反序列化</h4> 
<p>这次的需求是把后台给的 json 字符串反序列化为对象：</p> 
<pre><code class="prism language-text">{
	"name": "Huawei P100",
	"weight": 1,
	"timestamp": 1622360677020
}
</code></pre> 
<p>对应的类为：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Goods</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> weight<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试代码如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">String</span> goodsJson <span class="token operator">=</span> <span class="token string">"{\"name\":\"Huawei P100\",\"weight\":1,\"timestamp\":1622360677020}"</span><span class="token punctuation">;</span>
<span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Goods</span> goods <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>goodsJson<span class="token punctuation">,</span> <span class="token class-name">Goods</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>goods<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印结果：</p> 
<pre><code class="prism language-text">Goods{name='Huawei P100', weight=1, timestamp=1622360677020}
</code></pre> 
<p>正常地进行了反序列化。</p> 
<p>但是，后台有时候返回了这样的 json 字符串：</p> 
<pre><code class="prism language-text">{
	"name": "Huawei P100",
	"weight": "",
	"timestamp": 1622360677020
}
</code></pre> 
<pre><code class="prism language-java"><span class="token class-name">String</span> goodsJson <span class="token operator">=</span> <span class="token string">"{\"name\":\"Huawei P100\",\"weight\":\"\",\"timestamp\":1622360677020}"</span><span class="token punctuation">;</span>
</code></pre> 
<p>再次运行程序，报错：</p> 
<pre><code class="prism language-text">Exception in thread "main" com.google.gson.JsonSyntaxException: java.lang.NumberFormatException: empty String
	at com.google.gson.internal.bind.TypeAdapters$7.read(TypeAdapters.java:228)
	at com.google.gson.internal.bind.TypeAdapters$7.read(TypeAdapters.java:218)
	at com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$1.read(ReflectiveTypeAdapterFactory.java:131)
	at com.google.gson.internal.bind.ReflectiveTypeAdapterFactory$Adapter.read(ReflectiveTypeAdapterFactory.java:222)
	at com.google.gson.Gson.fromJson(Gson.java:932)
	at com.google.gson.Gson.fromJson(Gson.java:897)
	at com.google.gson.Gson.fromJson(Gson.java:846)
	at com.google.gson.Gson.fromJson(Gson.java:817)
	at com.example.lib._04_typeadapter.Test02.demo2(Test02.java:26)
	at com.example.lib._04_typeadapter.Test02.main(Test02.java:13)
Caused by: java.lang.NumberFormatException: empty String
	at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1842)
	at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:110)
	at java.lang.Double.parseDouble(Double.java:538)
	at com.google.gson.stream.JsonReader.nextInt(JsonReader.java:1202)
Caused by: java.lang.NumberFormatException: empty String
</code></pre> 
<p>这里就可以使用 <code>JsonDeserializer</code> 来解决这个异常。修改代码如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">JsonDeserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> jsonDeserializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonDeserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">JsonElement</span> json<span class="token punctuation">,</span> <span class="token class-name">Type</span> typeOfT<span class="token punctuation">,</span> <span class="token class-name">JsonDeserializationContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonParseException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> json<span class="token punctuation">.</span><span class="token function">getAsInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerTypeAdapter</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> jsonDeserializer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>修改完程序后，运行一下：</p> 
<pre><code class="prism language-text">Goods{name='Huawei P100', weight=0, timestamp=1622360677020}
</code></pre> 
<p>可以看到，这里解决了异常。</p> 
<p>需要说明的是，这里面 <code>registerTypeAdapter()</code> 方法的第一个参数传递 <code>int.class</code>，对应着 <code>Goods</code> 类的 <code>int</code> 类型的字段；如果 <code>Goods</code> 类的字段类型为 <code>Integer</code>，那么 <code>registerTypeAdapter</code> 方法的第一个参数需要传递 <code>Integer.class</code>。</p> 
<h4><a id="_InstanceCreator__923"></a>使用 <code>InstanceCreator</code> 自定义反序列化</h4> 
<p>需求是有个 <code>ShopperContext</code> 类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShopperContext</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> userid<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Context</span> context<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ShopperContext</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>要求在序列化后，<code>ShopperContext</code> 对象里包含 <code>Context</code> 类型字段的值。</p> 
<p>先不想太多，用之前的办法直接进行反序列化：</p> 
<pre><code class="prism language-java"><span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token string">"{\"userid\":\"id_12345\",\"username\":\"willwaywang6\"}"</span><span class="token punctuation">;</span>
<span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ShopperContext</span> shopperContext <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">ShopperContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>shopperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印如下：</p> 
<pre><code class="prism language-text">ShopperContext{userid='id_12345', username='willwaywang6', context=null}
</code></pre> 
<p>可以看到，<code>context</code> 字段为 <code>null</code>，不满足需求。</p> 
<p>这时就需要用到 <code>InstanceCreator</code>，修改代码如下：</p> 
<pre><code class="prism language-java"><span class="token comment">// 模拟一个 Context 对象</span>
<span class="token keyword">final</span> <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">InstanceCreator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShopperContext</span><span class="token punctuation">&gt;</span></span> instanceCreator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstanceCreator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShopperContext</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ShopperContext</span> <span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token class-name">Type</span> type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ShopperContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerTypeAdapter</span><span class="token punctuation">(</span><span class="token class-name">ShopperContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> instanceCreator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>再次运行程序，查看结果：</p> 
<pre><code class="prism language-text">ShopperContext{userid='id_12345', username='willwaywang6', context=com.example.lib._04_typeadapter.Context@6267c3bb}
</code></pre> 
<p>再举一个案例：</p> 
<p>有一个 <code>ShopperSingleton</code> 类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShopperSingleton</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> userid<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ShopperSingleton</span> singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShopperSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ShopperSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ShopperSingleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"ShopperSingleton@"</span> <span class="token operator">+</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"{"</span> <span class="token operator">+</span>
                <span class="token string">"userid='"</span> <span class="token operator">+</span> userid <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", username='"</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这是一个单例类。</p> 
<p>要求在反序列化后，把值赋值给这个单例的字段，而不是每次都创建新的实例。</p> 
<p>还是采取之前的办法，先把代码码起来：</p> 
<pre><code class="prism language-java"><span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token string">"{\"userid\":\"id_12345\",\"username\":\"willwaywang6\"}"</span><span class="token punctuation">;</span>
<span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 在反序列化之前的打印</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ShopperSingleton</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ShopperSingleton</span> shopperContext <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">ShopperSingleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 在反序列化之后的打印</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>shopperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印如下：</p> 
<pre><code class="prism language-text">ShopperSingleton@1066516207{userid='null', username='null'}
ShopperSingleton@777874839{userid='id_12345', username='willwaywang6'}
</code></pre> 
<p>不符合需要，序列化前后，<code>ShopperSingleton</code> 的单例被打破了。</p> 
<p>使用 <code>InstanceCreator</code> 来解决：</p> 
<pre><code class="prism language-java"><span class="token class-name">InstanceCreator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShopperSingleton</span><span class="token punctuation">&gt;</span></span> instanceCreator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstanceCreator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShopperSingleton</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ShopperSingleton</span> <span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token class-name">Type</span> type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">ShopperSingleton</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerTypeAdapter</span><span class="token punctuation">(</span><span class="token class-name">ShopperSingleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> instanceCreator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ShopperSingleton</span> shopperContext <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">ShopperSingleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印如下：</p> 
<pre><code class="prism language-text">ShopperSingleton@705927765{userid='null', username='null'}
ShopperSingleton@705927765{userid='id_12345', username='willwaywang6'}
</code></pre> 
<p>可以看到，序列化前后都是一个对象，满足要求。</p> 
<h4><a id="TypeAdapter__1034"></a>使用<code>TypeAdapter</code> 自定义序列化与反序列化</h4> 
<p>需求是这样的：<br> 对于 <code>Point</code> 类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>序列化时为 “1,1” 这样的 json 字符串；反序列化时，“1,1” 可以转为 <code>Point</code> 对象。</p> 
<p>直接看代码：</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerTypeAdapter</span><span class="token punctuation">(</span><span class="token class-name">Point</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Point</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">JsonWriter</span> writer<span class="token punctuation">,</span> <span class="token class-name">Point</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            writer<span class="token punctuation">.</span><span class="token function">nullValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> xy <span class="token operator">=</span> value<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> value<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        writer<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Point</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">JsonReader</span> reader<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">JsonToken</span><span class="token punctuation">.</span>NULL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            reader<span class="token punctuation">.</span><span class="token function">nextNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> xy <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">nextString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parts <span class="token operator">=</span> xy<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 序列化</span>
<span class="token class-name">Point</span> point <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 反序列化</span>
<span class="token comment">// 特别注意：是 "\"2,2\"", 而不是 "2,2"，否则反序列化会失败</span>
<span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token string">"\"2,2\""</span><span class="token punctuation">;</span>
<span class="token class-name">Point</span> p <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Point</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="25__1080"></a>2.5 源码里的解析过程</h3> 
<p>不管是序列化还是反序列化，都是分为三步：</p> 
<ol><li>获取 <code>TypeToken</code> 对象；</li><li>根据 <code>TypeToken</code> 对象获取 <code>TypeAdapter</code>对象；</li><li>通过 <code>TypeAdapter</code> 对象的 <code>read()</code> 方法进行反序列化，<code>write()</code> 方法进行序列化。</li></ol> 
<p>下面以序列化过程为例进行说明。</p> 
<p>进行分析的代码比较简洁，如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 序列化</span>
<span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"willwaywang6"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> personJson <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>personJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>现在开始一起看源码：</p> 
<p><code>toJson</code> 有一系列的重载方法，最后调用的是这个重载方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">toJson</span><span class="token punctuation">(</span><span class="token class-name">Object</span> src<span class="token punctuation">,</span> <span class="token class-name">Type</span> typeOfSrc<span class="token punctuation">,</span> <span class="token class-name">JsonWriter</span> writer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonIOException</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> adapter <span class="token operator">=</span> <span class="token function">getAdapter</span><span class="token punctuation">(</span><span class="token class-name">TypeToken</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>typeOfSrc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> adapter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先，通过 <code>TypeToken.get(typeOfSrc)</code> 获取到 <code>TypeToken</code> 对象传递给 <code>getAdapter()</code> 方法；</p> 
<p>接着，看 <code>getAdapter()</code> 方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeAdapterFactory</span><span class="token punctuation">&gt;</span></span> factories<span class="token punctuation">;</span>
<span class="token comment">// typeTokenCache 是以 TypeToken 为键，以 TypeAdapter 为值的一个缓存集合对象</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeToken</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">TypeAdapter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typeTokenCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeToken</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">TypeAdapter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAdapter</span><span class="token punctuation">(</span><span class="token class-name">TypeToken</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cached <span class="token operator">=</span> typeTokenCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> NULL_KEY_SURROGATE <span class="token operator">:</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 1，先从缓存里面取</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> cached<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 2，没有缓存，构建一个</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TypeAdapterFactory</span> factory <span class="token operator">:</span> factories<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> candidate <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      typeTokenCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> candidate<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"GSON ("</span> <span class="token operator">+</span> <span class="token class-name">GsonBuildConfig</span><span class="token punctuation">.</span>VERSION <span class="token operator">+</span> <span class="token string">") cannot handle "</span> <span class="token operator">+</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，先从缓存里面取；没有的话，再遍历 <code>factories</code> 列表，如果可以构建一个非空的 <code>TypeAdapter</code> 对象，就返回。</p> 
<p>目前有两个问题：</p> 
<ul><li><code>factories</code> 列表是在哪里赋值的？</li><li><code>TypeAdapter</code> 对象是如何构建出来的？</li></ul> 
<p>查看源码可以知道，<code>factories</code> 列表是在创建 <code>Gson</code> 对象（<code>Gson gson = new Gson();</code>）的时候赋值的。</p> 
<pre><code class="prism language-java"><span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token class-name">Excluder</span> excluder<span class="token punctuation">,</span> <span class="token class-name">FieldNamingStrategy</span> fieldNamingStrategy<span class="token punctuation">,</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">,</span> <span class="token class-name">InstanceCreator</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> instanceCreators<span class="token punctuation">,</span> <span class="token keyword">boolean</span> serializeNulls<span class="token punctuation">,</span>
    <span class="token keyword">boolean</span> complexMapKeySerialization<span class="token punctuation">,</span> <span class="token keyword">boolean</span> generateNonExecutableGson<span class="token punctuation">,</span> <span class="token keyword">boolean</span> htmlSafe<span class="token punctuation">,</span>
    <span class="token keyword">boolean</span> prettyPrinting<span class="token punctuation">,</span> <span class="token keyword">boolean</span> lenient<span class="token punctuation">,</span> <span class="token keyword">boolean</span> serializeSpecialFloatingPointValues<span class="token punctuation">,</span>
    <span class="token class-name">LongSerializationPolicy</span> longSerializationPolicy<span class="token punctuation">,</span> <span class="token class-name">String</span> datePattern<span class="token punctuation">,</span> <span class="token keyword">int</span> dateStyle<span class="token punctuation">,</span>
    <span class="token keyword">int</span> timeStyle<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeAdapterFactory</span><span class="token punctuation">&gt;</span></span> builderFactories<span class="token punctuation">,</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeAdapterFactory</span><span class="token punctuation">&gt;</span></span> builderHierarchyFactories<span class="token punctuation">,</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeAdapterFactory</span><span class="token punctuation">&gt;</span></span> factoriesToBeAdded<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token comment">// 省略与分析无关的代码</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeAdapterFactory</span><span class="token punctuation">&gt;</span></span> factories <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeAdapterFactory</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// built-in type adapters that cannot be overridden</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>JSON_ELEMENT_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ObjectTypeAdapter</span><span class="token punctuation">.</span>FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// the excluder must precede all adapters that handle user-defined types</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>excluder<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// users' type adapters</span>
  factories<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>factoriesToBeAdded<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// type adapters for basic platform types</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>STRING_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>INTEGER_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>BOOLEAN_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>BYTE_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>SHORT_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Number</span><span class="token punctuation">&gt;</span></span> longAdapter <span class="token operator">=</span> <span class="token function">longAdapter</span><span class="token punctuation">(</span>longSerializationPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span><span class="token function">newFactory</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> longAdapter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span><span class="token function">newFactory</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
          <span class="token function">doubleAdapter</span><span class="token punctuation">(</span>serializeSpecialFloatingPointValues<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span><span class="token function">newFactory</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Float</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
          <span class="token function">floatAdapter</span><span class="token punctuation">(</span>serializeSpecialFloatingPointValues<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>NUMBER_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>ATOMIC_INTEGER_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>ATOMIC_BOOLEAN_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span><span class="token function">newFactory</span><span class="token punctuation">(</span><span class="token class-name">AtomicLong</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token function">atomicLongAdapter</span><span class="token punctuation">(</span>longAdapter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span><span class="token function">newFactory</span><span class="token punctuation">(</span><span class="token class-name">AtomicLongArray</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token function">atomicLongArrayAdapter</span><span class="token punctuation">(</span>longAdapter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>ATOMIC_INTEGER_ARRAY_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>CHARACTER_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>STRING_BUILDER_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>STRING_BUFFER_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span><span class="token function">newFactory</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>BIG_DECIMAL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span><span class="token function">newFactory</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>BIG_INTEGER<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>URL_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>URI_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>UUID_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>CURRENCY_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>LOCALE_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>INET_ADDRESS_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>BIT_SET_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">DateTypeAdapter</span><span class="token punctuation">.</span>FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>CALENDAR_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TimeTypeAdapter</span><span class="token punctuation">.</span>FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SqlDateTypeAdapter</span><span class="token punctuation">.</span>FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>TIMESTAMP_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ArrayTypeAdapter</span><span class="token punctuation">.</span>FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>CLASS_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// type adapters for composite and user-defined types</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CollectionTypeAdapterFactory</span><span class="token punctuation">(</span>constructorConstructor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapTypeAdapterFactory</span><span class="token punctuation">(</span>constructorConstructor<span class="token punctuation">,</span> complexMapKeySerialization<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>jsonAdapterFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonAdapterAnnotationTypeAdapterFactory</span><span class="token punctuation">(</span>constructorConstructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>jsonAdapterFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">TypeAdapters</span><span class="token punctuation">.</span>ENUM_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReflectiveTypeAdapterFactory</span><span class="token punctuation">(</span>
      constructorConstructor<span class="token punctuation">,</span> fieldNamingStrategy<span class="token punctuation">,</span> excluder<span class="token punctuation">,</span> jsonAdapterFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>factories <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>factories<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>需要注意的是，向局部变量 <code>factories</code> 列表里面添加 <code>TypeAdapterFactory</code> 对象的顺序：</p> 
<ol><li>内置的 <code>TypeAdapterFactory</code>，不可以重写；</li><li>排除器(<code>Excluder implements TypeAdapterFactory</code>)；</li><li>用户自定义的 <code>TypeAdapterFactory</code>；</li><li>基本的平台类型的 <code>TypeAdapterFactory</code>；</li><li>type adapters for composite and user-defined types：这里面的 <code>ReflectiveTypeAdapterFactory</code> 是本次会分析到的，<code>Person</code> 对象的解析正是用到这个<code>TypeAdapterFactory</code>来创建 <code>TypeAdapter</code> 对象的。</li></ol> 
<p>回到我们分析的代码里面：</p> 
<pre><code class="prism language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TypeAdapterFactory</span> factory <span class="token operator">:</span> factories<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> candidate <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    typeTokenCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> candidate<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过 <code>factories</code> 列表进行遍历，得到第一个不为 <code>null</code> 的 <code>TypeAdapter</code> 对象，直接返回就可以了。</p> 
<p>那么，我们怎么知道本次分析获取的 <code>TypeAdapter</code> 对象是由哪个 <code>TypeAdapterFactory</code> 创建的呢？</p> 
<p>还是通过打断点的方式：<br> <img src="https://images2.imgbox.com/ef/68/1s9KjRsm_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7b/dc/ss9ayGCn_o.png" alt="在这里插入图片描述"><br> 可以看到我们获取的 <code>TypeAdapter</code> 是 <code>ReflectiveTypeAdapterFactory.Adapter</code> 对象，是通过 <code>ReflectiveTypeAdapterFactory</code> 创建的。</p> 
<p>这里想插播一下，Gson 如何使用工厂方法模式，来控制 <code>TypeAdapter</code> 的创建。我们以 <code>TypeAdapters</code> 类的 <code>newFactory()</code> 方法来说明一下，之前向 <code>factories</code> 列表添加的 <code>TypeAdapterFactory</code> 对象很多是通过这个方法来创建的：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">TypeAdapterFactory</span> STRING_FACTORY <span class="token operator">=</span> <span class="token function">newFactory</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> STRING<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span>TT<span class="token punctuation">&gt;</span></span> <span class="token class-name">TypeAdapterFactory</span> <span class="token function">newFactory</span><span class="token punctuation">(</span>
    <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span>TT<span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span>TT<span class="token punctuation">&gt;</span></span> typeAdapter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TypeAdapterFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span> <span class="token comment">// we use a runtime check to make sure the 'T's equal</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Gson</span> gson<span class="token punctuation">,</span> <span class="token class-name">TypeToken</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> typeToken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> typeToken<span class="token punctuation">.</span><span class="token function">getRawType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> type <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> typeAdapter <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token string">"Factory[type="</span> <span class="token operator">+</span> type<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">",adapter="</span> <span class="token operator">+</span> typeAdapter <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过这个 <code>TypeAdapterFactory</code> 对象的 <code>create</code> 方法，来获取 <code>TypeAdapter</code> 对象。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Gson</span> gson<span class="token punctuation">,</span> <span class="token class-name">TypeToken</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> typeToken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> typeToken<span class="token punctuation">.</span><span class="token function">getRawType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> type <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> typeAdapter <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果传入的 <code>TypeToken</code> 对象的原始类型是 <code>String.class</code>，那么就返回 <code>TypeAdapter&lt;String&gt; STRING</code>，否则就返回 <code>null</code>。</p> 
<p>回到分析的问题，现在我们知道本次分析的例子正是通过 <code>ReflectiveTypeAdapterFactory</code> 创建出的 <code>TypeAdapter</code> 对象来完成解析任务的。</p> 
<p>但是，我们并没有告知 <code>ReflectiveTypeAdapterFactory</code>，<code>Person</code> 类有哪些字段，字段的类型是什么，它是如何完成解析任务的呢？</p> 
<p>为了搞清楚这些问题，需要去看一下 <code>ReflectiveTypeAdapterFactory</code> 的代码。</p> 
<p>这里为了说明这一问题，对 <code>ReflectiveTypeAdapterFactory</code> 的代码部分，去掉了排除器的部分，去掉了字段命名策略的部分，去掉了 <code>jsonAdapterFactory</code> 的部分，修改了源代码里面的类嵌套的代码结构。</p> 
<p>下面看一下精简后的代码吧，觉得还是比较清晰的：</p> 
<p><code>MyReflectiveTypeAdapterFactory</code> 类，用于创建 <code>ReflectiveTypeAdapter</code> 对象：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">MyReflectiveTypeAdapterFactory</span> <span class="token keyword">implements</span> <span class="token class-name">TypeAdapterFactory</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConstructorConstructor</span> constructorConstructor<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReflectionAccessor</span> accessor <span class="token operator">=</span> <span class="token class-name">ReflectionAccessor</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyReflectiveTypeAdapterFactory</span><span class="token punctuation">(</span><span class="token class-name">ConstructorConstructor</span> constructorConstructor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>constructorConstructor <span class="token operator">=</span> constructorConstructor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Gson</span> gson<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">TypeToken</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> raw <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">getRawType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// it's a primitive!</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ObjectConstructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> constructor <span class="token operator">=</span> constructorConstructor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReflectiveTypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>constructor<span class="token punctuation">,</span> <span class="token function">getBoundFields</span><span class="token punctuation">(</span>gson<span class="token punctuation">,</span> type<span class="token punctuation">,</span> raw<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 收集以字段名为键，BoundField 为值的集合</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BoundField</span><span class="token punctuation">&gt;</span></span> <span class="token function">getBoundFields</span><span class="token punctuation">(</span><span class="token class-name">Gson</span> context<span class="token punctuation">,</span> <span class="token class-name">TypeToken</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> raw<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BoundField</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>raw<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>raw <span class="token operator">!=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> raw<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Field</span> field <span class="token operator">:</span> fields<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                accessor<span class="token punctuation">.</span><span class="token function">makeAccessible</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Type</span> fieldType <span class="token operator">=</span> $<span class="token class-name">Gson</span>$<span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> raw<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getGenericType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> name <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">BoundField</span> boundField <span class="token operator">=</span> <span class="token function">createBoundField</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> field<span class="token punctuation">,</span> name<span class="token punctuation">,</span>
                            <span class="token class-name">TypeToken</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fieldType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> boundField<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            type <span class="token operator">=</span> <span class="token class-name">TypeToken</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>$<span class="token class-name">Gson</span>$<span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> raw<span class="token punctuation">,</span> raw<span class="token punctuation">.</span><span class="token function">getGenericSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            raw <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">getRawType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 创建 BoundField 对象，实现了字段的解析接口</span>
    <span class="token keyword">private</span> <span class="token class-name">BoundField</span> <span class="token function">createBoundField</span><span class="token punctuation">(</span>
            <span class="token keyword">final</span> <span class="token class-name">Gson</span> context<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Field</span> field<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">TypeToken</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> fieldType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isPrimitive <span class="token operator">=</span> <span class="token class-name">Primitives</span><span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span>fieldType<span class="token punctuation">.</span><span class="token function">getRawType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> typeAdapter <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getAdapter</span><span class="token punctuation">(</span>fieldType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BoundField</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"unchecked"</span><span class="token punctuation">,</span> <span class="token string">"rawtypes"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">JsonWriter</span> writer<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span>
                    <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Object</span> fieldValue <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">TypeAdapter</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeAdapterRuntimeTypeWrapper</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> typeAdapter<span class="token punctuation">,</span> fieldType<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                t<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> fieldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">JsonReader</span> reader<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span>
                    <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Object</span> fieldValue <span class="token operator">=</span> typeAdapter<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldValue <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>isPrimitive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> fieldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">writeField</span><span class="token punctuation">(</span><span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Object</span> fieldValue <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> fieldValue <span class="token operator">!=</span> value<span class="token punctuation">;</span> <span class="token comment">// avoid recursion for example for Throwable.cause</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>BoundField</code> 类，抽象类，定义了字段的解析接口：</p> 
<pre><code class="prism language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BoundField</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token class-name">BoundField</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">abstract</span> <span class="token keyword">boolean</span> <span class="token function">writeField</span><span class="token punctuation">(</span><span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">;</span>

    <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">JsonWriter</span> writer<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">;</span>

    <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">JsonReader</span> reader<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>ReflectiveTypeAdapter</code> 类，把解析的任务都交给了 <code>BoundField</code> 来完成：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectiveTypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">TypeAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectConstructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> constructor<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BoundField</span><span class="token punctuation">&gt;</span></span> boundFields<span class="token punctuation">;</span>

    <span class="token class-name">ReflectiveTypeAdapter</span><span class="token punctuation">(</span><span class="token class-name">ObjectConstructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> constructor<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BoundField</span><span class="token punctuation">&gt;</span></span> boundFields<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>constructor <span class="token operator">=</span> constructor<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>boundFields <span class="token operator">=</span> boundFields<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">JsonReader</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">JsonToken</span><span class="token punctuation">.</span>NULL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            in<span class="token punctuation">.</span><span class="token function">nextNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">T</span> instance <span class="token operator">=</span> constructor<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            in<span class="token punctuation">.</span><span class="token function">beginObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">String</span> name <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nextName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">BoundField</span> field <span class="token operator">=</span> boundFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>field <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    in<span class="token punctuation">.</span><span class="token function">skipValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    field<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JsonSyntaxException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        in<span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">JsonWriter</span> out<span class="token punctuation">,</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            out<span class="token punctuation">.</span><span class="token function">nullValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        out<span class="token punctuation">.</span><span class="token function">beginObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BoundField</span> boundField <span class="token operator">:</span> boundFields<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>boundField<span class="token punctuation">.</span><span class="token function">writeField</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    out<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>boundField<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    boundField<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        out<span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>真正进行解析的任务是由 <code>BoundField</code> 来完成的，而创建 <code>BoundField</code> 和实现 <code>BoundField</code> 都使用到了反射。</p> 
<h2><a id="3__1420"></a>3 最后</h2> 
<p>本文从基本的 Gson 使用开始，接着展示了 Gson 中常用的注解以及常用的配置，最后介绍了 <code>registerAdapter</code> 的使用。</p> 
<p>还有一些未完成的内容：</p> 
<ul><li><code>registerTypeAdapter</code> 方法与 <code>registerTypeHierarchyAdapter</code> 方法的区别；</li><li>总结 Gson 框架里用到的设计模式：门面模式，适配器模式，策略模式，工厂模式（控制了到底是返回 <code>TypeAdapter</code> 的实例还是返回 <code>null</code>）；</li><li>Gson 如何使用流：<code>JsonReader</code>，<code>JsonWriter</code>？</li></ul> 
<p><a href="https://github.com/jhwsx/BlogCodes/tree/master/JsonStudy">代码传送门</a></p> 
<p>希望能够帮助到大家。</p> 
<h3><a id="_1431"></a>参考</h3> 
<ul><li><a href="https://mp.weixin.qq.com/s?__biz=MzIxNzU1Nzk3OQ==&amp;mid=2247486762&amp;idx=1&amp;sn=35f2a4d53dc36470994c8b24ca1474f6&amp;chksm=97f6b39ea0813a88e4cf0b9b39cad5ef34ff2cdf82a879f2f57b8ec3ece0522eb524dbf32d31&amp;scene=38#wechat_redirect" rel="nofollow">Gson 解析服务端返回的多种类型的 JSON</a></li><li><a href="https://www.jianshu.com/p/e740196225a4" rel="nofollow">你真的会用Gson吗?Gson使用指南</a></li><li><a href="https://blog.csdn.net/jdsjlzx/article/details/106409786">Gson 解析 Json，容错才是关键，举几个常用的实例！</a></li><li><a href="https://futurestud.io/tutorials/gson-advanced-custom-serialization-part-1" rel="nofollow">Gson Advanced — Custom Serialization for Simplification (Part 1)</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzA5MzI3NjE2MA==&amp;mid=2650243206&amp;idx=1&amp;sn=28c1d807ae3a8a5ef32c91095f264ab1&amp;chksm=886371e9bf14f8ffdd8507252315c96e371fc4f916c854bce85a178222104b1d9684e9ab4bae&amp;scene=38#wechat_redirect" rel="nofollow">Android Gson使用详解</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzIxNzU1Nzk3OQ==&amp;mid=2247485850&amp;idx=1&amp;sn=436cbfc7b3eb2549fe664063b693748f&amp;chksm=97f6b72ea0813e38b6e7a7b5f7736465c252f7ba739fd1510ec52b8fb78adbe8f25c701a1396&amp;scene=38#wechat_redirect" rel="nofollow">一个容错的 Gson 新世界</a></li><li><a href="https://yanchen.blog.csdn.net/article/details/49160321" rel="nofollow">JsonElement的简单说明</a></li><li><a href="https://blog.csdn.net/chunqiuwei/article/details/49338053">Gson的反射解析机制详解(1)</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fc693764191448c37efaaf26da2515e8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">html5中加入音乐怎么弄,如何在H5页面上添加音乐播放</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2483b438069ec4602891adf94fd7d116/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">html5在线预览xml,HTML5教程 5分钟了解XML</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>