<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android窗口层级（Window Type）分析 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android窗口层级（Window Type）分析" />
<meta property="og:description" content="前言 Android的窗口Window分为三种类型：
应用Window，比如Activity、Dialog；子Window，比如PopupWindow；系统Window，比如Toast、系统状态栏、导航栏等等。
应用Window的Z-Ordered最低，就是在系统中的显示层级最低，然后到子Window，层级最高的是系统Window。层级高的Window会覆盖层级低的Window。 要让窗口覆盖显示，只需要使它的层级比上个窗口高。
三种窗口对应不同的WindowToken，每个应用组件（应用组件可以是Activity、InputMethod、Wallpaper等，每个组件对应一个WindowToken）都需要通过WindowToken向WMS申请添加窗口，WMS（WindowManagerSerivce）通过根据窗口的WindowToken进行分类组织，相同WindowToken的窗口紧密联系。应用组件在新建窗口时必须提供WindowToken表面窗口身份类型。系统窗口会隐式申明WindowToken，同时WMS会在addWindow()时进行鉴权。
应用窗口层级 Activity的显示 先从Activity的setContentView()的源码入手：
在AppCompatDelegateImpl源码中
mSubDecor并非Window中的DecorView，在创建DecorView之后创建的一个子DecorView，包括是否是包含ActionBar、FloatingActionButton等，相当于旧版本的DecorView中TitleBar。
getWindow()是返回返回Activity的mWindow变量，指向一个Window的对象，Window是一个抽象类，这里返回的是PhoneWindow对象（PhoneWindow是Window的子类），PhoneWindow中有一个DecorView对象，DecorView实际上就是个FrameLayout，setContentView()的子布局最终会添加到DecorView中，DecorView为当前窗口的根视图。
这个根视图是如何最终被绘制出来的？
Window表示一个抽象窗口的概念，是View的直接管理者，对应一个View，Window和View之间由ViewRootImpl联系。
Activity的View层级就是如下:
应用窗口层级类型 WMS在进行应用窗口叠加时，会动态改变应用窗口的层值，但层值不会大于99。
public static final int FIRST_APPLICATION_WINDOW = 1; public static final int TYPE_BASE_APPLICATION = 1; public static final int TYPE_APPLICATION = 2; public static final int TYPE_APPLICATION_STARTING = 3; public static final int TYPE_DRAWN_APPLICATION = 4; public static final int LAST_APPLICATION_WINDOW = 99; 1.Activity的默认窗口层级为TYPE_BASE_APPLICATION。通过WindowManager.addView()将DecorView添加到窗口中。在ActivityThread中有这样一段代码：
2.Dialog默认的层级为TYPE_APPLICATION
Dialog的创建：
1.创建Window（方法同Activity创建）；
2.初始化DecorView，并将Dialog的视图添加进DecorView；
3.将DecorView添加到Window中显示。
同为TYPE_APPLICATION层级的也有ActionMode
Windowmanager的LayoutParams构造方法如果不指定windowtype默认为TYPE_APPLICATION，所以Dialog在Activity中创建时不指定窗口层级默认为TYPE_APPLICATION。
在Service中创建Dialog并弹出时，跟Activity同样代码会报错。需要设置为WindowManager.LayoutParams.TYPE_SYSTEM_ALERT的系统窗口层级以上才可以正常显示。
3.TYPE_APPLICATION_STARTING 启动窗口，Z-Ordered应高于应用程序中的所有其他窗口。为Android12特有的启动画面StartingWindow 即包含SplashScreen。这里还涉及到SystemUI的WMShell组件，其中SplitScreen分屏模式、OneHanded单手模式、Freeform自由窗口模式、Bubble气泡通知窗口（Android Q）、PIP画中画模式等等系统模式窗口为WMShell处理的一部分。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/b42ff910c9837d4298b0a4dba7c21fd0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-11T23:32:57+08:00" />
<meta property="article:modified_time" content="2023-09-11T23:32:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android窗口层级（Window Type）分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<p>Android的窗口Window分为三种类型：</p> 
<p>应用Window，比如<code>Activity</code>、<code>Dialog</code>；子Window，比如<code>PopupWindow</code>；系统Window，比如<code>Toast</code>、系统状态栏、导航栏等等。</p> 
<p>应用Window的Z-Ordered最低，就是在系统中的显示层级最低，然后到子Window，层级最高的是系统Window。层级高的Window会覆盖层级低的Window。 要让窗口覆盖显示，只需要使它的层级比上个窗口高。</p> 
<p>三种窗口对应不同的<code>WindowToken</code>，每个应用组件（应用组件可以是<code>Activity</code>、<code>InputMethod</code>、<code>Wallpaper</code>等，每个组件对应一个<code>WindowToken</code>）都需要通过<code>WindowToken</code>向WMS申请添加窗口，WMS（<code>WindowManagerSerivce</code>）通过根据窗口的<code>WindowToken</code>进行分类组织，相同<code>WindowToken</code>的窗口紧密联系。应用组件在新建窗口时必须提供<code>WindowToken</code>表面窗口身份类型。系统窗口会隐式申明<code>WindowToken</code>，同时WMS会在<code>addWindow()</code>时进行鉴权。</p> 
<h2><a id="_10"></a>应用窗口层级</h2> 
<h3><a id="Activity_12"></a>Activity的显示</h3> 
<p>先从<code>Activity</code>的<code>setContentView()</code>的源码入手：<br> <img src="https://images2.imgbox.com/8e/0d/GRBVPByn_o.png" alt="在这里插入图片描述"><br> 在<code>AppCompatDelegateImpl</code>源码中<br> <img src="https://images2.imgbox.com/f5/21/2NOp7bck_o.png" alt="在这里插入图片描述"></p> 
<p><code>mSubDecor</code>并非Window中的<code>DecorView</code>，在创建<code>DecorView</code>之后创建的一个子<code>DecorView</code>，包括是否是包含<code>ActionBar</code>、<code>FloatingActionButton</code>等，相当于旧版本的<code>DecorView</code>中<code>TitleBar</code>。</p> 
<p><code>getWindow()</code>是返回返回<code>Activity</code>的<code>mWindow</code>变量，指向一个<code>Window</code>的对象，<code>Window</code>是一个抽象类，这里返回的是<code>PhoneWindow</code>对象（<code>PhoneWindow</code>是<code>Window</code>的子类），<code>PhoneWindow</code>中有一个<code>DecorView</code>对象，<code>DecorView</code>实际上就是个<code>FrameLayout</code>，<code>setContentView()</code>的子布局最终会添加到<code>DecorView</code>中，<code>DecorView</code>为当前窗口的根视图。</p> 
<p>这个根视图是如何最终被绘制出来的？</p> 
<p><code>Window</code>表示一个抽象窗口的概念，是<code>View</code>的直接管理者，对应一个<code>View</code>，<code>Window</code>和<code>View</code>之间由<code>ViewRootImpl</code>联系。</p> 
<p><code>Activity</code>的<code>View</code>层级就是如下:<br> <img src="https://images2.imgbox.com/37/1a/4DXtSwMh_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_30"></a>应用窗口层级类型</h3> 
<p>WMS在进行应用窗口叠加时，会动态改变应用窗口的层值，但层值不会大于99。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">FIRST_APPLICATION_WINDOW</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TYPE_BASE_APPLICATION</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TYPE_APPLICATION</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TYPE_APPLICATION_STARTING</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TYPE_DRAWN_APPLICATION</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">LAST_APPLICATION_WINDOW</span> <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>
</code></pre> 
<p>1.<code>Activity</code>的默认窗口层级为<code>TYPE_BASE_APPLICATION</code>。通过<code>WindowManager.addView()</code>将<code>DecorView</code>添加到窗口中。在<code>ActivityThread</code>中有这样一段代码：</p> 
<p><img src="https://images2.imgbox.com/13/89/WY0us0sY_o.png" alt="在这里插入图片描述"><br> 2.<code>Dialog</code>默认的层级为<code>TYPE_APPLICATION</code><br> <code>Dialog</code>的创建：<br> 1.创建Window（方法同Activity创建）；<br> 2.初始化<code>DecorView</code>，并将Dialog的视图添加进<code>DecorView</code>；<br> 3.将<code>DecorView</code>添加到Window中显示。<br> 同为<code>TYPE_APPLICATION</code>层级的也有<code>ActionMode</code><br> <code>Windowmanager</code>的<code>LayoutParams</code>构造方法如果不指定windowtype默认为<code>TYPE_APPLICATION</code>，所以<code>Dialog</code>在<code>Activity</code>中创建时不指定窗口层级默认为<code>TYPE_APPLICATION</code>。<br> <img src="https://images2.imgbox.com/47/61/ckyDRHq7_o.png" alt="在这里插入图片描述"><br> 在<code>Service</code>中创建<code>Dialog</code>并弹出时，跟<code>Activity</code>同样代码会报错。需要设置为<code>WindowManager.LayoutParams.TYPE_SYSTEM_ALERT</code>的系统窗口层级以上才可以正常显示。</p> 
<p>3.<code>TYPE_APPLICATION_STARTING</code> 启动窗口，Z-Ordered应高于应用程序中的所有其他窗口。为Android12特有的启动画面<code>StartingWindow</code> 即包含<code>SplashScreen</code>。这里还涉及到SystemUI的<code>WMShell</code>组件，其中SplitScreen分屏模式、OneHanded单手模式、Freeform自由窗口模式、Bubble气泡通知窗口（Android Q）、PIP画中画模式等等系统模式窗口为<code>WMShell</code>处理的一部分。</p> 
<ol start="4"><li>经常在应用中做一些<code>Toast</code>临时弹框，但<code>Toast</code>为系统窗口而不是应用窗口，层级为<code>TYPE_TOAST</code>，不在应用窗口的范畴。在下面系统窗口介绍。</li></ol> 
<h2><a id="Sub_Window_61"></a>子窗口层级（Sub Window)</h2> 
<pre><code class="prism language-java">       <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">FIRST_SUB_WINDOW</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
       <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TYPE_APPLICATION_PANEL</span> <span class="token operator">=</span> <span class="token constant">FIRST_SUB_WINDOW</span><span class="token punctuation">;</span>
       <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TYPE_APPLICATION_MEDIA</span> <span class="token operator">=</span> <span class="token constant">FIRST_SUB_WINDOW</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
       <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TYPE_APPLICATION_SUB_PANEL</span> <span class="token operator">=</span> <span class="token constant">FIRST_SUB_WINDOW</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
       <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TYPE_APPLICATION_ATTACHED_DIALOG</span> <span class="token operator">=</span> <span class="token constant">FIRST_SUB_WINDOW</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
       <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TYPE_APPLICATION_MEDIA_OVERLAY</span>  <span class="token operator">=</span> <span class="token constant">FIRST_SUB_WINDOW</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span>
       <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TYPE_APPLICATION_ABOVE_SUB_PANEL</span> <span class="token operator">=</span> <span class="token constant">FIRST_SUB_WINDOW</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span>
       <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">LAST_SUB_WINDOW</span> <span class="token operator">=</span> <span class="token number">1999</span><span class="token punctuation">;</span>
</code></pre> 
<p>子窗口类型必须设置为应用窗口附加的窗口。 这些类型的窗口在 Z-Ordered中保持在它们附加的窗口旁边，并且它们的坐标是相对于所附加的应用窗口。</p> 
<p>1.<code>TYPE_APPLICATION_PANEL</code>为面板子窗口，应用窗口顶部的面板，例如<code>PopupWindow</code><br> <code>PopupWindow</code>源码中指定的窗口层级：</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">int</span> mWindowLayoutType <span class="token operator">=</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">TYPE_APPLICATION_PANEL</span><span class="token punctuation">;</span>
</code></pre> 
<p>2.<code>TYPE_APPLICATION_MEDIA</code>显示媒体（如视频）的窗口。为Android 7.1之前的<code>SurfaceView</code>源码中默认的层级，在<code>SurfaceView</code>源码中的<code>setZOrderOnTop()</code>方法，设置<code>SurfaceView</code>的显示顺序。</p> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setZOrderOnTop</span><span class="token punctuation">(</span>booleanonTop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>onTop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           mWindowType <span class="token operator">=</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">TYPE_APPLICATION_PANEL</span><span class="token punctuation">;</span>
           <span class="token comment">// ensures the surface is placed below the IME</span>
           mLayout<span class="token punctuation">.</span>flags <span class="token operator">|=</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">FLAG_ALT_FOCUSABLE_IM</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
           mWindowType <span class="token operator">=</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">TYPE_APPLICATION_MEDIA</span><span class="token punctuation">;</span>
           mLayout<span class="token punctuation">.</span>flags<span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">FLAG_ALT_FOCUSABLE_IM</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
</code></pre> 
<p>3.<code>TYPE_APPLICATION_MEDIA_OVERLAY</code>为隐藏的类型，应用程序无法直接调用。同样在Android 7.1之前的<code>SurfaceView</code>源码中涉及：</p> 
<pre><code class="prism language-java">       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setZOrderMediaOverlay</span><span class="token punctuation">(</span>booleanisMediaOverlay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           mWindowType <span class="token operator">=</span> isMediaOverlay
                   <span class="token operator">?</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">TYPE_APPLICATION_MEDIA_OVERLAY</span>
                   <span class="token operator">:</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">TYPE_APPLICATION_MEDIA</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
</code></pre> 
<p>4.<code>TYPE_APPLICATION_SUB_PANEL</code>应用窗口的子面板，代表在<code>TYPE_APPLICATION_PANEL</code>的上层，例如<code>PopupWindow</code>弹出列表或者弹出<code>Editor</code>等编辑框等等。</p> 
<p>5.<code>TYPE_APPLICATION_ATTACHED_DIALOG</code>类似于<code>TYPE_APPLICATION_PANEL</code>，但窗口的布局是作为顶级窗口的布局发生的，而不是作为其容器的子窗口。例如<code>CharacterPickerDialog</code>。在<code>PhoneWindow</code>源码中的<code>openPanel()</code>方法使用的就是这个类型，在Android7.1以上则不同，两个值都小于0 代表在当前显示窗口的下层:<br> <img src="https://images2.imgbox.com/c8/2b/ALC7rWk2_o.png" alt="在这里插入图片描述"><br> 6.<code>TYPE_APPLICATION_ABOVE_SUB_PANEL</code>隐藏的类型，为应用窗口之上的子面板及其子面板窗口。 这些窗口显示在其附加窗口和任何 <code>TYPE_APPLICATION_SUB_PANEL</code> 面板的顶部。</p> 
<h2><a id="_112"></a>系统窗口层级</h2> 
<p>在开发过程中，经常这样添加窗口：</p> 
<pre><code class="prism language-java">mWindowManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WindowManager</span><span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">WINDOW_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
mLayoutParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
mLayoutParams<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">WRAP_CONTENT</span><span class="token punctuation">;</span> mLayoutParams<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">WRAP_CONTENT</span><span class="token punctuation">;</span> 
mLayoutParams<span class="token punctuation">.</span>format <span class="token operator">=</span> <span class="token class-name">PixelFormat</span><span class="token punctuation">.</span><span class="token constant">RGBA_8888</span><span class="token punctuation">;</span> 
mLayoutParams<span class="token punctuation">.</span>flags <span class="token operator">|=</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">FLAG_FULLSCREEN</span><span class="token punctuation">;</span> mLayoutParams<span class="token punctuation">.</span>flags <span class="token operator">|=</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span><span class="token constant">FLAG_NOT_FOCUSABLE</span><span class="token punctuation">;</span> 
mLayoutParams<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span> <span class="token constant">TYPE_APPLICATION_OVERLAY</span><span class="token punctuation">;</span>
mWindowManager<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> mLayoutParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>注：TYPE_APPLICATION_OVERLAY为Android 8加入的类型</p> 
<p>这样添加的窗口都为系统窗口，同时也需要窗口权限。</p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.SYSTEM_ALERT_WINDOW"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre> 
<p>下面为系统窗口层级类型：</p> 
<table><thead><tr><th>窗口类型</th><th>描述</th></tr></thead><tbody><tr><td>FIRST_SYSTEM_WINDOW</td><td>系统的窗口类型，起始值2000</td></tr><tr><td>TYPE_STATUS_BAR</td><td>状态栏。只能有一个状态栏窗口；在屏幕的顶部，所有其他窗口都向下移动，所以它们在屏幕的下面。可通过参数设置全屏。</td></tr><tr><td>TYPE_SEARCH_BAR</td><td>搜索栏。只能有一个搜索栏窗口；在屏幕的顶部。在StatusBar上显示</td></tr><tr><td>TYPE_PHONE</td><td>电话窗口，例如来电通话。在应用窗口之上，但位于状态栏的后面。已过时，用TYPE_APPLICATION_OVERLAY替代</td></tr><tr><td>TYPE_SYSTEM_ALERT</td><td>系统警告窗口，如低电量警告弹框。已过时，用TYPE_APPLICATION_OVERLAY替代。</td></tr><tr><td>TYPE_KEYGUARD</td><td>锁屏窗口。不生成引用的接口。</td></tr><tr><td>TYPE_TOAST</td><td>Toast临时通知窗口。已过时，用TYPE_APPLICATION_OVERLAY替代。</td></tr><tr><td>TYPE_SYSTEM_OVERLAY</td><td>系统覆盖窗口，需要显示在其他所有窗口之上。这些窗口不能进行输入聚焦，否则会干扰锁屏。已过时，用TYPE_APPLICATION_OVERLAY替代。</td></tr><tr><td>TYPE_PRIORITY_PHONE</td><td>优先手机UI，即使锁屏处于活动状态也需要显示。这些窗口不能进行输入聚焦，否则会干扰锁屏。已过时，用TYPE_APPLICATION_OVERLAY替代。</td></tr><tr><td>TYPE_SYSTEM_DIALOG</td><td>从状态栏滑出的面板。</td></tr><tr><td>TYPE_KEYGUARD_DIALOG</td><td>锁屏时显示的对话框。</td></tr><tr><td>TYPE_SYSTEM_ERROR</td><td>系统错误窗口。已过时，用TYPE_APPLICATION_OVERLAY替代。</td></tr><tr><td>TYPE_INPUT_METHOD</td><td>输入法窗口，显示在正常UI上方。可以调整应用程序窗口的大小或平移，以在显示该窗口时保持输入焦点可见。</td></tr><tr><td>TYPE_INPUT_METHOD_DIALOG</td><td>输入法对话框窗口，显示在当前输入法窗口上方。</td></tr><tr><td>TYPE_WALLPAPER</td><td>壁纸窗口。放在任何想在壁纸上的窗口后面显示的层级上。系统有壁纸服务，跟过壁纸对应的TOKEN对窗口进行特殊调节</td></tr><tr><td>TYPE_STATUS_BAR_PANEL</td><td>从状态栏上滑出的面板，例如SystemUIDialog，SystemUI的HeadsUpView。不生成的APP使用的类型</td></tr><tr><td>TYPE_SECURE_SYSTEM_OVERLAY</td><td>安全系统覆盖窗口，需要显示在其他所有窗口之上。这些窗口不能进行输入聚焦，否则会干扰锁屏。这与TYPE_SYSTEM_OVERLAY完全相同，只是只允许系统本身创建这些覆盖。应用程序无法获得创建安全系统覆盖的权限。隐藏的类型</td></tr><tr><td>TYPE_DRAG</td><td>拖放伪窗口。最多只有一个拖动层，并且它被放置在所有其他窗口的顶部。隐藏的类型</td></tr><tr><td>TYPE_STATUS_BAR_SUB_PANEL</td><td>从状态栏上滑出的面板显示在所有用户的窗口上。这些窗口显示在状态栏和任何TYPE_STATUS_BAR_PANEL窗口的顶部。例如<code>SystemUIDialog</code>通过<code>setWindowOnTop()</code>方法切换TYPE_STATUS_BAR_PANEL的TYPE_STATUS_BAR_SUB_PANEL显示层级。隐藏的类型</td></tr><tr><td>TYPE_POINTER</td><td>鼠标指针。隐藏的类型</td></tr><tr><td>TYPE_NAVIGATION_BAR</td><td>导航栏。隐藏的类型</td></tr><tr><td>TYPE_VOLUME_OVERLAY</td><td>用户更改系统音量时显示的音量级别对话框。隐藏的类型</td></tr><tr><td>TYPE_BOOT_PROGRESS</td><td>启动进度对话框，位于所有内容的顶部。隐藏的类型</td></tr><tr><td>TYPE_INPUT_CONSUMER</td><td>当系统UI栏被隐藏时，使用输入事件的窗口类型。隐藏的类型</td></tr><tr><td>TYPE_NAVIGATION_BAR_PANEL</td><td>导航栏面板（当导航栏不同于状态栏时）。隐藏的类型</td></tr><tr><td>TYPE_DISPLAY_OVERLAY</td><td>显示覆盖窗口。用于模拟辅助显示设备。隐藏的类型</td></tr><tr><td>TYPE_MAGNIFICATION_OVERLAY</td><td>放大叠加窗口。当启用可访问性放大时，用于突出显示显示器的放大部分。隐藏的类型</td></tr><tr><td>TYPE_PRIVATE_PRESENTATION</td><td>私有顶部的演示Presentation窗口。Presentation会根据对应的Display的参数FLAG_PRIVATE来配置。</td></tr><tr><td>TYPE_VOICE_INTERACTION</td><td>语音交互窗口。隐藏的类型</td></tr><tr><td>TYPE_ACCESSIBILITY_OVERLAY</td><td>由连接的AccessibilityService覆盖的窗口，用于拦截用户交互，而无需更改可访问性服务可以内省的窗口。特别是，可访问性服务只能内省有视力的用户可以与之交互的窗口，即他们可以触摸这些窗口或在这些窗口中键入内容。例如，如果有一个可触摸的全屏辅助功能覆盖，则辅助功能服务将对其下方的窗口进行内省，即使它们被可触摸窗口覆盖。</td></tr><tr><td>TYPE_VOICE_INTERACTION_STARTING</td><td>语音交互层的启动窗口。</td></tr><tr><td>TYPE_DOCK_DIVIDER</td><td>用于显示用于调整堆栈大小的句柄的窗口。此窗口由系统进程所有。隐藏的类型</td></tr><tr><td>TYPE_QS_DIALOG</td><td>类似于 TYPE_APPLICATION_ATTACHED_DIALOG，但由快速设置平铺使用。隐藏的类型</td></tr><tr><td>TYPE_SCREENSHOT</td><td>屏幕截图。截取之下的窗口层级。如果采用android远程的层级截图无法截取倒车相关的UI视图。隐藏接口。</td></tr><tr><td>TYPE_PRESENTATION</td><td>外部显示器上的演示窗口。隐藏的类型</td></tr><tr><td>TYPE_APPLICATION_OVERLAY</td><td>用程序覆盖窗口显示在所有活动窗口上方（类型介于 FIRST_APPLICATION_WINDOW和 LAST_APPLICATION_WINDOW之间），但显示在状态栏或IME等关键系统窗口下方。系统可以随时改变这些窗口的位置、大小或可见性，以减少用户的视觉混乱，并管理资源要android.Manifest.permissionSYSTEM_ALERT_WINDOW权限。系统将调整具有此窗口类型的进程的重要性，以减少低内存杀手杀死它们的机会</td></tr><tr><td>TYPE_ACCESSIBILITY_MAGNIFICATION_OVERLAY</td><td>用于在其他窗口之上添加辅助功能窗口放大倍数的窗口。这将把窗口放置在覆盖窗口中。隐藏的类型</td></tr><tr><td>TYPE_NOTIFICATION_SHADE</td><td>锁屏时通知效果。只能有一个状态栏窗口；它被放置在屏幕的顶部，所有其他窗口都向下移动，所以它们都在屏幕的下面。隐藏的类型</td></tr><tr><td>TYPE_STATUS_BAR_ADDITIONAL</td><td>用于在屏幕的非常规部分（即屏幕的左侧或底部）显示状态栏。隐藏的类型</td></tr><tr><td>LAST_SYSTEM_WINDOW</td><td>系统窗口类型最高层级2999</td></tr></tbody></table> 
<p>下面为Android1开始的窗口层级，从最初的10多个发展到如今的40多个，层出不穷。<br> <img src="https://images2.imgbox.com/82/76/Mn6mq0XB_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_181"></a>自定义的窗口层级</h2> 
<p>车载方案存在倒车等特殊界面需要在较高的窗口层级显示，Android原有的窗口层级不满足车载需求，因此都会自定义车载窗口层级。</p> 
<p>下图为参考自定义的窗口层级：<br> <img src="https://images2.imgbox.com/4a/71/EjRcfSKw_o.png" alt="在这里插入图片描述"></p> 
<p>系统可以自定义窗口层级，framework修改参考另一篇博客：<br> <a href="https://blog.csdn.net/CJohn1994/article/details/124790153">android自定义窗口层级（自定义车载系统中倒车影像显示层级）</a></p> 
<p>自定义窗口层级在不同Android版本中的初始层级值也是不同，因此需要通过系统属性<code>SystemProperties.getInt("ro.custom.window", 2041)</code>来判断初始值。<br> 例如在Android 13平台的默认<code>ro.custom.window</code> 属性为2401，在Andoid 9等平台为2031。这样做的目的是由于跟Android原生的窗口层级存在冲突，因此需要根据平台来调节初始值。<br> <code>TYPE_CUSTOM_FIRST_WINDOW()</code>为自定义初始的系统窗口层级，在Android原生的窗口层级之上</p> 
<p><code>TYPE_TOP_BAR</code>和<code>TYPE_BOTTOM_BAR</code>在<code>TYPE_CUSTOM_FIRST_WINDOW</code>之上，但在倒车界面之下显示。<br> <code>TYPE_REVERSE_WINDOW</code>倒车影像为的窗口层级。若要覆盖在倒车之上需要使用更高的层级或者在倒车出现后添加<code>TYPE_CUSTOM_LAST_WINDOW</code>。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/30e5de54c6ae1471ac31ef8ed8532981/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mysql数据库封装</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/00f5117c2702fa5597dc5b05c8cfdd89/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">干货 | 常见的API接口漏洞总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>