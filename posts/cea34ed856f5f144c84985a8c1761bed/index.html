<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Wayland环境下通过xwayland支持docker图形界面 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Wayland环境下通过xwayland支持docker图形界面" />
<meta property="og:description" content="写在前面 在之前的文章里已经讲解了怎么直接在docker中使用wayland支持图形界面（docker内外都使用wayland），文章链接：
使用Docker安装ROS2 (ros-humble) 并开启对Wayland的支持
指令为：
docker run -it --privileged \ -v &lt;host_src&gt;:&lt;container_src&gt;:rw \ -e XDG_RUNTIME_DIR=/tmp \ -e WAYLAND_DISPLAY=$WAYLAND_DISPLAY \ -v $XDG_RUNTIME_DIR/$WAYLAND_DISPLAY:/tmp/$WAYLAND_DISPLAY \ -e QT_QPA_PLATFORM=wayland \ --name &lt;local_container_name&gt; &lt;container&gt;:&lt;tag&gt; &lt;build_command&gt; 然后就可以在docker中打开图形界面了。
然而，目前有一些软件不支持wayland、配置麻烦或者无法启动，所以本文介绍一种通过xwayland的方式在docker中使用X11渲染图形界面（docker外使用wayland，docker内使用X11）。
注意：这个方法使用了xwayland转换，一些软件可能依然无法使用，可以尝试其它方法如x11docker
Xwayland xwayland可以理解为一个桥，可以在wayland上提供一个X11的接口。
xwayland的安装非常简单，可以自行搜索，对于大多数发行版都可以通过包管理器直接安装。
运行方式 说到这里可能有些抽象，到底在哪里用wayland，哪里用X11？一句话概括为：
主机（运行wayland）-&gt; xwayland -&gt; 主机:/tmp/.X11-unix -&gt; docker:/tmp/.X11-unix -&gt; docker（X11环境）
启动docker xhost &#43; docker run -it --privileged \ --env=LOCAL_USER_ID=&#34;$(id -u)&#34; \ -v &lt;host_src&gt;:&lt;container_src&gt;:rw \ -v /tmp/.X11-unix:/tmp/.X11-unix:ro \ -e DISPLAY=$DISPLAY \ --name=&lt;local_container_name&gt; &lt;container&gt;:&lt;tag&gt; &lt;build_command&gt; -v &lt;host_src&gt;:&lt;container_src&gt;:rw将主机的&lt;host_src&gt;路径映射到docker的&lt;container_src&gt;路径" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/cea34ed856f5f144c84985a8c1761bed/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-09T12:20:59+08:00" />
<meta property="article:modified_time" content="2023-03-09T12:20:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Wayland环境下通过xwayland支持docker图形界面</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>写在前面</h2> 
<p>在之前的文章里已经讲解了怎么直接在docker中使用wayland支持图形界面（docker内外都使用wayland），文章链接：</p> 
<p><a href="https://blog.csdn.net/sinat_21946723/article/details/127436992">使用Docker安装ROS2 (ros-humble) 并开启对Wayland的支持</a></p> 
<p>指令为：</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run -it --privileged <span class="token punctuation">\</span>
           -v <span class="token operator">&lt;</span>host_src<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>container_src<span class="token operator">&gt;</span>:rw <span class="token punctuation">\</span>
           -e <span class="token assign-left variable"><span class="token environment constant">XDG_RUNTIME_DIR</span></span><span class="token operator">=</span>/tmp <span class="token punctuation">\</span>
           -e <span class="token assign-left variable">WAYLAND_DISPLAY</span><span class="token operator">=</span><span class="token variable">$WAYLAND_DISPLAY</span> <span class="token punctuation">\</span>
           -v <span class="token environment constant">$XDG_RUNTIME_DIR</span>/<span class="token variable">$WAYLAND_DISPLAY</span>:/tmp/<span class="token variable">$WAYLAND_DISPLAY</span> <span class="token punctuation">\</span>
           -e <span class="token assign-left variable">QT_QPA_PLATFORM</span><span class="token operator">=</span>wayland <span class="token punctuation">\</span>
           --name <span class="token operator">&lt;</span>local_container_name<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>container<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>tag<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>build_command<span class="token operator">&gt;</span>
</code></pre> 
<p>然后就可以在docker中打开图形界面了。</p> 
<p>然而，目前有一些软件不支持wayland、配置麻烦或者无法启动，所以本文介绍一种通过xwayland的方式在docker中使用X11渲染图形界面（docker外使用wayland，docker内使用X11）。</p> 
<p><strong>注意：这个方法使用了xwayland转换，一些软件可能依然无法使用，可以尝试其它方法如x11docker</strong></p> 
<h3><a id="Xwayland_23"></a>Xwayland</h3> 
<p>xwayland可以理解为一个桥，可以在wayland上提供一个X11的接口。</p> 
<p>xwayland的安装非常简单，可以自行搜索，对于大多数发行版都可以通过包管理器直接安装。</p> 
<h3><a id="_28"></a>运行方式</h3> 
<p>说到这里可能有些抽象，到底在哪里用wayland，哪里用X11？一句话概括为：</p> 
<p>主机（运行wayland）-&gt; xwayland -&gt; 主机:/tmp/.X11-unix -&gt; docker:/tmp/.X11-unix -&gt; docker（X11环境）</p> 
<h2><a id="docker_33"></a>启动docker</h2> 
<pre><code class="prism language-bash">xhost +

<span class="token function">docker</span> run -it --privileged <span class="token punctuation">\</span>
    --env<span class="token operator">=</span>LOCAL_USER_ID<span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span>"</span> <span class="token punctuation">\</span>
    -v <span class="token operator">&lt;</span>host_src<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>container_src<span class="token operator">&gt;</span>:rw <span class="token punctuation">\</span>
    -v /tmp/.X11-unix:/tmp/.X11-unix:ro <span class="token punctuation">\</span>
    -e <span class="token assign-left variable"><span class="token environment constant">DISPLAY</span></span><span class="token operator">=</span><span class="token environment constant">$DISPLAY</span> <span class="token punctuation">\</span>
    --name<span class="token operator">=</span><span class="token operator">&lt;</span>local_container_name<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>container<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>tag<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>build_command<span class="token operator">&gt;</span>
</code></pre> 
<p><code>-v &lt;host_src&gt;:&lt;container_src&gt;:rw</code>将主机的<code>&lt;host_src&gt;</code>路径映射到docker的<code>&lt;container_src&gt;</code>路径<br> <code>&lt;local_container_name&gt;</code>是给容器命的名字<br> <code>&lt;container&gt;:&lt;tag&gt;</code>是镜像的名称，可以通过<code>docker images</code>查看，如<code>px4io/px4-dev-ros-noetic</code></p> 
<p><strong>注意<code>xhost +</code>是不安全的，可以通过配置用户组的方法只允许本地用户使用，感兴趣请自行查找</strong></p> 
<p>然后就可以使用了，比如我们打开<code>gazebo</code>：</p> 
<p><img src="https://images2.imgbox.com/56/57/Dl7UJZLZ_o.png" alt="gazebo运行正常"><br> 正常打开并显示。</p> 
<h2><a id="_57"></a>可能出现的问题</h2> 
<h3><a id="_58"></a>权限错误</h3> 
<blockquote> 
 <p>Authorization required, but no authorization protocol specified</p> 
</blockquote> 
<p>这个错误可能并不是因为没有给予权限，而是没有使用正确的DISPLAY参数。</p> 
<p>处理方法：</p> 
<ol><li>尝试<code>xhost +</code>打开权限，然后测试问题是否解决。如果解决了，考虑用户组的配置问题，比如当前用户是否加入docker用户组或者有没有指定<code>--env=LOCAL_USER_ID="$(id -u)"</code></li><li>可能是没有指定<code>-e DISPLAY=$DISPLAY</code>或者配置错误，检查主机是不是有$DISPLAY参数，然后docker有没有设置成相同的参数，如果确认一致或者没有这个参数，可以尝试从1开始递增尝试DISPLAY参数，如<code>-e DISPLAY=:1</code></li></ol> 
<h3><a id="X11_69"></a>X11应用模糊</h3> 
<p>这个问题严格意义上讲和本文的主题并没有关系，只是为了避免出现应用模糊之后费时研究docker或者wayland或者X11的问题，但是其实并不需要这么复杂（仅对于KDE plasma桌面，版本&gt;=5.26）</p> 
<p>在KDE plasma桌面下进入设置 -&gt; Display and Monitor -&gt; Display Configuration，Legacy Application (X11) 这一项要设置成Apply scaling themselves，如图：</p> 
<p><img src="https://images2.imgbox.com/9d/56/QSu5yGV1_o.png" alt="KDE Settings"><br> 由于并没有在其它桌面上测试，不清楚在其它桌面上需要配置哪些参数，如果读者测试成功，欢迎评论区分享。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f3da16ac4a3a4ab3c661c69790f1d2a9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【微信小程序】-- 案例 - 本地生活（列表页面）（三十）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6aad6d773e2f8083ace2ba0103be3d1a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43;二叉树</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>