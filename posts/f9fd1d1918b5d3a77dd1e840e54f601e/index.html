<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>动手学机器学习(第二版) 第三章分类 - 编程鬼谷子的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="动手学机器学习(第二版) 第三章分类" />
<meta property="og:description" content="第三章 分类 import numpy as np 本章使用MNIST数据集，该数据集包含70,000张由美国的高中生和人口调查局手写数字的图像，使用Scikit-Learn提供的函数可以很方便第下载这些数据集
from sklearn.datasets import fetch_openml mnist = fetch_openml(&#39;mnist_784&#39;, version=1) mnist.keys() dict_keys([&#39;data&#39;, &#39;target&#39;, &#39;frame&#39;, &#39;categories&#39;, &#39;feature_names&#39;, &#39;target_names&#39;, &#39;DESCR&#39;, &#39;details&#39;, &#39;url&#39;]) 由Scikit-Learn下载的数据集通常有相似的数据结构：
DESCR: 描述数据集的基本信息data: 每个实例用一行数组表示，每列表示一个特征target: 包含标签的数组 X, y = mnist[&#34;data&#34;], mnist[&#34;target&#34;] X.shape (70000, 784) y.shape (70000,) 总共有70,000张图片，每张图片有784个特征。这是因为每一张图片是 28 × 28 28\times28 28×28 的分辨率，每个特征简单的代表像素点的强度，从0(白)到255(黑)。查看数据集中的手写数字，只需要选择实例的一个特征向量，然后将其重新变为 28 × 28 28\times28 28×28 的数组，再用Matplotlib’s imshow()函数画图显示
import matplotlib as mpl import matplotlib.pyplot as plt import random # 随机选择一张图片 # random_ind = random." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcguiguzi.github.io/posts/f9fd1d1918b5d3a77dd1e840e54f601e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-28T17:26:50+08:00" />
<meta property="article:modified_time" content="2020-07-28T17:26:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程鬼谷子的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程鬼谷子的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">动手学机器学习(第二版) 第三章分类</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="__0"></a>第三章 分类</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
</code></pre> 
<p>本章使用MNIST数据集，该数据集包含70,000张由美国的高中生和人口调查局手写数字的图像，使用<code>Scikit-Learn</code>提供的函数可以很方便第下载这些数据集</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> fetch_openml

mnist <span class="token operator">=</span> fetch_openml<span class="token punctuation">(</span><span class="token string">'mnist_784'</span><span class="token punctuation">,</span> version<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
mnist<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>dict_keys(['data', 'target', 'frame', 'categories', 'feature_names', 'target_names', 'DESCR', 'details', 'url'])
</code></pre> 
<p>由<code>Scikit-Learn</code>下载的数据集通常有相似的数据结构：</p> 
<ul><li><code>DESCR</code>: 描述数据集的基本信息</li><li><code>data</code>: 每个实例用一行数组表示，每列表示一个特征</li><li><code>target</code>: 包含标签的数组</li></ul> 
<pre><code class="prism language-python">X<span class="token punctuation">,</span> y <span class="token operator">=</span> mnist<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mnist<span class="token punctuation">[</span><span class="token string">"target"</span><span class="token punctuation">]</span>
X<span class="token punctuation">.</span>shape
</code></pre> 
<pre><code>(70000, 784)
</code></pre> 
<pre><code class="prism language-python">y<span class="token punctuation">.</span>shape
</code></pre> 
<pre><code>(70000,)
</code></pre> 
<p>总共有70,000张图片，每张图片有784个特征。这是因为每一张图片是 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         28 
        
       
         × 
        
       
         28 
        
       
      
        28\times28 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">2</span><span class="mord">8</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">2</span><span class="mord">8</span></span></span></span></span> 的分辨率，每个特征简单的代表像素点的强度，从0(白)到255(黑)。查看数据集中的手写数字，只需要选择实例的一个特征向量，然后将其重新变为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         28 
        
       
         × 
        
       
         28 
        
       
      
        28\times28 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">2</span><span class="mord">8</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">2</span><span class="mord">8</span></span></span></span></span> 的数组，再用<code>Matplotlib’s imshow()</code>函数画图显示</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib <span class="token keyword">as</span> mpl
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> random

<span class="token comment"># 随机选择一张图片</span>
<span class="token comment"># random_ind = random.randint(0,7e4)</span>
random_ind <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"chose No."</span><span class="token punctuation">,</span>random_ind<span class="token punctuation">,</span><span class="token string">" pic; label: "</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span>random_ind<span class="token punctuation">]</span><span class="token punctuation">)</span>
some_digit <span class="token operator">=</span> X<span class="token punctuation">[</span>random_ind<span class="token punctuation">]</span>
some_digit_image <span class="token operator">=</span> some_digit<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>some_digit_image<span class="token punctuation">,</span> cmap<span class="token operator">=</span>mpl<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>binary<span class="token punctuation">,</span> interpolation<span class="token operator">=</span><span class="token string">"nearest"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">"off"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>chose No. 0  pic; label:  5
</code></pre> 
<p><img src="https://images2.imgbox.com/54/f2/S4o1aB4b_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token comment"># 查看label标记，发现其格式是字符串</span>
y<span class="token punctuation">[</span>random_ind<span class="token punctuation">]</span>
</code></pre> 
<pre><code>'5'
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 将字符串label转换为整型数组</span>
y <span class="token operator">=</span> y<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
</code></pre> 
<p>在训练之前，一般需要将数据集分为训练数据和测试数据，<code>MNIST</code>数据集已经帮我们分好了训练数据集(前60，000张图片)和测试数据集(后10,000张图片)</p> 
<pre><code class="prism language-python">X_train<span class="token punctuation">,</span> X_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test <span class="token operator">=</span> X<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">60000</span><span class="token punctuation">]</span><span class="token punctuation">,</span> X<span class="token punctuation">[</span><span class="token number">60000</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">60000</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span><span class="token number">60000</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
</code></pre> 
<p>训练数据集的顺序已经打乱，这保证了所有的交叉验证是一致的(你也不想一折交叉验证缺少一些数字的图片). 另外，一些学习算法对训练实例的输入顺序敏感，在许多同样的实例在一行输入时，这些算法表现的很差. 打乱数据集的顺序保证了这些不会发生</p> 
<h3><a id="_110"></a>训练二元分类器</h3> 
<p>我们来简化问题，仅辨认一个数字，例如数字5. “5”分类器是一个二元分类器的例子，能够分辨为两类，5和非5.</p> 
<pre><code class="prism language-python">y_train_5 <span class="token operator">=</span> <span class="token punctuation">(</span>y_train <span class="token operator">==</span> y<span class="token punctuation">[</span>random_ind<span class="token punctuation">]</span><span class="token punctuation">)</span>
y_test_5 <span class="token operator">=</span> <span class="token punctuation">(</span>y_test <span class="token operator">==</span> y<span class="token punctuation">[</span>random_ind<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>然后我们选择一个分类器来训练. 一个方法是选择随机梯度下降(Stochastic Gradient Descent, SGD)分类器，使用<code>Scikit-Learn</code>s SGDClassifier`类. 这个类的优点是可以高效地处理大量的数据. 这是因为SGD算法可以每次单独训练一个输入实例，这也让SDG适合实时学习.</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> SGDClassifier

sgd_clf <span class="token operator">=</span> SGDClassifier<span class="token punctuation">(</span>random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>
sgd_clf<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train_5<span class="token punctuation">)</span>
</code></pre> 
<pre><code>SGDClassifier(random_state=42)
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 使用训练的SDG模型预测数字5</span>
sgd_clf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">[</span>some_digit<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>array([ True])
</code></pre> 
<h3><a id="_150"></a>性能评估</h3> 
<p>评价分类器的性能常常比评价回归的性能更具有欺骗性，所以需要花费很大的精力研究分类器的评估</p> 
<h4><a id="_154"></a>使用交叉验证评估准确率</h4> 
<h5><a id="_157"></a>实施交叉验证</h5> 
<p>手动实现交叉验证，代码如下所示. <code>StratifiedFold</code>方法实现了分层采样，每次迭代都创建了分类器的副本，在副本上训练训练样本，然后在测试样本上预测，最后比较正确预测并输出正确率</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> StratifiedKFold
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>base <span class="token keyword">import</span> clone

skfolds <span class="token operator">=</span> StratifiedKFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> train_index<span class="token punctuation">,</span> test_index <span class="token keyword">in</span> skfolds<span class="token punctuation">.</span>split<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train_5<span class="token punctuation">)</span><span class="token punctuation">:</span>
    clone_clf <span class="token operator">=</span> clone<span class="token punctuation">(</span>sgd_clf<span class="token punctuation">)</span>
    X_train_folds <span class="token operator">=</span> X_train<span class="token punctuation">[</span>train_index<span class="token punctuation">]</span>
    y_train_folds <span class="token operator">=</span> y_train_5<span class="token punctuation">[</span>train_index<span class="token punctuation">]</span>
    X_test_fold <span class="token operator">=</span> X_train<span class="token punctuation">[</span>test_index<span class="token punctuation">]</span>
    y_test_fold <span class="token operator">=</span> y_train_5<span class="token punctuation">[</span>test_index<span class="token punctuation">]</span>

    clone_clf<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train_folds<span class="token punctuation">,</span> y_train_folds<span class="token punctuation">)</span>
    y_pred <span class="token operator">=</span> clone_clf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_test_fold<span class="token punctuation">)</span>
    n_correct <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>y_pred <span class="token operator">==</span> y_test_fold<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>n_correct <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>y_pred<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>0.95035
0.96035
0.9604
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 使用cross_val_score()测试分类</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> cross_val_score
cross_val_score<span class="token punctuation">(</span>sgd_clf<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> y_train_5<span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> scoring<span class="token operator">=</span><span class="token string">"accuracy"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>array([0.95035, 0.96035, 0.9604 ])
</code></pre> 
<p>以上交叉验证的准确率都在93%以上，看起来效果十分好. 但是再这之前，设置一个很傻的分类器，将每张图片都设置为非5类</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseEstimator

<span class="token keyword">class</span> <span class="token class-name">Never5Classifier</span><span class="token punctuation">(</span>BaseEstimator<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">fit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">never_5_clf <span class="token operator">=</span> Never5Classifier<span class="token punctuation">(</span><span class="token punctuation">)</span>
cross_val_score<span class="token punctuation">(</span>never_5_clf<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span>y_train_5<span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> scoring<span class="token operator">=</span><span class="token string">"accuracy"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>array([0.91125, 0.90855, 0.90915])
</code></pre> 
<p>可以看到，这个很傻的分类器也有90%以上的准确率，这是因为数据集中只有10%左右的图片是5，所以一直猜测图片不是5，你也能得到90%的准确率</p> 
<p>这表明了为什么准确率通常不是衡量分类器的最好方法，特别是在处理有数据倾斜的情况下(例如，当一些类别的数据比其他类别的数据出现地更加频繁)</p> 
<h5><a id="Confusion_Matrix_230"></a>混淆矩阵(Confusion Matrix)</h5> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> cross_val_predict

y_train_pred <span class="token operator">=</span> cross_val_predict<span class="token punctuation">(</span>sgd_clf<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> y_train_5<span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> confusion_matrix
confusion_matrix<span class="token punctuation">(</span>y_train_5<span class="token punctuation">,</span> y_train_pred<span class="token punctuation">)</span>
</code></pre> 
<pre><code>array([[53892,   687],
       [ 1891,  3530]])
</code></pre> 
<p>在混淆矩阵中的每一行代表实际的类别，每一列代表预测的类列。</p> 
<ul><li>数组的第一行是被实际非5的图片(负类), 53,892张图片被正确地分类为非5(True Negative,TN)，剩余有687张图片错分为5(False Positive, FP)</li><li>第二行是实际为5的图片(正类)，1,891张图片被错误分为非5(False Negative, FN)，而剩下的3,530张图片是正确分为5的图片(True Positive, TP)</li></ul> 
<p>一个完美的分类器只有真负类(TN)和真正类(TP)，所以混淆矩阵只能在主对角线有非零值，如下所示</p> 
<pre><code class="prism language-python">y_train_perfect_predictions <span class="token operator">=</span> y_train_5
confusion_matrix<span class="token punctuation">(</span>y_train_5<span class="token punctuation">,</span> y_train_perfect_predictions<span class="token punctuation">)</span>
</code></pre> 
<pre><code>array([[54579,     0],
       [    0,  5421]])
</code></pre> 
<p>混淆矩阵告诉了你很多信息，但是有时你可能更想要更多准确的度量标准。一种方法是检查正类的准确率，这被称作分类器的准确率</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          p 
         
        
          r 
         
        
          e 
         
        
          c 
         
        
          i 
         
        
          s 
         
        
          i 
         
        
          o 
         
        
          n 
         
        
          = 
         
         
          
          
            T 
           
          
            P 
           
          
          
          
            T 
           
          
            P 
           
          
            + 
           
          
            F 
           
          
            P 
           
          
         
        
       
         precision = \frac{TP}{TP+FP} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.85396em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.12966em; vertical-align: -0.76933em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.36033em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.76933em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<p>一个很简单地获得完美精度的方法是只做正类预测(precison=1/1=100%)，分类器会忽略其他的类别，除了正类的实例，这种度量方法就会失效，所以精确率一般和另一种度量方法同时使用，叫做召回率(recall)，同样也叫做敏感度或者真正率</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          r 
         
        
          e 
         
        
          c 
         
        
          a 
         
        
          l 
         
        
          l 
         
        
          = 
         
         
          
          
            T 
           
          
            P 
           
          
          
          
            T 
           
          
            P 
           
          
            + 
           
          
            F 
           
          
            N 
           
          
         
        
       
         recall = \frac{TP}{TP+FN} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.12966em; vertical-align: -0.76933em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.36033em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="mord mathdefault" style="margin-right: 0.10903em;">N</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.76933em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<h5><a id="_283"></a>准确率和召回率</h5> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> precision_score<span class="token punctuation">,</span> recall_score
precision_score<span class="token punctuation">(</span>y_train_5<span class="token punctuation">,</span> y_train_pred<span class="token punctuation">)</span>
</code></pre> 
<pre><code>0.8370879772350012
</code></pre> 
<pre><code class="prism language-python">recall_score<span class="token punctuation">(</span>y_train_5<span class="token punctuation">,</span> y_train_pred<span class="token punctuation">)</span>
</code></pre> 
<pre><code>0.6511713705958311
</code></pre> 
<p>结合准确率和召回率的简单方法是F1分数，它是准确率和召回率的调和平均数</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           F 
          
         
           1 
          
         
        
          = 
         
         
         
           2 
          
          
           
           
             1 
            
            
            
              p 
             
            
              r 
             
            
              e 
             
            
              c 
             
            
              i 
             
            
              s 
             
            
              i 
             
            
              o 
             
            
              n 
             
            
           
          
            + 
           
           
           
             1 
            
            
            
              r 
             
            
              e 
             
            
              c 
             
            
              a 
             
            
              l 
             
            
              l 
             
            
           
          
         
        
          = 
         
        
          2 
         
        
          × 
         
         
          
          
            p 
           
          
            r 
           
          
            e 
           
          
            c 
           
          
            i 
           
          
            s 
           
          
            i 
           
          
            o 
           
          
            n 
           
          
            × 
           
          
            r 
           
          
            e 
           
          
            c 
           
          
            a 
           
          
            l 
           
          
            l 
           
          
          
          
            p 
           
          
            r 
           
          
            e 
           
          
            c 
           
          
            i 
           
          
            s 
           
          
            i 
           
          
            o 
           
          
            n 
           
          
            + 
           
          
            r 
           
          
            e 
           
          
            c 
           
          
            a 
           
          
            l 
           
          
            l 
           
          
         
        
          = 
         
         
          
          
            T 
           
          
            P 
           
          
          
          
            T 
           
          
            P 
           
          
            + 
           
           
            
            
              F 
             
            
              N 
             
            
              + 
             
            
              F 
             
            
              P 
             
            
           
             2 
            
           
          
         
        
       
         F_1 =\frac{2}{\frac{1}{precision} + \frac{1}{recall}} = 2 \times \frac{precision \times recall}{precision + recall} = \frac{TP}{TP+\frac{FN+FP}{2}} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.53766em; vertical-align: -1.21622em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em;"><span class="" style="top: -2.26489em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.845108em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">n</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.481108em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.845108em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.21622em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 2.25188em; vertical-align: -0.88044em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.88044em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.46766em; vertical-align: -1.10733em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.36033em;"><span class="" style="top: -2.23767em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.872331em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">F</span><span class="mord mathdefault mtight" style="margin-right: 0.10903em;">N</span><span class="mbin mtight">+</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">F</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">P</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.10733em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<p>只有在召回率和准确率都同时高，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          F 
         
        
          1 
         
        
       
      
        F_1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 才会高,但是一般情况下，两者是此消彼长的关系，这叫做准确率和召回率折中(precison/recall tradeoff)</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> f1_score
f1_score<span class="token punctuation">(</span>y_train_5<span class="token punctuation">,</span> y_train_pred<span class="token punctuation">)</span>
</code></pre> 
<pre><code>0.7325171197343846
</code></pre> 
<h4><a id="_329"></a>准确率/回调率折中</h4> 
<pre><code class="prism language-python">y_scores <span class="token operator">=</span> sgd_clf<span class="token punctuation">.</span>decision_function<span class="token punctuation">(</span><span class="token punctuation">[</span>some_digit<span class="token punctuation">]</span><span class="token punctuation">)</span>
y_scores
</code></pre> 
<pre><code>array([2164.22030239])
</code></pre> 
<pre><code class="prism language-python">threshold <span class="token operator">=</span> <span class="token number">0</span>
y_some_digit_pred <span class="token operator">=</span> <span class="token punctuation">(</span>y_scores <span class="token operator">&gt;</span> threshold<span class="token punctuation">)</span>
y_some_digit_pred
</code></pre> 
<pre><code>array([ True])
</code></pre> 
<pre><code class="prism language-python">threshold <span class="token operator">=</span> <span class="token number">8000</span>
y_some_digit_pred <span class="token operator">=</span> <span class="token punctuation">(</span>y_scores <span class="token operator">&gt;</span> threshold<span class="token punctuation">)</span>
y_some_digit_pred
</code></pre> 
<pre><code>array([False])
</code></pre> 
<pre><code class="prism language-python">y_scores <span class="token operator">=</span> cross_val_predict<span class="token punctuation">(</span>sgd_clf<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> y_train_5<span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">"decision_function"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">y_scores
</code></pre> 
<pre><code>array([  1200.93051237, -26883.79202424, -33072.03475406, ...,
        13272.12718981,  -7258.47203373, -16877.50840447])
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> precision_recall_curve

precisions<span class="token punctuation">,</span> recalls<span class="token punctuation">,</span> thresholds <span class="token operator">=</span> precision_recall_curve<span class="token punctuation">(</span>y_train_5<span class="token punctuation">,</span> y_scores<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">plot_precision_recall_vs_threshold</span><span class="token punctuation">(</span>precisions<span class="token punctuation">,</span> recalls<span class="token punctuation">,</span> thresholds<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>thresholds<span class="token punctuation">,</span> precisions<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"b--"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Precision"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>thresholds<span class="token punctuation">,</span> recalls<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"g-"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Recall"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"Precision"</span><span class="token punctuation">,</span> <span class="token string">"Recall"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

plot_precision_recall_vs_threshold<span class="token punctuation">(</span>precisions<span class="token punctuation">,</span> recalls<span class="token punctuation">,</span> thresholds<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f6/cf/HDq0SQtg_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>recalls<span class="token punctuation">,</span>precisions<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/fd/b8/iJnCELdw_o.png" alt="在这里插入图片描述"></p> 
<p>如果决定获取90%准确率，查看准确率和召回率的图片，可以找到阈值，更精确的是找到最低能使模型达到90%准确率的阈值</p> 
<pre><code class="prism language-python">threshold_90_precision <span class="token operator">=</span> thresholds<span class="token punctuation">[</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>precisions <span class="token operator">&gt;=</span> <span class="token number">0.90</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
threshold_90_precision
</code></pre> 
<pre><code>3370.0194991439557
</code></pre> 
<pre><code class="prism language-python">y_train_pred_90 <span class="token operator">=</span> <span class="token punctuation">(</span>y_scores <span class="token operator">&gt;=</span> threshold_90_precision<span class="token punctuation">)</span>
y_train_pred_90
</code></pre> 
<pre><code>array([False, False, False, ...,  True, False, False])
</code></pre> 
<pre><code class="prism language-python">precision_score<span class="token punctuation">(</span>y_train_5<span class="token punctuation">,</span> y_train_pred_90<span class="token punctuation">)</span>
</code></pre> 
<pre><code>0.9000345901072293
</code></pre> 
<pre><code class="prism language-python">recall_score<span class="token punctuation">(</span>y_train_5<span class="token punctuation">,</span> y_train_pred_90<span class="token punctuation">)</span>
</code></pre> 
<pre><code>0.4799852425751706
</code></pre> 
<h3><a id="The_ROC_Curve_476"></a>The ROC Curve</h3> 
<p>观察者操作特性曲线(receiver operating characteristic, ROC)是另一种常用于二分类器的工具. 它和准确率/召回率曲线类似，但是ROC曲线绘制的是真正率(TPR，回调的另一种说法)和假正类(FPR)的比值。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> roc_curve

fpr<span class="token punctuation">,</span> tpr<span class="token punctuation">,</span> threshold <span class="token operator">=</span> roc_curve<span class="token punctuation">(</span>y_train_5<span class="token punctuation">,</span> y_scores<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">plot_roc_curve</span><span class="token punctuation">(</span>fpt<span class="token punctuation">,</span> tpr<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>fpr<span class="token punctuation">,</span> tpr<span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> label<span class="token operator">=</span>label<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'k--'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"False Positive Rate"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"True Positive Rate(Recall)"</span><span class="token punctuation">)</span>
    
plot_roc_curve<span class="token punctuation">(</span>fpr<span class="token punctuation">,</span> tpr<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/38/72/3GaVLerS_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-HsKuD9HJ-1595927822631)(chap3_files/chap3_53_0.svg)]"></p> 
<p>同样地，这里也有平衡的关系，回调(recall, or TPR)越高，分类器产生的假正率越高。点线代表的是完全随机的分类器的ROC曲线；一个好的分类器离这条线越远越好(趋向于左上角)</p> 
<p>另外一种比较分类器的方法是测量曲线下的面积(<em>area under the curve</em>, AUC). 完美的分类器ROC AUC等于一，而完全随机的分类器的ROC AUC等于0.5. <code>Scikit-Learn</code>提供了一个计算ROC AUC的函数.</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> roc_auc_score
roc_auc_score<span class="token punctuation">(</span>y_train_5<span class="token punctuation">,</span> y_scores<span class="token punctuation">)</span>
</code></pre> 
<pre><code>0.9604938554008616
</code></pre> 
<p>当正类较少时，使用PR曲线，反之则是ROC曲线</p> 
<p>训练一个<code>RandomForestClassifier</code>并与<code>SGDClassifier</code>比较ROC曲线和ROC AUC分数</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword">import</span> RandomForestClassifier
forest_clf <span class="token operator">=</span> RandomForestClassifier<span class="token punctuation">(</span>random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>
y_probas_forest <span class="token operator">=</span> cross_val_predict<span class="token punctuation">(</span>forest_clf<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> y_train_5<span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">"predict_proba"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">y_scores_forest <span class="token operator">=</span> y_probas_forest<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
fpr_forest<span class="token punctuation">,</span> tpr_forest<span class="token punctuation">,</span> thresholds_forest <span class="token operator">=</span> roc_curve<span class="token punctuation">(</span>y_train_5<span class="token punctuation">,</span> y_scores_forest<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>fpr<span class="token punctuation">,</span> tpr<span class="token punctuation">,</span> <span class="token string">"b:"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"SGD"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>fpr_forest<span class="token punctuation">,</span> tpr_forest<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Random Forest"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">"lower right"</span><span class="token punctuation">)</span> 
plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.01</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ed/35/1xCJMFKy_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-ADUVci67-1595927822632)(chap3_files/chap3_60_0.svg)]"></p> 
<pre><code class="prism language-python"><span class="token comment"># 该代码出现未知错误。。。</span>
<span class="token comment">#  roc_auc_score(y_train, y_scores_forest)</span>
</code></pre> 
<h3><a id="_558"></a>多元分类</h3> 
<p>相比于二元分类器只能分辨两类，多元分类器(<em>multiclass classifiers, also called multinomial classifiers</em>)可以分辨超过两类.</p> 
<p>一些算法(例如随机森林分类器或者朴素贝叶斯分类器)可以直接处理多分类问题，其他的算法(例如支持向量机或者线性分类器)只能作二分类器.但也有一些策略让你可以用多个二分类器来实现多元分类器</p> 
<ul><li>用多个二分类器，每个分类器判断一类，对于每个实例，判断所有分类器输出的最高的得分，这叫做<em>one-versus-all</em>(OvA)策略，也叫作<em>one-versus-the-rest</em></li><li>训练关于每一对数字的二分类器，例如分辨0和1，这种策略叫做<em>one-versus-one</em>(OvO)。如果有 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          N 
         
        
       
         N 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.10903em;">N</span></span></span></span></span> 个分类，那么需要训练 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            N 
           
          
            × 
           
          
            ( 
           
          
            N 
           
          
            − 
           
          
            1 
           
          
            ) 
           
          
         
           2 
          
         
        
       
         \frac{N \times (N-1)}{2} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.355em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.01em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.485em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.10903em;">N</span><span class="mbin mtight">×</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.10903em;">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span> 个分类器</li></ul> 
<p>一些算法(例如支持向量机)和训练集的大小关系不大，所以对于这些算法OvO更加合适，因为它可以在小规模的数据集上训练很多的分类器，而不是在很大的数据集上训练很少的分类器。但是对于大多数的二分类算法来说，OvA更适用</p> 
<pre><code class="prism language-python">sgd_clf<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
sgd_clf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">[</span>some_digit<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>array([3], dtype=uint8)
</code></pre> 
<p><code>Scikit-Learn</code>检测到你使用二分类算法进行多元分类任务时，它会自动运行OvA(除了SVM会自动运行OvO)。</p> 
<pre><code class="prism language-python">some_digit_scores <span class="token operator">=</span> sgd_clf<span class="token punctuation">.</span>decision_function<span class="token punctuation">(</span><span class="token punctuation">[</span>some_digit<span class="token punctuation">]</span><span class="token punctuation">)</span>
some_digit_scores
</code></pre> 
<pre><code>array([[-31893.03095419, -34419.69069632,  -9530.63950739,
          1823.73154031, -22320.14822878,  -1385.80478895,
        -26188.91070951, -16147.51323997,  -4604.35491274,
        -12050.767298  ]])
</code></pre> 
<pre><code class="prism language-python">np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>some_digit_scores<span class="token punctuation">)</span>
</code></pre> 
<pre><code>3
</code></pre> 
<pre><code class="prism language-python">sgd_clf<span class="token punctuation">.</span>classes_
</code></pre> 
<pre><code>array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9], dtype=uint8)
</code></pre> 
<blockquote> 
 <p>分类器训练好之后，在其<code>classes_</code>属性储存目标类的列表</p> 
</blockquote> 
<p>强制<code>ScikitLearn</code>使用<em>one-versus-one</em>或者<em>one-versus-all</em>，可以使用<code>OneVsOneClassifier</code>或者<code>OneVsRestClassifier</code></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>multiclass <span class="token keyword">import</span> OneVsOneClassifier

ovo_clf <span class="token operator">=</span> OneVsOneClassifier<span class="token punctuation">(</span>SGDClassifier<span class="token punctuation">(</span>random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ovo_clf<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
ovo_clf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">[</span>some_digit<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>array([5], dtype=uint8)
</code></pre> 
<pre><code class="prism language-python"><span class="token builtin">len</span><span class="token punctuation">(</span>ovo_clf<span class="token punctuation">.</span>estimators_<span class="token punctuation">)</span>
</code></pre> 
<pre><code>45
</code></pre> 
<pre><code class="prism language-python">forest_clf<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
</code></pre> 
<pre><code>RandomForestClassifier(random_state=42)
</code></pre> 
<pre><code class="prism language-python">forest_clf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">[</span>some_digit<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>array([5], dtype=uint8)
</code></pre> 
<pre><code class="prism language-python">forest_clf<span class="token punctuation">.</span>predict_proba<span class="token punctuation">(</span><span class="token punctuation">[</span>some_digit<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>array([[0.  , 0.  , 0.01, 0.08, 0.  , 0.9 , 0.  , 0.  , 0.  , 0.01]])
</code></pre> 
<pre><code class="prism language-python">cross_val_score<span class="token punctuation">(</span>sgd_clf<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> scoring<span class="token operator">=</span><span class="token string">"accuracy"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>array([0.87365, 0.85835, 0.8689 ])
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> StandardScaler
scaler <span class="token operator">=</span> StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
X_train_scaled <span class="token operator">=</span> scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>X_train<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float64<span class="token punctuation">)</span><span class="token punctuation">)</span>
cross_val_score<span class="token punctuation">(</span>sgd_clf<span class="token punctuation">,</span> X_train_scaled<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span>cv<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>scoring<span class="token operator">=</span><span class="token string">"accuracy"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>array([0.8983, 0.891 , 0.9018])
</code></pre> 
<h3><a id="_720"></a>误差分析</h3> 
<pre><code class="prism language-python">y_train_pred <span class="token operator">=</span> cross_val_predict<span class="token punctuation">(</span>sgd_clf<span class="token punctuation">,</span> X_train_scaled<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
conf_mx <span class="token operator">=</span> confusion_matrix<span class="token punctuation">(</span>y_train<span class="token punctuation">,</span> y_train_pred<span class="token punctuation">)</span>
conf_mx
</code></pre> 
<pre><code>array([[5577,    0,   22,    5,    8,   43,   36,    6,  225,    1],
       [   0, 6400,   37,   24,    4,   44,    4,    7,  212,   10],
       [  27,   27, 5220,   92,   73,   27,   67,   36,  378,   11],
       [  22,   17,  117, 5227,    2,  203,   27,   40,  403,   73],
       [  12,   14,   41,    9, 5182,   12,   34,   27,  347,  164],
       [  27,   15,   30,  168,   53, 4444,   75,   14,  535,   60],
       [  30,   15,   42,    3,   44,   97, 5552,    3,  131,    1],
       [  21,   10,   51,   30,   49,   12,    3, 5684,  195,  210],
       [  17,   63,   48,   86,    3,  126,   25,   10, 5429,   44],
       [  25,   18,   30,   64,  118,   36,    1,  179,  371, 5107]])
</code></pre> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>matshow<span class="token punctuation">(</span>conf_mx<span class="token punctuation">,</span> cmap<span class="token operator">=</span>plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>gray<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5d/b2/H3lhwEmh_o.png" alt="在这里插入图片描述"></p> 
<p>误差矩阵看起来很好，大多数的图片在主对角线上，这意味着分类正确。</p> 
<pre><code class="prism language-python">row_sums <span class="token operator">=</span> conf_mx<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> keepdims<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
norm_conf_mx <span class="token operator">=</span> conf_mx <span class="token operator">/</span> row_sums

np<span class="token punctuation">.</span>fill_diagonal<span class="token punctuation">(</span>norm_conf_mx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>matshow<span class="token punctuation">(</span>norm_conf_mx<span class="token punctuation">,</span> cmap<span class="token operator">=</span>plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>gray<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/dc/73/aRWfHpEW_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-5SrV3097-1595927822635)(chap3_files/chap3_81_0.svg)]"></p> 
<p>将对角线置0，观察误差，发现第8行最明显</p> 
<pre><code class="prism language-python"><span class="token comment"># EXTRA</span>
<span class="token keyword">def</span> <span class="token function">plot_digits</span><span class="token punctuation">(</span>instances<span class="token punctuation">,</span> images_per_row<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">**</span>options<span class="token punctuation">)</span><span class="token punctuation">:</span>
    size <span class="token operator">=</span> <span class="token number">28</span>
    images_per_row <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>instances<span class="token punctuation">)</span><span class="token punctuation">,</span> images_per_row<span class="token punctuation">)</span>
    images <span class="token operator">=</span> <span class="token punctuation">[</span>instance<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>size<span class="token punctuation">,</span>size<span class="token punctuation">)</span> <span class="token keyword">for</span> instance <span class="token keyword">in</span> instances<span class="token punctuation">]</span>
    n_rows <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>instances<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> images_per_row <span class="token operator">+</span> <span class="token number">1</span>
    row_images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    n_empty <span class="token operator">=</span> n_rows <span class="token operator">*</span> images_per_row <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>instances<span class="token punctuation">)</span>
    images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> size <span class="token operator">*</span> n_empty<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> row <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_rows<span class="token punctuation">)</span><span class="token punctuation">:</span>
        rimages <span class="token operator">=</span> images<span class="token punctuation">[</span>row <span class="token operator">*</span> images_per_row <span class="token punctuation">:</span> <span class="token punctuation">(</span>row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> images_per_row<span class="token punctuation">]</span>
        row_images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>rimages<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>row_images<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">,</span> cmap <span class="token operator">=</span> mpl<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>binary<span class="token punctuation">,</span> <span class="token operator">**</span>options<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">"off"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">cl_a<span class="token punctuation">,</span> cl_b <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span>
X_aa <span class="token operator">=</span> X_train<span class="token punctuation">[</span><span class="token punctuation">(</span>y_train <span class="token operator">==</span> cl_a<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>y_train_pred <span class="token operator">==</span> cl_a<span class="token punctuation">)</span><span class="token punctuation">]</span>
X_ab <span class="token operator">=</span> X_train<span class="token punctuation">[</span><span class="token punctuation">(</span>y_train <span class="token operator">==</span> cl_a<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>y_train_pred <span class="token operator">==</span> cl_b<span class="token punctuation">)</span><span class="token punctuation">]</span>
X_ba <span class="token operator">=</span> X_train<span class="token punctuation">[</span><span class="token punctuation">(</span>y_train <span class="token operator">==</span> cl_b<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>y_train_pred <span class="token operator">==</span> cl_a<span class="token punctuation">)</span><span class="token punctuation">]</span>
X_bb <span class="token operator">=</span> X_train<span class="token punctuation">[</span><span class="token punctuation">(</span>y_train <span class="token operator">==</span> cl_b<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>y_train_pred <span class="token operator">==</span> cl_b<span class="token punctuation">)</span><span class="token punctuation">]</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">221</span><span class="token punctuation">)</span><span class="token punctuation">;</span> plot_digits<span class="token punctuation">(</span>X_aa<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">,</span> images_per_row<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">;</span> plot_digits<span class="token punctuation">(</span>X_ab<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">,</span> images_per_row<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">223</span><span class="token punctuation">)</span><span class="token punctuation">;</span> plot_digits<span class="token punctuation">(</span>X_ba<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">,</span> images_per_row<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">;</span> plot_digits<span class="token punctuation">(</span>X_bb<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">,</span> images_per_row<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0f/34/7GYNj9lP_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-buhm99FE-1595927822636)(chap3_files/chap3_84_0.svg)]"></p> 
<h3><a id="_814"></a>多标签分类</h3> 
<p>目前对于每个实例只能分配一个类，但是在一些例子中或许需要输出多个分类，比如一张图片中有多个人，可以用一个矩阵表示，例如<code>[1,0,1]</code>，表示第一个类和第三个类存在</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>neighbors <span class="token keyword">import</span> KNeighborsClassifier

y_train_large <span class="token operator">=</span> <span class="token punctuation">(</span>y_train <span class="token operator">&gt;=</span> <span class="token number">7</span><span class="token punctuation">)</span>
y_train_odd <span class="token operator">=</span> <span class="token punctuation">(</span>y_train <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
y_multilabel <span class="token operator">=</span> np<span class="token punctuation">.</span>c_<span class="token punctuation">[</span>y_train_large<span class="token punctuation">,</span> y_train_odd<span class="token punctuation">]</span>

knn_clf <span class="token operator">=</span> KNeighborsClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span>
knn_clf<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_multilabel<span class="token punctuation">)</span>
</code></pre> 
<pre><code>KNeighborsClassifier()
</code></pre> 
<pre><code class="prism language-python">knn_clf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">[</span>some_digit<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>array([[False,  True]])
</code></pre> 
<p><code>y_multilabel</code>包含两个标签：第一个是<code>&gt;=7</code>，第二个是判断是否奇数，训练后预测<code>5</code>，结果显示<code>5&gt;=7</code>为<code>False</code>，而<code>5%2==1</code>为<code>True</code></p> 
<pre><code class="prism language-python"><span class="token comment"># 这段代码运行慢的吐血！！！</span>
<span class="token comment"># y_train_knn_pred = cross_val_predict(knn_clf, X_train, y_multilabel, cv=3)</span>
<span class="token comment"># f1_score(y_multilabel, y_train_knn_pred, average="macro")</span>
</code></pre> 
<h3><a id="_858"></a>多输出分类</h3> 
<p>多输出分类简单的来说就是综合多分类输出，其中每个样本可以是多个种类</p> 
<pre><code class="prism language-python">noise <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>X_train<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">784</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
X_train_mod <span class="token operator">=</span> X_train <span class="token operator">+</span> noise
noise <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>X_test<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">784</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
X_test_mod <span class="token operator">=</span> X_test <span class="token operator">+</span> noise
y_train_mod <span class="token operator">=</span> X_train
y_test_mod <span class="token operator">=</span> X_test
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 查看添加噪声后的图片</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">121</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>X_train_mod<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmap <span class="token operator">=</span> mpl<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>binary<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">"off"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">122</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>y_train_mod<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmap <span class="token operator">=</span> mpl<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>binary<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">"off"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/85/67/VRGK3wJS_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-AvAC12am-1595927822636)(chap3_files/chap3_92_0.svg)]"></p> 
<pre><code class="prism language-python">knn_clf<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train_mod<span class="token punctuation">,</span> y_train_mod<span class="token punctuation">)</span>
some_index <span class="token operator">=</span> <span class="token number">0</span>
clean_digit <span class="token operator">=</span> knn_clf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">[</span>X_test_mod<span class="token punctuation">[</span>some_index<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">plot_digits<span class="token punctuation">(</span>clean_digit<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d0/d8/N6Cc8Mtd_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-PqQNRchu-1595927822637)(chap3_files/chap3_94_0.svg)]"></p> 
<h3><a id="_903"></a>参考文献</h3> 
<ol><li><a href="https://www.oreilly.com/library/view/hands-on-machine-learning/9781492032632/" rel="nofollow">《Hands-on Machine Learning with Scikit-Learn, Keras &amp; TensorFlow》(2nd Edition)</a></li><li><a href="https://github.com/ageron/handson-ml2">github 代码地址</a></li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1614b162f3e471f1f3f60a6d0d7b5a41/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">激光SLAM之NDT算法（2）-建图</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/083b3c5b98d3cfa4b56bb66891406039/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Mybatis generator的简单使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程鬼谷子的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>